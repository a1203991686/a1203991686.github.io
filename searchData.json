[{"title":"Handleræœºåˆ¶ä¹‹ThreadLocal","url":"/posts/64f0a9f6.html","content":"# ç®€ä»‹\nThreadLocalæ˜¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„æ•°æ®å‚¨å­˜ç±»ï¼Œé€šè¿‡ä»–å¯ä»¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å­˜å‚¨æ•°æ®ã€‚æ•°æ®å­˜å‚¨ä»¥åï¼Œåªæœ‰åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å¯ä»¥è·å–åˆ°å­˜å‚¨çš„æ•°æ®ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´åˆ™æ— æ³•è·å–ã€‚\n\nåœ¨æºç ä¸­æ˜¯è¿™æ ·å†™çš„ï¼š\n>This class provides thread-local variables.  These variables differ from\n>their normal counterparts in that each thread that accesses one (via its\n>{@code get} or {@code set} method) has its own, independently initialized\n>copy of the variable.  {@code ThreadLocal} instances are typically private\n>static fields in classes that wish to associate state with a thread (e.g.,\n>a user ID or Transaction ID).\n \nç¿»è¯‘è¿‡æ¥ï¼Œå°±æ˜¯è¯´è¿™ä¸ªç±»æä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯ä»–å’Œæ™®é€šå˜é‡ä¸åŒï¼Œä»–æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚è€Œé€šè¿‡`get()`å’Œ`set()`æ–¹æ³•å°±èƒ½å¾—åˆ°å’Œè®¾ç½®å½“å‰çº¿ç¨‹å¯¹åº”çš„è¯¥å˜é‡çš„å€¼ã€‚\n\n# ç¤ºä¾‹\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ï¼Œåœ¨ä¸€ä¸ªActivityçš„onCreateæ–¹æ³•ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š\n```java\npublic class MainActivity extends AppCompatActivity {\n\n    // éœ€è¦æ·»åŠ çš„ä»£ç \n    private static final String TAG = \"MainActivity\";\n    // éœ€è¦æ·»åŠ çš„ä»£ç \n    private ThreadLocal<Boolean> mBooleanThreadLocal = new ThreadLocal<>();\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n\n        // éœ€è¦æ·»åŠ çš„ä»£ç \n        mBooleanThreadLocal.set(true);\n        Log.d(TAG, \"[Thread#main]mBooleanThreadLocal=\" + mBooleanThreadLocal.get());\n\n        // éœ€è¦æ·»åŠ çš„ä»£ç \n        new Thread(\"Thread#1\") {\n            @Override\n            public void run() {\n                mBooleanThreadLocal.set(false);\n                Log.d(TAG, \"[Thread#1]mBooleanThreadLocal=\" + mBooleanThreadLocal.get());\n            }\n        }.start();\n        \n        // éœ€è¦æ·»åŠ çš„ä»£ç \n        new Thread(\"Thread#2\") {\n            @Override\n            public void run() {\n                Log.d(TAG, \"[Thread#2]mBooleanThreadLocal=\" + mBooleanThreadLocal.get());\n            }\n        }.start();\n    }\n}\n```\n\næ ¹æ®æˆ‘ä»¬ä¸Šé¢è¯´çš„ThreadLocalçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥çŒœå‡ºåº”è¯¥ä¼šè¾“å‡ºï¼š\n```java\n[Thread#main]mBooleanThreadLocal=true\n[Thread#1]mBooleanThreadLocal=false\n[Thread#2]mBooleanThreadLocal=null\n```\n\nç„¶åè¿è¡Œè¾“å‡ºçš„ç»“æœï¼Œä¸å‡ºæ‰€æ–™ï¼Œæœç„¶å’Œä¸Šé¢ä¸€æ ·ã€‚\n\n# ä½¿ç”¨åœºæ™¯\nä¸€èˆ¬æ¥è¯´ï¼Œå½“æŸäº›æ•°æ®æ˜¯ä»¥çº¿ç¨‹ä½œä¸ºä½œç”¨åŸŸå¹¶ä¸”ä¸åŒçº¿ç¨‹å…·æœ‰ä¸åŒçš„æ•°æ®å‰¯æœ¬çš„æ—¶å€™ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ThreadLocalã€‚æ¯”å¦‚å¯¹äºHandleræ¥è¯´ï¼Œå®ƒéœ€è¦è·å–å½“å‰çº¿ç¨‹çš„Looperï¼Œå¾ˆæ˜¾ç„¶Looperçš„ä½œç”¨åŸŸå°±æ˜¯çº¿ç¨‹å¹¶ä¸”ä¸åŒçº¿ç¨‹å…·æœ‰ä¸åŒçš„Looperï¼Œè¿™ä¸ªæ—¶å€™é€šè¿‡ThreadLocalå°±å¯ä»¥è½»æ¾å®ç°Looperåœ¨çº¿ç¨‹ä¸­çš„å­˜å–ï¼Œå¦‚æœä¸é‡‡ç”¨ThreadLocalï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¿…é¡»æä¾›ä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ä¾›HandleræŸ¥æ‰¾æŒ‡å®šçº¿ç¨‹çš„Looperï¼Œè¿™æ ·ä¸€æ¥å°±å¿…é¡»æä¾›ä¸€ä¸ªç±»ä¼¼äºLooperManagerçš„ç±»äº†ï¼Œä½†æ˜¯ç³»ç»Ÿå¹¶æ²¡æœ‰è¿™ä¹ˆåšè€Œæ˜¯é€‰æ‹©äº†ThreadLocalï¼Œè¿™å°±æ˜¯ThreadLocalçš„å¥½å¤„ã€‚\n\nå¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯å°±æ˜¯å¤æ‚é€»è¾‘ä¸‹çš„å¯¹è±¡ä¼ é€’ã€‚æ¯”å¦‚ç›‘å¬å™¨çš„ä¼ é€’ï¼Œæœ‰äº›æ—¶å€™ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»»åŠ¡è¿‡äºå¤æ‚ï¼Œè¿™å¯èƒ½è¡¨ç°ä¸ºå‡½æ•°è°ƒç”¨æ ˆæ¯”è¾ƒæ·±ä»¥åŠä»£ç å…¥å£çš„å¤šæ ·æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆéœ€è¦ç›‘å¬å™¨èƒ½å¤Ÿè´¯ç©¿æ•´ä¸ªçº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ€ä¹ˆåšå‘¢ï¼Ÿå…¶å®å°±å¯ä»¥é‡‡ç”¨ThreadLocalï¼Œé‡‡ç”¨ThreadLocalå¯ä»¥è®©ç›‘å¬å™¨ä½œä¸ºçº¿ç¨‹å†…çš„å…¨å±€å¯¹è±¡è€Œå­˜åœ¨ï¼Œåœ¨çº¿ç¨‹å†…éƒ¨åªè¦é€šè¿‡getæ–¹æ³•å°±å¯ä»¥è·å–åˆ°ç›‘å¬å™¨ã€‚è€Œå¦‚æœä¸é‡‡ç”¨ThreadLocalï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½æƒ³åˆ°çš„å¯èƒ½æ˜¯å¦‚ä¸‹ä¸¤ç§æ–¹æ³•ï¼šç¬¬ä¸€ç§æ–¹æ³•æ˜¯å°†ç›‘å¬å™¨é€šè¿‡å‚æ•°çš„å½¢å¼åœ¨å‡½æ•°è°ƒç”¨æ ˆä¸­è¿›è¡Œä¼ é€’ï¼Œç¬¬äºŒç§æ–¹æ³•å°±æ˜¯å°†ç›‘å¬å™¨ä½œä¸ºé™æ€å˜é‡ä¾›çº¿ç¨‹è®¿é—®ã€‚ä¸Šè¿°è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯æœ‰å±€é™æ€§çš„ã€‚ç¬¬ä¸€ç§æ–¹æ³•çš„é—®é¢˜æ—¶å½“å‡½æ•°è°ƒç”¨æ ˆå¾ˆæ·±çš„æ—¶å€™ï¼Œé€šè¿‡å‡½æ•°å‚æ•°æ¥ä¼ é€’ç›‘å¬å™¨å¯¹è±¡è¿™å‡ ä¹æ˜¯ä¸å¯æ¥å—çš„ï¼Œè¿™ä¼šè®©ç¨‹åºçš„è®¾è®¡çœ‹èµ·æ¥å¾ˆç³Ÿç³•ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä½†æ˜¯è¿™ç§çŠ¶æ€æ˜¯ä¸å…·æœ‰å¯æ‰©å……æ€§çš„ï¼Œæ¯”å¦‚å¦‚æœåŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆå°±éœ€è¦æä¾›ä¸¤ä¸ªé™æ€çš„ç›‘å¬å™¨å¯¹è±¡ï¼Œå¦‚æœæœ‰10ä¸ªçº¿ç¨‹åœ¨å¹¶å‘æ‰§è¡Œå‘¢ï¼Ÿæä¾›10ä¸ªé™æ€çš„ç›‘å¬å™¨å¯¹è±¡ï¼Ÿè¿™æ˜¾ç„¶æ˜¯ä¸å¯æ€è®®çš„ï¼Œè€Œé‡‡ç”¨ThreadLocalæ¯ä¸ªç›‘å¬å™¨å¯¹è±¡éƒ½åœ¨è‡ªå·±çš„çº¿ç¨‹å†…éƒ¨å­˜å‚¨ï¼Œæ ¹æ®å°±ä¸ä¼šæœ‰æ–¹æ³•2çš„è¿™ç§é—®é¢˜ã€‚\n\n# æºç \nä½œä¸ºä¸€ä¸ªå­˜å‚¨æ•°æ®çš„ç±»ï¼Œå…³é”®ç‚¹å°±åœ¨getå’Œsetæ–¹æ³•ã€‚\n## ThreadLocal # set\n\n```java\npublic void set(T value) {\n    // è·å–å½“å‰çº¿ç¨‹\n    Thread t = Thread.currentThread();\n    // å®é™…ä¸Šå­˜å‚¨æ•°æ®çš„ç»“æ„ç±»å‹\n    // ->> åˆ†æ1\n    ThreadLocalMap map = getMap(t);\n    // å¦‚æœå­˜åœ¨Mapå°±ç›´æ¥setï¼Œæ²¡æœ‰å°±åˆ›å»ºmapå¹¶set\n    if (map != null)\n        map.set(this, value);\n    else\n        // ->> åˆ†æ2\n        createMap(t, value);\n}\n\n\n/**\n * åˆ†æ1ï¼šgetMap()æ–¹æ³•\n */\nThreadLocalMap getMap(Thread t) {\n    // è¿”å›ä¼ å…¥çº¿ç¨‹çš„ThreadLocalMap\n    return t.threadLocals;\n}\n\n/**\n * åˆ†æ2ï¼šcreateMap()æ–¹æ³•\n */\nvoid createMap(Thread t, T firstValue) {\n    // åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadLocalMapå¹¶å°†å€¼ä¼ å…¥\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}\n```\nå½“ä½ è°ƒç”¨setæ–¹æ³•æ—¶ï¼Œå°±ä¼šæ‹¿åˆ°å½“å‰çº¿ç¨‹å¹¶å¾—åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œå¦‚æœmapä¸ä¸ºç©ºï¼Œé‚£å°±ç›´æ¥æŠŠå€¼ä¼ å…¥mapï¼›å¦‚æœmapä¸ºç©ºé‚£å°±æ–°å»ºä¸€ä¸ªå†ä¼ å€¼ã€‚\n\nè¿™å—æˆ‘ä»¬å°±èƒ½æ‡‚ä¸ºå•¥ThreadLocalèƒ½åªæ“ä½œè‡ªå·±çº¿ç¨‹é‡Œé¢çš„ä¸œè¥¿äº†ï¼Œå› ä¸ºæ‰€æœ‰ThreadLocaléƒ½ä¸ä»–çº¿ç¨‹ä¸­çš„ThreadLocalMapæœ‰å…³ã€‚\n\né‚£æˆ‘ä»¬å†æ¥çœ‹çœ‹ThreadLocalMapã€‚\n## ThreadLocalMap\n### å±æ€§å˜é‡\nå…ˆæ¥çœ‹ä¸‹ThreadLocalMapçš„ä¸€äº›å˜é‡ã€‚\n```java\n// å­˜å‚¨æ•°æ®çš„ç»“æ„ä¸ºEntryï¼Œè€Œä¸”keyæ˜¯å¼±å¼•ç”¨\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    Object value;\n\n    Entry(ThreadLocal<?> k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n\n// tableçš„åˆå§‹å®¹é‡\nprivate static final int INITIAL_CAPACITY = 16;\n\n// tableç”¨äºå­˜å‚¨æ•°æ®\nprivate Entry[] table;\n\n// \nprivate int size = 0;\n\n// è´Ÿè½½å› å­ï¼Œç”¨äºæ‰©å®¹\nprivate int threshold; // Default to 0\n\n// è®¾ç½®è´Ÿè½½å› å­ï¼Œé»˜è®¤ä¸ºå½“å‰å¤§å°çš„2/3\nprivate void setThreshold(int len) {\n    threshold = len * 2 / 3;\n}\n\n// ä¸‹ä¸€ä¸ªç´¢å¼•\nprivate static int nextIndex(int i, int len) {\n    return ((i + 1 < len) ? i + 1 : 0);\n}\n\n// ä¸Šä¸€ä¸ªç´¢å¼•\nprivate static int prevIndex(int i, int len) {\n    return ((i - 1 >= 0) ? i - 1 : len - 1);\n}\n\n// æ„é€ å‡½æ•°\nThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n    table = new Entry[INITIAL_CAPACITY];\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n    table[i] = new Entry(firstKey, firstValue);\n    size = 1;\n    setThreshold(INITIAL_CAPACITY);\n}\n```\n\n### ThreadLocalMap # set()\n```java\nprivate void set(ThreadLocal<?> key, Object value) {\n\n    Entry[] tab = table;\n    int len = tab.length;\n    // æ ¹æ®å“ˆå¸Œç®—æ³•æ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹\n    int i = key.threadLocalHashCode & (len-1);\n\n    //åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœkeyå€¼ç›¸åŒï¼Œå°±æ›¿æ¢ï¼Œå¦‚æœä¸åŒåˆ™æ‰¾ç©ºä½æ”¾æ•°æ®ã€‚\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal<?> k = e.get();\n        //åˆ¤æ–­keyå€¼ç›¸åŒå¦ï¼Œå¦‚æœæ˜¯ç›´æ¥è¦†ç›– ï¼ˆç¬¬ä¸€ç§æƒ…å†µï¼‰\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        //å¦‚æœå½“å‰Entryå¯¹è±¡å¯¹åº”Keyå€¼ä¸ºnull,åˆ™æ¸…ç©ºæ‰€æœ‰Keyä¸ºnullçš„æ•°æ®ï¼ˆç¬¬äºŒç§æƒ…å†µï¼‰\n        if (k == null) {\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n    }\n    //ä»¥ä¸Šæƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œç›´æ¥æ·»åŠ ï¼ˆç¬¬ä¸‰ç§æƒ…å†µï¼‰\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        rehash();\n}\n```\nå…ˆæ ¹æ®keyé€šè¿‡å“ˆå¸Œç®—æ³•å¾—åˆ°å¯¹åº”çš„iï¼Œç„¶åå†å¼€å§‹ä»è¿™ä¸ªiå¼€å§‹éå†ï¼Œè¿›è¡Œåˆ¤æ–­ï¼Œç”±äºä¸‹é¢ä¸‰ä¸ªåˆ¤æ–­æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†å¼€æ¥è®²ã€‚\n\n#### ç¬¬ä¸€ç§æƒ…å†µ\nè¿™ç§æƒ…å†µä¸‹ï¼Œkeyå€¼ç›¸åŒï¼Œå°±éœ€è¦å°†valueæ›¿æ¢æ‰ã€‚\n![ç¬¬ä¸€ç§æƒ…å†µ](http://cdn.littlecorgi.top/mweb/2019-11-08/%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%83%85%E5%86%B5.jpg)\n\n#### ç¬¬äºŒç§æƒ…å†µ\nè¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œå…ˆçœ‹ä¸‹ä»£ç ï¼š\n```java\nprivate void replaceStaleEntry(ThreadLocal<?> key, Object value,\n                               int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n    Entry e;\n    \n    int slotToExpunge = staleSlot;\n    // å…ˆå¾€å‰è¿›è¡Œåˆ¤æ–­ï¼Œçœ‹æ˜¯å¦èƒ½æ‰¾åˆ°ç©ºçš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°äº†å°±æ›´æ–°slotToExpunge\n    for (int i = prevIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = prevIndex(i, len))\n        if (e.get() == null)\n            slotToExpunge = i;\n\n    // å†å¾€åéå†\n    for (int i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n        ThreadLocal<?> k = e.get();\n\n        // å¦‚æœå½“å‰ièŠ‚ç‚¹çš„keyå’Œä¼ å…¥çš„keyç›¸åŒï¼Œé‚£å°±è¿›è¡Œæ›¿æ¢\n        if (k == key) {\n            e.value = value;\n\n            tab[i] = tab[staleSlot];\n            tab[staleSlot] = e;\n\n            /*\n             * å¦‚æœåœ¨æ•´ä¸ªæ‰«æè¿‡ç¨‹ä¸­ï¼ˆåŒ…æ‹¬å‡½æ•°ä¸€å¼€å§‹çš„å‘å‰æ‰«æä¸iä¹‹å‰çš„å‘åæ‰«æï¼‰\n             * æ‰¾åˆ°äº†ä¹‹å‰çš„æ— æ•ˆslotåˆ™ä»¥é‚£ä¸ªä½ç½®ä½œä¸ºæ¸…ç†çš„èµ·ç‚¹ï¼Œ\n             * å¦åˆ™åˆ™ä»¥å½“å‰çš„iä½œä¸ºæ¸…ç†èµ·ç‚¹\n             */\n            if (slotToExpunge == staleSlot)\n                slotToExpunge = i;\n            // è¿›è¡Œä¸€æ¬¡è¿ç»­æ®µçš„æ¸…ç†ï¼Œå†åšä¸€æ¬¡å¯å‘å¼æ¸…ç†\n            // ->> åˆ†æ1\n            // ->> åˆ†æ2\n            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n            return;\n        }\n\n        // å¦‚æœå½“å‰çš„slotå·²ç»æ— æ•ˆï¼Œå¹¶ä¸”å‘å‰æ‰«æè¿‡ç¨‹ä¸­æ²¡æœ‰æ— æ•ˆslotï¼Œåˆ™æ›´æ–°slotToExpungeä¸ºå½“å‰ä½ç½®\n        if (k == null && slotToExpunge == staleSlot)\n            slotToExpunge = i;\n    }\n\n    // å¦‚æœkeyåœ¨tableä¸­ä¸å­˜åœ¨ï¼Œåˆ™åœ¨åŸåœ°æ”¾ä¸€ä¸ªå³å¯\n    tab[staleSlot].value = null;\n    tab[staleSlot] = new Entry(key, value);\n\n    // åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­å¦‚æœå‘ç°ä»»ä½•æ— æ•ˆslotï¼Œåˆ™åšä¸€æ¬¡æ¸…ç†ï¼ˆè¿ç»­æ®µæ¸…ç†+å¯å‘å¼æ¸…ç†ï¼‰\n    // ->> åˆ†æ1\n    // ->> åˆ†æ2\n    if (slotToExpunge != staleSlot)\n        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n}\n\n\n/**\n * åˆ†æ1ï¼šexpungeStaleEntry()\n * ä½œç”¨ï¼šæŠŠè¿ç»­æ®µå†…æ‰€æœ‰æ— æ•ˆçš„slotéƒ½æ¸…ç†ä¸€é\n */\nprivate int expungeStaleEntry(int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    tab[staleSlot].value = null;\n    tab[staleSlot] = null;\n    size--;\n\n    Entry e;\n    int i;\n    for (i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n        ThreadLocal<?> k = e.get();\n        if (k == null) {\n            e.value = null;\n            tab[i] = null;\n            size--;\n        } else {\n            int h = k.threadLocalHashCode & (len - 1);\n            if (h != i) {\n                tab[i] = null;\n\n                while (tab[h] != null)\n                    h = nextIndex(h, len);\n                tab[h] = e;\n            }\n        }\n    }\n    return i;\n}\n\n/**\n * åˆ†æ2ï¼šcleanSomeSlots()\n * ä½œç”¨ï¼šéå†åˆ é™¤æ‰€æœ‰ä½ç½®ä¸‹key==nullçš„æ•°æ®\n */\nprivate boolean cleanSomeSlots(int i, int n) {\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null && e.get() == null) {\n            n = len;\n            removed = true;\n            // ->> åˆ†æ3\n            i = expungeStaleEntry(i);\n        }\n    } while ( (n >>>= 1) != 0);\n    return removed;\n}\n```\n\nç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n![ç¬¬äºŒç§æƒ…å†µ](http://cdn.littlecorgi.top/mweb/2019-11-08/%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%83%85%E5%86%B5.jpg)\n\n\n#### ç¬¬ä¸‰ç§æƒ…å†µ\nç¬¬ä¸‰ç§æƒ…å†µå°±æ˜¯ä¸Šé¢ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ’å…¥çš„ä½ç½®ä¸ºnullçš„æ—¶å€™ï¼Œå°±ç›´æ¥æ‰©å¤§ThreadLocalMapï¼Œç„¶åå†æ’å…¥ï¼š\n![ç¬¬ä¸‰ç§æƒ…å†µ](http://cdn.littlecorgi.top/mweb/2019-11-08/%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5.jpg)\n\n\n```java\ntab[i] = new Entry(key, value);\nint sz = ++size;\n// ->> cleanSomeSlotsè§ä¸Šé¢ç¬¬äºŒç§æƒ…å†µçš„åˆ†æ2\nif (!cleanSomeSlots(i, sz) && sz >= threshold)\n    // ->> åˆ†æ1\n    rehash();\n\n\n/**\n * åˆ†æ1ï¼šrehash()\n */\nprivate void rehash() {\n    // ->> expungeStaleEntriesè§ä¸Šé¢ç¬¬äºŒç§æƒ…å†µçš„åˆ†æ1\n    expungeStaleEntries();\n\n    if (size >= threshold - threshold / 4)\n        // ->> åˆ†æ2\n        resize();\n}\n\n/**\n * åˆ†æ2ï¼šresize()\n */\nprivate void resize() {\n    Entry[] oldTab = table;\n    int oldLen = oldTab.length;\n    int newLen = oldLen * 2;\n    Entry[] newTab = new Entry[newLen];\n    int count = 0;\n\n    for (int j = 0; j < oldLen; ++j) {\n        Entry e = oldTab[j];\n        if (e != null) {\n            ThreadLocal<?> k = e.get();\n            if (k == null) {\n                e.value = null; // Help the GC\n            } else {\n                int h = k.threadLocalHashCode & (newLen - 1);\n                while (newTab[h] != null)\n                    h = nextIndex(h, newLen);\n                newTab[h] = e;\n                count++;\n            }\n        }\n    }\n\n    setThreshold(newLen);\n    size = count;\n    table = newTab;\n}\n```\n\n### ThreadLocalMap # getEntry()\n```java\nprivate Entry getEntry(ThreadLocal<?> key) {\n    int i = key.threadLocalHashCode & (table.length - 1);\n    Entry e = table[i];\n    if (e != null && e.get() == key)\n        return e;\n    else\n        // ->> åˆ†æ1\n        return getEntryAfterMiss(key, i, e);\n}\n\n\n/**\n * åˆ†æ1ï¼šgetEntryAfterMiss()\n */\nprivate Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    // ä»å½“å‰å¾€åä¸€ä¸ªä¸ªè¿›è¡Œéå†ï¼Œç›´è‡³æ‰¾åˆ°å’Œkeyç›¸ç­‰çš„ç„¶åè¿”å›\n    while (e != null) {\n        ThreadLocal<?> k = e.get();\n        if (k == key)\n            return e;\n        if (k == null)\n            expungeStaleEntry(i);\n        else\n            i = nextIndex(i, len);\n        e = tab[i];\n    }\n    return null;\n}\n```\n\n### ThreadLocalMap # remove()\n```java\nprivate void remove(ThreadLocal<?> key) {\n    Entry[] tab = table;\n    int len = tab.length;\n    int i = key.threadLocalHashCode & (len-1);\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        if (e.get() == key) {\n            // æ˜¾å¼æ–­å¼€å¼±å¼•ç”¨\n            e.clear();\n            expungeStaleEntry(i);\n            return;\n        }\n    }\n}\n```","tags":["Android","æºç ","Handler","ThreadLocal"],"categories":["Android"]},{"title":"Viewçš„äº‹ä»¶åˆ†å‘","url":"/posts/bfb9e8a9.html","content":"ä»æˆ‘åˆšè¿›å®éªŒå®¤çš„æ—¶å€™ï¼Œå­¦é•¿å­¦å§å°±è¯´Viewçš„äº‹ä»¶åˆ†å‘æœºåˆ¶æ˜¯Androidé‡Œé¢ä¸€ä¸ªå¾ˆé‡è¦çš„å†…å®¹ï¼Œè¦æˆ‘ä»¬å¥½å¥½å­¦ã€‚\n\nä½†æ˜¯éšç€è‡ªå·±å¯¹Androidäº†è§£çš„æ·±å…¥ï¼Œè¶Šå‘è§‰å¾—è¿™ä¸ªä¸œè¥¿å¾ˆæœ‰å¿…è¦äº†è§£ä¸‹ï¼Œæ­£å¥½Androidè‰ºæœ¯å¼€å‘æ¢ç´¢ä¹Ÿçœ‹åˆ°äº†Viewè¿™å—ï¼Œä¹Ÿçœ‹äº†[éƒ­éœ–å¤§ç¥çš„åšå®¢](https://blog.csdn.net/guolin_blog/article/details/9097463)å’Œ[å¦ä¸€ä½å¤§ç¥çš„åšå®¢](https://www.jianshu.com/p/ea0108d8510e)ï¼Œæ‰€ä»¥å°±å¥½å¥½å­¦ä¹ äº†ä¸€ç•ªï¼Œå¹¶å†™äº†æ­¤åšå®¢ã€‚\n\n\n# 1. MotionEvent\nåœ¨å¼€å§‹è®²Viewäº‹ä»¶åˆ†å‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹MotionEventã€‚\n\nè¿™ä¸ªå°±æ˜¯æ‰‹æŒ‡è§£é™¤åˆ°å±å¹•åæ‰€äº§ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ï¼Œä¸»è¦ä¸ºä¸€ä¸‹ä¸‰ä¸ªå…¸å‹äº‹ä»¶ï¼š\n- ACTION_DOWMâ€”â€”æ‰‹æŒ‡åˆšæ¥è§¦å±å¹•\n- ACTION_MOVEâ€”â€”æ‰‹æŒ‡åœ¨å±å¹•ä¸Šç§»åŠ¨\n- ACTION_UPâ€”â€”æ‰‹æŒ‡ä»å±å¹•ä¸Šæ¾å¼€\n- ACTION_CANCELâ€”â€”ç»“æŸäº‹ä»¶ï¼ˆéäººä¸ºï¼‰\n\næ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ‰‹æŒ‡è§¦æ‘¸å±å¹•ç„¶åç¦»å¼€å¯èƒ½è§¦å‘ä¸€ä¸‹ä¸¤ç§æƒ…å†µï¼š\n- ç‚¹å‡»å±å¹•ç„¶åæ¾å¼€ï¼šACTION_DOWN -> ACTION_UP\n- ç‚¹å‡»å±å¹•ç„¶åæ»‘åŠ¨å†æ¾å¼€ï¼šACTION_DOWN -> ACTION_MOVE -> ACTION_UP\n\nä¸‹é¢ä¸€ä¸ªå›¾ç‰‡æ¥æ¦‚æ‹¬ä¸‹ï¼š\n![MotionEvent](http://cdn.littlecorgi.top/mweb/2019-10-31/MotionEvent.png)\n\n# 2. äº‹ä»¶åˆ†å‘ä¼ é€’è§„åˆ™\nä¼—æ‰€å‘¨çŸ¥ï¼ŒAndroidUIæ˜¯ç”±Activityã€ViewGroupã€ViewåŠå…¶æ´¾ç”Ÿç±»ç»„æˆçš„ã€‚\n\nå¤§è‡´ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n![AndroidUI](http://cdn.littlecorgi.top/mweb/2019-10-31/AndroidUI.jpg)\n\nå…¶ä¸­ï¼š\n- Activityï¼šæ§åˆ¶ç”Ÿå‘½å‘¨æœŸæˆ–è€…å¤„ç†äº‹ä»¶\n- ViewGroupï¼šä¸€ç»„Viewæˆ–è€…å¤šä¸ªViewçš„é›†åˆã€‚ä¹Ÿæ˜¯å¸ƒå±€Layoutçš„åŸºç±»ã€‚ä½†æ˜¯ç‰¹åˆ«çš„æ˜¯ï¼Œä»–ä¹Ÿé›†æˆè‡ªViewã€‚\n- Viewï¼šæ‰€æœ‰UIç»„ä»¶çš„åŸºç±»\n\nä»ä¸Šå›¾æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œäº‹ä»¶åˆ†å‘çš„é¡ºåºå°±æ˜¯ï¼šActivity -> ViewGroup -> Viewã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªç‚¹å‡»äº‹ä»¶äº§ç”Ÿï¼Œå…ˆäº¤ç”±Activityï¼Œå†ä¼ åˆ°ViewGroupï¼Œå†ä¼ åˆ°Viewã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­åªè¦æœ‰ä¸€ä¸ªéƒ¨åˆ†è¯´è¦æ‹¦æˆªï¼Œå°±ä¸ä¼šå†ç»§ç»­å¾€ä¸‹ä¼ é€’ã€‚\n\n# 3. äº‹ä»¶åˆ†å‘çš„æ ¸å¿ƒæ–¹æ³•\nå…¶å®æ—¶é—´åˆ†å‘çš„æ ¸å¿ƒæ–¹æ³•å¾ˆç®€å•ï¼Œå°±ç”±ä¸‰ä¸ªæ–¹æ³•ç»„æˆï¼š\n\n- public boolean dispatchTouchEvent(MotionEvent ev)\nç”¨æ¥è¿›è¡Œäº‹ä»¶çš„åˆ†å‘ã€‚å¦‚æœäº‹ä»¶èƒ½å¤Ÿä¼ é€’ç»™å½“å‰Viewï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿”å›ç»“æœå—å½“å‰Viewçš„onTouchEventå’Œä¸‹çº§Viewçš„dispatchTouchEventæ–¹æ³•çš„å½±å“ï¼Œè¡¨ç¤ºæ˜¯å¦æ¶ˆè€—å½“å‰äº‹ä»¶ã€‚\n- public boolean onInterceptTouchEvent(MotionEvent event)\nåœ¨dispatchTouchEventæ–¹æ³•å†…éƒ¨è°ƒç”¨ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦æ‹¦æˆªæŸä¸ªäº‹ä»¶ï¼Œå¦‚æœå½“å‰Viewæ‹¦æˆªäº†æŸä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆåœ¨åŒä¸€äº‹ä»¶åºåˆ—å½“ä¸­ï¼Œæ­¤æ–¹æ³•ä¸ä¼šå†æ¬¡è¢«è°ƒç”¨ï¼Œè¿”å›ç»“æœè¡¨ç¤ºæ˜¯å¦æ‹¦æˆªå½“å‰äº‹ä»¶ã€‚ï¼ˆåªæœ‰ViewGroupä¸­æ‰æœ‰æ­¤æ–¹æ³•ï¼ŒViewä¸­æ²¡æœ‰ï¼‰\n\n- public boolean onTouchEvent(MotionEvent event)\nåœ¨dispatchTouchEventæ–¹æ³•ä¸­è°ƒç”¨ï¼Œç”¨æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œè¿”å›ç»“æœè¡¨ç¤ºæ˜¯å¦æ¶ˆè€—å½“å‰äº‹ä»¶ï¼Œå¦‚æœä¸æ¶ˆè€—ï¼Œåˆ™åœ¨åŒä¸€ä¸ªäº‹ä»¶åºåˆ—ä¸­ï¼Œå½“å‰Viewæ— æ³•å†æ¬¡æ¥æ”¶åˆ°äº‹ä»¶ã€‚\n\nä¸‰ä¸ªæ–¹æ³•é—´çš„å…³ç³»å¯ä»¥æŒ‰ä¸‹é¢ä¸€æ®µä¼ªä»£ç è¡¨ç¤ºï¼šï¼ˆ[å‚è€ƒ](https://www.jianshu.com/p/ea0108d8510e)çš„ä»£ç ï¼‰\n```java\n\n/**\n  * ç‚¹å‡»äº‹ä»¶äº§ç”Ÿå \n  */ \n  // æ­¥éª¤1ï¼šè°ƒç”¨dispatchTouchEventï¼ˆï¼‰\n  public boolean dispatchTouchEvent(MotionEvent ev) {\n\n    boolean consume = false; //ä»£è¡¨ æ˜¯å¦ä¼šæ¶ˆè´¹äº‹ä»¶\n\n    // æ­¥éª¤2ï¼šåˆ¤æ–­æ˜¯å¦æ‹¦æˆªäº‹ä»¶\n    if (onInterceptTouchEvent(ev)) {\n      // a. è‹¥æ‹¦æˆªï¼Œåˆ™å°†è¯¥äº‹ä»¶äº¤ç»™å½“å‰Viewè¿›è¡Œå¤„ç†\n      // å³è°ƒç”¨onTouchEvent (ï¼‰æ–¹æ³•å»å¤„ç†ç‚¹å‡»äº‹ä»¶\n        consume = onTouchEvent (ev) ;\n\n    } else {\n\n      // b. è‹¥ä¸æ‹¦æˆªï¼Œåˆ™å°†è¯¥äº‹ä»¶ä¼ é€’åˆ°ä¸‹å±‚\n      // å³ ä¸‹å±‚å…ƒç´ çš„dispatchTouchEventï¼ˆï¼‰å°±ä¼šè¢«è°ƒç”¨ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹\n      // ç›´åˆ°ç‚¹å‡»äº‹ä»¶è¢«æœ€ç»ˆå¤„ç†ä¸ºæ­¢\n      consume = child.dispatchTouchEvent (ev) ;\n    }\n\n    // æ­¥éª¤3ï¼šæœ€ç»ˆè¿”å›é€šçŸ¥ è¯¥äº‹ä»¶æ˜¯å¦è¢«æ¶ˆè´¹ï¼ˆæ¥æ”¶ & å¤„ç†ï¼‰\n    return consume;\n}\n```\nå¯¹äºä¸€ä¸ªæ ¹ViewGroupï¼Œç‚¹å‡»äº‹ä»¶äº§ç”Ÿåï¼Œå°±ä¼šä¼ é€’ç»™ä»–ï¼Œè¿™æ—¶ä»–çš„dispatchTouchEventå°±ä¼šè¢«è°ƒç”¨ï¼Œç„¶åå°±å¼€å§‹åˆ¤æ–­ä»–æ˜¯å¦æ‹¦æˆªã€‚å¦‚æœæ‹¦æˆªï¼Œé‚£ä¹ˆç‚¹å‡»äº‹ä»¶å°±ä¼šç»™ViewGroupå»å¤„ç†ï¼Œå¦‚æœä¸æ‹¦æˆªï¼Œå°±è°ƒç”¨child.dispatchTouchEvent (ev) ä¼ ç»™å­æ§ä»¶çš„dispatchTouchEventæ–¹æ³•ã€‚ç„¶åç»§ç»­å¾ªç¯ï¼Œç›´åˆ°åˆ°æœ€åº•å±‚viewï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰childçš„æ—¶å€™ï¼Œæˆ–è€…ç›´åˆ°äº‹ä»¶è¢«æ‹¦æˆªã€‚\n\n# 4. æºç åˆ†æ\n## 4.1 Activityäº‹ä»¶åˆ†å‘\né¦–å…ˆå…ˆæ¥çœ‹dispatchTouchEventæ–¹æ³•ï¼š\n### æºç \n```java\npublic boolean dispatchTouchEvent(MotionEvent ev) {\n    if (ev.getAction() == MotionEvent.ACTION_DOWN) {\n        onUserInteraction();\n        // ->> åˆ†æ1\n    }\n    if (getWindow().superDispatchTouchEvent(ev)) {\n    // ->> åˆ†æ2\n        return true;\n    }\n    return onTouchEvent(ev);\n    // ->> åˆ†æ5\n}\n\n/**\n  * åˆ†æ1ï¼šonUserInteraction()\n  * è¿™ä¸ªæ–¹æ³•å°±æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘æ˜¯åœ¨æ²¡ææ‡‚è¿™ä¸ªæ–¹æ³•æ˜¯å¹²å˜›çš„ï¼Œæ‰€ä»¥å°±ç›´æ¥ç²˜è´´äº†carsonè¿™ä½å¤§ç¥çš„è¯´æ˜\n  * ä½œç”¨ï¼šå®ç°å±ä¿åŠŸèƒ½\n  * æ³¨ï¼š\n  *    a. è¯¥æ–¹æ³•ä¸ºç©ºæ–¹æ³•\n  *    b. å½“æ­¤activityåœ¨æ ˆé¡¶æ—¶ï¼Œè§¦å±ç‚¹å‡»æŒ‰homeï¼Œbackï¼Œmenué”®ç­‰éƒ½ä¼šè§¦å‘æ­¤æ–¹æ³•\n  */\npublic void onUserInteraction() {\n}\n\n/**\n  * åˆ†æ2ï¼šgetWindow().superDispatchTouchEvent(ev)\n  * ç‚¹å¼€ä¹‹åè¿›å…¥Windowç±»ï¼Œ\n  * ä½†æ˜¯å‘ç°è¿™ä¸ªç±»æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ã€‚\n  * \n  * äº†è§£è¿‡Viewçš„åŒå­¦éƒ½çŸ¥é“ï¼ŒWindowçš„å”¯ä¸€å®ç°ç±»å°±æ˜¯PhoneWindow\n  * é‚£æˆ‘ä»¬è¿›å…¥PhoneWindowçœ‹ä¸‹ä»–çš„superDispatchTouchEventæ–¹æ³•\n  */\npublic abstract boolean superDispatchTouchEvent(MotionEvent event);\n// ->> åˆ†æ3\n\n/**\n  * åˆ†æ3ï¼šPhoneWindow.superDispatchTouchEvent()\n  * å®é™…ä¸Šåˆè°ƒç”¨äº†DecorViewçš„superDispatchTouchEventæ–¹æ³•ï¼ŒDecorViewæ˜¯æœ€é¡¶å±‚çš„View\n  */\n@Override\npublic boolean superDispatchTouchEvent(MotionEvent event) {\n    return mDecor.superDispatchTouchEvent(event);\n    // ->> åˆ†æ4\n}\n\n/**\n * åˆ†æ4ï¼šDecorView.superDispatchTouchEvent()\n * æ³¨ï¼š\n *     a. DecorViewç»§æ‰¿è‡ªFrameLayoutï¼Œè€ŒFrameLayoutç»§æ‰¿è‡ªViewGroupï¼Œä¹Ÿå°±æ˜¯è¯´DecorViewå°±æ˜¯ViewGroupã€‚\n *     b. DecorViewè°ƒç”¨äº†çˆ¶ç±»çš„dispatchTouchEventæ–¹æ³•ï¼Œä¹Ÿå°±ç›¸å½“äºViewGroupçš„dispatchTouchEventæ–¹æ³•ï¼Œå°±æŠŠäº‹ä»¶äº¤ç»™äº†ViewGroupå»å¤„ç†ï¼Œè¿™å—åé¢å†è¯´\n */\npublic boolean superDispatchTouchEvent(MotionEvent event) {\n    return super.dispatchTouchEvent(event);\n}\n\n/**\n * åˆ†æ5ï¼šreturn onTouchEvent(ev)\n * å½“è§¦æ‘¸å±äº‹ä»¶æœªç”±å…¶ä¸‹çš„ä»»ä½•è§†å›¾å¤„ç†æ—¶è°ƒç”¨\n * \n */\npublic boolean onTouchEvent(MotionEvent event) {\n    if (mWindow.shouldCloseOnTouch(this, event)) {\n    // ->> åˆ†æ6\n        finish();\n        return true;\n    }\n\n    return false;\n    // åªæœ‰åœ¨ç‚¹å‡»äº‹ä»¶åœ¨Windowè¾¹ç•Œå¤–æ‰ä¼šè¿”å›trueï¼Œä¸€èˆ¬æƒ…å†µéƒ½è¿”å›falseï¼Œåˆ†æå®Œæ¯•\n}\n\n/** \n * åˆ†æ6ï¼šWindow.shouldCloseOnTouch()\n * \n * è¿”å›ï¼š\n *         è¿”å›trueï¼šè¯´æ˜äº‹ä»¶åœ¨è¾¹ç•Œå¤–ï¼Œå³ æ¶ˆè´¹äº‹ä»¶\n *         è¿”å›falseï¼šæœªæ¶ˆè´¹ï¼ˆé»˜è®¤ï¼‰\n */\npublic boolean shouldCloseOnTouch(Context context, MotionEvent event) {\n    final boolean isOutside =\n            event.getAction() == MotionEvent.ACTION_DOWN && isOutOfBounds(context, event)\n            || event.getAction() == MotionEvent.ACTION_OUTSIDE;\n    // ä¸»è¦æ˜¯å¯¹äºå¤„ç†è¾¹ç•Œå¤–ç‚¹å‡»äº‹ä»¶çš„åˆ¤æ–­ï¼šæ˜¯å¦æ˜¯DOWNäº‹ä»¶ï¼Œeventçš„åæ ‡æ˜¯å¦åœ¨è¾¹ç•Œå†…ç­‰\n    if (mCloseOnTouchOutside && peekDecorView() != null && isOutside) {\n        // peekDecorViewæ˜¯è¿”å›PhoneWindowçš„mDecor\n        return true;\n    }\n    return false;\n}\n```\n\n### æµç¨‹\n![Activityäº‹ä»¶åˆ†å‘æµç¨‹](http://cdn.littlecorgi.top/mweb/2019-10-31/Activity%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%B5%81%E7%A8%8B.jpg)\n\n## 4.2 ViewGroupäº‹ä»¶åˆ†å‘\n### æºç \nç”±äºæ­¤éƒ¨åˆ†ä»£ç è¿‡é•¿ï¼Œæˆ‘ä»¬å°†ä»£ç æ‹†åˆ†æˆä¸¤éƒ¨åˆ†ï¼š\n#### part1\n```java\n@Override\npublic boolean dispatchTouchEvent(MotionEvent ev) {\n    ...// ä»…è´´å‡ºå…³é”®ä»£ç \n    \n    boolean handled = false;\n    /**\n     * onFilterTouchEventForSecurity(ev)\n     * ç­›é€‰touchäº‹ä»¶ï¼Œè¿›å»ä¹‹åçš„åˆ¤æ–­æ ¸å¿ƒå°±æ˜¯å½“å‰è§†å›¾æ˜¯å¦è¢«å…¶å®ƒçª—å£é®æŒ¡æˆ–è€…éšè—\n     */\n    if (onFilterTouchEventForSecurity(ev)) {\n        final int action = ev.getAction();\n        final int actionMasked = action & MotionEvent.ACTION_MASK;\n\n        // Handle an initial down.\n        // ->> åˆ†æ1\n        if (actionMasked == MotionEvent.ACTION_DOWN) {\n            // Throw away all previous state when starting a new touch gesture.\n            // The framework may have dropped the up or cancel event for the previous gesture\n            // due to an app switch, ANR, or some other state change.\n            cancelAndClearTouchTargets(ev);\n            resetTouchState();\n        }\n\n        // Check for interception.\n        final boolean intercepted;\n        /**\n         * åˆ†æ2\n         * å¯ä»¥çœ‹åˆ°ä¼šæœ‰ä¸¤ç§æƒ…å†µä¸‹æ‹¦æˆªäº‹ä»¶ï¼šäº‹ä»¶ç±»å‹ä¸ºDOWNï¼Œæˆ–è€…mFirstTouchTarget != nullã€‚\n         * é‚£ä¹ˆè¿™ä¸ªmFirstTouchTargetæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n         * ä»åé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œå½“ViewGroupä¸æ‹¦æˆªäº‹ä»¶äº¤ç»™å­å…ƒç´ å¤„ç†çš„æ—¶å€™ï¼ŒmFirstTouchTargetä¸ä¸ºnullã€‚\n         * æ‰€ä»¥ï¼Œä¹Ÿå°±æ˜¯è¯´å½“MotionEventä¸ºUPæˆ–è€…MOVEçš„æ—¶å€™ï¼Œéƒ½è¿›ä¸å»è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸è°ƒç”¨ViewGroupçš„onInterceptTouchEventï¼Œä»–ä¸æ‹¦æˆªäº‹ä»¶\n         */\n        if (actionMasked == MotionEvent.ACTION_DOWN\n                || mFirstTouchTarget != null) {\n            final boolean disallowIntercept = (mGroupFlags & FLAG_DISALLOW_INTERCEPT) != 0;\n            if (!disallowIntercept) {\n                intercepted = onInterceptTouchEvent(ev);\n                ev.setAction(action); // restore action in case it was changed\n            } else {\n                intercepted = false;\n            }\n        } else {\n            // There are no touch targets and this action is not an initial down\n            // so this view group continues to intercept touches.\n            intercepted = true;\n        }\n        \n/**\n * åˆ†æ1\n * äº‹ä»¶å¼€å§‹æ—¶ä¼šè°ƒç”¨resetTouchState()æ¥æ¸…ç©ºmFirstAndClearTouchTarget\n */\nif (actionMasked == MotionEvent.ACTION_DOWN) {\n    cancelAndClearTouchTargets(ev);\n    // æ ¸å¿ƒç›®çš„å°±æ˜¯æ¸…ç©ºmFirstAndClearTouchTarget\n    resetTouchState();\n}\n```\n\n#### part2\n```java\n        ...//çœç•¥ä¸­é—´ä»£ç \n        // è¿›å…¥ifè¯­å¥ï¼Œåˆ¤æ–­æ¡ä»¶ä¸ºæ²¡æœ‰å¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼ŒåŒæ—¶äº‹ä»¶æ²¡æœ‰ç»“æŸã€‚å¯¹ViewGroupçš„å­å…ƒç´ è¿›è¡Œéå†\n        if (!canceled && !intercepted) {\n        \n            ...//ç»§ç»­çœç•¥ä¸­é—´ä»£ç \n            \n                    // å¾—åˆ°æ‰€æœ‰çš„å­View\n                    final View[] children = mChildren;\n                    // å¯¹å­Viewè¿›è¡Œéå†\n                    for (int i = childrenCount - 1; i >= 0; i--) {\n                        final int childIndex = getAndVerifyPreorderedIndex(\n                                childrenCount, i, customOrder);\n                        final View child = getAndVerifyPreorderedView(\n                                preorderedList, children, childIndex);\n\n                        // If there is a view that has accessibility focus we want it\n                        // to get the event first and if not handled we will perform a\n                        // normal dispatch. We may do a double iteration but this is\n                        // safer given the timeframe.\n                        // è¯¥viewgroupè®¾ç½®äº‹ä»¶äº†æŒ‡å‘ç„¦ç‚¹Viewå¹¶ä¸”ç„¦ç‚¹Viewåœ¨å‰é¢å·²ç»æ‰¾åˆ°äº†\n                        if (childWithAccessibilityFocus != null) {\n                            // åˆ¤æ–­éå†çš„æ­¤Viewæ˜¯å¦æ˜¯ç„¦ç‚¹Viewï¼Œå¦‚æœä¸æ˜¯å°±ç›´æ¥ä¸‹ä¸€éå¾ªç¯\n                            if (childWithAccessibilityFocus != child) {\n                                continue;\n                            }\n                            // å¦‚æœæ˜¯çš„è¯å°±å°†æ‰¾åˆ°çš„ç„¦ç‚¹viewç½®ç©º\n                            // iå›åˆ°åˆ°æ•°ç¬¬ä¸€ä¸ªä¸‹æ ‡\n                            // è¿™æ ·åšçš„ç›®çš„æ˜¯å…ˆè®©è¯¥ç„¦ç‚¹viewå°è¯•è¿›è¡Œä¸‹é¢çš„æ™®é€šåˆ†å‘æ“ä½œ\n                            // å¦‚æœæˆåŠŸäº†ï¼Œä¼šåœ¨ä¸‹é¢è·³å‡ºå¾ªç¯ã€‚\n                            // å¦‚æœä¸æˆåŠŸï¼Œå°±å°†è®°å½•çš„ç„¦ç‚¹viewç½®ç©ºï¼Œ\n                            // ä»æœ€åä¸€ä¸ªå¼€å§‹é‡æ–°éå†ï¼Œä¸å†è¿›å…¥è¿™ä¸ªåˆ¤æ–­ã€‚\n                            childWithAccessibilityFocus = null;\n                            i = childrenCount - 1;\n                        }\n\n                        // åˆ¤æ–­å½“å‰å­Viewæ˜¯å¦èƒ½è·å–ç„¦ç‚¹æˆ–è€…æ˜¯å¦æ­£åœ¨åšåŠ¨ç”»\n                        if (!canViewReceivePointerEvents(child)\n                                || !isTransformedTouchPointInView(x, y, child, null)) {\n                            ev.setTargetAccessibilityFocus(false);\n                            continue;\n                        }\n\n                        newTouchTarget = getTouchTarget(child);\n                        if (newTouchTarget != null) {\n                            // Child is already receiving touch within its bounds.\n                            // Give it the new pointer in addition to the ones it is handling.\n                            newTouchTarget.pointerIdBits |= idBitsToAssign;\n                            break;\n                        }\n\n                        resetCancelNextUpFlag(child);\n                        // ->> åˆ†æ1\n                        if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {\n                            // Child wants to receive touch within its bounds.\n                            mLastTouchDownTime = ev.getDownTime();\n                            if (preorderedList != null) {\n                                // childIndex points into presorted list, find original index\n                                for (int j = 0; j < childrenCount; j++) {\n                                    if (chifcldren[childIndex] == mChildren[j]) {\n                                        mLastTouchDownIndex = j;\n                                        break;\n                                    }\n                                }\n                            } else {\n                                mLastTouchDownIndex = childIndex;\n                            }\n                            mLastTouchDownX = ev.getX();\n                            mLastTouchDownY = ev.getY();\n                            // ->> åˆ†æ2\n                            newTouchTarget = addTouchTarget(child, idBitsToAssign);\n                            alreadyDispatchedToNewTouchTarget = true;\n                            break;\n                        }\n\n                        // The accessibility focus didn't handle the event, so clear\n                        // the flag and do a normal dispatch to all children.\n                        ev.setTargetAccessibilityFocus(false);\n                    }\n                  \n                  ... //çœç•¥\n        }\n\n/**\n * åˆ†æ1 dispatchTransformedTouchEvent()\n * \n * æ ¸å¿ƒå°±æ˜¯é‚£ä¸ªif (child == null)ã€‚\n * å¦‚æœchildä¸ä¸ºç©ºï¼Œé‚£ä¹ˆäº‹ä»¶å°±äº¤ç»™å­Viewå¤„ç†\n */\nprivate boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,\n        View child, int desiredPointerIdBits) {\n    final boolean handled;\n\n    // Canceling motions is a special case.  We don't need to perform any transformations\n    // or filtering.  The important part is the action, not the contents.\n    final int oldAction = event.getAction();\n    if (cancel || oldAction == MotionEvent.ACTION_CANCEL) {\n        event.setAction(MotionEvent.ACTION_CANCEL);\n        if (child == null) {\n            handled = super.dispatchTouchEvent(event);\n        } else {\n            handled = child.dispatchTouchEvent(event);\n        }\n        event.setAction(oldAction);\n        return handled;\n    }\n    ...//çœç•¥\n}\n\n/**\n * åˆ†æ2\n * å¦‚æœå­Viewèƒ½å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆå°±è°ƒç”¨addTouchTargetæ–¹æ³•ï¼Œå¯¹mFirstTouchTargetæ–¹æ³•è¿›è¡Œå¤åˆ¶ï¼Œç„¶åå†è¿›å…¥part1ä¸­åˆ†æ2ã€‚\n */\nprivate TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) {\n    final TouchTarget target = TouchTarget.obtain(child, pointerIdBits);\n    target.next = mFirstTouchTarget;\n    mFirstTouchTarget = target;\n    return target;\n}\n```\n\n#### part3\n```java\n        // Dispatch to touch targets.\n        // å¦‚æœpart2å¼€å¤´çš„é‚£ä¸ªifæ²¡æœ‰è¿›ï¼Œä¹Ÿå°±æ˜¯å¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªçš„è¯ï¼Œç›´æ¥åˆ°è¿™æ¥\n        // å¹¶ä¸”å¦‚æœæ²¡æœ‰è¿›å…¥part2ï¼Œé‚£ä¹ˆmFirstTouchTargetä»ç„¶ä¸ºç©ºï¼Œé‚£ä¹ˆå°±è¿›å…¥if\n        if (mFirstTouchTarget == null) {\n            // No touch targets so treat this as an ordinary view.\n            // æ­¤å¤„åœ¨ä¸Šé¢åˆ†æè¿‡äº†ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ç”±äºchildç›´æ¥ä¼ å…¥äº†nullï¼Œé‚£ä¹ˆå°±æ‰§è¡Œsuper.dispatchTouchEvenã€‚\n            // é‚£ä¹ˆsuperæ˜¯è°å‘¢ï¼Ÿæˆ‘ä»¬åœ¨å‰é¢è¯´è¿‡ï¼ŒViewGroupæ˜¯ç»§æ‰¿è‡ªViewçš„ï¼Œé‚£ä¹ˆä»–å°±æ˜¯æ‰§è¡ŒViewçš„dispatchTouchEventã€‚\n            handled = dispatchTransformedTouchEvent(ev, canceled, null,\n                    TouchTarget.ALL_POINTER_IDS);\n        } else {\n            ... //çœç•¥\n        }\n\n        // Update list of touch targets for pointer up or cancel, if needed.\n        if (canceled\n                || actionMasked == MotionEvent.ACTION_UP\n                || actionMasked == MotionEvent.ACTION_HOVER_MOVE) {\n                // ->> åˆ†æ1\n            resetTouchState();\n        } else if (split && actionMasked == MotionEvent.ACTION_POINTER_UP) {\n            final int actionIndex = ev.getActionIndex();\n            final int idBitsToRemove = 1 << ev.getPointerId(actionIndex);\n            removePointersFromTouchTargets(idBitsToRemove);\n        }\n    }\n    \n    ...//çœç•¥\n    \n}\n\n/**\n * åˆ†æ1\n * åœ¨åŒä¸€äº‹ä»¶ç³»åˆ—ç»“æŸåè°ƒç”¨resetTouchState();\n */\nprivate void resetTouchState() {\n    // å¯¹mFirstTouchTargetæ¸…ç©ºè¿˜åŸ\n    clearTouchTargets();\n    resetCancelNextUpFlag(this);\n    mGroupFlags &= ~FLAG_DISALLOW_INTERCEPT;\n    mNestedScrollAxes = SCROLL_AXIS_NONE;\n}\n```\n\n### æµç¨‹\næ­¤å›¾æ¬è‡ª[Carson_Hoå¤§ä½¬çš„åšå®¢](https://www.jianshu.com/p/38015afcdb58)\n![](http://cdn.littlecorgi.top/mweb/2019-10-31/15725314562031.jpg)\n\n## 4.3 Viewäº‹ä»¶åˆ†å‘\n### æºç \n#### dispatchTouchEvent\n```java\npublic boolean dispatchTouchEvent(MotionEvent event) {\n    ...//çœç•¥\n\n    boolean result = false;\n\n    ...//çœç•¥\n\n    // å’ŒViewGroupä¸€æ ·çš„åˆ¤æ–­ï¼Œåˆ¤æ–­å½“å‰è§†å›¾æ˜¯å¦è¢«é®æŒ¡æˆ–è€…ä¸å¯è§\n    if (onFilterTouchEventForSecurity(event)) {\n        if ((mViewFlags & ENABLED_MASK) == ENABLED && handleScrollBarDragging(event)) {\n            result = true;\n        }\n        //noinspection SimplifiableIfStatement\n        ListenerInfo li = mListenerInfo;\n        // æ£€æµ‹æœ‰æ²¡æœ‰è®¾ç½®OnTOuchListenerï¼Œå¦‚æœæœ‰ï¼Œå¹¶ä¸”onTouchæ–¹æ³•è¿”å›trueé‚£ä¹ˆè¿›å…¥ifï¼Œç»“æœå¯¼è‡´onTouchEventä¸è¢«æ‰§è¡Œ\n        if (li != null && li.mOnTouchListener != null\n                && (mViewFlags & ENABLED_MASK) == ENABLED\n                && li.mOnTouchListener.onTouch(this, event)) {\n                \n            result = true;\n        }\n\n        // å¦‚æœæ²¡è¿›å…¥ä¸Šé¢çš„ifï¼Œä¹Ÿå°±ç›¸å½“äºæ²¡æœ‰è®¾ç½®OnTouchListenerï¼Œé‚£ä¹ˆæ‰§è¡ŒonTOuchEvent\n        if (!result && onTouchEvent(event)) {\n            result = true;\n        }\n    }\n\n    ...//çœç•¥\n\n    return result;\n}\n```\n\nä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ**onTouchçš„ä¼˜å…ˆçº§é«˜äºonTouchEvent**ã€‚\n\n#### onTouchEvent\n```java\npublic boolean onTouchEvent(MotionEvent event) {\n    final float x = event.getX();\n    final float y = event.getY();\n    final int viewFlags = mViewFlags;\n    final int action = event.getAction();\n\n    /**\n     * æ³¨é‡Š1 \n     * åªæœ‰åœ¨Clickã€LongClickã€contextClickéƒ½ä¸å¯ç”¨çš„æ—¶å€™æ‰ä¸ºfalse\n     */\n    final boolean clickable = ((viewFlags & CLICKABLE) == CLICKABLE\n            || (viewFlags & LONG_CLICKABLE) == LONG_CLICKABLE)\n            || (viewFlags & CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;\n\n    // é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯ä¸å¯ç”¨ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›å…¥if\n    if ((viewFlags & ENABLED_MASK) == DISABLED) {\n        if (action == MotionEvent.ACTION_UP && (mPrivateFlags & PFLAG_PRESSED) != 0) {\n            setPressed(false);\n        }\n        mPrivateFlags3 &= ~PFLAG3_FINGER_DOWN;\n        // A disabled view that is clickable still consumes the touch\n        // events, it just doesn't respond to them.\n        // ->> æ³¨é‡Š1ï¼ˆè§ä¸Šé¢ğŸ‘†ï¼‰\n        return clickable;\n    }\n    // å¦‚æœViewæœ‰ä»£ç†ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•\n    if (mTouchDelegate != null) {\n        if (mTouchDelegate.onTouchEvent(event)) {\n            return true;\n        }\n    }\n    \n    // è¿™å—æˆ‘ä»¬åªè°ƒå‡ºACTION_UPæ¥çœ‹\n    // åªè¦clickableä¸ºtrue(è§ä¸Šé¢æ³¨é‡Š1ğŸ‘†)æˆ–è€…TOOLTIP(å¯èƒ½æ˜¯Android8.0æ–°å‡ºçš„æç¤ºåŠŸèƒ½å§)\n    if (clickable || (viewFlags & TOOLTIP) == TOOLTIP) {\n        switch (action) {\n            case MotionEvent.ACTION_UP:\n\n                ...//çœç•¥\n                \n                    if (!mHasPerformedLongPress && !mIgnoreNextUpEvent) {\n                        // This is a tap, so remove the longpress check\n                        removeLongPressCallback();\n\n                        // Only perform take click actions if we were in the pressed state\n                        if (!focusTaken) {\n                            // Use a Runnable and post this rather than calling\n                            // performClick directly. This lets other visual state\n                            // of the view update before click actions start.\n                            if (mPerformClick == null) {\n                                mPerformClick = new PerformClick();\n                            }\n                            if (!post(mPerformClick)) {\n                                // ->> åˆ†æ1\n                                performClickInternal();\n                            }\n                        }\n                    }\n\n                    ... //çœç•¥\n                    \n                }\n                mIgnoreNextUpEvent = false;\n                break;\n            \n            ... //çœç•¥å…¶å®ƒå‡ ç§MotionEvent\n        }\n\n        return true;\n    }\n    // ç”±ä»£ç å¯çŸ¥åªè¦ä¸Šé¢çš„ifè¯­å¥æˆç«‹ï¼Œä¸ç®¡è¿›å…¥switchä¸­çš„ä»»ä½•ACTIONæˆ–æ˜¯éƒ½ä¸è¿›å…¥ï¼Œè¿”å›å€¼éƒ½æ˜¯trueï¼Œå³äº‹ä»¶æ¶ˆè´¹äº†ã€‚\n    return false;\n}\n\n/**\n  * åˆ†æ1ï¼šperformClickï¼ˆï¼‰\n  */\npublic boolean performClick() {  \n\n    if (mOnClickListener != null) {  \n        playSoundEffect(SoundEffectConstants.CLICK);  \n        mOnClickListener.onClick(this);  \n        return true;  \n        // åªè¦æˆ‘ä»¬é€šè¿‡setOnClickListenerï¼ˆï¼‰ä¸ºæ§ä»¶cvViewæ³¨å†Œ1ä¸ªç‚¹å‡»äº‹ä»¶\n        // é‚£ä¹ˆå°±ä¼šç»™mOnClickListenerå˜é‡èµ‹å€¼ï¼ˆå³ä¸ä¸ºç©ºï¼‰\n        // åˆ™ä¼šå¾€ä¸‹å›è°ƒonClickï¼ˆï¼‰ & performClickï¼ˆï¼‰è¿”å›true\n    }  \n    return false;  \n} \n```\n\n### æµç¨‹\n![](http://cdn.littlecorgi.top/mweb/2019-10-31/15725337657670.jpg)\n","tags":["Android","View","æºç ","äº‹ä»¶åˆ†å‘"],"categories":["Android"]},{"title":"OpenGL ES 2.0ç¬”è®°2â€”â€”é¡¶ç‚¹ã€åæ ‡ã€å›¾å…ƒ","url":"/posts/268eb1c2.html","content":"\n> ä¸ŠèŠ‚æˆ‘ä»¬å¯¹OpenGLåšäº†ä¸€ä¸ªå¤§è‡´çš„ä»‹ç»ï¼Œå¹¶å†™äº†ä¸€ä¸ªåŸºæœ¬æ¡†æ¶ï¼Œåœ¨è¿™èŠ‚ä¸­æˆ‘ä»¬å°†ä¼šä»‹ç»é¡¶ç‚¹ã€åæ ‡ç³»å’Œå›¾å…ƒ\n\n<!--More-->\n\n# é¡¶ç‚¹\nåœ¨OpenGLä¸­ï¼Œæ‰€æœ‰çš„ä¸œè¥¿çš„ç»“æ„éƒ½æ˜¯ä»ä¸€ä¸ªé¡¶ç‚¹å¼€å§‹çš„ã€‚\n\næ‰€è°“é¡¶ç‚¹ï¼Œå°±æ˜¯ä¸€ä¸ªå‡ ä½•å›¾å½¢çš„æ‹ç‚¹ã€‚åœ¨ä»‹ç»é¡¶ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸‹OpenGLåæ ‡ã€‚\n\n## OpenGLåæ ‡ç³»\nå¦‚æœæœ‰ä¼šAndroidå¼€å‘çš„æœ‹å‹ï¼Œä¸€å®šä¼šé»˜è®¤ä¸ºä»å±å¹•çš„å·¦ä¸Šè§’å¼€å§‹ï¼Œæ°´å¹³å¾€å³æ˜¯xè½´ï¼Œç«–ç›´å‘ä¸‹æ˜¯yè½´ã€‚\n\nä½†æ˜¯åœ¨OpenGLä¸­æ˜¯ä¸åŒçš„ï¼ŒOpenGLæ˜¯ä»æ˜¾ç¤ºè§†çª—çš„æ­£ä¸­å¿ƒæ˜¯ä¸­å¿ƒï¼Œä¹Ÿå°±æ˜¯$(0, 0)$ï¼Œè€Œå±å¹•æœ€å·¦è¾¹çš„xè½´åæ ‡æ˜¯-1ï¼Œå±å¹•æœ€å³è¾¹çš„xè½´åæ ‡æ˜¯1ï¼Œå±å¹•æœ€ä¸Šé¢çš„yè½´åæ ‡æ˜¯1ï¼Œå±å¹•æœ€ä¸‹é¢çš„yè½´åæ ‡æ˜¯-1ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™å¹…å›¾ï¼š\n\n![opengl_coordinate](http://cdn.littlecorgi.top/mweb/2019-10-18/opengl_coordinate.png)\n\n## åœ¨ä»£ç ä¸­å®šä¹‰é¡¶ç‚¹\nåœ¨OpenGLä¸­å®šä¹‰é¡¶ç‚¹æœ‰ç‚¹ç‰¹æ®Šï¼Œæˆ‘ä»¬ç¬¬ä¸€ååº”éƒ½æ˜¯ç›´æ¥æ‹¿æ•°ç»„å°†é¡¶ç«¯å­˜èµ·æ¥å°±è¡Œäº†ï¼Œä½†æ˜¯åœ¨OpenGLä¸­ï¼Œä½ é™¤äº†è¦å°†é¡¶ç‚¹çš„åæ ‡ç”¨æ•°ç»„å­˜èµ·æ¥ä»¥å¤–ï¼Œè¿˜å¾—å®šä¹‰ä¸€ä¸ªå¸¸é‡ï¼Œç”¨æ¥æ ‡è®°ä¸€ä¸ªé¡¶ç‚¹æœ‰ä¸¤ä¸ªåˆ†é‡ï¼š\n```java\nprivate static final int POSITION_COMPONENT_COUNT = 2;\nfloat[] tableVerticesWithTriangles = {\n    // Triangle 1\n    -0.5f, -0.5f, \n    0.5f,  0.5f,\n    -0.5f,  0.5f,\n\n    // Triangle 2\n    -0.5f, -0.5f, \n    0.5f, -0.5f, \n    0.5f,  0.5f,\n\n    // Line 1\n    -0.5f, 0f, \n    0.5f, 0f,\n\n    // Mallets\n    0f, -0.25f, \n    0f,  0.25f\n};\n```\n\næˆ‘ä»¬é‡‡ç”¨æµ®ç‚¹æ•°çš„é¡ºåºåˆ—è¡¨å®šä¹‰é¡¶ç‚¹æ•°æ®ï¼Œè¿™ä¸ªæ•°ç»„é€šå¸¸è¢«æˆä¸ºé¡¶ç‚¹å±æ€§ã€‚\n\n# å›¾å…ƒ\nåœ¨OpenGLä¸­ï¼Œåªèƒ½ç»˜åˆ¶ç‚¹ã€ç›´çº¿å’Œä¸‰è§’å½¢ï¼Œè¿™ä¸‰ä¸ªä¹Ÿè¢«ç§°ä¸ºå›¾å…ƒã€‚\n\nä¹Ÿå°±æ„å‘³ç€ï¼Œå…¶å®ƒæ‰€æœ‰çš„å›¾å½¢éƒ½å¾—é€šè¿‡è¿™ä¸‰ä¸ªåŸºæœ¬å›¾å…ƒæ¥å®ç°ã€‚\n\nå¦‚æœæˆ‘ä»¬éœ€è¦ç»˜åˆ¶ä¸€ä¸ªç‚¹ï¼Œé‚£ä¹ˆä¸€ä¸ªåæ ‡å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ç»˜åˆ¶ä¸€æ¡ç›´çº¿ï¼Œå°±éœ€è¦ä¸¤ä¸ªåæ ‡ï¼Œå¦‚æœç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢ï¼Œå°±éœ€è¦ä¸‰ä¸ªåæ ‡ã€‚\n\né‚£ä¹ˆæˆ‘ä»¬å°±ä»¥ç»˜åˆ¶ä¸€ä¸ªæ­£æ–¹å½¢ä¸¾ä¾‹ï¼š\n\n```java\nfloat[] squareVerticesWithTriangles = {\n    -0.5f, -0.5f, \n    0.5f,  0.5f,\n    -0.5f,  0.5f,\n    0.5f, -0.5f\n};\n```\n\n![åæ ‡](http://cdn.littlecorgi.top/mweb/2019-10-18/%E5%9D%90%E6%A0%87.png)\n\n\nå¦‚æœæˆ‘è¦åœ¨è¿™ä¸ªæ­£æ–¹å½¢ä¸­é—´åŠ ä¸€ä¸ªæ¨ªçº¿çš„è¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥åœ¨ä¸Šé¢çš„æ•°ç»„é‡Œé¢å»åŠ ï¼Œåˆ°æ—¶å€™è¦å°†é¡¶ç‚¹ç€è‰²å™¨åŠ è½½åˆ°å›¾å½¢ä¸­çš„æ—¶å€™å†å»å¤„ç†ï¼š\n```java\nfloat[] squareVerticesWithTriangles = {\n    // Square\n    -0.5f, -0.5f, \n    0.5f,  0.5f,\n    -0.5f,  0.5f,\n    0.5f, -0.5f,\n    \n    // Line\n    -0.5f, 0,\n    0.5f, 0\n};\n```\n\n![çº¿æ­£æ–¹å½¢åæ ‡](http://cdn.littlecorgi.top/mweb/2019-10-18/%E7%BA%BF%E6%AD%A3%E6%96%B9%E5%BD%A2%E5%9D%90%E6%A0%87.png)\n\n\n# è®©æ•°æ®å¯ä»¥è¢«OpenGLè¯»å–\nåœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†é¡¶ç‚¹çš„å®šä¹‰ï¼Œä½†æ˜¯ç°åœ¨OpenGLå°šè¿˜ä¸èƒ½è¯»å–ä»–ä»¬ã€‚å…¶åŸå› æ˜¯è¿™äº›ä»£ç çš„è¿è¡Œç¯å¢ƒä¸OpenGLè¿è¡Œç¯å¢ƒä½¿ç”¨äº†ä¸ä¸€æ ·çš„è¯­è¨€ã€‚\n\nå½“æˆ‘ä»¬è¿è¡ŒJavaè¯­è¨€çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šçš„ï¼Œè€Œæ˜¯è¿è¡Œåœ¨JVM(çº¯Java)æˆ–è€…Dalvik(Android)è™šæ‹Ÿæœºä¸Šçš„ï¼Œå¹¶ä¸”è¿è¡Œåœ¨è¿™äº›è™šæ‹Ÿæœºä¸Šçš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç›´æ¥è®¿é—®æœ¬åœ°ç¯å¢ƒï¼›å…¶æ¬¡ï¼Œè™šæ‹Ÿæœºè¿˜é‡‡ç”¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå½“æ£€æµ‹åˆ°å˜é‡ã€å¯¹è±¡ä¸å†è¢«ä½¿ç”¨æ—¶ï¼Œå°±è‡ªåŠ¨é‡Šæ”¾æ‰è¿™äº›å†…å­˜ã€‚\n\nä½†æ˜¯æœ¬åœ°ç¯å¢ƒä¸èƒ½è¿™æ ·ï¼Œå› ä¸ºä»–æ˜¯ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šçš„ï¼Œä»–ä¸å¸Œæœ›å†…å­˜ä¼šè¢«ç§»æ¥ç§»å»æˆ–è€…è‡ªåŠ¨é‡Šæ”¾ã€‚\n\næ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ–¹æ¡ˆï¼Œè®©Androidç¨‹åºä¸OpenGLè¿›è¡Œé€šä¿¡ã€‚\nå…¶å®Androidä»£ç ä¸ç¡¬ä»¶é€šä¿¡æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n1. é€šè¿‡JNIæŠ€æœ¯ï¼›\n2. é€šè¿‡è°ƒç”¨android.opengl.GLES20åŒ…é‡Œé¢çš„æ–¹æ³•ã€‚\n\næˆ‘ä»¬è¿™å—ä¸»è¦æ˜¯é€šè¿‡ç¬¬äºŒç§æ–¹æ³•ã€‚\n\nJavaä¸­æœ‰ä¸€ç§ç‰¹æ®Šçš„é›†åˆï¼Œå¯ä»¥åˆ†é…æœ¬åœ°çš„å†…å­˜å—ï¼Œå¹¶å°†Javaçš„æ•°æ®å¤åˆ¶åˆ°æœ¬åœ°å†…å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š\n```java\n// å› ä¸ºJavaä¸­å›½ä¸€ä¸ªFloatå‹æ•°æ®å 4ä¸ªå­—èŠ‚\nprivate static final int BYTES_PER_FLOAT = 4;\n// å£°æ˜ä¸€ä¸ªå­—èŠ‚ç¼“å†²åŒº\nprivate final FloatBuffer vertexData;\n \nvertexData = ByteBuffer\n    // åˆ†é…ä¸€å—æœ¬åœ°å†…å­˜ï¼Œæ‰€ä»¥æ˜¯æ•°ç»„é•¿åº¦ * ç±»å‹æ‰€å å­—èŠ‚\n    .allocateDirect(tableVerticesWithTriangles.length * BYTES_PER_FLOAT)\n    // æŒ‰ç…§æœ¬åœ°å­—èŠ‚åºç»„ç»‡å†…å®¹\n    .order(ByteOrder.nativeOrder())\n    .asFloatBuffer();\n    // å°†æ•°æ®å­˜å…¥\n    .put(tableVerticesWithTriangles);\n```","tags":["Android","OpenGL","å›¾åƒå¤„ç†"],"categories":["OpenGL"]},{"title":"OpenGL ES 2.0ç¬”è®°1â€”â€”ç®€ä»‹","url":"/posts/a92b4a54.html","content":"# OpenGLæ˜¯ä»€ä¹ˆï¼ŸOpenGL ESåˆæ˜¯ä»€ä¹ˆï¼Ÿ\n## ç®€ä»‹\nOpenGLæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„è½¯ä»¶æ¥å£è¯­è¨€ï¼Œç”¨äºè°ƒç”¨ç¡¬ä»¶çš„2Dã€3Då›¾å½¢å¤„ç†å™¨ã€‚\n\nç„¶è€Œå—é™äºç°åœ¨çš„ç§»åŠ¨è®¾å¤‡æ€§èƒ½ï¼Œå¦‚æœå°†OpenGLç›´æ¥ç”¨åœ¨ä»–ä»¬ä¸Šé¢å°†ä¼šç‰¹åˆ«å¡ï¼Œäºæ˜¯å°±å‡ºç°äº†OpenGL ESã€‚ OpenGL ESæ˜¯OpenGLçš„åˆ†æ”¯ï¼Œä»–ä¸“é—¨ä½œç”¨äºåµŒå…¥å¼è®¾å¤‡ï¼Œå»æ‰äº†OpenGLå¾ˆå¤šä¸å¿…è¦çš„åŠŸèƒ½ã€‚\n\n<!--More-->\n\n## åº”ç”¨åœºæ™¯\n- æ¸¸æˆ\n- è§†é¢‘æ’­æ”¾å™¨\n- è§†é¢‘ç¼–è¾‘åº”ç”¨\n- å›¾ç‰‡ç¼–è¾‘åº”ç”¨\n\nç­‰å¯¹å›¾åƒå¤„ç†çš„åŠæ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨åœºæ™¯ã€‚\n\n## Androidå¯¹OpenGL ES çš„æ”¯æŒ\n|OpenGL ES ç‰ˆæœ¬|åŸºäºOpenGLçš„ç‰ˆæœ¬|Androidå¼•å…¥çš„ç‰ˆæœ¬|å…¼å®¹æ€§|åŠŸèƒ½ã€ç‰¹è‰²|\n|:-:|:-:|:-:|:-:|:-:|\n|1.0&1.1|1.3&1.5|Android 1.0|-|å›ºå®šçš„å›¾åƒç®¡é“ï¼Œå¼€å‘éš¾åº¦ç›¸æ¯”2.0ä½|\n|2.0|2.0|Android 2.2|ä¸å…¼å®¹1.x|å¯ç¼–ç¨‹çš„æ¸²æŸ“ç®¡é“ï¼Œæ€§èƒ½æ•ˆç‡æ›´é«˜ï¼Œå¼€å‘éš¾åº¦æ›´é«˜|\n|3.0|3.x|Android 4.3|å…¼å®¹2.0|æ€§èƒ½æ›´é«˜ï¼Œæ”¯æŒETC2æ ¼å¼çš„é€æ˜çº¹ç†å‹ç¼©|\n|3.1|4.x|Android 5.0|å…¼å®¹2.0/3.0|æ–°å¢è®¡ç®—ç€è‰²å™¨ã€å•ç‹¬çš„ç€è‰²å™¨å¯¹è±¡ç­‰æ–°ç‰¹æ€§|\n\n## ç‰ˆæœ¬çš„é€‰æ‹©\nç”±äºæ­¤ç¯‡åšå®¢æ˜¯å­¦ä¹ é˜¶æ®µå†™çš„ï¼Œè€Œæˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„å¤§éƒ¨åˆ†åšå®¢éƒ½æ˜¯2.0ï¼Œæ‰€ä»¥å°±ä»¥2.0ä¸ºä¸»ã€‚\n\nå…¶å®æˆ‘è§‰å¾—åº”è¯¥æ˜¯3.0ï¼Œ2.0ç¡®å®å¤ªè€äº†ï¼Œç°åœ¨Android4.3çš„æ‰‹æœºéƒ½è¾ƒå°‘è§äº†ï¼Œè€Œ3.1åˆå¤ªæ–°äº†ã€‚\n\n## å¯¼å…¥\né¦–å…ˆä½ å¾—åœ¨AndroidManifest.xmlä¸­åŠ å…¥\n`<uses-feature android:glEsVersion=\"0x00020000\" android:required=\"true\" />`\n\nå…¶ä¸­ä¸åŒç‰ˆæœ¬å¯¹åº”å€¼ï¼š\n\n|OpenGL ES ç‰ˆæœ¬|glEsVersion ç‰ˆæœ¬|\n|:-:|:-:|\n|2.0|0x00020000|\n|3.0|0x00030000|\n|3.1|0x00030001|\n\n# åŸºæœ¬æ¡†æ¶\nAndroidæ¡†æ¶é‡Œé¢æä¾›äº†ä¸¤ä¸ªç±»æ¥ç»™ä½ ä½¿ç”¨OpenGL ES APIåˆ›å»ºå’Œæ“ä½œå›¾å½¢ï¼š`GLSrufaceView`å’Œ`GLSurfaceView.Renderer`ã€‚\n\n## GLSrufaceView\nè¿™æ˜¯ä¸€ä¸ªè§†å›¾ç±»ï¼Œä½ å¯ä»¥é€šè¿‡OpenGL ES APIæ¥ç»˜åˆ¶å’Œæ“ä½œå›¾å½¢å¯¹è±¡ï¼Œä»–åœ¨åŠŸèƒ½ä¸Šå¾ˆç±»ä¼¼ä¸`SurfaceView`ã€‚ä½ å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª`SurfaceView`çš„å®ä¾‹å¹¶æ·»åŠ ä½ çš„æ¸²æŸ“å™¨æ¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚\n\nä»–çš„å¸¸ç”¨æ–¹æ³•æœ‰ï¼š\n- `setEGLContextClientVersion`ï¼šè®¾ç½®OpenGL ESç‰ˆæœ¬ï¼Œ2.0åˆ™è®¾ç½®2\n- `onPause`ï¼šæš‚åœæ¸²æŸ“ï¼Œæœ€å¥½æ˜¯åœ¨`Activity`ã€`Fragment`çš„`onPause()`æ–¹æ³•å†…è°ƒç”¨ï¼Œå‡å°‘ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œé¿å…ä¸å¿…è¦çš„å´©æºƒ\n- `onResume`ï¼šæ¢å¤æ¸²æŸ“ï¼Œç”¨æ³•ç±»æ¯”`onPause()`\n- `setRenderer`ï¼šè®¾ç½®æ¸²æŸ“å™¨\n- `setRenderMode`ï¼šè®¾ç½®æ¸²æŸ“æ¨¡å¼\n- `requestRender`: è¯·æ±‚æ¸²æŸ“ï¼Œç”±äºæ˜¯è¯·æ±‚å¼‚æ­¥çº¿ç¨‹è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥ä¸æ˜¯åŒæ­¥æ–¹æ³•ï¼Œè°ƒç”¨åä¸ä¼šç«‹åˆ»å°±è¿›è¡Œæ¸²æŸ“ã€‚æ¸²æŸ“ä¼šå›è°ƒåˆ°`Renderer`æ¥å£çš„`onDrawFrame()`æ–¹æ³•ã€‚\n- `queueEvent`ï¼šæ’å…¥ä¸€ä¸ª`Runnable`ä»»åŠ¡åˆ°åå°æ¸²æŸ“çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ç›¸åº”çš„ï¼Œæ¸²æŸ“çº¿ç¨‹ä¸­å¯ä»¥é€šè¿‡`Activity`çš„`runOnUIThread`çš„æ–¹æ³•æ¥ä¼ é€’äº‹ä»¶ç»™ä¸»çº¿ç¨‹å»æ‰§è¡Œ\n\nå…¶ä¸­ï¼ŒGLSurfaceViewçš„æ¸²æŸ“æ¨¡å¼æœ‰ï¼š\n- `RENDERMODE_CONTINUOUSLY`ï¼šä¸åœåœ°æ¸²æŸ“\n- `RENDERMODE_WHEN_DIRTY`ï¼šåªæœ‰è°ƒç”¨äº†`requestRender()`ä¹‹åæ‰ä¼šè§¦å‘æ¸²æŸ“å›è°ƒonDrawFrameæ–¹æ³•\n\n## GLSurfaceView.Renderer\næ­¤æ¥å£å®šä¹‰äº†åœ¨GLSurfaceViewä¸­ç»˜åˆ¶å›¾å½¢æ‰€éœ€çš„æ–¹æ³•ã€‚å¿…é¡»å°†æ­¤æ¥å£çš„å®ç°ä½œä¸ºå•ç‹¬çš„ç±»æä¾›ï¼Œå¹¶ä½¿ç”¨GLSurfaceView.setRenderer()å°†å…¶æ·»åŠ åˆ°GLSurfaceViewçš„å®ç°ç±»ä¸­ã€‚\n\nä»–çš„ä¸»è¦æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š\n- `onSurfaceCreated(GL10 gl, EGLConfig config)`ï¼šGLSurfaceViewå†…çš„Surfaceè¢«åˆ›å»ºæ—¶ä¼šè¢«è°ƒç”¨åˆ°\n- `onSurfaceChanged(GL10 gl, int width, int height)`ï¼šSurfaceå°ºå¯¸æ”¹å˜æ—¶è°ƒç”¨åˆ°\n- `onDrawFrame(GL10 gl)`ï¼šæ¸²æŸ“ç»˜åˆ¶æ¯ä¸€å¸§æ—¶è°ƒç”¨åˆ°\n\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé¦–æ¬¡åˆ›å»ºGLSurfaceViewæ—¶ï¼Œä¼šé¡ºåºè°ƒç”¨`onSurfaceCreated()` -> `onSurfaceChanged()` -> `onDrawFrame()`ã€‚ç„¶åæ¯ç»˜åˆ¶ä¸€å¸§ï¼Œéƒ½ä¼šä¸åœåœ°å›è°ƒ`onDrawFrame()`æ–¹æ³•ã€‚\n\n# ç¼–å†™æµç¨‹\né¦–å…ˆæˆ‘ä»¬æ¥å†™ä¸€ä¸ªåŸºæœ¬æ¡†æ¶ã€‚\n\nåˆ›å»ºä¸€ä¸ªAndroidé¡¹ç›®ï¼Œç„¶åActivityé€‰æ‹©EmptyActivityã€‚\n\n**æ³¨æ„ï¼šæœ¬é¡¹ç›®æŸäº›ç±»æˆ–è€…æ–¹æ³•é€šè¿‡AndroidStudioå¯¼å…¥çš„æ—¶å€™ä¼šè®©ä½ é€‰æ‹©æ˜¯ä»å“ªä¸ªåŒ…é‡Œé¢å¯¼å…¥ï¼Œä¸€è‡´é€‰æ‹©`android.opengl.GLES20`**\n\n## ç¼–å†™Activity\næ‰“å¼€æˆ‘ä»¬é¡¹ç›®çš„MainActivityï¼Œä½ å°±èƒ½çœ‹åˆ°ç†Ÿæ‚‰çš„onCreateæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯¹è¿™ä¸ªActivityè¿›è¡Œä¸€äº›æ›´æ”¹ã€‚\n\né¦–å…ˆï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªGLSurfaceViewçš„å¯¹è±¡,å¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„æˆå‘˜å˜é‡ï¼š\n```java\nprivate GLSurfaceView glSurfaceView;\nprivate boolean rendererSet = false;\n```\n\næ¥ä¸‹æ¥å°†`setContentView()`ç§»é™¤ï¼Œå¹¶å¯¹glSurfaceViewè¿›è¡Œåˆå§‹åŒ–ï¼š\n```java\n@Override\npublic void onCreate(Bundle savedInstanceState) {\n    super.onCreate(savedInstanceState);\n    glSurfaceView = new GLSurfaceView(this);\n}\n```\n\nç”±äºæˆ‘ä»¬æ˜¯åœ¨å†™OpenGL ES2.0çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ£€æµ‹å½“å‰è¿è¡ŒAPPçš„ç³»ç»Ÿæ”¯ä¸æ”¯æŒOpenGL ES2.0ã€‚æˆ‘ä»¬å°†ä¸‹é¢å‡ è¡Œä»£ç æ·»åŠ åˆ°onCreate()é‡Œé¢å»:\n```java\nfinal ActivityManager activityManager = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);\nfinal ConfigurationInfo configurationInfo = activityManager.deviceConfigurationInfo();\nfinal boolean supportsEs2 = configurationInfo.reqGlEsVersion >= 0x20000;\n```\n\nä½†æ˜¯è¿™æ®µä»£ç åœ¨æ¨¡æ‹Ÿå™¨ä¸Šä¸èƒ½å·¥ä½œï¼Œå› ä¸ºGPUæ¨¡æ‹Ÿéƒ¨åˆ†æœ‰ç¼ºé™·ã€‚ä¸ºäº†ä½¿ä»£ç åœ¨æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬è¦æŒ‰å¦‚ä¸‹ä»£ç ä¿®æ”¹æ£€æŸ¥æ¡ä»¶ï¼š\n```java\nfinal boolean supportsEs2 = configurationInfo.reqGlEsVersion >= 0x20000\n    || (Build.VERSION.SDK_INT >= Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1\n    && (Build.FINGERPRINT.startsWith(\"generic\")\n    || Build.FINGERPRINT.startsWith(\"unknown\")\n    || Build.MODEL.contains(\"google_sdk\")\n    || Build.MODEL.contains(\"Emulator\")\n    || Build.MODEL.contains(\"Android SDK build for x86\")))\n```\n\næ¥ä¸‹æ¥å°±æ˜¯é…ç½®æ¸²æŸ“è¡¨é¢ï¼š\n```java\nif (supportsEs2) {\n    // é…ç½®è¿™ä¸ªsurfaceè§†å›¾\n    glSurfaceView.setEGLContextClientVersion(2);\n\n    // é…ç½®Renderer\n    glSurfaceView.setRenderer(FirstOpenGLProjectRenderer());\n    rendererSet = true;\n} else {\n    Toast.makeText(this, \"This device does not support OpenGL ES 2.0\", Toast.LENGTH_SHORT).show();\n    return;\n}\n\nsetContentView(glSurfaceView);\n```\n\næœ€åæˆ‘ä»¬è¿˜å¾—å¤„ç†ä¸‹Activityçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å°†GLSurfaceViewçš„ç”Ÿå‘½å‘¨æœŸè·ŸActivityçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šèµ·æ¥ï¼š\n```java\n@Override\nvoid onPause() {\n    super.onPause();\n\n    if (rendererSet)\n        glSurfaceView.onPause();\n}\n\n@Override\nvoid onResume() {\n    super.onResume();\n\n    if (rendererSet)\n        glSurfaceView.onResume();\n}\n```\n\n## ç¼–å†™Renderer\nåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå‘½åä¸ºFirstOpenGLProjectRendererï¼Œè®©è®©è¿™ä¸ªç±»ç»§æ‰¿è‡ªGLSurfaceView.Rendererã€‚\n\næ¥ç€å°±å®ç°ä¸‰ä¸ªå¿…å¤‡æ–¹æ³•:\n- `onSurfaceCreate()`ï¼šåˆ›å»ºæ—¶è¢«è°ƒç”¨\n\n```java\n@Override\npublic void onSurfaceCreated(GL10 glUnsed, EGLConfig config) {\n    glClearColor(1.0f, 0.0f, 0.0f, 0.0f); //è®¾ç½®ä¸€ä¸ªæ¸…ç©ºå±å¹•ç”¨çš„é¢œè‰²\n}\n```\n\n- `onSurfaceChanged()`ï¼šåˆ›å»ºåæ¯å½“Surfaceå°ºå¯¸æ”¹å˜æ—¶ï¼Œéƒ½è°ƒç”¨æ­¤æ–¹æ³•\n\n```java\n@Override\npublic void onSurfaceChanged(GL10 glUnsed, int width, int height) {\n    glViewport(0, 0, width, height); //è®¾ç½®è§†çª—å°ºå¯¸\n}\n```\n\n- `onDrawFrame()`ï¼šç»˜åˆ¶æ¯ä¸€å¸§æ—¶è°ƒç”¨\n\n```java\n@Override\npublic void onDrawFrame(GL10 glUnsed) {\n    glClear(GL_COLOR_BUFFER_BIT); //æ¸…ç©ºå±å¹•\n}\n```\n\nç„¶åå°±å¯ä»¥è¿è¡Œç¨‹åºäº†ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°æ•´ä¸ªå±å¹•éƒ½æˆäº†çº¢è‰²ï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ\nå› ä¸ºæˆ‘ä»¬åœ¨onSurfaceCreatedæ–¹æ³•é‡Œé¢è®¾ç½®äº†glClearColor(1.0f,0.0f,0.0f,0.0f)ã€‚è¿™ä¸ªæ–¹æ³•çš„å‚æ•°å¯¹åº”çš„æ˜¯RGBAï¼Œç„¶åæˆ‘ä»¬åˆåœ¨onDrawFrameæ–¹æ³•ä¸­è®¾ç½®äº†æ¸…å±ï¼Œæ‰€ä»¥è¿™æ ·ä½ å°±ä¼šçœ‹åˆ°çš„æ˜¯çº¢è‰²äº†ã€‚","tags":["Android","OpenGL","å›¾åƒå¤„ç†"],"categories":["OpenGL"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(8)â€”â€”å¤©æ°”é¢„æŠ¥ç¬¬äºŒæ­¥-é€‰æ‹©çœã€å¸‚ã€åŒºç•Œé¢åŠç½‘ç»œè¯·æ±‚","url":"/posts/f0e3723.html","content":"\n> é¡¹ç›®Githubåœ°å€ï¼š[a1203991686/CoolWeather_Flutter](https://github.com/a1203991686/CoolWeather_Flutter)\n\nåœ¨ç¬¬å…­ç« ä¸­æˆ‘ä»¬å†™äº†å¤©æ°”é¢„æŠ¥çš„é¡µé¢ï¼Œ ä½†æ˜¯ä½ ä½œä¸ºå¤©æ°”é¢„æŠ¥è‚¯å®šèƒ½é€‰æ‹©åŸå¸‚å§ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ¥å†™é€‰æ‹©çœã€å¸‚ã€åŒºçš„ç•Œé¢ã€‚\n\næˆ‘ä»¬ä½¿ç”¨çš„æ˜¯éƒ­éœ–å¤§ç¥åœ¨ç¬¬ä¸€è¡Œä»£ç æœ€åé¢é…·æ¬§å¤©æ°”çš„APIã€‚\n\n<!-- More -->\n\n# 1. å®ç°ç•Œé¢\næ—¢ç„¶æ˜¯ä¸€ä¸ªé€‰æ‹©çœå¸‚åŒºçš„ç•Œé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨`ListView`ã€‚\n\né¦–å…ˆçœ‹ä¸€ä¸‹å¤§è‡´ç•Œé¢ï¼š\n![Screenshot_1570967184](http://cdn.littlecorgi.top/mweb/2019-10-14/Screenshot_1570967184.png)\n\n\nå°±ç›´æ¥ä½¿ç”¨`ListView`çš„`builder()`æ–¹æ³•ï¼Œå¿˜äº†çš„åŒå­¦å¯ä»¥çœ‹å‰é¢ç¬¬5ç« ã€‚\n\n\n\n## çœ\nåœ¨`view`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªç±»`provinces_page.dart`ï¼Œæ¥ä¸‹æ¥å°±åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å†™ä»£ç ï¼š\n```java\nclass ProvincesPageWidget extends StatefulWidget {\n    ProvincesPageWidget({Key key}) : super(key: key);\n\n    @override\n    ProvincesPageStateWidget createState() => new ProvincesPageStateWidget();\n}\n\nclass ProvincesPageStateWidget extends State<ProvincesPageWidget> {\n    @override\n    Widget build(BuildContext context) {\n        return Scaffold(\n            appBar: new AppBar(\n                title: Text(\n                    \"çœä»½\",\n                    style: TextStyle(fontSize: 25.0),\n                ),\n            ),\n            body: ListView.builder(\n                itemCount: 30,\n                itemBuilder: (context, index) {\n                    return ListTile(\n                            title: Text(\"$index\"),\n                    );\n                },\n            ),\n        );\n    }\n}\n```\n\n\n## å¸‚\nå’Œçœä¸€æ ·ã€‚åœ¨`view`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªç±»`city_page.dart`ï¼Œæ¥ä¸‹æ¥å°±åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å†™ä»£ç ã€‚ç…§ç€çœçš„ä¾è‘«èŠ¦ç”»ç“¢ï¼Œå†™ä¸€ä¸ª`ListView`ã€‚\n\n## åŒº\nå’Œçœä¸€æ ·ã€‚åœ¨`view`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªç±»`counties_page.dart`ï¼Œæ¥ä¸‹æ¥å°±åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å†™ä»£ç ã€‚ç…§ç€çœçš„ä¾è‘«èŠ¦ç”»ç“¢ï¼Œå†™ä¸€ä¸ª`ListView`ã€‚\n\n# 2. ç½‘ç»œè¯·æ±‚\nç½‘ç»œè¯·æ±‚å¯ä»¥çœ‹ä¸‹ä¹‹å‰ç¬¬7ç« çš„å†…å®¹ã€‚ä¸»è¦æ˜¯é€šè¿‡`Dio`è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸‹ç¬¬7ç« ç½‘ç»œè¯·æ±‚çš„å†…å®¹ã€‚\n\næˆ‘ä»¬ç½‘ç»œè¯·æ±‚ä¸»è¦éœ€è¦ä»¥ä¸‹å‡ ä¸ªAPIï¼š\n- è¯·æ±‚çœä»½åˆ—è¡¨ï¼š`http://guolin.tech/api/china`\n- è¯·æ±‚å¯¹åº”å¸‚åˆ—è¡¨ï¼š`http://guolin.tech/api/china/provinceID`\n- è¯·æ±‚å¯¹åº”åŒºå¿åˆ—è¡¨ï¼š`http://guolin.tech/api/china/provinceID/cityID`\n\nç”±äºæˆ‘ä»¬åœ¨ä¹‹å‰æ–‡ç« ä¸­ä½¿ç”¨çš„çœä½œä¸ºä¾‹å­ï¼Œè¿™å—æˆ‘ä»¬å°±ç”¨åŒºå¿ä½œä¸ºä¾‹å­ï¼š\n\n## è½¬ä¸ºDartç±»\né¦–å…ˆä½¿ç”¨ç½‘ç«™[https://caijinglong.github.io/json2dart/](https://caijinglong.github.io/json2dart/)æ¥è®²Jsonæ•°æ®è½¬ä¸ºDartå®ä½“ç±»ï¼š\n![Json](http://cdn.littlecorgi.top/mweb/2019-10-14/Json.png)\n\nç„¶ååœ¨é¡¹ç›®`lib`ç›®å½•æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚åä¸º`bean`ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹ä¸»è¦å­˜æ”¾å®ä½“ç±»çš„ä»£ç ã€‚ç„¶ååœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æ–°å»ºä¸€ä¸ªdartæ–‡ä»¶ï¼Œå‘½åä¸º`Counties`ã€‚ç„¶åæŠŠç”Ÿæˆçš„Dartä»£ç å¤åˆ¶ç²˜è´´è¿›å»ã€‚ä½†æ˜¯ä½ ä¼šå‘ç°å¤åˆ¶è¿›å»åä¼šæŠ¥é”™ï¼Œè¿™ä¸ªä¸ç”¨æ€¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¤„ç†é”™è¯¯ã€‚\n\n## ç”Ÿæˆ.g.dartæ–‡ä»¶\næ¥ä¸‹æ¥åœ¨é¡¹ç›®æ ¹ç›®å½•çš„`pubspec.yaml`æ–‡ä»¶çš„`dependencies`é¡¹ä¸‹é¢æ·»åŠ ä¾èµ–`json_annotation`ã€`dev_dependencies`é¡¹ä¸‹é¢æ·»åŠ `build_runner`å’Œ`json_serializable`ã€‚\n\næ¥ç€æ‰“å¼€ç»ˆç«¯ï¼Œå®šä½åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œè¾“å…¥\n`flutter packages pub run build_runner build`ï¼Œè¿è¡Œå³å¯ã€‚è¿è¡Œå®Œæ¯•ä½ å°±ä¼šå‘ç°ä½ é¡¹ç›®çš„å­˜å®ä½“ç±»çš„`lib/bean`ç›®å½•å¤šäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œåä¸º`Counties.g.dart`ã€‚åŒæ—¶ä½ `Counties.dart`é‡Œé¢çš„é”™è¯¯ä¹Ÿæ²¡æœ‰äº†ã€‚\n\n## ç½‘ç»œè¯·æ±‚\næœ€åä½ å°±å¯ä»¥é€šè¿‡Dioæ¥è¿›è¡Œç½‘ç»œè¯·æ±‚äº†ã€‚\n```java\nDio().get(http://guolin.tech/api/china/$_provinceID/$_cityID);\n```\n\né‚£ä¹ˆåˆ°è¿™æœ‰çš„åŒå­¦å¯èƒ½å°±ä¼šé—®äº†ï¼Œä½ ç½‘å€é‡Œé¢æœ‰`provinceID`å’Œ`cityID`ï¼Œé‚£è¿™ä¸¤ä¸ªæ€ä¹ˆè·å–ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾—ç”¨ä¸Šå¸¦å€¼è·¯ç”±è·³è½¬äº†ã€‚\n\næˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯è¿™æ ·çš„ä¸€ä¸ªé€»è¾‘:å…ˆé€‰æ‹©çœä»½ã€å†é€‰æ‹©åŸå¸‚ã€æœ€åé€‰æ‹©åŒºå’Œå¿ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™ä¸ª`CountyPageWidget`è‚¯å®šæ˜¯ç”±`CityPageWidget`è°ƒç”¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨`CityPageWidget`çš„`ListView`é‡Œé¢å°†`Text`é€šè¿‡`GestureDetector`åŒ…èµ·æ¥ï¼Œç„¶åå°†`GestureDetector`çš„`onTap`æ–¹æ³•è®¾ç½®ä¸ºè·³è½¬åˆ°`CountyPageWidget`ã€‚`CityPageWidget`çš„`ListView`ä»£ç å¦‚ä¸‹ï¼š\n```java\nListView.builder(\n    itemCount: _cityList.cities.length,\n    itemBuilder: (context, index) {\n        return GestureDetector(\n            child: ListTile(\n                title: Text(\"${_cityList.cities[index].name}\"),\n            ),\n            onTap: () {\n                Navigator.push(context,\n                    MaterialPageRoute(builder: (context) {\n                        return CountiesPageWidget(\n                            provinceID: _provinceID, //ç”±CityWidgetçš„ä¸Šä¸€çº§ProvinceWidgetä¼ è¿‡æ¥ï¼Œ\n                            cityID: _cityList.cities[index].id, // ç”±ç½‘ç»œè¯·æ±‚å›æ¥çš„æ•°æ®ä¼ å…¥\n                        );\n                    }));\n            },\n        );\n    },\n);\n```\n\nè¿™æ ·`CountyPageWidget`æ‰€éœ€çš„`provinceID`å’Œ`cityID`éƒ½æ˜¯ç”±`CityPageWidget`ä¼ å…¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå¯¹ä»–ä¼ å…¥çš„å€¼è¿›è¡Œå¤„ç†å‘¢ï¼Œæ€ä¹ˆæŠŠå®ƒæ·»åŠ åˆ°ç½‘å€é‡Œå»ï¼Ÿæ¥ä¸‹æ¥å¤§å®¶çœ‹ä»£ç å°±è¡Œäº†ï¼š\n```java\nclass CountyPageWidget extends StatefulWidget {\n  //åœ¨Widgetä¸­å®šä¹‰ä¸¤ä¸ªï¼Œæ–¹ä¾¿ç”±å…¶ä»–Widgetä¼ å…¥\n  final int provinceID;\n  final int cityID;\n\n  // è®¾ç½®æ„é€ æ–¹æ³•ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸¤ä¸ªå˜é‡\n  CountyPageWidget({Key key, this.provinceID, this.cityID}) : super(key: key);\n\n  @override\n  CountyPageWidgetState createState() => CountyPageWidgetState();\n}\n\nclass CountyPageWidgetState extends State<CountyPageWidget> {\n  // åœ¨Stateä¸­å®šä¹‰ä¸¤ä¸ªå˜é‡\n  int _provinceID;\n  int _cityID;\n  List<County> _county;\n\n  @override\n  void initState() {\n    // åœ¨æ­¤å°†Widgetä¸­çš„ä¸¤ä¸ªå˜é‡èµ‹å€¼ç»™Stateä¸­çš„å˜é‡\n    _provinceID = widget.provinceID;\n    _cityID = widget.cityID;\n    super.initState();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: new AppBar(\n        title: Text(\n          \"åŒºå¿\",\n          style: TextStyle(fontSize: 25.0),\n        ),\n      ),\n      body: FutureBuilder( // UIå¼‚æ­¥æ›´æ–°ç»„ä»¶\n        // è¿™å—å°±å¯ä»¥è°ƒç”¨äº†\n        future: Dio().get(\"http://guolin.tech/api/china/$_provinceID/$_cityID\"),\n        builder: (BuildContext context, AsyncSnapshot snapshot) {\n        ...çœç•¥åé¢æ‰€æœ‰ä»£ç \n}\n```\n\n# 3. UIå¼‚æ­¥æ›´æ–°\nä¸å¼‚æ­¥æ›´æ–°ç›¸å…³çš„çŸ¥è¯†å¤§å®¶ä¹Ÿå¯ä»¥çœ‹æˆ‘ä»¬ä¹‹å‰çš„ç¬¬7ç« åšå®¢ï¼Œè¿™å—åªè®²åº”ç”¨ã€‚\n\n## çœ\nå°†Scaffoldçš„bodyå‚æ•°è®¾ç½®ä¸ºFutureBuilderï¼Œå¹¶åœ¨FutureBuilderé‡Œé¢è°ƒç”¨ListView:\n```java\nFutureBuilder(\n    future: Dio().get(\"http://guolin.tech/api/china\"),\n    builder: (BuildContext context, AsyncSnapshot snapshot) {\n        if (snapshot.connectionState == ConnectionState.done) {\n            Response response = snapshot.data;\n            //å‘ç”Ÿé”™è¯¯\n            if (snapshot.hasError) {\n                return Text(snapshot.error.toString());\n            }\n\n            provinceList = getProvinceList(response.data);\n            //è¯·æ±‚æˆåŠŸï¼Œé€šè¿‡é¡¹ç›®ä¿¡æ¯æ„å»ºç”¨äºæ˜¾ç¤ºé¡¹ç›®åç§°çš„ListView\n            return ListView.builder(\n                itemCount: provinceList.length,\n                itemBuilder: (context, index) {\n                    return GestureDetector(\n                        child: ListTile(\n                            title: Text(\"${provinceList[index].name}\"),\n                        ),\n                        onTap: () {\n                            Navigator.push(context, MaterialPageRoute(builder: (context) {\n                                return CityPageWidget(\n                                    provinceID: provinceList[index].id,\n                                );\n                            }));\n                        },\n                    );\n                },\n            );\n        }\n        // è¯·æ±‚æœªå®Œæˆæ—¶å¼¹å‡ºloading\n        return CircularProgressIndicator();\n    },\n)\n```\n\n\n## å¸‚\nä¸çœåŒç†:\n```java\nFutureBuilder(\n    future: Dio().get(\"http://guolin.tech/api/china/$_provinceID\"),\n    builder: (BuildContext context, AsyncSnapshot snapshot) {\n        if (snapshot.connectionState == ConnectionState.done) {\n            Response response = snapshot.data;\n            //å‘ç”Ÿé”™è¯¯\n            if (snapshot.hasError) {\n                return Text(snapshot.error.toString());\n            }\n\n            _cityList = getCityList(response.data);\n            //è¯·æ±‚æˆåŠŸï¼Œé€šè¿‡é¡¹ç›®ä¿¡æ¯æ„å»ºç”¨äºæ˜¾ç¤ºé¡¹ç›®åç§°çš„ListView\n            return ListView.builder(\n                itemCount: _cityList.length,\n                itemBuilder: (context, index) {\n                    return GestureDetector(\n                        child: ListTile(\n                            title: Text(\"${_cityList[index].name}\"),\n                        ),\n                        onTap: () {\n                            Navigator.push(context, MaterialPageRoute(builder: (context) {\n                                return CountiesPageWidget(\n                                    provinceID: _provinceID,\n                                    cityID: _cityList[index].id,\n                                );\n                            }));\n                        },\n                    );\n                },\n            );\n        }\n        // è¯·æ±‚æœªå®Œæˆæ—¶å¼¹å‡ºloading\n        return CircularProgressIndicator();\n    },\n)\n```\n\n\n\n## åŒºå¿\nä¸çœåŒç†:\n```java\nFutureBuilder(\n    future: Dio().get(\"http://guolin.tech/api/china/$_provinceID/$_cityID\"),\n    builder: (BuildContext context, AsyncSnapshot snapshot) {\n        if (snapshot.connectionState == ConnectionState.done) {\n            Response response = snapshot.data;\n            //å‘ç”Ÿé”™è¯¯\n            if (snapshot.hasError) {\n                return Text(snapshot.error.toString());\n            }\n\n            _county = getCountyList(response.data);\n            //è¯·æ±‚æˆåŠŸï¼Œé€šè¿‡é¡¹ç›®ä¿¡æ¯æ„å»ºç”¨äºæ˜¾ç¤ºé¡¹ç›®åç§°çš„ListView\n            return ListView.builder(\n                itemCount: _county.length,\n                itemBuilder: (context, index) {\n                    return GestureDetector(\n                        child: ListTile(\n                            title: Text(\"${_county[index].name}\"),\n                        ),\n                        onTap: () {\n                            _saveCityID(_county[index].weatherId);\n                            Navigator.push(context, MaterialPageRoute(builder: (context) {\n                                return MainPage(\n                                    cityID: _county[index].weatherId,\n                                );\n                            }));\n                        },\n                    );\n                },\n            );\n        }\n        // è¯·æ±‚æœªå®Œæˆæ—¶å¼¹å‡ºloading\n        return CircularProgressIndicator();\n    },\n)\n```\n","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(7)â€”â€”Httpç½‘ç»œè¯·æ±‚ã€Jsonè½¬Dartå®ä½“ç±»åŠå¼‚æ­¥æ›´æ–°UI","url":"/posts/163d319c.html","content":"\n> ç›¸å…³Demoæºç å¯è§Github [a1203991686/CoolWeather_Flutter](https://github.com/a1203991686/CoolWeather_Flutter)\n\n<!--More-->\n# Flutter Http ç½‘ç»œè¯·æ±‚\nFlutterç½‘ç»œè¯·æ±‚å¯åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼Œä¸€ç§ä¸º`Dart:IO`åº“ä¸­ä¸ºæˆ‘ä»¬æä¾›çš„`HttpClient`ï¼Œå¦ä¸€ç§ä¸ºDartç¬¬ä¸‰æ–¹åº“`Dio`ã€‚\n\n## HttpClient\n`HttpClient`æ˜¯`Dart:IO`åº“è‡ªå¸¦çš„ä¸€ä¸ªç±»ï¼Œé€šè¿‡ä»–æ¥å®ç°ç½‘ç»œè¯·æ±‚æœ€åº•å±‚ã€ä¹Ÿå¯ä»¥å®Œå®Œå…¨å…¨çš„è‡ªå®šä¹‰è®¾ç½®ï¼Œä½†æ˜¯ç›¸å¯¹äºå…¶ä»–äººå°è£…å¥½çš„ç¬¬ä¸‰æ–¹åº“æ¥è¯´æ˜¾å¾—å¤æ‚ã€‚\n\n### å¼•å…¥\nå¯¼å…¥`Dart:IO`åº“ï¼š\n```java\nimport 'dart:io';\n```\n\n### åˆ›å»ºä¸€ä¸ªHttpClient:\n```java\n HttpClient httpClient = new HttpClient();\n```\n\n### åˆ›å»ºä¸€ä¸ªUri\nå¦‚æœä½ æ˜¯`Http`è¯·æ±‚ï¼š\n```java\nvar uri = new Uri.http(\n    host,\n    queryParameters: {\n        \"xx\":\"xx\",\n        \"yy\":\"dd\"\n    }\n);\n```\nå¦‚æœä½ æ˜¯`Https`è¯·æ±‚ï¼š\n```java\nvar uri = new Uri.https(\n    host,\n    queryParameters: {\n        \"xx\":\"xx\",\n        \"yy\":\"dd\"\n    }\n);\n```\n### æ ¹æ®uriè·å–è¿”å›æ•°æ®\n```java\nHttpClientRequest request = await httpClient.getUrl(uri);\nHttpClientResponse response = await request.close();\n```\n\n### è¯»å–å†…å®¹\nè¿›è¡Œè¿™ä¸€æ­¥å¾—å¯¼å…¥`dart:convert`åº“ï¼š\n```java\nimport 'dart:convert';\n\n... //çœç•¥ä¸­é—´ä»£ç  \n\nString responseBody = await response.transform(Utf8Decoder()).join();\n\nprint(respinseBody)\n```\n### æœ€åå…³é—­Client\n```java\nhttpClient.close();\n```\n\n## Dio\n`Dio`æ˜¯Dartç¤¾åŒºä¸Šåˆ«äººä¸Šä¼ çš„ç¬¬ä¸‰æ–¹åº“ï¼Œä»–å°è£…äº†`HttpClient`ï¼Œç›¸è¾ƒæ¥è¯´æ›´ä¸ºç®€å•ã€æ–¹ä¾¿ã€‚\n\n### å¼•å…¥\nåœ¨é¡¹ç›®çš„`pubspec.yaml`æ–‡ä»¶çš„`dependencies`ä¸­å¯¼å…¥`Dio`ï¼š\n```java\ndependencies:\n  dio: \n  // å¦‚æœå†’å·åé¢ä¸å¸¦å…·ä½“ç‰ˆæœ¬ä¿¡æ¯åˆ™è¡¨ç¤ºè‡ªåŠ¨ä¸‹è½½æœ€æ–°ç‰ˆ\n```\n\næ¥ç€åœ¨éœ€è¦ä½¿ç”¨çš„ä»£ç æ–‡ä»¶é‡Œé¢ï¼Œ`import`å¯¼å…¥ä»–ï¼š\n```java\nimport 'package:dio/dio.dart';\n```\næ¥ç€æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`Dio`äº†ã€‚\n\n### ç¤ºä¾‹\né¦–å…ˆå¾—åˆ›å»ºä¸€ä¸ª`Dio`å¯¹è±¡ã€‚\n```java\nDio dio =  Dio();\n```\n\nå‘èµ·`GET`è¯·æ±‚ï¼š\n```java\nResponse response;\nresponse=await dio.get(uri)\nprint(response.data.toString());\n```\n\nå‘èµ·`POST`è¯·æ±‚ï¼š\n```java\nresponse=await dio.post(uri);\n```\n\n# Jsonè½¬Dart\n##  æ‰‹åŠ¨ç”ŸæˆDartå®ä½“ç±»\né¦–å…ˆå¾—å¤§å®¶å®‰åˆ©ä¸€ä¸ªç½‘ç«™ï¼Œå› ä¸ºDartå®ä½“ç±»æ¯”Javaå®ä½“ç±»å¤šäº†å‡ ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç›¸å¯¹æ¥è¯´éº»çƒ¦ï¼Œé€šè¿‡è¿™ä¸ªç½‘ç«™å°±å¯ä»¥è‡ªåŠ¨ç”Ÿæˆjsonæ•°æ®å¯¹åº”çš„å®ä½“ç±»:\n[https://caijinglong.github.io/json2dart/](https://caijinglong.github.io/json2dart/)\n\n![json2dart](http://cdn.littlecorgi.top/mweb/2019-10-12/json2dart.png)\n\næ¯”æ–¹è¯´æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªé“¾æ¥(http://guolin.tech/api/china)ï¼Œå¹¶è®©ä»–è‡ªåŠ¨è½¬dartï¼š\n![Province](http://cdn.littlecorgi.top/mweb/2019-10-12/Province.png)\n\næ¥ä¸‹æ¥åªéœ€è¦åˆ›å»ºdartæ–‡ä»¶ï¼Œç„¶åå†æŠŠä»£ç å¤åˆ¶è¿›å»å°±è¡Œäº†ã€‚\n\nä¸å‡ºæ„å¤–ï¼Œä»£ç è‚¯å®šä¼šæŠ¥é”™ã€‚\n![dartå®ä½“ç±»](http://cdn.littlecorgi.top/mweb/2019-10-12/dart%E5%AE%9E%E4%BD%93%E7%B1%BB.png)\n\næŠ¥é”™ä¿¡æ¯ä¸º:\n```java\nerror: Target of URI hasn't been generated: 'province.g.dart'. (uri_has_not_been_generated at [cool_weather] lib/bean/province.dart:3)\n\nerror: The method '_$ProvinceFromJson' isn't defined for the class 'Province'. (undefined_method at [cool_weather] lib/bean/province.dart:31)\n\nerror: The method '_$ProvinceToJson' isn't defined for the class 'Province'. (undefined_method at [cool_weather] lib/bean/province.dart:33)\n```\n\nè¿™æ˜¯å› ä¸ºæˆ‘ä»¬é¡¹ç›®ä¸‹è¿˜æ²¡æœ‰`province.g.dart`è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯æ ¹æ®dartå®ä½“ç±»è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆç”Ÿæˆä»–å‘¢ï¼Ÿ\n\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨`pubspec.yaml`æ–‡ä»¶ä¸­å¯¼å…¥ä¸‰ä¸ªä¾èµ–åŒ…ï¼š\n![è½¬dart](http://cdn.littlecorgi.top/mweb/2019-10-12/%E8%BD%ACdart.png)\næˆ‘ä»¬é‡ç‚¹åªéœ€è¦ç®¡ä¸‰ä¸ªå†™ç€éœ€è¦å¯¼å…¥çš„ã€‚è¾“å…¥ä¹‹åç‚¹å‡»`pubspec.yaml`æ–‡ä»¶å³ä¸Šè§’çš„`packages get`ï¼Œå°±ä¼šè‡ªåŠ¨ä¸‹è½½åŒ…äº†ã€‚\n\nç„¶ååœ¨ç»ˆç«¯ä¸­ï¼Œè½¬åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œè¾“å…¥\n```\nflutter packages pub run build_runner build\n```\næ¥ç€ä½ å°±ä¼šæƒŠå–œçš„å‘ç°ï¼Œåœ¨ä½ çš„dartå®ä½“ç±»ä¸‹é¢å¤šäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰€ç¼ºå¤±çš„~.g.dartæ–‡ä»¶ï¼Œå¹¶ä¸”å®ä½“ç±»ä¸­é‚£äº›æŠ¥é”™ä¹Ÿéƒ½æ²¡äº†ã€‚\n![dart.g.dart](http://cdn.littlecorgi.top/mweb/2019-10-12/dart.g.dart.png)\n\n## å°†è¯·æ±‚å›æ¥çš„Responseè½¬ä¸ºDartå®ä½“ç±»\n\næ¥ç€HttpClientè¿”å›æ¥çš„responseBodyæˆ–è€…Dioè¿”å›çš„response\n\n```java\nList<Province> provinceList;\nprovinceList = ProvinceList.getProvinceList(jsonResponse);\n```\n\nprovinceListå°±æ˜¯è¿”å›æ¥çš„æ•°æ®è½¬æˆçš„å®ä½“ç±»çš„å¯¹è±¡äº†ã€‚\n\n# å¼‚æ­¥æ›´æ–°UI\nåœ¨æ­¤å¤„ä»‹ç»ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯æˆ‘è‡ªå·±æƒ³å‡ºæ¥çš„æ²™é›•æ–¹æ³•ï¼Œç¬¬äºŒç§æ˜¯é€šè¿‡Flutteræä¾›çš„ä¸“é—¨ç”¨äºå¼‚æ­¥æ›´æ–°UIçš„ç»„ä»¶FutureBuilderã€‚\n## æ²™é›•æ–¹æ³•\nåœ¨æ­¤è¯´ä¸€ä¸‹æˆ‘è¿™ä¸ªæ–¹æ³•çš„æƒ³æ³•ã€‚\n\nå¤§å®¶å¯ä»¥å›é¡¾ä¸‹æˆ‘ä¹‹å‰è®²Widgetçš„æ—¶å€™è¯´è¿‡ï¼ŒWidgetæœ‰ä¸€ä¸ªæ–¹æ³•initStateå¯ä»¥ç”¨æ¥åŠ è½½UIï¼Œä»¥åŠä¸€ä¸ªsetStateæ–¹æ³•å¯ç”¨æ¥æé†’Flutteré‡æ–°åŠ è½½UIã€‚\n\nè¯´åˆ°è¿™å¾ˆå¤šåŒå­¦ä¸€å®šæƒ³åˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è·å–åˆ°æ•°æ®ä¹‹åé€šè¿‡setStateæ–¹æ³•æ¥æ›´æ–°UIã€‚\n\n### è·å–åˆ°æ•°æ®\nè¿™ä¸ªä¸åŒå¤šè¯´ï¼Œä¸Šé¢è®²çš„å…¨éƒ½æ˜¯è·å–æ•°æ®ã€‚\n\n### è®¾ç½®ä¸€ä¸ªç©ºçš„å®ä½“ç±»\næ­¤å¤„æˆ‘è¿˜æ˜¯æ‹¿ä¸Šé¢çš„Province.dartæ¥åšä¾‹å­ã€‚æˆ‘ä»¬æ­£å¸¸æƒ…å†µä¸‹è·å–åˆ°çš„æ•°æ®è½¬æˆçš„å®ä½“ç±»çš„å¯¹è±¡æ˜¯`List<Province> provinceList`ã€‚æ‰€ä»¥æˆ‘ä»¬æ­¤å¤„å…ˆè®¾ç½®ä¸€ä¸ªç©ºçš„å¯¹è±¡:`List<Province> _provinceList`ã€‚\n\næ¥ç€åœ¨initStateé‡Œé¢è°ƒç”¨ç½‘ç»œè¯·æ±‚çš„æ–¹æ³•ï¼š\n```java\n@override\nvoid initState() {\n    getProvince();\n    super.initState();\n}\n```\n\nç„¶ååœ¨getProvinceæ–¹æ³•é‡Œé¢è·å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®provinceListä¼ ç»™_provinceListï¼š\n\n```java\nvoid getProvince() async {\n    var response = await Dio().get(\"http://guolin.tech/api/china\");\n    provinceList = ProvinceList.getProvinceList(response);\n    setState(() {\n        _provinces = provinceList;\n    });\n}\n```\n\nè¿™æ ·å°±å¯ä»¥å½“è·å–åˆ°æ•°æ®çš„æ—¶å€™å°±é€šçŸ¥Flutteræ›´æ–°çŠ¶æ€äº†ã€‚è¿™ä¸ªæ—¶å€™æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®æˆ‘ï¼Œä½ è¿™ä¸ªä¹Ÿåªæ˜¯è·å–åˆ°æ•°æ®çš„æ—¶å€™æ‰æ›´æ–°å•Šï¼Œé‚£å½“è¿˜æ²¡è·å–åˆ°æ•°æ®çš„æ—¶å€™å‘¢ï¼Ÿ\n\nè¿™å—å°±ä½“ç°åˆ°äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸ª_provincesäº†ã€‚\n\næˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨buildæ–¹æ³•è®¾ç½®ä¸‹ï¼Œåˆ¤æ–­ä¸‹_provincesä¸ºä¸ä¸ºç©º:å¦‚æœä¸ºç©ºï¼Œå°±è¯æ˜æ²¡æ•°æ®ï¼Œå°±åŠ è½½å…¶å®ƒé¡µé¢ï¼›å¦‚æœä¸ä¸ºç©ºï¼Œå°±è¯æ˜æœ‰æ•°æ®äº†ï¼Œé‚£å°±åŠ è½½æ•°æ®ã€‚\n```java\nbody: _provinces == null\n          ? new Text(\"æ­£åœ¨è¯·æ±‚\")\n          : new ListView.builder(\n          ... //çœå»ä»£ç ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯å°†_provincesçš„æ•°æ®åŠ è½½ListViewé‡Œé¢ï¼Œä¸€ä¸ªListViewçš„åŸºæœ¬æ„é€ æ–¹æ³•\n          )\n```\n\n## FutureBuilder\nå›å½’æ­£é¢˜ï¼Œæˆ‘ä¸Šé¢é‚£ä¸ªæ–¹æ³•çœŸçš„æ˜¯æœ‰å¤Ÿæ²™é›•çš„ã€‚\n\né‚£æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªåæ­£è¨€é¡ºçš„Flutteräº²ç”Ÿå„¿å­FutureBuilderã€‚\n\né¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹å®šä¹‰ï¼š\n```java\nFutureBuilder({\n  this.future,\n  this.initialData,\n  @required this.builder,\n})\n```\n- futureï¼šå¼‚æ­¥ä»»åŠ¡ï¼›\n- initialDataï¼šåˆå§‹åŒ–æ•°æ®ï¼›\n- builderï¼šbuilderæ–¹æ³•ã€‚\n\n### ç¤ºä¾‹\n```java\nbody: FutureBuilder(\n    future: Dio().get(\"http://guolin.tech/api/china\"),\n    builder: (BuildContext context, AsyncSnapshot snapshot) {\n        if (snapshot.connectionState == ConnectionState.done) {\n            Response response = snapshot.data;\n            print(response.toString());\n            //å‘ç”Ÿé”™è¯¯\n            if (snapshot.hasError) {\n                return Text(snapshot.error.toString());\n            }\n\n            provinceList = ProvinceList.fromJson(response.data);\n            //è¯·æ±‚æˆåŠŸï¼Œé€šè¿‡é¡¹ç›®ä¿¡æ¯æ„å»ºç”¨äºæ˜¾ç¤ºé¡¹ç›®åç§°çš„ListView\n            return ListView.builder(\n                itemCount: provinceList.provinces.length,\n                itemBuilder: (context, index) {\n                    return GestureDetector(\n                        child: ListTile(\n                            title: Text(\"${provinceList.provinces[index].name}\"),\n                        ),\n                        onTap: () {\n                            Navigator.push(context,\n                                MaterialPageRoute(builder: (context) {\n                                    return CityPageWidget(\n                                        cityID: provinceList.provinces[index].id);\n                                }));\n                        },\n                    );\n                },\n            );\n        }\n        // è¯·æ±‚æœªå®Œæˆæ—¶å¼¹å‡ºloading\n        return CircularProgressIndicator();\n    },\n)\n```","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(6)â€”â€”å¤©æ°”é¢„æŠ¥ç¬¬ä¸€æ­¥-ç•Œé¢","url":"/posts/15395a84.html","content":"\nç»è¿‡å‰é¢çš„å¯¹äºFlutterçš„ä»‹ç»ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„å¤©æ°”é¢„æŠ¥APPçš„ç•Œé¢äº†ã€‚\n\n\né¡¹ç›®Githubåœ°å€ï¼š[a1203991686/CoolWeather_Flutter](https://github.com/a1203991686/CoolWeather_Flutter)\n\n<!--More-->\n# 1. å¤§è‡´ç•Œé¢\næœ€ç»ˆå†™æˆçš„å¤§è‡´ç•Œé¢å¦‚å›¾ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570712111.png\" width = 50% />\n\næˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªç•Œé¢æ‹†åˆ†æˆå¦‚ä¸‹éƒ¨åˆ†ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570711214.png\" width = 50% />\n\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬APPä¸»è¦æœ‰æœ€ä¸Šé¢ç”¨æ¥æ˜¾ç¤ºåœ°ç‚¹å’Œåˆ·æ–°æ—¶é—´çš„`Title`ã€æ˜¾ç¤ºæ¸©åº¦å’Œå¤©æ°”çš„ä¸¤ä¸ª`Text`ã€æ˜¾ç¤º3å¤©é¢„æŠ¥çš„`ListView`ã€æ˜¾ç¤ºç©ºæ°”è´¨é‡çš„`GridView`ã€ä»¥åŠæœ€åæ˜¾ç¤ºç”Ÿæ´»å»ºè®®çš„`ListView`ã€‚\n\næ­¤å¤„ä¼šç”¨åˆ°æˆ‘ä»¬å‰é¢å­¦è¿‡çš„æ‰€æœ‰çŸ¥è¯†ï¼Œå¦‚æœæœ‰åŒå­¦æ²¡æœ‰çœ‹è¿‡å‰é¢å†…å®¹çš„ï¼Œå¯ä»¥çœ‹ä¸‹æœ¬ç³»åˆ—å‰é¢çš„æ–‡ç« ã€‚\n\n# 2. åˆ›å»ºé¡¹ç›®\né¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„Flutteré¡¹ç›®ï¼š\n1. åœ¨AndroidStudioç‚¹å‡»`File`->`New Flutter Project`ï¼›\n2. æ¥ç€é€‰æ‹©`Flutter Application`->`NEXT`ã€‚æ¥ç€å¡«å†™ä½ çš„é¡¹ç›®åç§°ç­‰ä¸€ç³»åˆ—ä¿¡æ¯åç‚¹å‡»`next`ï¼›â€¨![New Flutter Project](http://cdn.littlecorgi.top/mweb/2019-10-11/New%20Flutter%20Project.png)\n3. æ¥ç€è¾“å…¥ä½ çš„ç»„ç»‡/å…¬å¸åç§°ä½œä¸ºåŒ…åï¼Œæœ€åç‚¹å‡»`Finish`å³å¯ï¼Œè¿™æ ·å°±æ–°å»ºäº†ä¸€ä¸ªFlutteré¡¹ç›®ï¼Œå¹¶ä¸”Flutterä¼šè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆä¸€ä¸ªè®¡æ•°å™¨Demoï¼›\n    ![package ne](http://cdn.littlecorgi.top/mweb/2019-10-11/package%20new.png)\n4. è®©æˆ‘ä»¬æŠŠ`mian.dart`é‡Œé¢çš„æ‰€æœ‰æ³¨é‡Šä»¥åŠ`_MyHomePageState`é‡Œé¢çš„`build`æ–¹æ³•é‡Œé¢çš„ä»£ç éƒ½åˆ æ‰ï¼›\n5. æ¥ç€åœ¨`lib`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåå«`view`ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬æŠŠæ‰€æœ‰ä¸ç•Œé¢æœ‰å…³çš„ä»£ç æ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ï¼›\n6. ç„¶åæˆ‘ä»¬åœ¨`view`æ–‡ä»¶å¤¹ä¸‹é¢æ–°å»ºä¸€ä¸ªdartæ–‡ä»¶ï¼Œå‘½åä¸º`main_page`ã€‚è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„å¤©æ°”è¯¦æƒ…é¡µã€‚\n\nâ€¨\n# 3. è®¾è®¡å¥½å¤©æ°”è¯¦æƒ…é¡µæ¡†æ¶\né¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¼å…¥`material`åŒ…ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸»è¦ç”¨materialé£æ ¼UIæ¥å†™ã€‚\n\nåœ¨å¼€å¤´è¾“å…¥`import 'package:flutter/material.dart';`ï¼Œè¿™æ ·å°±å¯¼å…¥äº†`material`åŒ…ã€‚æ¥ç€åˆ›å»ºæˆ‘ä»¬çš„ç•Œé¢ç±»`MainPage`ã€‚\n\nç”±äºæˆ‘ä»¬åœ¨åˆ°æ—¶å€™å†™å¥½ç½‘ç»œè¯·æ±‚åï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å¾—ä»ç½‘ç»œè·å–ï¼Œå¹¶ä¸”ä½¿ç”¨äº†å¼‚æ­¥çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å…ˆæŠŠé¡µé¢åŠ è½½äº†ç„¶åç­‰è·å–çš„æ•°æ®å›æ¥äº†åœ¨é€šçŸ¥Flutteræ›´æ–°çŠ¶æ€ï¼Œæ‰€ä»¥è¿™å—æˆ‘ä»¬å¾—ä½¿ç”¨`StatefulWidget`ã€‚\n```java\nclass MainPage extends StatefulWidget {\n  MainPage({Key key}) : super(key: key);\n\n  @override\n  MainPageState createState() => new MainPageState();\n}\n\nclass MainPageState extends State<MainPage> {\n  @override\n  Widget build(BuildContext context) {\n  \n  }\n}\n```\n\næ¥ç€æˆ‘ä»¬å°±å¾—å¼€å§‹å†™`build()`é‡Œé¢çš„å†…å®¹äº†ã€‚ç”±äºæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±çš„èƒŒæ™¯å›¾ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä½¿ç”¨`Container`ä½œä¸ºæˆ‘ä»¬æœ€å¤–å±‚çš„Widgetï¼Œå¹¶ä½¿ç”¨`BoxDecoration`è£…é¥°å®¹å™¨é…åˆ`DecorationImage`æ¥æ”¾ç½®å›¾ç‰‡ï¼š\n```java\n@override\nWidget build(BuildContext context) {\n  return Container(\n    decoration: BoxDecoration(\n      image: DecorationImage(\n        image: NetworkImage(\"http://blog.mrabit.com/bing/today\"), //å¿…åº”æ¯æ—¥ä¸€å›¾èƒŒæ™¯\n        fit: BoxFit.cover, // è®¾ç½®ä¸ºå…¨å±\n      ),\n    ),\n    child: _weatherBody(),\n  );\n}\n```\n\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„è¿è¡Œç»“æœå¦‚å›¾(â‘ ä½ èƒŒæ™¯å›¾ç‰‡å¤šåŠå’Œæˆ‘ä¸ä¸€æ ·ï¼Œå› ä¸ºä¸Šé¢é‚£ä¸ªUriè·å–çš„æ˜¯å¿…åº”çš„æ¯æ—¥ä¸€å›¾ï¼Œæ¯å¤©å›¾ç‰‡éƒ½ä¸ä¸€æ ·ï¼›â‘¡è¿è¡Œçš„æ—¶å€™è®°å¾—æŠŠ`child: _weatherBody(),`ç»™æ³¨é‡Šæ‰ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰`_weatherBody()`è¿™ä¸ªæ–¹æ³•):\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570797585.png\" width = 50% />\n\n\n# 4. è®¾è®¡title\nä¸ºäº†æ–¹ä¾¿æˆ‘å°±ç›´æ¥æŠŠå‰©ä¸‹çš„å¸ƒå±€å•é¢†å‡ºæ¥æ”¾åˆ°`_weatherBody()`è¿™ä¸ªæ–¹æ³•:\n```java\nWidget _weatherBody() {\n  return\n}\n```\nç”±äºæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæœ‰Titleçš„é¡µé¢ï¼Œæ‰€ä»¥æœ€å¤–å±‚æˆ‘é€‰ç”¨äº†Scaffoldï¼š\n```java\nWidget _weatherBody() {\n  return Scaffold(\n    backgroundColor: Colors.transparent, //èƒŒæ™¯é€æ˜\n    appBar: AppBar(\n      centerTitle: true,\n      title: Text(\n        \"åŒ—äº¬\",\n        style: TextStyle(fontSize: 25.0),\n      ),\n      backgroundColor: Colors.transparent, //èƒŒæ™¯é€æ˜\n      actions: <Widget>[ //å³ä¾§Widgetï¼Œç›¸å½“äºAndroid Toolbarä¸­çš„menu\n        Container(\n          alignment: Alignment.center, //å‘ä¸­é—´å¯¹é½\n          child: Text(\n            \"12:10\",\n            textAlign: TextAlign.center, //æ–‡å­—å‘ä¸­é—´å¯¹é½\n          ),\n        )\n      ],\n    ),\n    body: SingleChildScrollView( // ç”±äºåˆ°æ—¶å€™æ•´ä¸ªé¡µé¢ä¸€ä¸ªå±å¹•å¯èƒ½æ”¾ä¸ä¸‹ï¼Œå°±æ”¾ç½®äº†ä¸€ä¸ªæ»šåŠ¨å¸ƒå±€\n    \n    ),\n  );\n}\n```\n\nè¿™ä¸ªæ—¶å€™çš„è¿è¡Œç»“æœæ˜¯ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570797746.png\" width = 50% />\n\n\n# 5. è®¾è®¡ä¸‹é¢å¤©æ°”é¢„æŠ¥é¡µé¢\næ¥ä¸‹æ¥å¯ä»¥å¼€å§‹ä¸‹ä¸‹é¢çš„å¤©æ°”æ˜¾ç¤ºé¡µé¢äº†ã€‚\n## å½“å‰æ¸©åº¦å’Œå¤©æ°”æƒ…å†µ\né¦–å…ˆå†™ä¸€ä¸ªçºµå‘çº¿æ€§å¸ƒå±€`Column`:\n```java\nbody: SingleChildScrollView(\n  child: Column(\n    children: <Widget>[\n      \n    ]\n  )\n),\n```\nç”±äºæˆ‘ä»¬è¦æ˜¾ç¤ºåœ¨å±å¹•æœ€å³è¾¹ï¼Œæ‰€ä»¥ä½¿ç”¨Align:\n```java\nbody: SingleChildScrollView(\n  child: Column(\n    children: <Widget>[\n      Align(\n        alignment: Alignment.centerRight,\n        child:Text(\n          \"26Â°C\",\n          style: TextStyle(\n            fontSize: 50.0,\n            color: Colors.white,\n          ),\n        ),\n      ),\n      Align(\n        alignment: Alignment.centerRight,\n        child:Text(\n          \"é˜´\",\n          style: TextStyle(\n            fontSize: 20.0,\n            color: Colors.white,\n          ),\n        ),\n      ),\n    ]\n  )\n),\n```\n\nè¿è¡Œç»“æœæ˜¯ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570797847.png\" width = 50% />\n\n\næ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ˜¾ç¤º3å¤©å¤©æ°”é¢„æŠ¥ã€å¤©æ°”è´¨é‡ä»¥åŠç”Ÿæ´»å»ºè®®çš„ä¸‰ä¸ªå­æ§ä»¶ï¼ŒåŒæ ·ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬ä¹ŸæŠŠä»–ä»¬ç»™å•é¢†å‡ºæ¥ï¼Œäºæ˜¯ä¸Šé¢çš„Columnæ¥ä¸‹æ¥å¯ä»¥è¿™æ ·å†™ï¼š\n```java\nbody: SingleChildScrollView(\n  child: Column(\n    children: <Widget>[\n      ... //ä¸Šé¢çš„ä¸¤ä¸ªText\n      Padding(\n        padding: EdgeInsets.only(\n          left: 15.0,\n          right: 15.0,\n          bottom: 15.0,\n        ),\n        child: Container(\n          color: Colors.black54,\n          child: _weatherList(), //3å¤©å¤©æ°”é¢„æŠ¥\n        ),\n      ),\n      Padding(\n        padding: EdgeInsets.only(\n          left: 15.0,\n          right: 15.0,\n        ),\n        child: Container(\n          color: Colors.black54,\n          child: _atmosphereList(), //ç©ºæ°”è´¨é‡\n        ),\n      ),\n      Padding(\n        padding: EdgeInsets.only(\n          top: 15.0,\n          left: 15.0,\n          right: 15.0,\n          bottom: 15.0,\n        ),\n        child: Container(\n          color: Colors.black54,\n          child: _lifestyleList(), //ç”Ÿæ´»å»ºè®®\n        ),\n      ),\n    ]\n  )\n),\n```\n\n## 3å¤©å¤©æ°”é¢„æŠ¥\nå¯¹äº3å¤©å¤©æ°”é¢„æŠ¥æˆ‘ä»¬ä¸»è¦é€šè¿‡ListViewæ¥å®ç°ï¼Œç”±äºåˆ°æ—¶å€™æ•°æ®æ¯”è¾ƒçµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç›´æ¥ä½¿ç”¨ListView.Builderæ¥å®ç°ï¼š\n```java\nList<String> dates = [\"2019/10/01\", \"2019/10/02\", \"2019/10/03\"];\nList<String> temperatures = [\"29/14\", \"30/18\", \"29/18\"];\nList<String> texts = [\"é˜´\", \"æ™´\", \"é›¨\"];\n\nWidget _weatherList() {\n    return Column(\n        children: <Widget>[\n            Align(\n                alignment: Alignment.centerLeft,\n                child: Text(\n                    \"é¢„æŠ¥\",\n                    style: TextStyle(\n                        color: Colors.white,\n                        fontSize: 20.0,\n                    ),\n                ),\n            ),\n            ListView.builder(\n                shrinkWrap: true, //è¿™ä¸ªæ˜¯æŒ‡æ ¹æ®ListViewæ‰€æœ‰å­Widgetçš„é•¿åº¦æ¥è®¾å®šListViewçš„é•¿åº¦\n                physics: NeverScrollableScrollPhysics(), //ç¦æ­¢ListViewè‡ªå·±çš„æ»‘åŠ¨ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤–é¢ç”¨äº†ä¸ªSingleChildScrollViewï¼Œæˆ‘ä»¬é€šè¿‡ä»–çš„æ»‘åŠ¨å°±å¯ä»¥äº†\n                itemCount: dates.length, //ListViewå­é¡¹ä¸ªæ•°\n                itemBuilder: (BuildContext context, int index) {\n                    return ListTile(\n                        title: Row(\n                            mainAxisAlignment: MainAxisAlignment.spaceBetween, //è¿™ä¸ªæ˜¯Rowçš„ä¸»è½´çš„å­é¡¹çš„åˆ†å¸ƒæ ¼å¼ï¼ŒspaceBetweenæ˜¯æŒ‡å¹³å‡åˆ†å¸ƒ\n                            mainAxisSize: MainAxisSize.max,\n                            children: <Widget>[\n                                Text(\n                                    \"${dates[index]}\",\n                                    style: TextStyle(color: Colors.white),\n                                ),\n                                Text(\n                                    \"${temperatures[index]}\",\n                                    style: TextStyle(color: Colors.white),\n                                ),\n                                Text(\n                                    \"${texts[index]}\",\n                                    style: TextStyle(color: Colors.white),\n                                ),\n                            ],\n                        ),\n                    );\n                }),\n        ],\n    );\n}\n```\n\nè¿™ä¸ªæ—¶å€™è¿è¡Œç»“æœæ˜¯ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570798505.png\" width = 50% />\n\n\n## ç©ºæ°”è´¨é‡\nè¿™å—æˆ‘ä»¬éœ€è¦ç”¨åˆ°GridViewï¼Œç”±äºåªæœ‰ä¸¤ä¸ªæ˜¾ç¤ºå†…å®¹ï¼Œè€Œä¸”æˆ‘ä»¬åæœŸä¹Ÿæ²¡æœ‰éœ€è¦åŠ¨æ€æ·»åŠ çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç›´æ¥ä½¿ç”¨GridViewæ„é€ æ–¹æ³•ï¼Œè€Œä¸å»ä½¿ç”¨GridViewçš„builderæ–¹æ³•ï¼š\n```java\nList<String> atmospheres = [\"16\", \"56\"];\n\nWidget _atmosphereList() {\n    return Column(\n        children: <Widget>[\n            Align(\n                alignment: Alignment.centerLeft,\n                child: Text(\n                    \"ç©ºæ°”è´¨é‡\",\n                    style: TextStyle(\n                        color: Colors.white,\n                            fontSize: 20.0,\n                    ),\n                ),\n            ),\n            GridView(\n                shrinkWrap: true, //è§ä¸Šé¢3å¤©å¤©æ°”é¢„æŠ¥çš„ListViewå¤„\n                physics: NeverScrollableScrollPhysics(), //è§ä¸Šé¢3å¤©å¤©æ°”é¢„æŠ¥çš„ListViewå¤„\n                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(\n                    crossAxisCount: 2, //æ¨ªè½´ä¸‰ä¸ªå­widget\n                    childAspectRatio: 2 //æ˜¾ç¤ºåŒºåŸŸå®½é«˜ç›¸ç­‰\n                ),\n                children: <Widget>[\n                    Column(\n                        children: <Widget>[\n                            Text(\n                                \"${atmospheres[0]}\",\n                                style: TextStyle(\n                                    color: Colors.white,\n                                    fontSize: 40.0,\n                                ),\n                            ),\n                            Text(\n                                \"èƒ½è§åº¦\",\n                                style: TextStyle(\n                                    color: Colors.white,\n                                    fontSize: 20.0,\n                                ),\n                            ),\n                        ],\n                    ),\n                    Column(\n                        children: <Widget>[\n                            Text(\n                                \"${atmospheres[1]}\",\n                                style: TextStyle(\n                                    color: Colors.white,\n                                    fontSize: 40.0,\n                                ),\n                            ),\n                            Text(\n                                \"æ¹¿åº¦\",\n                                style: TextStyle(\n                                    color: Colors.white,\n                                    fontSize: 20.0,\n                                ),\n                            ),\n                        ],\n                    ),\n                ],\n            ),\n        ],\n    );\n}\n```\n\nè¿è¡Œåçš„æ•ˆæœæ˜¯ï¼š\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570799107.png\" width = 50% />\n\n## ç”Ÿæ´»å»ºè®®\nè¿™å—å’Œ3å¤©å¤©æ°”é¢„æŠ¥ä¸€æ ·ï¼Œè€Œä¸”æ•°æ®æ¯”3å¤©å¤©æ°”é¢„æŠ¥æ›´å¤šï¼Œæ‰€ä»¥ä»–æ›´é€‚åˆç”¨ListView.builderï¼š\n```java\nList<String> _lifestyleWeatherBrf = [\n    \"è¾ƒèˆ’é€‚\",\n    \"è¾ƒèˆ’é€‚\",\n    \"é€‚å®œ\",\n    \"é€‚å®œ\",\n    \"å¼±\",\n    \"è¾ƒé€‚å®œ\",\n    \"ä¸­\"\n];\nList<String> _lifestyleWeatherTxt = [\n    \"ç™½å¤©å¤©æ°”æ™´å¥½ï¼Œæ—©æ™šä¼šæ„Ÿè§‰åå‡‰ï¼Œåˆåèˆ’é€‚ã€å®œäººã€‚\",\n    \"å»ºè®®ç€è–„å¤–å¥—ã€å¼€è¡«ç‰›ä»”è¡«è£¤ç­‰æœè£…ã€‚å¹´è€ä½“å¼±è€…åº”é€‚å½“æ·»åŠ è¡£ç‰©ï¼Œå®œç€å¤¹å…‹è¡«ã€è–„æ¯›è¡£ç­‰ã€‚\",\n    \"å„é¡¹æ°”è±¡æ¡ä»¶é€‚å®œï¼Œæ— æ˜æ˜¾é™æ¸©è¿‡ç¨‹ï¼Œå‘ç”Ÿæ„Ÿå†’æœºç‡è¾ƒä½ã€‚\",\n    \"å¤©æ°”è¾ƒå¥½ï¼Œèµ¶å¿«æŠ•èº«å¤§è‡ªç„¶å‚ä¸æˆ·å¤–è¿åŠ¨ï¼Œå°½æƒ…æ„Ÿå—è¿åŠ¨çš„å¿«ä¹å§ã€‚\",\n    \"å¤©æ°”è¾ƒå¥½ï¼Œä½†ä¸æ¯«ä¸ä¼šå½±å“æ‚¨å‡ºè¡Œçš„å¿ƒæƒ…ã€‚æ¸©åº¦é€‚å®œåˆæœ‰å¾®é£ç›¸ä¼´ï¼Œé€‚å®œæ—…æ¸¸ã€‚\",\n    \"ç´«å¤–çº¿å¼ºåº¦è¾ƒå¼±ï¼Œå»ºè®®å‡ºé—¨å‰æ¶‚æ“¦SPFåœ¨12-15ä¹‹é—´ã€PA+çš„é˜²æ™’æŠ¤è‚¤å“ã€‚\",\n    \"è¾ƒé€‚å®œæ´—è½¦ï¼Œæœªæ¥ä¸€å¤©æ— é›¨ï¼Œé£åŠ›è¾ƒå°ï¼Œæ“¦æ´—ä¸€æ–°çš„æ±½è½¦è‡³å°‘èƒ½ä¿æŒä¸€å¤©ã€‚\",\n    \",æ°”è±¡æ¡ä»¶å¯¹ç©ºæ°”æ±¡æŸ“ç‰©ç¨€é‡Šã€æ‰©æ•£å’Œæ¸…é™¤æ— æ˜æ˜¾å½±å“ï¼Œæ˜“æ„Ÿäººç¾¤åº”é€‚å½“å‡å°‘å®¤å¤–æ´»åŠ¨æ—¶é—´ã€‚\"\n];\n\nWidget _lifestyleList() {\n    return Column(\n        children: <Widget>[\n            Align(\n                alignment: Alignment.centerLeft,\n                child: Text(\n                    \"ç”Ÿæ´»å»ºè®®\",\n                    style: TextStyle(\n                        color: Colors.white,\n                        fontSize: 20.0,\n                    ),\n                ),\n            ),\n            ListView.builder(\n                shrinkWrap: true,\n                physics: NeverScrollableScrollPhysics(),\n                itemCount: _lifestyleWeatherBrf.length,\n                itemBuilder: (BuildContext context, int index) {\n                    return ListTile(\n                        title: Column(\n                            mainAxisAlignment: MainAxisAlignment.start,\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            children: <Widget>[\n                                Text(\n                                    \"${_lifestyleWeatherBrf[index]}\",\n                                    style: TextStyle(\n                                        color: Colors.white,\n                                    ),\n                                ),\n                                Text(\n                                    \"${_lifestyleWeatherTxt[index]}\",\n                                    style: TextStyle(\n                                        color: Colors.white,\n                                    ),\n                                ),\n                            ],\n                        ),\n                    );\n                },\n            ),\n        ],\n    );\n}\n```\n\nè¿è¡Œç»“æœæ˜¯:\n\n<img src=\"http://cdn.littlecorgi.top/mweb/2019-10-11/Screenshot_1570799686.png\" width = 50% />\n","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(5)â€”â€”SingleChildScrollViewã€ListViewå’ŒGridView","url":"/posts/30ff421d.html","content":"ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸‹Flutterä¸­çš„æ»‘åŠ¨æ§ä»¶`SingleChildScrollView`ã€åˆ—è¡¨`ListView`å’Œè¡¨æ ¼`GridView`ã€‚\n<!--More-->\n# SingleChildScrollView\n`SingleChildScrollView`ç±»ä¼¼äºAndroidä¸­çš„`ScrollView`ï¼Œæˆ‘ä½¿ç”¨çš„è¾ƒæµ…ï¼Œåœ¨æˆ‘ç›®å‰çœ‹æ¥ï¼Œä»–å’Œ`ScrollView`çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯å®ƒè¿˜å¯ä»¥æ¨ªå‘æ»šåŠ¨ã€‚\n\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»–çš„å®šä¹‰ï¼š\n```java\nSingleChildScrollView({\n  this.scrollDirection = Axis.vertical, //æ»šåŠ¨æ–¹å‘ï¼Œé»˜è®¤æ˜¯å‚ç›´æ–¹å‘\n  this.reverse = false, \n  this.padding, \n  bool primary, \n  this.physics, \n  this.controller,\n  this.child,\n})\n```\n\n- `scrollDirection`ï¼šè®¾å®šæ»šåŠ¨çš„æ–¹å‘ï¼Œå¯ä»¥è®¾å®š`Axis.vertical`æˆ–è€…`Axis.horizon`ï¼›\n- `reverse`ï¼šæ˜¯å¦æŒ‰ç…§é˜…è¯»æ–¹å‘çš„åæ–¹å‘æ»‘åŠ¨ï¼Œemmmè¿™ä¸ªå¯èƒ½æœ‰ç‚¹è§‰å¾—è«åå…¶å¦™ï¼Œä½†æ˜¯å¦‚é˜¿æ‹‰ä¼¯è¯­è¨€åœ°åŒºï¼Œä»–ä»¬é˜…è¯»å’Œæˆ‘å›½å¤æ—¶å€™ä¸€æ ·æ˜¯ä»å³å‘å·¦çš„ï¼Œæ‰€ä»¥å¦‚æœ`reverse`ä¸º`true`ï¼Œä¸”æ»šåŠ¨æ–¹å‘æ˜¯æ°´å¹³æ»šåŠ¨çš„è¯ï¼Œå¦‚æœç³»ç»Ÿæ—¶é˜¿æ‹‰ä¼¯è¯­ç­‰ä»å³å‘å·¦é˜…è¯»çš„è¯­è¨€æ—¶ï¼Œæ–¹å‘æ˜¯ä»å³å‘å·¦çš„ï¼›\n- `padding`ï¼šç•™ç™½çš„å¤§å°ï¼Œå’Œ`Padding`çš„ç”¨æ³•ä¸€æ ·ï¼Œé€šè¿‡`EdgeInsets`æ¥è®¾å®šï¼Œå…·ä½“å¯ä»¥çœ‹å‰å‡ ç« å°†FlutteråŸºç¡€Widgetï¼›\n- `primary`ï¼šæŒ‡æ˜¯å¦ä½¿ç”¨widgetæ ‘ä¸­é»˜è®¤çš„`PrimaryScrollController`ï¼›å½“æ»‘åŠ¨æ–¹å‘ä¸ºå‚ç›´æ–¹å‘ï¼ˆ`scrollDirection`å€¼ä¸º`Axis.vertical`ï¼‰å¹¶ä¸”æ²¡æœ‰æŒ‡å®š`controller`æ—¶ï¼Œ`primary`é»˜è®¤ä¸º`true`ï¼›\n- `physics`ï¼šç”¨äºæ§åˆ¶æ»šåŠ¨æ–¹å¼ï¼Œè¿™ä¸ªç­‰ä¼šé‡ç‚¹è®²è§£ï¼›\n- `controller`ï¼šç”¨äºæ»šåŠ¨ç›‘å¬åŠæ§åˆ¶ï¼›\n- `child`ï¼šå­Widgetã€‚\n\n## physics\nè¿™ä¸ªå‚æ•°æ˜¯ç”¨äºæ§åˆ¶æ»šåŠ¨æ–¹å¼ï¼Œæœ‰å‡ ç§å‚æ•°ï¼š\n- `NeverScrollablePhysics`ï¼šå‘ˆç°ä¸å¯æ»šåŠ¨çŠ¶æ€ï¼›\n- `BouncingScrollPhysics`ï¼šå½“åˆ—è¡¨æ»‘åŠ¨ç»“æŸæ—¶ï¼Œä¼šå›å¼¹åˆ—è¡¨ï¼Œç±»ä¼¼äºiOSçš„åˆ—è¡¨æ»‘åŠ¨æ•ˆæœï¼›\nâ€¨![BouncingScrollPhysics](http://cdn.littlecorgi.top/mweb/2019-10-10/BouncingScrollPhysics.gif)\n\n- `ClampingScrollPhysics`ï¼šæ»‘åŠ¨ç»“æŸæ—¶ä¼šæ˜¾ç¤ºæ°´æ³¢çº¹é˜´å½±ï¼Œç±»ä¼¼äºAndroidçš„åˆ—è¡¨æ»‘åŠ¨æ•ˆæœï¼›\nâ€¨![ClampingScrollPhysics](http://cdn.littlecorgi.top/mweb/2019-10-10/ClampingScrollPhysics.gif)\n\n- `FixedExtentScrollPhysics`ï¼šå¯ä»¥è‡ªå·±åˆ¶ä½œæ»‘åŠ¨æ•ˆæœï¼Œä½†æ˜¯æˆ‘ä¹Ÿä¸ä¼šï¼Œæ‰€ä»¥åœ¨æ­¤ä¸åšè§£é‡ŠğŸ˜ã€‚\n\n# ListView\n`ListView`å¯ä»¥æ²¿ä¸€ä¸ªæ–¹å‘ä¸Šçº¿æ€§æ’å¸ƒæ‰€æœ‰å­ç»„ä»¶ï¼ˆä¸ä»…å±€é™äºç«–ç›´æ–¹å‘ï¼‰ã€‚\n\nè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ä»–çš„å®šä¹‰ï¼š\n```java\nListView({\n  ...  \n  //å¯æ»šåŠ¨widgetå…¬å…±å‚æ•°\n  Axis scrollDirection = Axis.vertical,\n  bool reverse = false,\n  ScrollController controller,\n  bool primary,\n  ScrollPhysics physics,\n  EdgeInsetsGeometry padding,\n\n  //ListViewå„ä¸ªæ„é€ å‡½æ•°çš„å…±åŒå‚æ•°  \n  double itemExtent,\n  bool shrinkWrap = false,\n  bool addAutomaticKeepAlives = true,\n  bool addRepaintBoundaries = true,\n  double cacheExtent,\n\n  //å­widgetåˆ—è¡¨\n  List<Widget> children = const <Widget>[],\n})\n```\nå…¬å…±å±æ€§æˆ‘ä»¬å°±ä¸è®²äº†ï¼Œä¸Šé¢`SingleChildScrollView`å·²ç»è®²è¿‡äº†ï¼Œæˆ‘ä»¬ç°åœ¨åªè®²ä»–ç‰¹æœ‰çš„ï¼š\n- `itemExtent`ï¼šç”¨äºæ§åˆ¶`ListView`çš„é•¿åº¦ï¼Œå¦‚æœä¸ä¸º`null`ï¼Œåˆ™å¼ºåˆ¶æ‰€æœ‰å­Widgetåˆèµ·æ¥çš„é•¿åº¦å°äºè®¾å®šçš„å€¼ï¼šå¦‚æœ`ListView`æ˜¯æ¨ªå‘çš„ï¼Œåˆ™æ‰€æœ‰å­Widgetæ¨ªå‘é•¿åº¦çš„å’Œå°äºå®ƒï¼›å¦‚æœ`ListView`æ˜¯çºµå‘çš„ï¼Œåˆ™æ‰€æœ‰å­Widgetçºµå‘é•¿åº¦çš„å’Œå°äºå®ƒï¼›\n- `shrinkWrap`ï¼šè¯¥å±æ€§è¡¨ç¤ºæ˜¯å¦æ ¹æ®å­ç»„ä»¶çš„æ€»é•¿åº¦æ¥è®¾ç½®`ListView`çš„é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º`false` ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ListView`çš„ä¼šåœ¨æ»šåŠ¨æ–¹å‘å°½å¯èƒ½å¤šçš„å ç”¨ç©ºé—´ã€‚å½“`ListView`åœ¨ä¸€ä¸ªæ— è¾¹ç•Œ(æ»šåŠ¨æ–¹å‘ä¸Š)çš„å®¹å™¨ä¸­æ—¶ï¼Œ`shrinkWrap`å¿…é¡»ä¸º`true`ï¼›\n- `addAutomaticKeepAlives`ï¼šè¯¥å±æ€§è¡¨ç¤ºæ˜¯å¦å°†åˆ—è¡¨é¡¹ï¼ˆå­ç»„ä»¶ï¼‰åŒ…è£¹åœ¨`AutomaticKeepAlive`ç»„ä»¶ä¸­ï¼›å…¸å‹åœ°ï¼Œåœ¨ä¸€ä¸ªæ‡’åŠ è½½åˆ—è¡¨ä¸­ï¼Œå¦‚æœå°†åˆ—è¡¨é¡¹åŒ…è£¹åœ¨`AutomaticKeepAlive`ä¸­ï¼Œåœ¨è¯¥åˆ—è¡¨é¡¹æ»‘å‡ºè§†å£æ—¶å®ƒä¹Ÿä¸ä¼šè¢«`GCï¼ˆåƒåœ¾å›æ”¶ï¼‰`ï¼Œå®ƒä¼šä½¿ç”¨`KeepAliveNotification`æ¥ä¿å­˜å…¶çŠ¶æ€ã€‚å¦‚æœåˆ—è¡¨é¡¹è‡ªå·±ç»´æŠ¤å…¶`KeepAlive`çŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤å‚æ•°å¿…é¡»ç½®ä¸º`false`ï¼›\n- `addRepaintBoundaries`ï¼šè¯¥å±æ€§è¡¨ç¤ºæ˜¯å¦å°†åˆ—è¡¨é¡¹ï¼ˆå­ç»„ä»¶ï¼‰åŒ…è£¹åœ¨`RepaintBoundary`ç»„ä»¶ä¸­ã€‚å½“å¯æ»šåŠ¨ç»„ä»¶æ»šåŠ¨æ—¶ï¼Œå°†åˆ—è¡¨é¡¹åŒ…è£¹åœ¨`RepaintBoundary`ä¸­å¯ä»¥é¿å…åˆ—è¡¨é¡¹é‡ç»˜ï¼Œä½†æ˜¯å½“åˆ—è¡¨é¡¹é‡ç»˜çš„å¼€é”€éå¸¸å°ï¼ˆå¦‚ä¸€ä¸ªé¢œè‰²å—ï¼Œæˆ–è€…ä¸€ä¸ªè¾ƒçŸ­çš„æ–‡æœ¬ï¼‰æ—¶ï¼Œä¸æ·»åŠ `RepaintBoundary`åè€Œä¼šæ›´é«˜æ•ˆã€‚å’Œ`addAutomaticKeepAlive`ä¸€æ ·ï¼Œå¦‚æœåˆ—è¡¨é¡¹è‡ªå·±ç»´æŠ¤å…¶`KeepAlive`çŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤å‚æ•°å¿…é¡»ç½®ä¸º`false`ï¼›\n- `cacheExtent`ï¼šè®¾å®šç¼“å­˜å¤§å°ã€‚\n\né»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªä¸€ä¸ªè®¾å®š`children`å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿ï¼ŒFlutterè¿˜æä¾›äº†ä¸€ä¸ª`builder`æ„é€ æ–¹æ³•ï¼š\n\n## ListView.builder\n```java\nListView.builder({\n  // ListViewå…¬å…±å‚æ•°å·²çœç•¥  \n  ...\n  @required IndexedWidgetBuilder itemBuilder,\n  int itemCount,\n  ...\n})\n```\n- `itemCount`ï¼šæ˜¯éœ€è¦åŠ è½½å­Widgetçš„é•¿åº¦ï¼›\n- `itemBuilder`ï¼šåˆ—è¡¨é¡¹çš„æ„é€ å™¨ï¼Œå½“åˆ—è¡¨æ»šåŠ¨åˆ°å…·ä½“çš„`index`ä½ç½®æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ„å»ºå™¨æ„å»ºåˆ—è¡¨é¡¹ã€‚\n\nçœ‹ä¾‹å­ï¼š\n```java\nListView.builder(\n  itemCount: _provinces.length,\n  itemBuilder: (context, index) {\n    return GestureDetector(\n      child: ListTile(\n        title: Text(\"$index\"),\n      ),\n      onTap: () {}));\n      },\n    );\n  },\n)\n```\n![ListViewBUilde](http://cdn.littlecorgi.top/mweb/2019-10-10/ListViewBUilder.png)\n\n\n## ListView.separated\nç”¨äºæ·»åŠ åˆ†å‰²çº¿ã€‚ç›¸è¾ƒäº`ListView.builder`å¤šäº†ä¸€ä¸ª`separatorBuilder`å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªåˆ†å‰²ç»„ä»¶ç”Ÿæˆå™¨ã€‚\n\nä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼šå¥‡æ•°è¡Œæ·»åŠ ä¸€æ¡è“è‰²ä¸‹åˆ’çº¿ï¼Œå¶æ•°è¡Œæ·»åŠ ä¸€æ¡ç»¿è‰²ä¸‹åˆ’çº¿ã€‚\n```java\nclass ListView3 extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    //ä¸‹åˆ’çº¿widgeté¢„å®šä¹‰ä»¥ä¾›å¤ç”¨ã€‚  \n    Widget divider1=Divider(color: Colors.blue,);\n    Widget divider2=Divider(color: Colors.green);\n    return ListView.separated(\n        itemCount: 100,\n        //åˆ—è¡¨é¡¹æ„é€ å™¨\n        itemBuilder: (BuildContext context, int index) {\n          return ListTile(title: Text(\"$index\"));\n        },\n        //åˆ†å‰²å™¨æ„é€ å™¨\n        separatorBuilder: (BuildContext context, int index) {\n          return index%2==0?divider1:divider2;\n        },\n    );\n  }\n}\n```\n![-w160](https://cdn.jsdelivr.net/gh/flutterchina/flutter-in-action/docs/imgs/6-3.png)\n\n# GridView\n`GridView`å¯ä»¥æ„é€ ä¸€ä¸ªç½‘æ ¼åˆ—è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹:\n```java\nGridView({\n  Axis scrollDirection = Axis.vertical,\n  bool reverse = false,\n  ScrollController controller,\n  bool primary,\n  ScrollPhysics physics,\n  bool shrinkWrap = false,\n  EdgeInsetsGeometry padding,\n  @required SliverGridDelegate gridDelegate, //æ§åˆ¶å­widget layoutçš„å§”æ‰˜\n  bool addAutomaticKeepAlives = true,\n  bool addRepaintBoundaries = true,\n  double cacheExtent,\n  List<Widget> children = const <Widget>[],\n})\n```\nå¤§éƒ¨åˆ†å‚æ•°å’Œ`ListView`éƒ½ç›¸åŒï¼Œæˆ‘ä»¬åªå…³æ³¨`gridDelegate`è¿™ä¸ªå‚æ•°ï¼š\n`gridDelegate`ä½œç”¨æ˜¯æ§åˆ¶`GridView`å­ç»„ä»¶å¦‚ä½•æ’åˆ—ï¼ŒFlutterä¸­æä¾›äº†ä¸¤ä¸ªç±»`SliverGridDelegateWithFixedCrossAxisCount`å’Œ`SliverGridDelegateWithMaxCrossAxisExtent`ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»ä¸€ä¸‹å®ƒä»¬ã€‚\n\n## SliverGridDelegateWithFixedCrossAxisCount\nè¯¥å­ç±»å®ç°äº†ä¸€ä¸ªæ¨ªè½´ä¸ºå›ºå®šæ•°é‡å­å…ƒç´ çš„layoutç®—æ³•ï¼Œå…¶æ„é€ å‡½æ•°ä¸ºï¼š\n```java\nSliverGridDelegateWithFixedCrossAxisCount({\n  @required double crossAxisCount, \n  double mainAxisSpacing = 0.0,\n  double crossAxisSpacing = 0.0,\n  double childAspectRatio = 1.0,\n})\n```\n- `crossAxisCount`ï¼šæ¨ªè½´å­å…ƒç´ çš„æ•°é‡ã€‚æ­¤å±æ€§å€¼ç¡®å®šåå­å…ƒç´ åœ¨æ¨ªè½´çš„é•¿åº¦å°±ç¡®å®šäº†ï¼Œå³`ViewPort`æ¨ªè½´é•¿åº¦é™¤ä»¥`crossAxisCount`çš„å•†ã€‚\n- `mainAxisSpacing`ï¼šä¸»è½´æ–¹å‘çš„é—´è·ã€‚\n- `crossAxisSpacing`ï¼šæ¨ªè½´æ–¹å‘å­å…ƒç´ çš„é—´è·ã€‚\n- `childAspectRatio`ï¼šå­å…ƒç´ åœ¨æ¨ªè½´é•¿åº¦å’Œä¸»è½´é•¿åº¦çš„æ¯”ä¾‹ã€‚ç”±äº`crossAxisCount`æŒ‡å®šåï¼Œå­å…ƒç´ æ¨ªè½´é•¿åº¦å°±ç¡®å®šäº†ï¼Œç„¶åé€šè¿‡æ­¤å‚æ•°å€¼å°±å¯ä»¥ç¡®å®šå­å…ƒç´ åœ¨ä¸»è½´çš„é•¿åº¦ã€‚\n\n## SliverGridDelegateWithMaxCrossAxisExtent\nè¯¥å­ç±»å®ç°äº†ä¸€ä¸ªæ¨ªè½´å­å…ƒç´ ä¸ºå›ºå®šæœ€å¤§é•¿åº¦çš„layoutç®—æ³•ï¼Œå…¶æ„é€ å‡½æ•°ä¸ºï¼š\n```java\nSliverGridDelegateWithMaxCrossAxisExtent({\n  double maxCrossAxisExtent,\n  double mainAxisSpacing = 0.0,\n  double crossAxisSpacing = 0.0,\n  double childAspectRatio = 1.0,\n})\n```\n`maxCrossAxisExtent`ä¸ºå­å…ƒç´ åœ¨æ¨ªè½´ä¸Šçš„æœ€å¤§é•¿åº¦ï¼Œä¹‹æ‰€ä»¥æ˜¯â€œæœ€å¤§â€é•¿åº¦ï¼Œæ˜¯å› ä¸ºæ¨ªè½´æ–¹å‘æ¯ä¸ªå­å…ƒç´ çš„é•¿åº¦ä»ç„¶æ˜¯ç­‰åˆ†çš„ã€‚å…¶å®ƒå‚æ•°å’Œ`SliverGridDelegateWithFixedCrossAxisCount`ç›¸åŒã€‚\n\n## GridView.builder\nå’Œ`ListView`ä¸€æ ·ï¼Œå½“å­Widgetæ•°é‡è¾ƒå¤šæ—¶ï¼Œä¹Ÿæä¾›äº†`builder`æ–¹æ³•:\n```java\nGridView.builder(\n ...\n @required SliverGridDelegate gridDelegate, \n @required IndexedWidgetBuilder itemBuilder,\n)\n```\n\nè¿™ä¸ªå°±ä¸åœ¨è¿™ä¸¾ä¾‹äº†ï¼Œ`gridDelegate`å’Œå‰é¢ä¸€æ ·çš„ï¼Œ`itemBuilder`å’Œ`ListView`çš„ä¸€æ ·çš„ã€‚","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(4)â€”â€”åŸºç¡€Widget","url":"/posts/a3b37eac.html","content":"åˆ°è¿™ç« æˆ‘ä»¬å°±å·®ä¸å¤šå¯ä»¥å¼€å§‹å†™å¤©æ°”é¢„æŠ¥äº†ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸€äº›åŸºç¡€ç®€å•çš„Widgetã€‚\n\n<!--More-->\n\n# åŸºç¡€ç»„ä»¶\n## æ–‡æœ¬\n`Text`ç”¨äºæ˜¾ç¤ºç®€å•çš„æ–‡æœ¬ï¼ŒåŒ…å«ä¸€äº›æ§åˆ¶æ–‡æœ¬æ˜¾ç¤ºçš„å±æ€§ã€‚\n```java\nText(\n    \"1234\",\n),\nText(\n    \"1234\",\n    style: TextStyle(\n        color: Colors.purple,\n        fontSize: 32.0,\n        fontWeight: FontWeight.bold,\n    ),\n),\n```\n![Textç¤ºä¾‹](http://cdn.littlecorgi.top/mweb/2019-10-10/Text%E7%A4%BA%E4%BE%8B.png)\n\n- éœ€è¦æ˜¾ç¤ºçš„æ–‡æœ¬ä¿¡æ¯ç›´æ¥æ”¾åˆ°ä¸€ä¸ªåŒå¼•å·é‡Œé¢å°±å¯ä»¥äº†ï¼›\n- `textAlign`ï¼šæ–‡æœ¬å¯¹é½æ–¹å¼ï¼›\n- `maxLines`ï¼šæ–‡æœ¬æ˜¾ç¤ºçš„æœ€å¤§è¡Œæ•°ï¼›\n- `overflow`ï¼šæŒ‡å®šå¤šä½™æ–‡æœ¬çš„æˆªæ–­æ–¹å¼ï¼›\n- `textScaleFactor`ï¼šæŒ‡å®šæ–‡æœ¬ç›¸å¯¹äºå½“å‰å­—ä½“å¤§å°çš„ç¼©æ”¾å› å­ï¼›\n- `TextStyle`ï¼šè®¾ç½®æ˜¾ç¤ºæ–‡æœ¬çš„å­—ä½“ã€é¢œè‰²ã€ç²—ç»†ç­‰æ ·å¼ï¼š\n    - `height`ï¼šæŒ‡å®šè¡Œé«˜ï¼Œä½†æ˜¯ä¸æ˜¯ç»å¯¹å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå› å­ï¼Œç›¸å½“äº`fontsize * height`ï¼›\n    - `fontFamily`ï¼šè®¾ç½®å­—ä½“ï¼›\n    - `fontSize`ï¼šè®¾ç½®å­—ä½“å¤§å°\n\n## æŒ‰é’®\nä¸åŒçš„ç»„ä»¶åº“æœ‰ä¸åŒçš„æŒ‰é’®ï¼Œæˆ‘ä»¬ç°åœ¨åªæ‹¿Materialç»„ä»¶åº“ä¸­çš„æŒ‰é’®ä¸¾ä¾‹ã€‚\n\n### RaisedButton\næ¼‚æµ®æŒ‰é’®ï¼Œå¸¦æœ‰é˜´å½±å’Œç°è‰²èƒŒæ™¯ã€‚æŒ‰ä¸‹åé˜´å½±ä¼šå˜å¤§ã€‚\n```java\nRaisedButton(\n  child: Text(\"1234\"),\n  onPressed: () {},\n);\n```\n<figure class=\"half\">\n    <img src=\"http://cdn.littlecorgi.top/mweb/2019-10-10/RaisedButton%E6%9C%AA%E6%8C%89%E4%B8%8B.png\">\n    <img src=\"http://cdn.littlecorgi.top/mweb/2019-10-10/RaisedButton%E6%8C%89%E4%B8%8B.png\">\n</figure>\n\n### FlatButton\næ‰å¹³åŒ–æŒ‰é’®ï¼ŒèƒŒæ™¯é€æ˜ä¸”ä¸å¸¦é˜´å½±ï¼ŒæŒ‰ä¸‹åä¼šæœ‰èƒŒæ™¯è‰²ã€‚\n```java\nFlatButton(\n  child: Text(\"1234\"),\n  onPressed: () {},\n)\n```\n<figure class=\"half\">\n    <img src=\"http://cdn.littlecorgi.top/mweb/2019-10-10/FlatButton%E6%9C%AA%E6%8C%89%E4%B8%8B.png\">\n    <img src=\"http://cdn.littlecorgi.top/mweb/2019-10-10/FlatButton%E6%8C%89%E4%B8%8B.png\">\n</figure>\n\n### IconButton\nå¯ç‚¹å‡»çš„Iconï¼Œé»˜è®¤æ²¡æœ‰èƒŒæ™¯ï¼ŒæŒ‰ä¸‹åå‡ºç°é˜´å½±\n```java\nIconButton(\n  icon: Icon(Icons.thumb_up),\n  onPressed: () {},\n)\n```\n![-w88](http://cdn.littlecorgi.top/mweb/2019-10-10/15706115387455.png)\n\n## å›¾ç‰‡\næˆ‘ä»¬é€šè¿‡`Image`æ¥æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ¥æºå¯ä»¥æ˜¯`asset`ã€ç½‘ç»œç­‰ä½ç½®ã€‚\n\n### ä»assetåŠ è½½å›¾ç‰‡\n1. ç°åœ¨é¡¹ç›®æ ¹ç›®å½•(ä¹Ÿå°±æ˜¯å’Œandroidã€iosã€libç­‰ç›®å½•åŒçº§)æ–°å»ºä¸€ä¸ª`images`ç›®å½•ï¼Œå¹¶æŠŠå›¾ç‰‡`main.png`æ‹·è¿›å»ï¼›\n2. åœ¨`pubspec.yaml`ä¸­çš„flutteréƒ¨åˆ†æ·»åŠ ä¸€ä¸‹å†…å®¹ï¼š\n    ![assets](http://cdn.littlecorgi.top/mweb/2019-10-10/assets.png)\n3. åŠ è½½è¯¥å›¾ç‰‡\n\n```java\nImage(\n  image: AssetImage(\"images/amoled.png\"),\n);\n```\n\n`Image`ä¹Ÿæä¾›äº†ä¸€ä¸ªå¿«é€Ÿæ„é€ å‡½æ•°ï¼š\n```java\nImage.asset(\n  \"images/amoled.png\",\n)\n```\n\n### ä»ç½‘ç»œåŠ è½½å›¾ç‰‡\n```java\nImage(\n  image: NetworkImage(\n      \"https://s2.ax1x.com/2019/05/27/VZrQ3V.png\"),\n)\n```\næˆ–è€…\n```java\nImage.network(\n  \"https://s2.ax1x.com/2019/05/27/VZrQ3V.png\",\n)\n```\n\n### å‚æ•°\n`Image`æœ‰ä¸€äº›åŸºæœ¬å‚æ•°\n```java\nconst Image({\n  ...\n  this.width, //å›¾ç‰‡çš„å®½\n  this.height, //å›¾ç‰‡é«˜åº¦\n  this.fit,//ç¼©æ”¾æ¨¡å¼\n  this.alignment = Alignment.center, //å¯¹é½æ–¹å¼\n  this.repeat = ImageRepeat.noRepeat, //é‡å¤æ–¹å¼\n  ...\n})\n```\n\n- `width`å’Œ`height`ï¼šå®½å’Œé«˜ï¼›\n- `fit`ï¼šç¼©æ”¾æ¨¡å¼ï¼š\n    - `fill`ï¼šæ‹‰ä¼¸å›¾ç‰‡çŸ¥é“å¡«æ»¡ï¼›\n    - `cover`ï¼šæŒ‰åŸå›¾é•¿å®½æ¯”æ”¾å¤§å›¾ç‰‡æ¥å¡«æ»¡ï¼Œå¤šä½™çš„éƒ¨åˆ†èˆå»ï¼›\n    - `contain`ï¼šåœ¨ä¿è¯å›¾ç‰‡é•¿å®½æ¯”ä¸å˜çš„æƒ…å†µä¸‹å°½å¯èƒ½å»å¡«æ»¡ï¼›\n    - `fitWidth`ï¼šå®½åº¦ä¼šç¼©æ”¾åˆ°æ˜¾ç¤ºç©ºé—´çš„å®½åº¦ï¼Œé«˜åº¦ä¼šæŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå¦‚æœæœ‰å¤šä½™çš„éƒ¨åˆ†ä¼šè¢«èˆå»ï¼›\n    - `fitHeight`ï¼šä¸`fitWidth`åŒç†ï¼›\n    - `none`ï¼šæ²¡æœ‰é€‚åº”ç­–ç•¥ï¼Œå›¾ç‰‡å¤šå¤§å°±æ˜¾ç¤ºå¤šå¤§ï¼Œå¦‚æœå›¾ç‰‡åŸå°ºå¯¸å°äºæ˜¾ç¤ºç©ºé—´å°±åªæ˜¾ç¤ºåŸå°ºå¯¸ï¼›å¦‚æœå¤§äºåˆ™èˆå¼ƒå¤šä½™éƒ¨åˆ†åªæ˜¾ç¤ºä¸­é—´éƒ¨åˆ†ï¼›\n- `repeat`ï¼šå½“å›¾ç‰‡å°äºæ˜¾ç¤ºç©ºé—´æ—¶ï¼Œä¼šå°†å›¾ç‰‡é‡å¤æ˜¾ç¤ºã€‚\n\n# å¸ƒå±€ç»„ä»¶\n## çº¿æ€§å¸ƒå±€(Rowã€Column)\nçº¿æ€§å¸ƒå±€å°±ç›¸å½“äºAndroidé‡Œé¢çš„`LinearLayout`ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯Flutterå°†ç«–ç›´å’Œæ°´å¹³å¸ƒå±€å•ç‹¬æ‹¿äº†å‡ºæ¥ã€‚\n\nçº¿æ€§å¸ƒå±€åˆ†ä¸ºç«–ç›´å¸ƒå±€`Column`å’Œæ°´å¹³å¸ƒå±€`Row`ã€‚ä»–ä¸¤å±æ€§éƒ½æ˜¯ä¸€æ ·çš„ã€‚\nå†è¯´å±æ€§ä¹‹å‰æˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸¤ä¸ªæ¦‚å¿µï¼šä¸»è½´å’Œäº¤å‰è½´ã€‚å¦‚æœæ˜¯`Column`ï¼Œä¸»è½´æ˜¯ç«–ç›´è½´ï¼Œäº¤å‰è½´æ˜¯æ°´å¹³è½´ï¼›å¦‚æœæ˜¯`Row`ï¼Œä¸»è½´æ˜¯æ°´å¹³è½´ï¼Œäº¤å‰è½´æ˜¯ç«–ç›´è½´ã€‚\n```java\nRow({\n  ...  \n  MainAxisSize mainAxisSize = MainAxisSize.max,    \n  MainAxisAlignment mainAxisAlignment = MainAxisAlignment.start,\n  CrossAxisAlignment crossAxisAlignment = CrossAxisAlignment.center,\n  List<Widget> children = const <Widget>[],\n})\n```\n\n- `mainAxisSize`ï¼šä¸»è½´å ç”¨ç©ºé—´ã€‚é»˜è®¤æ˜¯`MainAxisSize.max`ï¼Œæ˜¯æŒ‡å ç”¨å…¨éƒ¨ä¸»è½´ç©ºé—´ã€‚å¦‚æœè®¾ç½®ä¸º`MainAxisSize.min`ï¼Œé‚£å°±åªå ç”¨æ‰€æœ‰å­ç»„ä»¶æ‰€éœ€è¦çš„ç©ºé—´ï¼›\n- `mainAxisAlignment`ï¼šå­Widgetåœ¨ä¸»è½´çš„å¯¹å…¶æ–¹å‘ï¼›\n- `crossAxisAlignment`ï¼šå­Widgetåœ¨äº¤å‰è½´çš„å¯¹å…¶æ–¹å‘ï¼›\n- `children`ï¼šæ‰€æœ‰çš„å­Widgetã€‚\n\n## å¼¹æ€§å¸ƒå±€(Flex)\nå…¶å®è¿™ä¸ªå¸ƒå±€å’Œçº¿æ€§å¸ƒå±€å¾ˆæœ‰æ¸Šæºï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œå› ä¸º`Row`å’Œ`Column`éƒ½ç»§æ‰¿è‡ªå®ƒã€‚\nå› æ­¤å…³äºä»–å’Œçº¿æ€§å¸ƒå±€é‡å¤çš„åœ°æ–¹æˆ‘ä»¬ç°åœ¨å°±ä¸å†è®²äº†ï¼Œæˆ‘ä»¬ç›´è¯´ä»–â€œå¼¹æ€§â€çš„éƒ¨åˆ†ã€‚\n\n### Expanded\nå¯ä»¥æŒ‰æ¯”ä¾‹â€œæ‹‰ä¼¸â€`Row`ã€`Column`å’Œ`Flex`å­ç»„ä»¶æ‰€å çš„ç©ºé—´ã€‚\n\n```java\nconst Expanded({\n  int flex = 1, \n  @required Widget child,\n})\n```\n`flex`ä¸ºå¼¹æ€§ç³»æ•°ï¼Œå¦‚æœä¸º`0`æˆ–è€…`null`ï¼Œåˆ™`child`ä¸ä¼šé˜”ä¼¸å ç”¨çš„æ§ä»¶ã€‚å¦‚æœå¤§äº`0`ï¼Œåˆ™ä¼šæŒ‰ç…§`flex`çš„æ¯”ä¾‹æ¥åˆ†éš”ä¸»è½´å…¨éƒ¨ç©ºé—²ç©ºé—´ã€‚å…¶å®è¯´ç™½äº†ï¼Œå°±å’ŒAndroidé‡Œé¢`LinearLayout`çš„`weight`ä¸€æ ·çš„ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æ¥ä¸¾ä¸ªä¾‹å­å§ã€‚\n\n```java\nreturn Scaffold(\n      appBar: new AppBar(\n        title: Text(\"$_title\"),\n      ),\n      body: Center(\n        child: Flex(\n          children: <Widget>[\n            Flex(\n              direction: Axis.horizontal,\n              children: <Widget>[\n                Expanded(\n                  flex: 1,\n                  child: Container(\n                    color: Colors.blue,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n                Expanded(\n                  flex: 2,\n                  child: Container(\n                    color: Colors.red,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n              ],\n            ),\n            Flex(\n              direction: Axis.horizontal,\n              children: <Widget>[\n                Expanded(\n                  flex: 3,\n                  child: Container(\n                    color: Colors.blue,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n                Expanded(\n                  flex: 1,\n                  child: Container(\n                    color: Colors.red,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n              ],\n            ),\n            Flex(\n              direction: Axis.horizontal,\n              children: <Widget>[\n                Expanded(\n                  flex: 1,\n                  child: Container(\n                    color: Colors.blue,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n                Expanded(\n                  flex: 1,\n                  child: Container(\n                    color: Colors.red,\n                    child: Text(\"1234\"),\n                  ),\n                ),\n              ],\n            ),\n          ],\n          direction: Axis.vertical,\n        ),\n      ),\n);\n```\n![Flexç¤ºä¾‹](http://cdn.littlecorgi.top/mweb/2019-10-10/Flex%E7%A4%BA%E4%BE%8B.png)\n\n## æµå¼å¸ƒå±€(Wrapã€Flow)\nå¦‚æœä½¿ç”¨çº¿æ€§å¸ƒå±€çš„è¯ï¼Œå½“éœ€è¦æ˜¾ç¤ºçš„å†…å®¹è¶…å‡ºå±å¹•è¾¹ç•Œçš„æ—¶å€™å°±ä¼šæŠ¥é”™ã€‚\n![è¶…å‡ºå±å¹•è¾¹ç•Œ](http://cdn.littlecorgi.top/mweb/2019-10-10/%E8%B6%85%E5%87%BA%E5%B1%8F%E5%B9%95%E8%BE%B9%E7%95%8C.png)\n\nä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æµå¼å¸ƒå±€ã€‚å½“éœ€è¦æ˜¾ç¤ºçš„å†…å®¹è¶…å‡ºå±å¹•è¾¹ç•Œçš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨æŠ˜è¡Œæ¥ç»§ç»­æ˜¾ç¤ºã€‚\n\nFlutterä¸­é€šè¿‡`Wrap`å’Œ`Flow`æ¥å®ç°æµå¼å¸ƒå±€ã€‚\n\n### Wrap\næˆ‘ä»¬æ¥çœ‹ä¸‹`Wrap`ä¸»è¦çš„ä¸€äº›å‚æ•°ï¼š\n```java\nWrap({\n  ...\n  this.direction = Axis.horizontal,\n  this.alignment = WrapAlignment.start,\n  this.spacing = 0.0,\n  this.runAlignment = WrapAlignment.start,\n  this.runSpacing = 0.0,\n  this.crossAxisAlignment = WrapCrossAlignment.start,\n  this.textDirection,\n  this.verticalDirection = VerticalDirection.down,\n  List<Widget> children = const <Widget>[],\n})\n```\n\nå…¶ä¸­å¾ˆå¤šå‚æ•°`Row`å’Œ`Column`ä¸­éƒ½æœ‰ï¼Œå°±ä¸å†ä»‹ç»äº†ï¼Œä¸»è¦ä»‹ç»ç‚¹ä¸åŒçš„ï¼š\n- `spacing`ï¼šä¸»è½´æ–¹å‘å­widgetçš„é—´è·\n- `runSpacing`ï¼šçºµè½´æ–¹å‘çš„é—´è·\n- `runAlignment`ï¼šçºµè½´æ–¹å‘çš„å¯¹é½æ–¹å¼\n\nä¸‹é¢æœ‰ä¸€ä¸ªç¤ºä¾‹ï¼š\n```java\nWrap(\n  spacing: 8.0, // ä¸»è½´(æ°´å¹³)æ–¹å‘é—´è·\n  runSpacing: 4.0, // çºµè½´ï¼ˆå‚ç›´ï¼‰æ–¹å‘é—´è·\n  alignment: WrapAlignment.center, //æ²¿ä¸»è½´æ–¹å‘å±…ä¸­\n  children: <Widget>[\n    new Chip(\n      avatar: new CircleAvatar(backgroundColor: Colors.blue, child: Text('A')),\n      label: new Text('Hamilton'),\n    ),\n    new Chip(\n      avatar: new CircleAvatar(backgroundColor: Colors.blue, child: Text('M')),\n      label: new Text('Lafayette'),\n    ),\n    new Chip(\n      avatar: new CircleAvatar(backgroundColor: Colors.blue, child: Text('H')),\n      label: new Text('Mulligan'),\n    ),\n    new Chip(\n      avatar: new CircleAvatar(backgroundColor: Colors.blue, child: Text('J')),\n      label: new Text('Laurens'),\n    ),\n  ],\n)\n```\n![Wrapç¤ºä¾‹](http://cdn.littlecorgi.top/mweb/2019-10-10/Wrap%E7%A4%BA%E4%BE%8B.png)\n\n### Flow\n`Flow`è¾ƒå¤æ‚ï¼Œéœ€è¦è‡ªå·±å®ç°å­Widgetçš„ä½ç½®è½¬æ¢ï¼Œä¸€èˆ¬ä¸æ¨èä½¿ç”¨`Flow`ã€‚ä½†æ˜¯å¦‚æœéœ€è¦è‡ªå®šä¹‰å¸ƒå±€ç­–ç•¥ï¼Œæˆ–è€…å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾—ç”¨`Flow`äº†ã€‚\n\nä½†æ˜¯ç”±äºå¤ªè¿‡äºå¤æ‚ï¼Œæˆ‘ä¹Ÿæ²¡å’‹ç”¨è¿‡ï¼Œæˆ‘å°±ä¸åœ¨è¿™è®²äº†ğŸ˜ï¼Œå¤§å®¶æœ‰éœ€è¦çš„å¯ä»¥ç™¾åº¦ï¼Œæˆ–è€…çœ‹æˆ‘æ¨èçš„è¿™ç¯‡ï¼š[4.4 æµå¼å¸ƒå±€-ã€ŠFlutterå®æˆ˜ã€‹](https://book.flutterchina.club/chapter4/wrap_and_flow.html)\n\n## å±‚å å¸ƒå±€(Stack)\nè¿™ä¸ªå¸ƒå±€ç±»ä¼¼äºAndroidä¸­çš„`Frame`ï¼Œå…è®¸åœ¨çˆ¶å¸ƒå±€çš„ä»»æ„åœ°æ–¹æ”¾ç½®å¸ƒå±€ã€‚\n```java\nStack({\n  this.alignment = AlignmentDirectional.topStart,\n  this.textDirection,\n  this.fit = StackFit.loose,\n  this.overflow = Overflow.clip,\n  List<Widget> children = const <Widget>[],\n})\n```\n- `alignment`ï¼šå†³å®šå¦‚ä½•å»å¯¹é½ï¼›\n- `textDirection`ï¼šç¡®å®š`alignment`çš„å‚è€ƒç³»ï¼›\n- `fit`ï¼šæ²¡æœ‰å®šä½çš„å­Widgetå¦‚ä½•å»é€‚åº”`Stack`çš„å¤§å°ï¼›\n- `overflow`ï¼šå†³å®šè¶…å‡º`Stack`æ˜¾ç¤ºç©ºé—´çš„å­Widgetå¦‚ä½•å»æ˜¾ç¤ºï¼Œå¦‚æœ`Overflow.clip`ï¼Œåˆ™è¶…å‡ºéƒ¨åˆ†ä¼šéšè—ï¼Œ`Overflow.visible`åˆ™ä¸ä¼šã€‚\n\n## å¯¹é½ä¸ç›¸å¯¹å®šä½(Align)\n\nAlignå¯ä»¥è°ƒæ•´å­Widgetçš„ä½ç½®ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®å­Widgetçš„å®½é«˜æ¥ç¡®å®šè‡ªèº«çš„å®½é«˜ã€‚\n```java\nAlign({\n  Key key,\n  this.alignment = Alignment.center,\n  this.widthFactor,\n  this.heightFactor,\n  Widget child,\n})\n```\n- alignmentï¼šä»£è¡¨å­Widgetåœ¨çˆ¶Widgetçš„èµ·å§‹ä½ç½®ï¼›\n- widthFactorå’ŒheightFactorç¡®å®šAlignæœ¬èº«çš„å®½é«˜ã€‚\n\næ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š\n```java\nContainer(\n  height: 120.0,\n  width: 120.0,\n  color: Colors.blue[50],\n  child: Align(\n    alignment: Alignment.topRight,\n    child: FlutterLogo(\n      size: 60,\n    ),\n  ),\n)\n```\nè¿è¡Œç»“æœï¼š\n![-w100](http://cdn.littlecorgi.top/mweb/2019-10-10/15706312811307.png)\n\n# 3. å®¹å™¨ç±»ç»„ä»¶\n## å¡«å……(Padding)\nç”¨è¿‡Androidçš„åŒå­¦ä¸€å®šç†Ÿæ‚‰ï¼ŒPaddingå°±æ˜¯è´Ÿè´£ç•™ç™½çš„å˜›ã€‚\nä½†æ˜¯è·ŸAndroidé‡Œé¢ä¸åŒçš„æ˜¯ï¼Œåœ¨Androidé‡Œé¢æˆ‘ä»¬ä¸€èˆ¬æ˜¯åœ¨ä¸€ä¸ªViewé‡Œé¢æ·»åŠ Paddingï¼Œä½†æ˜¯åœ¨Flutteré‡Œé¢ï¼ŒPaddingç›´æ¥å˜æˆäº†ä¸€ä¸ªWidgetã€ä¸€ä¸ªå¸ƒå±€ã€‚\n\nä½¿ç”¨æ–¹æ³•ï¼š\n```java\nPadding ({\n  EdgeInsetsGeometry padding,\n  Widget child,\n})\n```\nå¯¹äºEdgeInsetsGeometryæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨EdgeInsetsç±»ã€‚\n\n### EdgeInsets\nEdgeInsetsç±»æä¾›äº†å‡ ä¸ªä¾¿æ·çš„æ–¹æ³•ï¼š\n- fromLTRB(double left, double top, double right, double bottom)ï¼šåˆ†åˆ«æŒ‡å®šå››ä¸ªæ–¹å‘çš„å¡«å……ï¼›\n- all(double value) : æ‰€æœ‰æ–¹å‘å‡ä½¿ç”¨ç›¸åŒæ•°å€¼çš„å¡«å……ï¼›\n- only({left, top, right ,bottom })ï¼šå¯ä»¥è®¾ç½®å…·ä½“æŸä¸ªæ–¹å‘çš„å¡«å……(å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæ–¹å‘)ï¼›\n- symmetric({ vertical, horizontal })ï¼šç”¨äºè®¾ç½®å¯¹ç§°æ–¹å‘çš„å¡«å……ï¼ŒverticalæŒ‡topå’Œbottomï¼ŒhorizontalæŒ‡leftå’Œrightï¼›\n\nç¤ºä¾‹ï¼š\n```java\nbody: Column(\n  children: <Widget>[\n    Padding(\n      padding: EdgeInsets.only(left: 12.0, bottom: 10.0),\n      child: Text(\"1234\"),\n    ),\n    Padding(\n      padding: EdgeInsets.fromLTRB(0.0, 0.0, 10.0, 10.0),\n      child: Text(\"1234\"),\n    ),\n    Padding(\n      padding: EdgeInsets.symmetric(vertical: 10.0),\n      child: Text(\"1234\"),\n    ),\n  ],\n),\n```\nè¿è¡Œç»“æœï¼š\n![Paddingç¤ºä¾‹](http://cdn.littlecorgi.top/mweb/2019-10-10/Padding%E7%A4%BA%E4%BE%8B.png)","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(3)â€”â€”Widget","url":"/posts/fc77cdce.html","content":"\n# ç®€ä»‹\nåœ¨Flutterä¸­ï¼ŒWidgetæ˜¯ä¸ªéå¸¸åŸºæœ¬çš„ä¸œè¥¿ï¼Œæˆ‘åœ¨ä¸Šä¸€ç« å°±è¯´è¿‡ï¼ŒFlutterä¸­åªè¦æ˜¯ç•Œé¢éƒ½æ˜¯Widgetï¼Œä½ å¯ä»¥æŠŠå®ƒå°±ç†è§£æˆæ˜¯æ§ä»¶ï¼Œä½†æ˜¯åˆå’ŒAndroidçš„Viewæ§ä»¶ä¸åŒçš„æ˜¯ï¼Œåœ¨Flutterä¸­ï¼ŒåŒ…æ‹¬`Padding`ã€`Align`ã€æ‰‹åŠ¿æ£€æµ‹çš„`GestureDetector`ç­‰ç­‰ï¼Œéƒ½ç®—æ˜¯`Widget`ã€‚\n\nå…¶å®å¤§å¤šæ•°æ—¶å€™ï¼Œä½ å°±å¯ä»¥æŠŠWidgetç›´æ¥ç†è§£æˆUIæ§ä»¶å°±è¡Œäº†ï¼Œå› ä¸º`Padding`ã€`Align`ã€`GestureDetector`ç­‰ç­‰ä¹Ÿéƒ½æ˜¯ä¸ºUIæœåŠ¡çš„ï¼Œä½ å°±å¯ä»¥ç†è§£æˆFlutterä¸­åªè¦ä¸UIæœ‰å…³çš„å±æ€§éƒ½å¯ä»¥ç®—æ˜¯æ§ä»¶ã€‚\n\n<!--More-->\n\n# Widgetçš„çŠ¶æ€\nåœ¨Androidä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡æ›´æ–°æ•°æ®æ¥è¾¾åˆ°åˆ·æ–°UIçš„ç›®çš„ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨Flutterï¼Œå°±åƒæˆ‘ä»¬å‰é¢è¯´çš„è®¡æ•°å™¨çš„Demoï¼Œå¦‚æœç›´æ¥é€šè¿‡`StatelessWidget`ä¹Ÿå°±æ˜¯æ— çŠ¶æ€Widgetçš„è¯ï¼Œæ˜¯æ²¡æ³•è¿›è¡Œåˆ·æ–°UIçš„ï¼Œåªèƒ½å†™ä¸€ä¸ªæ­»ç•Œé¢ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœåœ¨Flutterä¸­ç•Œé¢å†™å‡ºæ¥çš„å°±æ˜¯ä¸€ä¸ªæ­»ç•Œé¢ï¼Œåªæœ‰é€šè¿‡åˆ·æ–°çŠ¶æ€æ‰èƒ½æ›´æ–°UIã€‚\n\nWidgetæœ‰ä¸¤ä¸ªç›´æ¥å­ç±»ï¼š`StatelessWidget`å’Œ`StatefulWidget`ï¼š\n- `StatelessWidget`ï¼šè¿™ä¸ªæ˜¯æ— çŠ¶æ€Widgetï¼Œå®ç°`build()`æ–¹æ³•åï¼Œå°±ä¸å¯å†å˜åŒ–ï¼Œå“ªæ€•ä»–çš„çŠ¶æ€æ”¹å˜äº†ã€‚è¿™å¥è¯å¯èƒ½æœ‰ç‚¹çŸ›ç›¾ï¼Œä½†æ˜¯æˆ‘æ¥ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”æ–¹è¯´ç°åœ¨æœ‰ä¸€ä¸ª`StatelessWidget`ï¼Œä»–çš„å†…å®¹å°±æ˜¯ä¸€ä¸ª`Text`ï¼Œè€Œè¿™ä¸ª`Text`çš„å†…å®¹åˆ™æ˜¾ç¤ºäº†`counter`è¿™ä¸ªå˜é‡ã€‚å½“è¿™ä¸ªé¡µé¢å‡ºç°çš„æ—¶å€™ï¼Œå–äº†å½“æ—¶`counter`çš„å€¼å¹¶æ˜¾ç¤ºäº†å‡ºæ¥ï¼Œä½†æ˜¯æˆ‘ä»¬åç»­ä¸ç®¡`counter`è¿™ä¸ªå€¼æ€ä¹ˆæ”¹å˜ï¼Œç•Œé¢éƒ½æ˜¯ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥çš„ã€‚\n- `StatefulWidget`ï¼šè¿™ä¸ªæ˜¯æœ‰çŠ¶æ€Widgetï¼Œå½“ä½ æœ‰çŠ¶æ€éœ€è¦æ”¹å˜çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡ä»–æ¥æ”¹å˜çŠ¶æ€ã€‚\n\nStateçš„å‡ ç§çŠ¶æ€ï¼š\n\n|åç§°|çŠ¶æ€|\n|:-:|:-:|\n|initState|createä¹‹åè¢«insertåˆ°æ¸²æŸ“æ ‘æ—¶è°ƒç”¨çš„ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡|\n|didChangeDependencies|stateä¾èµ–çš„å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶è°ƒç”¨|\n|didUpdateWidget|WidgetçŠ¶æ€æ”¹å˜æ—¶å€™è°ƒç”¨ï¼Œå¯èƒ½ä¼šè°ƒç”¨å¤šæ¬¡|\n|build|æ„å»ºWidgetæ—¶è°ƒç”¨|\n|deactivate|å½“ç§»é™¤æ¸²æŸ“æ ‘çš„æ—¶è°ƒç”¨|\n|dispose|Widgetå³å°†é”€æ¯æ—¶è°ƒç”¨|\n\n# StatelessWidget\nè¿™ä¸ªç±»ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦å®ç°`build()`æ–¹æ³•å°±å¯ä»¥äº†ã€‚\n\n`StatelessWidget`ç”¨äºä¸éœ€è¦ç»´æŠ¤çŠ¶æ€çš„åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä»–éœ€è¦æ˜¾ç¤ºçš„æŸä¸€ä¸ªå‚æ•°çš„å€¼å‘ç”Ÿå˜åŒ–äº†ä»–ä¹Ÿä¸å˜ã€‚\n\n```java\nclass Test extends StatelessWidget {\n  Test({Key key, this.title}) : super(key: key);\n\n  final String title;\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: new AppBar(\n        title: Text(\"$title\"),\n      ),\n      body: Text(\"1234\"),\n    );\n  }\n}\n```\nä¸Šé¢ä»£ç å°±æ¼”ç¤ºäº†ä¸€ä¸ª`StatelessWidget`çš„ä¾‹å­ï¼ŒåŠŸèƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„`title`åœ¨ç•Œé¢çš„`title`äº†ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚åªå®ç°äº†`build()`æ–¹æ³•å’Œæ„é€ æ–¹æ³•ã€‚å…¶ä¸­æ„é€ æ–¹æ³•å‚æ•°`Key`æ˜¯å¿…é¡»å¾—æœ‰çš„ï¼Œè€Œä¸”å¦‚æœè¯¥Widgetè¿˜æœ‰å…¶ä»–çŠ¶æ€çš„è¯ï¼Œä¹Ÿéœ€è¦å†™å…¥æ„é€ æ–¹æ³•ã€‚æ¥ç€è°ƒç”¨`build()`æ–¹æ³•ï¼Œå°†ä¼ å…¥çš„`title`åœ¨ç•Œé¢çš„`title`ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚\n\nä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨å®ƒï¼š\n```java\n@override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ),\n      home: Test(title: 'Flutter Demo Home Page'),\n    );\n  }\n```\nç»“æœæ˜¯ï¼š\n![Screenshot_20191009-112644](http://cdn.littlecorgi.top/mweb/2019-10-09/Screenshot_20191009-112644.jpg)\n\n# StatefulWidget\nä¸`StatelessWidget`ç›¸å¯¹çš„å°±æ˜¯`StatefulWidget`ã€‚å®ƒçš„é‡ç‚¹åœ¨äºå¯ä»¥æ ¹æ®çŠ¶æ€æ¥æ›´æ–°ã€‚\n\nä»–è¾ƒäº`StatelessWidget`ï¼Œå°‘äº†æˆ‘ä»¬å¸¸ç”¨çš„`build()`æ–¹æ³•ï¼Œå¤šäº†`createState()`æ–¹æ³•ã€‚ä¸‹é¢æˆ‘å°±æ¥è®²ä¸€ä¸‹ä»–çš„ç”¨æ³•ï¼Œæˆ‘è¿˜æ˜¯æ‹¿ä¸Šé¢çš„`Test`åšä¾‹å­ã€‚\n\n```java\nclass Test extends StatefulWidget {\n  Test({Key key, this.title}) : super(key: key);\n\n  final String title;\n\n  @override\n  _TestState createState() => _TestState();\n}\n\nclass _TestState extends State<Test> {\n  String _title;\n\n  @override\n  void initState() {\n    setState(() {\n      _title = widget.title;\n    });\n    super.initState();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: new AppBar(\n        title: Text(\"$_title\"),\n      ),\n      body: Text(\"1234\"),\n    );\n  }\n}\n```\nå…ˆçœ‹`Test`ç±»ï¼Œä»–ç»§æ‰¿è‡ª`StatefulWidget`ï¼Œç”±äºè¿™ä¸ªé¡µé¢éœ€è¦æ ¹æ®ä¼ å…¥çš„å‚æ•°æ¥æ˜¾ç¤º`title`ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªçŠ¶æ€`title`ï¼Œå¹¶åœ¨æ„é€ æ–¹æ³•ä¸­å†™å…¥äº†ä»–ã€‚æ¥ç€è°ƒç”¨äº†`createState()`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰`StatefulWidget`å¿…é¡»çš„ï¼Œä¸»è¦æ˜¯ä¸ºè¿™ä¸ªWidgetåˆ›å»ºä»–å¯¹åº”çš„Stateã€‚\n\näºæ˜¯æˆ‘ä»¬å°±åœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ï¼Œç±»åå«`_TestState`ï¼Œç»§æ‰¿è‡ª`State<Test>`ã€‚ç”±äºWidgetæœ‰`title`è¿™ä¸ªçŠ¶æ€ï¼Œå¹¶ä¸”éœ€è¦åœ¨ç•Œé¢ä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥ä¸ºäº†é™ä½ä»–ä»¬çš„è€¦åˆåº¦ï¼Œæˆ‘ä»¬åœ¨Stateç±»ä¸­ä¹Ÿåˆ›å»ºä¸€ä¸ªå«`_title`çš„çŠ¶æ€ï¼Œå¹¶`_title = widget.title;`ã€‚\næ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª`initState()`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯Stateå¿…é¡»çš„ï¼Œåœ¨ä¸Šé¢Widgetçš„çŠ¶æ€ä¸­æˆ‘ä»¬è®²åˆ°è¿‡ï¼Œè¿™ä¸ªæ˜¯åˆå§‹åŒ–Stateçš„ï¼ŒåŒæ—¶åœ¨`initSate()`é‡Œé¢ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª`setState()`ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å‘Šè¯‰Flutterè¯´è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å‚æ•°æ”¹å˜äº†æ¥ç€Widgetçš„çŠ¶æ€ä¹Ÿå¾—æ”¹å˜ã€‚æœ€åå°±æ˜¯`build()`æ–¹æ³•ã€‚\n\næ¥ä¸‹æ¥æˆ‘ä»¬è°ƒç”¨å®ƒï¼š\n```java\n@override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ),\n      home: Test(title: '1234'),\n    );\n  }\n```\nç»“æœæ˜¯ï¼š\n![Screenshot_20191009-114316](http://cdn.littlecorgi.top/mweb/2019-10-09/Screenshot_20191009-114316.jpg)\n","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(2)â€”â€”Flutterè®¡æ•°å™¨Demo","url":"/posts/956d1e66.html","content":"\næœ¬æ–‡æ ·ä¾‹éƒ½æ˜¯ä½¿ç”¨çš„AndroidStudioï¼Œå¦‚æœä½ ä½¿ç”¨Xcodeæˆ–è€…vscodeï¼Œä»£ç éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯IDEåˆ›å»ºé¡¹ç›®çš„æ–¹å¼ä»¥åŠè¿è¡ŒæŒ‰é”®ä½ç½®ä¸åŒè€Œå·²ã€‚\n\n<!-- More -->\n\n# åˆ›å»ºFlutteré¡¹ç›®\nAndroidStudioä¸­é€‰æ‹©`File`->`New`->`New Flutter Project`->`Flutter Application`->`NEXT`ã€‚æ¥ç€å¡«å†™ä½ çš„é¡¹ç›®åç§°ç­‰ä¸€ç³»åˆ—ä¿¡æ¯åå°±åˆ›å»ºæˆåŠŸäº†ï¼Œæˆ‘ä»¬å°±ä¼šçœ‹åˆ°AndroidStudioå·²ç»ä¸ºæˆ‘ä»¬åˆ›å»ºå¥½äº†ä¸€ä¸ªDemoï¼Œæ¥ç€è¿ä¸Šä½ çš„æ‰‹æœºæˆ–è€…æ‰“å¼€ä½ çš„è™šæ‹Ÿæœºï¼ŒæŒ‰ä¸‹AndroidStudioçš„è¿è¡Œé”®ï¼Œä¸ä¸€ä¼šå„¿ï¼Œä½ å°±ä¼šæƒŠå–œçš„å‘ç°ä½ çš„æ‰‹æœºä¸Šå°±æœ‰ä¸€ä¸ªFlutterè®¡æ•°å™¨Demoäº†ã€‚\n![è®¡æ•°å™¨è¿è¡ŒDemo](http://cdn.littlecorgi.top/mweb/2019-10-09/%E8%AE%A1%E6%95%B0%E5%99%A8%E8%BF%90%E8%A1%8CDemo.png)\n\n# ä»‹ç»ä¸‹AndroidStudioç•Œé¢\n![AndroidStudioç•Œé¢](http://cdn.littlecorgi.top/mweb/2019-10-09/AndroidStudio%E7%95%8C%E9%9D%A2.png)\nè¿™æ˜¯æˆ‘çš„AndroidStudioç•Œé¢ï¼Œæ¥ä¸‹æ¥æˆ‘åˆ†ä¸‰ä¸ªéƒ¨åˆ†ä»‹ç»ä¸‹AndroidStudioçš„å¤§è‡´ç•Œé¢ã€‚\n\n## æ§åˆ¶åŒº\n![æ§åˆ¶åŒº](http://cdn.littlecorgi.top/mweb/2019-10-09/%E6%8E%A7%E5%88%B6%E5%8C%BA.png)\n\nä¸€æ¬¡ä»‹ç»æ¯ä¸€ä¸ªæŒ‰é’®çš„åŠŸèƒ½ã€‚\n1. ç¬¬ä¸€ä¸ªæ˜¯ç”¨æ¥é€‰æ‹©è¿è¡Œè®¾å¤‡çš„ï¼Œæ¯”æ–¹è¯´æˆ‘ç°åœ¨å°±é€‰çš„æ˜¯æˆ‘çš„è™šæ‹Ÿæœºï¼Œç„¶åæˆ‘æŒ‰ä¸‹è¿è¡Œåå°±å¯ä»¥å°†é¡¹ç›®è¿è¡Œåˆ°æˆ‘çš„è™šæ‹Ÿæœºä¸Šè€Œä¸ä¼šè¿è¡Œåˆ°è¿ç€æˆ‘çš„ç”µè„‘çš„æ‰‹æœºä¸Šå»ï¼›\n2. ç¬¬äºŒä¸ªæ˜¯é€‰æ‹©è¿è¡Œå“ªä¸ªFlutter moduleï¼Œå¦‚æœä½ åŒä¸€ä¸ªé¡¹ç›®é‡Œé¢æœ‰å¤šä¸ªmoduleï¼Œä½ å°±å¯ä»¥åœ¨æ­¤é€‰æ‹©ä½ æƒ³è¦è¿è¡Œçš„moduleï¼›\n3. ç¬¬ä¸‰ä¸ªç°è‰²çš„é€‰é¡¹æ¡†æˆ‘ä¹Ÿæ²¡å¼„æ‡‚å¥¹æ˜¯å¹²å˜›çš„ï¼Œæˆ‘è‡³ä»Šéƒ½æ²¡èƒ½é€‰æ‹©è¿‡ï¼Œä¸€ç›´éƒ½æ˜¯ç°çš„ï¼›\n4. ç»¿è‰²çš„ä¸‰è§’å½¢ï¼Œå¤§å®¶ç†ŸçŸ¥ï¼Œè¿è¡Œé”®ï¼›\n5. çº¢è‰²çš„ç“¢è™«ï¼Œå¤§å®¶ç†ŸçŸ¥ï¼Œdebugé”®ï¼›\n6. ä¸çŸ¥é“å¹²å˜›çš„ï¼›\n7. FlutterAPPçš„æ€§èƒ½ç›‘è§†å™¨ï¼›\n8. é—ªç”µï¼Œè¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œä¹Ÿæ˜¯Flutterçš„ä¸€å¤§ç‰¹æ€§ï¼Œçƒ­é‡è½½é”®ï¼Œä»–èƒ½åšåˆ°ä¸éœ€è¦é‡æ–°ç¼–è¯‘ä»£ç å°±èƒ½å°†ä½ ä¿®æ”¹çš„ä»£ç çš„æ•ˆæœåœ¨ä½ çš„APPä¸Šæ˜¾ç¤ºå‡ºæ¥ï¼›\n9. ä¸çŸ¥é“å¹²å˜›çš„ï¼›\n10. çº¢è‰²çš„æ­£æ–¹å½¢ï¼Œåœæ­¢è¿è¡ŒæŒ‰é’®ã€‚\n\n## Runè¿è¡ŒåŒº\n![Runè¿è¡ŒåŒº](http://cdn.littlecorgi.top/mweb/2019-10-09/Run%E8%BF%90%E8%A1%8C%E5%8C%BA.png)\nå°±æ˜¯Flutterçš„ä¿¡æ¯æ˜¾ç¤ºåŒºï¼Œç±»ä¼¼äºAndroidStudioçš„Logcatï¼Œèƒ½æ˜¾ç¤ºFlutterAPPè¿è¡Œä¸­çš„ä¸€äº›ä¿¡æ¯ã€‚\n\n## Flutter Outline/Flutter InspectoråŒº\n![Flutter Outline](http://cdn.littlecorgi.top/mweb/2019-10-09/Flutter%20Outline.png)\n![Flutter Inspecto](http://cdn.littlecorgi.top/mweb/2019-10-09/Flutter%20Inspector.png)\nç”¨äºæ˜¾ç¤ºå½“å‰ç•Œé¢çš„ä¸€äº›æ„å»ºä¿¡æ¯ã€‚\n\n# Flutteré¡¹ç›®ç»“æ„\n![Flutteré¡¹ç›®ç»“æ„](http://cdn.littlecorgi.top/mweb/2019-10-09/Flutter%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png)\n\næˆ‘ä»¬æŒ‘ä¸€äº›é‡è¦çš„è¯´ä¸€ä¸‹ï¼š\n1. .ideaæ–‡ä»¶å¤¹ï¼ŒAndroidStudioè¯†åˆ«é¡¹ç›®çš„å¿…å¤‡æ–‡ä»¶å¤¹ï¼Œä¸ç”¨ç®¡ï¼›\n2. Androidæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾Flutteræ„å»ºçš„Androidé¡¹ç›®çš„æ–‡ä»¶å¤¹ï¼›\n3. iosæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾Flutteræ„å»ºçš„iOSé¡¹ç›®çš„æ–‡ä»¶å¤¹ï¼›\n4. libæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾Flutteré¡¹ç›®å’Œèµ„æºçš„æ–‡ä»¶å¤¹ï¼›\n5. pubspec.yamlæ–‡ä»¶ï¼Œå­˜æ”¾Flutteré¡¹ç›®ç›¸å…³ä¿¡æ¯ï¼Œå¦‚é¡¹ç›®åç§°ã€ç‰ˆæœ¬ã€ä¾èµ–ç­‰ç­‰ï¼Œç±»ä¼¼äºAndroidé¡¹ç›®çš„build.gradleæ–‡ä»¶ã€‚\n\n# main.dartæ–‡ä»¶\næˆ‘ä»¬é€šè¿‡è®²è¿™ä¸ªæ–‡ä»¶æ¥ç»™å¤§å®¶å¤§è‡´ä»‹ç»ä¸‹Flutteré¡¹ç›®ä»£ç ç»“æ„ã€‚\n\nå…¨éƒ¨æºä»£ç åœ¨æ­¤\n```dart\nimport 'package:flutter/material.dart';\n\nvoid main() => runApp(MyApp());\n\nclass MyApp extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ),\n      home: MyHomePage(title: 'Flutter Demo Home Page'),\n    );\n  }\n}\n\nclass MyHomePage extends StatefulWidget {\n  MyHomePage({Key key, this.title}) : super(key: key);\n  final String title;\n\n  @override\n  _MyHomePageState createState() => _MyHomePageState();\n}\n\nclass _MyHomePageState extends State<MyHomePage> {\n  int _counter = 0;\n\n  void _incrementCounter() {\n    setState(() {\n      _counter++;\n    });\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(widget.title),\n      ),\n      body: Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: <Widget>[\n            Text(\n              'You have pushed the button this many times:',\n            ),\n            Text(\n              '$_counter',\n              style: Theme.of(context).textTheme.display1,\n            ),\n          ],\n        ),\n      ),\n      floatingActionButton: FloatingActionButton(\n        onPressed: _incrementCounter,\n        tooltip: 'Increment',\n        child: Icon(Icons.add),\n      ),\n    );\n  }\n}\n\n```\n\n## import\né¦–å…ˆæˆ‘ä»¬çœ‹æœ€å¼€å§‹çš„`import`åŒºã€‚\n\nè¿™å—ç›¸å½“äºC/C++çš„`include`ï¼Œåè€Œä¸åƒjavaçš„`import`ã€‚æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œä½ æƒ³ä¸€ä¸‹ï¼Œä½ å†™javaç¨‹åºçš„æ—¶å€™ï¼Œä½ æ˜¯éœ€è¦å“ªä¸ªç±»å°±ç›´æ¥åœ¨ä»£ç ä¸­è¾“å…¥ç±»åï¼Œç„¶åIDEä¼šè‡ªåŠ¨ç»™ä½ æ˜¾ç¤ºæœ‰è¿™ä¸ªç±»çš„æ‰€æœ‰çš„åŒ…ï¼Œç„¶åè®©ä½ é€‰åŒ…å»å¯¼å…¥ï¼›è€Œå†™dartæ˜¯éœ€è¦ä½ å…ˆå¯¼å…¥åŒ…ï¼Œæ‰èƒ½åœ¨ä»£ç ä¸­å†™è¿™ä¸ªåŒ…ä¸­çš„ç±»ï¼Œå¦‚æœä½ æ²¡æœ‰å…ˆå¯¼å…¥åŒ…è€Œç›´æ¥åˆ°ä¸‹é¢å†™çš„è¯ï¼ŒIDEæ˜¯ä¸ä¼šæç¤ºä½ è¿™ä¸ªç±»å¯èƒ½ä¼šåœ¨å“ªä¸ªåŒ…ä¸­ï¼Œè€Œæ˜¯ç›´æ¥æŠ¥é”™ï¼Œè¿™ç‚¹å’ŒC/C++æ¯”è¾ƒç±»ä¼¼ã€‚\n\né‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆå¯¼å…¥çš„æ˜¯`flutter/material.dart`è¿™ä¸ªåŒ…å‘¢ï¼Ÿæˆ‘åœ¨ç¬¬ä¸€èŠ‚é‡Œé¢è¯´è¿‡ï¼ŒFlutterä»–å†…ç½®äº†Androidçš„Material Designé£æ ¼å’ŒiOSçš„Cupertinoé£æ ¼çš„UIï¼›æ‰€ä»¥è¿™å—å°±æ˜¯å¯¼å…¥Material Designé£æ ¼UIæ–‡ä»¶ï¼Œè€Œå¦‚æœä½ è¦ä½¿ç”¨Cupertinoé£æ ¼UIæ–‡ä»¶çš„è¯ï¼ŒæŠŠå®ƒæ”¹æˆCupertinoå°±è¡Œäº†ã€‚\n\n## main()\n```dart\nvoid main() => runApp(MyApp());\n\nclass MyApp extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ), \n      home: MyHomePage(title: 'Flutter Demo Home Page'),\n    );\n  }\n}\n```\n- ç¬¬ä¸€è¡Œï¼ŒæŒ‡æ˜é¡¹ç›®çš„å…¥å£å°±æ˜¯`MyApp()`ã€‚å›ºå®šæ ¼å¼ï¼Œå¯ä»¥ä¸ç”¨ç®¡ã€‚\n\n- ç¬¬äºŒè¡Œå°±å®šä¹‰äº†ä¸€ä¸ªç±»`MyApp`ç»§æ‰¿è‡ª`StatelessWidget`ï¼Œå¹¶é‡å†™äº†çˆ¶ç±»çš„`build()`æ–¹æ³•ã€‚`Widget`å¯ä»¥çœ‹æˆFlutterä¸­çš„é¡µé¢ï¼Œåªè¦æ˜¯Flutterä¸­çš„é¡µé¢ï¼Œéƒ½å¿…é¡»ç»§æ‰¿è‡ª`Widget`ã€‚ä»–æœ‰ç‚¹ç±»ä¼¼äºAndroidä¸­çš„`View`ï¼Œä½†æ˜¯ä¸åŒäº`View`çš„æ˜¯ï¼ŒFlutterä¸­çš„`padding`ã€`align`ã€`layout`ç­‰å±…ç„¶ä¹Ÿæ˜¯`Widget`ã€‚\n\n- å¦‚æœæ˜¯`StatelessWidget`ï¼Œåˆ™ä»£è¡¨å¥¹æ˜¯ä¸€ä¸ªâ€œçŠ¶æ€å°‘â€çš„`Widget`ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯çŠ¶æ€ç›¸å½“äº`Widget`çš„ä¸€äº›æ•°å€¼ï¼Œæ¯”æ–¹è¯´é¡µé¢è¦æ˜¾ç¤ºè®¡æ•°å™¨çš„è®¡æ•°`count`ï¼Œé‚£ä¹ˆè¿™ä¸ª`count`å°±æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œåªè¦æœ‰çŠ¶æ€å°±ä½¿ç”¨`StatefulWidget`ã€‚åƒ`MyApp`å®ƒæ²¡æœ‰çŠ¶æ€ï¼Œäºæ˜¯å°±ç”¨`StatelessWidget`ã€‚\n\n- ç»§æ‰¿è‡ª`StatelessWidget`çš„ç±»å¿…é¡»å®ç°`build()`æ–¹æ³•ï¼Œç›¸å½“äºè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ­»é¡µé¢ï¼Œåªéœ€è¦å±•ç¤ºå›ºå®šçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦çŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡`build()`ç›´æ¥å†™å…¥ç•Œé¢å°±è¡Œã€‚\n\n- `build()`æ–¹æ³•å¿…é¡»åŒæ ·è¿”å›ä¸€ä¸ª`Widget`ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä½¿ç”¨`MaterialApp`ï¼Œå…¶ä¸­æˆ‘ä»¬ç»™ä»–çš„`title`ã€`theme`ã€`home`è¿›è¡Œäº†èµ‹å€¼ï¼ŒåŒå­¦ä»¬åº”è¯¥éƒ½èƒ½å¤§è‡´è¯»æ‡‚å•¥æ„æ€ï¼Œé¦–é¡µ`home`åˆ™ç»™äº†`MyHomePage`.\n\n## MyHomePage\n```dart\nclass MyHomePage extends StatefulWidget {\n  MyHomePage({Key key, this.title}) : super(key: key);\n  final String title;\n\n  @override\n  _MyHomePageState createState() => _MyHomePageState();\n}\n\nclass _MyHomePageState extends State<MyHomePage> {\n  int _counter = 0;\n\n  void _incrementCounter() {\n    setState(() {\n      _counter++;\n    });\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(widget.title),\n      ),\n      body: Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: <Widget>[\n            Text(\n              'You have pushed the button this many times:',\n            ),\n            Text(\n              '$_counter',\n              style: Theme.of(context).textTheme.display1,\n            ),\n          ],\n        ),\n      ),\n      floatingActionButton: FloatingActionButton(\n        onPressed: _incrementCounter,\n        tooltip: 'Increment',\n        child: Icon(Icons.add),\n      ),\n    );\n  }\n}\n```\n\n### MyHomePage\næˆ‘ä»¬åœ¨å‰é¢è¯´è¿‡ï¼Œå¦‚æœä¸€ä¸ªé¡µé¢æœ‰æ•°æ®ä¹Ÿå°±æ˜¯â€œçŠ¶æ€â€çš„è¯ï¼Œé‚£ä¹ˆä»–å°±å¾—ç»§æ‰¿è‡ª`StatefulWidget`ã€‚\n\nå¦‚æœä¸€ä¸ªç±»ç»§æ‰¿è‡ª`StatefulWidget`ï¼Œé‚£è¿™ä¸ªç±»ä¼šå¾ˆç®€å•ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ä¸­å†™å…¥`key`ä»¥åŠè¯¥`Widget`éœ€è¦çš„æ•°æ®ã€‚ç„¶åé‡å†™`createState()`æ–¹æ³•ã€‚\n\n### MyHomePageState\nå¦‚æœä¸€ä¸ªç±»ç»§æ‰¿è‡ª`StatefulWIdget`ï¼Œé‚£ä¹ˆä¸€å®šä¼šæœ‰ä¸€ä¸ªä»–çš„`State`ç±»å¹¶ç»§æ‰¿è‡ª`State<è¯¥ç±»>`ï¼Œå°±åƒ`class _MyHomePageState extends State<MyHomePage>`ä¸€æ ·ã€‚\n\né‚£æˆ‘ä»¬æ¥çœ‹çœ‹Stateç±»é‡Œé¢æœ‰äº›å•¥ä¸œè¥¿:\n\né¦–å…ˆå…ˆå®šä¹‰â€œçŠ¶æ€â€ï¼šç”±äºæˆ‘ä»¬è¿™ä¸ªAPPä¸»è¦çš„åŠŸèƒ½æ˜¯ç”¨æ¥è®¡æ•°ï¼Œæ‰€ä»¥å¿…é¡»å®šä¹‰ä¸€ä¸ªintå‹å˜é‡æ¥è®¡æ•°ï¼š\n```dart\nint _counter = 0;\n```\næ¥ç€å¦‚æœæˆ‘ä»¬è¿™ä¸ª_counterå˜é‡å˜äº†ï¼Œé‚£å°±å¾—é€šçŸ¥flutterè¯´çŠ¶æ€å˜äº†ï¼Œéœ€è¦æ›´æ–°UIï¼š\n```dart\nvoid _incrementCounter() {\n  setState(() {\n     _counter++;\n  });\n}\n```\nå…¶ä¸­ï¼Œ`setState()`æ–¹æ³•å°±æ˜¯ç”¨æ¥é€šçŸ¥`Flutter`è¿™ä¸ªçŠ¶æ€æ”¹å˜äº†ï¼Œè¦å»æ›´æ–°UIçš„ã€‚\n\næœ€åé‡å†™`build()`æ–¹æ³•æ¥å†™å…¥ç•Œé¢ï¼š\n\n- `Scaffold`æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒæä¾›äº†é»˜è®¤çš„å¯¼èˆªæ ã€æ ‡é¢˜å’ŒåŒ…å«ä¸»å±å¹•`widget`æ ‘ï¼ˆååŒâ€œç»„ä»¶æ ‘â€æˆ–â€œéƒ¨ä»¶æ ‘â€ï¼‰çš„`body`å±æ€§ã€‚\n- `body`åé¢æ˜¯ä¸€ä¸ª`Center`ç»„ä»¶ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å®ƒçš„å­`Widget`å®šä½åˆ°çˆ¶`Widget`çš„ä¸­é—´ã€‚\n- `Center`åé¢æ˜¯ä¸€ä¸ª`Column`ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶ç±»ä¼¼äºAndroidä¸­çš„`LinearLayout`çš„`orientation: Vertical`ï¼Œä¹Ÿå°±æ˜¯å‚ç›´å‘çš„çº¿æ€§å¸ƒå±€ã€‚åŒæ—¶Flutterä¹Ÿæä¾›äº†`Row`è¿™ä¸ªæ°´å¹³å‘çš„çº¿æ€§å¸ƒå±€ã€‚ä»–ä»¬çš„å­`Widget`æ˜¯`children`å±æ€§ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å¤šä¸ª`Widget`ã€‚\n- `Column`é‡Œé¢æ˜¯ä¸¤ä¸ª`Text`ï¼Œè¿™ä¸ªæ²¡å•¥è®²çš„\n- æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª`FloatingActionButton`ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæµ®åŠ¨æŒ‰é’®ï¼ŒAndroidé‡Œé¢æœ‰è¿™ä¸ªæ§ä»¶ï¼Œæ ¸å¿ƒæ˜¯ä»–çš„`onPressed`å±æ€§ï¼Œè¿™ä¸ªå°±ç›¸å½“äº`onClick()`ï¼Œç”¨äºå¤„ç†ç‚¹å‡»äº‹ä»¶ã€‚\n\n# ä½“éªŒçƒ­é‡å¯\né¦–å…ˆå…ˆè®©é¡¹ç›®åœ¨è™šæ‹Ÿæœºæˆ–è€…æ‰‹æœºä¸Šè¿è¡Œç€ï¼Œç„¶åæˆ‘ä»¬æŠŠé¡µé¢Textä¸­çš„\"You have pushed the button this many times:\"æ”¹ä¸º\"You have clicked the button this many times:\"ï¼Œç„¶åæŒ‰çƒ­é‡å¯é”®ï¼ˆmacOSç‰ˆAndroidStudioé»˜è®¤æ˜¯commond+sé”®ï¼‰ï¼Œæ¥ç€ä½ å°±èƒ½é‡Œé¢åœ¨è™šæ‹Ÿæœºæˆ–è€…æ‰‹æœºä¸Šçœ‹åˆ°ä¿®æ”¹ä¹‹åçš„ç»“æœã€‚\n![flutterçƒ­é‡å¯](http://cdn.littlecorgi.top/mweb/2019-10-09/%E6%9C%AA%E5%91%BD%E5%90%8D%20-2-.gif)\n","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"Flutterå…¥é—¨å¹¶å¼€å‘å¤©æ°”é¢„æŠ¥APP(1)â€”â€”Flutterå®‰è£…","url":"/posts/4bf666bf.html","content":"# Flutteræ˜¯ä»€ä¹ˆ\nFlutteræ˜¯ç”±è°·æ­Œæ¨å‡ºçš„ä¸€ä¸ªç§»åŠ¨UIæ¡†æ¶ï¼Œå¯ä»¥è®©å¼€å‘è€…å¿«é€Ÿçš„åœ¨Androidå’ŒiOSä¸Šæ„å»ºé«˜è´¨é‡çš„åŸç”Ÿç”¨æˆ·ç•Œé¢ã€‚\n\n<!-- More -->\n\né€šè¿‡å®ƒæ¥ç¼–å†™APPçš„å¥½å¤„åœ¨äºï¼š\n- å®ƒå†…ç½®äº†Androidçš„Material Designé£æ ¼å’ŒiOSçš„Cupertinoé£æ ¼çš„UIï¼›\n- å®ƒé€šè¿‡Dartè¯­è¨€ç¼–å†™ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä»½ä»£ç å°±èƒ½åœ¨Androidå’ŒiOSè®¾å¤‡ä¸Šå¾—åˆ°åŒæ ·çš„è¿è¡Œæ•ˆæœï¼›\n- ä»–æœ‰çƒ­é‡è½½åŠŸèƒ½ï¼Œåªéœ€è¦è¿è¡ŒAPPåï¼Œä»£ç æ›´æ”¹ä¸€ç‚¹ç„¶åç‚¹å‡»çƒ­é‡è½½é”®å°±èƒ½å¿«é€Ÿæ˜¾ç¤ºå‡ºä¿®æ”¹åçš„ç•Œé¢ã€‚\n\n# ä½¿ç”¨é•œåƒå®‰è£…\nç”±äºä¸€äº›ä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼ŒFlutteråœ¨å›½å†…è®¿é—®æœ‰æ—¶å€™ä¼šå—åˆ°é™åˆ¶ï¼Œå› æ­¤Flutterå®˜æ–¹ä¸ºå›½å†…å¼€å‘è€…æ­å»ºäº†ä¸´æ—¶é•œåƒï¼Œå¤§å®¶å¯ä»¥å°†ä¸‹é¢çš„ç¯å¢ƒå˜é‡æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼š\n```bash\nexport PUB_HOSTED_URL=https://pub.flutter-io.cn\nexport FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn\n```\nç”±äºæˆ‘ç”¨çš„æ˜¯macOSï¼Œå› æ­¤æˆ‘å°±åªæ¼”ç¤ºmacOSçš„ã€‚\nå¦‚æœæœ‰Linuxçš„ç”¨æˆ·åˆ™å’ŒmacOS çš„å®‰è£…æ–¹å¼ç±»ä¼¼ï¼Œç”šè‡³å¯ä»¥è¯´ä¸€æ ·ï¼›\nä½†æ˜¯å¯¹äºWindowsç”¨äºï¼Œéœ€è¦å¤§å®¶æ¡Œé¢å³é”®æ­¤`ç”µè„‘->å±æ€§->å¼¹å‡ºé¡µé¢å·¦ä¾§æ çš„é«˜çº§ç³»ç»Ÿè®¾ç½®->ç¯å¢ƒå˜é‡`ï¼Œåœ¨ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ ä¸­ç‚¹å‡»æ–°å»ºï¼Œå˜é‡åè¾“å…¥ä¸Šé¢ç­‰å·å·¦è¾¹çš„å¤§å†™å†…å®¹ï¼Œä¸è¦exportï¼Œå€¼è¾“å…¥ç­‰å·å³è¾¹çš„å†…å®¹ï¼Œè¾“å…¥ä¸€ç»„ä¹‹åå†ç‚¹å‡»æ–°å»ºæ¥ç€è¾“å…¥ä¸‹ä¸€ç»„ã€‚\n![Windowsä¸‹çš„ç¯å¢ƒå˜é‡é…ç½®](https://img-blog.csdn.net/20180616140532293?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ExMjAzOTkxNjg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)\n\næ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹è¯´macOSã€‚\n## é¦–å…ˆä½ å¾—ç¡®å®šä½ ç”¨çš„æ˜¯ä»€ä¹ˆshell\nå¦‚æœä½ æ²¡æ›´æ”¹è¿‡ä½ macOSç»ˆç«¯è®¾ç½®ï¼Œé‚£ä¹ˆä½ é»˜è®¤å°±æ˜¯`bash`ï¼Œä½†æ˜¯å¦‚æœä½ æ›´æ”¹è¿‡ï¼Œæ¯”æ–¹è¯´æˆ‘å°±æ¢æˆäº†`zsh`ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—ä½ åº”è¯¥çŸ¥é“åœ¨å“ªè®¾ç½®ç¯å¢ƒå˜é‡ã€‚\n## å¦‚æœä½ æ˜¯bash\né¦–å…ˆæ‰“å¼€ä½ macOSçš„ç»ˆç«¯ï¼Œåœ¨å¯åŠ¨å°é‡Œé¢å¯ä»¥æ‰¾åˆ°ï¼Œæ¥ç€å¯¹`bash`çš„ç¯å¢ƒå˜é‡è¿›è¡Œè®¾ç½®ï¼Œè¾“å…¥\n```\nvim ~/.bash_profile\n```\nå›è½¦ï¼Œè¿›å…¥`.bash_profile`æ–‡ä»¶çš„ç¼–è¾‘é¡µé¢ï¼Œç„¶åæŒ‰ä¸‹é”®ç›˜`Ié”®`ï¼Œè¿›å…¥vimçš„ç¼–è¾‘æ¨¡å¼ï¼Œç„¶åç›´æ¥æŠŠä¸Šé¢çš„exportç¯å¢ƒå˜é‡èµ‹å€¼ç²˜è´´è¿›å»ã€‚ç„¶åæŒ‰ä¸‹`Escé”®`é€€å‡ºvimçš„ç¼–è¾‘æ¨¡å¼ï¼Œç„¶åç›´æ¥è¾“å…¥`:wq`å›è½¦ä¿å­˜å¹¶é€€å‡ºã€‚\næ¥ç€è¾“å…¥\n```\nsource ~/.bash_profile\n```\nè®©åˆšåˆšé…ç½®çš„ç¯å¢ƒå˜é‡ç”Ÿæ•ˆå³å¯ã€‚\n![bashé…ç½®ç¯å¢ƒå˜é‡](http://cdn.littlecorgi.top/mweb/2019-10-08/bash%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png)\n\n## å¦‚æœä½ æ˜¯zsh\né¦–å…ˆæ‰“å¼€ä½ macOSçš„ç»ˆç«¯ï¼Œåœ¨å¯åŠ¨å°é‡Œé¢å¯ä»¥æ‰¾åˆ°ï¼Œæ¥ç€å¯¹`zsh`çš„ç¯å¢ƒå˜é‡è¿›è¡Œè®¾ç½®ï¼Œè¾“å…¥\n```\nvim ~/.zshrc\n```\nå›è½¦ï¼Œè¿›å…¥`.zshrc`æ–‡ä»¶çš„ç¼–è¾‘é¡µé¢ï¼Œæ‰¾åˆ°å¦‚å›¾æ‰€ç¤ºéƒ¨åˆ†ï¼ˆé‡ç‚¹åœ¨äºæœ‰`# export MANPATH=\"/Usrs/......`çš„åœ°æ–¹ï¼Œå› ä¸ºæˆ‘è¿˜æœ‰å…¶å®ƒçš„ç¯å¢ƒå˜é‡ï¼Œæ‰€ä»¥ä½ çš„å¯èƒ½å’Œæˆ‘çš„ä¸åŒï¼‰ï¼š\n![zshr](http://cdn.littlecorgi.top/mweb/2019-10-08/zshrc.png)\n\n\nåœ¨`# export`ä¸‹é¢ï¼ŒæŒ‰ä¸‹é”®ç›˜`Ié”®`ï¼Œè¿›å…¥vimçš„ç¼–è¾‘æ¨¡å¼ï¼Œç„¶åç›´æ¥æŠŠä¸Šé¢çš„exportç¯å¢ƒå˜é‡èµ‹å€¼ç²˜è´´è¿›å»ã€‚\nè§æˆ‘å›¾ä¸­æœ€ä¸‹é¢æ ‡çº¢çš„é‚£åœ°æ–¹ï¼Œè‡³äºæœ€åä¸€è¡Œ`export PATH=~/development/flutter/bin:$PATH`å…ˆä¸ç®¡ã€‚ç„¶åæŒ‰ä¸‹`Escé”®`é€€å‡ºvimçš„ç¼–è¾‘æ¨¡å¼ï¼Œç„¶åç›´æ¥è¾“å…¥`:wq`å›è½¦ä¿å­˜å¹¶é€€å‡ºã€‚\næ¥ç€è¾“å…¥\n```\nsource ~/.zshrc\n```\nè®©åˆšåˆšé…ç½®çš„ç¯å¢ƒå˜é‡ç”Ÿæ•ˆå³å¯ã€‚\n![zshé…ç½®ç¯å¢ƒå˜é‡](http://cdn.littlecorgi.top/mweb/2019-10-08/zsh%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png)\n\n# ä¸‹è½½Flutter SDK\n## å…ˆå»Flutterçš„å®˜ç½‘å»ä¸‹è½½ä½ å¯¹åº”ç³»ç»Ÿçš„Flutter SDK\n1. æ‰“å¼€å®˜ç½‘ä¸‹è½½é¡µï¼š[Flutter SDK release](https://flutter.dev/docs/development/tools/sdk/releases)\n2. é€‰æ‹©ä½ çš„ç³»ç»Ÿå¯¹åº”çš„ç›®å½•ï¼Œç„¶åé»˜è®¤é€‰æ‹©Stable channelä¸‹è½½ã€‚(*Master channelè¿™ä¸ªæ˜¯ç›´æ¥ä»githubè·å–çš„githubä¸Šçš„æœ€æ–°ç‰ˆï¼Œä¹Ÿå°±æ˜¯è¯´Flutterçš„å¼€å‘è€…ä»–å†™äº†ç‚¹ä»€ä¹ˆæ”¹äº†ç‚¹ä»€ä¹ˆéƒ½ä¼šé‡Œé¢åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸Šæ˜¾ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬æ„å‘³ç€éå¸¸ä¸ç¨³å®šï¼Œå¯èƒ½bugå¾ˆå¤šï¼›Dev channelæ˜¯å¼€å‘ç‰ˆï¼ŒMaster channelç»è¿‡ä¸€å®šæµ‹è¯•ä¹‹åçš„ç‰ˆæœ¬ä¼šå‘å¸ƒåˆ°Dev channelä¸Šï¼Œä½†æ˜¯ä¸æ˜¯å¤§é‡çš„æµ‹è¯•ï¼Œæ‰€ä»¥å¯èƒ½è¿˜æ˜¯ä¸å¤ªç¨³å®šï¼›Beta channelæ˜¯æµ‹è¯•ç‰ˆï¼Œæ¯æœˆå‘å¸ƒä¸€æ¬¡ï¼Œä¼šæŠŠä¸Šä¸ªæœˆæ‰€é‡Šæ”¾çš„æ‰€æœ‰Dev channelä¸­æœ€ç¨³å®šçš„ç‰ˆæœ¬é‡Šæ”¾åˆ°Beta channelä¸Šï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æœ‰ç‚¹ä¸ç¨³å®šï¼Œé€‚åˆæƒ³å°é²œçš„å¼€å‘è€…ï¼›State channelæ˜¯æ ‡å‡†ç‰ˆï¼Œå½“Flutterç»´æŠ¤äººå‘˜è®¤ä¸ºæŸä¸ªç‰ˆæœ¬è¶³å¤Ÿç¨³å®šä¹‹åï¼Œå°±ä¼šå‘é€åˆ°è¿™ä¸ªç‰ˆæœ¬ä¸Šå»ï¼Œä¸€èˆ¬å¼€å‘è€…æœ€å¥½è¿˜æ˜¯ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬)\n\n## è§£å‹å®‰è£…åŒ…åˆ°ä½ æƒ³è¦çš„ç›®å½•\nä¾‹å¦‚\n```\n// Linux/macOS\ncd ~/development\nunzip ~/Downloads/flutter_macos_v0.5.1-beta.zip\n```\n\n## æ·»åŠ Fluuterè·¯å¾„åˆ°ç¯å¢ƒå˜é‡ä¸­\nå›é¡¾ç¬¬2é¡¹ï¼ŒæŠŠå¦‚ä¸‹å†…å®¹æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­å»\n```bash\nexport PATH=/ä½ ä¸Šä¸€æ­¥flutterè§£å‹çš„ç›®å½•/flutter/bin:$PATH\n```\n## è¿è¡ŒFlutter doctor\nå¦‚æœæ˜¯macOS/Linuxï¼Œç›´æ¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥`flutter doctor`å³å¯ã€‚\nå¦‚æœæ˜¯Windowsï¼Œåˆ™å³é”®å¼€å§‹ï¼Œé€‰æ‹©PowerShellï¼Œç„¶åè¾“å…¥`flutter doctor`å³å¯ã€‚\n\nè¿™ä¸ªå‘½ä»¤çš„åŠŸèƒ½æ˜¯æ£€æŸ¥ä½ çš„Flutteræ˜¯å¦æ­£å¸¸å®‰è£…ã€‚\n\nå¦‚æœæ­£å¸¸å®‰è£…çš„è¯ä¼šå‡ºç°å¦‚ä¸‹ä¿¡æ¯ï¼š\n```bash\nDoctor summary (to see all details, run flutter doctor -v):\n[âœ“] Flutter (Channel stable, v1.9.1+hotfix.4, on Mac OS X 10.13.6 17G65, locale zh-Hans-CN)\n \n[âœ“] Android toolchain - develop for Android devices (Android SDK version 29.0.1)\n[âœ—] Xcode - develop for iOS and macOS\n    âœ— Xcode installation is incomplete; a full installation is necessary for iOS development.\n      Download at: https://developer.apple.com/xcode/download/\n      Or install Xcode via the App Store.\n      Once installed, run:\n        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer\n    âœ— CocoaPods not installed.\n        CocoaPods is used to retrieve the iOS and macOS platform side's plugin code that responds to\n        your plugin usage on the Dart side.\n        Without CocoaPods, plugins will not work on iOS or macOS.\n        For more info, see https://flutter.dev/platform-plugins\n      To install:\n        sudo gem install cocoapods\n        pod setup\n[âœ“] Android Studio (version 3.5)\n[!] IntelliJ IDEA Community Edition (version 2019.2.3)\n    âœ— Flutter plugin not installed; this adds Flutter specific functionality.\n    âœ— Dart plugin not installed; this adds Dart specific functionality.\n[âœ“] VS Code (version 1.38.1)\n[âœ“] Connected device (1 available)\n\n! Doctor found issues in 2 categories.\n```\n\næˆ‘çš„ç”µè„‘è¿è¡Œä¹‹åä¼šå‡ºç°ä¸¤ä¸ªé”™è¯¯ï¼Œå› ä¸ºFlutter doctorä¼šè‡ªåŠ¨æ£€æŸ¥ç”µè„‘ä¸­æ‰€æœ‰èƒ½è¿è¡ŒFlutterçš„ç¼–è¾‘å™¨æˆ–è€…IDEï¼Œç„¶ååˆ¤æ–­ä»–ä»¬é…æ²¡é…ç½®Flutterã€‚æˆ‘çš„ç”µè„‘æ˜¯å› ä¸ºæ²¡æœ‰å®‰è£…Xcodeä»¥åŠæˆ‘æ²¡æœ‰åœ¨IDEAä¸­é…ç½®Flutterï¼Œæ‰€ä»¥æˆ‘è¿™ä¸¤é¡¹å‡ºé”™ã€‚\n\nå…¶å®ä½ åªè¦ä¿è¯é™¤äº†IDEä¹‹å¤–çš„é¡¹ç›®éƒ½æ˜¯æ­£å¸¸çš„å°±è¡Œäº†ï¼Œå¦‚æœæœ‰é”™çš„è¯ç›´æ¥æŠŠæŠ¥é”™ä¿¡æ¯æ”¾åˆ°ç™¾åº¦é‡Œé¢è¿›è¡Œæœç´¢å°±å¯ä»¥äº†ã€‚è‡³äºIDEé¡¹ç›®ï¼Œå¦‚æœä½ æ˜¯iOSå¼€å‘è€…ï¼Œåˆ™ä¿è¯Xcodeæˆ–è€…æ˜¯AppCodeå•¥çš„å‰é¢æ˜¯âœ”ï¸å°±è¡Œäº†çš„ï¼Œè‡³äºä½ ç”µè„‘ä¸Šçš„å…¶å®ƒä¾‹å¦‚IDEAæˆ–è€…vscodeå•¥çš„å¯ä»¥ä¸ç”¨ç®¡ï¼›å¦‚æœä½ æ˜¯Androidå¼€å‘è€…ï¼Œåˆ™ä¿è¯ä½ å¸¸ç”¨çš„IDEå¦‚Android Studioå‰é¢æ˜¯âœ”ï¸å°±è¡Œäº†çš„ï¼Œè‡³äºä½ ç”µè„‘ä¸Šçš„å…¶å®ƒä¾‹å¦‚IDEAæˆ–è€…vscodeå•¥çš„å¯ä»¥ä¸ç”¨ç®¡ã€‚\n\næ€»è€Œè¨€ä¹‹ï¼Œç¡®ä¿é™¤äº†IDEä¹‹å¤–çš„å…¶å®ƒé¡¹å‰é¢æ˜¯å¯¹å‹¾ï¼Œç„¶åç¡®å®šä¸€ä¸ªä½ å¸¸ç”¨çš„å†™ä»£ç çš„å·¥å…·å‰é¢æœ‰å¯¹å‹¾å°±è¡Œäº†ï¼Œå¦‚æœä½ é™¤äº†IDEä¹‹å¤–çš„å…¶å®ƒé¡¹æœ‰é—®é¢˜ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ç›´æ¥ç™¾åº¦ï¼›å¦‚æœæ˜¯ä½ å¸¸ç”¨çš„IDEå‰é¢æ²¡å¯¹å‹¾ï¼Œé‚£å°±ç™¾åº¦ä½ å¸¸ç”¨çš„IDE+Flutteræ¥å‚è€ƒåˆ«äººçš„é…ç½®æ•™ç¨‹ã€‚\n\n---\n*ç”±äºæˆ‘æ²¡æœ‰ç”¨è¿‡xcodeæ‰€ä»¥å°±ä¸è®²xcodeå¦‚ä½•é…ç½®Flutteräº†ï¼Œå°±åˆ†åˆ«è®²å¦‚ä½•åœ¨AndroidStudioå’Œvscodeé…ç½®Flutterã€‚*\n\n---\n\n# Android Studioé…ç½®Flutter\n1. æ‰“å¼€ä½ Android Studioçš„`è®¾ç½®/é¦–é€‰é¡¹/Preferences`ï¼Œç„¶åé€‰æ‹©`Plugins`ï¼Œåœ¨`Marketplace`é‡Œé¢æœç´¢`Flutter`ï¼šâ€¨    ![Androidstudio Flutte](http://cdn.littlecorgi.top/mweb/2019-10-08/Androidstudio%20Flutter.png)\n\n2. æ¥ç€ç‚¹å‡»`INSTALL`å®‰è£…å°±è¡Œäº†ï¼Œå¹¶ä¸”å®‰è£…Flutteræ’ä»¶ä¼šè‡ªåŠ¨é¡ºå¸¦å®‰è£…Dartæ’ä»¶ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…Dartæ’ä»¶ï¼Œä½ å°±ä¸€æ ·çš„æœç´¢`Dart`ç„¶åå®‰è£…å³å¯ï¼›\n3. å®‰è£…å®Œæˆå¹¶é‡å¯Android Studioä¹‹åï¼Œä»ç„¶æ‰“å¼€`è®¾ç½®/é¦–é€‰é¡¹/Preferences`ï¼Œé€‰æ‹©`Languages & Frameworks`->`Flutter`ï¼Œåœ¨æœ€ä¸Šé¢çš„SDKä¸­çš„`Flutter SDK path`é€‰æ‹©ä½ ç¬¬ä¸‰æ­¥Flutter SDKè§£å‹ç¼©çš„è·¯å¾„ï¼Œä¸å‡ºæ„å¤–çš„è¯ä¸‹é¢`Version`ä¼šè‡ªåŠ¨æ˜¾ç¤ºä½ Flutter SDKçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”`Languages & Frameworks`->`Dart`é‡Œé¢çš„`Dart SDK path`ä¹Ÿä¼šè‡ªåŠ¨å‡ºç°ã€‚\n    ![Android Studio Flutter Setting](http://cdn.littlecorgi.top/mweb/2019-10-08/Android%20Studio%20Flutter%20Setting.png)\n4. æ¥ç€å’Œä¹‹å‰ä¸€æ ·è¿è¡Œ`flutter doctor`,çœ‹çœ‹Android Studioå‰é¢æœ‰æ²¡æœ‰âœ”ï¸ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¼šæœ‰çš„ã€‚\n\n# vscode é…ç½®Flutter\n1. åœ¨vscodeæ‹“å±•é‡Œé¢æœç´¢Flutterå’ŒDartï¼Œå®‰è£…ï¼›â€¨![vscode Flutte](http://cdn.littlecorgi.top/mweb/2019-10-08/vscode%20Flutter.png)\n\n2. æ¥ç€å’Œä¹‹å‰ä¸€æ ·è¿è¡Œ`flutter doctor`,çœ‹çœ‹vscodeå‰é¢æœ‰æ²¡æœ‰âœ”ï¸ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¼šæœ‰çš„ã€‚","tags":["Android","Flutter"],"categories":["Flutter"]},{"title":"æ“ä½œç³»ç»Ÿ6--æ­»é”","url":"/posts/68dc89d4.html","content":"# 6.1 æ­»é”çš„å¼•å…¥\n\nåœ¨ä¹‹å‰æˆ‘ä»¬æˆ–å¤šæˆ–å°‘éƒ½æ¶‰åŠåˆ°äº†æ­»é”ï¼Œæœ€ç›´æ¥çš„ä¾‹å­å°±æ˜¯å“²å­¦å®¶å°±é¤ç­·å­ï¼Œå¦‚æœæ¯ä¸€ä¸ªå“²å­¦å®¶éƒ½æ‹¿èµ·äº†ä»–çš„å³æ‰‹çš„ç­·å­ï¼Œç°åœ¨éƒ½åœ¨ç­‰å·¦è¾¹çš„ç­·å­ã€‚è¿™æ ·ä¸€ç›´ç»•ä¸‹å»ï¼Œä»è€Œäº§ç”Ÿäº†æ­»é”ã€‚\n\n<!--More-->\n\n## 6.1.1 èµ„æºé—®é¢˜\nåœ¨ç³»ç»Ÿä¸­å­˜åœ¨ç€å¾ˆå¤šä¸åŒç±»å‹çš„èµ„æºï¼Œå…¶ä¸­å¯ä»¥å¼•èµ·çš„æ­»é”çš„ä¸»è¦æ˜¯éœ€è¦é‡‡ç”¨äº’æ–¥è®¿é—®æ–¹æ³•çš„ã€ä¸å¯ä»¥è¢«æŠ¢å çš„èµ„æºã€\n\n### 6.1.1.1 å¯é‡ç”¨æ€§èµ„æºå’Œæ¶ˆè€—æ€§èµ„æº\n\n#### å¯é‡ç”¨æ€§èµ„æº\nå¯é‡ç”¨æ€§èµ„æºæ˜¯ä¸€ç§å¯ä¾›ç”¨æˆ·é‡å¤ä½¿ç”¨å¤šæ¬¡çš„èµ„æºï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š\n1. æ¯ä¸€ä¸ªå¯é‡ç”¨æ€§èµ„æºä¸­çš„å•ä½åªèƒ½åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œä¸å…è®¸å¤šä¸ªè¿›ç¨‹å…±äº«\n2. è¿›ç¨‹åœ¨ä½¿ç”¨å¯é‡ç”¨æ€§èµ„æºæ—¶ï¼Œé¡»æŒ‰ç…§è¿™æ ·çš„é¡ºåºï¼šè¯·æ±‚èµ„æº -> ä½¿ç”¨èµ„æº -> é‡Šæ”¾èµ„æº\n3. ç³»ç»Ÿä¸­æ¯ä¸€ç±»å¯é‡ç”¨æ€§èµ„æºä¸­çš„å•å…ƒæ•°ç›®æ˜¯ç›¸å¯¹å›ºå®šçš„ï¼Œè¿›ç¨‹åœ¨è¿è¡ŒæœŸé—´æ—¢ä¸èƒ½åˆ›å»ºä¹Ÿä¸èƒ½åˆ é™¤å®ƒ\n\n#### å¯æ¶ˆè€—æ€§èµ„æº\nå¯æ¶ˆè€—æ€§èµ„æºåˆç§°ä¸ºä¸´æ—¶æ€§èµ„æºï¼Œå®ƒæ˜¯åœ¨è¿›ç¨‹è¿è¡ŒæœŸé—´ï¼Œç”±è¿›ç¨‹åŠ¨æ€çš„åˆ›å»ºå’Œæ¶ˆè€—çš„ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š\n1. æ¯ä¸€ç±»å¯æ¶ˆè€—æ€§èµ„æºçš„å•å…ƒæ•°ç›®åœ¨è¿›ç¨‹è¿è¡ŒæœŸé—´æ˜¯å¯ä»¥ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰æ—¶å®ƒå¯ä»¥æœ‰å¾ˆå¤šï¼Œæœ‰æ—¶å¯èƒ½ä¸º0\n2. è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä¸æ–­åœ°åˆ›é€ å¯æ¶ˆè€—æ€§èµ„æºçš„å•å…ƒï¼Œå°†å®ƒä»¬æ”¾å…¥è¯¥èµ„æºç±»çš„ç¼“å†²åŒºä¸­ï¼Œä»¥å¢åŠ è¯¥èµ„æºç±»çš„å•å…ƒæ•°ç›®\n3. è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¯·æ±‚è‹¥å¹²ä¸ªå¯æ¶ˆè€—æ€§èµ„æºå•å…ƒï¼Œç”¨äºè¿›ç¨‹è‡ªå·±çš„æ¶ˆè€—ï¼Œä¸å†å°†å®ƒä»¬è¿”å›ç»™è¯¥èµ„æºç±»ä¸­\n\n### 6.1.1.2 å¯æŠ¢å æ€§èµ„æºå’Œä¸å¯æŠ¢å æ€§èµ„æº\n#### å¯æŠ¢å æ€§èµ„æº \nå¯æŠŠç³»ç»Ÿä¸­çš„èµ„æºåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å¯æŠ¢å æ€§èµ„æºï¼Œæ˜¯æŒ‡æŸè¿›ç¨‹åœ¨è·å¾—è¿™ç±»èµ„æºåï¼Œè¯¥èµ„æºå¯ä»¥å†è¢«å…¶å®ƒè¿›ç¨‹æˆ–ç³»ç»ŸæŠ¢å \n\n#### ä¸å¯æŠ¢å æ€§èµ„æº\nå¦ä¸€ç±»èµ„æºæ˜¯ä¸å¯æŠ¢å èµ„æºï¼Œä¸€æ—¦ç³»ç»ŸæŠŠæŸèµ„æºåˆ†é…ç»™è¯¥è¿›ç¨‹ä¹‹åï¼Œå°±ä¸èƒ½å°†å®ƒå¼ºè¡Œå›æ”¶ï¼Œåªèƒ½åœ¨è¿›ç¨‹ç”¨å®Œåè‡ªè¡Œé‡Šæ”¾\n\n## 6.1.2 æ­»é”çš„èµ·å› \n### 6.1.2.1 ç«äº‰ä¸å¯æŠ¢å æ€§èµ„æºå¼•èµ·çš„æ­»é”\né€šå¸¸ç³»ç»Ÿä¸­æ‰€æ‹¥æœ‰çš„ä¸å¯æŠ¢å æ€§èµ„æºå…¶æ•°é‡ä¸è¶³ä»¥æ»¡è¶³å¤šä¸ªè¿›ç¨‹è¿è¡Œçš„éœ€è¦ï¼Œä½¿å¾—è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå› äº‰å¤ºèµ„æºè€Œé™·å…¥åƒµå±€ã€‚\n\nä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿›ç¨‹$P_1$å’Œ$P_2$åœ¨å¹¶å‘æ‰§è¡Œï¼Œä»–ä»¬éƒ½è¦å†™ä¸¤ä¸ªæ–‡ä»¶$F_1$å’Œ$F_2$ã€‚å…¶ä¸­$P_1$å’Œ$P_2$çš„ä»£ç åˆ†åˆ«ä¸ºï¼š\n``` C\n   P1\n  ....\nOpen(f1, w);\nOpen(f2, w);\n\n   P2\n  ....\nOpen(f2, w);\nOpen(f1, w);\n```\n\nå¦‚æœè¿™ä¸¤ä¸ªè¿›ç¨‹åœ¨å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœ$P_1$å…ˆæ‰“å¼€$F_1$å’Œ$F_2$ï¼Œç„¶å$P_2$æ‰å»æ‰“å¼€$F_1$(æˆ–$F_2$)ï¼Œç”±äºæ–‡ä»¶$F_1$(æˆ–$F_2$)å·²ç»è¢«æ‰“å¼€ï¼Œå› æ­¤$P_2$ä¼šè¢«é˜»å¡ã€‚å½“$P_1$ä½¿ç”¨å®Œ$F_1$(æˆ–$F_2$)ï¼Œè¿™æ—¶$P_2$æ‰å¯ä»¥å»æ‰“å¼€$F_1$(æˆ–$F_2$)ï¼Œè¿™æ ·ç¨‹åºç»§ç»­è¿è¡Œä¸‹å»ã€‚\n\nä½†æ˜¯å¦‚æœåœ¨$P_1$æ‰“å¼€$F_1$çš„åŒæ—¶ï¼Œ$P_2$å»æ‰“å¼€$F_2$ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å æœ‰ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œæ­¤æ—¶å°±å¯èƒ½å‡ºç°é—®é¢˜ã€‚å› ä¸ºå½“$P_1$è¯•å›¾å»æ‰“å¼€$F_2$,è€Œ$F_2$è¯•å›¾å»æ‰“å¼€$F_1$æ—¶ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹éƒ½ä¼šå› æ–‡ä»¶å·²è¢«æ‰“å¼€è€Œé˜»å¡ï¼Œå› æ­¤è¿™ä¸¤ä¸ªè¿›ç¨‹å°†ä¼šæ— é™æœŸåœ°ç­‰å¾…ä¸‹å»ï¼Œä»è€Œå½¢æˆæ­»é”ã€‚\n![å…±äº«æ–‡ä»¶æ—¶çš„æ­»é”æƒ…å†µ](http://cdn.littlecorgi.top/mweb/2019-09-19/%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E6%97%B6%E7%9A%84%E6%AD%BB%E9%94%81%E6%83%85%E5%86%B5.png)\n\n\n### 6.1.2.2 ç«äº‰å¯æ¶ˆè€—èµ„æºå¼•èµ·çš„æ­»é”\n![è¿›ç¨‹ä¹‹é—´é€šä¿¡æ—¶çš„æ­»é”](http://cdn.littlecorgi.top/mweb/2019-09-19/%E8%BF%9B%E7%A8%8B%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%97%B6%E7%9A%84%E6%AD%BB%E9%94%81.png)\nå¦‚å›¾æ‰€ç¤ºï¼Œ$m_1$ã€$m_3$ã€$m_3$æ˜¯å¯æ¶ˆè€—èµ„æºã€‚è¿›ç¨‹$P_1$ä¸€æ–¹é¢äº§ç”Ÿæ¶ˆæ¯$m_1$ï¼Œåˆ©ç”¨`send(p2,m1)`å°†å®ƒå‘é€ç»™$P_2$ï¼Œå¦ä¸€æ–¹é¢ï¼Œæœ‰è¦æ±‚ä»$P_3$æ¥å—æ¶ˆæ¯$m_2$ï¼›è€Œ$P_2$ã€$P_3$ä¾æ¬¡ç±»æ¨ã€‚\n\nå¦‚æœä¸‰ä¸ªè¿›ç¨‹æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š\n```c\nP1:   ...send(p2, m1);    receive(p3, m3);...\nP2:   ...send(p3, m2);    receive(p1, m1);...\nP3:   ...send(p1, m3);    receive(p2, m2);...\n```\nè¿™ä¸‰ä¸ªè¿›ç¨‹éƒ½å¯ä»¥å…ˆå°†æ¶ˆæ¯å‘é€ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œç›¸åº”åœ°ä»–ä»¬ä¹Ÿéƒ½èƒ½éƒ½æ¥æ”¶åˆ°ä»ä¸Šä¸€ä¸ªè¿›ç¨‹å‘æ¥çš„æ¶ˆæ¯ï¼Œå› æ­¤ä¸‰ä¸ªè¿›ç¨‹éƒ½å¯ä»¥é¡ºåˆ©çš„è¿›è¡Œä¸‹å»ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”ã€‚\n\nä½†æ˜¯å¦‚æœä¸‰ä¸ªè¿›ç¨‹éƒ½å…ˆæ‰§è¡Œreceiveï¼Œåœ¨æ‰§è¡Œsendï¼ŒæŒ‰ä¸‹é¢çš„é¡ºåºè¿è¡Œï¼š\n```c\nP1:   ...receive(p3, m3);    send(p2, m1);...\nP2:   ...receive(p1, m1);    send(p3, m2);...\nP3:   ...receive(p2, m2);    send(p1, m3);...\n```\né‚£ä¹ˆè¿™ä¸‰ä¸ªè¿›ç¨‹å°±ä¼šæ°¸è¿œé˜»å¡åœ¨å®ƒä»¬çš„receiveæ“ä½œä¸Šï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚\n\n\n# 6.2 æ­»é”çš„å®šä¹‰ã€å¿…è¦æ¡ä»¶å’Œå¤„ç†æ–¹æ³•\n## 6.2.1 æ­»é”çš„å®šä¹‰\nå¦‚æœä¸€ç»„è¿›ç¨‹ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ä»…ç”±è¯¥ç»„è¿›ç¨‹ä¸­çš„å…¶å®ƒè¿›ç¨‹æ‰èƒ½å¼•å‘çš„äº‹ä»¶ï¼Œé‚£ä¹ˆè¯¥ç»„è¿›ç¨‹æ˜¯æ­»é”çš„ã€‚\n\n## 6.2.2 äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶\näº§ç”Ÿæ­»é”å¿…é¡»åŒæ—¶å…·å¤‡ä¸‹é¢å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œåªè¦å…¶ä¸­ä»»ä¸€ä¸ªæ¡ä»¶ä¸æˆç«‹ï¼Œæ­»é”å°±ä¸ä¼šå‘ç”Ÿï¼š\n1. äº’æ–¥æ¡ä»¶ã€‚è¿›ç¨‹å¯¹æ‰€åˆ†é…çš„èµ„æºè¿›è¡Œæ’ä»–æ€§ä½¿ç”¨ã€‚å³è¯¥èµ„æºåªå…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå…¶ä»–è¿›ç¨‹å¦‚æœè¯·æ±‚è¯¥èµ„æºåªèƒ½ç­‰å¾…ã€‚\n2. è¯·æ±‚å’Œä¿æŒæ¡ä»¶ã€‚è¿›ç¨‹å·²ç»ä¿æŒä¸€è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œæ–°èµ„æºå·²è¢«å…¶ä»–è¿›ç¨‹å æœ‰ï¼Œå¯¼è‡´è¿›ç¨‹è¢«é˜»å¡ã€‚\n3. ä¸å¯æŠ¢å æ¡ä»¶ã€‚ è¿›ç¨‹å·²è·å¾—çš„èµ„æºåœ¨ä¸ºä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«æŠ¢å ï¼Œåªæœ‰è¿›ç¨‹åœ¨ä½¿ç”¨å®Œä¹‹åæ‰èƒ½é‡Šæ”¾ã€‚\n4. å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚å‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹èµ„æºå¾ªç¯é“¾ï¼Œå³è¿›ç¨‹é›†åˆ$[P_0, P_1, P_2, Â·Â·Â·, P_n]$ä¸­$P_0$æ­£åœ¨ç­‰å¾…ä¸€ä¸ª$P_1$å ç”¨çš„èµ„æºï¼Œ$P_1$æ­£åœ¨ç­‰å¾…ä¸€ä¸ª$P_2$å ç”¨çš„èµ„æºï¼Œâ€¦â€¦ï¼Œ$P_n$æ­£åœ¨ç­‰å¾…ä¸€ä¸ª$P_0$å ç”¨çš„èµ„æº\n\n## 6.2.3 å¤„ç†æ­»é”çš„åŠæ³•\nç›®å‰å¤„ç†æ­»é”çš„æ–¹æ³•å¯å½’ç»“ä¸ºå››ç§ï¼š\n1. é¢„é˜²æ­»é”ã€‚é€šè¿‡è®¾ç½®æŸäº›é™åˆ¶ï¼Œå»ç ´åäº§ç”Ÿæ­»é”å››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªæ¥é¢„é˜²æ­»é”ã€‚\n2. é¿å…æ­»é”ã€‚åœ¨èµ„æºçš„åŠ¨æ€åˆ†é…è¿‡ç¨‹ä¸­ï¼Œç”¨æŸç§æ–¹æ³•é˜»æ­¢ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œä»è€Œé¿å…å‘ç”Ÿæ­»é”ã€‚\n3. æ£€æµ‹æ­»é”ã€‚è¯¥æ–¹æ³•å…è®¸è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ­»é”ï¼Œä½†å¯é€šè¿‡æ£€æµ‹æœºæ„åŠæ—¶åœ°æ£€æµ‹å‡ºæ­»é”çš„å‘ç”Ÿï¼Œç„¶åé‡‡å–é€‚å½“æªæ–½ï¼ŒæŠŠè¿›åŸä»æ­»é”ä¸­è§£è„±å‡ºæ¥ã€‚\n4. è§£é™¤æ­»é”ã€‚å½“æ£€æµ‹åˆ°ç³»ç»Ÿä¸­å·²å‘ç”Ÿæ­»é”æ—¶ï¼Œå°±é‡‡å–ç›¸åº”æªæ–½ï¼Œå°†è¿›ç¨‹ä»æ­»é”çŠ¶æ€ä¸­è§£è„±å‡ºæ¥ã€‚\n\n# 6.3 é¢„é˜²æ­»é”\né¢„é˜²æ­»é”æ—¶é€šè¿‡ç ´åäº§ç”Ÿæ­»é”å››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªï¼Œä»¥é¿å…å‘ç”Ÿæ­»é”ã€‚\n\n## 6.3.1 ç ´åâ€œè¯·æ±‚å’Œä¿æŒâ€æ¡ä»¶\nå½“ä¸€ä¸ªè¿›ç¨‹åœ¨è¯·æ±‚èµ„æºæ—¶ï¼Œä»–ä¸èƒ½æŒæœ‰ä¸å¯æŠ¢å èµ„æºã€‚å¯é€šè¿‡ä¸€ä¸‹ä¸¤ç§ä¸åŒçš„åè®®å®ç°ï¼š\n\n### 6.3.1.1 ç¬¬ä¸€ç§åè®®\næ‰€æœ‰è¿›ç¨‹åœ¨å¼€å§‹è¿è¡Œä¹‹å‰ï¼Œå¿…é¡»ä¸€æ¬¡æ€§åœ°ç”³è¯·å…¶åœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­æ‰€éœ€çš„å…¨éƒ¨èµ„æºã€‚æ­¤æ—¶è‹¥ç³»ç»Ÿä¸­æœ‰è¶³å¤Ÿçš„èµ„æºåˆ†é…ç»™æŸè¿›ç¨‹ï¼Œä¾¿å¯æŠŠå…¶éœ€è¦çš„æ‰€æœ‰èµ„æºåˆ†é…ç»™å®ƒã€‚è¿™æ ·ï¼Œè¯¥è¿›ç¨‹åœ¨æ•´ä¸ªè¿è¡ŒæœŸé—´ï¼Œä¾¿ä¸ä¼šå†æå‡ºèµ„æºè¦æ±‚ï¼Œä»è€Œç ´åäº†â€œè¯·æ±‚â€æ¡ä»¶ã€‚ç³»ç»Ÿåœ¨åˆ†é…èµ„æºæ—¶ï¼Œåªè¦æœ‰ä¸€ç§èµ„æºä¸èƒ½æ»¡è¶³è¿›ç¨‹çš„è¦æ±‚ï¼Œå³ä½¿å…¶æ‰€éœ€çš„å…¶ä»–èµ„æºéƒ½ç©ºé—²ä¹Ÿä¸åˆ†é…ç»™å®ƒï¼Œè€Œè®©è¯¥è¿›ç¨‹ç­‰å¾…ã€‚ç”±äºè¯¥è¿›ç¨‹åœ¨ç­‰å¾…æœŸé—´æœªå æœ‰ä»»ä½•èµ„æºï¼Œäºæ˜¯ç ´åäº†â€œä¿æŒâ€æ¡ä»¶ï¼Œä»è€Œå¯ä»¥é¢„é˜²æ­»é”çš„å‘ç”Ÿã€‚\n\nè¿™ç§åè®®çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€æ˜“è¡Œä¸”å®‰å…¨ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæå…¶æ˜æ˜¾ï¼š\n1. èµ„æºè¢«ä¸¥é‡æµªè´¹ï¼Œä¸¥é‡çš„æ¶åŒ–äº†èµ„æºçš„åˆ©ç”¨ç‡ã€‚\n2. ä½¿è¿›ç¨‹ç»å¸¸çš„å‘ç”Ÿé¥¥é¥¿ç°è±¡ã€‚\n\n### 6.3.1.2 ç¬¬äºŒç§åè®®\nè¯¥åè®®æ˜¯å¯¹ç¬¬ä¸€ç§åè®®çš„æ”¹è¿›ï¼Œå®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹åªè·å¾—è¿è¡ŒåˆæœŸæ‰€éœ€çš„èµ„æºåï¼Œä¾¿å¼€å§‹è¿è¡Œã€‚è¿›ç¨‹è¿è¡Œçš„è¿‡ç¨‹ä¸­å†é€æ­¥é‡Šæ”¾å·²åˆ†é…ç»™è‡ªå·±çš„ã€ä¸”å·²ç”¨æ¯•çš„å…¨éƒ¨èµ„æºï¼Œç„¶åå†è¯·æ±‚æ–°çš„æ‰€éœ€èµ„æºã€‚\n\n## 6.3.2 ç ´åâ€œä¸å¯æŠ¢å â€æ¡ä»¶\nä¸ºäº†èƒ½ç ´åâ€œä¸å¯æŠ¢å â€æ¡ä»¶ï¼Œåè®®ä¸­è§„å®šï¼Œå½“ä¸€ä¸ªå·²ç»ä¿æŒäº†æŸäº›ä¸å¯è¢«æŠ¢å èµ„æºçš„è¿›ç¨‹ï¼Œæå‡ºæ–°çš„èµ„æºè¯·æ±‚è€Œä¸èƒ½å¾—åˆ°æ»¡è¶³æ—¶ï¼Œä»–å¿…é¡»é‡Šæ”¾å·²ç»ä¿æŒçš„æ‰€æœ‰èµ„æºï¼Œå¾…ä»¥åéœ€è¦æ—¶å†é‡æ–°ç”³è¯·ã€‚è¿™æ„å‘³ç€è¿›ç¨‹å·²å æœ‰çš„èµ„æºä¼šè¢«æš‚æ—¶åœ°é‡Šæ”¾ï¼Œæˆ–è€…è¯´æ˜¯è¢«æŠ¢å äº†ï¼Œä»è€Œç ´åäº†â€œä¸å¯æŠ¢å â€æ¡ä»¶ã€‚\n\n## 6.3.3 ç ´åâ€œå¾ªç¯ç­‰å¾…â€æ¡ä»¶\nä¸€ä¸ªèƒ½ä¿è¯â€œå¾ªç¯ç­‰å¾…â€æ¡ä»¶ä¸æˆç«‹çš„æ–¹æ³•æ˜¯ï¼Œå¯¹ç³»ç»Ÿæ‰€æœ‰èµ„æºç±»å‹è¿›è¡Œçº¿æ€§æ’åºï¼Œå¹¶èµ‹äºˆä¸åŒçš„åºå·ã€‚æ’åºåï¼Œä¾¿å¯ä»¥é‡‡ç”¨è¿™æ ·çš„é¢„é˜²åè®®ï¼šè§„å®šæ¯ä¸ªè¿›ç¨‹å¿…é¡»æŒ‰ç…§åºå·çš„åœ°å€é¡ºåºæ¥è¯·æ±‚èµ„æºã€‚ä¸€ä¸ªè¿›ç¨‹åœ¨å¼€å§‹æ—¶ï¼Œå¯ä»¥è¯·æ±‚èµ„æº$R_i$çš„å•å…ƒï¼Œä»¥åï¼Œå½“ä¸”ä»…å½“$F(R_j)>F(R_i)$ï¼Œè¿›ç¨‹æ‰å¯ä»¥è¯·æ±‚èµ„æº$R_j$ã€‚å¦‚æœéœ€è¦å¤šä¸ªåŒç±»èµ„æºå•å…ƒï¼Œåˆ™å¿…é¡»ä¸€èµ·è¯·æ±‚ã€‚\n\n- ä¼˜ç‚¹ï¼šèµ„æºåˆ©ç”¨ç‡å’Œç³»ç»Ÿååé‡éƒ½æœ‰æ¯”è¾ƒæ˜æ˜¾çš„æ”¹å–„ã€‚\n- ç¼ºç‚¹ï¼š\n    1. ç³»ç»Ÿä¸­å„ç±»èµ„æºæ‰€è§„å®šçš„åºå·å¿…é¡»ç¨³å®šï¼Œè¿™å°±é™åˆ¶äº†æ–°ç±»å‹è®¾å¤‡çš„å¢åŠ \n    2. å¯èƒ½ä¼šå‘ç”Ÿä½œä¸šä½¿ç”¨å„ç±»èµ„æºçš„é¡ºåºä¸ç³»ç»Ÿè§„å®šçš„ä¸åŒï¼Œé€ æˆèµ„æºçš„æµªè´¹ã€‚\n    3. è¿™ç§æŒ‰ç…§è§„å®šæ¬¡åºç”³è¯·èµ„æºçš„æ–¹æ³•ä¼šé™åˆ¶ç”¨æˆ·ç®€å•ï¼Œè‡ªä¸»çš„ç¼–ç¨‹ã€‚\n\n# 6.4 é¿å…æ­»é”\n\n## 6.4.1 ç³»ç»Ÿå®‰å…¨çŠ¶æ€\nåœ¨æ­»é”é¿å…æ–¹æ³•ä¸­ï¼ŒæŠŠç³»ç»Ÿçš„çŠ¶æ€åˆ†ä¸ºå®‰å…¨çŠ¶æ€å’Œä¸å®‰å…¨çŠ¶æ€ã€‚å½“ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€æ—¶ï¼Œå¯é¿å…å‘ç”Ÿæ­»é”ã€‚åä¹‹ï¼Œå½“ç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€æ—¶ï¼Œåˆ™å¯èƒ½è¿›å…¥åˆ°æ­»é”çŠ¶æ€ã€‚\n\nåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå…è®¸è¿›ç¨‹åŠ¨æ€çš„ç”³è¯·èµ„æºå—ï¼Œä½†ç³»ç»Ÿåœ¨è¿›è¡Œèµ„æºåˆ†é…ä¹‹å‰ï¼Œåº”å…ˆè®¡ç®—æ­¤æ¬¡èµ„æºåˆ†é…çš„å®‰å…¨æ€§ã€‚è‹¥æ­¤æ¬¡åˆ†é…ä¸ä¼šå¯¼è‡´ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œæ‰å¯å°†èµ„æºåˆ†é…ç»™è¿›ç¨‹ï¼Œå¦åˆ™ï¼Œå¦è¿›ç¨‹ç­‰å¾…ã€‚\n\nå®‰å…¨çŠ¶æ€æ˜¯æŒ‡ç³»ç»Ÿèƒ½æŒ‰æŸç§è¿›ç¨‹æ¨è¿›é¡ºåºä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å…¶æ‰€éœ€èµ„æºï¼Œç›´è‡³æ»¡è¶³æ¯ä¸ªè¿›ç¨‹å¯¹èµ„æºçš„æœ€å¤§éœ€æ±‚ã€‚å¦‚æœæ— æ³•æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªåºåˆ—ï¼Œåˆ™ç§°ç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€ã€‚\n\n## 6.4.2 åˆ©ç”¨é“¶è¡Œå®¶ç®—æ³•é¿å…æ­»é”\nä¸ºå®ç°é“¶è¡Œå®¶ç®—æ³•ï¼Œæ¯ä¸€ä¸ªæ–°è¿›ç¨‹åœ¨è¿›å…¥ç³»ç»Ÿæ—¶ï¼Œä»–å¿…é¡»ç”³æ˜åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½éœ€è¦æ¯ç§èµ„æºç±»å‹çš„æœ€å¤§å•å…ƒæ•°ç›®ï¼Œå…¶æ•°ç›®ä¸åº”è¶…è¿‡ç³»ç»Ÿæ‰€æ‹¥æœ‰çš„èµ„æºæ€»é‡ã€‚å½“è¿›ç¨‹è¯·æ±‚ä¸€ç»„èµ„æºæ—¶ï¼Œç³»ç»Ÿå¿…é¡»é¦–å…ˆç¡®å®šæ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºåˆ†é…ç»™è¿›ç¨‹ã€‚è‹¥æœ‰ï¼Œå†è¿›ä¸€æ­¥è®¡ç®—åœ¨å°†è¿™äº›èµ„æºåˆ†é…ç»™è¿›ç¨‹åï¼Œæ˜¯å¦ä¼šä½¿ç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€ã€‚å¦‚æœä¸ä¼šï¼Œæ‰åˆ†é…èµ„æºã€‚\n\n### 6.4.2.1 é“¶è¡Œå®¶ç®—æ³•ä¸­çš„æ•°æ®ç»“æ„\n1. å¯åˆ©ç”¨èµ„æºå‘é‡Availableã€‚ä»£è¡¨ç³»ç»Ÿä¸­ç›®å‰å·²æœ‰çš„å¯åˆ†é…çš„è¯¥ç§èµ„æºçš„æœ€å¤§æ•°ã€‚\n2. æœ€å¤§éœ€æ±‚çŸ©é˜µMaxã€‚ä»£è¡¨è¯¥è¿›ç¨‹å¯¹è¯¥èµ„æºçš„æœ€å¤§éœ€æ±‚æ•°ã€‚\n3. åˆ†é…çŸ©é˜µAllocationã€‚ä»£è¡¨ç›®å‰å·²ç»åˆ†é…ç»™è¯¥è¿›ç¨‹çš„è¯¥èµ„æºçš„æ•°ç›®ã€‚\n4. éœ€æ±‚çŸ©é˜µNeedã€‚ä»£è¡¨è¯¥è¿›ç¨‹è¿˜éœ€è¦è¯¥èµ„æºçš„æ•°ç›®ã€‚\n\n### 6.4.2.2 é“¶è¡Œå®¶ç®—æ³•\nè®¾$Request_i$æ˜¯è¿›ç¨‹$P_i$çš„è¯·æ±‚å‘é‡ï¼Œå¦‚æœ$Request_i[j]=K$ï¼Œè¡¨ç¤ºè¿›ç¨‹$P_i$éœ€è¦$K$ä¸ª$R_j$ç±»å‹çš„èµ„æºã€‚å½“$P_i$å‘å‡ºèµ„æºè¯·æ±‚åï¼Œç³»ç»ŸæŒ‰ä¸‹è¿°æ­¥éª¤è¿›è¡Œæ£€æŸ¥ï¼š\n1. å¦‚æœ$Request_i[j] \\le Need[i, j]$ï¼Œä¾¿è½¬å‘æ­¥éª¤2ï¼›å¦åˆ™ä»»åŠ¡å‡ºé”™ï¼Œå› ä¸ºå®ƒæ‰€éœ€è¦çš„èµ„æºæ•°å·²è¶…è¿‡å®ƒæ‰€å®£å¸ƒçš„æœ€å¤§å€¼ã€‚\n2. å¦‚æœ$Request_i[j] \\le Available[j]$ï¼Œä¾¿è½¬å‘æ­¥éª¤3ï¼›å¦åˆ™ï¼Œè¡¨ç¤ºå°šæ— è¶³å¤Ÿèµ„æºï¼Œ$P_i$éœ€ç­‰å¾…ã€‚\n3. ç³»ç»Ÿè¯•æ¢ç€æŠŠèµ„æºåˆ†é…ç»™è¿›ç¨‹$P_i$ï¼Œå¹¶ä¿®æ”¹ä¸‹é¢æ•°æ®ç»“æ„ä¸­çš„æ•°å€¼ï¼šâ€¨$Available[j] = Available[j] - Request_i[j]$\n    $Allocation[i,j] = Allocation[i,j] + Request_i[j]$\n    $Need[i,j] = Need[i,j] - Request_i[j]$\n4. ç³»ç»Ÿæ‰§è¡Œå®‰å…¨æ€§ç®—æ³•ï¼Œæ£€æŸ¥æ­¤æ¬¡èµ„æºåˆ†é…åç³»ç»Ÿæ˜¯å¦å¤„äºå®‰å…¨çŠ¶æ€ã€‚è‹¥å®‰å…¨ï¼Œæ‰æ­£å¼å°†èµ„æºåˆ†é…ç»™è¿›ç¨‹$P_i$ï¼Œå·²å®Œæˆæœ¬æ¬¡åˆ†é…ï¼›å¦åˆ™ï¼Œå°†æœ¬æ¬¡çš„è¯•æ¢åˆ†é…ä½œåºŸï¼Œæ¢å¤åŸæ¥çš„èµ„æºåˆ†é…çŠ¶æ€ï¼Œè®©è¿›ç¨‹$P_i$ç­‰å¾…ã€‚\n\n### 6.4.2.3 å®‰å…¨æ€§ç®—æ³•\n1. è®¾ç½®ä¸¤ä¸ªå‘é‡ï¼šâ‘ å·¥ä½œå‘é‡Workï¼Œä»–è¡¨ç¤ºç³»ç»Ÿå¯æä¾›ç»™è¿›ç¨‹ç»§ç»­è¿è¡Œæ‰€éœ€çš„å„ç±»èµ„æºæ•°ç›®ï¼Œå®ƒå«æœ‰mä¸ªå…ƒç´ ï¼Œåœ¨æ‰§è¡Œå®‰å…¨ç®—æ³•å¼€å§‹æ—¶ï¼Œ$Word = Available$ï¼›â‘¡FInishï¼šä»–è¡¨ç¤ºç³»ç»Ÿæ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºåˆ†é…ç»™è¿›ç¨‹ï¼Œä½¿ä¹‹è¿è¡Œå®Œæˆã€‚å¼€å§‹æ—¶å…ˆåš$Finish[i] = false$ï¼›å½“æœ‰è¶³å¤Ÿèµ„æºåˆ†é…ç»™è¿›ç¨‹æ—¶ï¼Œå†ä»¤$Finish[i] = true$ã€‚\n2. ä»è¿›ç¨‹é›†åˆä¸­æ‰¾åˆ°ä¸€ä¸ªèƒ½æ»¡è¶³ä¸‹è¿°æ¡ä»¶çš„è¿›ç¨‹ï¼šâ‘ $Finish[i]=false$ï¼›â‘¡$Need[i,j] \\le Work[j]$ï¼›è‹¥æ‰¾åˆ°åˆ™æ‰§è¡Œæ­¥éª¤3ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤4.\n3. è‹¥è¿›ç¨‹$P_i$è·å¾—èµ„æºåï¼Œå¯é¡ºåˆ©æ‰§è¡Œï¼Œç›´è‡³å®Œæˆï¼Œå¹¶é‡Šæ”¾å‡ºåˆ†é…ç»™ä»–çš„èµ„æºï¼Œæ•…åº”æ‰§è¡Œï¼š\n    $Word[j] = Work[j] + Allocation[i,j];$\n    $Finish[i]=true;$\n    go to step 2;\n4. å¦‚æœæ‰€æœ‰è¿›ç¨‹çš„$Finish[i]=true$éƒ½æ»¡è¶³ï¼Œåˆ™è¡¨ç¤ºç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€ï¼›å¦åˆ™ï¼Œç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€ã€‚\n\n### 6.4.2.4 é“¶è¡Œå®¶ç®—æ³•ä¾‹å­\n#### é¢˜ç›®\nå‡å®šç³»ç»Ÿä¸­æœ‰äº”ä¸ªè¿›ç¨‹$\\{P_0, P_1, P_2, P_3, P_4\\}$å’Œä¸‰ç±»èµ„æº$\\{A, B, C\\}$ï¼Œå„ç§èµ„æºçš„æ•°é‡åˆ†åˆ«ä¸º10ã€5ã€7ï¼Œåœ¨$T_0$æ—¶åˆ»çš„èµ„æºåˆ†é…æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š\n![T0æ—¶åˆ»çš„èµ„æºåˆ†é…è¡¨](http://cdn.littlecorgi.top/mweb/2019-09-20/T0%E6%97%B6%E5%88%BB%E7%9A%84%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E8%A1%A8.png)\n\n#### åœ¨$T_0$æ—¶åˆ»çš„å®‰å…¨æ€§\nåˆ©ç”¨å®‰å…¨æ€§ç®—æ³•å¯¹$T_0$æ—¶åˆ»çš„èµ„æºåˆ†é…æƒ…å†µè¿›è¡Œåˆ†æå¯çŸ¥ï¼Œåœ¨$T_0$æ—¶åˆ»å­˜åœ¨ç€ä¸€ä¸ªå®‰å…¨åºåˆ—$\\{P_1,P_3,P_4,P_2,P_0\\}$ï¼Œæ•…ç³»ç»Ÿæ˜¯å®‰å…¨çš„ã€‚\n![T0æ—¶åˆ»çš„å®‰å…¨åºåˆ—](http://cdn.littlecorgi.top/mweb/2019-09-20/T0%E6%97%B6%E5%88%BB%E7%9A%84%E5%AE%89%E5%85%A8%E5%BA%8F%E5%88%97.png)\n\n\n#### $P_1$è¯·æ±‚èµ„æº\n$P_1$å‘å‡ºè¯·æ±‚å‘é‡$Request_1(1,0,2)$ï¼Œç³»ç»ŸæŒ‰é“¶è¡Œå®¶ç®—æ³•è¿›è¡Œæ£€æŸ¥ï¼š\nâ‘ $Request_1(1,0,2) \\le Need_1(1,2,2)$ï¼›\nâ‘¡$Request_1(1,0,2) \\le Available_1(3,3,2)$ï¼›\nâ‘¢ç³»ç»Ÿå…ˆå‡å®šå¯ä¸º$P_1$åˆ†é…èµ„æºï¼Œå¹¶ä¿®æ”¹$Avaliable$ï¼Œ$Allocation_1$å’Œ$Need_1$å‘é‡ï¼Œç”±æ­¤å½¢æˆçš„èµ„æºå˜åŒ–æƒ…å†µå¦‚1å›¾ä¸­çš„åœ†æ‹¬å·æ‰€ç¤ºï¼›\nâ‘£å†åˆ©ç”¨å®‰å…¨æ€§ç®—æ³•æ£€æŸ¥æ­¤æ—¶ç³»ç»Ÿæ˜¯å¦å®‰å…¨ï¼Œå¦‚å›¾æ‰€ç¤º\n![P1ç”³è¯·èµ„æºæ—¶çš„å®‰å…¨æ€§æ£€æŸ¥](http://cdn.littlecorgi.top/mweb/2019-09-20/P1%E7%94%B3%E8%AF%B7%E8%B5%84%E6%BA%90%E6%97%B6%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E6%A3%80%E6%9F%A5.png)\n\næœ‰æ‰€è¿›è¡Œçš„å®‰å…¨æ€§æ£€æŸ¥å¾—çŸ¥ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå®‰å…¨åºåˆ—$\\{P_1,P_3,P_4,P_2,P_0\\}$ã€‚å› æ­¤ï¼Œç³»ç»Ÿæ˜¯å®‰å…¨çš„ï¼Œå¯ä»¥ç«‹å³å°†$P_1$æ‰€ç”³è¯·çš„èµ„æºåˆ†é…ç»™å®ƒã€‚\n#### $P_4$è¯·æ±‚èµ„æº\n$P_4$å‘å‡ºè¯·æ±‚å‘é‡$Request_4(3,3,0)$ï¼Œç³»ç»ŸæŒ‰é“¶è¡Œå®¶ç®—æ³•è¿›è¡Œæ£€æŸ¥ï¼š\nâ‘ $Request_4(3,3,0) \\le Need_4(4,3,1)$ï¼›\nâ‘¡$Request_4(3,3,0) \\ge Available(2,3,0)$ï¼Œè®©$P_4$ç­‰å¾…ã€‚\n\n#### $P_0$è¯·æ±‚èµ„æº\n$P_0$å‘å‡ºè¯·æ±‚å‘é‡$Request_0(0,2,0)$ï¼Œç³»ç»ŸæŒ‰é“¶è¡Œå®¶ç®—æ³•è¿›è¡Œæ£€æŸ¥ï¼š\nâ‘ $Request_0(0,2,0) \\le Need_0(7,4,3)$ï¼›\nâ‘¡$Request_0(0,2,0) \\le Available(2,3,0)$ï¼›\nâ‘¢ç³»ç»Ÿæš‚æ—¶å…ˆå‡å®šå¯ä¸º$P_0$åˆ†é…èµ„æºï¼Œå¹¶ä¿®æ”¹æœ‰å…³æ•°æ®ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n![ä¸ºP0åˆ†é…èµ„æºåçš„æœ‰å…³èµ„æºæ•°æ®](http://cdn.littlecorgi.top/mweb/2019-09-20/%E4%B8%BAP0%E5%88%86%E9%85%8D%E8%B5%84%E6%BA%90%E5%90%8E%E7%9A%84%E6%9C%89%E5%85%B3%E8%B5%84%E6%BA%90%E6%95%B0%E6%8D%AE.png)\n\n#### è¿›å…¥å®‰å…¨æ€§æ£€æŸ¥\nå¯ç”¨èµ„æº$Available(2,1,0)$å·²ä¸èƒ½æ»¡è¶³ä»»ä½•è¿›ç¨‹çš„éœ€è¦ï¼Œæ•…ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œæ­¤æ—¶ç³»ç»Ÿä¸åˆ†é…èµ„æºã€‚","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"æ“ä½œç³»ç»Ÿ5--å¤„ç†æœºè°ƒåº¦","url":"/posts/8b4e2673.html","content":">å¤§å®¶å¯ä»¥çœ‹ä¸‹æˆ‘ä½¿ç”¨å¹•å¸ƒè½¯ä»¶ç”»çš„[æ€ç»´å¯¼å›¾](https://mubu.com/doc/3Pf0zwzrgw)ï¼Œå¦‚æœå¤§å®¶æƒ³ä½¿ç”¨å¹•å¸ƒå¯ä»¥é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œï¼Œå¯å…è´¹è·å¾—ä¸€ä¸ªæœˆé«˜çº§ä¼šå‘˜https://mubu.com/inv/477598\n<!-- More -->\n\nåœ¨å¤šé“ç¨‹åºä¸­ï¼Œè°ƒåº¦çš„å®è´¨æ˜¯ä¸€ç§èµ„æºåˆ†é…ï¼Œå¤„ç†æœºè°ƒåº¦æ˜¯å¯¹å¤„ç†æœºèµ„æºè¿›è¡Œåˆ†é…ã€‚\n\n# 5.1 å¤„ç†æœºè°ƒåº¦çš„å±‚æ¬¡å’Œè°ƒåº¦ç®—æ³•çš„ç›®æ ‡\nåœ¨å¤šé“æ‰¹å¤„ç†ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªä½œä¸šä»æäº¤åˆ°è·å¾—å¤„ç†æœºæ‰§è¡Œï¼Œç›´è‡³ä½œä¸šè¿è¡Œå®Œæˆï¼Œå¯èƒ½éœ€è¦ç»å†å¤šæ¬¡å¤„ç†æœºè°ƒåº¦ã€‚\n\n## 5.1.1 å¤„ç†æœºè°ƒåº¦çš„å±‚æ¬¡\n1. é«˜çº§è°ƒåº¦\n    é«˜çº§è°ƒåº¦åˆç§°ä¸ºé•¿ç¨‹è°ƒåº¦æˆ–ä½œä¸šè°ƒåº¦ï¼Œä»–çš„è°ƒåº¦å¯¹è±¡æ˜¯ä½œä¸šã€‚ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®æŸç§ç®—æ³•ï¼Œå†³å®šå°†å¤–å­˜ä¸Šå¤„äºåå¤‡é˜Ÿåˆ—ä¸­çš„å“ªå‡ ä¸ªä½œä¸šè°ƒå…¥å†…å­˜ã€ä¸ºä»–ä»¬åˆ›å»ºè¿›ç¨‹ï¼Œåˆ†é…å¿…è¦çš„èµ„æºï¼Œå¹¶å°†ä»–ä»¬æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ã€‚\n    \n2. ä½çº§è°ƒåº¦\n    ä½çº§è°ƒåº¦åˆç§°ä¸ºçŸ­ç¨‹è°ƒåº¦æˆ–ä½œä¸šè°ƒåº¦ï¼Œä»–çš„è°ƒåº¦å¯¹è±¡æ˜¯è¿›ç¨‹ã€‚ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®æŸç§ç®—æ³•ï¼Œå†³å®šå°±ç»ªé˜Ÿåˆ—ä¸­å“ªä¸ªè¿›ç¨‹åº”è·å¾—å¤„ç†æœºï¼Œå¹¶ç”±åˆ†æ´¾ç¨‹åºå°†å¤„ç†æœºåˆ†é…ç»™è¢«é€‰ä¸­çš„è¿›ç¨‹ã€‚\n    \n3. ä¸­çº§è°ƒåº¦\n    ä¸­çº§è°ƒåº¦åˆç§°ä¸ºå†…å­˜è°ƒåº¦ã€‚ä¸»è¦åŠŸèƒ½æ˜¯å°†é‚£äº›æš‚æ—¶ä¸èƒ½è¿è¡Œçš„è¿›ç¨‹ï¼Œè°ƒè‡³å¤–å­˜ç­‰å¾…ï¼Œå½“ä»–ä»¬å…·å¤‡è¿è¡Œæ¡ä»¶ä¸”å†…å­˜åˆç¨æœ‰ç©ºé—²æ—¶å†è°ƒå…¥å†…å­˜ã€‚\n\n## 5.1.2 å¤„ç†æœºè°ƒåº¦ç®—æ³•çš„ç›®æ ‡\n\n### 5.1.2.1 å¤„ç†æœºè°ƒåº¦ç®—æ³•çš„å…±åŒç›®æ ‡\n1. èµ„æºåˆ©ç”¨ç‡\n    ç³»ç»Ÿä¸­çš„å¤„ç†æœºå’Œå…¶å®ƒæ‰€æœ‰èµ„æºåº”å°½å¯èƒ½ä¿æŒå¿™ç¢ŒçŠ¶æ€ï¼Œå…¶ä¸­æœ€é‡è¦çš„å¤„ç†æœºåˆ©ç”¨ç‡å¯ç”¨ä»¥ä¸‹æ–¹å¼è®¡ç®—ï¼š\n    $$ CPUçš„åˆ©ç”¨ç‡=\\frac{CPUæœ‰æ•ˆå·¥ä½œæ—¶é—´}{CPUæœ‰æ•ˆå·¥ä½œæ—¶é—´+CPUç©ºé—²ç­‰å¾…æ—¶é—´} $$\n2. å…¬å¹³æ€§\n    ç³»ç»Ÿä¸­çš„æ‰€æœ‰çš„è¿›ç¨‹éƒ½åº”è¯¥è·å¾—åˆç†çš„CPUæ—¶é—´ï¼Œä¸ä¼šå‘ç”Ÿè¿›ç¨‹é¥¥é¥¿ç°è±¡ã€‚ï¼Œå¯¹åŒç±»å‹çš„è¿›ç¨‹è·å¾—ç›¸åŒçš„æœåŠ¡ï¼›ä¸åŒç±»å‹çš„è¿›ç¨‹ï¼Œç”±äºç´§æ€¥ç¨‹åº¦ä¸åŒæˆ–è€…é‡è¦æ€§ä¸åŒï¼Œåº”æä¾›ä¸åŒçš„æœåŠ¡ã€‚\n3. å¹³è¡¡æ€§\n    ç³»ç»Ÿä¸­å¯èƒ½å…·æœ‰å¤šç§ç±»å‹çš„è¿›ç¨‹ï¼Œæœ‰çš„æ˜¯è®¡ç®—å‹ä½œä¸šï¼Œæœ‰çš„æ˜¯I/Oå‹ä½œä¸šã€‚ä¸ºäº†ä½¿CPUå’Œèµ„æºå°½å¯èƒ½çš„å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œè°ƒåº¦ç®—æ³•åº”å°½å¯èƒ½çš„ä¿æŒç³»ç»Ÿèµ„æºä½¿ç”¨çš„å¹³è¡¡æ€§ã€‚\n\n4. ç­–ç•¥å¼ºåˆ¶æ‰§è¡Œ\n    å¯¹æ‰€å®šåˆ¶çš„ç­–ç•¥ï¼Œåªè¦éœ€è¦ï¼Œå°±å¿…é¡»å‡†ç¡®çš„æ‰§è¡Œã€‚\n\n### 5.1.2.2 æ‰¹å¤„ç†ç³»ç»Ÿçš„ç›®æ ‡\n1. å¹³å‡å‘¨è½¬æ—¶é—´æ®µ\n    å‘¨è½¬æ—¶é—´ï¼Œæ˜¯æŒ‡ä»ä½œä¸šè¢«æäº¤ç»™ç³»ç»Ÿï¼Œç›´åˆ°ä½œä¸šæ‰§è¡Œå®Œæ¯•æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚\n    å¯¹äºæ¯ä¸ªç”¨æˆ·æ¥è¨€ï¼Œéƒ½å¸Œæœ›è‡ªå·±çš„å‘¨è½¬æ—¶é—´æœ€çŸ­ï¼›ä½†æ˜¯å¯¹äºç³»ç»Ÿæ¥è¨€ï¼Œä»–è¦æ±‚çš„æ˜¯å¹³å‡å‘¨è½¬æ—¶é—´æœ€çŸ­ï¼Œè¿™ä¸ä»…å¯ä»¥æé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡ï¼Œè€Œä¸”è¿˜å¯ä½¿å¤§å¤šæ•°ç”¨æˆ·éƒ½æ„Ÿåˆ°æ»¡æ„ã€‚\n    å¯æŠŠå‘¨è½¬æ—¶é—´æè¿°ä¸ºï¼š\n    $$ T=\\frac{1}{n}[\\sum_{i=1}^{n}{T_i}] $$\n    ä¸ºäº†è¿›ä¸€æ­¥ååº”è°ƒåº¦çš„æ€§èƒ½ï¼Œæ›´æ¸…æ¥šçš„æè¿°å„è¿›ç¨‹åœ¨å…¶å‘¨è½¬æ—¶é—´ä¸­ï¼Œç­‰å¾…å’Œæ‰§è¡Œæ—¶é—´çš„å…·ä½“åˆ†é…æƒ…å†µï¼Œå¾€å¾€ä½¿ç”¨å¸¦æƒå‘¨è½¬æ—¶é—´ï¼Œå³ä½œä¸šå‘¨è½¬æ—¶é—´Tä¸ç³»ç»Ÿä¸ºä»–æä¾›çš„æ—¶é—´Tsä¹‹æ¯”ï¼Œå³$ W=\\frac{T}{T_s} $ï¼Œå¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´å¯è¡¨ç¤ºä¸ºï¼š\n    $$ W = \\frac{1}{n}\\sum_{i=1}^{n}\\frac{T_i}{T_s} $$\n2. ç³»ç»Ÿååé‡é«˜\n\n3. å¤„ç†æœºåˆ©ç”¨ç‡é«˜\n\n### 5.1.2.3 åˆ†æ—¶ç³»ç»Ÿçš„ç›®æ ‡\n1. ç›¸åº”äº‹æ—¶é—´å¿«\n    å“åº”æ—¶é—´æ˜¯æŒ‡ä»ç”¨æˆ·é€šè¿‡é”®ç›˜æäº¤ä¸€ä¸ªè¯·æ±‚å¼€å§‹ï¼Œç›´åˆ°å±å¹•ä¸Šæ˜¾ç¤ºå‡ºå¤„ç†ç»“æœä¸ºä¹‹çš„ä¸€æ®µæ—¶é—´é—´éš”ï¼Œå®ƒåŒ…æ‹¬ä¸‰éƒ¨åˆ†æ—¶é—´ï¼šä¸€æ˜¯è¯·æ±‚ä¿¡æ¯ä»é”®ç›˜è¾“å…¥å¼€å§‹ï¼Œç›´è‡³å°†å…¶ä¼ é€åˆ°å¤„ç†æœºçš„æ—¶é—´ï¼›äºŒæ˜¯å¤„ç†æœºå¯¹è¯·æ±‚ä¿¡æ¯è¿›è¡Œå¤„ç†çš„æ—¶é—´ï¼›ä¸‰æ˜¯å°†æ‰€å½¢æˆçš„çš„å“åº”ä¿¡æ¯å›é€åˆ°ç»ˆç«¯æ˜¾ç¤ºå™¨çš„æ—¶é—´ã€‚\n    \n2. å‡è¡¡æ€§\n    ç”¨æˆ·å¯¹å“åº”æ—¶é—´çš„è¦æ±‚å¹¶éå®Œå…¨ç›¸åŒã€‚é€šå¸¸ï¼Œç”¨æˆ·å¯¹äºå¤æ‚çš„çš„ä½œä¸šï¼Œå“åº”æ—¶é—´å…è®¸è¾ƒé•¿ï¼›å¯¹äºç®€å•çš„ä½œä¸šï¼Œå“åº”æ—¶é—´åˆ™è¦çŸ­ã€‚\n\n### 5.1.2.4 å®æ—¶ç³»ç»Ÿçš„ç›®æ ‡\n1. æˆªæ­¢æ—¶é—´çš„ä¿è¯\n    æˆªæ­¢æ—¶é—´æ˜¯æŒ‡æŸä»»åŠ¡å¿…é¡»å¼€å§‹æ‰§è¡Œçš„æœ€è¿Ÿæ—¶é—´ï¼Œæˆ–è€…å¿…é¡»å®Œæˆçš„æœ€è¿Ÿæ—¶é—´ã€‚\n2. å¯é¢„æµ‹æ€§\n\n\n# 5.2 ä½œä¸šä¸ä½œä¸šè°ƒåº¦\næˆ‘ä»¬å‰é¢è®²åˆ°è¿‡ï¼Œåœ¨å¤šé“æ‰¹å¤„ç†ç³»ç»Ÿä¸­ï¼Œä½œä¸šç”±ç”¨æˆ·æäº¤ç»™ç³»ç»Ÿæ“ä½œå‘˜ï¼Œå†ç”±ç³»ç»Ÿæ“ä½œå‘˜æŠŠä½œä¸šè¾“å…¥ç»™ç›¸åº”çš„è¾“å…¥è®¾å¤‡ï¼Œå¹¶ä¿å­˜åœ¨ä¸€ä¸ªåå¤‡é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°±ç”±ä½œä¸šè°ƒåº¦ç¨‹åºå°†å…¶ä»å¤–å­˜è°ƒå…¥å†…å­˜å†æ¥è¿›è¡Œå¤„ç†ã€‚\n\n## 5.2.1 ä½œä¸š\n### 5.2.1.1 ä½œä¸šå’Œä½œä¸šæ­¥\n1. ä½œä¸š\n    ä½œä¸šä¸€èˆ¬åŒ…æ‹¬ç¨‹åºè¿˜æ•°æ®ï¼Œè¿˜åº”é…æœ‰ä¸€ä»½ä½œä¸šè¯´æ˜ä¹¦ï¼Œç³»ç»Ÿæ ¹æ®è¯¥è¯´æ˜ä¹¦æ¥å¯¹ç¨‹åºçš„è¿è¡Œè¿›è¡Œæ§åˆ¶ã€‚\n    \n2. ä½œä¸šæ­¥\n    åœ¨ä½œä¸šè¿è¡ŒæœŸé—´ï¼Œæ¯ä¸ªä½œä¸šéƒ½å¿…é¡»ç»è¿‡è‹¥å¹²ä¸ªç›¸å¯¹ç‹¬ç«‹ï¼Œåˆç›¸äº’å…³è”çš„é¡ºåºåŠ å·¥æ­¥éª¤æ‰èƒ½å¾—åˆ°ç»“æœã€‚æˆ‘ä»¬æŠŠå…¶ä¸­çš„æ¯ä¸€ä¸ªåŠ å·¥æ­¥éª¤ç§°ä¸ºä¸€ä¸ªä½œä¸šæ­¥ã€‚\n\n### 5.2.1.2 ä½œä¸šæ§åˆ¶å—JCB\nä¸ºäº†ç®¡ç†å’Œè°ƒåº¦ä½œä¸šï¼Œåœ¨å¤šé“æ‰¹å¤„ç†ç³»ç»Ÿä¸­ï¼Œä¸ºæ¯ä¸ªä½œä¸šè®¾ç½®äº†ä¸€ä¸ªä½œä¸šæ§åˆ¶å—JCBï¼Œå¥¹æ˜¯ä½œä¸šåœ¨ç³»ç»Ÿä¸­å­˜åœ¨çš„æ ‡å¿—ï¼Œå…¶ä¸­ä¿å­˜äº†ç³»ç»Ÿå¯¹ä½œä¸šè¿›è¡Œç®¡ç†å’Œè°ƒåº¦æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ã€‚\né€šå¸¸å†…å®¹æœ‰ä½œä¸šæ ‡è¯†ã€ç”¨æˆ·åç§°ã€ç”¨æˆ·è´¦å·ã€ä½œä¸šç±»å‹ã€ä½œä¸šçŠ¶æ€ã€è°ƒåº¦ä¿¡æ¯ã€èµ„æºéœ€æ±‚ã€èµ„æºä½¿ç”¨æƒ…å†µç­‰ã€‚\n\n### 5.2.1.3 ä½œä¸šè¿è¡Œçš„ä¸‰ä¸ªé˜¶æ®µå’Œä¸‰ç§çŠ¶æ€\n1. æ”¶å®¹é˜¶æ®µ\n    æ“ä½œå‘˜æŠŠç”¨æˆ·æäº¤çš„ä½œä¸šé€šè¿‡æŸç§è¾“å…¥æ–¹å¼æˆ–SPOOLingç³»ç»Ÿè¾“å…¥åˆ°ç¡¬ç›˜ä¸Šï¼Œå†ä¸ºæ”¹ä½œä¸šå»ºç«‹PCBï¼Œå¹¶æŠŠå®ƒæ”¾å…¥ä½œä¸šåå¤‡é˜Ÿåˆ—ä¸­ã€‚ä½œä¸šæ­¤æ—¶çš„çŠ¶æ€ä¸º**åå¤‡çŠ¶æ€**\n2. è¿è¡Œé˜¶æ®µ\n    å½“ä½œä¸šè¢«ä½œä¸šè°ƒåº¦é€‰ä¸­åï¼Œå˜ä¸ºå®ƒåˆ†é…å¿…è¦çš„èµ„æºå’Œå»ºç«‹è¿›ç¨‹ï¼Œå¹¶å°†å®ƒæ”¾å…¥å°±ç»ªé˜Ÿåˆ—ã€‚ä¸€ä¸ªä½œä¸šä»ç¬¬ä¸€æ¬¡è¿›å…¥å°±ç»ªçŠ¶æ€å¼€å§‹ï¼ŒçŸ¥é“ä»–è¿è¡Œç»“æŸå‰ï¼Œéƒ½å¤„äº**è¿è¡ŒçŠ¶æ€**\n3. å®Œæˆé˜¶æ®µ\n    å½“ä½œä¸šè¿è¡Œå®Œæˆï¼Œæˆ–è€…å‘ç”Ÿå¼‚å¸¸æƒ…å†µæå‰ç»“æŸæ—¶ï¼Œä½œä¸šä¾¿è¿›å…¥å®Œæˆé˜¶æ®µï¼Œç›¸åº”çš„ä½œä¸šçŠ¶æ€ä¸ºâ€œå®ŒæˆçŠ¶æ€â€ã€‚\n\n## 5.2.2 ä½œä¸šè°ƒåº¦çš„ä¸»è¦ä»»åŠ¡\nä½œä¸šè°ƒåº¦çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯æ ¹æ®JCBä¸­çš„å†…å®¹ï¼Œæ£€æŸ¥ç³»ç»Ÿä¸­çš„èµ„æºèƒ½å¦æ»¡è¶³ä½œä¸šå¯¹èµ„æºçš„éœ€æ±‚ï¼Œä»¥åŠæŒ‰ç…§ä¸€å®šçš„è°ƒåº¦ç®—æ³•ï¼Œä»å¤–å­˜çš„åå¤‡é˜Ÿåˆ—ä¸­é€‰å–æŸäº›ä½œä¸šè°ƒå…¥å†…å­˜ã€‚å¹¶ä¸ºå®ƒä»¬åˆ›å»ºè¿›ç¨‹ã€åˆ†é…å¿…è¦çš„èµ„æºã€‚ç„¶åå†å°†æ–°åˆ›å»ºçš„è¿›ç¨‹æ’åœ¨å°±ç»ªé˜Ÿåˆ—ä¸Šç­‰å¾…è°ƒåº¦ã€‚å› æ­¤ï¼Œä¹ŸæŠŠä½œä¸šè°ƒåº¦ç§°ä¸ºæ¥çº³è°ƒåº¦ã€‚åœ¨æ¯æ¬¡æ‰§è¡Œä½œä¸šè°ƒåº¦æ—¶ï¼Œéƒ½éœ€è¦åšå‡ºä»¥ä¸‹ä¸¤ä¸ªå†³å®šï¼š\n1. æ¥çº³å¤šå°‘ä¸ªä½œä¸š\n    åœ¨æ¯ä¸€æ¬¡ä½œä¸šè°ƒåº¦æ—¶ï¼Œåº”å½“ä»åå¤‡é˜Ÿåˆ—ä¸­é€‰å–å¤šå°‘ä½œä¸šè°ƒå…¥å†…å­˜ï¼Œå–å†³äºå¤šé“ç¨‹åºåº¦ï¼Œå³å…è®¸å¤šå°‘ä¸ªä½œä¸šåŒæ—¶åœ¨å†…å­˜ä¸­è¿è¡Œã€‚\n2. æ¥çº³å“ªäº›ä½œä¸š\n    é€‰æ‹©å“ªäº›ä½œä¸šå–å†³äºï¼Œä½œä¸šè°ƒåº¦é‡‡ç”¨å“ªç§ç®—æ³•ã€‚\n    \n# 5.3 ä½œä¸šè°ƒåº¦ç®—æ³•\n## 5.3.1 å…ˆæ¥å…ˆæœåŠ¡ï¼ˆFCFSï¼‰ç®—æ³•ç®—æ³•\nå¯¹äºè¿™ä¸ªç®—æ³•ï¼Œå…«ä¸ªå­—â€”â€”ç®€å•ç²—æš´ï¼Œæ²¡å•¥å¯è®²ã€‚ä½ æ¥çš„æ—©æˆ‘å°±å…ˆæœåŠ¡ä½ ï¼Œå…¶ä»–äººä¸ç®¡å†ç‰›é€¼ä½ æ¥æ™šäº†ä½ å°±æ˜¯å¼Ÿå¼Ÿï¼Œä½ å¾—ç­‰æˆ‘å…ˆæŠŠå‰é¢è¿™ä½æœåŠ¡å¥½äº†å†æ¥æœåŠ¡ä½ ã€‚\n\n## 5.3.2 çŸ­ä½œä¸šä¼˜å…ˆï¼ˆSJFï¼‰è°ƒåº¦ç®—æ³•\nå¯¹äºè¿™ä¸ªç®—æ³•ï¼Œä»–ä¹Ÿæ˜¯åŸºäºå…ˆæ¥å…ˆæœåŠ¡ï¼Œåªæ˜¯å¤šäº†ä¸ªè€ƒè™‘èŒƒå›´ï¼Œå°±æ˜¯åŸåˆ™ä¸Šè¿˜æ˜¯å…ˆåˆ°å…ˆæœåŠ¡ï¼Œä½†æ˜¯å½“æœåŠ¡å®Œä¸€ä¸ªä¹‹åå¹¶ä¸”è¿˜æœ‰å¾ˆå¤šä¸ªå†ç­‰ç€è¢«æœåŠ¡æ—¶ï¼Œå°±ä»ä¸­æ‰¾ä¸€ä¸ªéœ€è¦æœåŠ¡æ—¶é—´æœ€çŸ­çš„å…ˆæ¥æœåŠ¡ï¼ŒæœåŠ¡å®Œä»–äº†ï¼Œåœ¨ä»å‰©ä¸‹çš„æ‰¾ä¸€ä¸ªæœ€çŸ­çš„æ¥æœåŠ¡ã€‚\nè¿™ä¸ªç®—æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š\n1. å¿…é¡»é¢„çŸ¥ä½œä¸šçš„è¿è¡Œæ—¶é—´\n2. å¯¹é•¿ä½œä¸šå¾ˆä¸åˆ©\n3. äººæœºæ— æ³•äº¤äº’\n4. æ²¡æœ‰è€ƒè™‘ä½œä¸šæ‰§è¡Œçš„ç´§è¿«æ„Ÿï¼Œå¯¹æ€¥éœ€æœåŠ¡çš„ä½œä¸šä¸ç®¡\n\n## 5.3.3 ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ï¼ˆPSAï¼‰\nåœ¨ä¼˜å…ˆçº§ç®—æ³•ä¸­ï¼ŒåŸºäºä½œä¸šçš„ç´§è¿«ç¨‹åº¦ï¼Œå¤–éƒ¨ä¼šèµ‹äºˆè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œç„¶åä¼˜å…ˆçº§ç®—æ³•å°±æ ¹æ®ç®—æ³•çš„ä¼˜å…ˆçº§ï¼Œè¿›è¡Œè°ƒåº¦ã€‚ç®—æ³•å®è´¨ä¸Šç±»ä¼¼äºçŸ­ä½œä¸šä¼˜å…ˆï¼Œä½ ç”šè‡³å¯ä»¥æŠŠçŸ­ä½œä¸šä¼˜å…ˆçº§ç®—æ³•ä¹Ÿçœ‹åšæ˜¯ä¼˜å…ˆçº§ç®—æ³•ï¼Œåªä¸è¿‡ä»–çš„ä¼˜å…ˆçº§æ˜¯ä½œä¸šé•¿çŸ­ï¼Œè€Œä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•çš„ä¼˜å…ˆçº§æ˜¯è¿›ç¨‹çš„ç´§è¿«ç¨‹åº¦ã€‚\n\n## 5.3.4 é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼ˆHRRNï¼‰\nFCFSç®—æ³•æ˜¯è€ƒè™‘äº†ä½œä¸šçš„ç­‰å¾…æ—¶é—´ï¼Œå´å¿½ç•¥çš„ä½œä¸šçš„è¿è¡Œæ—¶é—´ï¼›è€ŒSJFç®—æ³•æ˜¯åªè€ƒè™‘äº†ä½œä¸šçš„è¿è¡Œæ—¶é—´ï¼Œå´å¿½ç•¥äº†ä½œä¸šçš„ç­‰å¾…æ—¶é—´ã€‚é«˜å“åº”æ¯”ç®—æ³•æ˜¯åˆè€ƒè™‘è¿è¡Œæ—¶é—´åˆè€ƒè™‘ç­‰å¾…æ—¶é—´ï¼Œå› æ­¤æ—¢èƒ½ç…§é¡¾çŸ­ä½œä¸šï¼Œåˆä¸è‡´ä½¿é•¿ä½œä¸šçš„ç­‰å¾…æ—¶é—´è¿‡é•¿ã€‚\n\nä»–ä¸ºæ¯ä¸ªä½œä¸šå¼•å…¥äº†ä¸€ä¸ªåŠ¨æ€ä¼˜å…ˆçº§ï¼Œå³ä¼˜å…ˆçº§æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œå®ƒéšç€ç­‰å¾…æ—¶é—´çš„å»¶é•¿è€Œå¢åŠ ï¼Œè¿™ä½¿å¾—é•¿ä½œä¸šçš„ä¼˜å…ˆçº§åœ¨ç­‰å¾…æœŸé—´ä¸æ–­åœ°å¢åŠ ï¼Œç­‰åˆ°è¶³å¤Ÿçš„æ—¶é—´åï¼Œå¿…ç„¶æœ‰æœºä¼šè·å¾—å¤„ç†æœºã€‚è¿™ä¸ªå˜åŒ–è§„å¾‹å¯æè¿°ä¸ºï¼š\n$$ ä¼˜å…ˆçº§=\\frac{ç­‰å¾…æ—¶é—´+è¦æ±‚æœåŠ¡æ—¶é—´}{è¦æ±‚æœåŠ¡æ—¶é—´} $$\n\nç”±äºç­‰å¾…æ—¶é—´ä¸æœåŠ¡æ—¶é—´ä¹‹å’Œå°±æ˜¯ç³»ç»Ÿå¯¹è¯¥ä½œä¸šçš„å“åº”æ—¶é—´ï¼Œæ•…è¯¥ä¼˜å…ˆçº§åˆç›¸å½“äºå“åº”æ¯”$R_p$ã€‚æ‰€ä»¥ï¼Œä¼˜å…ˆçº§åˆå¯è¡¨ç¤ºä¸ºï¼š$$ R_p=\\frac{ç­‰å¾…æ—¶é—´+è¦æ±‚æœåŠ¡æ—¶é—´}{è¦æ±‚æœåŠ¡æ—¶é—´}=\\frac{å“åº”æ—¶é—´}{è¦æ±‚æœåŠ¡æ—¶é—´} $$\n\nä»ä¸Šé¢å¯ä»¥çœ‹å‡º\n1. å¦‚æœä½œä¸šçš„ç­‰å¾…æ—¶é—´ç›¸åŒï¼Œåˆ™è¦æ±‚æœåŠ¡çš„æ—¶é—´è¶ŠçŸ­ï¼Œä¼˜å…ˆçº§è¶Šé«˜\n2. å½“è¦æ±‚æœåŠ¡æ—¶é—´ç›¸åŒæ—¶ï¼Œä½œä¸šçš„ä¼˜å…ˆçº§å†³å®šäºå…¶ç­‰å¾…æ—¶é—´\n3. å¯¹äºé•¿ä½œä¸šçš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥éšç­‰å¾…æ—¶é—´çš„å¢åŠ è€Œæé«˜\n\n# 5.4 è¿›ç¨‹è°ƒåº¦\n## 5.4.1 è¿›ç¨‹è°ƒåº¦çš„ä»»åŠ¡ã€æœºåˆ¶å’Œæ–¹å¼\n### 5.4.1.1 è¿›ç¨‹è°ƒåº¦çš„ä»»åŠ¡\n1. ä¿å­˜å¤„ç†æœºçš„ç°åœºä¿¡æ¯\n    åœ¨è¿›è¡Œè°ƒåº¦æ—¶é¦–å…ˆéœ€è¦ä¿å­˜å½“å‰è¿›ç¨‹å¤„ç†æœºçš„ç°åœºä¿¡æ¯ã€‚\n2. æŒ‰æŸç§ç®—æ³•é€‰å–è¿›ç¨‹\n    è°ƒåº¦ç¨‹åºæŒ‰æŸç§ç®—æ³•ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰å–ä¸€ä¸ªè¿›ç¨‹ï¼Œå°†å…¶çŠ¶æ€æ”¹ä¸ºè¿è¡ŒçŠ¶æ€ï¼Œå¹¶å‡†å¤‡æŠŠå¤„ç†æœºåˆ†é…ç»™ä»–ã€‚\n3. æŠŠå¤„ç†æœºåˆ†é…ç»™è¿›ç¨‹\n    ç”±åˆ†æ´¾ç¨‹åºæŠŠå¤„ç†å™¨åˆ†é…ç»™è¯¥è¿›ç¨‹ï¼Œæ­¤æ—¶éœ€è¦å°†é€‰ä¸­è¿›ç¨‹çš„è¿›ç¨‹æ§åˆ¶å—å†…æœ‰å…³å¤„ç†æœºç°åœºçš„ä¿¡æ¯è£…å…¥å¤„ç†å™¨ç›¸åº”çš„å„ä¸ªå¯„å­˜å™¨ä¸­ï¼ŒæŠŠå¤„ç†å™¨çš„æ§åˆ¶æƒäº¤äºˆè¯¥è¿›ç¨‹ï¼Œè®©å®ƒä»ä¸Šæ¬¡çš„æ–­ç‚¹å¤„æ¢å¤è¿è¡Œã€‚\n    \n### 5.4.1.2 è¿›ç¨‹è°ƒåº¦æœºåˆ¶\nä¸ºäº†å®ç°è¿›ç¨‹è°ƒåº¦ï¼Œåœ¨è¿›ç¨‹è°ƒåº¦æœºåˆ¶ä¸­ï¼Œåº”å…·æœ‰å¦‚ä¸‹ä¸‰ä¸ªåŸºæœ¬éƒ¨åˆ†ï¼š\n![è¿›ç¨‹è°ƒåº¦æœºåˆ¶](http://cdn.littlecorgi.top/mweb/è¿›ç¨‹è°ƒåº¦æœºåˆ¶.jpg)\n1. æ’é˜Ÿå™¨\nä¸ºäº†æé«˜è¿›ç¨‹è°ƒåº¦çš„æ•ˆç‡ï¼Œåº”äº‹å…ˆå°†ç³»ç»Ÿä¸­çš„æ‰€æœ‰å°±ç»ªè¿›ç¨‹æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥æ’æˆä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ï¼Œä»¥ä¾¿è°ƒåº¦ç¨‹åºèƒ½æœ€å¿«çš„æ‰¾åˆ°å®ƒã€‚\n2. åˆ†æ´¾å™¨\nåˆ†æ´¾å™¨ä¾æ®è¿›ç¨‹è°ƒåº¦ç¨‹åºæ‰€é€‰å®šçš„è¿›ç¨‹ï¼Œå°†å…¶ä»å°±ç»ªé˜Ÿåˆ—ä¸­å–å‡ºï¼Œç„¶åè¿›è¡Œä»åˆ†æ´¾å™¨åˆ°æ–°é€‰å‡ºè¿›ç¨‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°†å¤„ç†æœºåˆ†é…ç»™æ–°é€‰å‡ºçš„è¿›ç¨‹ã€‚\n3. ä¸Šä¸‹æ–‡åˆ‡æ¢å™¨\nåœ¨å¯¹å¤„ç†æœºè¿›è¡Œåˆ‡æ¢æ—¶ï¼Œä¼šå‘ç”Ÿä¸¤å¯¹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æ“ä½œ\n    1. å¯¹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼ŒOSå°†ä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå³æŠŠå½“å‰è¿›ç¨‹çš„å¤„ç†æœºå¯„å­˜å™¨çš„å†…å®¹ä¿å­˜åˆ°è¯¥è¿›ç¨‹çš„è¿›ç¨‹æ§åˆ¶å—ä¸­çš„ç›¸åº”å•å…ƒï¼Œå†è£…å…¥åˆ†æ´¾ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åˆ†æ´¾ç¨‹åºè¿è¡Œ\n    2. å¯¹ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç§»é™¤åˆ†æ´¾ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œè€ŒæŠŠæ–°é€‰è¿›ç¨‹çš„CPUç°åœºä¿¡æ¯è£…å…¥åˆ°å¤„ç†æœºçš„å„ä¸ªç›¸åº”å¯„å­˜å™¨ä¸­ï¼Œä»¥ä¾¿æ–°é€‰è¿›ç¨‹è¿è¡Œ\n\n### 5.4.1.3 è¿›ç¨‹è°ƒåº¦æ–¹å¼\n 1. éæŠ¢å æ–¹å¼\n     åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œä¸€æ—¦å¤„ç†æœºåˆ†æ´¾ç»™ä¸€ä¸ªè¿›ç¨‹åï¼Œå°±ä¸€æ¬¡æ€§ä¸€ç›´å¤„ç†ä¸‹å»ï¼Œç›´åˆ°è¯¥è¿›ç¨‹è¢«å¤„ç†å®Œã€‚\n 2. æŠ¢å æ–¹å¼\n     è¿™ç§è°ƒåº¦æ–¹å¼å…è®¸è°ƒåº¦ç¨‹åºæ ¹æ®æŸç§åŸåˆ™ï¼Œå»æš‚åœæŸä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œå°†å·²åˆ†é…ç»™è¯¥è¿›ç¨‹çš„å¤„ç†æœºé‡æ–°åˆ†é…ç»™å¦ä¸€è¿›ç¨‹ã€‚\n     å®ƒéµå¾ªçš„ä¸»è¦åŸåˆ™æœ‰ï¼š\n     1. ä¼˜å…ˆæƒåŸåˆ™ï¼Œä¼˜å…ˆçº§é«˜çš„æ–°åˆ°è¿›ç¨‹æŠ¢å æ­£åœ¨è¿è¡Œçš„ä¼˜å…ˆçº§ä½çš„è¿›ç¨‹\n     2. çŸ­è¿›ç¨‹ä¼˜å…ˆåŸåˆ™ï¼Œéœ€è¦è¿è¡Œæ—¶é—´æ›´çŸ­çš„æ–°åˆ°è¿›ç¨‹æŠ¢å æ­£åœ¨è¿è¡Œçš„éœ€è¦è¿è¡Œæ—¶é—´æ›´é•¿çš„è¿›ç¨‹\n     3. æ—¶é—´ç‰‡åŸåˆ™ï¼Œå„è¿›ç¨‹æŒ‰æ—¶é—´ç‰‡è½®è½¬è¿è¡Œï¼Œå½“æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹çš„ä¸€ä¸ªæ—¶é—´ç‰‡ç”¨å®Œåï¼Œä¾¿åœæ­¢è¯¥è¿›ç¨‹çš„æ‰§è¡Œè€Œé‡æ–°è¿›è¡Œè°ƒåº¦\n\n## 5.4.2 è½®è½¬è°ƒåº¦ç®—æ³•\nåœ¨åˆ†æ—¶ç³»ç»Ÿä¸­ï¼Œæœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€ç®€å•çš„å°±æ˜¯åŸºäºæ—¶é—´ç‰‡çš„è½®è½¬è°ƒåº¦ç®—æ³•ã€‚è¯¥ç®—æ³•é‡‡å–äº†éå¸¸å…¬å¹³çš„å¤„ç†æœºåˆ†é…æ–¹å¼ï¼Œå³è®©å°±ç»ªé˜Ÿåˆ—ä¸Šæ¯ä¸ªè¿›ç¨‹æ¯æ¬¡ä»…è¿è¡Œä¸€ä¸ªæ—¶é—´ç‰‡ã€‚nä¸ªè¿›ç¨‹æ¯ä¸ªéƒ½è¿è¡Œ$\\frac{1}{n}$çš„å¤„ç†æœºæ—¶é—´ã€‚\n\n### 5.4.2.1 åŸºæœ¬åŸç†\nåœ¨RRç®—æ³•ä¸­ï¼Œç³»ç»Ÿæ ¹æ®FCFSç­–ç•¥ï¼Œå°†æ‰€æœ‰çš„å°±ç»ªè¿›ç¨‹æ’æˆä¸€ä¸ªå°±ç»ªé˜Ÿåˆ—ï¼Œå¹¶å¯è®¾ç½®æ¯éš”ä¸€å®šæ—¶é—´é—´éš”å³äº§ç”Ÿä¸€æ¬¡ä¸­æ–­ï¼Œæ¿€æ´»ç³»ç»Ÿä¸­çš„è¿›ç¨‹è°ƒåº¦ç¨‹åºï¼Œå®Œæˆä¸€æ¬¡è°ƒåº¦ï¼Œå°†CPUåˆ†é…ç»™é˜Ÿé¦–è¿›ç¨‹ï¼Œä»¤å…¶æ‰§è¡Œã€‚\n\n### 5.4.2.2 è¿›ç¨‹åˆ‡æ¢æ—¶æœº\n1. å¦‚æœä¸€ä¸ªæ—¶é—´ç‰‡å°šæœªç”¨å®Œä½†æ˜¯æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å·²ç»å®Œæˆï¼Œæ­¤æ—¶å¯ä»¥åˆ‡æ¢\n2. åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡ç”¨å®Œï¼Œæ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥åˆ‡æ¢\n\n### 5.4.2.3 æ—¶é—´ç‰‡å¤§å°çš„ç¡®å®š\nåœ¨RRç®—æ³•ä¸­ï¼Œæ—¶é—´ç‰‡çš„å¤§å°å¯¹ç³»ç»Ÿæ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚\nå¦‚æœé€‰æ‹©å¾ˆå°çš„æ—¶é—´ç‰‡ï¼Œæœ‰åˆ©äºçŸ­ä½œä¸šï¼Œå› ä¸ºä»–èƒ½åœ¨è¯¥æ—¶é—´ç‰‡å†…å®Œæˆï¼Œä½†æ—¶é—´ç‰‡å°ï¼Œæ„å‘³ç€ä¼šé¢‘ç¹è°ƒåº¦ï¼Œè¿™æ— ç–‘ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ã€‚\n![æ—¶é—´ç‰‡å°äºäº¤äº’æ—¶é—´](http://cdn.littlecorgi.top/mweb/æ—¶é—´ç‰‡å°äºäº¤äº’æ—¶é—´.jpg)\n\nå¦‚æœæ—¶é—´ç‰‡é€‰æ‹©å¤ªé•¿ï¼Œè¿™æ ·çš„è¯RRå¯èƒ½ä¼šé€€åŒ–æˆFCFSï¼Œæ— æ³•æ»¡è¶³çŸ­ä½œä¸šå’Œäº¤äº’å¼ç”¨æˆ·çš„éœ€æ±‚ã€‚\n![æ—¶é—´ç‰‡å¤§äºäº¤äº’æ—¶é—´](http://cdn.littlecorgi.top/mweb/æ—¶é—´ç‰‡å¤§äºäº¤äº’æ—¶é—´.jpg)\n\n## 5.4.3 ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•\nåœ¨RRç®—æ³•ä¸­ï¼Œæˆ‘ä»¬å‡è®¾äº†æ‰€æœ‰è¿›ç¨‹çš„ç´§è¿«æ€§æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å®é™…æƒ…å†µå¹¶éå¦‚æ­¤ã€‚æˆ‘ä»¬ä¸ºäº†æ»¡è¶³å®é™…æƒ…å†µï¼Œåœ¨è¿›ç¨‹è°ƒåº¦ç®—æ³•ä¸­å¼•å…¥äº†ä¼˜å…ˆçº§ï¼Œè€Œå½¢æˆçš„ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ã€‚\n\n### 5.4.3.1 ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•çš„ç±»å‹\n1. éæŠ¢å å¼ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•\n2. æŠ¢å å¼ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•\n\nè¿™å—å’Œå‰é¢è°ƒåº¦ç®—æ³•æ–¹å¼ä¸€æ ·ï¼Œåœ¨æ­¤å°±ä¸å¤šè¯´ã€‚\n\n### 5.4.3.2 ä¼˜å…ˆçº§ç±»å‹\n#### 5.4.3.2.1 é™æ€ä¼˜å…ˆçº§\né™æ€ä¼˜å…ˆçº§æ˜¯åœ¨åˆ›å»ºè¿›ç¨‹æ—¶ç¡®å®šçš„ï¼Œåœ¨è¿›ç¨‹çš„æ•´ä¸ªè¿è¡ŒæœŸé—´ä¿æŒä¸å˜ã€‚ä¼˜å…ˆçº§æ˜¯åˆ©ç”¨æŸä¸€èŒƒå›´å†…çš„ä¸€ä¸ªæ•´æ•°æ¥è¡¨ç¤ºçš„ã€‚ç¡®å®šè¿›ç¨‹ä¼˜å…ˆçº§å¤§å°çš„ä¾æ®æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š\n1. è¿›ç¨‹ç±»å‹ï¼Œé€šå¸¸ç³»ç»Ÿè¿›ç¨‹çš„ä¼˜å…ˆçº§ä¸€èˆ¬é«˜äºç”¨æˆ·è¿›ç¨‹ã€‚\n2. è¿›ç¨‹å¯¹èµ„æºçš„éœ€æ±‚ï¼Œå¯¹èµ„æºè¦æ±‚è¾ƒå°‘çš„è¿›ç¨‹åº”èµ‹äºˆè¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚\n3. ç”¨æˆ·è¦æ±‚ï¼Œæ ¹æ®è¿›ç¨‹çš„ç´§è¿«ç¨‹åº¦åŠç”¨æˆ·æ‰€ä»˜è´¹ç”¨çš„å¤šå°‘ç¡®å®šä¼˜å…ˆçº§ã€‚\n\né™æ€ä¼˜å…ˆçº§æ³•ç®€å•æ˜“è¡Œï¼Œç³»ç»Ÿå¼€é”€å°ï¼Œä½†æ˜¯ä¸å¤Ÿç²¾ç¡®ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§ä½çš„è¿›ç¨‹é•¿æœŸæ²¡æœ‰è¢«è°ƒåº¦çš„æƒ…å†µã€‚\n\n#### 5.4.3.2.2 åŠ¨æ€ä¼˜å…ˆçº§\nåŠ¨æ€ä¼˜å…ˆçº§æ˜¯æŒ‡è¿›ç¨‹åˆ›å»ºä¹‹åˆï¼Œå…ˆèµ‹äºˆä¸€ä¸ªä¼˜å…ˆçº§ï¼Œç„¶åæ ¹æ®è¿›ç¨‹çš„æ¨è¿›æˆ–ç­‰å¾…æ—¶é—´çš„å¢åŠ è€Œæ”¹å˜ï¼Œä»¥ä¾¿è·å¾—æ›´å¥½çš„è°ƒåº¦æ€§èƒ½ã€‚\n\n## 5.4.4 å¤šé˜Ÿåˆ—è°ƒåº¦ç®—æ³•\nä¹‹å‰æ‰€è¿°çš„å„ç§è°ƒåº¦ç®—æ³•ï¼Œåœ¨åº”ç”¨äºè¿›ç¨‹è°ƒåº¦æ—¶ï¼Œç”±äºç³»ç»Ÿä¸­ä»…è®¾ç½®ä¸€ä¸ªè¿›ç¨‹çš„å°±ç»ªé˜Ÿåˆ—ï¼Œå³ä½çº§è°ƒåº¦çš„ç®—æ³•æ˜¯å•ä¸€çš„ï¼Œå›ºå®šçš„ï¼Œæ— æ³•æ»¡è¶³ç³»ç»Ÿä¸­ä¸åŒç”¨æˆ·å¯¹è¿›ç¨‹è°ƒåº¦ç­–ç•¥çš„ä¸åŒè¦æ±‚ï¼Œåœ¨å¤šå¤„ç†æœºç³»ç»Ÿä¸­ï¼Œè¿™ç§å•ä¸€è°ƒåº¦ç­–ç•¥å®ç°æœºåˆ¶ç¼ºç‚¹æ›´åŠ æ˜æ˜¾ã€‚å› æ­¤å¤šçº§é˜Ÿåˆ—ç®—æ³•èƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥è¿™ä¸€ç¼ºç‚¹ã€‚\n\nå¤šçº§é˜Ÿåˆ—ç®—æ³•å°†è¿›ç¨‹å°±ç»ªé˜Ÿåˆ—æ‹†åˆ†æˆè‹¥å¹²ä¸ªï¼Œä¸åŒçš„å°±ç»ªé˜Ÿåˆ—é‡‡ç”¨ä¸åŒçš„è°ƒåº¦ç®—ç®—æ³•ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå¥½çš„æ»¡è¶³ä¸åŒç”¨æˆ·å¯¹è¿›ç¨‹è°ƒåº¦ç­–ç•¥çš„ä¸åŒéœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ»¡è¶³å¤šå¤„ç†æœºç³»ç»Ÿçš„éœ€æ±‚ã€‚\n\n## 5.4.5 å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•\nå‰é¢çš„ç®—æ³•éƒ½æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œå¦‚æœæœªæŒ‡æ˜è¿›ç¨‹é•¿åº¦ï¼Œåˆ™çŸ­è¿›ç¨‹ä¼˜å…ˆå’ŒåŸºäºè¿›ç¨‹é•¿åº¦çš„æŠ¢å å¼è°ƒåº¦ç®—æ³•éƒ½å°†æ— æ³•ä½¿ç”¨ã€‚è€Œä¸‹è¿°çš„å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•åˆ™ä¸å¿…äº‹å…ˆçŸ¥é“å„ç§è¿›ç¨‹æ‰€éœ€çš„æ‰§è¡Œæ—¶é—´ï¼Œè¿˜å¯ä»¥å¾ˆå¥½åœ°æ»¡è¶³å„ç§ç±»å‹è¿›ç¨‹çš„éœ€è¦ï¼Œå› è€Œä»–æ˜¯ç›®å‰å…¬è®¤çš„ä¸€ç§è¾ƒå¥½çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•ã€‚\n\n### 5.4.5.1 è°ƒåº¦æœºåˆ¶\n1. è®¾ç½®å¤šä¸ªå°±ç»ªé˜Ÿåˆ—ã€‚åœ¨ç³»ç»Ÿä¸­è®¾ç½®å¤šä¸ªå°±ç»ªé˜Ÿåˆ—ï¼Œå¹¶æœªæ¯ä¸ªé˜Ÿåˆ—èµ‹äºˆä¸åŒçš„ä¼˜å…ˆçº§ã€‚ç¬¬ä¸€ä¸ªé˜Ÿåˆ—çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œç¬¬äºŒæ¬¡ä¹‹ï¼Œå…¶ä½™é˜Ÿåˆ—çš„ä¼˜å…ˆçº§é€ä¸ªé™ä½ã€‚è¯¥ç®—æ³•ä¸ºä¸åŒé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ‰€èµ‹äºˆçš„æ‰§è¡Œæ—¶é—´ç‰‡çš„å¤§å°ä¹Ÿä¸åŒï¼Œåœ¨ä¼˜å…ˆçº§è¶Šé«˜çš„é˜Ÿåˆ—ä¸­æ—¶é—´ç‰‡è¶Šå°ã€‚\n   ![å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•](http://cdn.littlecorgi.top/mweb/å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•.jpg)\n\n2. æ¯ä¸ªé˜Ÿåˆ—éƒ½é‡‡ç”¨FCFSç®—æ³•ã€‚å½“æ–°è¿›ç¨‹è¿›å…¥å†…å­˜åï¼Œé¦–å…ˆå°†å®ƒæ”¾å…¥ç¬¬ä¸€é˜Ÿåˆ—çš„æœ«å°¾ï¼ŒæŒ‰FCFSåŸåˆ™ç­‰å¾…è°ƒåº¦ã€‚å½“è½®åˆ°è¯¥è¿›ç¨‹æ—¶ï¼Œå¦‚ä»–èƒ½åœ¨æ—¶é—´ç‰‡å†…å®Œæˆï¼Œä¾¿å¯æ’¤ç¦»ç³»ç»Ÿï¼Œå¦åˆ™ï¼Œä»–åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡ç»“æŸè¿˜æœªå®Œæˆæ—¶ï¼Œè½¬å…¥ç¬¬äºŒé˜Ÿåˆ—æœ«å°¾ç­‰å¾…ï¼Œä¾æ¬¡ç±»æ¨ã€‚\n3. æŒ‰é˜Ÿåˆ—ä¼˜å…ˆçº§è°ƒåº¦ï¼Œé¦–å…ˆè°ƒåº¦æœ€é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„è¯¸è¿›ç¨‹è¿è¡Œï¼Œä»…å½“ç¬¬ä¸€é˜Ÿåˆ—ç©ºé—²æ—¶æ‰è°ƒåº¦ç¬¬äºŒé˜Ÿåˆ—ã€‚\n\n### 5.4.5.2 è°ƒåº¦ç®—æ³•çš„æ€§èƒ½\nåœ¨å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•ä¸­ï¼Œå¦‚æœè§„å®šç¬¬ä¸€ä¸ªé˜Ÿåˆ—çš„æ—¶é—´ç‰‡ç•¥å¤§äºå¤šæ•°äººæœºäº¤äº’ç³»ç»Ÿæ‰€éœ€å¤„ç†æ—¶é—´æ—¶ï¼Œä¾¿èƒ½è¾ƒå¥½çš„æ»¡è¶³å„ç§ç±»å‹ç”¨æˆ·çš„éœ€è¦ã€‚ \n\n## 5.4.6 åŸºäºå…¬å¹³åŸåˆ™çš„è°ƒåº¦ç®—æ³•\n### 5.4.6.1 ä¿è¯è°ƒåº¦ç®—æ³•\nä¿è¯è°ƒåº¦ç®—æ³•æ˜¯å¦ä¸€ç§ç±»å‹çš„è°ƒåº¦ç®—æ³•ï¼Œå®ƒæƒ³ç”¨æˆ·æ‰€ä½œå‡ºçš„ä¿è¯å¹¶ä¸æ˜¯ä¼˜å…ˆè¿è¡Œï¼Œè€Œæ˜¯æ˜ç¡®çš„æ€§èƒ½ä¿è¯ï¼Œè¯¥ç®—æ³•å¯ä»¥åšåˆ°è°ƒåº¦çš„å…¬å¹³æ€§ã€‚ä¸€ç§æ¯”è¾ƒå®¹æ˜“çš„æ€§èƒ½ä¿è¯æ˜¯å¤„ç†æœºçš„å…¬å¹³æ€§ï¼Œå¦‚æœåœ¨ç³»ç»Ÿä¸­æœ‰nä¸ªç±»å‹ç›¸åŒçš„è¿›ç¨‹åŒæ—¶è¿è¡Œï¼Œä¸ºäº†å…¬å¹³æœŸé—´ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è·å¾—ç›¸åŒçš„å¤„ç†æœºæ—¶é—´$\\frac{1}{n}$ã€‚\n\nåœ¨å®æ–½ä¿è¯è°ƒåº¦ç®—æ³•æ—¶ï¼Œç³»ç»Ÿå¿…é¡»å…·å¤‡è¿™æ ·ä¸€äº›åŠŸèƒ½ï¼š\n\n1. è·Ÿè¸ªè®¡ç®—æ¯ä¸ªè¿›ç¨‹è‡ªåˆ›å»ºä»¥æ¥å·²ç»æ‰§è¡Œçš„å¤„ç†æ—¶é—´ã€‚\n2. è®¡ç®—æ¯ä¸ªè¿›ç¨‹åº”è·å¾—çš„å¤„ç†æœºæ—¶é—´ï¼Œå³è‡ªåˆ›å»ºä»¥æ¥çš„æ—¶é—´é™¤ä»¥nã€‚\n3. è®¡ç®—è¿›ç¨‹è·å¾—å¤„ç†æœºæ—¶é—´çš„æ¯”ç‡ï¼Œå³è¿›ç¨‹å®é™…æ‰§è¡Œçš„å¤„ç†æ—¶é—´å’Œåº”è·å¾—çš„å¤„ç†æœºæ—¶é—´ä¹‹æ¯”ã€‚\n4. æ¯”è¾ƒå„è¿›ç¨‹è·å¾—å¤„ç†æœºæ—¶é—´çš„æ¯”ç‡ã€‚å¦‚è¿›ç¨‹Açš„æ¯”ç‡æœ€ä½ï¼Œä¸º0.5ï¼Œè€Œè¿›ç¨‹Bçš„æ¯”ç‡ä¸º0.8ï¼Œè¿›ç¨‹Cçš„æ¯”ç‡ä¸º1.2ç­‰ã€‚\n5. è°ƒåº¦ç¨‹åºåº”é€‰æ‹©æ¯”ç‡æœ€å°çš„è¿›ç¨‹å°†å¤„ç†æœºåˆ†é…ç»™å®ƒï¼Œå¹¶è®©è¯¥è¿›ç¨‹ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°è¶…è¿‡æœ€æ¥è¿‘å®ƒçš„è¿›ç¨‹æ¯”ç‡ä¸ºæ­¢ã€‚\n\n### 5.4.6.2 å…¬å¹³åˆ†äº«è°ƒåº¦ç®—æ³•\nåˆ†é…ç»™æ¯ä¸ªè¿›ç¨‹ç›¸åŒçš„å¤„ç†æœºæ—¶é—´ï¼Œæ˜¾ç„¶ï¼Œè¿™å¯¹è¯¸è¿›ç¨‹è€Œè¨€ï¼Œæ˜¯ä½“ç°äº†ä¸€å®šç¨‹åº¦çš„å…¬å¹³ï¼Œä½†å¦‚æœå„ä¸ªç”¨æˆ·æ‰€æ‹¥æœ‰çš„è¿›ç¨‹æ•°ä¸åŒï¼Œå°±ä¼šå‘ç”Ÿå¯¹ç”¨æˆ·çš„ä¸å…¬å¹³é—®é¢˜ã€‚ åœ¨è¯¥ç®—æ³•ä¸­ï¼Œè°ƒåº¦çš„å…¬å¹³æ€§æ˜¯ä½“é’ˆå¯¹äºç”¨æˆ·è€Œè¨€ã€‚ä½¿æ‰€æœ‰çš„ç”¨æˆ·è·å¾—ç›¸åŒçš„å¤„ç†æœºæ—¶é—´ï¼Œæˆ–è¦æ±‚çš„æ—¶é—´æ¯”ä¾‹ã€‚\n\n# 5.5 å®æ—¶è°ƒåº¦\n## 5.5.1 å®ç°å®æ—¶è°ƒåº¦çš„åŸºæœ¬æ¡ä»¶\n1. æä¾›å¿…è¦çš„ä¿¡æ¯\n    1. å°±ç»ªæ—¶é—´ï¼Œæ˜¯æŒ‡æŸä»»åŠ¡ç§°ä¸ºå°±ç»ªçŠ¶æ€çš„æ—¶é—´ï¼Œåœ¨å‘¨æœŸä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œå¥¹æ˜¯å®ç°é¢„çŸ¥çš„ä¸€ä¸²æ—¶é—´åºåˆ—ã€‚\n    2. å¼€å§‹æˆªæ­¢æ—¶é—´å’Œå®Œæˆæˆªæ­¢æ—¶é—´ï¼Œå¯¹äºå…¸å‹çš„å®æ—¶åº”ç”¨ï¼Œåªéœ€çŸ¥é“å¼€å§‹æˆªæ­¢æ—¶é—´æˆ–è€…å®Œæˆæˆªæ­¢æ—¶é—´\n    3. å¤„ç†æ—¶é—´ï¼Œä¸€ä¸ªä»»åŠ¡ä»å¼€å§‹æ‰§è¡Œï¼Œç›´è‡³å®Œæˆæ—¶æ‰€éœ€çš„æ—¶é—´\n    4. èµ„æºè¦æ±‚ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶æ‰€éœ€è¦çš„ä¸€ç»„èµ„æº\n    5. ä¼˜å…ˆçº§ï¼Œå¦‚æœæŸä»»åŠ¡çš„å¼€å§‹æˆªæ­¢æ—¶é—´é”™è¿‡ï¼ŒåŠ¿å¿…å¼•èµ·æ•…éšœï¼Œåˆ™åº”ä¸ºè¯¥ä»»åŠ¡èµ‹äºˆâ€œç»å¯¹â€ä¼˜å…ˆçº§ï¼›å¦‚æœå…¶å¼€å§‹æˆªæ­¢æ—¶é—´çš„é”™è¿‡ï¼Œå¯¹ä»»åŠ¡çš„ç»§ç»­è¿è¡Œæ— é‡å¤§å½±å“ï¼Œåˆ™å¯ä¸ºå…¶èµ‹äºˆâ€œç›¸å¯¹ä¼˜å…ˆçº§â€ï¼Œä¾›è°ƒåº¦ç¨‹åºå‚è€ƒ\n2. ç³»ç»Ÿå¤„ç†èƒ½åŠ›å¼º\n    åœ¨å®æ—¶ç³»ç»Ÿä¸­ï¼Œè‹¥å¤„ç†æœºçš„å¤„ç†èƒ½åŠ›ä¸å¤Ÿå¼ºï¼Œåˆ™æœ‰å¯èƒ½å› å¤„ç†æœºå¿™ä¸è¿‡ï¼Œè€Œè‡´ä½¿æŸäº›å®æ—¶ä»»åŠ¡ä¸èƒ½å¾—åˆ°åŠæ—¶å¤„ç†ï¼Œä»è€Œå¯¼è‡´å‘ç”Ÿéš¾ä»¥é¢„æ–™çš„åæœã€‚\n    å‡å®šç³»ç»Ÿä¸­æœ‰mä¸ªå‘¨æœŸæ€§çš„ç¡¬å®æ—¶ä»»åŠ¡HRTï¼Œä»–ä»¬çš„å¤„ç†æ—¶é—´å¯è¡¨ç¤ºä¸º$C_i$ï¼Œå‘¨æœŸæ—¶é—´è¡¨ç¤ºä¸º$P_i$ï¼Œåˆ™åœ¨å•å¤„ç†æœºæƒ…å†µä¸‹ï¼Œå¿…é¡»æ»¡è¶³ä¸‹é¢çš„é™åˆ¶æ¡ä»¶ç³»ç»Ÿæ‰æ˜¯å¯è°ƒåº¦çš„ï¼š$$ \\sum_{i=1}^{m}\\frac{C_i}{P_i}\\le1 $$\n    æé«˜ç³»ç»Ÿå¤„ç†èƒ½åŠ›çš„é€”å¾„æœ‰äºŒï¼šä¸€æ˜¯é‡‡ç”¨å•å¤„ç†æœºç³»ç»Ÿï¼Œä½†é¡»å¢å¼ºå…¶å¤„ç†èƒ½åŠ›ï¼Œä»¥æ˜¾è‘—åœ°å‡å°‘å¯¹æ¯ä¸€ä¸ªä»»åŠ¡çš„å¤„ç†æ—¶é—´ï¼›äºŒæ˜¯é‡‡ç”¨å¤šå¤„ç†æœºç³»ç»Ÿã€‚å‡å®šç³»ç»Ÿä¸­çš„å¤„ç†æœºæ•°ä¸ºNï¼Œåˆ™åº”å°†ä¸Šè¿°çš„é™åˆ¶æ¡ä»¶æ”¹ä¸ºï¼š$$ \\sum_{i=1}^{m}\\frac{C_i}{P_i}\\le N $$\n3. é‡‡ç”¨æŠ¢å å¼è°ƒåº¦æœºåˆ¶\n    åœ¨å«æœ‰HRTä»»åŠ¡çš„å®æ—¶ç³»ç»Ÿä¸­ï¼Œå¹¿æ³›é‡‡ç”¨æŠ¢å æœºåˆ¶ã€‚è¿™æ ·ä¾¿å¯æ»¡è¶³HRTä»»åŠ¡å¯¹æˆªæ­¢æ—¶é—´çš„è¦æ±‚ã€‚ä½†è¿™ç§è°ƒåº¦æœºåˆ¶æ¯”è¾ƒå¤æ‚ã€‚ å¯¹äºä¸€äº›å°çš„å®æ—¶ç³»ç»Ÿï¼Œå¦‚æœèƒ½å¤Ÿé¢„çŸ¥ä»»åŠ¡æ³•å¼€å§‹æˆªæ­¢æ—¶é—´ï¼Œåˆ™å¯¹äºå®æ—¶ä»»åŠ¡çš„è°ƒåº¦å¯ä»¥é‡‡ç”¨éæŠ¢å å¼è°ƒåº¦ã€‚\n4. å…·æœ‰å¿«é€Ÿåˆ‡æ¢æœºåˆ¶\n    ä¸ºä¿è¯ç¡¬å®æ—¶ä»»åŠ¡èƒ½åŠæ—¶è¿è¡Œï¼Œåœ¨ç³»ç»Ÿä¸­è¿˜åº”å…·æœ‰å¿«é€Ÿåˆ‡æ¢æœºåˆ¶ï¼Œä½¿ä¹‹èƒ½è¿›è¡Œä»»åŠ¡çš„å¿«é€Ÿåˆ‡æ¢ã€‚è¯¥æœºåˆ¶åº”å…·æœ‰å¦‚ä¸‹ä¸¤æ–¹é¢çš„èƒ½åŠ›ï¼š\n    2. å¯¹ä¸­æ–­çš„å¿«é€Ÿå“åº”èƒ½åŠ›ã€‚å¯¹ç´§è¿«çš„å¤–éƒ¨äº‹ä»¶è¯·æ±‚ä¸­æ–­èƒ½åŠæ—¶å“åº”ï¼Œè¦æ±‚ç³»ç»Ÿå…·æœ‰å¿«é€Ÿç¡¬ä»¶ä¸­æ–­æœºæ„ï¼Œè¿˜åº”ä½¿ç¦æ­¢ä¸­æ–­çš„æ—¶é—´é—´éš”å°½é‡çŸ­ï¼Œä»¥å…è€½è¯¯æ—¶æœº(å…¶å®ƒç´§è¿«ä»»åŠ¡)ã€‚\n    3. å¿«é€Ÿçš„ä»»åŠ¡åˆ†æ´¾èƒ½åŠ›ã€‚ä¸ºäº†æé«˜åˆ†æ´¾ç¨‹åºè¿›è¡Œä»»åŠ¡åˆ‡æ¢æ—¶çš„é€Ÿåº¦ï¼Œåº”ä½¿ç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿è¡ŒåŠŸèƒ½å•ä½é€‚å½“çš„å°ï¼Œä»¥å‡å°‘ä»»åŠ¡åˆ‡æ¢çš„æ—¶é—´å¼€é”€ã€‚\n\n## 5.5.2 å®æ—¶è°ƒåº¦ç®—æ³•çš„åˆ†ç±»\n### 5.5.2.1 éæŠ¢å å¼è°ƒåº¦ç®—æ³•\n1. éæŠ¢å å¼è½®è½¬è°ƒåº¦ç®—æ³•\n    ç”±ä¸€å°è®¡ç®—æœºæ§åˆ¶è‹¥å¹²ä¸ªç›¸åŒçš„å¯¹è±¡ï¼Œä¸ºæ¯ä¸ªè¢«æ§å¯¹è±¡å»ºç«‹ä¸€ä¸ªå®æ—¶ä»»åŠ¡ã€‚å¹¶å°†ä»–ä»¬æ’æˆä¸€ä¸ªè½®è½¬é˜Ÿåˆ—ã€‚è°ƒåº¦ç¨‹åºæ¯æ¬¡é€‰æ‹©é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æŠ•å…¥è¿è¡Œï¼Œå½“è¯¥ä»»åŠ¡å®Œæˆåï¼Œä¾¿æŠŠå®ƒæŒ‚åœ¨è½®è½¬é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…ï¼Œè°ƒåº¦ç¨‹åºå†é€‰æ‹©ä¸‹ä¸€ä¸ªé˜Ÿé¦–ä»»åŠ¡è¿è¡Œã€‚\n\n2. éæŠ¢å å¼ä¼˜å…ˆè°ƒåº¦ç®—æ³•\n    å¦‚æœåœ¨ç³»ç»Ÿä¸­è¿˜å«æœ‰å°‘æ•°å…·æœ‰ä¸€å®šè¦æ±‚çš„å®æ—¶ä»»åŠ¡ï¼Œåˆ™å¯é‡‡ç”¨éæŠ¢å å¼ä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼Œç³»ç»Ÿä¸ºè¿™äº›ä»»åŠ¡èµ‹äºˆäº†è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚å½“è¿™äº›å®æ—¶ä»»åŠ¡åˆ°è¾¾æ—¶ï¼ŒæŠŠå®ƒä»¬å®‰æ’åœ¨å°±ç»ªé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œç­‰å¾…å½“å‰ä»»åŠ¡è‡ªæˆ‘ç»ˆæ­¢æˆ–è¿è¡Œå®Œæˆåï¼Œä¾¿å¯å»è°ƒåº¦æ‰§è¡Œé˜Ÿé¦–çš„é«˜ä¼˜å…ˆçº§è¿›ç¨‹ã€‚\n\n### 5.5.2.2 æŠ¢å å¼è°ƒåº¦ç®—æ³•\n1. åŸºäºæ—¶é’Ÿä¸­æ–­çš„æŠ¢å å¼ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ã€‚\n    åœ¨æŸå®æ—¶ä»»åŠ¡åˆ°è¾¾åï¼Œå¦‚æœä»–çš„ä¼˜å…ˆçº§é«˜äºå½“å‰ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯å¹¶ä¸ç«‹å³æŠ¢å å½“å‰ä»»åŠ¡çš„å¤„ç†æœºï¼Œè€Œæ˜¯ç­‰åˆ°æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè°ƒåº¦ç¨‹åºæ‰å‰¥å¤ºå¤§å¹´ä»»åŠ¡çš„æ‰§è¡Œï¼ŒæŠŠå¤„ç†æœºåˆ†é…ç»™æ–°åˆ°çš„é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚\n\n2. ç«‹å³æŠ¢å çš„ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ã€‚\n    åœ¨è¿™ç§è°ƒåº¦ç­–ç•¥ä¸­ï¼Œè¦æ±‚æ“ä½œç³»ç»Ÿå…·æœ‰å¿«é€Ÿå“åº”å¤–éƒ¨äº‹ä»¶ä¸­æ–­çš„èƒ½åŠ›ï¼Œä¸€æ—¦å‡ºç°å¤–éƒ¨ä¸­æ–­ï¼Œåªè¦å½“å‰ä»»åŠ¡æœªå¤„äºä¸´ç•ŒåŒºï¼Œä¾¿èƒ½ç«‹å³å‰¥å¤ºå½“å‰ä»»åŠ¡çš„æ‰§è¡Œï¼ŒæŠŠå¤„ç†æœºåˆ†é…ç»™è¯·æ±‚ä¸­æ–­çš„ç´§è¿«ä»»åŠ¡ã€‚\n    ![å®æ—¶è¿›ç¨‹è°ƒåº¦](http://cdn.littlecorgi.top/mweb/å®æ—¶è¿›ç¨‹è°ƒåº¦.png)\n\n\n## 5.5.3 æœ€æ—©æˆªæ­¢æ—¶é—´ä¼˜å…ˆ\nè¯¥ç®—æ³•æ˜¯æ ¹æ®ä»»åŠ¡æˆªæ­¢æ—¶é—´ç¡®å®šä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œä»»åŠ¡çš„æˆªæ­¢æ—¶é—´è¶Šæ—©ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå…·æœ‰æœ€æ—©æˆªæ­¢æ—¶é—´çš„ä»»åŠ¡æ’åœ¨é˜Ÿé¦–ã€‚\n\n### 5.5.3.1 éæŠ¢å å¼è°ƒåº¦æ–¹å¼ç”¨äºéå‘¨æœŸå®æ—¶ä»»åŠ¡\n![EDFç®—æ³•ç”¨äºéæŠ¢å å¼è°ƒåº¦æ–¹æ³•](http://cdn.littlecorgi.top/mweb/EDFç®—æ³•ç”¨äºéæŠ¢å å¼è°ƒåº¦æ–¹æ³•.jpg)\n\n### 5.5.3.2 æŠ¢å å¼è°ƒåº¦æ–¹å¼ç”¨äºéå‘¨æœŸå®æ—¶ä»»åŠ¡\n![æœ€æ—©æˆªæ­¢æ—¶é—´ä¼˜å…ˆç®—æ³•ç”¨äºæŠ¢å è°ƒåº¦æ–¹å¼ä¹‹ä¾‹](http://cdn.littlecorgi.top/mweb/æœ€æ—©æˆªæ­¢æ—¶é—´ä¼˜å…ˆç®—æ³•ç”¨äºæŠ¢å è°ƒåº¦æ–¹å¼ä¹‹ä¾‹.png)\n\n## 5.5.4 æœ€ä½æ¾å¼›åº¦ä¼˜å…ˆLLFç®—æ³•\nè¯¥ç®—æ³•åœ¨ç¡®å®šä»»åŠ¡çš„ä¼˜å…ˆçº§æ—¶ï¼Œæ ¹æ®çš„æ˜¯ä»»åŠ¡çš„ç´§æ€¥(æˆ–æ¾å¼›)ç¨‹åº¦ã€‚ä»»åŠ¡ç´§æ€¥ç¨‹åº¦æ„ˆé«˜ï¼Œèµ‹äºˆè¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§å°±æ„ˆé«˜ï¼Œä»¥ä½¿ä¹‹ä¼˜å…ˆæ‰§è¡Œã€‚ \u000bè¯¥æ–¹å¼ä¸»è¦ç”¨å¯æŠ¢å å¼è°ƒåº¦ã€‚\n\nå‡å¦‚åœ¨ä¸€ä¸ªå®æ—¶ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªå‘¨æœŸæ€§å®æ—¶ä»»åŠ¡Aå’ŒBï¼Œä»»åŠ¡Aè¦æ±‚æ¯20â€…msæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œæ—¶é—´ä¸º10â€…msï¼Œä»»åŠ¡Bè¦æ±‚æ¯50â€…msæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œæ—¶é—´ä¸º25â€…msã€‚ç”±æ­¤å¯çŸ¥ï¼Œä»»åŠ¡Aå’ŒBæ¯æ¬¡å¿…é¡»å®Œæˆçš„æ—¶é—´åˆ†åˆ«ä¸ºï¼šA1ã€A2ã€A3ã€â€¦å’ŒB1ã€B2ã€B3ã€â€¦ï¼Œå¦‚ä¸‹å›¾\n![Aä»»åŠ¡å’ŒBä»»åŠ¡æ¯æ¬¡å¿…é¡»å®Œæˆçš„æ—¶é—´](http://cdn.littlecorgi.top/mweb/Aä»»åŠ¡å’ŒBä»»åŠ¡æ¯æ¬¡å¿…é¡»å®Œæˆçš„æ—¶é—´.png)\n\nåˆ©ç”¨ELLFç®—æ³•è¿›è¡Œè°ƒåº¦çš„æƒ…å†µï¼š\n![åˆ©ç”¨ELLFç®—æ³•è¿›è¡Œè°ƒåº¦çš„æƒ…å†µ](http://cdn.littlecorgi.top/mweb/åˆ©ç”¨ELLFç®—æ³•è¿›è¡Œè°ƒåº¦çš„æƒ…å†µ.png)\n","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"Androidç½‘ç»œè¯·æ±‚1--HttpClientä¸HttpURLConnection","url":"/posts/eb898689.html","content":"åœ¨æ—©æœŸçš„æ—¶å€™ï¼ŒAndroidä¸Šè¿˜æ²¡æœ‰åƒ`Volley`ã€`OkHttp`ã€`Retrofit`è¿™äº›ä¼˜ç§€çš„å¼€æºåº“ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ç½‘ç»œè¯·æ±‚çš„è¯ï¼Œå°±åªèƒ½è‡ªå·±å°è£…`HttpClient`å’Œ`HttpURLConnection`ã€‚ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹ä¸‹`Apache`çš„è¿™ä¸¤ä¸ªç±»ã€‚\n<!-- More -->\n\n# 1. HttpClient\n\n## 2.1 å¯¼å…¥HttpClient\nç”±äºä»Android 6.0 å¼€å§‹ï¼Œè°·æ­Œå°±å°†HttpClientä»Androidä¸­åˆ é™¤äº†ï¼Œæ‰€ä»¥è‹¥ç°åœ¨æƒ³ä½¿ç”¨ä»–ï¼Œè¿˜å¾—å¯¼å…¥ä¾èµ–ï¼š\nåœ¨é¡¹ç›®çš„`build.gradle`çš„`Android`ä»£ç å—ä¸‹åŠ å…¥ä¾èµ–ï¼Œç¤ºä¾‹ï¼š\n```java\nandroid {\n    useLibrary 'org.apache.http.legacy'\n    ...\n}\n```\n## 2.2 HttpClientçš„Get\né¦–å…ˆé€šè¿‡`DefaultHttpClient`æ¥å®ä¾‹åŒ–ä¸€ä¸ª`HttpClient`ï¼Œå¹¶é…ç½®å¥½å‚æ•°ï¼š\n```java\n //åˆ›å»ºHttpClient\nprivate HttpClient createHttpClient() {\n    HttpParams mDefaultHttpParams = new BasicHttpParams();\n    //è®¾ç½®è¿æ¥è¶…æ—¶\n    HttpConnectionParams.setConnectionTimeout(mDefaultHttpParams, 15000);\n    //è®¾ç½®è¯·æ±‚è¶…æ—¶\n    HttpConnectionParams.setSoTimeout(mDefaultHttpParams, 15000);\n    HttpConnectionParams.setTcpNoDelay(mDefaultHttpParams, true);\n    HttpProtocolParams.setVersion(mDefaultHttpParams, HttpVersion.HTTP_1_1);\n    HttpProtocolParams.setContentCharset(mDefaultHttpParams, HTTP.UTF_8);\n    //æŒç»­æ¡æ‰‹\n    HttpProtocolParams.setUseExpectContinue(mDefaultHttpParams, true);\n    HttpClient mHttpClient = new DefaultHttpClient(mDefaultHttpParams);\n    return mHttpClient;\n}\n```\næ¥ç€åˆ›å»º`HttpGet`å’Œ`HttpClient`ï¼Œè¯·æ±‚ç½‘ç»œå¹¶å¾—åˆ°`HttpResponse`ï¼Œå¹¶å¯¹`HttpResponse`è¿›è¡Œå¤„ç†ï¼š\n```java\nprivate void useHttpClientGet(String url) {\n    HttpGet mHttpGet = new HttpGet(url);\n    mHttpGet.addHeader(\"Connection\", \"Keep-Alive\");\n    try {\n        HttpClient mHttpClient = createHttpClient();\n        HttpResponse mHttpResponse = mHttpClient.execute(mHttpGet);\n        HttpEntity mHttpEntity = mHttpResponse.getEntity();\n        int code = mHttpResponse.getStatusLine().getStatusCode();\n        if (null != mHttpEntity) {\n            InputStream mInputStream = mHttpEntity.getContent();\n            String respose = converStreamToString(mInputStream);\n            Log.i(\"wangshu\", \"è¯·æ±‚çŠ¶æ€ç :\" + code + \"\\nè¯·æ±‚ç»“æœ:\\n\" + respose);\n            mInputStream.close();\n        }\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n}\n```\n`converStreamToString()`æ–¹æ³•å°†è¯·æ±‚ç»“æœè½¬æ¢æˆ`String`ç±»å‹ï¼š\n```java\nprivate String converStreamToString(InputStream is) throws IOException {\n    BufferedReader reader = new BufferedReader(new InputStreamReader(is));\n    StringBuffer sb = new StringBuffer();\n    String line = null;\n    while ((line = reader.readLine()) != null) {\n        sb.append(line + \"\\n\");\n    }\n    String respose = sb.toString();\n    return respose;\n}\n```\næœ€åå¼€å¯çº¿ç¨‹è®¿é—®:\n```java\nnew Thread(new Runnable() {\n    @Override\n    public void run() {\n        useHttpClientGet(\"http://www.baidu.com\");\n    }\n}).start();\n```\n## 1.3 HttpClientçš„POST\nå’ŒGETå·®ä¸å¤šï¼Œåªéœ€è¦ä¿®æ”¹ä¼ é€’çš„å‚æ•°ï¼š\n```java\nprivate void useHttpClientPost(String url) {\n    HttpPost mHttpPost = new HttpPost(url);\n    mHttpPost.addHeader(\"Connection\", \"Keep-Alive\");\n    try {\n        HttpClient mHttpClient = createHttpClient();\n        List<NameValuePair> postParams = new ArrayList<>();\n        //è¦ä¼ é€’çš„å‚æ•°\n        postParams.add(new BasicNameValuePair(\"username\", \"moon\"));\n        postParams.add(new BasicNameValuePair(\"password\", \"123\"));\n        mHttpPost.setEntity(new UrlEncodedFormEntity(postParams));\n        HttpResponse mHttpResponse = mHttpClient.execute(mHttpPost);\n        HttpEntity mHttpEntity = mHttpResponse.getEntity();\n        int code = mHttpResponse.getStatusLine().getStatusCode();\n        if (null != mHttpEntity) {\n            InputStream mInputStream = mHttpEntity.getContent();\n            String respose = converStreamToString(mInputStream);\n            Log.i(\"wangshu\", \"è¯·æ±‚çŠ¶æ€ç :\" + code + \"\\nè¯·æ±‚ç»“æœ:\\n\" + respose);\n            mInputStream.close();\n        }\n    } catch (IOException e) {\n            e.printStackTrace();\n    }\n}\n```\n\n# 2. HttpURLConnection\n`HttpURLConnection`è¾ƒ`HttpClient`æ¥è¯´æ›´è½»é‡ï¼Œè€Œä¸”ä»–`API`ä¹Ÿæ¯”`HttpClient`ç®€å•ã€‚ç‰¹åˆ«æ˜¯`Android 6.0`å°†`HttpClient`ç§»é™¤ä¹‹åï¼Œç°åœ¨åªèƒ½ä½¿ç”¨`HttpURLConnection`ã€‚\n## 2.1 HttpURLConnectionçš„POSTè¯·æ±‚\né¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªUrlConnManagerç±»ï¼Œç„¶åé‡Œé¢æä¾›getHttpURLConnection()æ–¹æ³•ç”¨äºé…ç½®é»˜è®¤çš„å‚æ•°å¹¶è¿”å›HttpURLConnectionï¼š\n```java\npublic static HttpURLConnection getHttpURLConnection(String url){\n    HttpURLConnection mHttpURLConnection=null;\n    try {\n        URL mUrl=new URL(url);\n        mHttpURLConnection=(HttpURLConnection)mUrl.openConnection();\n        //è®¾ç½®é“¾æ¥è¶…æ—¶æ—¶é—´\n        mHttpURLConnection.setConnectTimeout(15000);\n        //è®¾ç½®è¯»å–è¶…æ—¶æ—¶é—´\n        mHttpURLConnection.setReadTimeout(15000);\n        //è®¾ç½®è¯·æ±‚å‚æ•°\n        mHttpURLConnection.setRequestMethod(\"POST\");\n        //æ·»åŠ Header\n        mHttpURLConnection.setRequestProperty(\"Connection\",\"Keep-Alive\");\n        //æ¥æ”¶è¾“å…¥æµ\n        mHttpURLConnection.setDoInput(true);\n        //ä¼ é€’å‚æ•°æ—¶éœ€è¦å¼€å¯\n        mHttpURLConnection.setDoOutput(true);\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n    return mHttpURLConnection ;\n}\n```\nå› ä¸ºæˆ‘ä»¬è¦å‘é€POSTè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨UrlConnManagerç±»ä¸­å†å†™ä¸€ä¸ªpostParams()æ–¹æ³•ç”¨æ¥ç»„ç»‡ä¸€ä¸‹è¯·æ±‚å‚æ•°å¹¶å°†è¯·æ±‚å‚æ•°å†™å…¥åˆ°è¾“å‡ºæµä¸­ï¼š\n```java\npublic static void postParams(OutputStream output,List<NameValuePair>paramsList) throws IOException{\n    StringBuilder mStringBuilder=new StringBuilder();\n    for (NameValuePair pair:paramsList){\n        if(!TextUtils.isEmpty(mStringBuilder)){\n            mStringBuilder.append(\"&\");\n        }\n        mStringBuilder.append(URLEncoder.encode(pair.getName(),\"UTF-8\"));\n        mStringBuilder.append(\"=\");\n        mStringBuilder.append(URLEncoder.encode(pair.getValue(),\"UTF-8\"));\n    }\n    BufferedWriter writer=new BufferedWriter(new OutputStreamWriter(output,\"UTF-8\"));\n    writer.write(mStringBuilder.toString());\n    writer.flush();\n    writer.close();\n}\n```\næ¥ä¸‹æ¥æˆ‘ä»¬æ·»åŠ è¯·æ±‚å‚æ•°ï¼Œè°ƒç”¨postParams()æ–¹æ³•å°†è¯·æ±‚çš„å‚æ•°ç»„ç»‡å¥½ä¼ ç»™HttpURLConnectionçš„è¾“å‡ºæµï¼Œè¯·æ±‚è¿æ¥å¹¶å¤„ç†è¿”å›çš„ç»“æœï¼š\n```java\nprivate void useHttpUrlConnectionPost(String url) {\n    InputStream mInputStream = null;\n    HttpURLConnection mHttpURLConnection = UrlConnManager.getHttpURLConnection(url);\n    try {\n        List<NameValuePair> postParams = new ArrayList<>();\n        //è¦ä¼ é€’çš„å‚æ•°\n        postParams.add(new BasicNameValuePair(\"username\", \"moon\"));\n        postParams.add(new BasicNameValuePair(\"password\", \"123\"));\n        UrlConnManager.postParams(mHttpURLConnection.getOutputStream(), postParams);\n        mHttpURLConnection.connect();\n        mInputStream = mHttpURLConnection.getInputStream();\n        int code = mHttpURLConnection.getResponseCode();\n        String respose = converStreamToString(mInputStream);\n        Log.i(\"wangshu\", \"è¯·æ±‚çŠ¶æ€ç :\" + code + \"\\nè¯·æ±‚ç»“æœ:\\n\" + respose);\n        mInputStream.close();\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n}\n```\næœ€åå¼€å¯çº¿ç¨‹è¯·æ±‚ç½‘ç»œï¼š\n```java\nprivate void useHttpUrlConnectionGetThread() {\n    new Thread(new Runnable() {\n        @Override\n        public void run() {\n            useHttpUrlConnectionPost(\"http://www.baidu.com\");\n        }\n    }).start();\n}\n```","tags":["Android","kotlin","Volley","æºç "],"categories":["Android"]},{"title":"ijkPlayerç¼–è¯‘-Android","url":"/posts/d61d5542.html","content":"# 1. ç®€ä»‹\nijkplayeræ˜¯å“”å“©å“”å“©çš„ä¸€ä¸ªå¼€æºè§†é¢‘æ’­æ”¾æ¡†æ¶ï¼Œæ”¯æŒAndroidã€iOSã€‚åº•å±‚æ˜¯ffplayã€‚\n\nGithubåœ°å€ï¼š[bilibili/ijkplayer](https://github.com/bilibili/ijkplayer)\n<!-- More -->\n\n# 2. ç¼–è¯‘æ–¹æ³•\nç”±äºé€šè¿‡Gradleç¼–è¯‘èµ·æ¥å¾ˆæ…¢è€Œä¸”ä¸€æ—¦å¤±è´¥åˆå¾—é‡å¤´æ¥ï¼Œæ‰€ä»¥è¿™å—å°±ä½¿ç”¨AndroidNDKçš„æ–¹å¼æ¥ç¼–è¯‘ã€‚\n\n## 2.1 ç¼–è¯‘ä¹‹å‰\né¦–å…ˆä½ å¾—é…ç½®å¥½ç­‰ä¼šç¼–è¯‘éœ€è¦çš„ä¸œè¥¿ã€‚è¿™å—æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨[Homebrew](https://brew.sh/index_zh-cn)æ¥å®‰è£…gitå’Œyasmã€‚\nHomebrewç±»ä¼¼äºUbuntuçš„dpkgã€RedHatå’ŒcentOSçš„yumï¼Œä»–æ˜¯macOSä¸Šçš„ä¸€ä¸ªè½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚ä½†æ˜¯åæ¥å‡ºäº†Linuxç‰ˆã€‚\nç”±äºijkplayerå®˜æ–¹è¯´ç”¨çš„å®ƒï¼Œé‚£å’±ä»¬å°±ç”¨å®ƒå§ã€‚\n\n### Ubuntu\n#### 1. å…ˆæŠŠç›®å‰å·²æœ‰çš„åŒ…æ›´æ–°\n```bash\n// ä»é•œåƒç«™ä¸‹è½½è½¯ä»¶åˆ—è¡¨ï¼Œå¹¶æ£€æŸ¥æœ‰æ²¡æœ‰éœ€è¦æ›´æ–°çš„åŒ…\nsudo apt update\n\n// æ›´æ–°éœ€è¦æ›´æ–°çš„åŒ…\nsudo apt upgrade\n\n// è‡ªåŠ¨å¸è½½æ‰å½“åˆä¸ºäº†å®‰è£…å…¶ä»–è½¯ä»¶æˆ–å…¶ä»–åŸå› è€Œå®‰è£…ä½†æ˜¯ç›®å‰å·²ç»æ²¡ç”¨çš„åŒ…\nsudo apt autoremove\n```\n\n#### 2. å®‰è£…Homebrew\n\n\n```bash\n1. é¦–å…ˆç¡®å®šæ˜¯å¦å®‰è£…ruby  \n    apt install ruby'\n    \n2. ç„¶åé€šè¿‡rubyå®‰è£…Homebrew  \n    ruby -c \"$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)\"\n    \n3. å†é€šè¿‡Homebrewå®‰è£…gitå’Œyasm\n    brew install git\n    brew install yasm\n```\n\n#### 3. é…ç½®Android SDKå’ŒNDK\n1. Android SDK\n    ä½ å¯ä»¥æ‰“å¼€ä½ çš„AndroidStudioï¼Œè¿›å…¥`Preferences -> Appearance & Behavior -> System Settings -> Android SDK`ã€‚è¿™å—å°±ä¼šæ˜¾ç¤ºä½ SDKå®‰è£…ç›®å½•ã€‚\n    ç„¶ååœ¨ç»ˆç«¯ä¸­è¾“å…¥`vim ~/.bash_profile`ã€‚ç„¶åè¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n    \n    ```bash\n    export ANDROID_SDK_HOME=AndroidSDKçš„ç›®å½•/android-sdk-linux\n    export PATH=$PATH:${ANDROID_SDK_HOME}/tools\n    export PATH=$PATH:${ANDROID_SDK_HOME}/platform-tools\n    ```\n    ä¿å­˜ï¼Œç„¶åå†åœ¨ç»ˆç«¯è¾“å…¥`source ~/.bash_profile`ï¼Œå°±å¯ä»¥äº†ã€‚\n2. Android NDK\n    é¦–å…ˆä½ å¾—åˆ°å®˜ç½‘ä¸‹è½½NDKï¼š[NDK å½’æ¡£](https://developer.android.com/ndk/downloads/older_releases.html?hl=zh-cn)ã€‚è€Œä¸”ä½ åªèƒ½ä¸‹è½½r10eç‰ˆæœ¬çš„ï¼Œä¸‹è½½å…¶å®ƒç‰ˆæœ¬ç¼–è¯‘ä¼šæŠ¥é”™ã€‚\n    ä¸‹è½½ä¸‹æ¥è§£å‹åï¼ŒåŒæ ·å’Œä¸Šé¢ä¸€æ ·å¾—é…ç½®ç¯å¢ƒå˜é‡ï¼š\n    \n    ```bash\n    export ANDROID_NDK_HOME=NDKç›®å½•\n    export PATH=$PATH:${ANDROID_SDK_HOME}\n    ```\n    ä¿å­˜ï¼Œç„¶åå†åœ¨ç»ˆç«¯è¾“å…¥`source ~/.bash_profile`ï¼Œå°±å¯ä»¥äº†ã€‚\n\n### macOS\nå®‰è£…Homebrewï¼Œç”±äºmacOSè‡ªå¸¦rubyï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å¯ä»¥å¼€å§‹å®‰è£…Homebrewã€‚\n```bash\nruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\"\nbrew install git\nbrew install yasm\n```\nç„¶åå°±æ˜¯é…ç½®ä½ çš„Android SDKå’ŒAndroid NDKï¼š\nå’Œä¸Šé¢Ubuntuä¸‹ä¸€æ ·ã€‚\n\n## 2.2 ç¼–è¯‘Android\n\n```bash\ngit clone https://github.com/Bilibili/ijkplayer.git ijkplayer-android\ncd ijkplayer-android\ngit checkout -B latest k0.8.8\n\n./init-android.sh\n\ncd android/contrib\n./compile-ffmpeg.sh clean\n// è¿™æ­¥ç‰¹æ…¢ï¼Œè€—æ—¶å¾ˆé•¿\n./compile-ffmpeg.sh all\n\ncd ..\n./compile-ijk.sh all\n```\nä¸Šé¢è¿™äº›æ‰§è¡Œå®Œå°±å¯ä»¥äº†ã€‚\nç„¶åä½ å°±èƒ½åœ¨ä½ çš„`/ijkplayer-android/android/ijkplayer`è·¯å¾„ä¸‹å°±èƒ½çœ‹åˆ°ç¼–è¯‘åçš„é¡¹ç›®äº†ï¼Œå…¶ä¸­æ¯ä¸ª`moduleçš„/src/mian/libs`é‡Œé¢å°±æ˜¯soæ–‡ä»¶ã€‚\n\n# 3. æœ€å\nä½ å¯ä»¥ç›´æ¥é€šè¿‡AndroidStudioæ‰“å¼€`/ijkplayer-android/android/ijkplayer`ï¼Œç„¶ååœ¨é‡Œé¢çš„`/ijkplayer-example`ä¸‹è°¢ä½ è‡ªå·±çš„ä»£ç å°±å¯ä»¥äº†ã€‚","tags":["Android","ijkplayer","éŸ³è§†é¢‘"],"categories":["Android"]},{"title":"Androidç½‘ç»œè¯·æ±‚4--è§£æRetrofitæºç ","url":"/posts/a2a8de56.html","content":"# 1. Retrofitç®€ä»‹\n- [Retrofit - github](https://github.com/square/retrofit)\n- [Retrofit - Doc](https://square.github.io/retrofit/)\n\n`Retrofit`æ˜¯Squareå…¬å¸çš„åˆä¸€åŠ›ä½œï¼Œé’ˆå¯¹Androidç½‘ç»œè¯·æ±‚çš„æ¡†æ¶ï¼Œéµå¾ª`Restful`è®¾è®¡é£æ ¼ï¼Œåº•å±‚åŸºäº`OkHttp`ã€‚\n<!-- More -->\n\nä»–å¯¹æ¯”å…¶ä»–æ¡†æ¶\n- æ€§èƒ½æœ€å¥½\n- å°è£…ç¨‹åº¦é«˜ï¼Œæ‹“å±•æ€§å·®\n- ç®€ä»‹æ˜“ç”¨ï¼Œä»£ç ç®€å•\n- è§£è€¦å½»åº•\n- å¯ä»¥éå¸¸æ–¹ä¾¿çš„ä¸RxJavaè¿ç”¨\n\n# 2. Retrofitç”¨æ³•ï¼ˆå¼‚æ­¥ï¼‰\n## 2.1 æ·»åŠ ä¾èµ–\nå¯ä»¥åœ¨Retrofit Githubåº“é¡µé¢é‡Œé¢æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬å·ï¼Œæˆ‘å†™è¿™ç¯‡åšå®¢æ—¶æœ€æ–°ç‰ˆå¯¼å…¥æ–¹å¼\n\nåœ¨ä½ é¡¹ç›®çš„appçš„`build.gradle`é‡Œé¢æ·»åŠ \n`implementation 'com.squareup.retrofit2:retrofit:2.6.1'`\n\nåŒæ—¶ï¼Œå¦‚æœä½ éœ€è¦é…å¥—çš„æ•°æ®è½¬æ¢å™¨è¿˜éœ€è¦å¯¼å…¥ä»¥ä¸‹çš„ä¾èµ–\n- Gson: `com.squareup.retrofit2:converter-gson`\n- Jackson: `com.squareup.retrofit2:converter-jackson`\n- Moshi: `com.squareup.retrofit2:converter-moshi`\n- Protobuf: `com.squareup.retrofit2:converter-protobuf`\n- Wire: `com.squareup.retrofit2:converter-wire`\n- Simple XML: `com.squareup.retrofit2:converter-simplexml`\n- Scalars (primitives, boxed, and String): `com.squareup.retrofit2:converter-scalars`\n\n## 2.2 æ·»åŠ ç½‘ç»œæƒé™\nåœ¨ä½ APPçš„AndroidManifest.xmlé‡Œæ·»åŠ \n`<uses-permission android:name=\"android.permission.INTERNET\"/>\n`\n\n## 2.3 åˆ›å»º æ¥æ”¶æœåŠ¡å™¨è¿”å›æ•°æ® çš„ç±»\n*Reception.java*\n```java\npuublic class Reception {\n    // æ ¹æ®è¿”å›æ•°æ®çš„æ ¼å¼å’Œæ•°æ®è§£ææ–¹å¼å®šä¹‰\n    ...\n}\n```\n\n## 2.4 åˆ›å»º ç”¨äºæè¿°ç½‘ç»œè¯·æ±‚ çš„æ¥å£\n*GetRequest_Interface.interface*\n```java\npublic interface GetRequest_Interface {\n    @GET(\"openapi.do?keyfrom=Yanzhikai&key=2032414398&type=data&doctype=json&version=1.1&q=car\")\n    Call<Translation>  getCall();\n    // @GETæ³¨è§£çš„ä½œç”¨:é‡‡ç”¨Getæ–¹æ³•å‘é€ç½‘ç»œè¯·æ±‚\n \n    // getCall() = æ¥æ”¶ç½‘ç»œè¯·æ±‚æ•°æ®çš„æ–¹æ³•\n    // å…¶ä¸­è¿”å›ç±»å‹ä¸ºCall<*>ï¼Œ*æ˜¯æ¥æ”¶æ•°æ®çš„ç±»ï¼ˆå³ä¸Šé¢å®šä¹‰çš„Translationç±»ï¼‰\n    // å¦‚æœæƒ³ç›´æ¥è·å¾—Responsebodyä¸­çš„å†…å®¹ï¼Œå¯ä»¥å®šä¹‰ç½‘ç»œè¯·æ±‚è¿”å›å€¼ä¸ºCall<ResponseBody>\n}\n```\n\n## 2.5 åˆ›å»ºRetrofitå®ä¾‹\n```java\n Retrofit retrofit = new Retrofit.Builder()\n                .baseUrl(\"http://fanyi.youdao.com/\") // è®¾ç½®ç½‘ç»œè¯·æ±‚çš„Urlåœ°å€\n                .addConverterFactory(GsonConverterFactory.create()) // è®¾ç½®æ•°æ®è§£æå™¨\n                .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) // æ”¯æŒRxJavaå¹³å°\n                .build();\n```\n\n## 2.6 åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£å®ä¾‹\n```java\n// åˆ›å»º ç½‘ç»œè¯·æ±‚æ¥å£ çš„å®ä¾‹\nGetRequest_Interface request = retrofit.create(GetRequest_Interface.class);\n\n//å¯¹ å‘é€è¯·æ±‚ è¿›è¡Œå°è£…\nCall<Reception> call = request.getCall();\n```\n\n## 2.7 å‘é€ç½‘ç»œè¯·æ±‚\n```java\n//å‘é€ç½‘ç»œè¯·æ±‚(å¼‚æ­¥)\ncall.enqueue(new Callback<Translation>() {\n    //è¯·æ±‚æˆåŠŸæ—¶å›è°ƒ\n    @Override\n    public void onResponse(Call<Translation> call, Response<Translation> response) {\n        //è¯·æ±‚å¤„ç†,è¾“å‡ºç»“æœ\n        response.body().show();\n    }\n\n    //è¯·æ±‚å¤±è´¥æ—¶å€™çš„å›è°ƒ\n    @Override\n    public void onFailure(Call<Translation> call, Throwable throwable) {\n        System.out.println(\"è¿æ¥å¤±è´¥\");\n    }\n});\n```\n\n## 2.8 å¤„ç†è¿”å›æ•°æ®\n```java\n//å‘é€ç½‘ç»œè¯·æ±‚(å¼‚æ­¥)\ncall.enqueue(new Callback<Translation>() {\n    //è¯·æ±‚æˆåŠŸæ—¶å›è°ƒ\n    @Override\n    public void onResponse(Call<Translation> call, Response<Translation> response) {\n        // å¯¹è¿”å›æ•°æ®è¿›è¡Œå¤„ç†\n        response.body().show();\n    }\n\n    //è¯·æ±‚å¤±è´¥æ—¶å€™çš„å›è°ƒ\n    @Override\n    public void onFailure(Call<Translation> call, Throwable throwable) {\n        System.out.println(\"è¿æ¥å¤±è´¥\");\n    }\n});\n```\n\nç”±äºæœ¬æ–‡çš„æ ¸å¿ƒä¸æ˜¯è®²ç”¨æ³•ï¼Œæ‰€ä»¥å…³äºç”¨æ³•è¿™å—ï¼Œæˆ‘å¹¶æ²¡æœ‰å¤šè®²ï¼Œå¤§å®¶è‹¥æƒ³å¤šäº†è§£ï¼Œå¯ä»¥çœ‹æ­¤åšå®¢ï¼š[è¿™æ˜¯ä¸€ä»½å¾ˆè¯¦ç»†çš„ Retrofit 2.0 ä½¿ç”¨æ•™ç¨‹ï¼ˆå«å®ä¾‹è®²è§£ï¼‰](https://blog.csdn.net/carson_ho/article/details/73732076)\n\n# 3. Retrofitæºç \n## 3.1 Retrofitå¯¹è±¡æ„é€ æºç \nåº”å¯¹ä¸€ä¸ªæ¡†æ¶çš„æºç é¦–å…ˆä»ä½¿ç”¨å®ƒçš„åœ°æ–¹å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹`Retrofit`çš„åˆ›å»ºä»£ç ï¼š\n```java\n Retrofit retrofit = new Retrofit.Builder()\n        .baseUrl(\"http://fanyi.youdao.com/\")\n        .addConverterFactory(GsonConverterFactory.create())\n        .build();\n```\n\næˆ‘ä»¬å¯ä»¥æŠŠå®ƒåˆ†ä¸º5ä¸ªéƒ¨åˆ†æ¥åˆ†ææºç ï¼š\n![æºç åˆ†ææ­¥éª¤](https://user-gold-cdn.xitu.io/2018/3/7/161fdeda6c0120c1?imageslim)\n\næˆ‘ä»¬é¦–å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥\n\n### 3.1.1 æ­¥éª¤1ï¼šRetrofitç±»\n```java\npublic final class Retrofit {\n    private final Map<Method, ServiceMethod<?>> serviceMethodCache = new ConcurrentHashMap<>();\n  \n    // ç½‘ç»œè¯·æ±‚å·¥å‚\n    final okhttp3.Call.Factory callFactory;\n    // è¯·æ±‚çš„Urlåœ°å€\n    final HttpUrl baseUrl;\n    // æ•°æ®è½¬æ¢å™¨å·¥å‚çš„é›†åˆ\n    final List<Converter.Factory> converterFactories;\n    // ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚çš„é›†åˆ\n    final List<CallAdapter.Factory> callAdapterFactories;\n    // å›è°ƒ\n    final @Nullable Executor callbackExecutor;\n    // æ˜¯å¦æå‰å¯¹ä¸šåŠ¡æ¥å£ä¸­çš„æ³¨è§£è¿›è¡ŒéªŒè¯è½¬æ¢çš„æ ‡å¿—ä½\n    final boolean validateEagerly;\n\n    Retrofit(okhttp3.Call.Factory callFactory, HttpUrl baseUrl,\n        List<Converter.Factory> converterFactories, List<CallAdapter.Factory> callAdapterFactories,\n        @Nullable Executor callbackExecutor, boolean validateEagerly) {\n        this.callFactory = callFactory;\n        this.baseUrl = baseUrl;\n        this.converterFactories = converterFactories; // Copy+unmodifiable at call site.\n        this.callAdapterFactories = callAdapterFactories; // Copy+unmodifiable at call site.\n        this.callbackExecutor = callbackExecutor;\n        this.validateEagerly = validateEagerly;\n    }\n    ...// çœç•¥åé¢çš„ä»£ç \n}\n```\nå¯ä»¥çœ‹åˆ°ï¼Œ`Retrofit`çš„æ„é€ æ–¹æ³•éœ€è¦ä¸€æ¬¡æ€§æŠŠéœ€è¦çš„æ•°æ®å…¨éƒ¨å‡†å¤‡å¥½ã€‚\nè€Œä¸”è¿™å—æœ‰ç‰¹åˆ«å¤šçš„å·¥å‚ï¼Œä½¿ç”¨äº†å·¥å‚æ¨¡å¼ã€‚è¿™ä¸ªæˆ‘ä»¬ä¹‹åå†è®²ï¼Œæ¥ä¸‹æ¥çœ‹æ­¥éª¤2ï¼š\n\n### 3.1.2 æ­¥éª¤2ï¼šBuilder()æ–¹æ³•\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹`Builder()`æ–¹æ³•çš„æºç ï¼š\n```java\npublic Builder() {\n    this(Platform.get());\n}\n```\n\nè¿™é‡Œè°ƒç”¨äº†`Rlatform.get()`æ–¹æ³•ï¼š\n```java\nstatic Platform get() {\n    return PLATFORM;\n}\n```\n\n`PLATFORM`çš„å®šä¹‰å°±åœ¨ä¸Šé¢ï¼š\n```java\nprivate static final Platform PLATFORM = findPlatform();\n```\n\næˆ‘ä»¬å†æ¥çœ‹ä¸‹`findPlatform()`æ–¹æ³•ï¼š\n```java\nprivate static Platform findPlatform() {\n    try {\n        Class.forName(\"android.os.Build\");\n        if (Build.VERSION.SDK_INT != 0) {\n            return new Android();\n        }\n    } catch (ClassNotFoundException ignored) {\n    }\n    return new Platform(true);\n}\n```\n\nè¿™å—åˆ›å»ºäº†ä¸€ä¸ª`Android`å¯¹è±¡ï¼Œæ¥ç€è¿”å›äº†ä¼ å…¥`true`åˆ›å»ºçš„`Platform`å¯¹è±¡ã€‚æˆ‘ä»¬å†æ¥çœ‹ä¸‹`Android`ç±»ï¼š\n```java\nstatic final class Android extends Platform {\n    Android() {\n        super(Build.VERSION.SDK_INT >= 24);\n    }\n\n    @Override public Executor defaultCallbackExecutor() {\n        // è¿”å›ä¸€ä¸ªé»˜è®¤çš„å›è°ƒæ–¹æ³•æ‰§è¡Œå™¨\n        // è¯¥æ‰§è¡Œå™¨ä½œç”¨ï¼šåˆ‡æ¢çº¿ç¨‹ï¼ˆå­->>ä¸»çº¿ç¨‹ï¼‰ï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œå›è°ƒæ–¹æ³•\n        return new MainThreadExecutor();\n    }\n\n    static class MainThreadExecutor implements Executor {\n        // è·å–ä¸Android ä¸»çº¿ç¨‹ç»‘å®šçš„Handler \n        private final Handler handler = new Handler(Looper.getMainLooper());\n\n        @Override public void execute(Runnable r) {\n            // è¯¥Handleræ˜¯ä¸Šé¢è·å–çš„ä¸Android ä¸»çº¿ç¨‹ç»‘å®šçš„Handler \n            // åœ¨UIçº¿ç¨‹è¿›è¡Œå¯¹ç½‘ç»œè¯·æ±‚è¿”å›æ•°æ®å¤„ç†ç­‰æ“ä½œã€‚\n            handler.post(r);\n        }\n    }\n}\n```\n\n### 3.1.3 æ­¥éª¤3ï¼šbaseUrl()æ–¹æ³•\n```java\npublic Builder baseUrl(String baseUrl) {\n    Objects.requireNonNull(baseUrl, \"baseUrl == null\");\n    return baseUrl(HttpUrl.get(baseUrl));\n}\n```\n\næœ€åè¿˜æ˜¯è°ƒç”¨äº†ä¸€ä¸ª`baseUrl()`æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª`baseUrl()`æ–¹æ³•ï¼š\n```java\npublic Builder baseUrl(HttpUrl baseUrl) {\n    Objects.requireNonNull(baseUrl, \"baseUrl == null\");\n    // æŠŠURLå‚æ•°åˆ†å‰²æˆå‡ ä¸ªè·¯å¾„ç¢ç‰‡\n    List<String> pathSegments = baseUrl.pathSegments();\n    // æ£€æµ‹æœ€åä¸€ä¸ªç¢ç‰‡æ¥æ£€æŸ¥URLå‚æ•°æ˜¯ä¸æ˜¯ä»¥\"/\"ç»“å°¾,ä¸æ˜¯å°±æŠ›å‡ºå¼‚å¸¸\t\n    if (!\"\".equals(pathSegments.get(pathSegments.size() - 1))) {\n        throw new IllegalArgumentException(\"baseUrl must end in /: \" + baseUrl);\n    }\n    this.baseUrl = baseUrl;\n    return this;\n}\n```\næ­¥éª¤3ç”¨äºè®¾ç½®ç½‘ç»œè¯·æ±‚çš„`Url`\n\n### 3.1.4 æ­¥éª¤4ï¼šaddConverterFactory()æ–¹æ³•\næˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`GsonConverterFactory.create()`æ–¹æ³•ï¼š\n```java\npublic static GsonConverterFactory create() {\n    return create(new Gson());\n}\n```\n\nåˆè°ƒç”¨äº†å¦ä¸€ä¸ª`create()`æ–¹æ³•ï¼š\n```java\npublic static GsonConverterFactory create(Gson gson) {\n    if (gson == null) throw new NullPointerException(\"gson == null\");\n    return new GsonConverterFactory(gson);\n}\n```\n\nå¦‚æœä¼ å…¥çš„`gson`ä¸ºç©ºå°±æŠ¥å¼‚å¸¸ï¼Œä¸ä¸ºç©ºå°±è°ƒç”¨`GsonConverterFactory`çš„æ„é€ æ–¹æ³•ï¼š\n```java\nprivate GsonConverterFactory(Gson gson) {\n    this.gson = gson;\n}\n```\n\næ‰€ä»¥è¿™ä¸ªæ–¹æ³•æœ¬è´¨å°±æ˜¯è¿”å›äº†ä¸€ä¸ª`gson`å¯¹è±¡ç»™äº†`addConverterFactory()`æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š\n```java\n/** ä¸ºå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ·»åŠ è½¬æ¢å™¨å·¥å‚ã€‚ */\npublic Builder addConverterFactory(Converter.Factory factory) {\n    converterFactories.add(Objects.requireNonNull(factory, \"factory == null\"));\n    return this;\n}\n```\næ­¥éª¤4åˆ›å»ºäº†ä¸€ä¸ªå«æœ‰`Gson`å®ä¾‹çš„`GsonConverterFactory`å¯¹è±¡ï¼Œå¹¶æ”¾å…¥äº†`ConverterFactory`ã€‚\n\n### 3.1.5 æ­¥éª¤5ï¼šbuild()æ–¹æ³•\n```java\npublic Retrofit build() {\n    if (baseUrl == null) {\n        throw new IllegalStateException(\"Base URL required.\");\n    }\n    // é…ç½®ç½‘ç»œè¯·æ±‚æ‰§è¡Œå™¨\n    okhttp3.Call.Factory callFactory = this.callFactory;\n    // å¦‚æœæ²¡æœ‰æŒ‡å®šcallFactoryï¼Œåˆ™åˆ›å»ºOkHttpClient\n    if (callFactory == null) {\n        callFactory = new OkHttpClient();\n    }\n    // é…ç½®å›è°ƒæ‰§è¡Œå™¨\n    Executor callbackExecutor = this.callbackExecutor;\n    if (callbackExecutor == null) {\n        callbackExecutor = platform.defaultCallbackExecutor();\n    }\n\n    // é…ç½®ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚\n    List<CallAdapter.Factory> callAdapterFactories = new ArrayList<>(this.callAdapterFactories);\n    callAdapterFactories.addAll(platform.defaultCallAdapterFactories(callbackExecutor));\n\n    // é…ç½®æ•°æ®è½¬æ¢å™¨å·¥å‚\n    List<Converter.Factory> converterFactories = new ArrayList<>(\n        1 + this.converterFactories.size() + platform.defaultConverterFactoriesSize());\n\n    // é¦–å…ˆæ·»åŠ å†…ç½®è½¬æ¢å™¨å·¥å‚ã€‚è¿™å¯ä»¥é˜²æ­¢é‡å†™å®ƒçš„è¡Œä¸ºï¼Œä½†ä¹Ÿå¯ä»¥ç¡®ä¿åœ¨ä½¿ç”¨ä½¿ç”¨ä½¿ç”¨æ‰€æœ‰ç±»å‹çš„è½¬æ¢å™¨æ—¶æ­£ç¡®çš„è¡Œä¸ºã€‚\n    converterFactories.add(new BuiltInConverters());\n    converterFactories.addAll(this.converterFactories);\n    converterFactories.addAll(platform.defaultConverterFactories());\n\n    return new Retrofit(callFactory, baseUrl, unmodifiableList(converterFactories),\n        unmodifiableList(callAdapterFactories), callbackExecutor, validateEagerly);\n}\n```\næŒ‰å‰é¢é…ç½®çš„å˜é‡ï¼Œå°†`Retrofit`æ‰€æœ‰çš„å˜é‡éƒ½é…ç½®å¥½ï¼Œæœ€åå®Œæˆåˆ›å»º`Retrofit`å®ä¾‹ã€‚\n\nåˆ°è¿™Retrofitçš„åˆ›å»ºéƒ¨åˆ†å°±å®Œäº†ã€‚\nRetrofité€šè¿‡å»ºé€ è€…æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªRetrofitå®ä¾‹ï¼š\n- è¯·æ±‚å·¥å‚callFactoryï¼šé»˜è®¤æ˜¯OkHttpClient\n- æ•°æ®è½¬æ¢å™¨å·¥å‚converterFactories\n- ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚callAdapterFactoriesï¼šé»˜è®¤æ˜¯ExecutorCallAdapterFactory\n- å›è°ƒæ‰§è¡Œå™¨callbackExecutor\n\n![Retrofitå¯¹è±¡æ„å»ºæµç¨‹](http://cdn.littlecorgi.top/mweb/Retrofitå¯¹è±¡æ„å»ºæµç¨‹.jpg)\n\n\n## 3.2 åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹\nå¤§è‡´åˆ›å»ºæ–¹æ³•å¦‚ä¸‹ï¼š\n```java\n<!-- Reception.java -->\npuublic class Reception {\n    // æ ¹æ®è¿”å›æ•°æ®çš„æ ¼å¼å’Œæ•°æ®è§£ææ–¹å¼å®šä¹‰\n    ...\n}\n\n<!-- GetRequest_Interface.interface -->\npublic interface GetRequest_Interface {\n    @GET(\"openapi.do?keyfrom=Yanzhikai&key=2032414398&type=data&doctype=json&version=1.1&q=car\")\n    Call<Translation>  getCall();\n    // @GETæ³¨è§£çš„ä½œç”¨:é‡‡ç”¨Getæ–¹æ³•å‘é€ç½‘ç»œè¯·æ±‚\n \n    // getCall() = æ¥æ”¶ç½‘ç»œè¯·æ±‚æ•°æ®çš„æ–¹æ³•\n    // å…¶ä¸­è¿”å›ç±»å‹ä¸ºCall<*>ï¼Œ*æ˜¯æ¥æ”¶æ•°æ®çš„ç±»ï¼ˆå³ä¸Šé¢å®šä¹‰çš„Translationç±»ï¼‰\n    // å¦‚æœæƒ³ç›´æ¥è·å¾—Responsebodyä¸­çš„å†…å®¹ï¼Œå¯ä»¥å®šä¹‰ç½‘ç»œè¯·æ±‚è¿”å›å€¼ä¸ºCall<ResponseBody>\n}\n\n<!-- MainActivity.java -->\n// åˆ›å»º ç½‘ç»œè¯·æ±‚æ¥å£ çš„å®ä¾‹\nGetRequest_Interface request = retrofit.create(GetRequest_Interface.class);\n//å¯¹ å‘é€è¯·æ±‚ è¿›è¡Œå°è£…\nCall<Reception> call = request.getCall();\n```\n\næˆ‘ä»¬å…ˆçœ‹çœ‹`retrofit.create()`å¹²äº†å•¥ï¼š\n```java\npublic <T> T create(final Class<T> service) {\n    validateServiceInterface(service);\n    return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class<?>[] { service },\n        new InvocationHandler() {\n            private final Platform platform = Platform.get();\n            private final Object[] emptyArgs = new Object[0];\n\n            @Override public @Nullable Object invoke(Object proxy, Method method,\n                    @Nullable Object[] args) throws Throwable {\n                // å¦‚æœè¯¥æ–¹æ³•æ˜¯æ¥è‡ªå¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ™æ¨è¿Ÿåˆ°æ­£å¸¸è°ƒç”¨ã€‚\n                if (method.getDeclaringClass() == Object.class) {\n                    return method.invoke(this, args);\n                }\n                if (platform.isDefaultMethod(method)) {\n                    return platform.invokeDefaultMethod(method, service, proxy, args);\n                }\n                return loadServiceMethod(method).invoke(args != null ? args : emptyArgs);\n            }\n        });\n}\n```\né¦–å…ˆè°ƒç”¨äº†`validateServiceInterface()`è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š\n```java\nprivate void validateServiceInterface(Class<?> service) {\n    // å¦‚æœä¸æ˜¯æ¥å£å°±æŠ›å¼‚å¸¸\n    if (!service.isInterface()) {\n        throw new IllegalArgumentException(\"API declarations must be interfaces.\");\n    }\n\n    // æ„é€ äº†ä¸€ä¸ªå®¹é‡ä¸‹é™ä¸º1çš„ç©ºåŒå‘é˜Ÿåˆ—æ¥å­˜å‚¨æ•°æ®\n    Deque<Class<?>> check = new ArrayDeque<>(1);\n    // æ·»åŠ åˆ°é˜Ÿåˆ—\n    check.add(service);\n    while (!check.isEmpty()) {\n        // å°†é˜Ÿåˆ—çš„æ­£å‘ç¬¬ä¸€ä¸ªå…ƒç´ ç§»é™¤\n        Class<?> candidate = check.removeFirst();\n        // getTypeParameters()çš„ä½œç”¨æ˜¯å¾—åˆ°æ³›å‹ç±»å‹ï¼Œå¦‚æœæ³›å‹çš„æ•°é‡ä¸ä¸º0çš„è¯è¿›å…¥\n        if (candidate.getTypeParameters().length != 0) {\n            StringBuilder message = new StringBuilder(\"Type parameters are unsupported on \")\n                .append(candidate.getName());\n            if (candidate != service) {\n                message.append(\" which is an interface of \")\n                    .append(service.getName());\n            }\n            throw new IllegalArgumentException(message.toString());\n        }\n        Collections.addAll(check, candidate.getInterfaces());\n    }\n\n    if (validateEagerly) {\n        Platform platform = Platform.get();\n        for (Method method : service.getDeclaredMethods()) {\n            if (!platform.isDefaultMethod(method) && !Modifier.isStatic(method.getModifiers())) {\n                loadServiceMethod(method);\n            }\n        }\n    }\n}\n```\nè·å–åˆ°`Platform`ï¼ˆå¹³å°ï¼‰ï¼Œç„¶åå†éå†æ¥å£ä¸­çš„æ–¹æ³•ï¼Œè°ƒç”¨`loadServiceMethod()`æ–¹æ³•ï¼š\n```java\nServiceMethod<?> loadServiceMethod(Method method) {\n    ServiceMethod<?> result = serviceMethodCache.get(method);\n    if (result != null) return result;\n\n    synchronized (serviceMethodCache) {\n        result = serviceMethodCache.get(method);\n        if (result == null) {\n            result = ServiceMethod.parseAnnotations(this, method);\n            serviceMethodCache.put(method, result);\n        }\n    }\n    return result;\n}\n```\nè¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯é€šè¿‡`serviceMethodCache`æ¥å­˜å‚¨è½¬æ¢ä¸º`ServiceMethod`ç±»å‹çš„`Method`ã€‚\n\né‚£æˆ‘ä»¬åœ¨å›è¿‡å»çœ‹`InvocationHandler`çš„`invoke()`æ–¹æ³•ã€‚\n```java\nnew InvocationHandler() {\n    private final Platform platform = Platform.get();\n    private final Object[] emptyArgs = new Object[0];\n\n    @Override public @Nullable Object invoke(Object proxy, Method method,\n            @Nullable Object[] args) throws Throwable {\n        // å¦‚æœè¯¥æ–¹æ³•æ˜¯æ¥è‡ªå¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ™æ¨è¿Ÿåˆ°æ­£å¸¸è°ƒç”¨ã€‚\n        if (method.getDeclaringClass() == Object.class) {\n            return method.invoke(this, args);\n        }\n        if (platform.isDefaultMethod(method)) {\n            return platform.invokeDefaultMethod(method, service, proxy, args);\n        }\n        return loadServiceMethod(method).invoke(args != null ? args : emptyArgs);\n    }\n});\n```\nä¸¤ä¸ªifå…ˆä¸ç®¡ï¼Œå…ˆçœ‹æœ€åçš„`return`ï¼Œå¯ä»¥çœ‹åˆ°ä»–è°ƒç”¨äº†ä¸€ä¸ª`loadServiceMethod()`æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åœ¨å‰é¢å°±è¯´è¿‡ï¼Œä¸»è¦å°±è¿”å›äº†ä¸€ä¸ª`ServiceMethod`ã€‚é‚£æˆ‘ä»¬æ¥ç€æ¥çœ‹`invoke()`æ–¹æ³•ï¼š\næŒ‰ä½`command+é¼ æ ‡å·¦é”®`è¿›å…¥åï¼Œæ˜¾ç¤ºçš„æ˜¯ï¼š\n```java\nabstract class ServiceMethod<T> {\n  static <T> ServiceMethod<T> parseAnnotations(Retrofit retrofit, Method method) {\n    RequestFactory requestFactory = RequestFactory.parseAnnotations(retrofit, method);\n\n    Type returnType = method.getGenericReturnType();\n    if (Utils.hasUnresolvableType(returnType)) {\n      throw methodError(method,\n          \"Method return type must not include a type variable or wildcard: %s\", returnType);\n    }\n    if (returnType == void.class) {\n      throw methodError(method, \"Service methods cannot return void.\");\n    }\n\n    return HttpServiceMethod.parseAnnotations(retrofit, method, requestFactory);\n  }\n\n  abstract @Nullable T invoke(Object[] args);\n}\n```\nè¿™ä¸ª`invoke()`æ ¹æœ¬å°±æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•å•Šï¼Œç„¶åæˆ‘åˆå›å»æ‰¾çœ‹çœ‹æœ‰æ²¡æœ‰è¯´æ˜¯å“ªä¸ªç»§æ‰¿è‡ª`ServiceMethod`çš„ç±»å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œç»“æœä¹Ÿæ²¡æ‰¾åˆ°ï¼Œæœ€åæƒ³åˆ°äº†AndroidStudioå¯ä»¥`command+å·¦é”®`æ‰¾å®ç°äº†è¿™ä¸ªç±»çš„åœ°æ–¹å•Šã€‚äºæ˜¯æˆ‘å°±ç‚¹äº†ä¸‹è¿™ä¸ªç±»ï¼Œç»“æœæˆåŠŸæ‰¾åˆ°äº†`HttpServiceMethod`è¿™ä¸ªç±»ï¼Œä»–æ˜¯`ServiceMethod`çš„å­ç±»ä¸­å”¯ä¸€ä¸€ä¸ªå®ç°äº†`invoke()`æ–¹æ³•çš„ï¼š\n```java\n@Override final @Nullable ReturnT invoke(Object[] args) {\n    Call<ResponseT> call = new OkHttpCall<>(requestFactory, args, callFactory, responseConverter);\n    return adapt(call, args);\n}\n```\n\nå¯ä»¥çœ‹åˆ°è¿™å—ä»–åˆ›å»ºäº†ä¸€ä¸ªOkHttpCallå¯¹è±¡ï¼Œæ­¤å¤„ä¸åšè¯¦è§£ï¼Œå¯ä»¥çœ‹æˆ‘å…³äºOkHttpçš„ä¸€ç¯‡åšå®¢ï¼š[Androidç½‘ç»œè¯·æ±‚3--è§£æOkHttpæºç ](https://www.littlecorgi.top/posts/151ac78a.html)ã€‚ç„¶åè°ƒç”¨äº†adaptæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•:\n```java\nprotected abstract @Nullable ReturnT adapt(Call<ResponseT> call, Object[] args);\n```\nè¿™åˆæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚åªä¸è¿‡å¥½çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¸‹é¢æˆ‘ä»¬å°±æ‰¾åˆ°äº†ä»–çš„å®ç°ï¼š\n```java\nstatic final class CallAdapted<ResponseT, ReturnT> extends HttpServiceMethod<ResponseT, ReturnT> {\n    private final CallAdapter<ResponseT, ReturnT> callAdapter;\n\n    CallAdapted(RequestFactory requestFactory, okhttp3.Call.Factory callFactory,\n            Converter<ResponseBody, ResponseT> responseConverter,\n            CallAdapter<ResponseT, ReturnT> callAdapter) {\n        super(requestFactory, callFactory, responseConverter);\n        this.callAdapter = callAdapter;\n    }\n\n    @Override protected ReturnT adapt(Call<ResponseT> call, Object[] args) {\n        return callAdapter.adapt(call);\n    }\n}\n```\nå¯æ˜¯ä»–åˆè¿”å›ç»™äº†ä¸€ä¸ª`CallAdapter`æ¥å£çš„å®ç°ç±»çš„`adapt()`æ–¹æ³•ã€‚ã€‚ã€‚ã€‚è‰¹\n\næ‰€ä»¥ï¼Œè¿™å—æˆ‘å°±ä¸æ‡‚äº†ï¼Œæˆ‘ä¸çŸ¥é“ä»–åˆ°åº•å’‹å®ç°è¿™ä¸ªçš„è¿™ä¸ªæ–¹æ³•çš„ï¼Œæˆ‘çœ‹äº†ã€ŠAndroidè¿›é˜¶ä¹‹å…‰ã€‹å’Œå…¶å®ƒå¾ˆå¤šåšå®¢ï¼Œä»–ä»¬éƒ½æ˜¯è€ç‰ˆæœ¬çš„`Retrofit`ï¼Œ`create()`æ–¹æ³•ä¸åŒï¼Œè€Œä¸”è°ƒç”¨çš„`adapt()`æ–¹æ³•ä¹Ÿä¸åŒã€‚ã€‚ã€‚\n\n![Retrofitç½‘ç»œè¯·æ±‚æ¥å£åˆ›å»º](http://Â¡cdn.littlecorgi.top/mweb/Retrofitç½‘ç»œè¯·æ±‚æ¥å£åˆ›å»º.jpg)\n\n\n## 3.3 ç½‘ç»œè¯·æ±‚\nç½‘ç»œè¯·æ±‚è¿™å—Retrofitå®é™…ä¸Šå°±æ˜¯ç”¨OkHttpå®ç°çš„ï¼Œæ‰€ä»¥è¿™å—æˆ‘å°±ä¸åœ¨è¿™å¤šè¯´äº†ï¼Œå¤§å®¶è¦äº†è§£çš„å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„åšå®¢ï¼š[Androidç½‘ç»œè¯·æ±‚3--è§£æOkHttpæºç ](https://www.littlecorgi.top/posts/151ac78a.html)ã€‚\n\n","tags":["Android","kotlin","æºç ","OkHttp","Retrofit"],"categories":["Android"]},{"title":"æ“ä½œç³»ç»Ÿ4--è¿›ç¨‹çš„é€šä¿¡å’Œçº¿ç¨‹","url":"/posts/30b7e738.html","content":">å¤§å®¶å¯ä»¥çœ‹ä¸‹æˆ‘ä½¿ç”¨å¹•å¸ƒè½¯ä»¶ç”»çš„[æ€ç»´å¯¼å›¾](https://mubu.com/doc/3Pf0zwzrgw)ï¼Œå¦‚æœå¤§å®¶æƒ³ä½¿ç”¨å¹•å¸ƒå¯ä»¥é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œï¼Œå¯å…è´¹è·å¾—ä¸€ä¸ªæœˆé«˜çº§ä¼šå‘˜https://mubu.com/inv/477598\n<!-- More -->\n# 4.1 è¿›ç¨‹é€šä¿¡\nè¿›ç¨‹é€šä¿¡å°±æ˜¯æŒ‡è¿›ç¨‹ä¹‹é—´çš„ä¿¡æ¯äº¤æ¢ã€‚\n\næ—©æœŸçš„æ—¶å€™ï¼Œç”±äºæŠ€æœ¯ä¸å‘è¾¾ï¼Œä»¥åŠç”±äºè¿›ç¨‹çš„åŒæ­¥å’Œäº’æ–¥éœ€è¦åœ¨è¿›ç¨‹é—´äº¤æ¢ä¸€å®šçš„æ•°æ®ï¼Œæ‰€ä»¥ä¸å°‘äººä¹Ÿå°†ä»–ä»¬ç§°ä¸ºè¿›ç¨‹é€šä¿¡ï¼Œä½†æ˜¯å®è´¨ä¸Šä»–ä»¬åªèƒ½è¢«æˆä¸ºä½çº§çš„è¿›ç¨‹é€šä¿¡ã€‚\nä»¥ä¿¡å·é‡ä¸ºä¾‹ï¼Œä»–\n1. æ•ˆç‡ä½\n    ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…æ¯æ¬¡åªèƒ½å‘ç¼“å†²åŒºæŠ•æ”¾ä¸€ä¸ªäº§å“æˆ–è€…å–å‡ºä¸€ä¸ªäº§å“ã€‚\n2. é€šä¿¡å¯¹ç”¨æˆ·ä¸é€æ˜\n\nè€Œå…³äºè¿›ç¨‹é—´é€šä¿¡æ‰€éœ€çš„æ•°æ®ç»“æ„çš„è®¾ç½®å’Œæ•°æ®çš„ä¼ é€ã€è¿›ç¨‹çš„åŒæ­¥å’Œäº’æ–¥ï¼Œéƒ½éœ€è¦ç¨‹åºå‘˜å»å®Œæˆï¼Œæ˜¾ç„¶æ˜¯éå¸¸ä¸æ–¹ä¾¿çš„ã€‚\n\næ‰€ä»¥é«˜çº§è¿›ç¨‹é€šä¿¡å¿…é¡»æ»¡è¶³å¦‚ä¸‹ç‰¹ç‚¹ï¼š\n1. ä½¿ç”¨æ–¹ä¾¿ã€‚\n    OSéšè—äº†å®ç°è¿›ç¨‹é€šä¿¡çš„å…·ä½“ç»†èŠ‚ï¼Œå‘ç”¨æˆ·æä¾›äº†ä¸€ç»„ç”¨äºå®ç°é«˜çº§é€šä¿¡çš„å‘½ä»¤ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°ç›´æ¥åˆ©ç”¨å®ƒå®ç°è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚\n2. é«˜æ•ˆçš„ä¼ é€æ•°æ®ã€‚\n    ç”¨æˆ·å¯ä»¥ç›´æ¥åˆ©ç”¨é«˜çº§é€šä¿¡å‘½ä»¤é«˜æ•ˆçš„ä¼ é€å¤§é‡çš„æ•°æ®ã€‚\n    \nè¿›ç¨‹é€šä¿¡ä¸»è¦æœ‰å…±äº«å­˜å‚¨å™¨ç³»ç»Ÿã€ç®¡é“é€šä¿¡ç³»ç»Ÿã€æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿä»¥åŠå®¢æˆ·æœº-æœåŠ¡å™¨ç³»ç»Ÿã€‚\n## 4.1.1 å…±äº«å­˜å‚¨å™¨ç³»ç»Ÿ\nå…±äº«å­˜å‚¨å™¨ç³»ç»Ÿåˆåˆ†ä¸ºäº†ä¸¤ç§ï¼š\n1. åŸºäºå…±äº«æ•°æ®ç»“æ„çš„é€šä¿¡æ–¹å¼\n    åœ¨è¿™ç§é€šä¿¡æ–¹å¼ä¸‹ï¼Œè¦æ±‚è¿›ç¨‹å…¬ç”¨æŸäº›æ•°æ®ç»“æ„ï¼Œå€Ÿä»¥å®ç°è¯¸è¿›ç¨‹é—´çš„ä¿¡æ¯äº¤æ¢ã€‚è¿™ç§æ–¹å¼ä»…é€‚ç”¨äºä¼ é€’ç›¸å¯¹å°‘é‡çš„æ•°æ®ï¼Œé€šä¿¡æ•ˆç‡ä½ä¸‹ï¼Œå±äºä½çº§é€šä¿¡ã€‚\n2. åŸºäºå…±äº«å­˜å‚¨åŒºçš„é€šä¿¡æ–¹å¼\n    ä¸ºäº†ä¼ è¾“å¤§é‡æ•°æ®ï¼Œå°±åœ¨å†…å­˜ä¸­åˆ’å‡ºäº†ä¸€å—å…±äº«å­˜å‚¨åŒºåŸŸï¼Œè¯¸è¿›ç¨‹å¯é€šè¿‡å¯¹è¯¥å…±äº«åŒºçš„è¯»æˆ–å†™äº¤æ¢æ•°æ®ï¼Œå®ç°é€šä¿¡ï¼Œæ•°æ®çš„å½¢å¼å’Œä½ç½®ç”šè‡³è®¿é—®æ§åˆ¶éƒ½æ˜¯ç”±è¿›ç¨‹è´Ÿè´£ï¼Œè€Œä¸æ˜¯OSã€‚\n\n## 4.1.2 ç®¡é“é€šä¿¡ç³»ç»Ÿ\næ‰€è°“ç®¡é“ï¼Œæ˜¯æŒ‡ç”¨äºè¿æ¥ä¸€ä¸ªè¯»è¿›ç¨‹å’Œä¸€ä¸ªå†™è¿›ç¨‹ä»¥å®ç°ä»–ä»¬ä¹‹é—´é€šä¿¡çš„ä¸€å—å…±äº«å­˜å‚¨æ–‡ä»¶ï¼Œåˆå«pipeæ–‡ä»¶ã€‚\nå‘ç®¡é“æä¾›è¾“å…¥çš„å‘é€è¿›ç¨‹ä»¥å­—ç¬¦æµå½¢å¼å°†è¾¾é‡çš„æ•°æ®é€å…¥ç®¡é“ï¼Œè€Œæ¥æ”¶ç®¡é“è¾“å‡ºçš„æ¥æ”¶è¿›ç¨‹åˆ™ä»ç®¡é“ä¸­æ¥æ”¶æ•°æ®ã€‚\nè¿™ç§æ–¹å¼æ˜¯UNIXç³»ç»ŸIPCæœ€å¤è€çš„å½¢å¼ã€‚\n\nä¸ºäº†åè°ƒåŒæ–¹çš„é€šä¿¡ï¼Œä»–å¿…é¡»æä¾›ä¸€ä¸‹ä¸‰ä¸ªåŠŸèƒ½çš„åè°ƒèƒ½åŠ›ï¼š\n1. äº’æ–¥\n2. åŒæ­¥\n3. ç¡®å®šå¯¹æ–¹æ˜¯å¦å­˜åœ¨\n\n## 4.1.3 æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿ\nåœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œé›†æˆä¸å†å€ŸåŠ©ä»»ä½•å…±äº«å­˜å‚¨åŒºæˆ–æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ä»¥æ ¼å¼åŒ–çš„æ¶ˆæ¯(Message)ä¸ºå•ä½ï¼Œå°†é€šä¿¡çš„æ•°æ®å°è£…åœ¨æ¶ˆæ¯ä¸­ï¼Œå¹¶åˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç»„é€šä¿¡å‘½ä»¤ï¼Œåœ¨è¿›ç¨‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’ï¼Œå®Œæˆè¿›ç¨‹é—´çš„æ•°æ®äº¤æ¢ã€‚\n\nè¯¥æ–¹å¼éšè—äº†é€šä¿¡å®ç°ç»†èŠ‚ï¼Œä½¿é€šä¿¡è¿‡ç¨‹å¯¹ç”¨æˆ·é€æ˜åŒ–ï¼Œé™ä½äº†é€šä¿¡ç¨‹åºè®¾è®¡çš„å¤æ‚æ€§å’Œé”™è¯¯ç‡ï¼Œæˆä¸ºå½“å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ç±»è¿›ç¨‹é—´çš„é€šä¿¡æœºåˆ¶.\n\n## 4.1.4 å®¢æˆ·æœº-æœåŠ¡å™¨ç³»ç»Ÿ\nå‰é¢çš„å‡ ç§é€šä¿¡ç³»ç»Ÿï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ç”¨äºå®ç°ä¸åŒè®¡ç®—æœºé—´è¿›ç¨‹çš„åŒå‘é€šä¿¡ï¼Œä½†æ˜¯å®¢æˆ·æœº-æœåŠ¡å™¨ç³»ç»Ÿçš„é€šä¿¡æœºåˆ¶ï¼Œåœ¨ç½‘ç»œç¯å¢ƒçš„å„ç§åº”ç”¨é¢†åŸŸå·²æˆä¸ºå½“å‰ä¸»æµçš„é€šä¿¡å®ç°æœºåˆ¶ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼šå¥—æ¥å­—ã€è¿œç¨‹è¿‡ç¨‹è°ƒç”¨å’Œè¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚åœ¨è¿™å°±ä¸å¤šèµ˜è¿°äº†ã€‚\n\n# 4.2 çº¿ç¨‹\n## 4.2.1 ä¸ºä»€ä¹ˆè¦å¼•å…¥çº¿ç¨‹\næˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿›ç¨‹æœ‰ä¸¤ä¸ªåŸºæœ¬å±æ€§ï¼šâ‘ è¿›ç¨‹æ˜¯ä¸€ä¸ªå¯æ‹¥æœ‰èµ„æºçš„ç‹¬ç«‹å•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹è¦èƒ½ç‹¬ç«‹è¿è¡Œï¼Œä»–å¿…é¡»æ‹¥æœ‰ä¸€å®šçš„æ•°æ®ç»“æ„ã€‚â‘¡è¿›ç¨‹åŒæ—¶åˆæ˜¯ä¸€ä¸ªå¯ç‹¬ç«‹è°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ã€‚\n\nä¸ºäº†ç¨‹åºèƒ½å¹¶å‘æ‰§è¡Œï¼Œç³»ç»Ÿå¿…é¡»èƒ½è¿›è¡Œåˆ›å»ºè¿›ç¨‹ã€æ’¤é”€è¿›ç¨‹å’Œåˆ‡æ¢è¿›ç¨‹æ“ä½œã€‚ä½†æ˜¯ç”±äºè¿›ç¨‹æ˜¯èµ„æºçš„æ‹¥æœ‰è€…ï¼Œæ‰€ä»¥åœ¨ä¸Šè¿°è¿™äº›æ“ä½œä¸­ï¼Œç³»ç»Ÿå¿…é¡»ä¸ºä¹‹ä»˜å‡ºè¾ƒå¤§çš„æ—¶ç©ºå¼€é”€ã€‚è¿™å°±é™åˆ¶äº†ç³»ç»Ÿä¸­æ‰€è®¾ç½®è¿›ç¨‹çš„æ•°ç›®ï¼Œè€Œä¸”è¿›ç¨‹åˆ‡æ¢ä¹Ÿä¸å®œè¿‡äºé¢‘ç¹ï¼Œä»è€Œé™åˆ¶äº†å¹¶å‘ç¨‹åº¦çš„è¿›ä¸€æ­¥æé«˜ã€‚\n\n## 4.2.2 çº¿ç¨‹çš„æ¦‚å¿µ\nåœ¨ä¸Šè¿°åŸå› ä¸‹ï¼Œå¼•å…¥äº†çº¿ç¨‹çš„æ¦‚å¿µã€‚å­¦è€…ä»¬å°†è¿›ç¨‹çš„ä¸¤ä¸ªå±æ€§åˆ†å¼€ï¼Œè®©ä½œä¸ºè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ä¸æ‹¥æœ‰èµ„æºï¼Œè®©æ‹¥æœ‰èµ„æºçš„åŸºæœ¬å•å€ä¸è¢«é¢‘ç¹çš„è°ƒåº¦ã€‚è¿™æ ·çš„è¯ï¼Œå°±å½¢æˆäº†çº¿ç¨‹çš„æ¦‚å¿µã€‚\n\nä¸‹é¢æˆ‘ä»¬ä»6ä¸ªæ–¹é¢æ¥æ¯”è¾ƒä¸‹è¿›å’Œçº¿ç¨‹ï¼š\n1. è°ƒåº¦çš„åŸºæœ¬å•ä½\n    ä¼ ç»ŸOSä¸­ï¼Œè¿›ç¨‹æ˜¯ä½œä¸ºç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œæ¯æ¬¡è°ƒåº¦æ—¶ï¼Œéƒ½éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¼€é”€å¤§ã€‚åœ¨å¼•å…¥äº†çº¿ç¨‹çš„OSä¸­ï¼Œçº¿ç¨‹æ˜¯ä½œä¸ºç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹åˆ‡æ¢æ—¶åªéœ€è¦ä¿å­˜å’Œè®¾ç½®å°‘é‡çš„å¯„å­˜å™¨å†…å®¹ï¼Œåˆ‡æ¢ä»£ä»·è¿œå°äºè¿›ç¨‹ã€‚\n2. å¹¶å‘æ€§\n    åœ¨å¼•å…¥çº¿ç¨‹çš„OSä¸­ï¼Œä¸ä»…è¿›ç¨‹ä¹‹é—´å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸”åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ä¹‹é—´äº¦å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œç”šè‡³è¿˜å…è®¸åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½å¹¶å‘æ‰§è¡Œã€‚\n3. æ‹¥æœ‰èµ„æº\n    è¿›ç¨‹å¯ä»¥æ‹¥æœ‰èµ„æºï¼Œè€Œä¸”è¿˜æ˜¯ç³»ç»Ÿä¸­æ‹¥æœ‰èµ„æºçš„ä¸€ä¸ªåŸºæœ¬å•ä½ã€‚ä½†æ˜¯çº¿ç¨‹æœ¬èº«å¹¶ä¸æ‹¥æœ‰èµ„æºï¼Œè€Œæ˜¯ä»…æœ‰ä¸€ç‚¹å¿…ä¸å¯å°‘çš„ã€èƒ½ä¿è¯ç‹¬ç«‹è¿è¡Œçš„èµ„æºã€‚\n4. ç‹¬ç«‹æ€§\n    åŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¹‹é—´çš„ç‹¬ç«‹æ€§æ¯”ä¸åŒè¿›ç¨‹é—´çš„ç‹¬ç«‹æ€§ä½å¾—å¤šã€‚\n5. ç³»ç»Ÿå¼€é”€\n    è¿›ç¨‹åˆ‡æ¢éœ€è¦å¤§é‡çš„ç³»ç»Ÿå¼€é”€ï¼Œè€Œçº¿ç¨‹é—´åˆ™éœ€è¦çš„å¾ˆå°‘\n6. æ”¯æŒå¤šå¤„ç†æœºç³»ç»Ÿ\n    åœ¨å¤šå¤„ç†æœºç³»ç»Ÿä¸­ï¼Œå¯¹äºä¼ ç»Ÿè¿›ç¨‹ï¼Œä¸ç®¡æœ‰å¤šå°‘å¤„ç†æœºï¼Œè¯¥è¿›ç¨‹åªèƒ½è¿è¡Œåœ¨ä¸€ä¸ªå¤„ç†æœºä¸Šã€‚ä½†æ˜¯å¯¹äºå¤šçº¿ç¨‹è¿›ç¨‹ï¼Œå¯ä»¥å°†ä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹åˆ†é…åˆ°å¤šä¸ªå¤„ç†æœºä¸Šã€‚\n\n## 4.2.3 çº¿ç¨‹çš„çŠ¶æ€å’Œçº¿ç¨‹æ§åˆ¶å—\nä¸è¿›ç¨‹ä¸€æ ·ï¼Œçº¿ç¨‹ä¹Ÿæ‹¥æœ‰ä¸‰ä¸ªçŠ¶æ€å’Œçº¿ç¨‹æ§åˆ¶å—ã€‚\n\n### 4.2.3.1 çº¿ç¨‹è¿è¡Œçš„ä¸‰ä¸ªçŠ¶æ€\nçº¿ç¨‹çš„ä¸‰ä¸ªçŠ¶æ€å’Œè¿›ç¨‹ç±»ä¼¼ã€‚\n1. è¿è¡ŒçŠ¶æ€ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²è·å¾—å¤„ç†æœºè€Œæ­£åœ¨è¿è¡Œã€‚\n2. å°±ç»ªçŠ¶æ€ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²å…·å¤‡å„ç§æ‰§è¡Œæ¡ä»¶ï¼Œåªé¡»å†è·å¾—CPUä¾¿å¯ç«‹å³æ‰§è¡Œã€‚\n3. é˜»å¡çŠ¶æ€ï¼Œåªçº¿ç¨‹åœ¨æ‰§è¡Œä¸­å› æŸäº‹ä»¶å—é˜»è€Œå¤„äºæš‚åœçŠ¶æ€ã€‚\n\n### 4.2.3.2 çº¿ç¨‹æ§åˆ¶å—TCB\nçº¿ç¨‹æ§åˆ¶å—ç”¨æ¥çºªå½•ç”¨äºæ§åˆ¶å’Œç®¡ç†çº¿ç¨‹çš„ä¿¡æ¯ã€‚\nçº¿ç¨‹æ§åˆ¶å—ä¸­é€šå¸¸ç”±è¿™å‡ é¡¹ï¼š\n1. çº¿ç¨‹æ ‡è¯†ç¬¦ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹è®¾ç½®å”¯ä¸€åœ°æ ‡è¯†ç¬¦ã€‚\n2. ä¸€ç»„å¯„å­˜å™¨ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨PCã€çŠ¶æ€å¯„å­˜å™¨å’Œé€šç”¨å¯„å­˜å™¨çš„å†…å®¹ã€‚\n3. çº¿ç¨‹è¿è¡ŒçŠ¶æ€ï¼Œç”¨äºæè¿°çº¿ç¨‹æ­£å¤„äºä½•ç§è¿è¡ŒçŠ¶æ€ã€‚\n4. ä¼˜å…ˆçº§ï¼Œæè¿°çº¿ç¨‹æ‰§è¡Œçš„ä¼˜å…ˆç¨‹åº¦ã€‚\n5. çº¿ç¨‹ä¸“æœ‰å­˜å‚¨åŒºï¼Œç”¨äºçº¿ç¨‹åˆ‡æ¢æ—¶å­˜æ”¾ç°åœºä¿æŠ¤ä¿¡æ¯ï¼Œå’Œä¸è¯¥çº¿ç¨‹ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚\n6. ä¿¡å·å±è”½ï¼Œå³å¯¹æŸäº›ä¿¡å·åŠ ä»¥å±è”½ã€‚\n7. å †æ ˆæŒ‡é’ˆã€‚","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"uCropæ¡†æ¶ç”¨æ³•å’Œæºç è§£æ","url":"/posts/4e4b8b52.html","content":">æœ¬äººèƒ½åŠ›ä¸è¶³ï¼Œåœ¨çœ‹åˆ°æºç æœ€åä¸€éƒ¨åˆ†çš„æ—¶å€™å¤§é‡æŠ„è¢­[å¯èƒ½æ˜¯æœ€è¯¦ç»†çš„UCropæºç è§£æ](https://www.jianshu.com/p/1d3fb16fb412)\n\n# 1. uCropç®€ä»‹\nuCropæ˜¯ç›®å‰è¾ƒç«çš„å›¾ç‰‡è£å‰ªæ¡†æ¶ï¼Œå¼€å‘è€…å®£ç§°ä»–ä¼šæ¯”ç›®å‰å¸‚é¢ä¸Šæ‰€æœ‰çš„å›¾ç‰‡è£å‰ªæ–¹æ¡ˆéƒ½è¦æ›´æµç•…ã€‚å¤–åŠ ä»–å°è£…ç¨‹åº¦è¾ƒé«˜ï¼Œå¯è‡ªå®šä¹‰ï¼Œè€Œä¸”é¢œå€¼å¾ˆé«˜ï¼ˆä¼¼ä¹è¿™ä¸ªæ‰æ˜¯é‡ç‚¹ï¼‰ï¼Œç°åœ¨è¶Šæ¥è¶Šå¤šAPPé€‰æ‹©ä½¿ç”¨å®ƒã€‚\n[github](https://github.com/Yalantis/uCrop)\n<!-- More -->\n\n# 2. ä½¿ç”¨æ–¹æ³•\nå¾—ç›ŠäºuCropä¼˜ç§€çš„å°è£…ï¼ŒuCropçš„ä½¿ç”¨æ–¹æ³•ç‰¹ç®€å•ã€‚\n## 2.1 å¯¼å…¥ä¾èµ–\n1. å…ˆåœ¨é¡¹ç›®çš„`build.gradle`ä¸­æ·»åŠ \n\n    ```java\n    allprojects {\n      repositories {\n        jcenter()\n        maven { url \"https://jitpack.io\" }\n      }\n    }\n    ```\n\n    å¹¶åœ¨`module`çš„`build.gradle`ä¸­æ·»åŠ \n    \n    `implementation 'com.github.yalantis:ucrop:2.2.3'` - è½»é‡çº§æ¡†æ¶\n    \n    `implementation 'com.github.yalantis:ucrop:2.2.3-native'` - è·å¾—æ¡†æ¶å…¨éƒ¨å¼ºå¤§çš„åŠŸèƒ½ä»¥åŠå›¾ç‰‡çš„é«˜è´¨é‡(æœ€ç»ˆå¯èƒ½ä¼šå¯¼è‡´apkçš„å¤§å°å¢åŠ 1.5MBä»¥ä¸Š)\n2. ç”±äºæ¡†æ¶çš„æœ¬è´¨æ˜¯è°ƒç”¨åˆ°å¦ä¸€ä¸ªActivityå»å¤„ç†å›¾ç‰‡ï¼Œæ‰€ä»¥éœ€è¦åœ¨AndroidManifest.xmlä¸­å°†UCropActivityæ·»åŠ è¿›å»\n    ```xml\n    <activity\n        android:name=\"com.yalantis.ucrop.UCropActivity\"\n        android:screenOrientation=\"portrait\"\n        android:theme=\"@style/Theme.AppCompat.Light.NoActionBar\"/>\n    ```\n\nåˆ°è¿™ä½ å°±èƒ½æŠŠcUropå…¨éƒ¨å¯¼å…¥åˆ°ä½ çš„é¡¹ç›®é‡Œé¢äº†ï¼Œæ¥ä¸‹æ¥å’±ä»¬å°±æ‹‰å°†å¦‚ä½•è°ƒç”¨\n\n## 2.2 å¼€å§‹åŸºæœ¬çš„è°ƒç”¨\nè°ƒç”¨èµ·æ¥å¾ˆç®€å•ï¼š\n```java\nUCrop.of(sourceUri, destinationUri)\n    .start(context);\n```\nå…¶ä¸­`sourceUri`æ˜¯è¾“å…¥å›¾ç‰‡çš„`Uri`ï¼Œ`destinationUri`æ˜¯è¾“å‡ºå›¾ç‰‡çš„`Uri`ã€‚ç„¶åä»–å°±ä¼šç”±`Intent`çš„è°ƒåŠ¨è·³åˆ°`UCropActivity`ï¼Œç”¨æˆ·å°±åœ¨`UCropActivity`é‡Œé¢è¿›è¡Œå›¾ç‰‡è£å‰ªæ“ä½œï¼Œç„¶åæœ€åç”±`UCropActivity`å‘èµ·ä¸€ä¸ª`Intent`å›åˆ°ä½ çš„`Activity`ã€‚\n\n## 2.3 å¤„ç†å›æ¥çš„æ•°æ®\nç”±äºæ˜¯ä»`UCropAcitivity`ä¼ å›æ•°æ®ï¼Œæ‰€ä»¥ä½ éœ€è¦åœ¨ä½ çš„`Activity`é‡Œé¢çš„`onActivityResult`æ–¹æ³•å¤„ç†`uCrop`è¿”å›çš„ä¿¡æ¯ï¼š\n```java\n@Override\npublic void onActivityResult(int requestCode, int resultCode, Intent data) {\n    if (resultCode == RESULT_OK && requestCode == UCrop.REQUEST_CROP) {\n        final Uri resultUri = UCrop.getOutput(data);\n    } else if (resultCode == UCrop.RESULT_ERROR) {\n        final Throwable cropError = UCrop.getError(data);\n    }\n}\n```\n\nåˆ°è¿™ï¼ŒåŸºæœ¬ç”¨æ³•å°±å®Œäº†ï¼Œä½ å°±å¯ä»¥å°½æƒ…çš„ä½¿ç”¨uCropã€‚ä½†æ˜¯æˆ‘å‰é¢è¯´è¿‡ï¼ŒuCropå°è£…ç¨‹åº¦å¥½ï¼Œè¿™ç‚¹å¾ˆå¤šå›¾ç‰‡å¤„ç†æ¡†æ¶éƒ½å¯ä»¥åšåˆ°ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æŠŠéœ€è¦çš„æ•°æ®ä¼ åˆ°è‡ªå·±çš„Activityä¹‹åç”±è‡ªå·±çš„Activityå¤„ç†ï¼Œæ‰€ä»¥å¾ˆå¤šæ¡†æ¶çœ‹èµ·æ¥éƒ½æœ‰ä¼˜ç§€çš„å°è£…ï¼Œé‚£uCropç›¸æ¯”å…¶ä»–åˆæœ‰å•¥å¥½å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯è‡ªå®šä¹‰çµæ´»ï¼š\n\n## 2.4 uCropé«˜é˜¶ç”¨æ³•\n\n### 2.4.1 é…ç½®uCrop\n```java\n/**\n  * å¯åŠ¨è£å‰ª\n  * @param activity ä¸Šä¸‹æ–‡\n  * @param sourceFilePath éœ€è¦è£å‰ªå›¾ç‰‡çš„ç»å¯¹è·¯å¾„\n  * @param requestCode æ¯”å¦‚ï¼šUCrop.REQUEST_CROP\n  * @param aspectRatioX è£å‰ªå›¾ç‰‡å®½é«˜æ¯”\n  * @param aspectRatioY è£å‰ªå›¾ç‰‡å®½é«˜æ¯”\n  * @return\n  */\npublic static String startUCrop(Activity activity, String sourceFilePath, \n\tint requestCode, float aspectRatioX, float aspectRatioY) {\n    Uri sourceUri = Uri.fromFile(new File(sourceFilePath));\n    File outDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);\n    if (!outDir.exists()) {\n        outDir.mkdirs();\n    }\n    File outFile = new File(outDir, System.currentTimeMillis() + \".jpg\");\n    //è£å‰ªåå›¾ç‰‡çš„ç»å¯¹è·¯å¾„\n    String cameraScalePath = outFile.getAbsolutePath();\n    Uri destinationUri = Uri.fromFile(outFile);\n    //åˆå§‹åŒ–ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼šéœ€è¦è£å‰ªçš„å›¾ç‰‡ï¼›ç¬¬äºŒä¸ªå‚æ•°ï¼šè£å‰ªåå›¾ç‰‡\n    UCrop uCrop = UCrop.of(sourceUri, destinationUri);\n    //åˆå§‹åŒ–UCropé…ç½®\n    UCrop.Options options = new UCrop.Options();\n    //è®¾ç½®è£å‰ªå›¾ç‰‡å¯æ“ä½œçš„æ‰‹åŠ¿\n    options.setAllowedGestures(UCropActivity.SCALE, UCropActivity.ROTATE, UCropActivity.ALL);\n    //æ˜¯å¦éšè—åº•éƒ¨å®¹å™¨ï¼Œé»˜è®¤æ˜¾ç¤º\n    options.setHideBottomControls(true);\n    //è®¾ç½®toolbaré¢œè‰²\n    options.setToolbarColor(ActivityCompat.getColor(activity, R.color.colorPrimary));\n    //è®¾ç½®çŠ¶æ€æ é¢œè‰²\n    options.setStatusBarColor(ActivityCompat.getColor(activity, R.color.colorPrimary));\n    //æ˜¯å¦èƒ½è°ƒæ•´è£å‰ªæ¡†\n    options.setFreeStyleCropEnabled(true);\n    //UCropé…ç½®\n    uCrop.withOptions(options);\n    //è®¾ç½®è£å‰ªå›¾ç‰‡çš„å®½é«˜æ¯”ï¼Œæ¯”å¦‚16ï¼š9\n    uCrop.withAspectRatio(aspectRatioX, aspectRatioY);\n    //uCrop.useSourceImageAspectRatio();\n    //è·³è½¬è£å‰ªé¡µé¢\n    uCrop.start(activity, requestCode);\n    return cameraScalePath;\n}\n```\n\n### 2.4.2 å…¶ä»–é…ç½®\n```java\n//è®¾ç½®Toolbaræ ‡é¢˜\nvoid setToolbarTitle(@Nullable String text)\n//è®¾ç½®è£å‰ªçš„å›¾ç‰‡æ ¼å¼\nvoid setCompressionFormat(@NonNull Bitmap.CompressFormat format)\n//è®¾ç½®è£å‰ªçš„å›¾ç‰‡è´¨é‡ï¼Œå–å€¼0-100\nvoid setCompressionQuality(@IntRange(from = 0) int compressQuality)\n//è®¾ç½®æœ€å¤šç¼©æ”¾çš„æ¯”ä¾‹å°º\nvoid setMaxScaleMultiplier(@FloatRange(from = 1.0, fromInclusive = false) float maxScaleMultiplier)\n//åŠ¨ç”»æ—¶é—´\nvoid setImageToCropBoundsAnimDuration(@IntRange(from = 100) int durationMillis)\n//è®¾ç½®å›¾ç‰‡å‹ç¼©æœ€å¤§å€¼\nvoid setMaxBitmapSize(@IntRange(from = 100) int maxBitmapSize)\n//æ˜¯å¦æ˜¾ç¤ºæ¤­åœ†è£å‰ªæ¡†é˜´å½±\nvoid setOvalDimmedLayer(boolean isOval) \n//è®¾ç½®æ¤­åœ†è£å‰ªæ¡†é˜´å½±é¢œè‰²\nvoid setDimmedLayerColor(@ColorInt int color)\n//æ˜¯å¦æ˜¾ç¤ºè£å‰ªæ¡†\nvoid setShowCropFrame(boolean show)\n//è®¾ç½®è£å‰ªæ¡†è¾¹çš„å®½åº¦\nvoid setCropFrameStrokeWidth(@IntRange(from = 0) int width)\n//æ˜¯å¦æ˜¾ç¤ºè£å‰ªæ¡†ç½‘æ ¼\nvoid setShowCropGrid(boolean show) \n//è®¾ç½®è£å‰ªæ¡†ç½‘æ ¼é¢œè‰²\nvoid setCropGridColor(@ColorInt int color)\n//è®¾ç½®è£å‰ªæ¡†ç½‘æ ¼å®½\nvoid setCropGridStrokeWidth(@IntRange(from = 0) int width)\n```\n\n# 3. æºç è§£æ\n>åœ¨æˆ‘å¼€å§‹è¯´æºç ä¹‹å‰ï¼Œæˆ‘å»ºè®®å¤§å®¶å¯ä»¥å…ˆçœ‹ä¸‹æˆ‘ä¸‹é¢çš„è¿æ¥ï¼Œå› ä¸ºæœ¬æ¡†æ¶çš„ä½œè€…çœŸçš„æ˜¯ä¸ªå¥½äººï¼Œä»–ä¸ä»…ä¸ºæˆ‘ä»¬è´¡çŒ®äº†è¿™ä¹ˆå¥½çš„ä¸€ä¸ªæ¡†æ¶ï¼Œè¿˜æŠŠè‡ªå·±å†™è¿™ä¸ªæ¡†æ¶çš„æ€è·¯éƒ½å†™äº†å‡ºæ¥ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹\n[è‹±æ–‡åŸç‰ˆ](https://yalantis.com/blog/how-we-created-ucrop-our-own-image-cropping-library-for-android/)\n[å›½å†…ç½‘å‹ç¿»è¯‘ç‰ˆ](https://blog.csdn.net/wood_water_peng/article/details/51306274)\n[ç™¾åº¦ç½‘é¡µç¿»è¯‘æœºç¿»ç‰ˆ](http://fanyi.baidu.com/transpage?query=https%3A%2F%2Fyalantis.com%2Fblog%2Fhow-we-created-ucrop-our-own-image-cropping-library-for-android%2F%23&source=url&ie=utf8&from=auto&to=zh&render=1)\nå…¶å®æˆ‘ä¸ªäººæ„Ÿè§‰ç™¾åº¦æœºç¿»æ²¡æœ‰è°·æ­Œç¿»è¯‘çš„å¥½ï¼Œå¤§å®¶æœ‰æ¡ä»¶çš„å¯ä»¥ä½¿ç”¨è°·æ­Œç¿»è¯‘æµè§ˆå™¨æ’ä»¶ç¿»è¯‘æ•´ä¸ªç½‘é¡µï¼ˆè°·æ­Œç¿»è¯‘å¥½åƒå›½å†…å¯ä»¥ç›´æ¥è®¿é—®ï¼‰\n\nä»£ç ç»“æ„å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:\n## 3.1 ç¬¬ä¸€éƒ¨åˆ†ï¼šUCropActivityï¼ˆæ•´ä¸ªæ¡†æ¶çš„å¤–åœ¨ï¼Œç”¨æˆ·æ“ä½œå›¾ç‰‡çš„åœ°æ–¹ï¼‰\nä»–çš„åŠŸèƒ½å°±æ˜¯é¡¹ç›®ä¸»è¦çš„ç•Œé¢ï¼Œä»¥åŠå®ç°ä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–ã€‚ä½ è·³è½¬åˆ°uCropçœ‹åˆ°çš„é‚£ä¸ªæ“ä½œå›¾ç‰‡çš„ç•Œé¢å°±æ˜¯å®ƒã€‚\n\nè¿™å—çœ‹æºç çš„æ—¶å€™ä»£ç å±…å¤šï¼Œä½†æ˜¯ï¼Œè¯´å®è¯ï¼Œå°±åƒåˆšåˆšè¯´çš„ä¸€æ ·ï¼Œä»–é™¤äº†åˆå§‹åŒ–è¿˜æ˜¯åˆå§‹åŒ–ã€‚åˆå§‹åŒ–å®Œ`Toolbar`æ¥ç€åˆå§‹åŒ–`ViewGroup`ï¼Œåˆå§‹åŒ–å®Œ`ViewGroup`æ¥ç€åˆå§‹åŒ–`Image`æ•°æ®ç­‰ç­‰ã€‚æ‰€ä»¥è¿™å—æˆ‘å°±æ²¡å’‹ç»†çœ‹~~ï¼ˆå…¶å®æ˜¯å› ä¸ºä»£ç å¤ªé•¿äº†ï¼Œé€ƒï¼‰~~\n## 3.2 ç¬¬äºŒéƒ¨åˆ†ï¼šOverlayViewï¼ˆç»˜åˆ¶è£å‰ªæ¡†ï¼‰\nè¿™ä¸€å—ä¸»è¦å°±æ˜¯æ¥ç”»ä½ æ‰€çœ‹åˆ°çš„å›¾ç‰‡ä¸­çš„è£å‰ªçš„è¾…åŠ©çº¿ã€‚\n\nåœ¨æ„é€ æ–¹æ³•é‡Œé¢å°±è°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯`init()`ï¼Œè€Œ`init()`æ–¹æ³•ä¹Ÿå°±å¹²äº†ä¸€ä»¶äº‹â€”â€”åˆ¤æ–­ã€‚å½“ç³»ç»Ÿå°äº`JELLY_BEA_MR2`ä¹Ÿå°±æ˜¯`Android4.3`æ—¶ï¼Œå¯åŠ¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œè‡³äºä¸ºä»€ä¹ˆ`setLayerType(LAYER_TYPE_SOFTWARE, null);`è¿™ä¸ªçœ‹ç€å°±åƒå¯åŠ¨ç¡¬ä»¶åŠ é€Ÿçš„æ–¹æ³•ï¼Œç”šè‡³å‚æ•°é‡Œé¢è¿˜æœ‰è½¯ä»¶è¿™ä¸ªå•è¯çš„æ–¹æ³•èƒ½å¯åŠ¨ç¡¬ä»¶åŠ é€Ÿï¼Œè¯·å¤§å®¶ç§»æ­¥[HenCoder Android è‡ªå®šä¹‰ View 1-8 ç¡¬ä»¶åŠ é€Ÿ](https://hencoder.com/ui-1-8/)ï¼ˆè¿›å»ç›´æ¥æœç´¢è¿™ä¸ªæ–¹æ³•å³å¯ï¼Œå°±èƒ½æ‰¾åˆ°è§£é‡Šçš„åœ°æ–¹ï¼‰ï¼Œæˆ‘å†æ¬¡ä¸åšè§£é‡Šã€‚\n\nè¿™ä¸ªç±»ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•\n1. `drawDimmedLayer()`ç»˜åˆ¶è£å‰ªæ¡†ä¹‹å¤–çš„ç°è‰²éƒ¨åˆ†\n2. `drawCropGrid()`ç»˜åˆ¶è£å‰ªæ¡†\n\né‚£æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š\n### 3.2.1 drawDimmedLayer()\n```java\nprotected void drawDimmedLayer(@NonNull Canvas canvas) {\n    //å…ˆä¿å­˜å½“å‰å½“å‰ç”»å¸ƒ\n    canvas.save();\n    //åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºåœ†æ¡†\n    if (mCircleDimmedLayer) {\n        //æŒ‰Pathè·¯å¾„è£å‰ª\n        canvas.clipPath(mCircularPath, Region.Op.DIFFERENCE);\n    } else {\n        //è£å‰ªçŸ©å½¢\n        canvas.clipRect(mCropViewRect, Region.Op.DIFFERENCE);\n    }\n    //ç€è‰²\n    canvas.drawColor(mDimmedColor);\n    //æ¢å¤ä¹‹å‰ä¿å­˜çš„Canvasçš„çŠ¶æ€\n    canvas.restore();\n\n    if (mCircleDimmedLayer) { // ç»˜åˆ¶1pxç¬”åˆ’ä»¥ä¿®å¤åé”¯é½¿\n        canvas.drawCircle(mCropViewRect.centerX(), mCropViewRect.centerY(),\n                Math.min(mCropViewRect.width(), mCropViewRect.height()) / 2.f, mDimmedStrokePaint);\n    }\n}\n```\né¦–å…ˆå°±æ˜¯ä¸€ä¸ª`mCircleDimmedLayer`ï¼Œè¿™ä¸ªæˆ‘çœŸçš„å¾ˆè¿·ï¼Œå› ä¸ºæˆ‘ä¸çŸ¥é“å¥¹æ˜¯å’‹æ¥çš„ï¼Œäºæ˜¯æˆ‘å°±çœ‹`OverlayView`æœ‰æ²¡æœ‰å¯¹è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼Œäºæ˜¯æ•´ä¸ªç±»æˆ‘å°±æ‰¾åˆ°äº†ä¸€ä¸ª`setCircleDimmedLayer()`æ–¹æ³•ï¼Œäºæ˜¯æˆ‘çœ‹è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å“ªè¢«è°ƒç”¨äº†çš„ï¼Œç„¶åæˆ‘å°±æ‰¾åˆ°ä»–åˆ†åˆ«è¢«UCropActivityå’ŒUCropFragmentä¸¤ä¸ªç±»è°ƒç”¨åˆ°ï¼Œè€Œä¸”ä¸€ä¸ªæ˜¯`intent.getBooleanExtra()`æ–¹æ³•ä¸€ä¸ªæ˜¯`bundle.getBoolean()`æ–¹æ³•ï¼Œçœ‹åˆ°è¿™ä¸ªæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æœ‰ç‚¹æ•°äº†ï¼Œè¿™æ˜æ˜¾å°±æ˜¯å…¶ä»–ç±»ä¼ è¿‡æ¥çš„å•Šï¼Œæˆ‘å‘ç°ä»–ä¸¤çš„keyçš„å€¼éƒ½æ˜¯`UCrop.Options.EXTRA_CIRCLE_DIMMED_LAYER`ï¼Œé‚£æˆ‘å°±æ‡‚äº†ï¼Œæ‰¾æ•´ä¸ªæ¡†æ¶é‡Œé¢å“ªå„¿æåˆ°è¿‡è¿™ä¸ªå€¼ä¸å°±å¾—äº†ï¼Œäºæ˜¯æˆ‘å°±å‘ç°é™¤äº†ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•ä»¥åŠä»–çš„åˆå§‹åŒ–ä»¥å¤–ï¼Œæˆ‘å‘ç°äº†ç¬¬4ä¸ªè°ƒç”¨çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªè°ƒç”¨çš„åœ°æ–¹â€”â€”Ucrop.setCircleDimmedLayer()ï¼š\n```java\n/**\n * @param isCircle - set it to true if you want dimmed layer to have an circle inside\n * iscircle-å¦‚æœå¸Œæœ›æš—æ˜¾å±‚ä¸­æœ‰ä¸€ä¸ªåœ†ï¼Œè¯·å°†å…¶è®¾ç½®ä¸ºtrueã€‚\n */\npublic void setCircleDimmedLayer(boolean isCircle) {\n    mOptionBundle.putBoolean(EXTRA_CIRCLE_DIMMED_LAYER, isCircle);\n}\n```\næ³¨é‡Šä¸Šé¢æ˜¯åŸè¯ï¼Œä¸‹é¢æ˜¯æˆ‘ç™¾åº¦æœºç¿»çš„ç¿»è¯‘ã€‚çœ‹äº†å°±æ‡‚äº†å§ï¼Œåæ­£æˆ‘æ²¡æ‡‚ï¼Œæˆ‘ä¹Ÿå®Œå…¨æ²¡æœ‰è§åˆ°å“ªè°ƒç”¨è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘æ›´ä¸æ‡‚å•¥å«å¸Œæœ›æš—æ˜¾å±‚æœ‰ä¸ªåœ†ï¼Œå•¥ç©æ„ï¼Ÿå……æ»¡çº¿æ¡çš„é»‘ï¼Ÿï¼Ÿï¼Ÿ\nç›´åˆ°æˆ‘å°†UCropçš„è°ƒç”¨æ–¹æ³•ä¿®æ”¹äº†å¹¶è¿è¡Œä¹‹åæˆ‘æ‰æ‡‚äº†ï¼š\n```java\nval options = UCrop.Options()\noptions.setCircleDimmedLayer(true)\nUCrop.of(uri, destinationUri)\n        .withOptions(options)\n        .start(this)\n```\nç»“æœæ˜¯ï¼š\n![Screenshot_20190802-211515_PhotoXiu_puzzle](http://cdn.littlecorgi.top/mweb/Screenshot_20190802-211515_PhotoXiu_puzzle.jpg)\n\nç„¶åå°±æ‡‚äº†ï¼Œåº”è¯¥æ˜¯èƒ½æˆªä¸€ä¸ªåœ†å½¢çš„å›¾æ¡ˆå§ï¼Œç„¶åæˆ‘ç‚¹ä¸‹äº†âœ”ï¸ï¼Œç„¶åâ€¦â€¦\n\n![Screenshot_20190802-211547_PhotoXiu_puzzle](http://cdn.littlecorgi.top/mweb/Screenshot_20190802-211547_PhotoXiu_puzzle.jpg)\næ— è¯å¯è¯´ï¼Œä½œè€…ç‰›é€¼ï¼ï¼ï¼\n\n\nå›å»å›å»ï¼Œåˆšåˆšè¯´åˆ°`drawDimmedLayer()`ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ`mCircleDimmedLayer`ä¸º`true`å°±è°ƒç”¨`clipPath()`è·Ÿç€è·¯å¾„è£åˆ‡ä¸€ä¸ªçŸ©å½¢åŠ åŸï¼Œä¸ç„¶çš„è¯å°±è°ƒç”¨`clipRect()`è£åˆ‡ä¸€ä¸ªçŸ©å½¢ã€‚ç„¶ååŠ å…¥é¢œè‰²ï¼Œç„¶åå®Œäº†\n\n### 3.2.2 drawCropGrid()\n```java\nprotected void drawCropGrid(@NonNull Canvas canvas) {\n    // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå‰ªè£æ¡†\n    if (mShowCropGrid) {\n        // åˆ¤æ–­çŸ©å½¢æ•°æ®æ˜¯å¦ä¸ºç©ºï¼ŒmGridPoints å¦‚æœç­‰äºç©ºçš„è¯è¿›å…¥å¡«å……æ•°æ®\n        if (mGridPoints == null && !mCropViewRect.isEmpty()) {\n            // è¯¥æ•°ç»„ä¸º canvas.drawLines çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°è¦æ±‚å…¶å…ƒç´ ä¸ªæ•°ä¸º 4 çš„å€æ•°\n            mGridPoints = new float[(mCropGridRowCount) * 4 + (mCropGridColumnCount) * 4];\n\n            int index = 0;\n            // ç»„è£…æ•°æ®ï¼Œæ•°æ®ä¸ºæ¯ä¸€ç»„çº¿æ®µçš„åæ ‡ç‚¹\n            for (int i = 0; i < mCropGridRowCount; i++) {\n                mGridPoints[index++] = mCropViewRect.left;\n                mGridPoints[index++] = (mCropViewRect.height() * (((float) i + 1.0f) / (float) (mCropGridRowCount + 1))) + mCropViewRect.top;\n                mGridPoints[index++] = mCropViewRect.right;\n                mGridPoints[index++] = (mCropViewRect.height() * (((float) i + 1.0f) / (float) (mCropGridRowCount + 1))) + mCropViewRect.top;\n            }\n\n            for (int i = 0; i < mCropGridColumnCount; i++) {\n                mGridPoints[index++] = (mCropViewRect.width() * (((float) i + 1.0f) / (float) (mCropGridColumnCount + 1))) + mCropViewRect.left;\n                mGridPoints[index++] = mCropViewRect.top;\n                mGridPoints[index++] = (mCropViewRect.width() * (((float) i + 1.0f) / (float) (mCropGridColumnCount + 1))) + mCropViewRect.left;\n                mGridPoints[index++] = mCropViewRect.bottom;\n            }\n        }\n        //ç»˜åˆ¶çº¿æ®µ\n        if (mGridPoints != null) {\n            canvas.drawLines(mGridPoints, mCropGridPaint);\n        }\n    }\n    //ç»˜åˆ¶çŸ©å½¢åŒ…è£¹çº¿æ®µ\n    if (mShowCropFrame) {\n        canvas.drawRect(mCropViewRect, mCropFramePaint);\n    }\n    //ç»˜åˆ¶è¾¹è§’åŒ…è£¹,mFreestyleCropModeæ­¤å‚æ•°å¦‚æœç­‰äº1çš„è¯ å‰ªè£æ¡†ä¸ºå¯ç§»åŠ¨çŠ¶æ€ï¼Œä¸€èˆ¬ä¸ç”¨\n    if (mFreestyleCropMode != FREESTYLE_CROP_MODE_DISABLE) {\n        canvas.save();\n\n        mTempRect.set(mCropViewRect);\n        mTempRect.inset(mCropRectCornerTouchAreaLineLength, -mCropRectCornerTouchAreaLineLength);\n        canvas.clipRect(mTempRect, Region.Op.DIFFERENCE);\n\n        mTempRect.set(mCropViewRect);\n        mTempRect.inset(-mCropRectCornerTouchAreaLineLength, mCropRectCornerTouchAreaLineLength);\n        canvas.clipRect(mTempRect, Region.Op.DIFFERENCE);\n\n        canvas.drawRect(mCropViewRect, mCropFrameCornersPaint);\n\n        canvas.restore();\n    }\n}\n```\nä¸€å¼€å¤´åˆæ˜¯ä¸€ä¸ªå’Œä¸Šé¢ç±»ä¼¼çš„å˜é‡`mShowCropGrid`ï¼Œè¿™ä¸‹æˆ‘å°±ä¸è¯´æˆ‘æ‰¾çš„å…·ä½“æ­¥éª¤ï¼Œä»–çš„åŠŸèƒ½å°±æ˜¯å¦‚æœä»–æ˜¯`true`å°±ä¼šåœ¨è£å‰ªæ¡†ä¸­æ˜¾ç¤º9å®«æ ¼çº¿ï¼Œä¸º`false`å°±æ²¡æœ‰ã€‚æ¥ç€å°±æ˜¯ç”»çº¿éƒ¨åˆ†ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæˆ‘ä¸ç”¨è®²å•¥ï¼Œä¹Ÿæ²¡å•¥è®²çš„ï¼Œå”¯ä¸€å°±æ˜¯ä¸ºä»€ä¹ˆmGridPointsè¿™ä¸ªæ•°ç»„çš„å¤§å°æ˜¯4çš„å€æ•°ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹è¿™ä¸ªåšå®¢[Android Canvas DrawLinesä¸­ç¬¬ä¸€ä¸ªå‚æ•°çš„è§£é‡Š](https://blog.csdn.net/pimkle/article/details/16946423)\n\n\n## 3.3 ç¬¬ä¸‰éƒ¨åˆ†ï¼šGestureCropImageViewï¼ˆæ­£åœ¨æ¡†æ¶çš„å†…åœ¨ï¼Œä»£ç æ“ä½œæ“ä½œå›¾ç‰‡çš„åœ°æ–¹ï¼‰\nè¿™ä¸ªæ˜¯æ•´ä¸ªé¡¹ç›®æœ€æ ¸å¿ƒçš„åœ°æ–¹ã€‚å‰é¢çš„ä¸¤éƒ¨åˆ†éƒ½æ˜¯UIçš„ï¼Œè€Œè¿™ä¸ªæ‰æ˜¯çœŸæ­£çš„å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æˆ‘æœ€æƒ³çŸ¥é“äº†è§£çš„éƒ¨åˆ†ã€‚\nè¿™éƒ¨åˆ†ä½œè€…ä¹Ÿåœ¨ä»–çš„åšå®¢é‡Œé¢è¯´çš„æœ€å¤šæœ€æ¸…æ¥šã€‚\nä½œè€…æŠŠè¿™éƒ¨åˆ†çš„é€»è¾‘åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†\n1. `TransformImageView extends ImageView`\n    ä»–å¤„ç†äº†\n    1. ä»æºæ‹¿åˆ°å›¾ç‰‡\n    2. å°†å›¾ç‰‡è¿›å˜æ¢ï¼ˆå¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ï¼‰ï¼Œå¹¶åº”ç”¨åˆ°å½“å‰å›¾ç‰‡ä¸Š\n\n2. `CropImageView extends TransformImageView`\n    ä»–å¤„ç†äº†\n    1. ç»˜åˆ¶è£å‰ªè¾¹æ¡†å’Œç½‘æ ¼\n    2. ä¸ºè£å‰ªåŒºåŸŸè®¾ç½®ä¸€å¼ å›¾ç‰‡ï¼ˆå¦‚æœç”¨æˆ·å¯¹å›¾ç‰‡æ“ä½œå¯¼è‡´è£å‰ªåŒºåŸŸå‡ºç°äº†ç©ºç™½ï¼Œé‚£ä¹ˆå›¾ç‰‡åº”è‡ªåŠ¨ç§»åŠ¨åˆ°è¾¹ç•Œå¡«å……ç©ºç™½åŒºåŸŸï¼‰\n    3. ç»§æ‰¿çˆ¶ç±»æ–¹æ³•ï¼Œä½¿ç”¨æ›´ç²¾å‡†çš„è§„åˆ™æ¥æ“ä½œçŸ©é˜µï¼ˆé™åˆ¶æœ€å¤§å’Œæœ€å°ç¼©æ”¾æ¯”ï¼‰\n    4. æ·»åŠ æ–¹æ³•å’Œç¼©å°çš„æ–¹æ³•\n    5. è£å‰ªå›¾ç‰‡\n3. `GestureCropImageView extends CropImageView`\n    ä»–å¤„ç†äº†\n    1. ç›‘å¬ç”¨æˆ·æ‰‹åŠ¿ï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„æ­£ç¡®çš„æ–¹æ³•\n\n### 3.3.1 TransformImageView\nä½œè€…è¯´è¿™æ˜¯æœ€å®¹æ˜“çš„éƒ¨åˆ†ã€‚\nåœ¨çœ‹è¿™ä¸ªç±»ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`BitmapLoadTask`ç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€åˆ‡å›¾åƒå¤„ç†çš„åŸºç¡€ï¼Œè¿™ä¸ªç±»è´Ÿè´£äº†`Uri`è§£ç `bitmap`ï¼Œå¹¶å¤„ç†åˆ†è¾¨ç‡ï¼š\né¦–å…ˆæ ¹æ®æ‹¿åˆ°çš„`Uri`è§£æä½å›¾ï¼š\n```java\nfinal ParcelFileDescriptor parcelFileDescriptor;\ntry {\n    parcelFileDescriptor = mContext.getContentResolver().openFileDescriptor(mInputUri, \"r\");\n} catch (FileNotFoundException e) {\n    return new BitmapWorkerResult(e);\n}\n\nfinal FileDescriptor fileDescriptor;\nif (parcelFileDescriptor != null) {\n    fileDescriptor = parcelFileDescriptor.getFileDescriptor();\n} else {\n    return new BitmapWorkerResult(new NullPointerException(\"ParcelFileDescriptor was null for given Uri: [\" + mInputUri + \"]\"));\n}\n```\nç°åœ¨ï¼Œå¯ä»¥ä½¿ç”¨`BitmapFactory`æ–¹æ³•è§£ç `FileDescriptor`ã€‚\n\nä½†åœ¨è§£ç ä½å›¾ä¹‹å‰ï¼Œæœ‰å¿…è¦çŸ¥é“å®ƒçš„å¤§å°ï¼Œå› ä¸ºå¦‚æœåˆ†è¾¨ç‡å¤ªé«˜ï¼Œä½å›¾å°†è¢«äºŒæ¬¡é‡‡æ ·ã€‚\n```java\nfinal BitmapFactory.Options options = new BitmapFactory.Options();\n\n\n\noptions.inJustDecodeBounds = true;\n\nBitmapFactory.decodeFileDescriptor(fileDescriptor, null, options);\n\noptions.inSampleSize = calculateInSampleSize(options, requiredWidth, requiredHeight);\n\noptions.inJustDecodeBounds = false;\n\n\n\nBitmap decodeSampledBitmap = BitmapFactory.decodeFileDescriptor(fileDescriptor, null, options);\n\nclose(parcelFileDescriptor);\n\n\n\nExifInterface exif = getExif(uri);\n\nif (exif != null) {\n\n  int exifOrientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);\n\n  return rotateBitmap(decodeSampledBitmap, exifToDegrees(exifOrientation));\n\n} else {\n\n  return decodeSampledBitmap;\n\n}\n```\nè¿™æ ·å°±æ‹¿åˆ°äº†`bitmap`å®ä¾‹äº†ï¼Œå°±å¯ä»¥å»`TansformImageView`å»å¯¹å›¾ç‰‡è¿›è¡Œè°ƒæ•´äº†ã€‚\nå…¶å®è¿™ä¸ªç±»æˆ‘ä¹Ÿä¸çŸ¥é“è¯´å•¥ğŸ˜‚ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªç±»ä¹Ÿå°±æ˜¯æŠŠ`Matrix`çš„`postTranslate()`ã€`postRotate()`å’Œ`postScale()`æ–¹æ³•ç»™å°è£…äº†ä¸‹ã€‚\nå…³äºMatrixçš„çŸ¥è¯†å¤§å®¶å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢ï¼š[å®‰å“è‡ªå®šä¹‰Viewè¿›é˜¶-MatrixåŸç†](https://www.gcssloop.com/customview/Matrix_Basic)\n\n### 3.3.2 CropImageView\nè¿™ä¸€å±‚æ˜¯æœ€å¤æ‚çš„ä¸€å±‚ï¼Œä½œè€…çš„æ“ä½œå¤§è‡´å¯ä»¥åˆ†ä¸º3æ­¥ï¼šå›¾ç‰‡è£å‰ªæ¡†åç§»è®¡ç®—ã€å›¾ç‰‡å½’ä¸ºåŠ¨ç”»å¤„ç†ã€è£å‰ªå›¾ç‰‡\n\n- ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡è£å‰ªæ¡†åç§»è®¡ç®—\nå½“ç”¨æˆ·æ‰‹æŒ‡ç§»å¼€æ—¶ï¼Œè¦ç¡®ä¿å›¾ç‰‡å¤„äºè£å‰ªåŒºåŸŸä¸­ï¼Œå¦‚æœä¸å¤„äºï¼Œéœ€è¦é€šè¿‡å¹³ç§»æŠŠå®ƒç§»è¿‡æ¥ï¼š\n\n```java\npublic void setImageToWrapCropBounds(boolean animate) {\n    //å¦‚æœå›¾ç‰‡åŠ è½½å®Œæ¯•å¹¶ä¸”å›¾ç‰‡ä¸å¤„äºå‰ªè£åŒºåŸŸ\n    if (mBitmapLaidOut && !isImageWrapCropBounds()) {\n\n        //è·å–ä¸­å¿ƒç‚¹X,Yåæ ‡\n        float currentX = mCurrentImageCenter[0];\n        float currentY = mCurrentImageCenter[1];\n        //è·å–ç¼©æ”¾æ¯”ä¾‹\n        float currentScale = getCurrentScale();\n\n        //è·å–åç§»è·ç¦»\n        float deltaX = mCropRect.centerX() - currentX;\n        float deltaY = mCropRect.centerY() - currentY;\n        float deltaScale = 0;\n\n        mTempMatrix.reset();\n        mTempMatrix.setTranslate(deltaX, deltaY);\n\n        final float[] tempCurrentImageCorners = Arrays.copyOf(mCurrentImageCorners, mCurrentImageCorners.length);\n        mTempMatrix.mapPoints(tempCurrentImageCorners);\n\n        //åˆ¤æ–­å›¾ç‰‡æ˜¯å¦åŒ…å«åœ¨å‰ªè£åŒºåŸŸ\n        boolean willImageWrapCropBoundsAfterTranslate = isImageWrapCropBounds(tempCurrentImageCorners);\n\n        //å¦‚æœåŒ…å«åœ¨å‰ªè£åŒºåŸŸ\n        if (willImageWrapCropBoundsAfterTranslate) {\n            //è·å–åç§»çš„è·ç¦»\n            final float[] imageIndents = calculateImageIndents();\n            //åç§»çš„è·ç¦»ï¼Œæ¨ªåæ ‡åŠ æ¨ªåæ ‡ çºµåæ ‡åŠ çºµåæ ‡\n            deltaX = -(imageIndents[0] + imageIndents[2]);\n            deltaY = -(imageIndents[1] + imageIndents[3]);\n        } else {\n            //å¦‚æœä¸åŒ…å«åœ¨å‰ªè£åŒºåŸŸï¼Œåˆ›å»ºä¸´æ—¶çŸ©å½¢\n            RectF tempCropRect = new RectF(mCropRect);\n            mTempMatrix.reset();\n            //è®¾ç½®åç§»è§’åº¦\n            mTempMatrix.setRotate(getCurrentAngle());\n            mTempMatrix.mapRect(tempCropRect);\n\n            //è·å¾—çŸ©å½¢çš„è¾¹é•¿åæ ‡\n            final float[] currentImageSides = RectUtils.getRectSidesFromCorners(mCurrentImageCorners);\n            //è·å–æ”¾å¤§æ¯”ä¾‹\n            deltaScale = Math.max(tempCropRect.width() / currentImageSides[0],\n                    tempCropRect.height() / currentImageSides[1]);\n            deltaScale = deltaScale * currentScale - currentScale;\n        }\n\n        //å¦‚æœéœ€è¦åŠ¨ç”»\n        if (animate) {\n            post(mWrapCropBoundsRunnable = new WrapCropBoundsRunnable(\n                    CropImageView.this, mImageToWrapCropBoundsAnimDuration, currentX, currentY, deltaX, deltaY,\n                    currentScale, deltaScale, willImageWrapCropBoundsAfterTranslate));\n        } else {\n            //ä¸éœ€è¦åŠ¨ç”»ï¼Œç›´æ¥ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®\n            postTranslate(deltaX, deltaY);\n            if (!willImageWrapCropBoundsAfterTranslate) {\n                zoomInImage(currentScale + deltaScale, mCropRect.centerX(), mCropRect.centerY());\n            }\n        }\n    }\n}\n```\n\n- ç¬¬äºŒæ­¥ï¼šå¤„ç†å¹³ç§»\né€šè¿‡ä¸€ä¸ªRunnableçº¿ç¨‹æ¥å¤„ç†å¹³ç§»ï¼Œå¹¶ä¸”é€šè¿‡æ—¶é—´å·®å€¼çš„è®¡ç®—æ¥ç§»åŠ¨åŠ¨ç”»ï¼Œä½¿åŠ¨ç”»çœ‹èµ·æ¥æ›´çœŸå®ï¼š\n```java\n/**\n * æ­¤å¯è¿è¡Œæ–‡ä»¶ç”¨äºåŠ¨ç”»å›¾åƒï¼Œä½¿å…¶å®Œå…¨å¡«å……è£å‰ªè¾¹ç•Œã€‚\n * ç»™å®šå€¼åœ¨åŠ¨ç”»æœŸé—´å†…æ’ã€‚\n * runnableå¯ä»¥ç»ˆæ­¢äºvie{@link #cancelAllAnimations()}æ–¹æ³•ï¼Œ\n * ä¹Ÿå¯ä»¥åœ¨è§¦å‘{@link WrapCropBoundsRunnable#run()}æ–¹æ³•å†…çš„æŸäº›æ¡ä»¶æ—¶ç»ˆæ­¢ã€‚\n */\nprivate static class WrapCropBoundsRunnable implements Runnable {\n\n    private final WeakReference<CropImageView> mCropImageView;\n\n    private final long mDurationMs, mStartTime;\n    private final float mOldX, mOldY;\n    private final float mCenterDiffX, mCenterDiffY;\n    private final float mOldScale;\n    private final float mDeltaScale;\n    private final boolean mWillBeImageInBoundsAfterTranslate;\n\n    public WrapCropBoundsRunnable(CropImageView cropImageView,\n                                long durationMs,\n                                float oldX, float oldY,\n                                float centerDiffX, float centerDiffY,\n                                float oldScale, float deltaScale,\n                                boolean willBeImageInBoundsAfterTranslate) {\n\n        mCropImageView = new WeakReference<>(cropImageView);\n\n        mDurationMs = durationMs;\n        mStartTime = System.currentTimeMillis();\n        mOldX = oldX;\n        mOldY = oldY;\n        mCenterDiffX = centerDiffX;\n        mCenterDiffY = centerDiffY;\n        mOldScale = oldScale;\n        mDeltaScale = deltaScale;\n        mWillBeImageInBoundsAfterTranslate = willBeImageInBoundsAfterTranslate;\n    }\n\n    @Override\n    public void run() {\n        CropImageView cropImageView = mCropImageView.get();\n        if (cropImageView == null) {\n            return;\n        }\n\n        long now = System.currentTimeMillis();\n        float currentMs = Math.min(mDurationMs, now - mStartTime);\n\n        float newX = CubicEasing.easeOut(currentMs, 0, mCenterDiffX, mDurationMs);\n        float newY = CubicEasing.easeOut(currentMs, 0, mCenterDiffY, mDurationMs);\n        float newScale = CubicEasing.easeInOut(currentMs, 0, mDeltaScale, mDurationMs);\n\n        if (currentMs < mDurationMs) {\n            cropImageView.postTranslate(newX - (cropImageView.mCurrentImageCenter[0] - mOldX), newY - (cropImageView.mCurrentImageCenter[1] - mOldY));\n            if (!mWillBeImageInBoundsAfterTranslate) {\n                cropImageView.zoomInImage(mOldScale + newScale, cropImageView.mCropRect.centerX(), cropImageView.mCropRect.centerY());\n            }\n            if (!cropImageView.isImageWrapCropBounds()) {\n                cropImageView.post(this);\n            }\n        }\n    }\n}\n```\n\nä¸‹é¢è¿˜æœ‰å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºåŒå‡»æ”¾å¤§:\n\n```java\n/**\n * æ­¤å¯è¿è¡Œé¡¹ç”¨äºè®¾ç½®å›¾åƒç¼©æ”¾çš„åŠ¨ç”»ã€‚\n * ç»™å®šå€¼åœ¨åŠ¨ç”»æœŸé—´å†…æ’ã€‚\n * runnableå¯ä»¥ç»ˆæ­¢vie {@link #cancelAllAnimations()}æ–¹æ³•ï¼Œ\n * ä¹Ÿå¯ä»¥åœ¨è§¦å‘{@link ZoomImageToPosition#run()}æ–¹æ³•å†…çš„æŸäº›æ¡ä»¶æ—¶ç»ˆæ­¢ã€‚\n */\nprivate static class ZoomImageToPosition implements Runnable {\n\n    private final WeakReference<CropImageView> mCropImageView;\n\n    private final long mDurationMs, mStartTime;\n    private final float mOldScale;\n    private final float mDeltaScale;\n    private final float mDestX;\n    private final float mDestY;\n\n    public ZoomImageToPosition(CropImageView cropImageView,\n                                long durationMs,\n                                float oldScale, float deltaScale,\n                                float destX, float destY) {\n\n        mCropImageView = new WeakReference<>(cropImageView);\n\n        mStartTime = System.currentTimeMillis();\n        mDurationMs = durationMs;\n        mOldScale = oldScale;\n        mDeltaScale = deltaScale;\n        mDestX = destX;\n        mDestY = destY;\n    }\n\n    @Override\n    public void run() {\n        CropImageView cropImageView = mCropImageView.get();\n        if (cropImageView == null) {\n            return;\n        }\n\n        long now = System.currentTimeMillis();\n        float currentMs = Math.min(mDurationMs, now - mStartTime);\n        float newScale = CubicEasing.easeInOut(currentMs, 0, mDeltaScale, mDurationMs);\n\n        if (currentMs < mDurationMs) {\n            cropImageView.zoomInImage(mOldScale + newScale, mDestX, mDestY);\n            cropImageView.post(this);\n        } else {\n            cropImageView.setImageToWrapCropBounds();\n        }\n    }\n}\n```\n\n- ç¬¬ä¸‰æ­¥ï¼šè£å‰ªå›¾ç‰‡\n\n```java\n/**\n * å–æ¶ˆæ‰€æœ‰å½“å‰åŠ¨ç”»å¹¶è®¾ç½®å›¾åƒä»¥å¡«å……è£å‰ªåŒºåŸŸï¼ˆä¸å¸¦åŠ¨ç”»ï¼‰ã€‚\n * ç„¶åç”¨é€‚å½“çš„å‚æ•°åˆ›å»ºå¹¶æ‰§è¡Œ{@link BitmapCropTask}ã€‚\n */\npublic void cropAndSaveImage(@NonNull Bitmap.CompressFormat compressFormat, int compressQuality,\n                            @Nullable BitmapCropCallback cropCallback) {\n    //ç»“æŸå­çº¿ç¨‹\n    cancelAllAnimations();\n    //è®¾ç½®è¦å‰ªè£çš„å›¾ç‰‡ï¼Œä¸éœ€è¦ä½ç§»åŠ¨ç”»\n    setImageToWrapCropBounds(false);\n\n    //å­˜å‚¨å›¾ç‰‡ä¿¡æ¯ï¼Œå››ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼šmCropRectè¦å‰ªè£çš„å›¾ç‰‡çŸ©é˜µï¼Œå½“å‰å›¾ç‰‡è¦å‰ªè£çš„çŸ©é˜µï¼Œå½“å‰æ”¾å¤§çš„å€¼ï¼Œå½“å‰æ—‹è½¬çš„è§’åº¦\n    final ImageState imageState = new ImageState(\n            mCropRect, RectUtils.trapToRect(mCurrentImageCorners),\n            getCurrentScale(), getCurrentAngle());\n\n    //å‰ªè£å‚æ•°ï¼ŒmMaxResultImageSizeXï¼ŒmMaxResultImageSizeYï¼šå‰ªè£å›¾ç‰‡çš„æœ€å¤§å®½åº¦ã€é«˜åº¦ã€‚\n    final CropParameters cropParameters = new CropParameters(\n            mMaxResultImageSizeX, mMaxResultImageSizeY,\n            compressFormat, compressQuality,\n            getImageInputPath(), getImageOutputPath(), getExifInfo());\n\n    //å‰ªè£æ“ä½œæ”¾åˆ°AsyncTaskä¸­æ‰§è¡Œ\n    new BitmapCropTask(getViewBitmap(), imageState, cropParameters, cropCallback).execute();\n}\n```\nè¿™å—æ ¸å¿ƒæ–¹æ³•è¿˜æ˜¯åœ¨`BitmapCropTask`ä¸­ï¼š\n```java\n//è°ƒæ•´å‰ªè£å¤§å°ï¼Œå¦‚æœæœ‰è®¾ç½®æœ€å¤§å‰ªè£å¤§å°ä¹Ÿä¼šåœ¨è¿™é‡Œåšè°ƒæ•´åˆ°è®¾ç½®èŒƒå›´\nprivate float resize() {\n    final BitmapFactory.Options options = new BitmapFactory.Options();\n    options.inJustDecodeBounds = true;\n    BitmapFactory.decodeFile(mImageInputPath, options);\n\n    boolean swapSides = mExifInfo.getExifDegrees() == 90 || mExifInfo.getExifDegrees() == 270;\n    float scaleX = (swapSides ? options.outHeight : options.outWidth) / (float) mViewBitmap.getWidth();\n    float scaleY = (swapSides ? options.outWidth : options.outHeight) / (float) mViewBitmap.getHeight();\n\n    float resizeScale = Math.min(scaleX, scaleY);\n\n    mCurrentScale /= resizeScale;\n\n    resizeScale = 1;\n    if (mMaxResultImageSizeX > 0 && mMaxResultImageSizeY > 0) {\n        float cropWidth = mCropRect.width() / mCurrentScale;\n        float cropHeight = mCropRect.height() / mCurrentScale;\n\n        if (cropWidth > mMaxResultImageSizeX || cropHeight > mMaxResultImageSizeY) {\n\n            scaleX = mMaxResultImageSizeX / cropWidth;\n            scaleY = mMaxResultImageSizeY / cropHeight;\n            resizeScale = Math.min(scaleX, scaleY);\n\n            mCurrentScale /= resizeScale;\n        }\n    }\n    return resizeScale;\n}\n\n// å‰ªè£å›¾ç‰‡\nprivate boolean crop(float resizeScale) throws IOException {\n    ExifInterface originalExif = new ExifInterface(mImageInputPath);\n\n    //å››èˆäº”å…¥å–æ•´\n    cropOffsetX = Math.round((mCropRect.left - mCurrentImageRect.left) / mCurrentScale);\n    cropOffsetY = Math.round((mCropRect.top - mCurrentImageRect.top) / mCurrentScale);\n    mCroppedImageWidth = Math.round(mCropRect.width() / mCurrentScale);\n    mCroppedImageHeight = Math.round(mCropRect.height() / mCurrentScale);\n\n    //è®¡ç®—å‡ºå›¾ç‰‡æ˜¯å¦éœ€è¦è¢«å‰ªè£\n    boolean shouldCrop = shouldCrop(mCroppedImageWidth, mCroppedImageHeight);\n    Log.i(TAG, \"Should crop: \" + shouldCrop);\n\n    if (shouldCrop) {\n        //è°ƒç”¨C++æ–¹æ³•å‰ªè£\n        boolean cropped = cropCImg(mImageInputPath, mImageOutputPath,\n                cropOffsetX, cropOffsetY, mCroppedImageWidth, mCroppedImageHeight,\n                mCurrentAngle, resizeScale, mCompressFormat.ordinal(), mCompressQuality,\n                mExifInfo.getExifDegrees(), mExifInfo.getExifTranslation());\n        //å‰ªè£æˆåŠŸå¤åˆ¶å›¾ç‰‡EXIFä¿¡æ¯\n        if (cropped && mCompressFormat.equals(Bitmap.CompressFormat.JPEG)) {\n            ImageHeaderParser.copyExif(originalExif, mCroppedImageWidth, mCroppedImageHeight, mImageOutputPath);\n        }\n        return cropped;\n    } else {\n        //ç›´æ¥å¤åˆ¶å›¾ç‰‡åˆ°ç›®æ ‡æ–‡ä»¶å¤¹\n        FileUtils.copyFile(mImageInputPath, mImageOutputPath);\n        return false;\n    }\n}\n```\n\n### 3.3.3 GestureCropImageView\nè¿™ä¸ªç±»ä¸»è¦å°±æ˜¯å¯¹æ‰‹åŠ¿çš„ç›‘å¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•ç²—æš´ï¼Œç›´æ¥æ‰¾ä»–çš„onTouchEventæ–¹æ³•ï¼š\n```java\n/**\n * å¦‚æœæ˜¯ACTION_DOWN eventï¼Œç”¨æˆ·è§¦æ‘¸å±å¹•ï¼Œå¿…é¡»å–æ¶ˆæ‰€æœ‰å½“å‰åŠ¨ç”»ã€‚\n * å¦‚æœæ˜¯ACTION_UP eventï¼Œç”¨æˆ·ä»å±å¹•ä¸Šå–ä¸‹æ‰€æœ‰æ‰‹æŒ‡ï¼Œå¿…é¡»çº æ­£å½“å‰å›¾åƒä½ç½®ã€‚\n * å¦‚æœæœ‰ä¸¤ä¸ªä»¥ä¸Šçš„æ‰‹æŒ‡-æ›´æ–°ç„¦ç‚¹åæ ‡ã€‚\n * å¦‚æœå·²å¯ç”¨ï¼Œåˆ™å°†äº‹ä»¶ä¼ é€’ç»™æ‰‹åŠ¿æ£€æµ‹å™¨ã€‚\n */\n@Override\npublic boolean onTouchEvent(MotionEvent event) {\n    if ((event.getAction() & MotionEvent.ACTION_MASK) == MotionEvent.ACTION_DOWN) {\n        cancelAllAnimations();\n    }\n\n    if (event.getPointerCount() > 1) {\n        mMidPntX = (event.getX(0) + event.getX(1)) / 2;\n        mMidPntY = (event.getY(0) + event.getY(1)) / 2;\n    }\n\n    //åŒå‡»ç›‘å¬å’Œæ‹–åŠ¨ç›‘å¬\n    mGestureDetector.onTouchEvent(event);\n\n    //ä¸¤æŒ‡ç¼©æ”¾ç›‘å¬\n    if (mIsScaleEnabled) {\n        mScaleDetector.onTouchEvent(event);\n    }\n\n    //æ—‹è½¬ç›‘å¬\n    if (mIsRotateEnabled) {\n        mRotateDetector.onTouchEvent(event);\n    }\n\n    if ((event.getAction() & MotionEvent.ACTION_MASK) == MotionEvent.ACTION_UP) {\n        //æœ€åä¸€æŒ‡æŠ¬èµ·æ—¶åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å¡«å……å‰ªè£æ¡†\n        setImageToWrapCropBounds();\n    }\n    return true;\n}\n```","tags":["Android","æºç ","uCrop","å›¾ç‰‡å¤„ç†"],"categories":["Android"]},{"title":"Aria2macOSå®‰è£…","url":"/posts/4f46fdbb.html","content":"> å¯¹ä¸èµ·å¤§å®¶ï¼Œåœ¨æˆ‘é…ç½®å¥½è¿™ä¸ªè½¯ä»¶ä¹‹åï¼Œæˆ‘å…´å†²å†²çš„æ‰“å¼€äº†githubæƒ³ä¸‹è½½ä¸‹ssr4.0forWindowsï¼Œè¿«ä¸åŠå¾…æƒ³æ„Ÿå—ä¸‹aria2çš„å¿«æ„Ÿï¼Œç»“æœå‘ç°æˆ‘é”™äº†ã€‚  \n> ä¸‹è½½é€Ÿåº¦å°±æ‰å‡ åk/sï¼Œé‚£ä¸€ç¬é—´ï¼Œæˆ‘æ„Ÿè§¦å¾ˆå¤šï¼Œæˆ‘çªç„¶æƒ³åˆ°æˆ‘æ˜¨æ™šçš„è¿…é›·ä¸‹è½½åŒæ ·çš„èµ„æºåŒæ ·çš„ç½‘åŒæ ·çš„vpnä¸‹å¤§å‡ ç™¾k/s çš„é€Ÿåº¦ï¼Œç„¶ååˆçœ‹åˆ°äº†æ­¤æ—¶æˆ‘ç»™äºˆå¸Œæœ›çš„ariaï¼Œæˆ‘é™·å…¥äº†æ²‰æ€ï¼Œæˆ–è®¸è¿™å°±æ˜¯äººç”Ÿå§ã€‚  \n> çªç„¶è§‰å¾—macOSè¿…é›·ï¼Œä¹Ÿè¿˜æŒºå¥½çœ‹çš„ï¼Œä¹ŸæŒºå¥½ç”¨çš„ï¼Œå®Œå…¨æ²¡æœ‰å¹¿å‘Šï¼Œè¦ä¸‹è½½æ‰“å¼€ï¼Œä¸‹è½½å®Œäº†å°±é€€å‡ºï¼Œå”¯ä¸€é—®é¢˜å°±æ˜¯Chromeçš„è¿…é›·æ‹“å±•ä¼¼ä¹å¤ªçµæ•äº†ç‚¹ï¼Œæˆ‘å•¥éƒ½æ²¡ç‚¹å°±è«åå…¶å¦™å¼¹å‡ºä¸‹è½½é¡µé¢ï¼Œé™¤äº†è¿™ä¸ªï¼Œä¼¼ä¹éå¸¸å®Œç¾ã€‚  \n> æ‰€ä»¥ï¼Œåœ¨æˆ‘é…ç½®å¥½aria2å¹¶å†™ä¸‹è¿™ç¯‡åšå®¢åçš„ä¸åˆ°1ä¸ªå°æ—¶æ—¶é—´ï¼Œæˆ‘å¸è½½äº†aira2ï¼Œå¹¶é‡æ–°ç”¨ä¸Šäº†è¿…é›·ã€‚æ‰€ä»¥ï¼Œæˆ‘æœ€ååªæƒ³è¯´ä¸€å¥ï¼Œè´¢å¤§nbï¼è´¢å¤§nbï¼è´¢å¤§nbï¼å¯¹ä¸èµ·ï¼Œèµ°é”™ç‰‡åœºäº†ï¼Œé‡æ¥ï¼ŒIDMç‰›é€¼ï¼IDMç‰›é€¼ï¼IDMç‰›é€¼ï¼  \n>å¦‚æœå“ªä½ç‰›é€¼çš„å¤§å“¥çœ‹åˆ°äº†è¿™ç¯‡åšå®¢ï¼Œè®°å¾—å¸®æˆ‘ç»™IDMè¯´å£°ï¼Œä¸€ä¸ªWindowsçš„IDMæ­£ç‰ˆç”¨æˆ·æ€¥éœ€IDM macOSç‰ˆï¼ï¼ï¼\n\n<!-- More -->\n# ä¸‹è½½Aira2\n## é€šè¿‡githubå®‰è£…\n- æ‰“å¼€githubä¸»é¡µ [aria2/aria2-Release](https://github.com/aria2/aria2/releases)\n- æ‰¾åˆ°å¯¹åº”çš„ç³»ç»Ÿä¸‹è½½å®‰è£…å³å¯\n\n## é€šè¿‡Homebrewå®‰è£…\nç»ˆç«¯è¾“å…¥å‘½ä»¤`brew install aria2`å®‰è£…å³å¯ã€‚\næ²¡æœ‰å®‰è£…Homebrewçš„åŒå­¦å¯ä»¥æœç´¢å®‰è£…Homebrewå³å¯ã€‚\n\n> è¿™ä¸ªè½¯ä»¶æ˜¯æ²¡æœ‰å›¾å½¢ç•Œé¢çš„ï¼Œæ‰€ä»¥å®‰è£…å¥½ä¹‹ååœ¨å¯åŠ¨å°é‡Œé¢æ˜¯æ‰¾ä¸åˆ°Aria2çš„å›¾æ ‡çš„\n\n# é…ç½®Aira2\n## å…ˆåˆ›å»ºAria2çš„é…ç½®æ–‡ä»¶\nAria2æä¾›äº†ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š\n1. ç›´æ¥å‘½ä»¤è¡Œæ¨¡å¼ä¸‹è½½\n    ä¸å¤ªæ¨èè¿™ç§ï¼Œå› ä¸ºå‘½ä»¤è¡Œä¸‹ä¸‹è½½æ¯”è¾ƒç¹çï¼Œè€Œä¸”ä¹Ÿä¸å¤ªå¥½æ“ä½œ\n2. RPCæ¨¡å¼\n    åœ¨è¿™ç§æ–¹å¼ï¼ŒAria2å¯åŠ¨ä¹‹åå°±ä¼šä»¥åå°çš„æ–¹å¼è¿è¡Œï¼Œä½ å°±å¯ä»¥é€šè¿‡WebUIæˆ–è€…å®‰è£…å®¢æˆ·ç«¯çš„æ–¹å¼æ¥ä½¿ç”¨å›¾å½¢ç•Œé¢æ§åˆ¶Aria2.\nä½†æ˜¯è¿™ç§æ–¹å¼ä¸‹éœ€è¦é…ç½®æ–‡ä»¶ï¼Œç°åœ¨å°±å‘Šè¯‰å¤§å®¶å¦‚ä½•é…ç½®ï¼š\né¦–å…ˆåˆ›å»ºæ–‡ä»¶\n\n```linux\ncd ~\nmkdir /.aria2\ncd /.aria2\ntouch aria2.conf\n```\n\nç„¶åæ‰“å¼€Finderï¼Œä½¿ç”¨å¿«æ·é”®`Shift+Cmd+G`å¼¹å‡ºè·¯å¾„è¾“å…¥æ¡†ï¼Œæ¥ç€å¤åˆ¶ç²˜è´´`~/.aria2/`å›è½¦å°±è¿›å…¥äº†`.aria2`æ–‡ä»¶å¤¹ï¼Œä½ å°±ä¼šçœ‹åˆ°é‡Œé¢çš„`aria2.conf`æ–‡ä»¶ï¼Œæ¥ç€ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œå¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹\n```\n#ç”¨æˆ·å\n#rpc-user=user\n#å¯†ç \n#rpc-passwd=passwd\n#ä¸Šé¢çš„è®¤è¯æ–¹å¼ä¸å»ºè®®ä½¿ç”¨,å»ºè®®ä½¿ç”¨ä¸‹é¢çš„tokenæ–¹å¼\n#è®¾ç½®åŠ å¯†çš„å¯†é’¥\n#rpc-secret=token\n#å…è®¸rpc\nenable-rpc=true\n#å…è®¸æ‰€æœ‰æ¥æº, webç•Œé¢è·¨åŸŸæƒé™éœ€è¦\nrpc-allow-origin-all=true\n#å…è®¸å¤–éƒ¨è®¿é—®ï¼Œfalseçš„è¯åªç›‘å¬æœ¬åœ°ç«¯å£\nrpc-listen-all=true\n#RPCç«¯å£, ä»…å½“é»˜è®¤ç«¯å£è¢«å ç”¨æ—¶ä¿®æ”¹\n#rpc-listen-port=6800\n#æœ€å¤§åŒæ—¶ä¸‹è½½æ•°(ä»»åŠ¡æ•°), è·¯ç”±å»ºè®®å€¼: 3\nmax-concurrent-downloads=5\n#æ–­ç‚¹ç»­ä¼ \ncontinue=true\n#åŒæœåŠ¡å™¨è¿æ¥æ•°\nmax-connection-per-server=5\n#æœ€å°æ–‡ä»¶åˆ†ç‰‡å¤§å°, ä¸‹è½½çº¿ç¨‹æ•°ä¸Šé™å–å†³äºèƒ½åˆ†å‡ºå¤šå°‘ç‰‡, å¯¹äºå°æ–‡ä»¶é‡è¦\nmin-split-size=10M\n#å•æ–‡ä»¶æœ€å¤§çº¿ç¨‹æ•°, è·¯ç”±å»ºè®®å€¼: 5\nsplit=10\n#ä¸‹è½½é€Ÿåº¦é™åˆ¶\nmax-overall-download-limit=0\n#å•æ–‡ä»¶é€Ÿåº¦é™åˆ¶\nmax-download-limit=0\n#ä¸Šä¼ é€Ÿåº¦é™åˆ¶\nmax-overall-upload-limit=0\n#å•æ–‡ä»¶é€Ÿåº¦é™åˆ¶\nmax-upload-limit=0\n#æ–­å¼€é€Ÿåº¦è¿‡æ…¢çš„è¿æ¥\n#lowest-speed-limit=0\n#éªŒè¯ç”¨ï¼Œéœ€è¦1.16.1ä¹‹åçš„releaseç‰ˆæœ¬\n#referer=*\n#æ–‡ä»¶ä¿å­˜è·¯å¾„, é»˜è®¤ä¸ºå½“å‰å¯åŠ¨ä½ç½®\ndir=/Users/xxx/Downloads\n#æ–‡ä»¶ç¼“å­˜, ä½¿ç”¨å†…ç½®çš„æ–‡ä»¶ç¼“å­˜, å¦‚æœä½ ä¸ç›¸ä¿¡Linuxå†…æ ¸æ–‡ä»¶ç¼“å­˜å’Œç£ç›˜å†…ç½®ç¼“å­˜æ—¶ä½¿ç”¨, éœ€è¦1.16åŠä»¥ä¸Šç‰ˆæœ¬\n#disk-cache=0\n#å¦ä¸€ç§Linuxæ–‡ä»¶ç¼“å­˜æ–¹å¼, ä½¿ç”¨å‰ç¡®ä¿æ‚¨ä½¿ç”¨çš„å†…æ ¸æ”¯æŒæ­¤é€‰é¡¹, éœ€è¦1.15åŠä»¥ä¸Šç‰ˆæœ¬(?)\n#enable-mmap=true\n#æ–‡ä»¶é¢„åˆ†é…, èƒ½æœ‰æ•ˆé™ä½æ–‡ä»¶ç¢ç‰‡, æé«˜ç£ç›˜æ€§èƒ½. ç¼ºç‚¹æ˜¯é¢„åˆ†é…æ—¶é—´è¾ƒé•¿\n#æ‰€éœ€æ—¶é—´ none < falloc ? trunc Â« prealloc, fallocå’Œtruncéœ€è¦æ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸æ”¯æŒ\nfile-allocation=prealloc\n\n#å¼€å¯BTä¸‹è½½\nenable-dht=true\nbt-enable-lpd=true\nenable-peer-exchange=true\n# bt-tracker æ›´æ–°ï¼Œè§£å†³Aria2 BTä¸‹è½½é€Ÿåº¦æ…¢æ²¡é€Ÿåº¦çš„é—®é¢˜\nudp://tracker.coppersurfer.tk:6969/announce,http://tracker.internetwarriors.net:1337/announce,udp://tracker.opentrackr.org:1337/announce,udp://9.rarbg.to:2710/announce,udp://9.rarbg.me:2710/announce,udp://tracker.openbittorrent.com:80/announce,http://tracker3.itzmx.com:6961/announce,http://tracker1.itzmx.com:8080/announce,udp://exodus.desync.com:6969/announce,udp://retracker.lanta-net.ru:2710/announce,udp://tracker.torrent.eu.org:451/announce,udp://tracker.tiny-vps.com:6969/announce,udp://bt.xxx-tracker.com:2710/announce,udp://tracker2.itzmx.com:6961/announce,udp://tracker.cyberia.is:6969/announce,udp://open.demonii.si:1337/announce,udp://explodie.org:6969/announce,udp://denis.stalker.upeer.me:6969/announce,udp://open.stealth.si:80/announce,http://tracker4.itzmx.com:2710/announce\n```\n\nä¸ç”¨æ›´æ”¹å•¥ï¼Œä¹Ÿä¸å»ºè®®æ›´æ”¹å•¥ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹ä¸Šé¢çš„é…ç½®å†…å®¹ï¼Œè‡³å°‘è®°å¾—æ¯ä¸€é¡¹å¤§è‡´æ˜¯ä¸ªå•¥ï¼Œå› ä¸ºç­‰ä¼šé…ç½®å›¾å½¢ç•Œé¢éœ€è¦è¿™äº›ä¿¡æ¯ã€‚\n\næœ€åé¢çš„BTä¸‹è½½çš„`bt-tracker`å¤§å®¶é…ç½®è®°å¾—åˆ°è¿™ä¸ªé¡µé¢æ›´æ–°ï¼šhttps://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt\n\nç„¶åå†æŠŠå†…å®¹å¤åˆ¶ç²˜è´´è¿‡å»ã€‚\n\nä¸‹è½½è·¯å¾„ä½ å¯ä»¥è‡ªå·±é€‰æ‹©ï¼Œå¯ä»¥å°±æŠŠ`/Users/xxx/Downloads`ä¸­çš„`xxx`æ¢æˆä½ è‡ªå·±çš„macOSç”¨æˆ·åå³å¯ã€‚\n\n# å¯åŠ¨Aria2 RPCæ¨¡å¼\nç»ˆç«¯è¾“å…¥`aria2c --conf-path=\"/Users/xxx/.aria2/aria2.conf\" -D`å°±å¯ä»¥å¯åŠ¨äº†ã€‚ä¸€æ ·çš„ï¼Œxxxæ˜¯ä½ çš„ç”¨æˆ·åã€‚\n\n# è¿›å…¥å›¾å½¢ç•Œé¢\nAria2æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹å›¾å½¢ç•Œé¢ï¼Œå®¢æˆ·ç«¯æœ‰ï¼Œä½†æ˜¯æˆ‘æ²¡ç”¨è¿‡æ‰€ä»¥æˆ‘ä¸åšä»‹ç»ï¼Œåœ¨è¿™ä¸»è¦ä»‹ç»WebUIã€‚\n\n## YAAWæ’ä»¶\n1. åœ¨chromeçš„æ‹“å±•ä¸­å¿ƒæœç´¢`YAAW`ï¼Œç„¶åå®‰è£…å³å¯ï¼Œæ¥ç€å°±ä¼šå‡ºç°YAAMçš„æ’ä»¶\n2. ç‚¹å‡»æ‰“å¼€å®ƒï¼Œå°±ä¼šè¿›å…¥YAAWçš„WebUIã€‚\n![](http://cdn.littlecorgi.top/mweb/15647112624749.jpg)\n3. ç‚¹å‡»å³ä¸Šè§’çš„ğŸ”§å›¾æ ‡ï¼Œè¿›å…¥è®¾ç½®ç•Œé¢\n![](http://cdn.littlecorgi.top/mweb/15647113330438.jpg)\n4. å¦‚æœä½ ä¸Šé¢çš„`aria2.conf`æ˜¯ç›´æ¥å¤åˆ¶ç²˜è´´çš„æˆ‘çš„è¯ï¼Œç…§ç€æˆ‘å›¾ä¸­çš„å¡«å†™å°±å¯ä»¥äº†ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨äº†ã€‚æ‰¾åˆ°éœ€è¦ä¸‹è½½çš„èµ„æºå³é”®ç„¶åé€‰æ‹©YAAWå°±ä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½ã€‚\n\n## AriaNg WebUI\nè¿™ä¸ªæ¯”ä¸Šé¢é‚£ä¸ªå¥½çœ‹ç‚¹ï¼Œç¼ºç‚¹æ˜¯æ²¡æœ‰æ’ä»¶ï¼Œä½ åªèƒ½å¤åˆ¶ä¸‹è½½é“¾æ¥æ‰‹åŠ¨æ–°å»ºä¸‹è½½ä»»åŠ¡\n1. åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ç½‘å€ `http://ariang.mayswind.net/latest/#!/downloading`\n![](http://cdn.littlecorgi.top/mweb/15647115205711.jpg)\n\n\n2. ç‚¹å‡»AriaNgè®¾ç½®\n![](http://cdn.littlecorgi.top/mweb/15647115637006.jpg)\n3. ä¸€æ ·ï¼Œå¦‚æœä½ ä¸Šé¢çš„`aria2.conf`æ˜¯ç›´æ¥å¤åˆ¶ç²˜è´´çš„æˆ‘çš„è¯ï¼Œç…§ç€æˆ‘å›¾ä¸­çš„å¡«å†™å°±å¯ä»¥äº†ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨äº†ã€‚\n4. ä½ å¯ä»¥ç‚¹å‡»Aria2çŠ¶æ€ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å·²è¿æ¥ï¼Œå¦‚æœä¸æ˜¯å°±çœ‹çœ‹æœ‰æ²¡æœ‰å“ªå„¿å’Œ`aria2.conf`è®¾ç½®çš„ä¸ä¸€æ ·ã€‚\n![](http://cdn.littlecorgi.top/mweb/15647116500131.jpg)\n\n# å…³é—­Aria2\nè¿™ä¸ªå¥½åƒå®˜æ–¹æ²¡æœ‰æ–¹æ³•å…³é—­ï¼Œäºæ˜¯æˆ‘ä»¬å°±ç”¨æœ€ç®€å•ç²—æš´çš„æ–¹æ³•ã€‚\n1. ç»ˆç«¯è¾“å…¥`ps aux|grep aria2`å¾—åˆ°Aria2çš„è¿›ç¨‹å·\n2. ç„¶åè¾“å…¥`kill number`è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ç›´æ¥æ€æ­»è¿™ä¸ªè¿›ç¨‹ï¼Œ`number`æ”¹ä¸ºä¸Šé¢çš„åˆ°çš„è¿›ç¨‹å·å³å¯ã€‚\n\n# é…ç½®è‡ªå¯åŠ¨\n## åˆ›å»ºshæ–‡ä»¶\nè¿›å…¥åˆ°å¸Œæœ›ä¿å­˜çš„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶`aria2.sh`ï¼š\n```\ntouch aria2.sh\n```\nç„¶åè¾“å…¥ä¸‹é¢çš„ä»£ç å¹¶ä¿å­˜ï¼š\n```\n#!/bin/bash\necho \"start aria2 server\"\naria2c --conf-path=\"/Users/xxx/.aria2/aria2.conf\" -D\necho \"exiting\"\nexit\n```\n## ä¿®æ”¹æ–‡ä»¶æƒé™\n1. ç»™`aria2.sh`æ–‡ä»¶æ‰§è¡Œæƒé™ï¼š`chmod +x aria2.sh`\n2. è®©`aria2.sh`é»˜è®¤ç”¨è‡ªå·±å¸¸ç”¨çš„terminalå·¥å…·æ‰“å¼€ã€‚å³é”®æ–‡ä»¶ ï¼> æ˜¾ç¤ºç®€ä»‹ï¼šè®¾ç½®â€œæ‰“å¼€æ–¹å¼->æ‰€æœ‰åº”ç”¨ç¨‹åºâ€ä¸ºè‡ªå·±çš„terminalå³å¯ã€‚\n\n## æ·»åŠ åˆ°å¼€æœºå¯åŠ¨é¡¹\n1. åœ¨`Mac`æ¡Œé¢é¡¶éƒ¨èœå•ä¸­ï¼Œç‚¹å‡»è‹¹æœå›¾æ ‡ï¼Œåœ¨å¼¹å‡ºçš„èœå•ä¸­ï¼Œç‚¹å‡»è¿›å…¥ç³»ç»Ÿåå¥½è®¾ç½®ã€‚\n2. åœ¨æ‰“å¼€ç³»ç»Ÿåå¥½è®¾ç½®åï¼Œç„¶åç‚¹å‡»è¿›å…¥ç”¨æˆ·ä¸ç¾¤ç»„è®¾ç½®é€‰é¡¹ã€‚\n3. ç„¶ååœ¨ç”¨æˆ·ä¸ç¾¤ç»„è®¾ç½®ç•Œé¢ï¼Œå…ˆåœ¨å·¦ä¾§é€‰æ‹©ç™»é™†ç”¨æˆ·-å½“å‰ç”¨æˆ·ï¼Œç„¶ååœ¨å³ä¾§åˆ‡æ¢åˆ°ç™»å½•é¡¹\n4. ç„¶åç‚¹ä¸‹é¢çš„+è¿›è¡Œæ·»åŠ ï¼Œé€‰æ‹©åˆšæ‰æˆ‘ä»¬åˆ›å»ºçš„æ–‡ä»¶aria2.shï¼Œå¹¶å‹¾é€‰éšè—ã€‚\nè¿™æ · aria2 å°±å¯ä»¥åœ¨æ¯æ¬¡å¼€æœºçš„æ—¶å€™è‡ªå¯åŠ¨äº†ã€‚\n\n### æœ€åï¼ŒAria2å¸è½½æ–¹å¼\nç»ˆç«¯ä¸‹æ‰§è¡Œ`sudo pkgutil --forget aria2`ä»¥åŠ`sudo pkgutil --forget aria2.path`ï¼Œç„¶åä¸Šé¢åˆ›å»ºçš„`.aria2`æ–‡ä»¶å¤¹","tags":["Aria2"],"categories":["æ‚é¡¹"]},{"title":"æ“ä½œç³»ç»Ÿ3--è¿›ç¨‹çš„åŒæ­¥","url":"/posts/362e394f.html","content":">å¤§å®¶å¯ä»¥çœ‹ä¸‹æˆ‘ä½¿ç”¨å¹•å¸ƒè½¯ä»¶ç”»çš„[æ€ç»´å¯¼å›¾](https://mubu.com/doc/3Pf0zwzrgw)ï¼Œå¦‚æœå¤§å®¶æƒ³ä½¿ç”¨å¹•å¸ƒå¯ä»¥é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œï¼Œå¯å…è´¹è·å¾—ä¸€ä¸ªæœˆé«˜çº§ä¼šå‘˜https://mubu.com/inv/477598\n<!--More-->\n# 3.1 è¿›ç¨‹åŒæ­¥\n## 3.1.1 åŒæ­¥æ¦‚å¿µ\n### 3.1.1.1 è¿›ç¨‹åŒæ­¥çš„æ¦‚å¿µ\nè¿›ç¨‹åŒæ­¥æœºåˆ¶çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯å¯¹å¤šä¸ªç›¸å…³è¿›ç¨‹åœ¨æ‰§è¡Œæ¬¡åºä¸Šè¿›è¡Œåè°ƒï¼Œä½¿å¹¶å‘æ‰§è¡Œçš„è¿›ç¨‹ä¹‹é—´èƒ½æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å…±äº«ç³»ç»Ÿèµ„æºï¼Œå¹¶èƒ½å¾ˆå¥½çš„é…åˆå·¥ä½œï¼Œä»è€Œä½¿ç¨‹åºçš„æ‰§è¡Œå…·æœ‰å¯å†ç°æ€§ã€‚\n\n### 3.1.1.2 åˆ¶çº¦å…³ç³»\nå¯¹äºå¤„äºåŒä¸€ä¸ªç³»ç»Ÿä¸­çš„å¤šä¸ªè¿›ç¨‹ï¼Œç”±äºä»–ä»¬å…±äº«ç€ç³»ç»Ÿçš„èµ„æºï¼Œæˆ–è€…ä¸ºäº†å®ŒæˆåŒä¸€ä¸ªä»»åŠ¡è€Œç›¸äº’åˆä½œï¼Œæ‰€ä»¥ä»–ä»¬ä¹‹é—´å¯èƒ½å­˜åœ¨ä¸‹é¢ä¸¤ç§åˆ¶çº¦å…³ç³»ï¼š\n1. é—´æ¥ç›¸äº’åˆ¶çº¦å…³ç³»\n    ç³»ç»Ÿä¸­çš„è¿›ç¨‹éš¾å…ä¼šè°ƒç”¨åƒæ‰“å°æœºã€CPUç­‰è¿™æ ·çš„ä¸´ç•Œèµ„æºã€‚å¦‚æœæƒ³è¿™äº›èµ„æºæ­£å¸¸è°ƒç”¨ï¼Œå¿…é¡»ä¿è¯å¤šä¸ªè¿›ç¨‹ä¹‹é—´äº’æ–¥åœ°è®¿é—®è¿™äº›èµ„æºï¼Œè¿›è€Œå°±åœ¨è¿™äº›è¿›ç¨‹é—´å½¢æˆäº†é—´æ¥ç›¸äº’åˆ¶çº¦å…³ç³»ã€‚\n    ä¸ºäº†ä¿è¯è¿™äº›è¿›ç¨‹èƒ½æœ‰åºçš„è¿›è¡Œï¼Œå¯¹äºç³»ç»Ÿä¸­çš„è¿™ç±»èµ„æºï¼Œå¿…é¡»ç”±ç³»ç»Ÿå®æ–½ç»Ÿä¸€åˆ†é…ï¼Œå³ç”¨æˆ·åœ¨ä½¿ç”¨ä¹‹å‰å¿…é¡»å…ˆæå‡ºç”³è¯·ï¼Œç»ä¸å…è®¸ç”¨æˆ·ç›´æ¥ä½¿ç”¨ã€‚\n2. ç›´æ¥ç›¸äº’åˆ¶çº¦å…³ç³»\n    åœ¨ç³»ç»Ÿä¸­ä¹Ÿä¼šå­˜åœ¨ä¸€äº›è¿›ç¨‹ï¼Œä»–ä»¬ä¸ºäº†å®ŒæˆåŒä¸€ä¸ªç›®æ ‡è€Œç›¸äº’é…åˆåˆä½œå·¥ä½œï¼Œè¿™ç§å°±æ˜¯ç›´æ¥äº’ç›¸åˆ¶çº¦å…³ç³»ã€‚\n    è¿›ç¨‹é—´çš„ç›´æ¥åˆ¶çº¦å…³ç³»å°±æ˜¯æºäºä»–ä»¬ä¹‹é—´çš„ç›¸äº’åˆä½œã€‚\n\n### 3.1.1.3 ä¸´ç•Œèµ„æº\nè™½ç„¶å¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«ç³»ç»Ÿä¸­çš„å„ç§èµ„æºï¼Œä½†å…¶ä¸­è®¸å¤šèµ„æºä¸€æ¬¡åªèƒ½ä¸ºä¸€ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨ï¼Œæˆ‘ä»¬æŠŠä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºç§°ä¸ºä¸´ç•Œèµ„æºã€‚è®¸å¤šç‰©ç†è®¾å¤‡éƒ½å±äºä¸´ç•Œèµ„æºï¼Œå¦‚æ‰“å°æœºç­‰ã€‚æ­¤å¤–ï¼Œå¦‚æœå˜é‡ã€æ•°æ®ç­‰éƒ½å¯ä»¥è¢«è‹¥å¹²è¿›ç¨‹å…±äº«ï¼Œä¹Ÿå±äºä¸´ç•Œèµ„æºã€‚\n\n### 3.1.1.4 ä¸´ç•ŒåŒº\näººä»¬æŠŠåœ¨æ¯ä¸ªè¿›ç¨‹ä¸­è®¿é—®ä¸´ç•Œèµ„æºçš„é‚£æ®µä»£ç ç§°ä¸ºä¸´ç•ŒåŒºã€‚è‹¥èƒ½ä¿è¯è¯¸è¿›ç¨‹äº’æ–¥åœ°è¿›å…¥è‡ªå·±çš„ä¸´ç•ŒåŒºï¼Œä¾¿å¯å®ç°è¯¸è¿›ç¨‹å¯¹ä¸´ç•Œèµ„æºçš„äº’æ–¥è®¿é—®ã€‚\nä¸ºæ­¤ï¼Œæ¯ä¸ªè¿›ç¨‹åœ¨è¿›å…¥ä¸´ç•ŒåŒºä¹‹å‰ï¼Œåº”å…ˆå¯¹è¦è®¿é—®çš„ä¸´ç•ŒåŒºè¿›ç¨‹æ£€æŸ¥ï¼šå¦‚æœä¸´ç•ŒåŒºæ­£åœ¨è¢«è®¿é—®ï¼Œåˆ™è¿›ç¨‹ä¸èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼›å¦‚æœä¸´ç•ŒåŒºæ²¡æœ‰è¢«è®¿é—®ï¼Œé‚£è¿›ç¨‹å°±å¯è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¹¶å°†ä¸´ç•ŒåŒºæ­£åœ¨è¢«è®¿é—®çš„æ ‡å¿—ç½®ä¸ºæ­£è¢«è®¿é—®ã€‚\næ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®ä¸´ç•Œèµ„æºçš„çº¿ç¨‹çš„å¾ªç¯ä»£ç åˆ†ä¸ºå¦‚ä¸‹éƒ¨åˆ†ï¼š\n- è®¿é—®ä¸´ç•ŒåŒºä¹‹å‰ç”¨äºä¸Šè¿°åˆ¤æ–­çš„ä»£ç åŒºç§°ä¸º**è¿›å…¥åŒº**\n- åœ¨è®¿é—®å®Œä¸´ç•ŒåŒºä¹‹åç”¨äºå°†ä¸´ç•ŒåŒºæ­£è¢«è®¿é—®çš„æ ‡å¿—æ¢å¤ä¸ºæœªè¢«è®¿é—®çš„æ ‡å¿—çš„ä»£ç åŒºç§°ä¸º**é€€å‡ºåŒº**\n- é™¤äº†è¿›å…¥å»ã€ä¸´ç•ŒåŒºã€é€€å‡ºåŒºä»£ç ä¹‹å¤–çš„å…¶å®ƒä»£ç ç§°ä¸º**å‰©ä½™åŒº**\n\n```c\nwhile (true) {\n    è¿›å…¥åŒº\n    ä¸´ç•ŒåŒº\n    é€€å‡ºåŒº\n    å‰©ä½™åŒº\n}\n```\n\n### 3.1.1.5 åŒæ­¥æœºåˆ¶åº”éµå¾ªçš„è§„åˆ™\n1. ç©ºé—²è®©è¿›ï¼šå½“æ— è¿›ç¨‹å¤„äºä¸´ç•ŒåŒºæ—¶ï¼Œè¡¨æ˜ä¸´ç•Œèµ„æºå¤„äºç©ºé—²çŠ¶æ€ï¼Œåº”å…è®¸ä¸€ä¸ªè¯·æ±‚è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹ç«‹å³è¿›å…¥è‡ªå·±çš„ä¸´ç•ŒåŒºï¼Œä»¥æœ‰æ•ˆçš„åˆ©ç”¨ä¸´ç•Œèµ„æº\n2. å¿™åˆ™ç­‰å¾…ï¼šå½“å·²æœ‰è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œè¡¨æ˜ä¸´ç•Œèµ„æºæ­£åœ¨è¢«è®¿é—®ï¼Œå› è€Œå…¶å®ƒè§†å›¾è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹å¿…é¡»ç­‰å¾…ï¼Œä»¥ä¿è¯å¯¹ä¸´ç•Œèµ„æºçš„äº’æ–¥è®¿é—®\n3. æœ‰é™ç­‰å¾…ï¼šå¯¹è¦æ±‚è®¿é—®ä¸´ç•Œèµ„æºçš„è¿›ç¨‹ï¼Œåº”ä¿è¯åœ¨æœ‰é™çš„æ—¶é—´å†…èƒ½è¿›å…¥è‡ªå·±çš„ä¸´ç•ŒåŒºï¼Œä»¥å…é™·å…¥â€œæ­»ç­‰â€çŠ¶æ€\n4. è®©æƒç­‰å¾…ï¼šå½“è¿›ç¨‹ä¸èƒ½è¿›å…¥è‡ªå·±çš„ä¸´ç•ŒåŒºæ—¶ï¼Œåº”ç«‹å³é‡Šæ”¾å¤„ç†æœºï¼Œä»¥å…è¿›ç¨‹é™·å…¥â€œå¿™ç­‰â€çŠ¶æ€\n\n## 3.1.2 åŒæ­¥æœºåˆ¶\n### 3.2.2.1 ä¿¡å·é‡æœºåˆ¶\n#### 1. ä»€ä¹ˆæ˜¯ä¿¡å·é‡\nä¿¡å·é‡çš„æ•°æ®ç»“æ„ä¸ºä¸€ä¸ªå€¼å’Œä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘ç­‰å¾…è¯¥ä¿¡å·é‡çš„ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå€¼åˆ™ä¸ç›¸åº”çš„èµ„æºçš„ä½¿ç”¨æƒ…å†µæœ‰å…³ï¼š\n- å½“ä»–çš„å€¼å¤§äº0æ—¶ï¼Œè¡¨ç¤ºå½“å‰å¯ç”¨èµ„æºçš„æ•°é‡\n- å½“ä»–çš„å€¼å°äº0æ—¶ï¼Œå…¶ç»å¯¹å€¼è¡¨ç¤ºç­‰å¾…ä½¿ç”¨è¯¥èµ„æºçš„è¿›ç¨‹ä¸ªæ•°\n\n#### 2. ä»€ä¹ˆæ˜¯ä¿¡å·é‡æœºåˆ¶\nä¿¡å·é‡æœºåˆ¶å³åˆ©ç”¨pvæ“ä½œå¯¹ä¿¡å·é‡è¿›è¡Œå¤„ç†ã€‚è€Œä¸”ä¿¡å·é‡åªèƒ½ç”±pvæ“ä½œè¿›ç¨‹å¤„ç†ã€‚\nå½“S>0æ—¶ï¼ŒSè¡¨ç¤ºå¯ç”¨èµ„æºçš„æ•°é‡ã€‚æ‰§è¡Œä¸€æ¬¡Pæ“ä½œæ„å‘³ç€åˆ†é…ä¸€ä¸ªå•ä½èµ„æºï¼Œå› æ­¤Så€¼å‡1ï¼›å½“S<0æ—¶ï¼Œè¡¨ç¤ºå·²ç»æ²¡æœ‰å¯ç”¨èµ„æºï¼Œè¯·æ±‚è€…å¿…é¡»ç­‰å¾…åˆ«çš„è¿›ç¨‹é‡Šæ”¾è¯¥ç±»èµ„æºï¼Œä»–æ‰èƒ½è¿è¡Œä¸‹å»ã€‚è€Œæ‰§è¡Œä¸€ä¸ªVæ“ä½œä»¥ä¸ºç€é‡Šæ”¾ä¸€ä¸ªå•ä½èµ„æºï¼Œå› æ­¤Sçš„å€¼åŠ 1ï¼›å½“S>0ï¼Œè¡¨ç¤ºæœ‰æŸäº›èµ„æºæ­£åœ¨ç­‰å¾…è¯¥èµ„æºï¼Œå› æ­¤è¦å”¤é†’ä¸€ä¸ªç­‰å¾…çŠ¶æ€çš„è¿›ç¨‹ï¼Œä½¿ä¹‹è¿è¡Œä¸‹å»ã€‚\n\n### 3.2.2.2 PVæ“ä½œ\n#### 1. Pæ“ä½œ\nç”³è¯·ä¸€ä¸ªå•ä½èµ„æºï¼Œè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒº\n```c\nwait (S) {\n    while (s <= 0) ;// å¦‚æœæ²¡æœ‰èµ„æºåˆ™å¾ªç¯ç­‰å¾…\n    S--;\n}\n```\n1. å°†ä¿¡å·é‡Sçš„å€¼å‡1ï¼Œå³S=S-1ï¼›\n2. å¦‚æœS<=0ï¼Œåˆ™è¯¥è¿›ç¨‹ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™è¯¥è¿›ç¨‹ç½®ä¸ºç­‰å¾…çŠ¶æ€ï¼Œæ’å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚\n\n#### 2. Væ“ä½œ\né‡Šæ”¾ä¸€ä¸ªå•ä½èµ„æºï¼Œè¿›ç¨‹ä»ä¸´ç•ŒåŒºå‡ºæ¥\n```c\nsignal (S) {\n    S++;\n}\n```\n1. å°†ä¿¡å·é‡Sçš„å€¼åŠ 1ï¼Œå³S=S+1ï¼›\n2. å¦‚æœS>0ï¼Œåˆ™è¯¥è¿›ç¨‹ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™é‡Šæ”¾é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç­‰å¾…ä¿¡å·é‡çš„è¿›ç¨‹ã€‚\n\n#### 3. PVæ“ä½œçš„æ„ä¹‰\nç”¨PVæ“ä½œæ¥å®ç°è¿›ç¨‹çš„åŒæ­¥å’Œäº’æ–¥\n\n### 3.2.3 ç®¡ç¨‹æœºåˆ¶\nå°½ç®¡ä¿¡å·é‡æœºåˆ¶å¾ˆæ–¹åˆé«˜æ•ˆï¼Œä½†æ˜¯æ¯ä¸ªè¦è®¿é—®ä¸´ç•Œèµ„æºçš„è¿›ç¨‹éƒ½å¿…é¡»å¿…å¤‡åŒæ­¥æ“ä½œï¼Œè¿™å°±ä½¿å¾—å¤§é‡çš„åŒæ­¥æ“ä½œåˆ†æ•£åœ¨å„ä¸ªè¿›ç¨‹ä¸­ã€‚è¿™ä¸ä»…ç»™ç³»ç»Ÿçš„ç®¡ç†å¸¦æ¥éº»çƒ¦ï¼Œè¿˜ä¼šå› åŒæ­¥æ“ä½œä¸å½“è€Œäº§ç”Ÿæ­»é”ã€‚ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå˜äº§ç”Ÿäº†ä¸€ç§æ–°çš„åŒæ­¥å·¥å…·â€”â€”ç®¡ç¨‹ã€‚\n#### 1. ç®¡ç¨‹çš„å®šä¹‰\nç³»ç»Ÿä¸­å„ç§ç¡¬ä»¶èµ„æºå’Œè½¯ä»¶èµ„æºå‡å¯ç”¨æ•°æ®ç»“æ„æŠ½è±¡åœ°æè¿°å…¶èµ„æºç‰¹å¾ï¼Œå³ç”¨å°‘é‡ä¿¡æ¯å’Œå¯¹è¯¥èµ„æºæ‰€æ‰§è¡Œçš„æ“ä½œæ¥è¡¨å¾è¯¥èµ„æºã€‚æ‰€ä»¥å°±å‡ºç°äº†ç®¡ç¨‹ã€‚\nç®¡ç¨‹å¯ä»¥çœ‹æˆä¸€ä¸ªè½¯ä»¶æ¨¡å—ï¼Œå®ƒæ˜¯å°†å…±äº«çš„å˜é‡å’Œå¯¹äºè¿™äº›å…±äº«å˜é‡çš„æ“ä½œå°è£…èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå…·æœ‰ä¸€å®šæ¥å£çš„åŠŸèƒ½æ¨¡å—ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨ç®¡ç¨‹æ¥å®ç°è¿›ç¨‹çº§åˆ«çš„å¹¶å‘æ§åˆ¶ã€‚\nåœ¨ç®¡ç¨‹å…¥å£å¤„çš„ç­‰å¾…é˜Ÿåˆ—ç§°ä¸ºå…¥å£ç­‰å¾…é˜Ÿåˆ—ï¼Œç”±äºè¿›ç¨‹ä¼šæ‰§è¡Œå”¤é†’æ“ä½œï¼Œå› æ­¤å¯èƒ½æœ‰å¤šä¸ªç­‰å¾…ä½¿ç”¨ç®¡ç¨‹çš„é˜Ÿåˆ—ï¼Œè¿™æ ·çš„é˜Ÿåˆ—ç§°ä¸ºç´§æ€¥é˜Ÿåˆ—ï¼Œå®ƒçš„ä¼˜å…ˆçº§é«˜äºç­‰å¾…é˜Ÿåˆ—ã€‚\n\n#### 2. ç®¡ç¨‹çš„ç‰¹å¾\n1. æ¨¡å—åŒ–\n    ç®¡ç¨‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„è½¯ä»¶æ¨¡å—ï¼Œå¯ä»¥å•ç‹¬ç¼–è¯‘\n2. æŠ½è±¡æ•°æ®ç±»å‹\n    ç®¡ç¨‹ä¸­å°è£…äº†æ•°æ®åŠå¯¹äºæ•°æ®çš„æ“ä½œ\n3. ä¿¡æ¯éšè—\n    ç®¡ç¨‹å¤–çš„è¿›ç¨‹æˆ–å…¶ä»–è½¯ä»¶æ¨¡å—åªèƒ½é€šè¿‡ç®¡ç¨‹å¯¹å¤–çš„æ¥å£æ¥è®¿é—®ç®¡ç¨‹æä¾›çš„æ“ä½œï¼Œç®¡ç¨‹å†…éƒ¨çš„å®ç°ç»†èŠ‚å¯¹å¤–ç•Œæ˜¯é€æ˜çš„\n4. ä½¿ç”¨çš„äº’æ–¥æ€§\n    ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œç®¡ç¨‹åªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚è¿›å…¥ç®¡ç¨‹æ—¶çš„äº’æ–¥ç”±ç¼–è¯‘å™¨è´Ÿè´£å®Œæˆ\n\n#### 3. æ¡ä»¶å˜é‡\n\nä¸€ä¸ªè¿›ç¨‹è¢«é˜»å¡æˆ–æŒ‚èµ·çš„æ¡ä»¶ï¼ˆåŸå› ï¼‰æœ‰å¤šä¸ªï¼Œå› æ­¤åœ¨ç®¡ç¨‹ä¸­è®¾ç½®äº†å¤šä¸ªæ¡ä»¶å˜é‡ï¼Œå¯¹è¿™äº›æ¡ä»¶å˜é‡çš„è®¿é—®åªèƒ½åœ¨ç®¡ç¨‹ä¸­è¿›è¡Œã€‚\nç®¡ç¨‹ä¸­æ¯ä¸ªæ¡ä»¶å˜é‡éƒ½éœ€äºˆä»¥è¯´æ˜ï¼Œå½¢å¼ä¸ºï¼š`condition x`ã€‚å¯¹å…¶çš„æ“ä½œåªæœ‰`wait`å’Œ`signal`ï¼Œå…¶å«ä¹‰æ˜¯ï¼š\n1. `x.wait`ï¼šæ­£åœ¨è°ƒç”¨ç®¡ç¨‹çš„è¿›ç¨‹å› xæ¡ä»¶éœ€è¦è¢«é˜»å¡æˆ–æŒ‚èµ·ï¼Œåˆ™è°ƒç”¨`x.wait`å°†è‡ªå·±æ’å…¥åˆ°xæ¡ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼Œå¹¶é‡Šæ”¾ç®¡ç¨‹ï¼ŒçŸ¥é“xæ¡ä»¶å‘ç”Ÿå˜åŒ–ã€‚æ­¤æ—¶å…¶å®ƒè¿›ç¨‹å¯ä»¥ä½¿ç”¨è¯¥ç®¡ç¨‹ã€‚\n2. `x.signal`ï¼š æ­£åœ¨è°ƒç”¨ç®¡ç¨‹çš„è¿›ç¨‹å‘ç°xæ¡ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™è°ƒç”¨`x.signal`ï¼Œé‡æ–°å¯åŠ¨ä¸€ä¸ªå› xæ¡ä»¶è€Œé˜»å¡æˆ–æŒ‚èµ·çš„è¿›ç¨‹ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿™æ ·çš„è¿›ç¨‹ï¼Œåˆ™é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰ï¼Œç»§ç»­æ‰§è¡ŒåŸè¿›ç¨‹ï¼Œä¸äº§ç”Ÿä»»ä½•ç»“æœã€‚ï¼ˆä¸ä¿¡å·é‡çš„signalä¸åŒï¼Œæ²¡æœ‰s=s+1çš„æ“ä½œï¼‰\n\n# 3.2 è¿›ç¨‹åŒæ­¥çš„ç»å…¸é—®é¢˜\n## 3.2.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜\n### 1. é—®é¢˜æè¿°\næœ‰ä¸€ç¾¤ç”Ÿäº§è€…è¿›ç¨‹åœ¨ç”Ÿäº§äº§å“ï¼Œå¹¶å°†è¿™äº›äº§å“æä¾›ç»™æ¶ˆè´¹è€…è¿›ç¨‹å»æ¶ˆè´¹ã€‚ä¸ºä½¿ç”Ÿäº§è€…è¿›ç¨‹ä¸æ¶ˆè´¹è€…è¿›ç¨‹èƒ½å¹¶å‘æ‰§è¡Œï¼Œåœ¨ä¸¤è€…ä¹‹é—´è®¾ç½®äº†ä¸€ä¸ªå¤§å°ä¸ºnçš„ç¼“å†²åŒºï¼Œç”Ÿäº§è€…è¿›ç¨‹å°†å…¶æ‰€äº§ç”Ÿçš„äº§å“æ”¾å…¥ç¼“å†²åŒºä¸­ï¼›æ¶ˆè´¹è€…å¯ä»ç¼“å†²åŒºä¸­å–èµ°äº§å“å»æ¶ˆè´¹ã€‚ä»–ä»¬ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æ—¢ä¸å…è®¸æ¶ˆè´¹è€…è¿›ç¨‹åˆ°ä¸€ä¸ªç©ºç¼“å†²åŒºå»å–äº§å“ï¼Œä¹Ÿä¸å…è®¸ç”Ÿäº§è€…è¿›ç¨‹å‘ä¸€ä¸ªå·²è£…æ»¡äº§å“ä¸”å°šæœªè¢«å–èµ°çš„ç¼“å†²åŒºä¸­æŠ•æ”¾äº§å“ã€‚\n![ProducerConsumerProble](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/31/ProducerConsumerProblem.jpg)\n### 2. é—®é¢˜åˆ†æ\néœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š\n- åœ¨ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¸èƒ½å†è¿›è¡Œæ¶ˆè´¹\n- åœ¨ç¼“å†²åŒºå·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…ä¸èƒ½å†è¿›è¡Œç”Ÿäº§\n- å½“ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç”Ÿäº§æˆ–æ¶ˆè´¹æ—¶ï¼Œå…¶ä½™çº¿ç¨‹ä¸èƒ½å†è¿›è¡Œç”Ÿäº§æˆ–æ¶ˆè´¹\n\n### 3. ä¼ªä»£ç \n```c\nvar items = 0, space = 10, mutex = 1;\nvar in = 0, out = 0;\nitem buf[10] = { NULL };\n\nproducer {\n    while( true ) {\n        wait( space );  // ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºé—²ä½ç½®ï¼Œ åœ¨ä½¿ç”¨PVæ“ä½œæ—¶ï¼Œæ¡ä»¶å˜é‡éœ€è¦åœ¨äº’æ–¥é”ä¹‹å‰\n        wait( mutex );  // ä¿è¯åœ¨productæ—¶ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è®¿é—®ç¼“å†²åŒº\n\n        // product\n        buf.push( item, in );  // å°†æ–°èµ„æºæ”¾åˆ°buf[in]ä½ç½® \n        in = ( in + 1 ) % 10;\n\n        signal( mutex );  // å”¤é†’çš„é¡ºåºå¯ä»¥ä¸åŒ\n        signal( items );  // é€šçŸ¥consumerç¼“å†²åŒºæœ‰èµ„æºå¯ä»¥å–èµ°\n    }\n}\n\nconsumer {\n    while( true ) {\n        wait( items );  // ç­‰å¾…ç¼“å†²åŒºæœ‰èµ„æºå¯ä»¥ä½¿ç”¨\n        wait( mutex );  // ä¿è¯åœ¨consumeæ—¶ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è®¿é—®ç¼“å†²åŒº\n\n        // consume\n        buf.pop( out );  // å°†buf[out]ä½ç½®çš„çš„èµ„æºå–èµ°\n        out = ( out + 1 ) % 10;\n\n        signal( mutex );  // å”¤é†’çš„é¡ºåºå¯ä»¥ä¸åŒ\n        signal( space );  // é€šçŸ¥ç¼“å†²åŒºæœ‰ç©ºé—²ä½ç½®\n    }\n}\n```\nä¸èƒ½å°†çº¿ç¨‹é‡Œä¸¤ä¸ª`wait`çš„é¡ºåºè°ƒæ¢å¦åˆ™ä¼šå‡ºç°æ­»é”ã€‚ä¾‹å¦‚(è°ƒæ¢å)ï¼Œå°†`consumer`çš„ä¸¤ä¸ª`wait`è°ƒæ¢ï¼Œåœ¨`producer`å‘å‡º`signal`ä¿¡å·åï¼Œå¦‚æœ`producer`çº¿ç¨‹æ­¤æ—¶å†æ¬¡è·å¾—è¿è¡Œæœºä¼šï¼Œæ‰§è¡Œå®Œäº†`wait(space)`ï¼Œæ­¤æ—¶ï¼Œå¦ä¸€ä¸ª`consumer`çº¿ç¨‹è·å¾—è¿è¡Œæœºä¼šï¼Œæ‰§è¡Œäº†`wait(mutex)`ï¼Œå¦‚æœæ­¤æ—¶ç¼“å†²åŒºä¸ºç©ºï¼Œé‚£ä¹ˆ`consumer`å°†ä¼šé˜»å¡åœ¨`wait(items)`ï¼Œè€Œ`producer`ä¹Ÿä¼šå› ä¸ºæ— æ³•è·å¾—é”çš„æ‰€æœ‰æƒæ‰€ä»¥é˜»å¡åœ¨`wait(mutex)`ï¼Œè¿™æ ·ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨é˜»å¡ï¼Œä¹Ÿå°±é€ æˆäº†æ­»é”ã€‚\n\n## 3.2.2 å“²å­¦å®¶è¿›é¤é—®é¢˜\n\n### 1. é—®é¢˜æè¿°\næœ‰äº”ä½å“²å­¦å®¶å…±ç”¨ä¸€å¼ åœ†æ¡Œï¼Œåˆ†åˆ«ååœ¨å‘¨å›´çš„äº”å¼ æ¤…å­ä¸Šï¼Œåœ¨åœ†æ¡Œä¸Šæœ‰äº”ä¸ªç¢—å’Œäº”æ”¯ç­·å­ã€‚ä»–ä»¬çš„ç”Ÿæ´»çš„æ–¹å¼æ˜¯äº¤æ›¿çš„è¿›è¡Œæ€è€ƒå’Œè¿›é¤ï¼šå¹³æ—¶ï¼Œä¸€ä¸ªå“²å­¦å®¶è¿›è¡Œæ€è€ƒï¼Œé¥¥é¥¿æ—¶ä¾¿è§†å›¾å–å…¶å·¦å³ç¦»ä»–æœ€è¿‘çš„ç­·å­ï¼Œåªæœ‰åœ¨ä»–æ‹¿åˆ°ä¸¤åªç­·å­æ—¶æ‰èƒ½è¿›é¤ï¼Œè¿›é¤å®Œæ¯•ï¼Œæ”¾ä¸‹ç­·å­ç»§ç»­æ€è€ƒã€‚\n\n### 2. é—®é¢˜åˆ†æ\n- åªæœ‰æ‹¿åˆ°ä¸¤åªç­·å­æ—¶ï¼Œå“²å­¦å®¶æ‰èƒ½åƒé¥­ã€‚\n- å¦‚æœç­·å­å·²è¢«åˆ«äººæ‹¿èµ°ï¼Œåˆ™å¿…é¡»ç­‰åˆ«äººåƒå®Œä¹‹åæ‰èƒ½æ‹¿åˆ°ç­·å­ã€‚\n- ä»»ä¸€å“²å­¦å®¶åœ¨è‡ªå·±æœªæ‹¿åˆ°ä¸¤åªç­·å­åƒå®Œé¥­å‰ï¼Œä¸ä¼šæ”¾ä¸‹æ‰‹ä¸­å·²ç»æ‹¿åˆ°çš„ç­·å­\n\n### 3. ä¼ªä»£ç \nè‡³å¤šåªå…è®¸å››ä¸ªå“²å­¦å®¶åŒæ—¶è¿›é¤ï¼Œä»¥ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªå“²å­¦å®¶èƒ½å¤Ÿè¿›é¤ï¼Œæœ€ç»ˆæ€»ä¼šé‡Šæ”¾å‡ºä»–æ‰€ä½¿ç”¨è¿‡çš„ä¸¤æ”¯ç­·å­ï¼Œä»è€Œå¯ä½¿æ›´å¤šçš„å“²å­¦å®¶è¿›é¤ã€‚å®šä¹‰ä¿¡å·é‡countï¼Œåªå…è®¸4ä¸ªå“²å­¦å®¶åŒæ—¶è¿›é¤ï¼Œè¿™æ ·å°±èƒ½ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªå“²å­¦å®¶å¯ä»¥å°±é¤ã€‚\n ```c\nsemaphore chopstick[5]={1,1,1,1,1};\nsemaphore count=4; // è®¾ç½®ä¸€ä¸ªcountï¼Œæœ€å¤šæœ‰å››ä¸ªå“²å­¦å®¶å¯ä»¥è¿›æ¥\nvoid philosopher(int i)\n{\n\twhile(true)\n\t{\n\t\tthink();\n\t\twait(count); //è¯·æ±‚è¿›å…¥æˆ¿é—´è¿›é¤ å½“countä¸º0æ—¶ ä¸èƒ½å…è®¸å“²å­¦å®¶å†è¿›æ¥äº†\n\t\twait(chopstick[i]); //è¯·æ±‚å·¦æ‰‹è¾¹çš„ç­·å­\n\t\twait(chopstick[(i+1)%5]); //è¯·æ±‚å³æ‰‹è¾¹çš„ç­·å­\n\t\teat();\n\t\tsignal(chopstick[i]); //é‡Šæ”¾å·¦æ‰‹è¾¹çš„ç­·å­\n\t\tsignal(chopstick[(i+1)%5]); //é‡Šæ”¾å³æ‰‹è¾¹çš„ç­·å­\n\t\tsignal(count); //ç¦»å¼€é¥­æ¡Œé‡Šæ”¾ä¿¡å·é‡\n\t}\n}\n ```\n \n## 3.2.3 è¯»è€…-å†™è€…é—®é¢˜\n### 1. é—®é¢˜æè¿°\nä¸€ä¸ªæ•°æ®æ–‡ä»¶æˆ–è®°å½•å¯è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Œæˆ‘ä»¬æŠŠåªè¦æ±‚è¯»è¯¥æ–‡ä»¶çš„è¿›ç¨‹ç§°ä¸ºâ€œReaderè¿›ç¨‹â€ï¼Œå…¶å®ƒè¿›ç¨‹åˆ™ç§°ä¸ºâ€œWriterè¿›ç¨‹â€ã€‚å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå› ä¸ºè¯»æ“ä½œä¸ä¼šä½¿æ•°æ®æ–‡ä»¶æ··ä¹±ã€‚ä½†ä¸å…è®¸ä¸€ä¸ªWriterè¿›ç¨‹å’Œå…¶å®ƒReaderè¿›ç¨‹æˆ–Writerè¿›ç¨‹åŒæ—¶è®¿é—®å…±äº«å¯¹è±¡ï¼Œè¿™æ ·å¾ˆæœ‰å¯èƒ½é€ æˆå…±äº«æ•°æ®æ··ä¹±ã€‚\n### 2. é—®é¢˜åˆ†æ\n- å…è®¸å¤šä¸ªReaderè¿›ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªå…±äº«å¯¹è±¡\n- ä¸å…è®¸Writerè¿›ç¨‹å’Œå…¶å®ƒè¿›ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªå…±äº«å¯¹è±¡\n\n### 3. ä¼ªä»£ç \n```c\nsemaphore rmutex = 1,wmutex = 1;\nint readcount = 0;\nvoid reader(){\n\tdo{\n\t\twait(rmutex);\n\t\tif(readcount==0) wait(wmutex);\n\t\treadcount++;\n\t\tsignal(rmutex);\n\t\tÂ·Â·Â·\n\t\tperform read operation;\n\t\tÂ·Â·Â·\n\t\twaitï¼ˆrmutexï¼‰ï¼›\n\t\tif(readcount==0) signal(wmutex);\n\t\treadcount--;\n\t\tsignal(rmutex);\n\t}while(TRUE);\n}\n\nvoid writer(){\n\tdo{\n\t\twait(wmutex);\n\t\tperfrom write operation;\n\t\tsignal(wmutex); \n\t}while(TRUE);\n}\n```","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"Androidç½‘ç»œè¯·æ±‚3--è§£æOkHttpæºç ","url":"/posts/151ac78a.html","content":"# 1. OkHttpç®€ä»‹\n`okhttp`æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“ï¼Œç”¨äºandroidä¸­è¯·æ±‚ç½‘ç»œã€‚\n\nè¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®,æ˜¯å®‰å“ç«¯æœ€ç«çƒ­çš„è½»é‡çº§æ¡†æ¶,ç”±ç§»åŠ¨æ”¯ä»˜Squareå…¬å¸è´¡çŒ®ã€‚ç”¨äºæ›¿ä»£å› ç§»é™¤äº†`HttpClient`è€Œå¯¼è‡´æ²¡ç”¨çš„`Volley`ã€‚\n\nç›®å‰æ›´å¤šäººé€‰æ‹©äº†`Retrofit`ã€‚\n<!-- More -->\n\n# 2. æºç è§£æ\n>æœ¬æ–‡å¯¹OkHttpçš„æ¢è®¨å…¨éƒ¨åŸºäºç›®å‰çš„æœ€æ–°ç‰ˆOkHttp:4.0.1ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬ä½œè€…å·²ç»ä½¿ç”¨kotlinå¯¹æºç è¿›è¡Œäº†é‡å†™ï¼Œæ‰€ä»¥æœ‰äº›å°ä¼™ä¼´å¯èƒ½é˜…è¯»ç¨å¾®æœ‰ç‚¹é—®é¢˜ï¼Œä½†æ˜¯åˆ«æ‹…å¿ƒï¼Œæœ¬æ–‡ä¸­æ‰€æ¶‰åŠçš„æºç é˜…è¯»èµ·æ¥åŸºæœ¬ä¸Šå’ŒJavaä¸€æ ·ï¼Œæ‰€ä»¥è¯·ä¸ä¼škotlinçš„å°ä¼™ä¼´è¿˜æ˜¯è€å¿ƒçœ‹ä¸‹å»ï¼Œä¸å¤ªæ‡‚çš„è¯­æ³•å°±ç™¾åº¦ä¸‹ï¼ŒåŒæ—¶æˆ‘ä¹Ÿä¼šå¯¹æŸäº›è¯­æ³•ä½œæ³¨é‡Š\n\n## 2.1 OkHttpè¯·æ±‚æµç¨‹\n### 2.1.1 ä»è¯·æ±‚å¤„ç†å¼€å§‹åˆ†æ\næˆ‘ä»¬æ— è®ºåœ¨ä½¿ç”¨`OkHttp`è¿›è¡Œä»€ä¹ˆè¯·æ±‚çš„æ—¶å€™éƒ½ä¼šåˆ›å»º`OkHttpClient`å¯¹è±¡å¹¶è°ƒç”¨ä»–çš„`newCall()`æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±ä»è¿™ä¸ªæ–¹æ³•çœ‹èµ·ï¼š\n\n```kotlin\noverride fun newCall(request: Request): Call {\nreturn RealCall.newRealCall(this, request, forWebSocket = false)\n}\n```\nå¯ä»¥çœ‹åˆ°è¿”å›äº†ä¸€ä¸ª`RealCall`å¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä½¿ç”¨`OkHttpClient`å¯¹è±¡è°ƒç”¨çš„`execute()`æ“ä½œå®é™…ä¸Šæ˜¯`RealCall`çš„`execute()`æ“ä½œï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹`RealCall`çš„`execute()`æ–¹æ³•ï¼š\n```kotlin\noverride fun execute(): Response {\n    // æ·»åŠ åŒæ­¥é”\n    synchronized(this) {\n        // check()æ˜¯kotlinç‰¹æœ‰çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä»–æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªifï¼Œ\n        // ä½†æ˜¯å½“ä»–çš„åˆ¤æ–­è¯­å¥æ˜¯falseçš„è¯ï¼Œ\n        // ä»–å°±ä¼šæŠ›å‡ºä¸€ä¸ªIllegalStateExceptionå¼‚å¸¸ï¼Œå¼‚å¸¸çš„å†…å®¹å°±æ˜¯åé¢çš„è¯­å¥\n        check(!executed) { \"Already Executed\" }\n        executed = true\n        // executedæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä»–çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡äº†ï¼Œ\n        // å¦‚æœæ‰§è¡Œè¿‡äº†è¿˜æ‰§è¡Œäº†è¿™ä¸ªæ–¹æ³•çš„è¯å°±æŠ›å¼‚å¸¸\n    }\n    // transmitterç”¨äºè¿æ¥OKHTTPçš„åº”ç”¨ç¨‹åºå’Œç½‘ç»œå±‚ï¼Œä¸ç”¨å¤šç®¡\n    transmitter.timeoutEnter()\n    transmitter.callStart()\n    try {\n        client.dispatcher.executed(this)\n        return getResponseWithInterceptorChain()\n    } finally {\n        client.dispatcher.finished(this)\n    }\n}\n```\nè¿™å—åˆè°ƒç”¨äº†`client.dispatcher`ï¼Œç„¶åæ‰¾å›å»æ‰¾åˆ°`OkHttpClient`çš„`dispatcher`å¯¹è±¡ï¼Œå‘ç°ä»–å°±æ˜¯`Dispatcher`ç±»çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæ¥ç€æˆ‘ä»¬ç»§ç»­çœ‹`Dispatcher`ç±»ã€‚\n\n### 2.1.2 Dispatcherä»»åŠ¡è°ƒåº¦\nè¿›å…¥`Dispatcher`ç±»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æˆå‘˜å˜é‡å®šä¹‰:\n>æ³¨ï¼škotlinä¸­ä¸€ä¸ªæˆå‘˜å˜é‡çš„@getå’Œ@setåˆ†åˆ«å¯¹åº”äº†Javaä¸­getå’Œsetæ–¹æ³•ï¼Œæ‰€ä»¥è¿™å—æˆ‘æ²¡æœ‰å®Œå®Œå…¨å…¨å¤åˆ¶ç²˜è´´åˆ°è¿™ï¼Œæˆ‘åªå–äº†å®šä¹‰éƒ¨åˆ†\n\n```kotlin\n// æœ€å¤§å¹¶å‘è¯·æ±‚æ•°\nvar maxRequests = 64\n// æ¯ä¸ªä¸»æœºçš„æœ€å¤§è¯·æ±‚æ•°\nvar maxRequestsPerHost = 5\n// æ¶ˆè´¹è€…çº¿ç¨‹\nval executorService: ExecutorService\n// å°†è¦è¿è¡Œçš„å¼‚æ­¥è¯·æ±‚é˜Ÿåˆ—\nprivate val readyAsyncCalls = ArrayDeque<AsyncCall>()\n// æ­£åœ¨è¿è¡Œçš„å¼‚æ­¥è¯·æ±‚é˜Ÿé˜Ÿåˆ—\nprivate val runningAsyncCalls = ArrayDeque<AsyncCall>()\n// æ­£åœ¨è¿è¡Œçš„åŒæ­¥è¯·æ±‚é˜Ÿåˆ—\nprivate val runningSyncCalls = ArrayDeque<RealCall>()\n```\n\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹`Dispatcher`çš„æ„é€ æ–¹æ³•\n```kotlin\n// ä¸»æ„é€ æ–¹æ³•ï¼Œæ²¡å†™å…·ä½“å®ç°\nclass Dispatcher constructor() {} \n\nconstructor(executorService: ExecutorService) : this() {\n    this.executorServiceOrNull = executorService\n}\n```\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–å°†ä¼ è¿›æ¥çš„`executorService`ä¼ ç»™äº†`executorServiceOrNull`ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹`executorServiceOrNull`çš„å®šä¹‰ï¼š\n```kotlin\n// executorServiceOrNullè¿™ä¸ªåº”è¯¥æ˜¯å› ä¸ºkotlinçš„ç©ºå®‰å…¨æ£€æŸ¥ç‰¹æ€§è€Œå®šä¹‰çš„ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯executorService\nprivate var executorServiceOrNull: ExecutorService? = null\n\n@get:Synchronized\n@get:JvmName(\"executorService\") val executorService: ExecutorService\n    get() {\n        if (executorServiceOrNull == null) {\n            executorServiceOrNull = ThreadPoolExecutor(0, Int.MAX_VALUE, 60, TimeUnit.SECONDS,\n                SynchronousQueue(), threadFactory(\"OkHttp Dispatcher\", false))\n        }\n        return executorServiceOrNull!!\n    }\n```\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°`executorService`çš„`set`æ–¹æ³•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ã€‚å†ç»“åˆä»–æœ‰ä¸¤ä¸ªæ„é€ å™¨å°±çŸ¥é“ï¼šå¦‚æœæ²¡æœ‰ç»™`Dispatcher`ä¼ å…¥ä¸€ä¸ªçº¿ç¨‹æ± ä»–å°±ä¼šè‡ªå·±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚è¿™ä¸ªçº¿ç¨‹æ± é€‚åˆæ‰§è¡Œå¤§é‡ä¸”è€—æ—¶è¾ƒå°‘çš„ä»»åŠ¡ã€‚\n\næ„é€ å™¨æˆ‘ä»¬çœ‹å®Œäº†ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä»–çš„`enqueue()`æ–¹æ³•ï¼š\n```kotlin\ninternal fun enqueue(call: AsyncCall) {\n    synchronized(this) {\n        readyAsyncCalls.add(call)\n\n        // Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to\n        // the same host.\n        if (!call.get().forWebSocket) {\n            val existingCall = findExistingCallWithHost(call.host())\n            if (existingCall != null)call.reuseCallsPerHostFrom(existingCall)\n        }\n    }\n    promoteAndExecute()\n}\n```\næ¥ä¸€ä¸ªè¯·æ±‚å°±æŠŠä»–æ·»åŠ åˆ°å°±ç»ªè¯·æ±‚é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå°±æ¥åˆ¤æ–­`forWebSocket`è¿™ä¸ªå±æ€§ã€‚çœ‹åˆ°è¿™ä¸ªå±æ€§æˆ‘è¿˜è¿·äº†ä¸‹ï¼Œæœ‰ç‚¹æä¸æ‡‚å¥¹æ˜¯å¹²å˜›çš„ï¼Œç„¶åç»è¿‡æˆ‘çš„ä¸€ç•ªæœç´¢åï¼Œå‘ç°åŸæ¥`OkHttp`è¿˜å¯ä»¥è¿›è¡Œ`WebSocket`é€šä¿¡ï¼Œè€Œè¿™ä¸ªå±æ€§å°±æ˜¯ä¸º`WebSocket`é€šä¿¡å‡†å¤‡çš„ã€‚äºæ˜¯æˆ‘å°±åˆ°`RealCall`é‡Œé¢æ‰¾åœ¨å“ªå„¿å®šä¹‰äº†è¿™ä¸ªå±æ€§äº†ï¼Œç„¶åæˆ‘å°±å‘ç°äº†åœ¨`RealCall`çš„`newRealCall()`æ–¹æ³•è¿™å—ï¼Œè¿™ä¸ªæ–¹æ³•ä¼ å…¥çš„å‚æ•°ä¸­æœ‰ä¸€ä¸ª`Boolean`å€¼åå­—å°±å«`forWebSocket`ã€‚\n```kotlin\ncompanion object {\n    fun newRealCall(\n        client: OkHttpClient,\n        originalRequest: Request,\n        forWebSocket: Boolean\n    ): RealCall {\n        // Safely publish the Call instance to the EventListener.\n        return RealCall(client, originalRequest, forWebSocket).apply {\n            transmitter = Transmitter(client, this)\n        }\n    }\n}\n```\nä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰å°è±¡ï¼Œå’±ä»¬åœ¨ä¸Šé¢è¯´è¿‡ï¼Œæ‰§è¡Œ`OkHttpClient.newCall()`æ–¹æ³•å®é™…ä¸Šæ˜¯è¿”å›äº†ä¸€ä¸ª`RealCall`å¯¹è±¡ï¼Œäºæ˜¯åœ¨é‚£æ‰¾åˆ°äº†è¿™ä¸ªçš„ç­”æ¡ˆï¼Œ`forWebSocket=false`\næ‰€ä»¥è¯´è¿™ä¸ª`if`å’±ä»¬ä¸ç”¨ç®¡ï¼Œç›´æ¥çœ‹`promoteAndExecute()`æ–¹æ³•ï¼š\n```kotlin\nprivate fun promoteAndExecute(): Boolean {\n    // ä¸çŸ¥é“å¤§å®¶è¿˜è®°ä¸è®°å¾—å’±ä»¬ä¹‹å‰è¯´çš„kotliné‡Œé¢çš„check()è¯­æ³•ï¼Œ\n    // è¿™ä¸ªå’Œcheckä¹Ÿä¸€æ ·ï¼Œåªä¸è¿‡æŠ›å‡ºçš„æ˜¯AssertionErrorå¼‚å¸¸\n    assert(!Thread.holdsLock(this))\n\n    // mutableListOfæ˜¯kotliné‡Œé¢çš„å¯å˜listé›†åˆ\n    val executableCalls = mutableListOf<AsyncCall>()\n    val isRunning: Boolean\n    synchronized(this) {\n        val i = readyAsyncCalls.iterator()\n            while (i.hasNext()) {\n                val asyncCall = i.next()\n\n                if (runningAsyncCalls.size >= this.maxRequests) break // æœ€å¤§å®¹é‡\n                if (asyncCall.callsPerHost().get() >= this.maxRequestsPerHost) continue // ä¸»æœºæœ€å¤§å®¹é‡\n\n                i.remove()\n                asyncCall.callsPerHost().incrementAndGet()\n                executableCalls.add(asyncCall)\n                runningAsyncCalls.add(asyncCall)\n            }\n        isRunning = runningCallsCount() > 0\n    }\n\n    for (i in 0 until executableCalls.size) {\n        val asyncCall = executableCalls[i]\n        asyncCall.executeOn(executorService)\n    }\n\n    return isRunning\n}\n```\né¦–å…ˆå°†å·²å°±ç»ªé˜Ÿåˆ—éå†ä¸€éï¼Œåˆ¤æ–­æ­£åœ¨è¿è¡Œçš„æ•°é‡æ˜¯ä¸æ˜¯å¤§äºå®šä¹‰çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œå¦‚æœå¤§äºçš„è¯ç›´æ¥é€€å‡ºå¾ªç¯ï¼›å¦‚æœä¸å¤§äºåˆ™åœ¨åˆ¤æ–­è¿™ä¸ªè¯·æ±‚çš„ä¸»æœºè¯·æ±‚æ•°æ˜¯ä¸æ˜¯å¤§äºå®šä¹‰çš„æ¯ä¸ªä¸»æœºæœ€å¤§è¯·æ±‚æ•°ï¼Œå¦‚æœå¤§äºå°±è·³è¿‡è¿™ä¸ªè¯·æ±‚æ¢ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼›ä¸å¤§äºå°±æŠŠå®ƒè°ƒå…¥æ­£åœ¨è¿è¡Œçš„è¯·æ±‚é˜Ÿåˆ—é‡Œé¢ï¼Œç›´åˆ°éå†å®Œæˆã€‚ç„¶ååˆ¤æ–­è¿˜æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚ï¼Œå¦‚æœæœ‰å°±`isRunning`ç½®`true`ã€‚æ¥ç€å†å–å‡º`executableCalls`é‡Œçš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åæ‰§è¡Œ`executteOn()`æ–¹æ³•ã€‚æˆ‘ä»¬ç»§ç»­æ¥çœ‹`AsyncCall`çš„`executeOn()`æ–¹æ³•ï¼š\n```kotlin\nfun executeOn(executorService: ExecutorService) {\n    assert(!Thread.holdsLock(client.dispatcher))\n    var success = false\n    try {\n        executorService.execute(this)\n        success = true\n    } catch (e: RejectedExecutionException) {\n        val ioException = InterruptedIOException(\"executor rejected\")\n        ioException.initCause(e)\n        transmitter.noMoreExchanges(ioException)\n        responseCallback.onFailure(this@RealCall, ioException)\n    } finally {\n        if (!success) {\n            client.dispatcher.finished(this) // This call is no longer running!\n        }\n    }\n}\n```\nè¿™æ®µä»£ç å°±æ˜¯åœ¨æ‰§è¡Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œå¦‚æœæˆåŠŸæ‰§è¡Œå°±å°†`success`ç½®`true`ï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™æŠ›å¼‚å¸¸å¹¶è¿”å›ç»™`responseCallback`çš„`onFailure()`æ–¹æ³•ã€‚å¹¶ä¸”å¦‚æœæ²¡æœ‰æˆåŠŸæ‰§è¡Œä¹Ÿå°±æ˜¯`success`ä¸º`false`ï¼Œé‚£ä¹ˆåœ¨`finally`ä¸­å°±ä¼šæ‰§è¡Œ`client.dispatcher.finished()`æ–¹æ³•:\n```kotlin\ninternal fun finished(call: AsyncCall) {\n    call.callsPerHost().decrementAndGet()\n    finished(runningAsyncCalls, call)\n  }\n```\nè¿™ä¸ªæ–¹æ³•å…ˆå°†ä¼ å…¥çš„`AsyncCall`çš„`callsPerHost`ç»™å‡1ï¼Œç„¶åå†è°ƒç”¨äº†`finished()`æ–¹æ³•ï¼Œæˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ª`finished()`æ–¹æ³•ï¼š\n\n```kotlin\nprivate fun <T> finished(calls: Deque<T>, call: T) {\n    val idleCallback: Runnable?\n    synchronized(this) {\n        if (!calls.remove(call)) throw AssertionError(\"Call wasn't in-flight!\")\n        idleCallback = this.idleCallback\n    }\n\n    val isRunning = promoteAndExecute()\n\n    if (!isRunning && idleCallback != null) {\n        idleCallback.run()\n    }\n}\n```\nä»–è®²æ­¤æ¬¡è¯·æ±‚ä»`runningAsyncCalls`ä¸­ç§»é™¤ï¼Œç„¶åæ‰§è¡Œäº†`promoteAndExecute()`æ–¹æ³•ï¼Œå’±ä»¬åœ¨ä¸Šé¢è¯´è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä»–çš„è¿”å›å€¼å°±æ˜¯åˆ¤æ–­å½“å‰è¿™ä¸ªè¿è¡Œé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è¯·æ±‚ï¼Œå¦‚æœè¿˜æœ‰å°±è¿”å›`true`ï¼Œæ²¡æœ‰å°±`false`ã€‚æ¥ç€ä¸€ä¸ª`if`ï¼Œåˆ¤æ–­`isRunning`å’Œ`idleCallback`çš„ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰è¿™ä¸ªè¯·æ±‚è¿˜æ²¡æœ‰æ‰§è¡Œçš„è¯ï¼Œå°±è°ƒç”¨`run()`æ–¹æ³•æ‰§è¡Œå½“å‰è¯·æ±‚ã€‚è¿™æ ·æ¯ä¸ªè¯·æ±‚éƒ½æ‰§è¡Œå®Œæ¯•äº†ã€‚\né‚£æˆ‘ä»¬å†æ¥çœ‹çœ‹ä»–çš„`run()`æ–¹æ³•ï¼š\n```kotlin\noverride fun run() {\n      threadName(\"OkHttp ${redactedUrl()}\") {\n            var signalledCallback = false\n            transmitter.timeoutEnter()\n            try {\n                val response = getResponseWithInterceptorChain()\n                signalledCallback = true\n                responseCallback.onResponse(this@RealCall, response)\n            } catch (e: IOException) {\n                if (signalledCallback) {\n                    // Do not signal the callback twice!\n                    Platform.get().log(INFO, \"Callback failure for ${toLoggableString()}\", e)\n                } else {\n                    responseCallback.onFailure(this@RealCall, e)\n                }\n            } finally {\n                client.dispatcher.finished(this)\n            }\n      }\n}\n```\nè¿™å—è°ƒç”¨äº†ä¸€ä¸ª`getResponseWithInterceptorChain()`æ–¹æ³•ï¼Œå¹¶è¿”å›äº†`response`ï¼Œå¹¶å°†å®ƒè¿”å›ç»™äº†`responseCallback.onResponse()`æ–¹æ³•ã€‚å¦‚æœå¤±è´¥äº†å°±å°†ç»“æœè¿”å›ç»™`responseCallback.onFailure()`æ–¹æ³•ã€‚æœ€åè°ƒç”¨`client.dispatcher.finished()`æ–¹æ³•ã€‚\n\n### 2.1.3 Interceptoræ‹¦æˆªå™¨\n#### 2.1.3.1 getResponseWithInterceptorChain()æ–¹æ³•\né¦–å…ˆæˆ‘ä»¬çœ‹çœ‹`getResponseWithInterceptorChain()`æ–¹æ³•ï¼š\n```kotlin\n@Throws(IOException::class)\nfun getResponseWithInterceptorChain(): Response {\n    // Build a full stack of interceptors.\n    val interceptors = mutableListOf<Interceptor>()\n    interceptors += client.interceptors\n    interceptors += RetryAndFollowUpInterceptor(client)\n    interceptors += BridgeInterceptor(client.cookieJar)\n    interceptors += CacheInterceptor(client.cache)\n    interceptors += ConnectInterceptor\n    if (!forWebSocket) {\n        interceptors += client.networkInterceptors\n    }\n    interceptors += CallServerInterceptor(forWebSocket)\n\n    val chain = RealInterceptorChain(interceptors, transmitter, null, 0, originalRequest, this,\n        client.connectTimeoutMillis, client.readTimeoutMillis, client.writeTimeoutMillis)\n\n    var calledNoMoreExchanges = false\n    try {\n        val response = chain.proceed(originalRequest)\n        if (transmitter.isCanceled) {\n            response.closeQuietly()\n            throw IOException(\"Canceled\")\n        }\n        return response\n    } catch (e: IOException) {\n        calledNoMoreExchanges = true\n        throw transmitter.noMoreExchanges(e) as Throwable\n    } finally {\n        if (!calledNoMoreExchanges) {\n            transmitter.noMoreExchanges(null)\n        }\n    }\n}\n```\né¦–å…ˆå°±åˆ›å»ºäº†ä¸€å¤§å †çš„è¿æ¥å™¨å¹¶æ·»åŠ åˆ°`interceptors`é›†åˆä¸­ã€‚ç„¶ååˆ›å»ºäº†ä¸€ä¸ª`RealInterceptorChain`å¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†ä»–çš„`proceed()`æ–¹æ³•ï¼Œæ¥ç€ä¸»è¦ç›®çš„å°±æ˜¯è®²`proceed()`è¿”å›çš„`response`ç»™è¿”å›å»ã€‚\né‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹`RealInterceptorChain`çš„`proceed()`æ–¹æ³•ï¼š\n\n```kotlin\noverride fun proceed(request: Request): Response {\n    return proceed(request, transmitter, exchange)\n}\n  \n@Throws(IOException::class)\nfun proceed(request: Request, transmitter: Transmitter, exchange: Exchange?): Response {\n    if (index >= interceptors.size) throw AssertionError()\n\n    calls++\n\n    // If we already have a stream, confirm that the incoming request will use it.\n    check(this.exchange == null || this.exchange.connection()!!.supportsUrl(request.url)) {\n        \"network interceptor ${interceptors[index - 1]} must retain the same host and port\"\n    }\n\n    // If we already have a stream, confirm that this is the only call to chain.proceed().\n    check(this.exchange == null || calls <= 1) {\n        \"network interceptor ${interceptors[index - 1]} must call proceed() exactly once\"\n    }\n\n    // Call the next interceptor in the chain.\n    val next = RealInterceptorChain(interceptors, transmitter, exchange,\n        index + 1, request, call, connectTimeout, readTimeout, writeTimeout)\n    val interceptor = interceptors[index]\n\n    @Suppress(\"USELESS_ELVIS\")\n    val response = interceptor.intercept(next) ?: throw NullPointerException(\n        \"interceptor $interceptor returned null\")\n\n    // Confirm that the next interceptor made its required call to chain.proceed().\n    check(exchange == null || index + 1 >= interceptors.size || next.calls == 1) {\n        \"network interceptor $interceptor must call proceed() exactly once\"\n    }\n\n    check(response.body != null) { \"interceptor $interceptor returned a response with no body\" }\n\n    return response\n  }\n```\né¦–å…ˆå°±æ˜¯ä¸€ä¸ª`index`ï¼Œ`index`æ˜¯`RealInterceptorChain`æ„é€ å™¨ä¸­ä¼ å…¥çš„å‚æ•°ï¼Œå¥¹æ˜¯ç¬¬å››ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹`getResponseWithInterceptorChain()`æ–¹æ³•ä¸­åˆ›å»º`RealInterceptorChain`å¯¹è±¡æ—¶æ„é€ å™¨çš„ç¬¬å››ä¸ªä¼ å…¥çš„å€¼ä¸º0ã€‚ç„¶ååˆ¤æ–­`index`çš„å€¼æ˜¯ä¸æ˜¯å¤§äº`interceptors`çš„å¤§å°ï¼Œå¦‚æœå¤§äºå°±æŠ›å¼‚å¸¸ï¼Œå¦åˆ™å°±ç»§ç»­ä¸€é¡¿æ£€æŸ¥ï¼ï¼ï¼ç„¶åå†åˆ›å»º`RealInterceptorChain`å¯¹è±¡ï¼Œæ­¤æ—¶åˆ›å»ºçš„å¯¹è±¡ä¼ å…¥çš„`index`ä¸ºæ­¤æ—¶çš„`index+1`ï¼Œç„¶åå†è°ƒç”¨`interceptor`çš„`intercept()`æ–¹æ³•ï¼Œå¹¶è¿”å›`response`ã€‚\n`interceptor`çš„`intercept()`ä½œç”¨æ˜¯å½“å­˜åœ¨å¤šä¸ªæ‹¦æˆªå™¨æ—¶éƒ½ä¼šåœ¨ä¸Šé¢ä»£ç æ³¨é‡Š1å¤„é˜»å¡ï¼Œå¹¶ç­‰å¾…ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„è°ƒç”¨è¿”å›ã€‚\n\n#### 2.1.3.2 Interceptoræºç \né‚£ç°åœ¨æˆ‘ä»¬å†æ¥è®²å‡ ä¸ªé‡è¦çš„æ‹¦æˆªå™¨å§ã€‚\n`OkHttp`ä¸­`Interceptor`çš„å®ç°ç±»æœ‰ï¼š\n1. `ConnectInterceptor`ï¼šè¿æ¥æ‹¦æˆªå™¨ã€‚ \n2. `CallServerInterceptor`ï¼šè¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨ \n3. `CacheInterceptor`ï¼šç¼“å­˜æ‹¦æˆªå™¨ \n4. `BridgeInterceptor`ï¼šæ¡¥æ¢æ‹¦æˆªå™¨ã€‚ \n\nå…¶ä¸­è¾ƒä¸ºé‡è¦çš„å°±æ˜¯`ConnectInterceptor`å’Œ`CallServerInterceptor`ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªã€‚\n\n##### 2.1.3.2.1 ConnectInterceptor\nè¿™ä¸ªç±»ä¸»è¦ç”¨æ¥å®ç°ç½‘ç»œè¯·æ±‚è¿æ¥ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ä»–çš„`intercept`æ–¹æ³•ï¼š\n```kotlin\n@Throws(IOException::class)\noverride fun intercept(chain: Interceptor.Chain): Response {\n    val realChain = chain as RealInterceptorChain\n    val request = realChain.request()\n    val transmitter = realChain.transmitter()\n\n    // We need the network to satisfy this request. Possibly for validating a conditional GET.\n    val doExtensiveHealthChecks = request.method != \"GET\"\n    val exchange = transmitter.newExchange(chain, doExtensiveHealthChecks)\n\n    return realChain.proceed(request, transmitter, exchange)\n}\n```\nè¿™ä¸ªæ–¹æ³•å…ˆå°†ä¼ å…¥çš„`chain`å¯¹è±¡é€ å‹æˆäº†`RealInterceptorChain`çš„å¯¹è±¡ï¼Œè¿™ä¸ªç±»æˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œç„¶åè°ƒç”¨ä»–çš„`response()`å’Œ`transmitter()`æ–¹æ³•ï¼Œåˆ†åˆ«å¾—åˆ°å½“å‰`chain`çš„`response`å’Œ`transmitter`ã€‚ç„¶åæ‰§è¡Œäº†`request`çš„`method()`æ–¹æ³•ï¼Œåˆ¤æ–­`request`çš„ç±»å‹æ˜¯ä¸æ˜¯`GET`ï¼Œå¦‚æœæ˜¯`doExtensiveHealthChecks`å°±ä¸º`false`ï¼Œå¦åˆ™ä¸º`true`ï¼Œæ¥ç€æŠŠ`doExtensiveHealthChecks`ä¼ å…¥`transmitterçš„newExchange()`æ–¹æ³•ä¸­å»ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç­‰ä¼šå†è¯´ï¼Œç„¶åå†è°ƒç”¨äº†`proceed()`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨ä¸Šé¢è¯´è¿‡ã€‚\n\n##### 2.1.3.2.2 CallServerInterceptor\nè¿™ä¸ªç±»æ˜¯ç½‘ç»œè¯·æ±‚çš„æœ¬è´¨ã€‚å®ƒçš„`intercept`æ–¹æ³•æºç å¦‚ä¸‹ï¼š\n```kotlin\n@Throws(IOException::class)\n  override fun intercept(chain: Interceptor.Chain): Response {\n    val realChain = chain as RealInterceptorChain\n    val exchange = realChain.exchange()\n    val request = realChain.request()\n    val requestBody = request.body\n    val sentRequestMillis = System.currentTimeMillis()\n\n    // å†™å…¥è¯·æ±‚å¤´\n    exchange.writeRequestHeaders(request)\n\n    var responseHeadersStarted = false\n    var responseBuilder: Response.Builder? = null\n    // å†™å…¥è¯·æ±‚ä½“ä¿¡æ¯\n    if (HttpMethod.permitsRequestBody(request.method) && requestBody != null) {\n        // å¦‚æœè¯·æ±‚ä¸Šæœ‰â€œexpect:100 continueâ€å¤´\n        // è¯·ç­‰å¾…â€œhttp/1.1 100 continueâ€å“åº”ï¼Œç„¶åå†ä¼ è¾“è¯·æ±‚ä¸»ä½“.\n        // å¦‚æœæˆ‘ä»¬æ²¡æœ‰å¾—åˆ°ï¼Œè¿”å›æˆ‘ä»¬å¾—åˆ°çš„ï¼ˆä¾‹å¦‚4xxå“åº”ï¼‰ï¼Œè€Œä¸ä¼ è¾“è¯·æ±‚ä½“ã€‚\n        if (\"100-continue\".equals(request.header(\"Expect\"), ignoreCase = true)) {\n            exchange.flushRequest()\n            responseHeadersStarted = true\n            exchange.responseHeadersStart()\n            responseBuilder = exchange.readResponseHeaders(true)\n        }\n        if (responseBuilder == null) {\n            if (requestBody.isDuplex()) {\n                // å‡†å¤‡ä¸€ä¸ªåŒå·¥ä¸»ä½“ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºç¨åå¯ä»¥å‘é€è¯·æ±‚ä¸»ä½“ã€‚\n                exchange.flushRequest()\n                val bufferedRequestBody = exchange.createRequestBody(request, true).buffer()\n                requestBody.writeTo(bufferedRequestBody)\n            } else {\n                // å¦‚æœæ»¡è¶³â€œexpect:100 continueâ€é¢„æœŸï¼Œåˆ™ç¼–å†™è¯·æ±‚æ­£æ–‡ã€‚\n                val bufferedRequestBody = exchange.createRequestBody(request, false).buffer()\n                requestBody.writeTo(bufferedRequestBody)\n                bufferedRequestBody.close()\n            }\n        } else {\n            exchange.noRequestBody()\n            if (!exchange.connection()!!.isMultiplexed) {\n                // å¦‚æœä¸æ»¡è¶³â€œexpect:100 continueâ€çš„è¦æ±‚ï¼Œè¯·é˜²æ­¢é‡ç”¨HTTP/1è¿æ¥ã€‚\n                // å¦åˆ™ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰ä¹‰åŠ¡ä¼ è¾“è¯·æ±‚ä¸»ä½“ä»¥ä½¿è¿æ¥ä¿æŒä¸€è‡´çŠ¶æ€ã€‚\n                exchange.noNewExchangesOnConnection()\n            }\n        }\n    } else {\n        exchange.noRequestBody()\n    }\n\n    // ç»“æŸè¯·æ±‚\n    if (requestBody == null || !requestBody.isDuplex()) {\n        exchange.finishRequest()\n    }\n    if (!responseHeadersStarted) {\n        exchange.responseHeadersStart()\n    }\n    if (responseBuilder == null) {\n        responseBuilder = exchange.readResponseHeaders(false)!!\n    }\n    // è¯»å–å“åº”å¤´ä¿¡æ¯\n    var response = responseBuilder\n        .request(request)\n        .handshake(exchange.connection()!!.handshake())\n        .sentRequestAtMillis(sentRequestMillis)\n        .receivedResponseAtMillis(System.currentTimeMillis())\n        .build()\n    var code = response.code\n    if (code == 100) {\n        // æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ª100ç»§ç»­ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰è¯·æ±‚ã€‚\n        // å†æ¬¡å°è¯•è¯»å–å®é™…å“åº”\n        response = exchange.readResponseHeaders(false)!!\n            .request(request)\n            .handshake(exchange.connection()!!.handshake())\n            .sentRequestAtMillis(sentRequestMillis)\n            .receivedResponseAtMillis(System.currentTimeMillis())\n            .build()\n        code = response.code\n    }\n\n    exchange.responseHeadersEnd(response)\n\n    // openResponseBody è·å–å“åº”ä½“ä¿¡æ¯\n    response = if (forWebSocket && code == 101) {\n        // è¿æ¥æ­£åœ¨å‡çº§ï¼Œä½†æˆ‘ä»¬éœ€è¦ç¡®ä¿æ‹¦æˆªå™¨çœ‹åˆ°éç©ºçš„å“åº”ä¸»ä½“ã€‚\n        response.newBuilder()\n            .body(EMPTY_RESPONSE)\n            .build()\n        } else {\n            response.newBuilder()\n                .body(exchange.openResponseBody(response))\n                .build()\n        }\n        if (\"close\".equals(response.request.header(\"Connection\"), ignoreCase = true) ||\n        \"close\".equals(response.header(\"Connection\"), ignoreCase = true)) {\n            exchange.noNewExchangesOnConnection()\n        }\n        if ((code == 204 || code == 205) && response.body?.contentLength() ?: -1L > 0L) {\n            throw ProtocolException(\n                \"HTTP $code had non-zero Content-Length: ${response.body?.contentLength()}\")\n        }\n    \n    //è¿”å›ä¸€ä¸ªå“åº”\n    return response\n}\n```\nå…·ä½“è¿‡ç¨‹å¯ä»¥çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œå®ƒä¸»è¦æ˜¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ•°æ®å’Œæ¥å—æœåŠ¡å™¨è¿”å›çš„æ•°æ®ã€‚\n\n### 2.1.4 Transmiter\n`Transmitter`ç±»æ˜¯`OkHttp`çš„åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„ä¸€ä¸ªæ¡¥æ¢ç±»ã€‚\n\næˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¯¥ç±»çš„åˆå§‹åŒ–ï¼š\n```kotlin\nclass Transmitter(\n    private val client: OkHttpClient,\n    private val call: Call\n) {\n    private val connectionPool: RealConnectionPool = client.connectionPool.delegate\n    private val eventListener: EventListener = client.eventListenerFactory.create(call)\n    private val timeout = object : AsyncTimeout() {\n        override fun timedOut() {\n            cancel()\n        }\n    }.apply {\n        timeout(client.callTimeoutMillis.toLong(), MILLISECONDS)\n    }\n```\n`Transmitter`ä¸»è¦çš„ä¸€äº›æˆå‘˜å˜é‡å°±è¿™äº›ï¼Œé¦–å…ˆæ„é€ å™¨ä¸­ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª`OkHttpClient`ï¼Œä¸€ä¸ª`Call`ã€‚ç„¶ååˆåˆ›å»ºäº†ä¸€ä¸ªè¿æ¥æ± `connectionPool`ï¼Œè¿˜æœ‰ä¸€ä¸ªç›‘å¬å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰©å±•è¿™ä¸ªç±»æ¥ç›‘å¬ç¨‹åºçš„`HTTP`çš„è°ƒç”¨æ•°é‡ã€å¤§å°å’ŒæŒç»­æ—¶é—´ã€‚\n\n### 2.1.5 RealConnection\næˆ‘ä»¬å…ˆçœ‹çœ‹ä»–çš„ä¸€äº›å±æ€§ï¼š\n```kotlin\nclass RealConnection(\n    val connectionPool: RealConnectionPool,\n    private val route: Route\n) : Http2Connection.Listener(), Connection {\n\n    // ä»¥ä¸‹å­—æ®µç”±connectï¼ˆï¼‰åˆå§‹åŒ–ï¼Œä»ä¸é‡æ–°åˆ†é…ã€‚\n\n    // åº•å±‚socket\n    private var rawSocket: Socket? = null\n\n    /**\n     * åº”ç”¨å±‚å¥—æ¥å­—ã€‚å¦‚æœæ­¤è¿æ¥ä¸ä½¿ç”¨SSLï¼Œåˆ™å¯ä»¥æ˜¯[sslsocket]åˆ†å±‚åœ¨[rawsocket]ä¸Šï¼Œä¹Ÿå¯ä»¥æ˜¯[rawsocket]æœ¬èº«ã€‚\n    */\n    // åº”ç”¨å±‚socket\n    private var socket: Socket? = null\n    // æ¡æ‰‹\n    private var handshake: Handshake? = null\n    //  åè®®\n    private var protocol: Protocol? = null\n    // http2çš„è¿æ¥\n    private var http2Connection: Http2Connection? = null\n    // ä¸æœåŠ¡å™¨äº¤äº’çš„è¾“å…¥è¾“å‡ºæµ\n    private var source: BufferedSource? = null\n    private var sink: BufferedSink? = null\n\n    // è·Ÿè¸ªè¿æ¥çŠ¶æ€ä¸‹çš„å­—æ®µç”±è¿æ¥æ± ä¿æŠ¤ã€‚\n\n    /**\n     * å¦‚æœä¸ºtrueï¼Œåˆ™ä¸èƒ½åœ¨æ­¤è¿æ¥ä¸Šåˆ›å»ºæ–°çš„äº¤æ¢ã€‚ä¸€æ—¦æ˜¯trueçš„ï¼Œè¿™æ€»æ˜¯trueçš„ã€‚\n     * ç”±[ConnectionPool]ç›‘è§†ã€‚\n     */\n    var noNewExchanges = false\n\n    /**\n     * å»ºç«‹å¯èƒ½ç”±äºæ‰€é€‰è·¯ç”±è€Œå¯¼è‡´çš„æµæ—¶å‡ºç°é—®é¢˜çš„æ¬¡æ•°ã€‚ç”±[ConnectionPool]ä¿æŠ¤ã€‚\n     */\n    internal var routeFailureCount = 0\n\n    internal var successCount = 0\n    private var refusedStreamCount = 0\n\n    /**\n     * æ­¤è¿æ¥å¯ä»¥æ‰¿è½½çš„æœ€å¤§å¹¶å‘æµæ•°ã€‚\n     * å¦‚æœâ€œallocations.sizeï¼ˆï¼‰<allocationlimitâ€ï¼Œåˆ™å¯ä»¥åœ¨æ­¤è¿æ¥ä¸Šåˆ›å»ºæ–°æµã€‚     \n     */ \n    private var allocationLimit = 1\n```\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ä»–çš„`connect()`æ–¹æ³•ï¼š\n```kotlin\nfun connect(\n    connectTimeout: Int,\n    readTimeout: Int,\n    writeTimeout: Int,\n    pingIntervalMillis: Int,\n    connectionRetryEnabled: Boolean,\n    call: Call,\n    eventListener: EventListener\n) {\n    check(protocol == null) { \"already connected\" }\n\n    // çº¿è·¯çš„é€‰æ‹©\n    var routeException: RouteException? = null\n    val connectionSpecs = route.address.connectionSpecs\n    val connectionSpecSelector = ConnectionSpecSelector(connectionSpecs)\n\n    if (route.address.sslSocketFactory == null) {\n        if (ConnectionSpec.CLEARTEXT !in connectionSpecs) {\n            throw RouteException(UnknownServiceException(\n                \"CLEARTEXT communication not enabled for client\"))\n        }\n        val host = route.address.url.host\n        if (!Platform.get().isCleartextTrafficPermitted(host)) {\n            throw RouteException(UnknownServiceException(\n                \"CLEARTEXT communication to $host not permitted by network security policy\"))\n        }\n    } else {\n        if (Protocol.H2_PRIOR_KNOWLEDGE in route.address.protocols) {\n            throw RouteException(UnknownServiceException(\n                \"H2_PRIOR_KNOWLEDGE cannot be used with HTTPS\"))\n        }\n    }\n\n    // è¿æ¥å¼€å§‹\n    while (true) {\n        try {\n            // å¦‚æœè¦æ±‚éš§é“æ¨¡å¼ï¼Œå»ºç«‹é€šé“è¿æ¥ï¼Œé€šå¸¸ä¸æ˜¯è¿™ç§\n            if (route.requiresTunnel()) {\n                connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener)\n                if (rawSocket == null) {\n                    // æˆ‘ä»¬æ— æ³•è¿æ¥éš§é“ï¼Œä½†é€‚å½“å…³é—­äº†æˆ‘ä»¬çš„èµ„æºã€‚\n                    break\n                }\n            } else {\n                // ä¸€èˆ¬éƒ½èµ°è¿™æ¡é€»è¾‘äº†ï¼Œå®é™…ä¸Šå¾ˆç®€å•å°±æ˜¯socketçš„è¿æ¥\n                connectSocket(connectTimeout, readTimeout, call, eventListener)\n            }\n            // httpsçš„å»ºç«‹\n            establishProtocol(connectionSpecSelector, pingIntervalMillis, call, eventListener)\n            eventListener.connectEnd(call, route.socketAddress, route.proxy, protocol)\n            break\n        } catch (e: IOException) {\n            socket?.closeQuietly()\n            rawSocket?.closeQuietly()\n            socket = null\n            rawSocket = null\n            source = null\n            sink = null\n            handshake = null\n            protocol = null\n            http2Connection = null\n\n            eventListener.connectFailed(call, route.socketAddress, route.proxy, null, e)\n\n            if (routeException == null) {\n                routeException = RouteException(e)\n            } else {\n                routeException.addConnectException(e)\n            }\n\n            if (!connectionRetryEnabled || !connectionSpecSelector.connectionFailed(e)) {\n                throw routeException\n            }\n        }\n    }\n\n    if (route.requiresTunnel() && rawSocket == null) {\n        throw RouteException(ProtocolException(\n            \"Too many tunnel connections attempted: $MAX_TUNNEL_ATTEMPTS\"))\n    }\n\n    val http2Connection = this.http2Connection\n    if (http2Connection != null) {\n        synchronized(connectionPool) {\n            allocationLimit = http2Connection.maxConcurrentStreams()\n        }\n    }\n}\n```\né¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»å»ºç«‹è¿æ¥ï¼Œå¦‚æœå·²ç»å»ºç«‹å°±æŠ›å¼‚å¸¸ï¼Œæ²¡æœ‰çš„è¯å°±ç»§ç»­ã€‚æ¥ç€å°±å¾—åˆ°äº†`ConnectionSpecs`ï¼Œç„¶åæ ¹æ®ä»–å»ºç«‹äº†ä¸€ä¸ª`connectionSpecSelector`é›†åˆã€‚æ¥ç€åˆ¤æ–­æ˜¯ä¸æ˜¯å®‰å…¨è¿æ¥ï¼Œä¹Ÿå°±æ˜¯sslè¿æ¥ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±åˆ¤æ–­äº†ä¸€äº›å±æ€§ï¼Œå…ˆç¡®å®šæ˜¯ä¸æ˜¯æ˜æ–‡ç„¶åå†ç¡®å®šä¸»æœºèƒ½ä¸èƒ½æ¥å—æ˜æ–‡æ“ä½œã€‚æ¥ç€å°±å¼€å§‹è¿æ¥ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯è¦è¿›è¡Œéš§é“é€šä¿¡ï¼Œå¦‚æœæ˜¯å°±è°ƒç”¨`connectTunnel()`å»ºç«‹éš§é“é€šä¿¡ï¼Œå¦‚æœä¸æ˜¯å°±è°ƒç”¨`connectSocket()`å»ºç«‹æ™®é€šçš„é€šä¿¡ã€‚ç„¶åé€šè¿‡`establishProtocol()`å»ºç«‹åè®®ã€‚å¦‚æœæ˜¯`HTTP/2`å°±è®¾ç½®ç›¸å…³å±æ€§ã€‚\n\nç„¶åæˆ‘ä»¬å°±æ¥çœ‹çœ‹ä»–å…·ä½“å¦‚ä½•å®ç°çš„ï¼Œå…ˆçœ‹çœ‹`connectSocket()`æ–¹æ³•ï¼š\n```kotlin\n@Throws(IOException::class)\nprivate fun connectSocket(\n    connectTimeout: Int,\n    readTimeout: Int,\n    call: Call,\n    eventListener: EventListener\n) {\n    val proxy = route.proxy\n    val address = route.address\n\n    // æ ¹æ®ä»£ç†ç±»å‹é€‰æ‹©socketç±»å‹æ˜¯ä»£ç†è¿˜æ˜¯ç›´è¿\n    val rawSocket = when (proxy.type()) {\n        Proxy.Type.DIRECT, Proxy.Type.HTTP -> address.socketFactory.createSocket()!!\n        else -> Socket(proxy)\n    }\n    this.rawSocket = rawSocket\n\n    eventListener.connectStart(call, route.socketAddress, proxy)\n    rawSocket.soTimeout = readTimeout\n    try {\n        // è¿æ¥socketï¼Œä¹‹æ‰€ä»¥è¿™æ ·å†™æ˜¯å› ä¸ºæ”¯æŒä¸åŒçš„å¹³å°\n        // é‡Œé¢å®é™…ä¸Šæ˜¯  socket.connect(address, connectTimeout);\n        Platform.get().connectSocket(rawSocket, route.socketAddress, connectTimeout)\n    } catch (e: ConnectException) {\n        throw ConnectException(\"Failed to connect to ${route.socketAddress}\").apply {\n            initCause(e)\n        }\n    }\n\n    // ä¸‹é¢çš„Try/Catchå—æ˜¯ä¸€ç§é¿å…Android 7.0å´©æºƒçš„ä¼ªé»‘å®¢æ–¹æ³•\n    // More details:\n    // https://github.com/square/okhttp/issues/3245\n    // https://android-review.googlesource.com/#/c/271775/\n    try {\n        // å¾—åˆ°è¾“å…¥ï¼è¾“å‡ºæµ\n        source = rawSocket.source().buffer()\n        sink = rawSocket.sink().buffer()\n    } catch (npe: NullPointerException) {\n        if (npe.message == NPE_THROW_WITH_NULL) {\n            throw IOException(npe)\n        }\n    }\n}\n```\né¦–å…ˆå…ˆåˆ¤æ–­è¿æ¥ç±»å‹ï¼Œå¦‚æœæ˜¯ç›´è¿æˆ–è€…`HTTP`è¿æ¥å°±ç›´è¿ï¼Œå¦åˆ™çš„è¯èµ°`Socket`ä»£ç†ï¼Œç„¶åé€šè¿‡`eventListener.connectStart()`æ–¹æ³•åˆ›å»ºè¿æ¥ï¼Œå†è®¾å®šè¶…æ—¶->å®Œæˆè¿æ¥->åˆ›å»ºç”¨äºI/Oçš„`source`å’Œ`sink`ã€‚\n\næˆ‘ä»¬æ¥ç€å†æ¥çœ‹`connectTunnel()`æ–¹æ³•ï¼š\n```kotlin\n@Throws(IOException::class)\nprivate fun connectTunnel(\n    connectTimeout: Int,\n    readTimeout: Int,\n    writeTimeout: Int,\n    call: Call,\n    eventListener: EventListener\n) {\n    var tunnelRequest: Request = createTunnelRequest()\n    val url = tunnelRequest.url\n    for (i in 0 until MAX_TUNNEL_ATTEMPTS) {\n        connectSocket(connectTimeout, readTimeout, call, eventListener)\n        tunnelRequest = createTunnel(readTimeout, writeTimeout, tunnelRequest, url)\n            ?: break // å·²æˆåŠŸåˆ›å»ºéš§é“ã€‚\n\n        // ä»£ç†å†³å®šåœ¨èº«ä»½éªŒè¯è´¨è¯¢åå…³é—­è¿æ¥ã€‚\n        // æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œä½†è¿™æ¬¡éœ€è¦ä½¿ç”¨èº«ä»½éªŒè¯å‡­æ®ã€‚\n        rawSocket?.closeQuietly()\n        rawSocket = null\n        sink = null\n        source = null\n        eventListener.connectEnd(call, route.socketAddress, route.proxy, null)\n    }\n}\n```\nå¤§ä½“å°±æ˜¯å…ˆåˆ›å»ºéš§é“è¯·æ±‚ï¼Œç„¶åå»ºç«‹`socket`è¿æ¥ï¼Œå†å‘é€è¯·æ±‚å»ºç«‹éš§é“ã€‚\n\n# 3. è¯·æ±‚æµç¨‹å›¾\né‚£æˆ‘ä»¬æœ€åæ¥æ€»ç»“ä¸‹\n## 3.1 åŒæ­¥è¯·æ±‚æ˜¯å¦‚ä½•æ“ä½œçš„ï¼Ÿ\n![OkHttpSyn](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/26/OkHttpSync.jpg)\n\n## 3.2 å¼‚æ­¥è¯·æ±‚æ˜¯å¦‚ä½•æ“ä½œçš„ï¼Ÿ\n![OkHttpAsyn](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/26/OkHttpAsync.jpg)\n","tags":["Android","kotlin","æºç ","OkHttp"],"categories":["Android"]},{"title":"Androidç½‘ç»œè¯·æ±‚2--è§£æVolleyæºç ","url":"/posts/df8fd75e.html","content":">æœ¬æ–‡å¤§ç¯‡å¹…å‚è€ƒ[æ­¤ç¯‡æ–‡ç« ](https://www.jianshu.com/p/d8500e377f3e)ï¼Œå¤§å®¶å¯ä»¥ç»“åˆä¸¤ç¯‡æ–‡ç« çœ‹ä¸€ä¸‹\n\n# 1. Volleyç®€ä»‹\nåœ¨å¾ˆæ—©ä»¥å‰ï¼Œå¦‚æœAndroidå¼€å‘è€…æƒ³ä½¿ç”¨ç½‘ç»œè¯·æ±‚çš„è¯ï¼Œå¿…é¡»è‡ªå·±é€šè¿‡`HttpClient`æˆ–è€…`HttpURLConnection`ç¼–å†™ä»£ç æ¥è®¿é—®ã€‚ä½†æ˜¯ä»–ä¸¤çš„ç”¨æ³•è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œå¦‚æœä¸é€‚å½“çš„å°è£…çš„è¯ï¼Œå°±ä¼šæœ‰å¾ˆå¤šå¤šä½™ä»£ç ç”šè‡³æ•ˆç‡é™ä½ã€‚æ‰€ä»¥å½“æ—¶å‡ºç°äº†å¾ˆå¤šç¬¬ä¸‰æ–¹ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œä½†æ˜¯éƒ½æ˜¯ç¬¬ä¸‰æ–¹çš„ï¼Œè€Œè°·æ­Œå®˜æ–¹ä¸€ç›´æ²¡æœ‰ä½œä¸ºã€‚\næœ€ç»ˆåœ¨2013å¹´ï¼Œè°·æ­Œç»ˆäºæ„è¯†åˆ°äº†é—®é¢˜ï¼Œäºæ˜¯ä»–ä»¬æ¨å‡ºäº†ä¸€ä¸ªå®˜æ–¹çš„å…¨æ–°çš„ç½‘ç»œæ¡†æ¶â€”â€”Volleyã€‚Volleyå®ƒåˆèƒ½éå¸¸ç®€å•çš„è¿›è¡ŒHTTPé€šä¿¡ï¼Œåˆèƒ½è½»æ¾åŠ è½½ç½‘ç»œä¸Šçš„å›¾ç‰‡ã€‚ä»–çš„è®¾è®¡ç›®çš„å°±æ˜¯åº”å¯¹æ•°æ®é‡ä¸å¤§ä½†æ˜¯é¢‘å‘çš„ç½‘ç»œæ“ä½œï¼Œä½†æ˜¯å¯¹äºä¸‹è½½ç­‰éœ€è¦å¤§æ•°æ®é‡çš„ç½‘ç»œæ“ä½œï¼Œä»–å°±ä¸å¤ªé€‚åˆã€‚\n<!-- More -->\n\n# 2. æºç è§£æ\n## 2.1 ä»RequestQueueå…¥æ‰‹\nå¦‚æœä½ ä½¿ç”¨Volleyçš„è¯ï¼Œå°±ä¼šå‘ç°Volleyä¸ç®¡è¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œé¦–å…ˆç¬¬ä¸€æ­¥å°±æ˜¯å…ˆåˆ›å»ºRequestQueueå¯¹è±¡ã€‚\næ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥è®¤å®šä»–ä¸ºVolleyçš„å…¥å£ã€‚\nåˆ›å»ºRequestQueueçš„æ–¹æ³•æ˜¯`RequestQueue mQueue = Volley.newRequestQueue(getApplicationContext());`,æˆ‘ä»¬å°±çœ‹çœ‹`newRequestQueue`å¹²äº†ä»€ä¹ˆï¼š\n```java\npublic static RequestQueue newRequestQueue(Context context, BaseHttpStack stack) {\n    BasicNetwork network;\n    if (stack == null) {\n        if (Build.VERSION.SDK_INT >= 9) {\n            network = new BasicNetwork(new HurlStack());\n        } else {\n            // åœ¨Android 2.3ä¹‹å‰ï¼ŒHttpURLConnectionæ˜¯ä¸å¯é çš„ã€‚\n            // è¯·å‚é˜…ï¼šhttp://android-developers.blogspot.com/2011/09/androids-http-clients.html\n            // åœ¨å°†æ¥çš„æŸä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°†æŠŠminsdkversionç§»åˆ°Android 2.2ä¹‹ä¸Šï¼Œ\n            // å¹¶å¯ä»¥åˆ é™¤è¿™ä¸ªå›é€€ï¼ˆè¿åŒæ‰€æœ‰ApacheHTTPä»£ç ï¼‰ã€‚            \n            String userAgent = \"volley/0\";\n            try {\n                String packageName = context.getPackageName();\n                PackageInfo info =\n             context.getPackageManager().getPackageInfo(packageName, /* flags= */ 0);\n                    userAgent = packageName + \"/\" + info.versionCode;\n            } catch (NameNotFoundException e) {\n            }\n\n        network =\n                new BasicNetwork(\n                        new HttpClientStack(AndroidHttpClient.newInstance(userAgent)));\n        }\n    } else {\n        network = new BasicNetwork(stack);\n    }\n\n    return newRequestQueue(context, network);\n}\n```\nè°ƒç”¨æ–¹æ³•åï¼Œå…ˆæŸ¥çœ‹Androidç‰ˆæœ¬æ˜¯å¦å¤§äºç­‰äº2.3ï¼Œå¦‚æœå¤§äºåˆ™è°ƒç”¨åŸºäº`HttpURLConnection`çš„`HurlStack`ï¼Œå¦åˆ™è°ƒç”¨åŸºäº`HttpClient`çš„`HttpClientStack`ã€‚æ¥ä¸‹æ¥åˆ›å»º`BasicNetwork`å¹¶è°ƒç”¨`newRequestQueue(context, network)`æ–¹ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ª`newRequestQueue()`æ–¹æ³•ï¼š\n```java\nprivate static RequestQueue newRequestQueue(Context context, Network network) {\n    final Context appContext = context.getApplicationContext();\n    // å¯¹ç¼“å­˜ç›®å½•ä½¿ç”¨æƒ°æ€§ä¾›åº”å•†ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸Šè°ƒç”¨newRequestQueueï¼ˆï¼‰ï¼Œ\n    // è€Œä¸ä¼šå¯¼è‡´ä¸¥æ ¼çš„æ¨¡å¼å†²çªã€‚    \n    DiskBasedCache.FileSupplier cacheSupplier =\n            new DiskBasedCache.FileSupplier() {\n                private File cacheDir = null;\n\n                @Override\n                public File get() {\n                    if (cacheDir == null) {\n                        cacheDir = new File(appContext.getCacheDir(), DEFAULT_CACHE_DIR);\n                    }\n                    return cacheDir;\n                }\n            };\n    RequestQueue queue = new RequestQueue(new DiskBasedCache(cacheSupplier), network);\n    queue.start();\n    return queue;\n}\n```\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ä¸ºVolleyåˆ›å»ºäº†ä¸€ä¸ªç¡¬ç›˜ç¼“å­˜`DiskBasedCache`ï¼Œç„¶åé€šè¿‡è¿™ä¸ªç£ç›˜ç¼“å­˜å’Œ`Network`åˆ›å»ºäº†ä¸€ä¸ª`RequestQueue`å¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†`start()`æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹`start()`æ–¹æ³•:\n```java\npublic void start() {\n    stop(); \n    // ç¡®ä¿å½“å‰è¿è¡Œçš„æ‰€æœ‰è°ƒåº¦ç¨‹åºéƒ½å·²åœæ­¢ã€‚\n    // åˆ›å»ºç¼“å­˜è°ƒåº¦å™¨å¹¶å¼€å§‹å®ƒã€‚\n    mCacheDispatcher = new CacheDispatcher(mCacheQueue, mNetworkQueue, mCache, mDelivery);\n    mCacheDispatcher.start();\n\n    // åˆ›å»ºè¾¾åˆ°æ± å¤§å°çš„ç½‘ç»œè°ƒåº¦ç¨‹åºï¼ˆå’Œç›¸åº”çš„çº¿ç¨‹ï¼‰ã€‚\n    for (int i = 0; i < mDispatchers.length; i++) {\n        NetworkDispatcher networkDispatcher =\n                    new NetworkDispatcher(mNetworkQueue, mNetwork, mCache, mDelivery);\n        mDispatchers[i] = networkDispatcher;\n        networkDispatcher.start();\n    }\n}\n```\n`CacheDispatcher`æ˜¯ä¸€ä¸ªç¼“å­˜è°ƒåº¦çº¿ç¨‹ï¼Œå¹¶è°ƒç”¨äº†`start()`æ–¹æ³•ã€‚åœ¨å¾ªç¯ä¸­è°ƒç”¨`NetworkDispatcher`çš„`start()`æ–¹æ³•ã€‚`NetworkDispatcher`æ˜¯ç½‘ç»œè°ƒåº¦çº¿ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹`mDispatchers.length`ä¸º4ï¼Œé»˜è®¤å¼€å¯äº†4ä¸ªè°ƒåº¦çº¿ç¨‹ï¼Œå¤–åŠ 1ä¸ªç¼“å­˜è°ƒåº¦çº¿ç¨‹ï¼Œæ€»å…±5ä¸ªçº¿ç¨‹ã€‚\næ¥ä¸‹æ¥Volleyä¼šåˆ›å»ºå„ç§`Request`ï¼Œå¹¶è°ƒç”¨`RequestQueue`çš„`add()`æ–¹æ³•ï¼š\n```java\npublic <T> Request<T> add(Request<T> request) {\n    // å°†è¯·æ±‚æ ‡è®°ä¸ºå±äºæ­¤é˜Ÿåˆ—ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°å½“å‰è¯·æ±‚é›†ã€‚\n    request.setRequestQueue(this);\n    synchronized (mCurrentRequests) {\n        //mCurrentRequestsæ˜¯ä¸€ä¸ªHashSet\n        mCurrentRequests.add(request);\n    }\n\n    // æŒ‰æ·»åŠ çš„é¡ºåºå¤„ç†è¯·æ±‚ã€‚\n    request.setSequence(getSequenceNumber());\n    request.addMarker(\"add-to-queue\");\n    sendRequestEvent(request, RequestEvent.REQUEST_QUEUED);\n\n    // å¦‚æœè¯·æ±‚æ˜¯ä¸å¯æ‰§è¡Œçš„ï¼Œè·³è¿‡ç¼“å­˜é˜Ÿåˆ—ï¼Œç„¶åç›´æ¥è¿›å…¥ç½‘ç»œã€‚\n    if (!request.shouldCache()) {\n        mNetworkQueue.add(request);\n        return request;\n    }\n    mCacheQueue.add(request);\n    return request;\n}\n```\nè¿™å—åœ°æ–¹çš„ä»£ç å°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯æ ¹æ®`request`çš„`shouldCache()`æ–¹æ³•æ¥è¿”å›`request`çš„`mShouldCache`å±æ€§æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥ç¼“å­˜ï¼Œé»˜è®¤æ˜¯å¯ä»¥çš„ã€‚å¦‚æœèƒ½ç¼“å­˜ï¼Œå°†æ­¤è¯·æ±‚åŠ å…¥`mCacheQueue`é˜Ÿåˆ—ï¼Œä¸å†é‡å¤è¯·æ±‚ï¼›ä¸å¯ä»¥çš„è¯å°±å°†è¯·æ±‚åŠ å…¥ç½‘ç»œè¯·æ±‚é˜Ÿåˆ—`mNetworkQueue`ã€‚\n\n## 2.2 CacheDispatcherç¼“å­˜è°ƒåº¦çº¿ç¨‹\n`RequestQueue`çš„`add()`æ–¹æ³•å¹¶æ²¡æœ‰è¯·æ±‚ç½‘ç»œæˆ–è€…å¯¹ç¼“å­˜è¿›è¡Œæ“ä½œã€‚å½“å°†è¯·æ±‚æ·»åŠ åˆ°ç½‘ç»œè¯·æ±‚é˜Ÿ åˆ—æˆ–è€…ç¼“å­˜é˜Ÿåˆ—æ—¶ï¼Œåœ¨åå°çš„ç½‘ç»œè°ƒåº¦çº¿ç¨‹å’Œç¼“å­˜è°ƒåº¦çº¿ç¨‹è½®è¯¢å„è‡ªçš„è¯·æ±‚é˜Ÿåˆ—ï¼Œè‹¥å‘ç°æœ‰è¯·æ±‚ä»»åŠ¡åˆ™å¼€ å§‹æ‰§è¡Œã€‚ä¸‹é¢å…ˆçœ‹çœ‹ç¼“å­˜è°ƒåº¦çº¿ç¨‹ã€‚\n\né¦–å…ˆå…ˆæ¥çœ‹çœ‹`CacheDispatcher`çš„`add()`æ–¹æ³•ï¼š\n```java\n@Override\npublic void run() {\n    if (DEBUG) \n        VolleyLog.v(\"start new dispatcher\");\n    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);\n    // Process.THREAD_PRIORITY_BACKGROUNDé»˜è®¤å€¼ä¸º10\n\n    // è¿›è¡Œé˜»å¡è°ƒç”¨ä»¥åˆå§‹åŒ–ç¼“å­˜ã€‚\n    mCache.initialize();\n\n    while (true) {\n        try {\n            processRequest();\n        } catch (InterruptedException e) {\n            // å¯èƒ½è¢«æ‰“æ–­äº†ï¼Œå› ä¸ºæ˜¯æ—¶å€™è¦é€€å‡ºäº†ã€‚\n            if (mQuit) {\n                Thread.currentThread().interrupt();\n                    return;\n            }\n            VolleyLog.e(\n                    \"Ignoring spurious interrupt of CacheDispatcher thread; \"\n                            + \"use quit() to terminate it\");\n            // å¿½ç•¥cachedispatcherçº¿ç¨‹çš„å‡ä¸­æ–­ï¼›\n            // ä½¿ç”¨quitï¼ˆï¼‰ç»ˆæ­¢å®ƒ\n        }\n    }\n}\n```\nè¿™å—å¯ä»¥çœ‹å‡ºä¸»è¦å°±æ˜¯åˆå§‹åŒ–äº†ç¼“å­˜é˜Ÿåˆ—ï¼Œç„¶åå¼€äº†ä¸ªæ­»å¾ªç¯ï¼Œä¸€ç›´è°ƒç”¨`processRequest()`ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š\n```java\nprivate void processRequest() throws InterruptedException {\n    // ä»CacheQueueä¸­å–å‡ºä¸€ä¸ªå¯ç”¨çš„request\n    final Request<?> request = mCacheQueue.take();\n    processRequest(request);\n}\n\n@VisibleForTesting\nvoid processRequest(final Request<?> request) throws InterruptedException {\n    request.addMarker(\"cache-queue-take\");\n    request.sendEvent(RequestQueue.RequestEvent.REQUEST_CACHE_LOOKUP_STARTED);\n\n    try {\n        //requestå¦‚æœè¢«å–æ¶ˆäº†ï¼Œå°±ç›´æ¥è¿”å›\n        if (request.isCanceled()) {\n            request.finish(\"cache-discard-canceled\");\n            return;\n        }\n\n        Cache.Entry entry = mCache.get(request.getCacheKey());\n        // æ²¡æœ‰ç¼“å­˜å°±æŠŠrequestæ·»åŠ åˆ°NetworkQueueä¸­\n        if (entry == null) {\n            request.addMarker(\"cache-miss\");\n            // æ²¡æœ‰ç¼“å­˜ï¼Œå¹¶ä¸”ç­‰å¾…é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰æ­¤requestï¼Œé‚£ä¹ˆå°±ç›´æ¥åŠ å…¥åˆ°NetworkQueueä¸­\n            if (!mWaitingRequestManager.maybeAddToWaitingRequests(request)) {\n                mNetworkQueue.put(request);\n            }\n            return;\n        }\n\n        // å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œä¹Ÿæ˜¯ä¸€æ ·æŠŠrequestæ·»åŠ åˆ°NetworkQueueä¸­\n        if (entry.isExpired()) {\n            request.addMarker(\"cache-hit-expired\");\n            request.setCacheEntry(entry);\n            if (!mWaitingRequestManager.maybeAddToWaitingRequests(request)) {\n                mNetworkQueue.put(request);\n            }\n            return;\n        }\n\n        // æœ‰ç¼“å­˜å¹¶ä¸”æ²¡æœ‰è¿‡æœŸ\n        request.addMarker(\"cache-hit\");\n        // æ ¹æ®ç¼“å­˜çš„å†…å®¹è§£æ\n        Response<?> response =\n                request.parseNetworkResponse(\n                        new NetworkResponse(entry.data, entry.responseHeaders));\n        request.addMarker(\"cache-hit-parsed\");\n        // æ˜¯å¦éœ€è¦æ›´æ–°\n        if (!entry.refreshNeeded()) {\n            // ä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥å°†ç»“æœè°ƒåº¦åˆ°ä¸»çº¿ç¨‹\n            mDelivery.postResponse(request, response);\n        } else {\n            request.addMarker(\"cache-hit-refresh-needed\");\n            request.setCacheEntry(entry);\n            response.intermediate = true;\n            // åˆ¤æ–­æ˜¯å¦æœ‰ç›¸åŒç¼“å­˜é”®çš„ä»»åŠ¡åœ¨æ‰§è¡Œ\n            if (!mWaitingRequestManager.maybeAddToWaitingRequests(request)) {\n                // éœ€è¦æ›´æ–°ç»“æœï¼Œå…ˆå°†ç»“æœè°ƒåº¦åˆ°ä¸»çº¿ç¨‹ï¼Œç„¶åæ‰§è¡Œnew runnable(){}\n                // runnableä¸­å°±æ˜¯å°†requestæ·»åŠ åˆ°NetworkQueueä¸­ï¼Œæ›´æ–°ä¸€ä¸‹å†…å®¹\n                mDelivery.postResponse(\n                        request,\n                        response,\n                        new Runnable() {\n                            @Override\n                            public void run() {\n                                try {\n                                    mNetworkQueue.put(request);\n                                } catch (InterruptedException e) {\n                                    // Restore the interrupted status\n                                    Thread.currentThread().interrupt();\n                                }\n                            }\n                        });\n            } else {\n                // requestå·²ç»åŠ å…¥åˆ°mWaitingRequestsä¸­\n                // ç›´æ¥æŠŠç»“æœè°ƒåº¦åˆ°ä¸»çº¿ç¨‹\n                mDelivery.postResponse(request, response);\n            }\n        }\n    } finally {\n        request.sendEvent(RequestQueue.RequestEvent.REQUEST_CACHE_LOOKUP_FINISHED);\n    }\n}\n```\næˆ‘ä»¬åœ¨`processRequest`ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ–¹æ³•ç»å¸¸å‡ºç°ï¼Œé‚£å°±æ˜¯`mWaitingRequestManager.maybeAddToWaitingRequests(request)`ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ¤æ–­å½“å‰è¿™ä¸ª`request`æ˜¯å¦æœ‰å­˜åœ¨ç›¸åŒç¼“å­˜é”®çš„è¯·æ±‚å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ª`request`åŠ å…¥åˆ°ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°ç›¸åŒç¼“å­˜é”®çš„è¯·æ±‚å®Œæˆã€‚\n\næ€»ç»“ä¸€ä¸‹`CacheDispatcher`ä¸»è¦æ­¥éª¤ï¼š\n\n- ä»`CacheQueue`ä¸­å¾ªç¯å–å‡º`request`ï¼›\n- å¦‚æœç¼“å­˜ä¸¢å¤±ï¼ŒåŠ å…¥åˆ°`NetworkQueue`ä¸­ï¼›\n- å¦‚æœç¼“å­˜è¿‡æœŸï¼ŒåŠ å…¥åˆ°`NetworkQueue`ä¸­ï¼›\n- å°†ç¼“å­˜ä¸­çš„æ•°æ®è§£ææˆ`Response`å¯¹è±¡ï¼›\n- å¦‚æœä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥å°†ç»“æœå›è°ƒåˆ°ä¸»çº¿ç¨‹ï¼Œå›è°ƒæ“ä½œç­‰ä»‹ç»å®Œ`NetworkDispatcher`ä¹‹åä¸€èµ·æ·±å…¥å‰–æï¼›\n- å¦‚æœéœ€è¦æ›´æ–°ï¼Œå…ˆå°†ç»“æœå›è°ƒåˆ°ä¸»çº¿ç¨‹ï¼Œç„¶åå†å°†`request`åŠ å…¥åˆ°`NetworkQueue`ä¸­ã€‚\n\nä¸‹é¢æ¥çœ‹çœ‹ç½‘ç»œè°ƒåº¦çº¿ç¨‹ã€‚\n\n## 2.3 NetWorkDispatcherç½‘ç»œè°ƒåº¦çº¿ç¨‹\nNetworkDispatcherçš„runæ–¹æ³•ä»£ç å¦‚ä¸‹æ‰€ç¤º:\n```java\n@Override\npublic void run() {\n    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);\n    while (true) {\n        try {\n            processRequest();\n        } catch (InterruptedException e) {\n            // æˆ‘ä»¬å¯èƒ½è¢«æ‰“æ–­äº†ï¼Œå› ä¸ºæ˜¯æ—¶å€™é€€å‡ºäº†ã€‚\n            if (mQuit) {\n                Thread.currentThread().interrupt();\n                return;\n            }\n            VolleyLog.e(\n                    \"Ignoring spurious interrupt of NetworkDispatcher thread; \"\n                            + \"use quit() to terminate it\");\n        }\n    }\n}\n```\nç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œ`NetWordDispatch`å’Œ`CacheDispatch`éå¸¸ç±»ä¼¼ã€‚\nä»–çš„`run()`æ–¹æ³•å’Œ`CacheDispatch`çš„æ–¹æ³•åŸºæœ¬ä¸€æ ·ï¼Œè¿™å°±ä¸å¤šåšä»‹ç»ï¼Œä¸‹é¢æ¥çœ‹çœ‹ä»–çš„`processRequest()`æ–¹æ³•ã€‚\n```java\nprivate void processRequest() throws InterruptedException {\n    // ä»NetworkQueueä¸­å–å‡ºrequest\n    Request<?> request = mQueue.take();\n    processRequest(request);\n}\n\n@VisibleForTesting\nvoid processRequest(Request<?> request) {\n    long startTimeMs = SystemClock.elapsedRealtime();\n    request.sendEvent(RequestQueue.RequestEvent.REQUEST_NETWORK_DISPATCH_STARTED);\n    try {\n        request.addMarker(\"network-queue-take\");\n\n        // å¦‚æœrequestè¢«å–æ¶ˆäº†ï¼Œé‚£ä¹ˆå°±ä¸æ‰§è¡Œæ­¤request\n        if (request.isCanceled()) {\n            request.finish(\"network-discard-cancelled\");\n            request.notifyListenerResponseNotUsable();\n            return;\n        }\n\n        addTrafficStatsTag(request);\n\n        // è¿˜è®°å¾—è¿™ä¸ªmNetworkä¹ˆï¼Œå®ƒå°±æ˜¯Volley.newRequestQueue()æ–¹æ³•é‡Œçš„BasicNetworkå¯¹è±¡ï¼Œä¸€ä¼šæˆ‘ä»¬æ¥çœ‹çœ‹mNetwork.performRequest()æ–¹æ³•æ˜¯å¦‚ä½•å¾—åˆ°NetworkResponseçš„\n        NetworkResponse networkResponse = mNetwork.performRequest(request);\n        request.addMarker(\"network-http-complete\");\n\n        // notModifiedæ˜¯æœåŠ¡ç«¯è¿”å›304ï¼ŒhasHadResponseDelivered()æ˜¯requestå·²ç»å›è°ƒè¿‡äº†\n        if (networkResponse.notModified && request.hasHadResponseDelivered()) {\n            request.finish(\"not-modified\");\n            request.notifyListenerResponseNotUsable();\n            return;\n        }\n\n        // å°†NetworkResponseè§£ææˆResponseå¯¹è±¡ï¼Œåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œ\n        Response<?> response = request.parseNetworkResponse(networkResponse);\n        request.addMarker(\"network-parse-complete\");\n\n        // å°†requestå†™å…¥ç¼“å­˜\n        if (request.shouldCache() && response.cacheEntry != null) {\n            mCache.put(request.getCacheKey(), response.cacheEntry);\n            request.addMarker(\"network-cache-written\");\n        }\n\n        request.markDelivered();\n        // å›è°ƒç»“æœè‡³ä¸»çº¿ç¨‹\n        mDelivery.postResponse(request, response);\n        request.notifyListenerResponseReceived(response);\n    } \n    // ä»¥ä¸‹éƒ½æ˜¯å¤„ç†å¼‚å¸¸é”™è¯¯ï¼Œç„¶åä¹Ÿéœ€è¦å›è°ƒè‡³ä¸»çº¿ç¨‹\n    catch (VolleyError volleyError) {\n        volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);\n        parseAndDeliverNetworkError(request, volleyError);\n        request.notifyListenerResponseNotUsable();\n    } catch (Exception e) {\n        VolleyLog.e(e, \"Unhandled exception %s\", e.toString());\n        VolleyError volleyError = new VolleyError(e);\n        volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);\n        mDelivery.postError(request, volleyError);\n        request.notifyListenerResponseNotUsable();\n    } finally {\n        request.sendEvent(RequestQueue.RequestEvent.REQUEST_NETWORK_DISPATCH_FINISHED);\n    }\n}\n```\né€šè¿‡`NetworkDispatcher.processRequest()`æ–¹æ³•å¯ä»¥å‘ç°ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š\n\n- é€šè¿‡`BasicNetwork.performRequest(request)`å¾—åˆ°`NetworkResponse`å¯¹è±¡ï¼›\n- é€šè¿‡`request.parseNetworkResponse(networkResponse)`è§£æå¾—åˆ°`Response`å¯¹è±¡ï¼›\n- é€šè¿‡`mDelivery`å°†æˆåŠŸç»“æœæˆ–è€…å¤±è´¥ç»“æœå›è°ƒåˆ°ä¸»çº¿ç¨‹ã€‚\n\nç°åœ¨æˆ‘ä»¬ä¾æ¬¡æ¥åˆ†æè¿™ä¸‰æ­¥ï¼š\n- è¯·æ±‚ç½‘ç»œï¼Œå¾—åˆ°`NetworkResponse`\n    æˆ‘ä»¬çœ‹çœ‹`BasicNetwork`çš„`performRequest()`æ–¹æ³•ï¼š\n    \n```java\n@Override\npublic NetworkResponse performRequest(Request<?> request) throws VolleyError {\n    long requestStart = SystemClock.elapsedRealtime();\n    while (true) {\n        HttpResponse httpResponse = null;\n        byte[] responseContents = null;\n        List<Header> responseHeaders = Collections.emptyList();\n        try {\n            // Gather headers.\n            Map<String, String> additionalRequestHeaders =\n                    getCacheHeaders(request.getCacheEntry());\n            httpResponse = mBaseHttpStack.executeRequest(request, additionalRequestHeaders);\n            int statusCode = httpResponse.getStatusCode();\n\n            responseHeaders = httpResponse.getHeaders();\n            // Handle cache validation.\n            if (statusCode == HttpURLConnection.HTTP_NOT_MODIFIED) {\n                Entry entry = request.getCacheEntry();\n                if (entry == null) {\n                    return new NetworkResponse(\n                            HttpURLConnection.HTTP_NOT_MODIFIED,\n                            /* data= */ null,\n                            /* notModified= */ true,\n                            SystemClock.elapsedRealtime() - requestStart,\n                            responseHeaders);\n            }\n                    â€¦â€¦â€¦â€¦çœç•¥\n```\né€šè¿‡ä¸Šé¢æºç å¯ä»¥çœ‹å‡ºï¼Œ`BasicNetwork`å°±æ˜¯å°è£…äº†ä¸€ä¸‹`NetworkResponse`ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬ç»§ç»­æ·±å…¥åˆ°`BaseHttpStack.executeRequest(request, additionalRequestHeaders)`æºç ä¸­ã€‚\n```java\npublic abstract HttpResponse executeRequest(\n        Request<?> request, Map<String, String> additionalHeaders)\n        throws IOException, AuthFailureError;\n```\nè¿™æ—¶å‘ç°è¿™ä¸ª`BaseHttpStack`å°±æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€Œè¿™ä¸ª`executeRequest()`ä¹Ÿå°±æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚æˆ‘å½“æ—¶å°±å¡åœ¨è¿™äº†ï¼Œè°ƒç”¨äº†ä¸€ä¸ªæŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œè¿™å’‹æ“ä½œå˜›ã€‚ç„¶åæˆ‘å°±å¥½å¥½å†çœ‹äº†ä¸€éï¼Œæ‰¾åˆ°`BasicNetwork`çš„æ„é€ å‡½æ•°ä¸­å¯¹`mBaseHttpStck`å®šä¹‰çš„åœ°æ–¹ï¼Œå‘ç°è¿™ä¸ªæ˜¯æ„é€ å‡½æ•°ä¼ è¿›æ¥çš„ï¼Œç„¶åå°±æƒ³åˆ°äº†åœ¨è°ƒç”¨`Volley.newRequestQueue()`æ—¶ï¼Œæ˜¯æ ¹æ®Androidç‰ˆæœ¬ä¼ å…¥äº†ä¸åŒçš„`Stack`ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹`HurlStack.executeRequest()`æ–¹æ³•ï¼š\n```java\n@Override\npublic HttpResponse executeRequest(Request<?> request, Map<String, String> additionalHeaders)\n        throws IOException, AuthFailureError {\n    String url = request.getUrl();\n    HashMap<String, String> map = new HashMap<>();\n    map.putAll(additionalHeaders);\n    // request.getheadersï¼ˆï¼‰ä¼˜å…ˆäºç»™å®šçš„é™„åŠ ï¼ˆç¼“å­˜ï¼‰å¤´.\n    map.putAll(request.getHeaders());\n    if (mUrlRewriter != null) {\n        String rewritten = mUrlRewriter.rewriteUrl(url);\n        if (rewritten == null) {\n            throw new IOException(\"URL blocked by rewriter: \" + url);\n        }\n        url = rewritten;\n    }\n    URL parsedUrl = new URL(url);\n    HttpURLConnection connection = openConnection(parsedUrl, request);\n    boolean keepConnectionOpen = false;\n    try {\n        for (String headerName : map.keySet()) {\n            connection.setRequestProperty(headerName, map.get(headerName));\n        }\n        setConnectionParametersForRequest(connection, request);\n        // ä½¿ç”¨æ¥è‡ªhttpurlConnectionçš„æ•°æ®åˆå§‹åŒ–httpResponseã€‚\n        int responseCode = connection.getResponseCode();\n        if (responseCode == -1) {\n            // å¦‚æœæ— æ³•æ£€ç´¢å“åº”ä»£ç ï¼ŒgetResponseCodeï¼ˆï¼‰å°†è¿”å›-1ã€‚\n            // å‘å‘¼å«è€…å‘å‡ºä¿¡å·ï¼Œè¯´æ˜è¿æ¥æœ‰é—®é¢˜ã€‚\n            throw new IOException(\"Could not retrieve response code from HttpUrlConnection.\");\n        }\n\n        if (!hasResponseBody(request.getMethod(), responseCode)) {\n            return new HttpResponse(responseCode, convertHeaders(connection.getHeaderFields()));\n        }\n\n        // éœ€è¦ä¿æŒè¿æ¥æ‰“å¼€ï¼Œç›´åˆ°è°ƒç”¨æ–¹ä½¿ç”¨æµã€‚åŒ…è£…æµï¼Œä»¥ä¾¿closeï¼ˆï¼‰å°†æ–­å¼€è¿æ¥ã€‚\n        keepConnectionOpen = true;\n        return new HttpResponse(\n                responseCode,\n                convertHeaders(connection.getHeaderFields()),\n                connection.getContentLength(),\n                new UrlConnectionInputStream(connection));\n    } finally {\n        if (!keepConnectionOpen) {\n            connection.disconnect();\n        }\n    }\n}\n```\nå¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦å°±æ˜¯å€ŸåŠ©äº†`HttpURLConnection`å¯¹è±¡æ¥è¯·æ±‚ç½‘ç»œï¼Œå¹¶æ ¹æ®ä¸åŒçš„æ¡ä»¶è¿”å›ä¸åŒçš„`HttpResponse`å¯¹è±¡ã€‚\n- è§£æ`NetworkResponse`, å¾—åˆ°`Response`ï¼š\nè§£æè¿‡ç¨‹æ˜¯å®šä¹‰åœ¨`Request`ç±»ä¸­ï¼Œä½†æ˜¯ä»–æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸åŒçš„Requestéƒ½æœ‰è‡ªå·±çš„å®ç°ï¼Œæˆ‘ä»¬ç°åœ¨å°±ä»¥JsonRequestä¸ºä¾‹çœ‹çœ‹ï¼š\nç„¶åå‘ç°ä»–åˆæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œé‚£æˆ‘ä»¬å°±çœ‹çœ‹`JsonRequest`å…¶ä¸­ä¸€ä¸ªå®ç°ç±»`JsonObjectRequest`çš„`parseNetworkResponse()`æ–¹æ³•ï¼š\n\n```java\n@Override\nprotected Response<JSONObject> parseNetworkResponse(NetworkResponse response) {\n    try {\n        String jsonString =\n                new String(\n                        response.data,\n                        HttpHeaderParser.parseCharset(response.headers, PROTOCOL_CHARSET));\n        return Response.success(\n                new JSONObject(jsonString), HttpHeaderParser.parseCacheHeaders(response));\n    } catch (UnsupportedEncodingException e) {\n        return Response.error(new ParseError(e));\n    } catch (JSONException je) {\n        return Response.error(new ParseError(je));\n    }\n}\n```\nè¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†ï¼Œæ ¹æ®è¿”å›æ¥çš„`response`å»ºäº†ä¸€ä¸ª`String`ç„¶åæŠŠè¿™ä¸ª`String`æ”¾åˆ°`Response`é‡Œé¢å»ç„¶åå†è¿”å›å»ã€‚\n- å›è°ƒä¸»çº¿ç¨‹\nå›è°ƒä¸»è¦æ˜¯é€šè¿‡`Delivery`çš„`postResponse()`æ–¹æ³•å®ç°çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•,æ‰¾è¿‡å»åˆæ‰¾åˆ°äº†ä¸€ä¸ª`ResponseDelivery`æŠ½è±¡ç±»ï¼Œç„¶ååˆå¾—æ‰¾ä»–çš„å®ç°ç±»ï¼Œè¿™æ—¶å¤§å®¶åº”è¯¥è®°å¾—`RequestQueue()`çš„æ—¶å€™åˆå§‹åŒ–äº†ä¸€ä¸ª`Delivery`ï¼š\n\n```java\npublic RequestQueue(Cache cache, Network network, int threadPoolSize) {\n    this(\n            cache,\n            network,\n            threadPoolSize,\n            new ExecutorDelivery(new Handler(Looper.getMainLooper())));\n}\n```\nä»–è¿”å›äº†ä¸€ä¸ª`ExecutorDelivery`ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç±»ï¼Œç„¶åå°±æƒŠå–œçš„å‘ç°ï¼Œæˆ‘ä»¬ç»ˆäºæ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿äº†ï¼š\n```java\n/**\n * Creates a new response delivery interface.\n *\n * @param handler {@link Handler} to post responses on\n */\npublic ExecutorDelivery(final Handler handler) {\n    // Make an Executor that just wraps the handler.\n    mResponsePoster =\n            new Executor() {\n                @Override\n                public void execute(Runnable command) {\n                        handler.post(command);\n                }\n            };\n}\n```\nçŸ¥é“äº†å®ƒçš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°å›è°ƒçš„ï¼š\n\n`Volley`ä¸­å›è°ƒæ˜¯é€šè¿‡`postResponse()`æ–¹æ³•çš„ :\n\n```java\npublic void postResponse(Request<?> request, Response<?> response) {\n    postResponse(request, response, null);\n}\n\n@Override\npublic void postResponse(Request<?> request, Response<?> response, Runnable runnable) {\n    request.markDelivered();\n    request.addMarker(\"post-response\");\n    mResponsePoster.execute(new ResponseDeliveryRunnable(request, response, runnable));\n}\n```\n\n`postResponse()`æœ€ç»ˆä¼šè°ƒç”¨`mResponsePoster`å¯¹è±¡çš„`execute()`æ–¹æ³•ï¼Œä¼ å…¥äº†ä¸€ä¸ª`ResponseDeliveryRunnable`å¯¹è±¡ï¼Œå®ƒå®ç°äº†`Runnable`æ¥å£ï¼Œ`execute()`æ–¹æ³•ä¼šé€šè¿‡`Handler.post(runnable)`å°†`ResponseDeliveryRunnable`æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª`ResponseDeliveryRunnable`çš„`run()`æ–¹æ³•åœ¨ä¸»çº¿ç¨‹ä¸­åšäº†ä»€ä¹ˆæ“ä½œï¼š\n\n```java\n@SuppressWarnings(\"unchecked\")\n@Override\npublic void run() {\n\n    // If this request has canceled, finish it and don't deliver.\n    if (mRequest.isCanceled()) {\n        mRequest.finish(\"canceled-at-delivery\");\n        return;\n    }\n\n    if (mResponse.isSuccess()) {\n        // æ‰§è¡ŒæˆåŠŸçš„å›è°ƒï¼Œåœ¨å…·ä½“çš„Requestå®ç°ç±»ä¸­ï¼Œæ¯”å¦‚StringRequestå°±ä¼šè°ƒç”¨listener.onResponse(string)å›è°ƒ\n        mRequest.deliverResponse(mResponse.result);\n    } else {\n        // æ‰§è¡Œå¤±è´¥çš„å›è°ƒï¼Œåœ¨requestä¸­ï¼Œç›´æ¥å›è°ƒäº†listener.onErrorResponse(error)\n        mRequest.deliverError(mResponse.error);\n    }\n\n    // intermediateé»˜è®¤ä¸ºfalseï¼Œä½†æ˜¯åœ¨CacheDispatcherçš„run()ä¸­ï¼Œå¦‚æœéœ€è¦æ›´æ–°ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä¼šç½®ä¸ºtrue\n    if (mResponse.intermediate) {\n        mRequest.addMarker(\"intermediate-response\");\n    } else {\n        mRequest.finish(\"done\");\n    }\n\n    // å¦‚æœä¼ å…¥äº†runnableä¸ä¸ºç©ºï¼Œé‚£å°±å°±æ‰§è¡Œrunnable.run()æ–¹æ³•\n    // å›å¿†ä¸‹åœ¨CacheDispatcherçš„run()æ–¹æ³•ä¸­ï¼Œå¦‚æœrequestæœ‰ç¼“å­˜ï¼Œä½†æ˜¯éœ€è¦æ›´æ–°ç¼“å­˜çš„æ—¶å€™ï¼ŒmDeliveryæ˜¯ä¸æ˜¯è°ƒç”¨çš„å¸¦runnableçš„æ–¹æ³•\n    if (mRunnable != null) {\n        mRunnable.run();\n    }\n}\n```\n\n# 3 è¯·æ±‚æµç¨‹å›¾\næœ€åé™„ä¸ŠVolleyçš„è¯·æ±‚æµç¨‹å›¾\n![VolleyRequestProcess](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/23/VolleyRequestProcess.jpg)\n\n\n\n","tags":["Android","kotlin","Volley","æºç "],"categories":["Android"]},{"title":"æ“ä½œç³»ç»Ÿ2--è¿›ç¨‹çš„æè¿°å’Œæ§åˆ¶","url":"/posts/2e847144.html","content":">å¤§å®¶å¯ä»¥çœ‹ä¸‹æˆ‘ä½¿ç”¨å¹•å¸ƒè½¯ä»¶ç”»çš„[æ€ç»´å¯¼å›¾](https://mubu.com/doc/3Pf0zwzrgw)ï¼Œå¦‚æœå¤§å®¶æƒ³ä½¿ç”¨å¹•å¸ƒå¯ä»¥é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œï¼Œå¯å…è´¹è·å¾—ä¸€ä¸ªæœˆé«˜çº§ä¼šå‘˜https://mubu.com/inv/477598\n\n<!-- More -->\n[TOC]\n\n# 2.1 è¿›ç¨‹çš„æè¿°\n## 2.1.1 è¿›ç¨‹çš„å®šä¹‰å’Œç‰¹å¾\n### 2.1.1.1 è¿›ç¨‹çš„å®šä¹‰\nä¸ºäº†èƒ½å¤Ÿä½¿ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥å¯¹å¹¶å‘æ‰§è¡Œçš„ç¨‹åºåŠ ä»¥æè¿°å’Œæ§åˆ¶ï¼Œäººä»¬å¼•å…¥äº†â€œè¿›ç¨‹â€çš„æ¦‚å¿µã€‚\nä¸ºäº†ä½¿å‚ä¸å¹¶å‘æ‰§è¡Œçš„æ¯ä¸ªç¨‹åºéƒ½èƒ½ç‹¬ç«‹åœ°è¿è¡Œï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»ä¸ºä¹‹é…ç½®ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„ï¼Œç§°ä¸º**è¿›ç¨‹æ•°æ®å—ï¼ˆPCBï¼‰**ã€‚ä»–ç”¨æ¥çºªå½•è¿›ç¨‹çš„å„ç§å±æ€§ï¼Œæè¿°è¿›ç¨‹çš„åŠ¨æ€å˜åŒ–è¿‡ç¨‹ã€‚ä¸»è¦åŒ…å«æœ‰è¿›ç¨‹çš„æè¿°ä¿¡æ¯ï¼ˆè¿›ç¨‹æ ‡è¯†ç¬¦ï¼Œè¿›ç¨‹åï¼Œç”¨æˆ·æ ‡è¯†ç¬¦ï¼Œè¿›ç¨‹ç»„å…³ç³»ç­‰ï¼‰ã€è¿›ç¨‹æ§åˆ¶ä¿¡æ¯ï¼ˆå½“å‰çŠ¶æ€ï¼Œä¼˜å…ˆçº§ï¼Œä»£ç æ‰§è¡Œå…¥å£åœ°å€ï¼Œä¿å­˜çš„ç£ç›˜åœ°å€ç­‰ç­‰ï¼‰ã€æ‰€æ‹¥æœ‰çš„èµ„æºå’Œä½¿ç”¨æƒ…å†µï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´çš„çŠ¶æ€ï¼Œæ–‡ä»¶æ‰“å¼€åˆ—è¡¨ç­‰ï¼‰å’ŒCPUç°åœºä¿¡æ¯ç­‰å†…å®¹ã€‚PCBæ˜¯ç³»ç»Ÿæ„ŸçŸ¥è¿›ç¨‹å­˜åœ¨çš„å”¯ä¸€æ ‡å¿—ã€‚\næ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æŠŠè¿›ç¨‹å®ä½“å°±ç®€ç§°ä¸ºè¿›ç¨‹ï¼Œåˆ›å»ºè¿›ç¨‹ï¼Œå®è´¨ä¸Šæ˜¯åˆ›å»ºè¿›ç¨‹å®ä½“ä¸­çš„PCBï¼›æ’¤é”€è¿›ç¨‹ï¼Œå®è´¨ä¸Šæ˜¯æ’¤é”€è¿›ç¨‹çš„PCBã€‚\nå¯¹äºè¿›ç¨‹çš„å®šä¹‰ï¼Œæ¯”è¾ƒå…¸å‹çš„æœ‰ï¼š\n1. è¿›ç¨‹æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œ\n2. è¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºåŠå…¶æ•°æ®åœ¨å¤„ç†æœºä¸Šé¡ºåºæ‰§è¡Œæ—¶æ‰€å‘ç”Ÿçš„æ´»åŠ¨\n3. è¿›ç¨‹æ˜¯å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºåœ¨ä¸€ä¸ªæ•°æ®é›†åˆä¸Šè¿è¡Œçš„è¿‡ç¨‹ï¼Œå®ƒæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½\n\n### 2.1.1.2 è¿›ç¨‹çš„ç‰¹å¾\n1. ç»“æ„æ€§\nè¿›ç¨‹å®ä½“æ˜¯ç”±ç¨‹åºæ®µã€æ•°æ®æ®µåŠè¿›ç¨‹æ§åˆ¶å¿«ä¸‰éƒ¨åˆ†ç»„æˆã€‚\n2. åŠ¨æ€æ€§\nè¿›ç¨‹çš„å®è´¨æ˜¯è¿›ç¨‹å®ä½“çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè€Œä¸”è¿›ç¨‹â€œç”±åˆ›å»ºè€Œäº§ç”Ÿï¼Œç”±è°ƒåº¦è€Œæ‰§è¡Œï¼Œç”±æ’¤é”€è€Œæ¶ˆäº¡â€ã€‚\n3. å¹¶å‘æ€§\nå¤šä¸ªè¿›ç¨‹å®ä½“åŒå­˜äºå†…å­˜ä¸­ï¼Œä¸”èƒ½åœ¨ä¸€æ®µæ—¶é—´å†…åŒæ—¶è¿è¡Œã€‚\n4. ç‹¬ç«‹æ€§\nè¿›ç¨‹å®ä½“æ˜¯ä¸€ä¸ªèƒ½ç‹¬ç«‹è¿è¡Œã€ç‹¬ç«‹è·å¾—èµ„æºå’Œç‹¬ç«‹æ¥æ”¶è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚\n5. å¼‚æ­¥æ€§\nè¿›ç¨‹æ˜¯æŒ‰å¼‚æ­¥æ–¹å¼è¿è¡Œçš„ã€‚\n\n## 2.1.2 è¿›ç¨‹çš„åŸºæœ¬çŠ¶æ€åŠè½¬æ¢\n### 2.1.2.1 è¿›ç¨‹çš„ä¸‰ç§åŸºæœ¬çŠ¶æ€\nè¿›ç¨‹ä¸»è¦åˆ†ä¸ºä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼š\n1. è¿è¡Œæ€\næŒ‡è¿›ç¨‹å·²ç»è·å¾—äº†CPUï¼Œä»–æ­£åœ¨CPUä¸Šæ‰§è¡Œã€‚\n2. å°±ç»ªæ€\næŒ‡è¿›ç¨‹å·²ç»å‡†å¤‡å°±ç»ªï¼Œå‡†å¤‡å¥½äº†è¢«CPUæ‰§è¡Œçš„çŠ¶æ€ã€‚å¦‚æœç³»ç»Ÿä¸­æœ‰å¾ˆå¤šå¤„äºå°±ç»ªæ€çš„è¿›ç¨‹ï¼Œé€šå¸¸æŠŠä»–ä»¬æŒ‰ä¸€å®šçš„ç­–ç•¥æ’æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ç§°ä¸ºå°±ç»ªé˜Ÿåˆ—ã€‚\n3. ç­‰å¾…æ€\næŒ‡æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ç”±äºå‘ç”ŸæŸäº‹ä»¶ï¼ˆå¦‚I/Oè¯·æ±‚ã€ç”³è¯·ç¼“å†²åŒºå¤±è´¥ç­‰é—®é¢˜ï¼‰æš‚æ—¶æ— æ³•ç»§ç»­æ‰§è¡Œæ—¶çš„çŠ¶æ€ã€‚æ­¤æ—¶å¼•èµ·è¿›ç¨‹è°ƒåº¦ï¼ŒOSæŠŠå¤„ç†æœºåˆ†é…ç»™å°±ç»ªä¸­çš„è¿›ç¨‹ï¼Œè®©å—é˜»çš„è¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚\n\n### 2.1.2.2 ä¸‰ç§çŠ¶æ€çš„è½¬æ¢\n![ä¸‰ç§çŠ¶æ€çš„è½¬æ¢](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/20/UntitledDiagram.jpg)\n\n### 2.1.2.3 åˆ›å»ºçŠ¶æ€å’Œç»ˆæ­¢çŠ¶æ€\nä¸ºäº†æ»¡è¶³è¿›ç¨‹æ§åˆ¶å—å¯¹æ•°æ®åŠæ“ä½œçš„å®Œæ•´æ€§è¦æ±‚ä»¥åŠå¢å¼ºç®¡ç†çš„çµæ´»æ€§ï¼Œé€šå¸¸åœ¨ç³»ç»Ÿä¸­åˆä¸ºè¿›ç¨‹å¼•å…¥äº†ä¸¤ç§å¸¸è§çš„çŠ¶æ€ï¼šåˆ›å»ºçŠ¶æ€å’Œç»ˆæ­¢çŠ¶æ€ã€‚\n![äº”ç§çŠ¶æ€è½¬æ¢](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/20/wuzhongzhuangtaizhuanhuan.png)\n\n## 2.1.3 è¿›ç¨‹ç®¡ç†ä¸­çš„æ•°æ®ç»“æ„\nåœ¨æœ€å¼€å§‹æˆ‘å·²ç»ç»æåˆ°äº†è¿›ç¨‹æ§åˆ¶å—PCBè¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æˆ‘ä»¬å°±è¿›ä¸€æ­¥æ¥äº†è§£ä»–ã€‚\n### 2.1.3.1 è¿›ç¨‹æ§åˆ¶å—ä¸­çš„ä½œç”¨\nPCBçš„ä½œç”¨ä¸»è¦å°±æ˜¯ä½¿ä¸€ä¸ªåœ¨å¤šé“ç¨‹åºç¯å¢ƒä¸‹ä¸èƒ½ç‹¬ç«‹è¿è¡Œçš„ç¨‹åºç§°ä¸ºä¸€ä¸ªèƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ªèƒ½ä¸å…¶å®ƒè¿›ç¨‹å¹¶å‘æ‰§è¡Œçš„è¿›ç¨‹ã€‚\n1. ä½œä¸ºç‹¬ç«‹è¿è¡ŒåŸºæœ¬å•ä½çš„æ ‡å¿—ã€‚\n    å½“ä¸€ä¸ªç¨‹åºé…ç½®äº†PCBä¹‹åï¼Œå°±è¡¨ç¤ºä»–å·²æ˜¯ä¸€ä¸ªèƒ½åœ¨å¤šé“ç¨‹åºç¯å¢ƒä¸‹ç‹¬ç«‹è¿è¡Œçš„ã€åˆæ³•çš„åŸºæœ¬å•ä½ï¼Œä¹Ÿå°±å…·æœ‰å–å¾—OSæœåŠ¡çš„æƒåˆ©ã€‚å½“ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹çš„æ—¶å€™ï¼Œå°±ä¸ºä»–åˆ›å»ºäº†ä¸€ä¸ªPCBï¼Œè¿›ç¨‹ç»“æŸåæ”¶å›PCBã€‚\n2. èƒ½å®ç°é—´æ–­æ€§è¿è¡Œæ–¹å¼ã€‚\n    åœ¨å¤šé“ç¨‹åºè¿è¡Œç¯å¢ƒä¸‹ï¼Œç”±äºå­˜åœ¨æ—¶é—´ç‰‡æˆ–è€…æœ‰ç­‰å¾…I/Oè¯·æ±‚çš„æƒ…å†µï¼Œæ‰€ä»¥è¿›ç¨‹ä¸€èˆ¬éƒ½æ˜¯å‡ºäºèµ°èµ°åœåœçš„çŠ¶æ€ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹è¢«é˜»å¡çš„æ—¶å€™ï¼Œä»–åº”è¯¥æœ‰ä¸€ç§èƒ½ä¿å­˜å½“å‰è¿è¡ŒçŠ¶æ€çš„èƒ½åŠ›ä¹Ÿå°±æ˜¯ä¿æŠ¤ç°åœºæœºåˆ¶ï¼Œæ–¹ä¾¿åœ¨æ­¤è¢«è°ƒåº¦æ‰§è¡Œæ—¶æ¢å¤é˜»å¡å‰çš„çŠ¶æ€ã€‚æ‰€ä»¥å°±éœ€è¦åœ¨PCBé‡Œé¢æä¾›ä¸€ä¸ªæ•°æ®ç»“æ„æ¥ä¿å­˜è¯¥è¿›ç¨‹è¢«ä¸­æ–­æ—¶çš„ä¸€äº›ä¿¡æ¯ã€‚\n3. æä¾›è¿›ç¨‹ç®¡ç†æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚\n    è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´å§ã€‚\n4. æä¾›è¿›ç¨‹è°ƒåº¦æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚\n    åªæœ‰å¤„äºå°±ç»ªçŠ¶æ€çš„è¿›ç¨‹æ‰èƒ½è¢«è°ƒåº¦æ‰§è¡Œï¼Œè€Œåœ¨PCBä¸­å°±æä¾›äº†è¿›ç¨‹å¤„äºä½•ç§çŠ¶æ€çš„ä¿¡æ¯ã€‚\n5. å®ç°ä¸å…¶å®ƒè¿›ç¨‹çš„åŒæ­¥ä¸é€šä¿¡ã€‚\n    \n### 2.1.3.2 è¿›ç¨‹æ§åˆ¶å—ä¸­çš„ä¿¡æ¯\næ ¹æ®ä¸Šé¢è¿›ç¨‹æ§åˆ¶å—ä½œç”¨çš„æè¿°ï¼Œå¯¹åº”çš„è¿›ç¨‹æ§åˆ¶å—ä¸­å°±éœ€è¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ã€‚\n1. è¿›ç¨‹æ ‡è¯†ç¬¦\n    è¿›ç¨‹æ ‡è¯†ç¬¦ç”¨äºå”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè¿›ç¨‹ã€‚ä¸€ä¸ªè¿›ç¨‹é€šå¸¸å…·æœ‰ä¸¤ç§æ ‡è¯†ç¬¦ï¼š\n    1. å¤–éƒ¨æ ‡è¯†ç¬¦\n        ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ï¼ˆè¿›ç¨‹ï¼‰å¯¹è¿›ç¨‹çš„è®¿é—®ï¼Œè¿›ç¨‹éœ€è¦æä¾›ä¸€ä¸ªç”¨äºç”¨æˆ·ï¼ˆè¿›ç¨‹ï¼‰è®¿é—®çš„æ ‡è¯†ç¬¦ã€‚\n    2. å†…éƒ¨æ ‡è¯†ç¬¦\n        ä¸ºäº†æ–¹ä¾¿ç³»ç»Ÿå¯¹è¿›ç¨‹çš„ä½¿ç”¨ï¼Œåœ¨OSä¸­åˆä¸ºè¿›ç¨‹è®¾ç½®äº†å†…éƒ¨æ ‡è¯†ç¬¦ã€‚é€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„åºå·ã€‚\n2. å¤„ç†æœºçŠ¶æ€\n    å¤„ç†æœºçŠ¶æ€ä¿¡æ¯ä¹Ÿç§°ä¸ºå¤„ç†æœºçš„ä¸Šä¸‹æ–‡ï¼Œä¸»è¦æ˜¯ç”±å¤„ç†æœºçš„å„ç§å¯„å­˜å™¨ä¸­çš„å†…å®¹ç»„æˆçš„ã€‚è¿™äº›å¯„å­˜å™¨ä¿¡æ¯åŒ…æ‹¬é€šç”¨å¯„å­˜å™¨ã€æŒ‡ä»¤å¯„å­˜å™¨ã€ç¨‹åºçŠ¶æ€å­—PSWå’Œç”¨æˆ·æ ˆæŒ‡é’ˆã€‚\n3. è¿›ç¨‹è°ƒåº¦ä¿¡æ¯\n    åœ¨OSè¿›è¡Œè°ƒåº¦çš„æ—¶å€™ï¼Œå¿…é¡»äº†è§£è¿›ç¨‹çš„çŠ¶æ€åŠæœ‰å…³è¿›ç¨‹è°ƒåº¦çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åŒ…æ‹¬ï¼šè¿›ç¨‹çŠ¶æ€ã€è¿›ç¨‹ä¼˜å…ˆçº§ã€è¿›ç¨‹è°ƒåº¦æ‰€éœ€å…¶ä»–ä¿¡æ¯ï¼ˆä¸æ‰€é‡‡ç”¨çš„çš„è°ƒåº¦ç®—æ³•æœ‰å…³ï¼‰å’Œäº‹ä»¶ï¼ˆé˜»å¡åŸå› ï¼‰ã€‚\n4. è¿›ç¨‹æ§åˆ¶ä¿¡æ¯\n    ç”¨äºè¿›ç¨‹æ§åˆ¶æ‰€å¿…é¡»çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šç¨‹åºå’Œæ•°æ®çš„åœ°å€ã€è¿›ç¨‹åŒæ­¥å’Œé€šä¿¡æœºåˆ¶ã€èµ„æºæ¸…å•å’Œé“¾æ¥æŒ‡é’ˆã€‚\n\n### 2.1.3.3 è¿›ç¨‹æ§åˆ¶å—çš„ç»„ç»‡æ–¹å¼\nä¸€ä¸ªç³»ç»Ÿä¸­æœ‰å¾ˆå¤šä¸ªPCBï¼Œä¸ºäº†å¯¹ä»–ä»¬è¿›è¡Œæœ‰æ•ˆçš„ç®¡ç†ï¼Œåº”è¯¥ç”¨é€‚å½“çš„æ–¹å¼å°†è¿™äº›PCBç»„ç»‡èµ·æ¥ï¼Œå¸¸ç”¨çš„ç»„ç»‡æ–¹å¼æœ‰ä¸‰ç§\n1. çº¿æ€§æ–¹å¼\nç›´æ¥å°†æ‰€æœ‰PCBæ”¾åœ¨ä¸€å¼ çº¿æ€§è¡¨ä¸­ï¼Œä¼˜ç‚¹æ˜¯ç®€å•ï¼Œå¼€é”€å°ï¼Œä½†æ˜¯æ¯æ¬¡æŸ¥æ‰¾èµ·æ¥å¾ˆéº»çƒ¦ã€‚\n![linedPCB](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/21/linedPCB.jpg)\n\n2. é“¾æ¥æ–¹å¼\næŠŠå…·æœ‰ç›¸åŒçŠ¶æ€çš„PCBåˆ†åˆ«é€šè¿‡PCBä¸­çš„é“¾æ¥å­—é“¾æ¥æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚\n![linkedPCB](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/21/linkedPCB.png)\n\n3. ç´¢å¼•æ–¹å¼\næ ¹æ®æ‰€æœ‰è¿›ç¨‹çŠ¶æ€çš„ä¸åŒå»ºç«‹å‡ å¼ ç´¢å¼•è¡¨ï¼Œå¹¶æŠŠä¸ªç´¢å¼•è¡¨åœ¨å†…å­˜çš„é¦–åœ°å€çºªå½•åœ¨å†…å­˜çš„ä¸€äº›ä¸“ç”¨å•å…ƒä¸­ã€‚\n![indexPCB](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/21/indexPCB.png)\n\n# 2.2 è¿›ç¨‹æ§åˆ¶\n## 2.2.1 è¿›ç¨‹çš„å±‚æ¬¡ç»“æ„\nåœ¨OSä¸­ï¼Œå…è®¸ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œé€šå¸¸æŠŠåˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œè¢«åˆ›å»ºçš„è¿›ç¨‹ç§°ä¸ºå­è¿›ç¨‹ã€‚ç„¶åå­è¿›ç¨‹å¯ä»¥ä½œä¸ºçˆ¶è¿›ç¨‹ç»§ç»­å»åˆ›å»ºå­è¿›ç¨‹ï¼Œè¿›è€Œå½¢æˆä¸€ä¸ªè¿›ç¨‹å®¶æ—ã€‚\n## 2.2.2 è¿›ç¨‹çš„åˆ›å»º\næ¯å½“å‡ºç°äº†åˆ›å»ºæ–°è¿›ç¨‹çš„è¯·æ±‚åï¼ŒOSä¾¿è°ƒç”¨è¿›ç¨‹åˆ›å»ºåŸè¯­CreatæŒ‰ä¸‹è¿°æ­¥éª¤åˆ›å»ºæ–°è¿›ç¨‹ï¼š\n1. ç”³è¯·ç©ºç™½PCBï¼Œä¸ºæ–°è¿›ç¨‹ç”³è¯·è·å¾—å”¯ä¸€çš„æ•°å­—æ ‡è¯†ç¬¦ï¼Œå¹¶ä»PCBé›†åˆä¸­ç´¢å–ä¸€ä¸ªç©ºç™½PCBã€‚\n2. ä¸ºæ–°è¿›ç¨‹åˆ†é…å…¶è¿è¡Œæ‰€éœ€çš„èµ„æºï¼ŒåŒ…æ‹¬å„ç§ç‰©ç†å’Œé€»è¾‘èµ„æºã€‚\n3. åˆå§‹åŒ–è¿›ç¨‹æ§åˆ¶å—PCBã€‚\n4. å¦‚æœè¿›ç¨‹å°±ç»ªé˜Ÿåˆ—èƒ½å¤Ÿæ¥çº³æ–°è¿›ç¨‹ï¼Œä¾¿å°†æ–°è¿›ç¨‹æ’å…¥å°±ç»ªé˜Ÿåˆ—ã€‚\n\n## 2.2.3 è¿›ç¨‹çš„ç»ˆæ­¢\n1. æ ¹æ®è¢«ç»ˆæ­¢è¿›ç¨‹çš„æ ‡è¯†ç¬¦ï¼Œä»PCBé›†åˆä¸­æ£€ç´¢å‡ºè¿›ç¨‹çš„PCBï¼Œä»ä¸­è¯»å‡ºè¯¥è¿›ç¨‹çš„çŠ¶æ€ã€‚\n2. è‹¥è¢«ç»ˆæ­¢è¿›ç¨‹æ­£å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œåº”ç«‹å³ç»ˆæ­¢è¯¥è¿›ç¨‹çš„æ‰§è¡Œï¼Œå¹¶ç½®è°ƒåº¦æ ‡å¿—ä½çœŸï¼Œç”¨äºæŒ‡ç¤ºè¯¥è¿›ç¨‹è¢«ç»ˆæ­¢ååº”é‡æ–°è¿›è¡Œè°ƒåº¦ã€‚\n3. è‹¥è¯¥è¿›ç¨‹è¿˜æœ‰å­å­™è¿›ç¨‹ï¼Œè¿˜åº”å°†å…¶æ‰€æœ‰å­å­™è¿›ç¨‹ä¹Ÿéƒ½äºˆä»¥ç»ˆæ­¢ï¼Œä»¥é˜²å®ƒä»¬ç§°ä¸ºä¸å¯æ§çš„è¿›ç¨‹ã€‚\n4. å°†è¢«ç»ˆæ­¢è¿›ç¨‹æ‰€æ‹¥æœ‰çš„çš„å…¨éƒ¨èµ„æºæˆ–è€…å½’è¿˜ç»™å…¶çˆ¶è¿›ç¨‹ï¼Œæˆ–è€…å½’è¿˜ç»™ç³»ç»Ÿã€‚\n5. å°†è¢«ç»ˆæ­¢è¿›ç¨‹ï¼ˆPCBï¼‰ä»æ‰€åœ¨é˜Ÿåˆ—ï¼ˆæˆ–é“¾è¡¨ï¼‰ä¸­ç§»å‡ºï¼Œç­‰å¾…å…¶ä»–ç¨‹åºæ¥æœé›†ä¿¡æ¯ã€‚\n\n","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"æ“ä½œç³»ç»Ÿ1--æ“ä½œç³»ç»Ÿæ¦‚è¿°","url":"/posts/62248b34.html","content":">å¤§å®¶å¯ä»¥çœ‹ä¸‹æˆ‘ä½¿ç”¨å¹•å¸ƒè½¯ä»¶ç”»çš„[æ€ç»´å¯¼å›¾](https://mubu.com/doc/3Pf0zwzrgw)ï¼Œå¦‚æœå¤§å®¶æƒ³ä½¿ç”¨å¹•å¸ƒå¯ä»¥é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œï¼Œå¯å…è´¹è·å¾—ä¸€ä¸ªæœˆé«˜çº§ä¼šå‘˜https://mubu.com/inv/477598\n\n<!-- More -->\n# ç°å¦‚ä»Šä¸»æµçš„æ“ä½œç³»ç»Ÿ\n\n## 1.1.1 PC\n\n### 1.1.1.1 Windows\nMicrosoft Windowsæ˜¯å¾®è½¯å…¬å¸æ¨å‡ºçš„ä¸€ç³»åˆ—æ“ä½œç³»ç»Ÿã€‚å…¶é—®ä¸–æ—¶é—´ä¸º1985å¹´ï¼Œèµ·åˆä¸ºè¿è¡ŒäºMS-DOSä¹‹ä¸‹çš„æ¡Œé¢ç¯å¢ƒï¼Œå…¶åç»­ç‰ˆæœ¬é€æ¸å‘å±•æˆä¸ºä¸»è¦ä¸ºä¸ªäººè®¡ç®—æœºå’ŒæœåŠ¡å™¨ç”¨æˆ·è®¾è®¡çš„æ“ä½œç³»ç»Ÿï¼Œå¹¶æœ€ç»ˆè·å¾—äº†ä¸–ç•Œä¸ªäººè®¡ç®—æœºæ“ä½œç³»ç»Ÿçš„å„æ–­åœ°ä½ã€‚æ­¤æ“ä½œç³»ç»Ÿå¯ä»¥åœ¨å‡ ç§ä¸åŒç±»å‹çš„å¹³å°ä¸Šè¿è¡Œï¼Œå¦‚ä¸ªäººè®¡ç®—æœºã€ç§»åŠ¨è®¾å¤‡ã€æœåŠ¡å™¨å’ŒåµŒå…¥å¼ç³»ç»Ÿç­‰ç­‰ï¼Œå…¶ä¸­åœ¨ä¸ªäººè®¡ç®—æœºçš„é¢†åŸŸåº”ç”¨å†…æœ€ä¸ºæ™®éã€‚\nWindowsæ“ä½œç³»ç»Ÿå½“å‰æœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯äº2015å¹´7æœˆ29æ—¥å‘å¸ƒçš„ Windows 10ã€‚Windows Serverå½“å‰æœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯2018å¹´10æœˆ2æ—¥å‘å¸ƒçš„Windows Server 2019ã€‚Windows Phoneå½“å‰æœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯Windows10 Mobileï¼Œä½†æ˜¯å·²åœæ­¢å¼€å‘æ–°ç‰ˆæœ¬ï¼Œä»…å¯¹ç°æœ‰ç‰ˆæœ¬è¿›è¡Œå®‰å…¨è¡¥ä¸å’Œç»´æŠ¤ï¼Œç›´åˆ°2019å¹´12æœˆã€‚\n### 1.1.1.2 macOS\nmacOSï¼ˆ2011å¹´åŠä¹‹å‰ç§°Mac OS Xï¼Œ2012å¹´è‡³2015å¹´ç§°OS Xï¼‰æ˜¯è‹¹æœå…¬å¸æ¨å‡ºçš„åŸºäºå›¾å½¢ç”¨æˆ·ç•Œé¢æ“ä½œç³»ç»Ÿï¼Œä¸ºéº¦é‡‘å¡”ï¼ˆMacintoshï¼‰çš„ä¸»æ“ä½œç³»ç»Ÿã€‚StatCounteråœ¨2018å¹´8æœˆçš„æ•°æ®è¡¨ç¤ºï¼Œåœ¨æ¡Œé¢æ“ä½œç³»ç»Ÿä¸­ï¼ŒmacOSçš„ä½¿ç”¨ä»½é¢ä¸º12.65%ï¼Œæ¬¡äºWindowsçš„82.51%ä½å±…ç¬¬äºŒã€‚\nmacOSå½“å‰æœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯2018å¹´9æœˆ25æ—¥å‘å¸ƒçš„macOS 10.14 Mojaveï¼Œ2019å¹´6æœˆ4æ—¥æ¨å‡ºmacOS 10.15 Catalinaçš„ç¬¬ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬ã€‚\n### 1.1.1.3 Linux\nLinuxæ˜¯ä¸€ç§è‡ªç”±å’Œå¼€æ”¾æºç çš„ç±»UNIX æ“ä½œç³»ç»Ÿã€‚è¯¥æ“ä½œç³»ç»Ÿçš„å†…æ ¸ç”±æ—çº³æ–¯Â·æ‰˜ç“¦å…¹åœ¨1991å¹´10æœˆ5æ—¥é¦–æ¬¡å‘å¸ƒï¼Œåœ¨åŠ ä¸Šç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºä¹‹åï¼Œæˆä¸º Linux æ“ä½œç³»ç»Ÿã€‚Linuxä¹Ÿæ˜¯è‡ªç”±è½¯ä»¶å’Œå¼€æ”¾æºä»£ç è½¯ä»¶å‘å±•ä¸­æœ€è‘—åçš„ä¾‹å­ã€‚åªè¦éµå¾ª GNU é€šç”¨å…¬å…±è®¸å¯è¯ï¼ˆGPLï¼‰ï¼Œä»»ä½•ä¸ªäººå’Œæœºæ„éƒ½å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨ Linux çš„æ‰€æœ‰åº•å±‚æºä»£ç ï¼Œä¹Ÿå¯ä»¥è‡ªç”±åœ°ä¿®æ”¹å’Œå†å‘å¸ƒã€‚å¤§å¤šæ•° Linux ç³»ç»Ÿè¿˜åŒ…æ‹¬åƒæä¾› GUI çš„ X Window ä¹‹ç±»çš„ç¨‹åºã€‚é™¤äº†ä¸€éƒ¨åˆ†ä¸“å®¶ä¹‹å¤–ï¼Œå¤§å¤šæ•°äººéƒ½æ˜¯ç›´æ¥ä½¿ç”¨ Linux å‘è¡Œç‰ˆï¼Œè€Œä¸æ˜¯è‡ªå·±é€‰æ‹©æ¯ä¸€æ ·ç»„ä»¶æˆ–è‡ªè¡Œè®¾ç½®ã€‚\n### 1.1.1.4 Unix\nUNIXæ“ä½œç³»ç»Ÿï¼ˆå°¤å°¼æ–¯ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¤šç”¨æˆ·ã€å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å¤„ç†å™¨æ¶æ„ï¼ŒæŒ‰ç…§æ“ä½œç³»ç»Ÿçš„åˆ†ç±»ï¼Œå±äºåˆ†æ—¶æ“ä½œç³»ç»Ÿï¼Œæœ€æ—©ç”±KenThompsonã€Dennis Ritchieå’ŒDouglas McIlroyäº1969å¹´åœ¨AT&Tçš„è´å°”å®éªŒå®¤å¼€å‘ã€‚å®ƒçš„å•†æ ‡æƒç”±å›½é™…å¼€æ”¾æ ‡å‡†ç»„ç»‡æ‰€æ‹¥æœ‰ï¼Œåªæœ‰ç¬¦åˆå•ä¸€UNIXè§„èŒƒçš„UNIXç³»ç»Ÿæ‰èƒ½ä½¿ç”¨UNIXè¿™ä¸ªåç§°ï¼Œå¦åˆ™åªèƒ½ç§°ä¸ºç±»UNIXï¼ˆUNIX-likeï¼‰ã€‚\n## 1.1.2 ç§»åŠ¨ç«¯\n\n### 1.1.2.1 Android\nAndroidï¼Œå¸¸è§çš„éå®˜æ–¹ä¸­æ–‡åç§°ä¸ºå®‰å“ï¼Œæ˜¯ä¸€ä¸ªåŸºäºLinuxå†…æ ¸çš„å¼€æ”¾æºä»£ç ç§»åŠ¨æ“ä½œç³»ç»Ÿï¼Œç”±Googleæˆç«‹çš„Open Handset AllianceæŒç»­é¢†å¯¼ä¸å¼€å‘ï¼Œä¸»è¦è®¾è®¡ç”¨äºè§¦æ‘¸å±ç§»åŠ¨è®¾å¤‡å¦‚æ™ºèƒ½æ‰‹æœºå’Œå¹³æ¿ç”µè„‘ä¸å…¶ä»–ä¾¿æºå¼è®¾å¤‡ã€‚\nAndroid Inc.äº2003å¹´10æœˆç”±å®‰è¿ªÂ·é²å®¾ã€åˆ©å¥‡Â·ç±³çº³å°”ã€å°¼å…‹Â·å¸­å°”æ–¯ã€å…‹é‡Œæ–¯Â·æ€€ç‰¹åœ¨åŠ å·å¸•ç½—å¥¥å›¾åˆ›å»ºã€‚Androidæœ€åˆç”±å®‰è¿ªÂ·é²å®¾ç­‰äººå¼€å‘åˆ¶ä½œï¼Œæœ€åˆå¼€å‘è¿™ä¸ªç³»ç»Ÿçš„æ—©æœŸæ–¹å‘æ˜¯åˆ›å»ºä¸€ä¸ªæ•°å­—ç›¸æœºçš„å…ˆè¿›æ“ä½œç³»ç»Ÿï¼Œä½†æ˜¯åæ¥å‘ç°å¸‚åœºéœ€æ±‚ä¸å¤Ÿå¤§ï¼ŒåŠ ä¸Šæ™ºèƒ½æ‰‹æœºå¸‚åœºå¿«é€Ÿæˆé•¿ï¼Œäºæ˜¯Androidæˆä¸ºä¸€æ¬¾é¢å‘æ™ºèƒ½æ‰‹æœºçš„æ“ä½œç³»ç»Ÿã€‚äº2005å¹´7æœˆ11æ—¥Android Inc.è¢«ç¾å›½ç§‘æŠ€ä¼ä¸šGoogleæ”¶è´­ã€‚\n2017å¹´3æœˆï¼ŒAndroidå…¨çƒç½‘ç»œæµé‡å’Œè®¾å¤‡è¶…è¶ŠMicrosoft Windowsï¼Œæ­£å¼æˆä¸ºå…¨çƒç¬¬ä¸€å¤§æ“ä½œç³»ç»Ÿã€‚\n### 1.1.2.2 iOS\niOSï¼ˆåŸåä¸ºiPhone OSï¼‰æ˜¯è‹¹æœå…¬å¸ä¸ºå…¶ç§»åŠ¨è®¾å¤‡æ‰€å¼€å‘çš„ä¸“æœ‰ç§»åŠ¨æ“ä½œç³»ç»Ÿï¼Œä¸ºå…¶å…¬å¸çš„è®¸å¤šç§»åŠ¨è®¾å¤‡æä¾›æ“ä½œç•Œé¢ï¼Œæ”¯æŒè®¾å¤‡åŒ…æ‹¬iPhoneã€iPadå’ŒiPod touchã€‚iPhone OSè‡ªiOS 4èµ·ä¾¿æ”¹åä¸ºiOSï¼Œå®ƒæ˜¯ç»§Androidåå…¨çƒç¬¬äºŒå¤§æœ€å—æ¬¢è¿çš„ç§»åŠ¨æ“ä½œç³»ç»Ÿï¼Œå¸‚å ç‡å·²ä¸Šå‡è‡³çº¦24.5% ï¼Œä½†ä»è¿œä½äºGoogleå¼€å‘çš„Androidç³»ç»Ÿçš„72.2%ã€‚\n\n# 1.2 æ“ä½œç³»ç»Ÿçš„ç®€ä»‹ä¸ä½œç”¨\n\n## 1.2.1 æ“ä½œç³»ç»Ÿçš„ç®€ä»‹\næ“ä½œç³»ç»Ÿæ˜¯é…ç½®åœ¨è®¡ç®—æœºç¡¬ä»¶ä¸Šçš„ç¬¬ä¸€å±‚è½¯ä»¶ï¼Œæ˜¯å¯¹ç¡¬ä»¶ç³»ç»Ÿçš„é¦–æ¬¡æ‰©å……ã€‚ä¸»è¦ä½œç”¨æ˜¯å¯¹ç®¡ç†å¥½è®¡ç®—æœºç¡¬ä»¶è®¾å¤‡ï¼Œæé«˜ä»–ä»¬çš„åˆ©ç”¨ç‡å’Œç³»ç»Ÿçš„ååé‡ï¼Œå¹¶ä¸ºç”¨æˆ·å’Œåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªç®€å•æ¥å£ï¼Œä¾¿äºç”¨æˆ·ä½¿ç”¨ã€‚\n\n## 1.2.2 æ“ä½œç³»ç»Ÿçš„ç›®çš„\n1. æ–¹ä¾¿æ€§\n    å¦‚æœä¸€ä¸ªè®¡ç®—æœºæ²¡æœ‰OSï¼Œé‚£ä¹ˆä»–ä¼šéå¸¸éš¾ç”¨ã€‚ç”¨æˆ·ä¸ç®¡è¿›è¡Œå•¥æ“ä½œéƒ½å¾—é€šè¿‡æœºå™¨è¯­è¨€ç¼–å†™ç¨‹åºç„¶åè¿è¡Œï¼Œè€Œå¦‚æœæœ‰OSçš„è¯ï¼Œç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨å„ç§å„æ ·çš„è¯­è¨€ç¼–å†™ç¨‹åºï¼Œç„¶åé€šè¿‡ç¼–è¯‘å°†é«˜çº§è¯­è¨€ç¼–è¯‘æˆæœºå™¨ä»£ç ï¼Œæ–¹ä¾¿äº†ç”¨æˆ·ã€‚\n2. æœ‰æ•ˆæ€§\n    æœ‰æ•ˆæ€§åˆ†ä¸¤å±‚å«ä¹‰â€”â€”æé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡å’Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚æ—©æœŸæ²¡æœ‰OSçš„è®¡ç®—æœºä¸­ï¼Œå¤„ç†æœºå’ŒI/Oè®¾å¤‡ç­‰ç»å¸¸å¤„äºç©ºé—²çŠ¶æ€ï¼Œå„ç§èµ„æºä¸èƒ½å¾—åˆ°åˆç†åˆ©ç”¨ï¼Œæ‰€ä»¥æé«˜ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡æ˜¯æ¨åŠ¨OSå‘å±•çš„ä¸»è¦åŠ¨åŠ›ã€‚å¦ä¸€æ–¹é¢ï¼ŒOSå¯ä»¥é€šè¿‡åˆç†ç»„ç»‡è®¡ç®—æœºçš„å·¥ä½œæµç¨‹ï¼ŒåŠ é€Ÿç¨‹åºçš„è¿è¡Œï¼Œç¼©çŸ­ç¨‹åºçš„è¿è¡Œå‘¨æœŸï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚\n3. å¯æ‰©å……æ€§\n    ä¸ºäº†é€‚åº”ç°åœ¨è¶Šæ¥è¶Šå¤šçš„è®¡ç®—æœºç¡¬ä»¶ä»¥åŠä½“ç³»ç»“æ„ï¼ŒOSå¿…ä¿®æœ‰è‰¯å¥½çš„å¯æ‰©å……æ€§ã€‚\n4. å¼€æ”¾æ€§\n    OSéœ€è¦éµå¾ªä¸–ç•Œæ ‡å‡†è§„èŒƒï¼Œå‡¡éµå¾ªå›½é™…æ ‡å‡†æ‰€å¼€å‘çš„ç¡¬ä»¶å’Œè½¯ä»¶éƒ½èƒ½å½¼æ­¤å…¼å®¹ï¼Œæ–¹ä¾¿åœ°å®ç°äº’è”ã€‚\n\n## 1.2.3 æ“ä½œç³»ç»Ÿçš„ä½œç”¨\n1. OSä½œä¸ºç”¨æˆ·ä¸è®¡ç®—æœºç¡¬ä»¶ç³»ç»Ÿä¹‹é—´çš„æ¥å£\n    OSå¤„äºç”¨æˆ·å’Œç¡¬ä»¶ä¹‹é—´ï¼Œæ–¹ä¾¿ç”¨æˆ·é€šè¿‡OSä½¿ç”¨ç¡¬ä»¶ã€‚æˆ–è€…è¯´ï¼Œç”¨æˆ·åœ¨OSçš„å¸®åŠ©ä¸‹èƒ½å¤Ÿæ–¹ä¾¿ã€å¿«æ·ã€å¯é åœ°æ“çºµè®¡ç®—æœºç¡¬ä»¶å’Œè¿è¡Œè‡ªå·±çš„ç¨‹åºã€‚\n2. OSä½œä¸ºè®¡ç®—æœºç³»ç»Ÿèµ„æºçš„ç®¡ç†è€…\n    è®¡ç®—æœºç³»ç»Ÿèµ„æºä¸»è¦å¯åˆ†ä¸ºå¤„ç†æœºã€å­˜å‚¨å™¨ã€I/Oè®¾å¤‡ä»¥åŠæ–‡ä»¶ã€‚OSä¸»è¦åŠŸèƒ½ä¹Ÿå°±æ˜¯å¯¹è¿™å››ç±»èµ„æºè¿›è¡Œæœ‰æ•ˆçš„ç®¡ç†ã€‚å¤„ç†æœºç®¡ç†æ˜¯ç”¨äºåˆ†é…å’Œæ§åˆ¶å¤„ç†æœºï¼›å­˜å‚¨å™¨ç®¡ç†ä¸»è¦è´Ÿè´£å†…å­˜çš„åˆ†é…ä¸å›æ”¶ï¼›I/Oè®¾å¤‡ç®¡ç†æ˜¯è´Ÿè´£I/Oè®¾å¤‡çš„åˆ†é…ä¸æ“çºµï¼›æ–‡ä»¶ç®¡ç†æ˜¯ç”¨äºå®ç°å¯¹æ–‡ä»¶çš„å­˜å–ã€å…±äº«å’Œä¿æŠ¤ã€‚\n3. OSå®ç°äº†å¯¹è®¡ç®—æœºèµ„æºçš„æŠ½è±¡\n    åœ¨è£¸æœºä¸­ï¼Œç”¨æˆ·å¦‚æœæƒ³è¦å¯¹è®¡ç®—å™¨è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å¯¹ç‰©ç†æ¥å£çš„å®ç°ç»†èŠ‚æœ‰å……åˆ†çš„äº†è§£ã€‚ä½†åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·å¹¶ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ç‰©ç†ï¼Œè€Œç”±æ“ä½œç³»ç»Ÿæ¥å®ç°å…·ä½“çš„æ“ä½œç»†èŠ‚ï¼Œå¹¶å‘ä¸Šè®²æ“ä½œè®¾å¤‡æŠ½è±¡ä¸ºä¸€ç»„æ•°æ®ç»“æ„ä»¥åŠä¸€ç»„æ“ä½œå‘½ä»¤ã€‚æ­¤æ—¶åœ¨ç”¨æˆ·çœ¼é‡Œï¼Œçœ‹åˆ°çš„æ˜¯ä¸€å°æ¯”è£¸æœºåŠŸèƒ½æ›´å¼ºï¼Œä½¿ç”¨æ›´æ–¹ä¾¿çš„æœºå™¨ã€‚\n\n## 1.2.4 æ¨åŠ¨æ“ä½œç³»ç»Ÿå‘å±•çš„ä¸»è¦åŠ¨åŠ›\n1. ä¸æ–­æé«˜è®¡ç®—æœºèµ„æºåˆ©ç”¨ç‡\n2. æ–¹ä¾¿ç”¨æˆ·\n3. å™¨ä»¶çš„ä¸æ–­æ›´æ–°æ¢ä»£\n4. è®¡ç®—æœºä½“ç³»ç»“æ„çš„ä¸æ–­å‘å±•\n5. ä¸æ–­æå‡ºæ–°çš„åº”ç”¨éœ€æ±‚\n\n# 1.3 æ“ä½œç³»ç»Ÿçš„å‘å±•\n\n## 1.3.1 å•é“æ‰¹å¤„ç†ç³»ç»Ÿ\nåœ¨è¯´å•é“æ‰¹å¤„ç†ä¹‹å‰ç°è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µâ€”â€”ä½œä¸šã€‚ä½œä¸šåŒ…æ‹¬ç”¨æˆ·ç¨‹åºã€æ•°æ®ã€ä½œä¸šè¯´æ˜ä¹¦ã€‚è¿™æ ·æ¯ä¸€ä¸ªå¤„ç†å¯¹è±¡éƒ½æ˜¯ä½œä¸šã€‚\n### 1. å¤„ç†è¿‡ç¨‹\næ¯ä¸ªå•é“æ‰¹å¤„ç†ç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªç³»ç»Ÿæ“ä½œå‘˜ã€‚ç”¨æˆ·å…ˆå°†ä½œä¸šäº¤ç»™ç³»ç»Ÿæ“ä½œå‘˜ï¼Œç„¶åæ“ä½œç³»ç»Ÿæ“ä½œå‘˜å°±å°†ä¸€ä¸ªä¸ªä½œä¸šç»„æˆä¸€æ‰¹ä½œä¸šï¼Œè¾“å…¥åˆ°è®¡ç®—æœºä¸­ï¼Œåœ¨ç³»ç»Ÿä¸­å½¢æˆä¸€ä¸ªè‡ªåŠ¨è½¬æ¥çš„ä½œä¸šæµï¼Œç„¶åå¯åŠ¨æ“ä½œç³»ç»Ÿå¯¹ä½œä¸šè‡ªåŠ¨ã€ä¾æ¬¡çš„å¤„ç†ï¼Œå¤„ç†å®Œæˆåå†å°†å¤„ç†ç»“æœè¿”å›ç»™ç³»ç»Ÿæ“ä½œå‘˜ï¼Œæ“ä½œå‘˜åœ¨è¿”å›ç»™ç”¨æˆ·ã€‚è¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªå•é“æ‰¹å¤„ç†è¿‡ç¨‹ã€‚\n![å•é“æ‰¹å¤„ç†ç³»ç»Ÿå¤„ç†è¿‡ç¨‹](https://blog-1255876459.cos.ap-chengdu.myqcloud.com/2019/07/19/15635340778216.png)\n\n### 2. ç¼ºç‚¹\nç³»ç»Ÿèµ„æºå¾—ä¸åˆ°å……åˆ†åˆ©ç”¨ã€‚è¿™æ˜¯å› ä¸ºåœ¨å†…å­˜ä¸­ä»…æœ‰ä¸€é“ç¨‹åºï¼Œæ¯é€¢ç¨‹åºåœ¨è¿è¡Œä¸­å‘å‡ºI/Oè¯·æ±‚åï¼ŒCPUä¾¿å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¿…é¡»åœ¨I/Oå®Œæˆåæ‰ç»§ç»­è¿è¡Œã€‚\n\n## 1.3.2 å¤šé“æ‰¹å¤„ç†ç³»ç»Ÿ\n\n### 1. å¤„ç†è¿‡ç¨‹\nåœ¨è¯¥ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ‰€æäº¤çš„ä½œä¸šå…ˆæ”¾åœ¨å¤–å­˜ä¸­ï¼Œå¹¶æ’æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œç§°ä¸ºâ€œåå¤‡é˜Ÿåˆ—â€œã€‚ç„¶åç”±ä½œä¸šè°ƒåº¦ç¨‹åºæŒ‰ä¸€å®šçš„ç®—æ³•ï¼Œä»åå¤‡é˜Ÿåˆ—ä¸­é€‰æ‹©è‹¥å¹²ä½œä¸šè°ƒå…¥å†…å­˜ã€‚ç”±äºåŒæ—¶åœ¨å†…å­˜ä¸­è£…æœ‰è‹¥å¹²é“ç¨‹åºï¼Œè¿™æ ·ä¾¿å¯ä»¥åœ¨è¿è¡Œç¨‹åºAæ—¶ï¼Œåˆ©ç”¨å…¶I/Oæ“ä½œæš‚åœæ‰§è¡Œæ—¶çš„CPUç©ºæ¡£æœŸï¼Œå†è°ƒåº¦å¦ä¸€é“ç¨‹åºBè¿è¡Œã€‚\n\n### 2. ä¼˜ç¼ºç‚¹\n1. ä¼˜ç‚¹\n    1. èµ„æºåˆ©ç”¨ç‡é«˜\n    2. ç³»ç»Ÿååé‡å¤§\n2. ç¼ºç‚¹\n    1. å¹³å‡å‘¨è½¬æ—¶é—´é•¿\n    2. æ— äº¤äº’èƒ½åŠ›\n\n\n## 1.3.3 åˆ†æ—¶ç³»ç»Ÿ\n\n### 1. è¿è¡Œæ–¹å¼\n1. ä½œä¸šç›´æ¥è¿›å…¥å†…å­˜ã€‚å› ä¸ºä½œä¸šåœ¨ç£ç›˜ä¸Šä¸å¯è¿è¡Œï¼Œæ‰€ä»¥ä½œä¸šåº”ç›´æ¥è¿›å…¥å†…å­˜\n2. é‡‡ç”¨è½®è½¬è¿è¡Œæ–¹å¼ã€‚å¦‚æœä¸€ä¸ªä½œä¸šç‹¬å CPUè¿ç»­è¿è¡Œï¼Œé‚£ä¹ˆå…¶ä»–ä½œä¸šæ²¡æ³•è¿è¡Œã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¼•å…¥äº†æ—¶é—´ç‰‡æ¦‚å¿µã€‚ä¸€ä¸ªæ—¶é—´ç‰‡æ˜¯ä¸€ä¸ªå¾ˆçŸ­çš„æ—¶é—´ï¼Œç³»ç»Ÿè§„å®šäº†æ¯ä¸ªä½œä¸šæ¯æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œç„¶åå°±æš‚åœè¯¥ä½œä¸šçš„è¿è¡Œï¼Œå¹¶ç«‹å³è°ƒåº¦ä¸‹ä¸€ä¸ªä½œä¸šè¿è¡Œã€‚å¦‚æœåœ¨ä¸é•¿çš„æ—¶é—´å†…èƒ½ä½¿æ‰€æœ‰çš„ä½œä¸šéƒ½æ‰§è¡Œä¸€ä¸ªæ—¶é—´ç‰‡çš„æ—¶é—´ï¼Œä¾¿å¯ä»¥ä½¿æ¯ä¸ªç”¨æˆ·éƒ½èƒ½åŠæ—¶åœ°ä¸è‡ªå·±çš„ä½œä¸šè¿›è¡Œäº¤äº’ï¼Œä»è€Œä½¿ç”¨æˆ·çš„è¯·æ±‚çš„åˆ°åŠæ—¶å“åº”ã€‚\n\n### 2. ç‰¹å¾\n1. å¤šè·¯æ€§\n2. ç‹¬ç«‹æ€§\n3. åŠæ—¶æ€§\n4. äº¤äº’æ€§\n\n## 1.3.4 å®æ—¶ç³»ç»Ÿ\nå®æ—¶ç³»ç»Ÿæ˜¯æŒ‡ç³»ç»Ÿèƒ½åŠæ—¶å“åº”å¤–éƒ¨äº‹ä»¶çš„è¯·æ±‚ï¼Œåœ¨è§„å®šæ—¶é—´å†…å®Œæˆå¯¹è¯¥äº‹ä»¶çš„å¤„ç†ï¼Œå¹¶æ§åˆ¶æ‰€æœ‰å®æ—¶ä»»åŠ¡åè°ƒä¸€è‡´åœ°è¿è¡Œã€‚\nå®æ—¶ç³»ç»Ÿä¸»è¦åº”ç”¨äºï¼š\n1. å·¥ä¸šï¼ˆæ­¦å™¨ï¼‰æ§åˆ¶ç³»ç»Ÿ\n2. ä¿¡æ¯æŸ¥è¯¢ç³»ç»Ÿ\n3. å¤šåª’ä½“ç³»ç»Ÿ\n4. åµŒå…¥å¼ç³»ç»Ÿ\n\n# 1.4 æ“ä½œç³»ç»Ÿçš„åŸºæœ¬ç‰¹å¾\n\n## 1.4.1 å¹¶å‘\næ­£æ˜¯ç³»ç»Ÿä¸­æœ‰è¿™ä¸€ç‰¹å¾ï¼Œæ‰ä½¿å¾—OSèƒ½æœ‰æ•ˆåœ°æé«˜ç³»ç»Ÿä¸­çš„èµ„æºåˆ©ç”¨ç‡ï¼Œå¢åŠ ç³»ç»Ÿçš„ååé‡ã€‚\n\n### å¹¶å‘ä¸å¹¶è¡Œ\nå¹¶è¡Œæ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿï¼Œå¾®è§‚ä¸Šæ˜¯åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åœ¨CPUä¸Šè¿è¡Œã€‚\nå¹¶å‘æ˜¯æŒ‡å®è§‚ä¸Šä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´å‘ç”Ÿï¼Œå¾®è§‚ä¸Šç¼ºæ˜¯æŸä¸€æ—¶åˆ»CPUä¸Šåªæœ‰ä¸€ä¸ªè¿›ç¨‹ã€‚\n\n## 1.4.2 å…±äº«\nèµ„æºå…±äº«ï¼Œå³æ“ä½œç³»ç»Ÿä¸­çš„èµ„æºå¯ä¾›å¤šä¸ªå¹¶å‘æ‰§è¡Œçš„è¿›ç¨‹å…±åŒä½¿ç”¨ï¼Œç”±äºèµ„æºå±æ€§ä¸åŒï¼Œå¤šä¸ªè¿›ç¨‹å¯¹èµ„æºçš„å…±äº«æ–¹å¼ä¹Ÿä¸åŒã€‚å¯åˆ†ä¸ºï¼šäº’æ–¥å…±äº«æ–¹å¼å’ŒåŒæ—¶è®¿é—®æ–¹å¼ã€‚\n\n### 1. äº’æ–¥å…±äº«æ–¹å¼\nä¸€æ®µæ—¶é—´å†…åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®è¯¥èµ„æºï¼Œå¦‚ç£å¸¦æœº,æ‰“å°æœºç­‰ã€‚è™½ç„¶å¯ä»¥ä¾›å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œä½†æ˜¯ä¸ºäº†æ‰“å°æˆ–è®°å½•ç»“æœä¸é€ æˆæ··æ·†ï¼Œåº”è§„å®šä¸€æ®µæ—¶é—´å†…åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®è¯¥èµ„æºã€‚\n\n### 2. åŒæ—¶è®¿é—®æ–¹å¼\næŸäº›èµ„æºï¼Œä¸€æ®µæ—¶é—´å†…æ˜¯å¯ä»¥å…è®¸å¤šä¸ªè¿›ç¨‹â€œåŒæ—¶â€åŒæ—¶å¯¹ä»–ä»¬è¿›è¡Œè®¿é—®ï¼Œè¿™ä¸ªåŒæ—¶æ˜¯å®è§‚ä¸Šçš„ï¼Œåœ¨å¾®è§‚ä¸Šå¯èƒ½æ˜¯åˆ†æ—¶å…±äº«ã€‚\n\n## 1.4.3 è™šæ‹Ÿ\nåœ¨OSä¸­ï¼ŒæŠŠé€šè¿‡æŸç§æŠ€æœ¯å°†ä¸€ä¸ªç‰©ç†å®ä½“å˜ä¸ºè‹¥å¹²ä¸ªé€»è¾‘ä¸Šçš„å¯¹åº”ç‰©çš„åŠŸèƒ½ç§°ä¸ºâ€è™šæ‹Ÿâ€œã€‚\n\n## 1.4.4 å¼‚æ­¥\nåœ¨å¤šé“ç¯å¢ƒä¸‹ï¼Œå…è®¸å¤šä¸ªç¨‹åºå¹¶å‘æ‰§è¡Œã€‚ä½†ç”±äºèµ„æºæœ‰é™ï¼Œè¿›ç¨‹çš„æ‰§è¡Œä¸æ˜¯ä¸€è´¯åˆ°åº•ã€‚è€Œæ˜¯èµ°èµ°åœåœï¼Œä»¥ä¸å¯é¢„çŸ¥çš„é€Ÿåº¦å‘å‰æ¨è¿›ï¼Œè¿™å°±æ˜¯è¿›ç¨‹çš„å¼‚æ­¥ã€‚\n\n# 1.5 æ“ä½œç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½\næ“ä½œç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½åº”åˆ†ä¸ºå¤„ç†æœºç®¡ç†ã€å­˜å‚¨å™¨ç®¡ç†ã€è®¾å¤‡ç®¡ç†å’Œæ–‡ä»¶ç®¡ç†ã€‚æ­¤å¤–ï¼Œè¿˜åº”å‘ç”¨æˆ·æä¾›æ–¹ä¾¿çš„ç”¨æˆ·æ¥å£ã€‚\n\n## 1.5.1 å¤„ç†æœºç®¡ç†åŠŸèƒ½\n\n### 1. è¿›ç¨‹æ§åˆ¶\nåœ¨å¤šé“ç¨‹åºç¯å¢ƒä¸­ï¼Œä¸ºäº†ä½¿ä½œä¸šèƒ½å¹¶å‘æ‰§è¡Œï¼Œå¿…é¡»ä¸ºæ¯é“ä½œä¸šåˆ›å»ºä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸ºä¹‹åˆ†é…å¿…è¦çš„èµ„æºã€‚å½“è¿›ç¨‹è¿è¡Œç»“æŸæ—¶ï¼Œåº”ç«‹å³æ’¤é”€è¯¥è¿›ç¨‹ï¼Œä»¥ä¾¿èƒ½åŠæ—¶å›æ”¶è¯¥è¿›ç¨‹æ‰€å ç”¨çš„å„ç§èµ„æºï¼Œä¾›å…¶å®ƒè¿›ç¨‹ä½¿ç”¨ã€‚\n\n### 2. è¿›ç¨‹åŒæ­¥\nä¸ºäº†ä½¿å¤šä¸ªè¿›ç¨‹èƒ½æœ‰æ¡ä¸ç´Šçš„è¿è¡Œï¼Œç³»ç»Ÿä¸­å¿…é¡»è®¾ç½®ç›¸åº”çš„è¿›ç¨‹åŒæ­¥æœºåˆ¶ã€‚è¯¥æœºåˆ¶çš„ä¸»è¦ä»»åŠ¡æ˜¯ä¸ºå¤šä¸ªè¿›ç¨‹çš„è¿è¡Œè¿›è¡Œåè°ƒã€‚\n\n### 3. è¿›ç¨‹é€šä¿¡\nå¦‚æœä¸€ç»„ç›¸äº’åˆä½œçš„è¿›ç¨‹å»å®Œæˆä¸€ä¸ªå…±åŒçš„ä»»åŠ¡æ—¶ï¼Œåœ¨ä»–ä»¬ä¹‹é—´å¾€å¾€éœ€è¦äº¤æ¢ä¿¡æ¯ã€‚\n\n### 4. è°ƒåº¦\nåœ¨ä¼ ç»ŸOSä¸­ï¼Œè°ƒåº¦åŒ…æ‹¬ä½œä¸šè°ƒåº¦å’Œè¿›ç¨‹è°ƒåº¦ã€‚\n1. ä½œä¸šè°ƒåº¦\n    ä½œä¸šè°ƒåº¦çš„åŸºæœ¬ä»»åŠ¡å°±æ˜¯ä»åå¤‡é˜Ÿåˆ—ä¸­æŒ‰ç…§ä¸€å®šçš„ç®—æ³•é€‰æ‹©å‡ºè‹¥å¹²ä¸ªä½œä¸šï¼Œä¸ºä»–ä»¬åˆ†é…æ‰€éœ€èµ„æºï¼Œåœ¨è¿™äº›ä½œä¸šè°ƒå…¥å†…å­˜åï¼Œåˆ†åˆ«ä¸ºä»–ä»¬åˆ›å»ºè¿›ç¨‹ï¼Œæ˜¯ä»–ä»¬éƒ½ç§°ä¸ºå¯èƒ½è·å¾—å¤„ç†æœºçš„å°±ç»ªè¿›ç¨‹ï¼Œå¹¶å°†ä»–ä»¬æ’å…¥å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚\n2. è¿›ç¨‹è°ƒåº¦\n    è¿›ç¨‹è°ƒåº¦çš„ä»»åŠ¡æ˜¯ä»è¿›ç¨‹çš„å°±ç»ªé˜Ÿåˆ—ä¸­æŒ‰ç…§ä¸€å®šçš„ç®—æ³•é€‰å‡ºä¸€ä¸ªè¿›ç¨‹ï¼Œå°†å¤„ç†æœºåˆ†é…ç»™ä»–ï¼Œå¹¶ä¸ºä»–è®¾ç½®è¿è¡Œçº¿ç¨‹ï¼Œä½¿å…¶æŠ•å…¥æ‰§è¡Œã€‚\n\n## 1.5.2 å­˜å‚¨å™¨ç®¡ç†åŠŸèƒ½\nå­˜å‚¨å™¨ç®¡ç†è§†ä¸ºå¤šé“ç¨‹åºçš„è¿è¡Œæä¾›è‰¯å¥½çš„ç¯å¢ƒï¼Œæé«˜å­˜å‚¨å™¨åˆ©ç”¨ç‡ï¼Œå¹¶èƒ½ä»é€»è¾‘ä¸Šæ‰©å……å†…å­˜ã€‚ä¸ºæ­¤ï¼Œå­˜å‚¨å™¨ç®¡ç†åº”å…·æœ‰å†…å­˜åˆ†é…å’Œå›æ”¶ã€å†…å­˜ä¿æŠ¤ã€åœ°å€æ˜ å°„å’Œå†…å­˜æ‰©å……ç­‰åŠŸèƒ½ã€‚\n\n### 1. å†…å­˜åˆ†é…\nå†…å­˜åˆ†é…ä¸»è¦ä»»åŠ¡æ˜¯ï¼š\n1. ä¸ºæ¯é“ç¨‹åºåˆ†é…å†…å­˜ç©ºé—´\n2. æé«˜å­˜å‚¨å™¨çš„åˆ©ç”¨ç‡ï¼Œå°½é‡å‡å°‘ä¸å¯ç”¨çš„å†…å­˜ç©ºé—´\n3. å…è®¸æ­£åœ¨è¿è¡Œçš„ç¨‹åºç”³è¯·é™„åŠ çš„å†…å­˜ç©ºé—´ï¼Œä»¥é€‚åº”ç¨‹åºå’Œæ•°æ®åŠ¨æ€å¢é•¿çš„éœ€è¦ã€‚\n\nOSåœ¨å®ç°å†…å­˜åˆ†é…æ—¶ï¼Œå¯é‡‡å–é™æ€å’ŒåŠ¨æ€ä¸¤ç§æ–¹å¼ï¼š\n1. é™æ€åˆ†é…å†…å­˜ã€‚æ¯ä¸ªä½œä¸šçš„å†…å­˜ç©ºé—´åœ¨ä½œä¸šè£…å…¥æ—¶ç¡®å®šï¼Œç¡®å®šåä¸å†æ”¹å˜ã€‚\n2. åŠ¨æ€åˆ†é…å†…å­˜ã€‚æ¯ä¸ªä½œä¸šæ‰€è¦æ±‚çš„çš„åŸºæœ¬å†…å­˜ç©ºé—´è™½ç„¶ä¹Ÿæ˜¯åœ¨è£…å…¥æ—¶ç¡®å®šçš„ï¼Œä½†å…è®¸ä½œä¸šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç»§ç»­ç”³è¯·æ–°çš„é™„åŠ å†…å­˜ç©ºé—´ï¼Œä»¥é€‚åº”ç¨‹åºå’Œæ•°æ®çš„åŠ¨æ€å¢é•¿ã€‚\n\n### 2. å†…å­˜ä¿æŠ¤\nç¡®ä¿æ¯é“ç”¨æˆ·ç¨‹åºéƒ½åœ¨è‡ªå·±çš„å†…å­˜ç©ºé—´å†…è¿è¡Œï¼Œå½¼æ­¤äº’ä¸å¹²æ‰°ã€‚å†³ä¸å…è®¸ç”¨æˆ·ç¨‹åºè®¿é—®æ“ä½œç³»ç»Ÿçš„ç¨‹åºå’Œæ•°æ®ï¼Œä¹Ÿä¸å…è®¸ç”¨æˆ·ç¨‹åºè½¬ç§»åˆ°éå…±äº«çš„å…¶ä»–ç”¨æˆ·ç¨‹åºä¸­å»æ‰§è¡Œã€‚\n\n### 3. åœ°å€æ˜ å°„\næ¯é“ç¨‹åºç»ç¼–è¯‘è¿æ¥åæ‰€å½¢æˆçš„çš„å¯è£…å…¥ç¨‹åºå…¶åœ°å€éƒ½æ˜¯ä»0å¼€å§‹çš„ï¼Œä½†æ˜¯ä¸å¯èƒ½å°†ä»–ä»¬ä»â€œ0â€åœ°å€å¼€å§‹è£…å…¥å†…å­˜ï¼Œæ‰€ä»¥ç‰©ç†åœ°å€å’Œé€»è¾‘åœ°å€å¹¶ä¸ä¸€è‡´ï¼Œè¿™æ—¶å€™å°±éœ€è¦åœ°å€æ˜ å°„æ¥è®©ç¨‹åºèƒ½æ­£å¸¸è¿è¡Œã€‚\n\n### 4. å†…å­˜æ‰©å……\nå€ŸåŠ©è™šæ‹Ÿå­˜å‚¨æŠ€æœ¯æ¥å®ç°å†…å­˜æ‰©å……ï¼Œä¸»è¦è§£å†³ï¼š\n1. å†…å­˜å’ŒI/Oä¹‹é—´é€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜\n2. å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³çš„é—®é¢˜\n\n## 1.5.3 è®¾å¤‡ç®¡ç†åŠŸèƒ½\nä¸»è¦ä»»åŠ¡ï¼š\n1. å®Œæˆç”¨æˆ·è¿›ç¨‹æå‡ºçš„I/Oè¯·æ±‚ï¼Œä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…æ‰€éœ€çš„I/Oè®¾å¤‡ï¼Œå¹¶å®ŒæˆæŒ‡å®šçš„I/Oæ“ä½œ\n2. æé«˜CPUä¸I/Oè®¾å¤‡çš„åˆ©ç”¨ç‡ï¼Œæé«˜I/Oé€Ÿåº¦ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨I/O\n\nä¸ºäº†å®ç°ä»¥ä¸ŠåŠŸèƒ½ï¼Œåº”å…·æœ‰ç¼“å†²ç®¡ç†ã€è®¾å¤‡åˆ†é…å’Œè®¾å¤‡å¤„ç†ä»¥åŠè™šæ‹Ÿè®¾å¤‡ç­‰åŠŸèƒ½ã€‚\n### 1. ç¼“å†²ç®¡ç†\nä¸ºäº†æœ‰æ•ˆçš„ç¼“å’ŒCPUä¸I/Oè®¾å¤‡é—´é€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜ï¼Œæé«˜CPUåˆ©ç”¨ç‡ï¼Œäºæ˜¯å¼•å…¥äº†ç¼“å†²ç®¡ç†ã€‚\n\n### 2. è®¾å¤‡åˆ†é…\nè®¾å¤‡åˆ†é…çš„åŸºæœ¬ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·è¿›ç¨‹çš„I/Oè¯·æ±‚ã€ç³»ç»Ÿç°æœ‰èµ„æºæƒ…å†µä»¥åŠæŒ‰ç…§æŸç§è®¾å¤‡åˆ†é…ç­–ç•¥ï¼Œä¸ºä¹‹åˆ†é…å…¶æ‰€éœ€çš„è®¾å¤‡ã€‚\n\n### 3. è®¾å¤‡å¤„ç†\nå®ç°CPUå’Œè®¾å¤‡æ§åˆ¶å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œå³ç”±CPUå‘è®¾å¤‡æ§åˆ¶å™¨å‘å‡ºI/Oå‘½ä»¤ï¼Œè¦æ±‚ä»–å®ŒæˆæŒ‡å®šçš„I/Oæ“ä½œï¼›åä¹‹ï¼Œç”±CPUæ§åˆ¶ä»æ¥æ”¶å™¨å‘æ¥çš„ä¸­æ–­è¯·æ±‚ï¼Œå¹¶ç»™äºˆè¿…é€Ÿçš„å“åº”å’Œç›¸åº”çš„å¤„ç†ã€‚\n\n## 1.5.4 æ–‡ä»¶ç®¡ç†åŠŸèƒ½\nä¸»è¦æ˜¯å¯¹ç”¨æˆ·æ–‡ä»¶å’Œç³»ç»Ÿæ–‡ä»¶è¿›è¡Œç®¡ç†ä»¥æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼Œå¹¶ä¿è¯æ–‡ä»¶çš„å®‰å…¨æ€§ã€‚ä¸ºæ­¤ï¼Œæ–‡ä»¶ç®¡ç†åº”å…·æœ‰å¯¹æ–‡ä»¶å­˜å‚¨ç©ºé—´ç®¡ç†ã€ç›®å½•ç®¡ç†ã€æ–‡ä»¶çš„è¯»/å†™ç®¡ç†ä»¥åŠæ–‡ä»¶çš„å…±äº«ä¸ä¿æŠ¤ç­‰åŠŸèƒ½ã€‚\n\n### 1. æ–‡ä»¶å­˜å‚¨ç©ºé—´çš„ç®¡ç†\nä¸ºæ¯ä¸ªæ–‡ä»¶åˆ†é…å¿…è¦çš„å¤–å­˜ç©ºé—´ï¼Œæé«˜æˆ‘æ‘åˆ©ç”¨ç‡ï¼Œè¿›è€Œæé«˜æ–‡ä»¶ç³»ç»Ÿçš„å­˜ã€å–é€Ÿåº¦ã€‚\n\n### 2. ç›®å½•ç®¡ç†\nä¸ºæ¯ä¸ªæ–‡ä»¶å»ºç«‹ä¸€ä¸ªç›®å½•é¡¹ï¼Œç›®å½•é¡¹åŒ…æ‹¬æ–‡ä»¶åã€æ–‡ä»¶å±æ€§ã€æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ä½ç½®ç­‰ï¼Œå¹¶å¯¹ä¼—å¤šçš„ç›®å½•é¡¹åŠ ä»¥æœ‰æ•ˆçš„ç»„ç»‡ï¼Œä»¥å®ç°æ–¹ä¾¿çš„æŒ‰åå­—å­˜å–ã€‚\n\n### 3. æ–‡ä»¶çš„è¯»/å†™ç®¡ç†å’Œä¿æŠ¤\næ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ï¼Œä»å¤–å­˜ä¸­è¯»å–æ•°æ®æˆ–å°†æ•°æ®å†™å…¥å¤–å­˜ã€‚å¹¶ä¸”ä¿æŠ¤æ–‡ä»¶é˜²æ­¢å…¶è¢«éæ³•ç›—å–å’Œç ´åã€‚\n\n## 1.5.5 æ“ä½œç³»ç»Ÿä¸ç”¨æˆ·é—´çš„æ¥å£\næ¥å£ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼šç”¨æˆ·æ¥å£å’Œç¨‹åºæ¥å£ã€‚ç”¨æˆ·æ¥å£æ˜¯ä¾›ç”¨æˆ·è°ƒç”¨ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥æˆ–é—´æ¥æ§åˆ¶è‡ªå·±çš„ä½œä¸šã€‚ç¨‹åºæ¥å£æ˜¯ä¸ºç”¨æˆ·ç¨‹åºåœ¨æ‰§è¡Œä¸­è®¿é—®ç³»ç»Ÿèµ„æºè€Œè®¾å®šçš„ï¼Œæ˜¯ç”¨æˆ·å–å¾—æ“ä½œç³»ç»ŸæœåŠ¡çš„å”¯ä¸€é€”å¾„ã€‚","tags":["æ“ä½œç³»ç»Ÿ"],"categories":["æ“ä½œç³»ç»Ÿ"]},{"title":"Androidå¤šçº¿ç¨‹2--Javaä¸­çš„çº¿ç¨‹æ± ","url":"/posts/b39fd0ab.html","content":"# ç®€ä»‹\næˆ‘ä»¬åœ¨å†™é¡¹ç›®ç»å¸¸è¦ç”¨åˆ°å¤šçº¿ç¨‹ã€‚ä½†æ˜¯çº¿ç¨‹çš„åˆ›å»ºå’Œæ‘§æ¯éƒ½æ˜¯è¾ƒæ¶ˆè€—èµ„æºå’Œæ€§èƒ½çš„ï¼Œå¦‚æœä½ æ¯éœ€è¦ä¸€ä¸ªä»»åŠ¡å°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£å¯èƒ½ä¼šåœ¨çº¿ç¨‹çš„åˆ›å»ºå’Œæ‘§æ¯ä¸Šæµªè´¹æ‰å¾ˆå¤šèµ„æºã€‚é‚£å¦‚æœæˆ‘ä»¬è®©çº¿ç¨‹æ‰§è¡Œä»»åŠ¡åä¸æ‘§æ¯ï¼Œæ¥ç€æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å°±èƒ½é¿å…è¿™ç§æƒ…å†µäº†ã€‚Java1.5ä¸­æä¾›äº†`Executor`æ¡†æ¶ç”¨äºæŠŠä»»åŠ¡çš„æäº¤å’Œæ‰§è¡Œè§£è€¦ï¼Œä»»åŠ¡çš„æ‰§è¡Œå°±äº¤ç»™`Runnable`æˆ–è€…`Callable`ï¼Œè€Œ`Executor`æ¡†æ¶ç”¨äºå¤„ç†ä»»åŠ¡ã€‚`Executor`ä¸­æœ€æ ¸å¿ƒçš„æˆå‘˜å°±æ˜¯`ThreadPoolExecutor`ï¼Œä»–å°±æ˜¯çº¿ç¨‹æ± æ ¸å¿ƒå®ç°ç±»ã€‚\n\n<!-- More -->\n\n# ThreadPoolExecutor\næˆ‘ä»¬ç°åœ¨å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚\næ„é€ å™¨ï¼š\n```java\npublic ThreadPoolExecutor(int corePoolSize,\n                        int maximumPoolSize,markdownlint\n                        long keepAliveTime,\n                        TimeUnit unit,\n                        BlockingQueue<Runnable> workQueue,\n                        ThreadFactory threadFactory,\n                        RejectedExecutionHandler handler) {\n    if (corePoolSize < 0 ||\n        maximumPoolSize <= 0 ||\n        maximumPoolSize < corePoolSize ||\n        keepAliveTime < 0)\n        throw new IllegalArgumentException();\n    if (workQueue == null || threadFactory == null || handler == null)\n        throw new NullPointerException();\n    this.corePoolSize = corePoolSize;\n    this.maximumPoolSize = maximumPoolSize;\n    this.workQueue = workQueue;\n    this.keepAliveTime = unit.toNanos(keepAliveTime);\n    this.threadFactory = threadFactory;\n    this.handler = handler;\n}\n```\næˆ‘ä»¬æ¥çœ‹ä¸‹è¿™äº›å‚æ•°ï¼š\n* `corePoolSize`ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± åˆšåˆ›å»ºçš„æ—¶å€™ï¼Œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œåªæœ‰ä»»åŠ¡æäº¤çš„æ—¶å€™æ‰ä¼šåˆ›å»ºçº¿ç¨‹ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡å°äº`corePoolSize`ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹ï¼›å¦‚æœç­‰äºæˆ–è€…å¤§äºï¼Œåˆ™ä¸å†åˆ›å»ºã€‚\n* `maximumPoolSize`ï¼šçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å½“`workQueue`æ»¡äº†è€Œä¸”çº¿ç¨‹æ•°å°äº`maximumPoolSize`æ—¶ï¼Œçº¿ç¨‹æ± ä»ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚ä½†æ˜¯å¦‚æœè¶…è¿‡äº†`maximumPoolSize`æ—¶ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\n* `keepAliveTime`ï¼šéæ ¸å¿ƒçº¿ç¨‹é—²ç½®çš„è¶…è¿‡æ—¶é—´ã€‚å½“çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡å¤§äºworkQueueï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹çš„ç©ºé—²æ—¶é—´å¤§äºkeepAliveTimeï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¢«å›æ”¶ã€‚å¦‚æœä»»åŠ¡å¾ˆå¤šï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡ çš„æ‰§è¡Œäº‹ä»¶å¾ˆçŸ­ï¼Œåˆ™å¯ä»¥è°ƒå¤§keepAliveTimeæ¥æé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚å¦å¤–ï¼Œå¦‚æœè®¾ç½® allowCoreThreadTimeOutå±æ€§ä¸ºtrueæ—¶ï¼ŒkeepAliveTimeä¹Ÿä¼šåº”ç”¨åˆ°æ ¸å¿ƒçº¿ç¨‹ä¸Šã€‚\n* `timeUnit`ï¼škeepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½ã€‚å¯é€‰çš„å•ä½æœ‰å¤©(DAYS)ã€å°æ—¶(HOURS)ã€åˆ†é’Ÿ(MINUTES)ã€ç§’(SECONDS)ã€æ¯«ç§’(MILLISECONDS)ç­‰ã€‚\n* `workQueue`ï¼šä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ•°å¤§äº`corePoolSize`ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°æ­¤ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚è¯¥ä»»åŠ¡ é˜Ÿåˆ—æ˜¯`BlockingQueue`ç±»å‹çš„ï¼Œä¹Ÿå°±æ˜¯é˜»å¡é˜Ÿåˆ—ã€‚\n* `threadFactory`ï¼šçº¿ç¨‹å·¥å‚ã€‚å¯ä»¥ç”¨çº¿ç¨‹å·¥å‚ç»™æ¯ä¸ªåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹è®¾ç½®åå­—ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æ— é¡»è®¾ç½®è¯¥å‚æ•°ã€‚\n* `RejectedExecutionHandler`ï¼šé¥±å’Œç­–ç•¥ã€‚è¿™æ˜¯å½“ä»»åŠ¡é˜Ÿåˆ—å’Œçº¿ç¨‹æ± éƒ½æ»¡äº†æ—¶æ‰€é‡‡å–çš„åº”å¯¹ç­–ç•¥ï¼Œé»˜è®¤æ˜¯AbordPolicyï¼Œè¡¨ç¤ºæ— æ³•å¤„ç†æ–°ä»»åŠ¡ï¼Œå¹¶æŠ›å‡º`RejectedExecutionException`å¼‚å¸¸ã€‚æ­¤å¤–è¿˜æœ‰3ç§ç­–ç•¥ï¼Œå®ƒä»¬åˆ†åˆ«å¦‚ä¸‹:\n    1. `CallerRunsPolicy`ï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚æ­¤ç­–ç•¥æä¾›ç®€å•çš„åé¦ˆæ§åˆ¶æœºåˆ¶ï¼Œèƒ½å¤Ÿå‡ç¼“æ–°ä»»åŠ¡çš„æäº¤é€Ÿåº¦ã€‚\n    2. `DiscardPolicy`ï¼šä¸èƒ½æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶å°†è¯¥ä»»åŠ¡åˆ é™¤ã€‚\n    3. `DiscardOldestPolicy`ï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€è¿‘çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰çš„ä»»åŠ¡ã€‚\n\n# çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹\nçº¿ç¨‹æ± çš„ä»»åŠ¡å¤„ç†ä¸»è¦åˆ†ä¸º3ä¸ªæ­¥éª¤\n1. æäº¤ä»»åŠ¡åï¼Œçº¿ç¨‹æ± å…ˆåˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦è¾¾åˆ°äº†æ ¸å¿ƒçº¿ç¨‹æ•°`corePoolSize`ã€‚å¦‚æœæœªè¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼›å¦åˆ™ï¼Œå°±æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\n2. æ¥ç€çº¿ç¨‹æ± åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ã€‚å¦‚æœæ²¡æ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼›å¦åˆ™ï¼Œå°±æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\n3. æ¥ç€å› ä¸ºä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œçº¿ç¨‹æ± å°±åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœæœªè¾¾åˆ°ï¼Œåˆ™åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼›å¦åˆ™ï¼Œå°±æ‰§è¡Œé¥±å’Œç­–ç•¥ï¼Œé»˜è®¤ä¼šæŠ›å‡º`RejectedExecutionException`å¼‚å¸¸ã€‚\n\n![çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹](http://psb1j8lvg.bkt.clouddn.com/mweb/å±å¹•å¿«ç…§2019-06-16ä¸‹åˆ3.03.51.png)\n1. å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æœªè¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚\n2. å¦‚æœçº¿ç¨‹æ•°å¤§äºæˆ–è€…ç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œçº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹ä¼šä¸æ–­åœ°ä» ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚\n3. å¦‚æœä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”çº¿ç¨‹æ•°æ²¡æœ‰è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»å¤„ç†ä»»åŠ¡ã€‚\n4. å¦‚æœçº¿ç¨‹æ•°è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™æ‰§è¡Œé¥±å’Œç­–ç•¥ã€‚\n\n# çº¿ç¨‹æ± çš„ç§ç±»\n## CachedThreadPoolï¼šå¯ç¼“å­˜çº¿ç¨‹æ± \n1. çº¿ç¨‹æ•°æ— é™åˆ¶\n2. æœ‰ç©ºé—²çº¿ç¨‹åˆ™å¤ç”¨ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— ç©ºé—²çº¿ç¨‹åˆ™æ–°å»ºçº¿ç¨‹\n3. ä¸€å®šç¨‹åºå‡å°‘é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€\n\nåˆ›å»ºæºç ï¼š\n```java\npublic static ExecutorService newCachedThreadPool() {\n    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                    60L, TimeUnit.SECONDS,\n                                    new SynchronousQueue<Runnable>());\n}\n```\n\n`CachedThreadPool`çš„`corePoolSize`ä¸º0ï¼Œ`maximumPoolSize`è®¾ç½®ä¸º`Integer.MAX_VALUE`ï¼Œè¿™æ„å‘³ç€`CachedThreadPool`æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œéæ ¸å¿ƒçº¿ç¨‹æ˜¯æ— ç•Œçš„ã€‚`keepAliveTime`è®¾ç½®ä¸º60Lï¼Œåˆ™ç©ºé—²çº¿ç¨‹ç­‰å¾…æ–°ä»»åŠ¡ çš„æœ€é•¿æ—¶é—´ä¸º60sã€‚åœ¨æ­¤ç”¨äº†é˜»å¡é˜Ÿåˆ—`SynchronousQueue`ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç§»é™¤æ“ä½œï¼ŒåŒæ ·ä»»ä½•ä¸€ä¸ªç§»é™¤æ“ä½œéƒ½ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ’å…¥æ“ä½œã€‚\n\n## FixedThreadPoolï¼šå®šé•¿çº¿ç¨‹æ± \n1. å¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°ï¼ˆåŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹æ•°ï¼‰\n2. è¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…\n\nåˆ›å»ºæºç ï¼š\n```java\npublic static ExecutorService newFixedThreadPool(int nThreads) {\n    return new ThreadPoolExecutor(nThreads, nThreads,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue<Runnable>());\n}\n```\n\n`FixedThreadPool`çš„`corePoolSize`å’Œ`maximumPoolSize`éƒ½è®¾ç½®ä¸ºåˆ›å»º`FixedThreadPool`æŒ‡å®šçš„å‚æ•°`nThreads`ï¼Œä¹Ÿå°±æ„å‘³ç€`FixedThreadPool`åªæœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œå¹¶ä¸”æ•°é‡æ˜¯å›ºå®šçš„ï¼Œæ²¡æœ‰éæ ¸å¿ƒçº¿ç¨‹ã€‚`keepAliveTime`è®¾ç½®ä¸º0Læ„å‘³ç€å¤šä½™çš„çº¿ç¨‹ä¼šè¢«ç«‹å³ç»ˆæ­¢ã€‚å› ä¸ºä¸ä¼šäº§ç”Ÿå¤šä½™çš„çº¿ç¨‹ï¼Œæ‰€ä»¥`keepAliveTime`æ˜¯æ— æ•ˆçš„å‚æ•°ã€‚å¦å¤–ï¼Œä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨äº†æ— ç•Œçš„é˜»å¡é˜Ÿåˆ—`LinkedBlockingQueue`ã€‚\n\n## ScheduledThreadPoolï¼šå®šé•¿çº¿ç¨‹æ± \næ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚\n\nåˆ›å»ºæºç ï¼š\n```java\npublic static ScheduledExecutorService newScheduledThreadPool(\n        int corePoolSize, ThreadFactory threadFactory) {\n    return new ScheduledThreadPoolExecutor(corePoolSize, threadFactory);\n}\n```\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºæºç ä¸­ä»–è·³è½¬åˆ°äº†`ScheduledThreadPoolExecutor`çš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿›å»ï¼š\n```java\npublic ScheduledThreadPoolExecutor(int corePoolSize,\n                                    ThreadFactory threadFactory) {\n    super(corePoolSize, Integer.MAX_VALUE,\n            DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,\n            new DelayedWorkQueue(), threadFactory);\n}\n```\n\nä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ`ScheduledThreadPoolExecutor`çš„æ„é€ æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„æ˜¯`ThreadPoolExecutor`çš„æ„é€ æ–¹æ³•ã€‚`corePoolSize`æ˜¯ä¼ è¿›æ¥çš„å›ºå®šæ•°å€¼ï¼Œ`maximumPoolSize`çš„å€¼æ˜¯`Integer.MAX_VALUE`ã€‚å› ä¸ºé‡‡ç”¨çš„`DelayedWorkQueue`æ˜¯æ— ç•Œçš„ï¼Œæ‰€ä»¥`maximumPoolSize`è¿™ä¸ªå‚æ•°æ˜¯æ— æ•ˆçš„ã€‚\n\n## SingleThreadExecutorï¼šå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± \n1. æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡\n2. æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåºæ‰§è¡Œï¼Œå³éµå¾ªé˜Ÿåˆ—çš„å…¥é˜Ÿå‡ºé˜Ÿè§„åˆ™\n\nåˆ›å»ºæºç ï¼š\n```java\npublic static ExecutorService newSingleThreadExecutor() {\n    return new FinalizableDelegatedExecutorService\n        (new ThreadPoolExecutor(1, 1,\n                                0L, TimeUnit.MILLISECONDS,\n                                new LinkedBlockingQueue<Runnable>()));\n}\n```\n\n`corePoolSize`å’Œ`maximumPoolSize`éƒ½ä¸º1ï¼Œæ„å‘³ç€`SingleThreadExecutor`åªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œå…¶ä»–çš„å‚æ•°éƒ½å’Œ`FixedThreadPool`ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚","tags":["Android","Java","å¤šçº¿ç¨‹"],"categories":["Java"]},{"title":"Nexté…ç½®å¤‡ä»½","url":"/posts/5b6e53a4.html","content":"# Hexoé…ç½®å¤‡ä»½\n<!-- More -->\n\n# è¯„è®ºç³»ç»Ÿ\n* æ¥å¿…åŠ› - https://www.livere.com/\n* valine(åœ¨ç”¨) - https://valine.js.org/\n\n# é˜…è¯»é‡æ˜¾ç¤º\n* leancloud - https://leancloud.cn/\n* valine(åœ¨ç”¨) - https://valine.js.org/","tags":["Hexo"],"categories":["æ‚é¡¹"]},{"title":"Androidå¤šçº¿ç¨‹1--Javaä¸­çš„é˜»å¡é˜Ÿåˆ—","url":"/posts/63ab42b7.html","content":"\n# é˜»å¡é˜Ÿåˆ—\n\n## å‰è¨€\nåœ¨è°ˆè®ºé˜»å¡é˜Ÿåˆ—ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸‹æ“ä½œç³»ç»Ÿå¤šçº¿ç¨‹éƒ¨åˆ†ä¸€ä¸ªç»å…¸çš„ä¾‹å­â€”â€”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜ï¼š\n>ç°åœ¨æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯ç”Ÿäº§è€…ä¸€ä¸ªæ˜¯æ¶ˆè´¹è€…ï¼Œè¿˜æœ‰ä¸€ä¸ªçº¿ç¨‹ç¼“å†²åŒºã€‚ç”Ÿäº§è€…ä¸»è¦ä½œç”¨å°±æ˜¯å‘ç¼“å†²åŒºä¸­æ·»åŠ æ•°æ®ï¼Œæ¶ˆè´¹è€…å°±æ˜¯ä»ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®ã€‚è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒå°±æ˜¯å¦‚ä½•ç¡®ä¿ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡äº†çš„æ—¶å€™è¿˜å¾€å…¶ä¸­æ·»åŠ å…ƒç´ ï¼Œæ¶ˆè´¹è€…ä¸ä¼šåœ¨ç¼“å†²åŒºç©ºäº†çš„æ—¶å€™è¿˜è¦æ±‚å–å‡ºæ•°æ®ã€‚\n\n<!-- More -->\nå…³äºè¿™ä¸ªé—®é¢˜çš„è§£å†³åŠæ³•æˆ‘ä»¬ä»¥åå†è¯´ï¼Œæˆ‘ä»¬ç°åœ¨ä¸»è¦è®¨è®ºçº¿ç¨‹ç¼“å†²åŒºâ€”â€”é˜»å¡é˜Ÿåˆ—ã€‚\n## é˜»å¡é˜Ÿåˆ—ç®€ä»‹\né˜»å¡é˜Ÿåˆ—å°±æ˜¯é˜Ÿåˆ—ï¼Œåªæ˜¯åœ¨ä¸€èˆ¬çš„é˜Ÿåˆ—ä¸Šæ·»åŠ äº†ä¸¤ä¸ªæ¡ä»¶ï¼š\n1. å½“é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™ä¸å…è®¸å†æ·»åŠ æ•°æ®\n2. å½“é˜Ÿåˆ—ç©ºäº†çš„æ—¶å€™ä¸å…è®¸ä»ä¸­å–æ•°æ®\n\nåœ¨Javaä¸­ï¼Œé˜»å¡é˜Ÿåˆ—æ˜¯é€šè¿‡`BlockingQueue`æ¥å®ç°çš„ï¼Œ`BlockingQueue`æ˜¯`Java.util.concurrent`åŒ…ä¸‹ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ã€‚\n\n## BlockingQueueçš„æ“ä½œæ–¹æ³•\n| æ–¹æ³• | æŠ›å¼‚å¸¸ | è¿”å›ç‰¹å®šå€¼ | é˜»å¡ | è¶…æ—¶ |\n| :---: | :---: | :---: | :---: | :---: |\n|æ’å…¥| add(E e) | offer(E e) | put(E e) | offer(E e, long timeout, TimeUnit unit) |\n|ç§»é™¤| remove() | poll() | take() | poll(time, unit) |\n|æ£€æŸ¥| element() | peek() | ä¸å¯ç”¨ | ä¸å¯ç”¨ |\n\n> è§£é‡Šï¼š\n> 1. æŠ›å¼‚å¸¸ï¼šå¦‚æœæ“ä½œæ— æ³•æ‰§è¡Œï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸\n> 2. ç‰¹å®šå€¼ï¼šå¦‚æœæ“ä½œæ— æ³•æ‰§è¡Œï¼Œåˆ™è¿”å›ä¸€ä¸ªç‰¹å®šçš„å€¼\n> 3. é˜»å¡ï¼š å¦‚æœæ“ä½œæ— æ³•æ‰§è¡Œï¼Œåˆ™æ–¹æ³•è°ƒç”¨è¢«é˜»å¡ï¼Œç›´åˆ°å¯ä»¥æ‰§è¡Œ\n> 4. è¶…æ—¶ï¼šå¦‚æœæ“ä½œæ— æ³•æ‰§è¡Œï¼Œåˆ™æ–¹æ³•è°ƒç”¨è¢«é˜»å¡ï¼Œç›´åˆ°å¯ä»¥æ‰§è¡Œæˆ–è€…è¶…è¿‡é™å®šçš„æ—¶é—´ã€‚è¿”å›ä¸€ä¸ªç‰¹å®šå€¼ä»¥å‘ŠçŸ¥è¯¥æ“ä½œæ˜¯å¦æˆåŠŸ(å…¸å‹çš„æ˜¯true / false)ã€‚\n\n## Javaä¸­çš„å„ç§é˜»å¡é˜Ÿåˆ—\n`Java`åŸºäº`BlockingQueue`ç»™å¼€å‘è€…æä¾›äº†7ä¸ªé˜»å¡é˜Ÿåˆ—ï¼š\n1. `ArrayBlockingQueue`ï¼šåŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æœ‰ç•Œå°±æ„å‘³ç€ä»–æœ‰ä¸€ä¸ªæœ€å¤§é™åº¦ï¼Œæ‰€å­˜å‚¨çš„çº¿ç¨‹çš„æ•°é‡ä¸èƒ½è¶…è¿‡è¿™ä¸ªé™å®šå€¼ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨å¯¹å…¶åˆå§‹åŒ–çš„æ—¶å€™ç»™å®šè¿™ä¸ªé™å®šå€¼ã€‚ä½†æ˜¯ç”±äºå®ƒæ˜¯åŸºäºæ•°ç»„æ‰€ä»¥ä»–å’Œæ•°ç»„ä¸€æ ·ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™é™å®šäº†è¿™ä¸ªå¤§å°ä»¥åå°±ä¸èƒ½æ”¹å˜ã€‚\n2. `LinkedBlockingQueue`ï¼šåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ã€‚å®ƒå†…éƒ¨ä»¥ä¸€ä¸ªé“¾å¼ç»“æ„(é“¾æ¥èŠ‚ç‚¹)å¯¹å…¶å…ƒç´ è¿›è¡Œå­˜å‚¨ã€‚å¦‚æœéœ€è¦çš„è¯ï¼Œè¿™ä¸€é“¾å¼ç»“æ„å¯ä»¥é€‰æ‹©ä¸€ä¸ªä¸Šé™ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ä¸Šé™ï¼Œå°†ä½¿ç”¨`Integer.MAX_VALUE`ä½œä¸ºä¸Šé™ã€‚`LinkedBlockingQueue`å†…éƒ¨ä»¥FIFO(å…ˆè¿›å…ˆå‡º)çš„é¡ºåºå¯¹å…ƒç´ è¿›è¡Œå­˜å‚¨ã€‚é˜Ÿåˆ—ä¸­çš„å¤´å…ƒç´ åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸­æ˜¯æ”¾å…¥æ—¶é—´æœ€ä¹…çš„é‚£ä¸ªï¼Œè€Œå°¾å…ƒç´ åˆ™æ˜¯æœ€çŸ­çš„é‚£ä¸ªã€‚ç”±äºé»˜è®¤æ˜¯æ— ä¸Šé™çš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä»–çš„æ—¶å€™ï¼Œå¦‚æœç”Ÿäº§è€…çš„é€Ÿåº¦å¤§äºæ¶ˆè´¹è€…çš„é€Ÿåº¦ï¼Œç³»ç»Ÿå†…å­˜å¯èƒ½ä¼šè¢«è€—å°½ã€‚æ‰€ä»¥ä½¿ç”¨ä»–ä¸€å®šè¦è®¾ç½®åˆå€¼ã€‚\n3. `PriorityBlockingQueue`ï¼šæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µæŒ‰ç…§è‡ªç„¶é¡ºåºç”Ÿåºæ’åˆ—ï¼Œä½ å¯ä»¥é‡å†™`compateTo()`æ–¹æ³•æ¥åˆ¶å®šå…ƒç´ æŒ‰è§„å®šæ’åºã€‚\n4. `DelayQueue`ï¼šæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç°`Delayed`æ¥å£ã€‚\n5. `SynchromousQueue`ï¼šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é˜Ÿåˆ—ã€‚ä»–ä¸èƒ½å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œä»–çš„æ¯ä¸€æ¬¡æ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç›¸åº”çš„åˆ é™¤æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚\n6. `LinkedTransferQueue`ï¼šåŸºäºé“¾è¡¨çš„æ— ç•Œé˜»å¡`TransferQueue`é˜Ÿåˆ—ã€‚ç›¸å¯¹äºå…¶ä»–é˜Ÿåˆ—ï¼Œä»–å¤šäº†`transfer(E e)`ã€`tryTransfer(E e)` å’Œ `tryTransfer(E e, long timeout, TimeUnit unit)`æ–¹æ³•ã€‚\n7. `LinkedBlockingDeque`ï¼šæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚å¯åœ¨ä¸¤ç«¯å…¥é˜Ÿå‡ºå¯¹ã€‚æ‰€ä»¥å½“å¤šçº¿ç¨‹å…¥é˜Ÿæ—¶ï¼Œå‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚\n\n## é˜»å¡é˜Ÿåˆ—å®ç°åŸç†\nä¸‹é¢æˆ‘ä»¬ä»¥`ArrayBlockingQueue`æºç ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸‹é˜»å¡é˜Ÿåˆ—å®ç°åŸç†ï¼š\n### å®šä¹‰\né¦–å…ˆå°±æ˜¯ä¸€å †å˜é‡çš„å®šä¹‰ï¼š\n```java\n/** The queued items */\nfinal Object[] items;\n\n/** items index for next take, poll, peek or remove */\nint takeIndex;\n\n/** items index for next put, offer, or add */\nint putIndex;\n\n/** Number of elements in the queue */\nint count;\n\n/*\n * Concurrency control uses the classic two-condition algorithm\n * found in any textbook.\n */\n\n/** Main lock guarding all access */\nfinal ReentrantLock lock;\n\n/** Condition for waiting takes */\nprivate\nfinal Condition notEmpty;\n\n/** Condition for waiting puts */\nprivate\nfinal Condition notFull;\n```\n`items`æ˜¯å­˜å‚¨é˜Ÿåˆ—å…ƒç´ çš„æ•°ç»„ï¼Œ`takeIndex`å’Œ`putIndex`åˆ†åˆ«æ˜¯å–æ•°æ®å’Œå­˜æ•°æ®çš„ç´¢å¼•ï¼Œ`count`æ˜¯é˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°ï¼Œ`lock`ä¸ºçœ‹ä¸€ä¸ªå¯é‡å…¥é”ï¼Œ`notEmpty`å’Œ`notFull`å‡ä¸ºç­‰å¾…æ¡ä»¶ï¼Œç”±`loc`kåˆ›å»ºã€‚\n\n### æ„é€ å™¨\næ¥ä¸‹æ¥çœ‹ä¸‹å®ƒçš„æ„é€ å™¨\n```java\npublic ArrayBlockingQueue(int capacity) {\n}\n\npublic ArrayBlockingQueue(int capacity, boolean fair) { \n}\n\npublic ArrayBlockingQueue(int capacity, boolean fair, Collection<? extends E> c) {\n}\n```\næ„é€ å™¨æœ‰ä¸‰ä¸ªé‡è½½çš„ç‰ˆæœ¬ï¼Œç¬¬ä¸€ä¸ªæ„é€ å™¨åªæœ‰ä¸€ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šå®¹é‡ï¼Œç¬¬äºŒä¸ªæ„é€ å™¨å¤šäº†ä¸€ä¸ªå‚æ•°æ¥æŒ‡å®šè®¿é—®ç­–ç•¥ï¼Œç¬¬ä¸‰ä¸ªæ„é€ å™¨åˆå¤šäº†ä¸€ä¸ªå‚æ•°å¯ä»¥æŒ‡å®šç”¨å¦å¤–ä¸€ä¸ªé›†åˆè¿›è¡Œåˆå§‹åŒ–ã€‚\n\n### æ•°æ®çš„æ·»åŠ \næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹`BlockingQueue`çš„ä¸‰ä¸ªæ’å…¥çš„æ–¹æ³•ï¼š`put()`ã€`add()`å’Œ`offer()`ï¼š\n* `put()` æ–¹æ³•ï¼šé˜Ÿåˆ—æ»¡ï¼Œä¼šé˜»å¡è°ƒç”¨å­˜å‚¨å…ƒç´ çš„çº¿ç¨‹\n\n```java\npublic void put(E e) throws InterruptedException {\n    // å…ˆæ£€æŸ¥eæ˜¯ä¸æ˜¯ç©ºï¼Œå¦‚æœç©ºåˆ™æŠ›å¼‚å¸¸\n    Objects.requireNonNull(e);\n    // è·å–ä¸€ä¸ªé‡å…¥é”lock\n    final ReentrantLock lock = this.lock;\n    // åŠ é”ï¼Œä¿è¯è°ƒç”¨putæ–¹æ³•çš„æ—¶å€™åªæœ‰1ä¸ªçº¿ç¨‹\n    lock.lockInterruptibly();\n    try {\n    // å¦‚æœçº¿ç¨‹ä¸­çš„å…ƒç´ æ•°é‡æ˜¯å¦ç­‰äºå½“å‰æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœç›¸ç­‰åˆ™è°ƒç”¨awaitæ–¹æ³•ç­‰å¾…ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™enqueueæ–¹æ³•æ’å…¥å…ƒç´ \n        while (count == items.length)\n            notFull.await();\n        enqueue(e);\n    } finally {\n    // è§£é”\n        lock.unlock();\n    }\n}\n```\n* `add()`æ–¹æ³•ï¼šå®é™…ä¸Šè°ƒç”¨äº†`offer()`æ–¹æ³•\n\n```java\npublic boolean add(E e) {\n    if (offer(e))\n        return true;\n    else\n        throw new IllegalStateException(\"Queue full\");\n}\n```\n* `offer()`æ–¹æ³•ï¼šæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false\n\n```java\npublic boolean offer(E e) {\n    // æ£€æŸ¥eæ˜¯å¦ä¸ºç©º\n    Objects.requireNonNull(e);\n    // è·å–é‡å…¥é”lock\n    final ReentrantLock lock = this.lock;\n    // åŠ é”\n    lock.lock();\n    try {\n        // å¦‚æœå¦‚æœçº¿ç¨‹ä¸­çš„å…ƒç´ æ•°é‡æ˜¯å¦ç­‰äºå½“å‰æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœç›¸ç­‰åˆ™è°ƒè¿”å›falseï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™enqueueæ–¹æ³•æ’å…¥å…ƒç´ å¹¶è¿”å›true\n        if (count == items.length)\n            return false;\n        else {\n            enqueue(e);\n            return true;\n        }\n    } finally {\n        // è§£é”\n        lock.unlock();\n    }\n}\n```\n\nä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†`enqueue()`æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š\n```java\n/**\n * Inserts element at current put position, advances, and signals.\n * Call only when holding lock.\n */\nprivate void enqueue(E e) {\n    // assert lock.isHeldByCurrentThread();\n    // assert lock.getHoldCount() == 1;\n    // assert items[putIndex] == null;\n    final Object[] items = this.items;\n    items[putIndex] = e;\n    if (++putIndex == items.length) \n        putIndex = 0;\n    count++;\n    notEmpty.signal();\n}\n```\nå…ˆè·å–å…ƒç´ æ•°ç»„`items`ï¼Œç„¶åæ·»åŠ `putIndex`ä¸Šï¼Œå¦‚æœ`++putIndex`ç­‰äº`items`çš„é•¿åº¦ï¼Œåˆ™è¯æ˜å½“å‰è¿™ä¸ª`items`æ‰€æœ‰å…ƒç´ éƒ½æ·»åŠ è¿›äº†ï¼Œå°±è®©`putIndex`ç­‰äº0.ç„¶åè°ƒç”¨`notEmpty.signal()`æ–¹æ³•å”¤é†’æ­£åœ¨è·å–å…ƒç´ çš„çº¿ç¨‹ï¼Œè®©ä»–ä»¬ä»é˜Ÿåˆ—ä¸­å–æ•°æ®ã€‚\n\n### æ•°æ®çš„å–å‡º\nArrayBlockingQueueçš„å–æ•°æ®æ–¹æ³•æ€»å…±ä¹Ÿæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š`poll()`ã€`take()`å’Œ`remove()`\n* `poll()`æ–¹æ³•ï¼šè·å–å…ƒç´ ï¼Œå­˜åœ¨è¿”å›å…ƒç´ e,ä¸å­˜åœ¨è¿”å›null\n \n```java\npublic E poll() {\n    // è·å–é‡å…¥é”lock\n    final ReentrantLock lock = this.lock;\n    // åŠ é”\n    lock.lock();\n    try {\n        // å¦‚æœå…ƒç´ æ•°é‡ç­‰äº0å°±è¿”å›nullï¼Œå¦åˆ™è°ƒç”¨dequeue()æ–¹æ³•\n        return (count == 0) ? null : dequeue();\n    } finally {\n        // è§£é”\n        lock.unlock();\n    }\n}\n```\n* `take()`æ–¹æ³•ï¼šå–å…ƒç´ ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©º,åˆ™ä¼šé˜»å¡è°ƒç”¨è·å–å…ƒç´ çš„çº¿ç¨‹\n\n```java\npublic E take() throws InterruptedException {\n    // è·å–é‡å…¥é”lock\n    final ReentrantLock lock = this.lock;\n    // åŠ é”\n    lock.lockInterruptibly();\n    try {\n        // å¦‚æœçº¿ç¨‹ä¸­çš„å…ƒç´ æ•°é‡æ˜¯å¦ç­‰äº0ï¼Œå¦‚æœç›¸ç­‰åˆ™è°ƒç”¨awaitæ–¹æ³•ç­‰å¾…ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™dequeueæ–¹æ³•åˆ é™¤å…ƒç´ \n        while (count == 0)\n            notEmpty.await();\n        return dequeue();\n    } finally {\n        // è§£é”\n        lock.unlock();\n    }\n}\n```\n* `remove()`æ–¹æ³•ï¼šå–å…ƒç´ ï¼Œå®ƒæ˜¯å–ç‰¹å®šçš„é‚£ä¸ªå…ƒç´ \n\n```java\npublic boolean remove(Object o) {\n    // åˆ¤æ–­oæ˜¯å¦ä¸ºç©º\n    if (o == null) return false;\n    // è·å–é‡å…¥é”lock\n    final ReentrantLock lock = this.lock;\n    // åŠ é”\n    lock.lock();\n    try {\n        // å¦‚æœå…ƒç´ æ•°é‡å¤§äº0ï¼Œåˆ™è·å–itemsï¼Œç„¶åä¾¿åˆ©å…ƒç´ ï¼Œåˆ¤æ–­oæ˜¯å…¶ä¸­çš„å“ªä¸ªï¼Œç„¶ååˆ é™¤é‚£ä¸ª\n        if (count > 0) {\n            final Object[] items = this.items;\n            for (int i = takeIndex, end = putIndex, to = (i < end) ? end : items.length; ; i = 0, to = end) {\n                for (; i < to; i++)\n                    if (o.equals(items[i])) {\n                        removeAt(i);\n                        return true;\n                    }\n                if (to == end) break;\n            }\n        }\n        return false;\n    } finally {\n        // è§£é”\n        lock.unlock();\n    }\n}\n```\n`poll()`å’Œ`take()`ä¸¤ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†`dequeue()`æ–¹æ³•ï¼Œæˆ‘ä»¬å°±çœ‹ä¸‹`dequeue()`æ˜¯å¦‚ä½•æ¥å®ç°çš„ï¼š\n```java\n/**\n * Extracts element at current take position, advances, and signals.\n * Call only when holding lock.\n */\nprivate E dequeue() {\n    // assert lock.isHeldByCurrentThread();\n    // assert lock.getHoldCount() == 1;\n    // assert items[takeIndex] != null;\n    final Object[] items = this.items;\n    @SuppressWarnings(\"unchecked\")\n    E e = (E) items[takeIndex];\n    items[takeIndex] = null;\n    if (++takeIndex == items.length) takeIndex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementDequeued();\n    notFull.signal();\n    return e;\n}\n```\nå’Œä¸Šé¢çš„`enqueue()`æ–¹æ³•ç±»ä¼¼ï¼Œå†æ¬¡å°±ä¸å†èµ˜è¿°ã€‚\n\n## é˜»å¡é˜Ÿåˆ—çš„åº”ç”¨\nå‰é¢æˆ‘è¯´è¿‡ï¼Œé˜»å¡é˜Ÿåˆ—ä¸»è¦ç”¨åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œé‚£ä¸‹é¢æˆ‘ä»¬å°±æ¥å†™ä¸€ä¸ªç®€å•çš„å°demo\n>>è¿™æ®µä»£ç æ¥è‡ªåˆ˜æœ›èˆ’æ‰€è‘—ã€ŠAndroidè¿›é˜¶ä¹‹å…‰ã€‹\n\nå¦‚æœä¸ç”¨é˜»å¡é˜Ÿåˆ—ï¼š\n```java\nimport java.util.PriorityQueue;\n\npublic class Test {\n    private int queueSize = 10;\n    private PriorityQueue<Integer> queue = new PriorityQueue<>(queueSize);\n\n    public static void main(String[] args) {\n        Test test = new Test();\n        Producer producer = test.new Producer();\n        Consumer consumer = test.new Consumer();\n        producer.start();\n        consumer.start();\n    }\n\n    class Consumer extends Thread {\n        @Override\n        public void run() {\n            while (true) {\n                synchronized (queue) {\n                    while (queue.size() == 0) {\n                        try {\n                            System.out.println(\"é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…æ•°æ®\");\n                            queue.wait();\n                        } catch (InterruptedException e) {\n                            e.printStackTrace();\n                            queue.notify();\n                        }\n                    }\n                    // æ¯æ¬¡ç§»èµ°é˜Ÿé¦–å…ƒç´ \n                    queue.poll();\n                    queue.notify();\n                }\n            }\n        }\n    }\n\n    private class Producer extends Thread {\n        @Override\n        public void run() {\n            while (true) {\n                synchronized (queue) {\n                    try {\n                        System.out.println(\"é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…æœ‰ç©ºä½™ç©ºé—´\");\n                        queue.wait();\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                        queue.notify();\n                    }\n                }\n                // æ¯æ¬¡æ’å…¥ä¸€ä¸ªå…ƒç´ \n                queue.offer(1);\n                queue.notify();\n            }\n        }\n    }\n}\n```\n\nä½¿ç”¨é˜»å¡é˜Ÿåˆ—`ArrayBlockingQueue`ï¼š\n```java\nimport java.util.concurrent.ArrayBlockingQueue;\n\npublic class BlockingQueueTest {\n    private int queueSize = 10;\n    private ArrayBlockingQueue<Integer> queue = new ArrayBlockingQueue<>(queueSize);\n\n    public static void main(String[] args) {\n        BlockingQueueTest test = new BlockingQueueTest();\n        BlockingQueueTest.Producer producer = test.new Producer();\n        BlockingQueueTest.Consumer consumer = test.new Consumer();\n        producer.start();\n        consumer.start();\n    }\n\n    class Consumer extends Thread {\n        @Override\n        public void run() {\n            while (true) {\n                try {\n                    queue.take();\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n    }\n\n    private class Producer extends Thread {\n        @Override\n        public void run() {\n            while (true) {\n                try {\n                    queue.put(1);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n    }\n}\n```","tags":["Android","Java","å¤šçº¿ç¨‹"],"categories":["Java"]},{"title":"Kotlinå…¥é—¨1:Kotlinå’ŒJavaåŒºåˆ«åŸºç¡€ç¯‡","url":"/posts/343b01ae.html","content":"# Koltinå…¥é—¨\n# Kotlinç®€ä»‹\n> ç§‘ç‰¹æ—å²›(ĞšĞ¾Ñ‚Ğ»Ğ¸Ğ½)æ˜¯ä¸€åº§ä¿„ç½—æ–¯çš„å²›å±¿,ä½äºåœ£å½¼å¾—å ¡ä»¥è¥¿çº¦30å…¬é‡Œå¤„,å½¢çŠ¶ç‹­é•¿,ä¸œè¥¿é•¿åº¦çº¦14å…¬é‡Œ,å—åŒ—å®½åº¦çº¦2å…¬é‡Œ,é¢ç§¯æœ‰16å¹³æ–¹å…¬é‡Œ,æ‰¼å®ˆä¿„å›½è¿›å…¥èŠ¬å…°æ¹¾çš„æ°´é“ã€‚ç§‘ç‰¹æ—å²›ä¸Šå»ºæœ‰å–€ç…æ–½å¡”å¾—å¸‚,ä¸ºåœ£å½¼å¾—å ¡ä¸‹è¾–çš„åŸå¸‚ã€‚\n\nè€Œæˆ‘ä»¬è™½è¯´çš„kotlinï¼Œå°±æ˜¯ä¸€é—¨æ ¹æ®å®ƒå‘½åçš„ä¸€ç§ç°ä»£ç¨‹åºè®¾è®¡è¯­è¨€ã€‚Kotlin æ˜¯ä¸€ä¸ªç”¨äºç°ä»£å¤šå¹³å°åº”ç”¨çš„é™æ€ç¼–ç¨‹è¯­è¨€ï¼Œç”± JetBrains å¼€å‘ã€‚Kotlinå¯ä»¥ç¼–è¯‘æˆJavaå­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘JavaScriptï¼Œæ–¹ä¾¿åœ¨æ²¡æœ‰JVMçš„è®¾å¤‡ä¸Šè¿è¡Œã€‚Kotlinå·²æ­£å¼æˆä¸ºAndroidå®˜æ–¹æ”¯æŒå¼€å‘è¯­è¨€ã€‚\n\n<!-- More -->\n-------\n\n\n# å˜é‡\nkotlinå’ŒJavaçš„æœ€åŸºæœ¬çš„åŒºåˆ«å°±æ˜¯kotlinä¸­**ä¸‡ç‰©çš†å¯¹è±¡**ï¼ŒJavaä¸­è¿˜å­˜åœ¨ç€intã€floatç­‰åŸºæœ¬ç±»å‹ï¼Œä½†æ˜¯åœ¨kotlinä¸­ï¼Œå®ƒæŠŠè¿™äº›éƒ½å®šä¹‰æˆäº†å¯¹è±¡ï¼Œç±»ä¼¼äºJavaä¸­çš„å°è£…ç±»\n## å˜é‡çš„å£°æ˜\nä¸Šé¢è¯´äº†ï¼Œkotlinä¸‡ç‰©çš†å¯¹è±¡ï¼Œæ‰€ä»¥æ‰€æœ‰çš„å˜é‡ä¹Ÿéƒ½æ˜¯å¯¹è±¡ã€‚\nåœ¨kotlinå®šä¹‰å¯¹è±¡å’ŒJavaæœ‰ç‚¹å°åŒºåˆ«ã€‚\nkotlinå®šä¹‰å¯¹è±¡çš„æ ¼å¼ä¸º\n>  å£°æ˜ç±»å‹ å˜é‡åï¼š å˜é‡ç±»å‹\n\nå…¶ä¸­ï¼š\n* å£°æ˜ç±»å‹åˆ†ä¸º`val`å’Œ`var`ã€‚`val`æ˜¯ä¸å¯å˜ç±»å‹ï¼Œç±»ä¼¼äºconstï¼Œå®šä¹‰æ—¶å¿…é¡»èµ‹å€¼ï¼Œèµ‹å€¼åä¸èƒ½è¢«ä¿®æ”¹ã€‚`var`æ˜¯å¯å˜ç±»å‹ã€‚\n* å˜é‡åå°±æ˜¯ä½ å®šä¹‰çš„è¿™ä¸ªå˜é‡çš„åç§°ã€‚\n* å˜é‡ç±»å‹å°±æ˜¯ä½ è¿™ä¸ªå˜é‡å¯¹åº”çš„ç±»çš„åå­—ã€‚\n\n## ç±»å‹æ¨æ–­\n### çœå»å˜é‡ç±»å‹\nkotliné‡Œé¢ç±»ä¼¼c++çš„`auto`ç±»å‹ï¼Œå¯¹äºåŸºæœ¬ç±»å‹ï¼Œä½ å¯ä»¥ä¸å†™å˜é‡ç±»å‹ï¼Œkotlinä¼šè‡ªåŠ¨å¸®ä½ åˆ¤æ–­ã€‚\n\n```kotlin\nvar a = 5\nprintln(a is Int)\n\nvar b = â€œ123\nprintln(b is String)\n\nvar c = 1.3\nprintln(c is Float)\n\nvar d = true\nprintln(d is Boolean)\n```\n\n### `is`å…³é”®å­—\n`is`é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åˆ¤æ–­è¿™ä¸ªå˜é‡æ˜¯ä¸æ˜¯è¿™ä¸ªç±»å‹çš„å®ä¾‹ã€‚\nä¾‹å­è§ä¸Šã€‚\n\n## æ•°å­—ç±»å‹\n\n|  ç±»å‹  |  å®½åº¦(bit)  |\n| --- | --- |\n|  Byte |   8 |\n| Short |  16  |\n|  Int  |  32  |\n|  Long  |  64  |\n|  Float  |  32  |\n| Double   |  64  |\n\nè¿™äº›ç±»å‹éƒ½ç»§æ‰¿è‡ª`Number`å’Œ`Comparable`ç±»ã€‚\n\n### å­—é¢å¸¸é‡å€¼\n* åè¿›åˆ¶ï¼š`123`\n* åå…­è¿›åˆ¶ï¼š`0x0f`\n* äºŒè¿›åˆ¶ï¼š`0b0010`\n* Longç±»å‹ï¼š`123L`\n* doubleç±»å‹ï¼š123.4\n* Floatç±»å‹ï¼š`123.4f`æˆ–è€…`123.4F`\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿`_`æ¥æ–¹ä¾¿æˆ‘ä»¬é˜…è¯»\n\n```kotlin\n1_000_000 // 1000000\n0xFF_EC // 0xFFEC\n```\n### æ˜¾ç¤ºè½¬æ¢\nkotlinä¸­ä¸å¯éšå¼è½¬æ¢\næ¯”å¦‚Java ä¸­\n\n```java\nint a = 2;\nlong b = a;\n```\nä½†æ˜¯åœ¨kotlinä¸­\n\n```kotlin\nvar a : Int? = 2\nvar b : Long? = a; // error\nvar b : Long? = a.toLong()\n```\n\n## Charç±»å‹\nkotlinä¸­çš„`Char`è¡¨ç¤ºå­—ç¬¦ã€‚ä½†æ˜¯å’ŒJavaä¸åŒï¼Œä»–ä¸èƒ½ç›´æ¥å½“ASCIIç å€¼ã€‚\n\n```kotlin\nfun check(c : Char) {\n    if (c == 1) { // error \n    \n    }\n}\n```\n\n## Booleanç±»å‹\nkotlinä¸­çš„å¸ƒå°”ç±»å‹ç”¨`Boolean`æ¥è¡¨ç¤ºï¼Œä»–æœ‰ä¸¤ä¸ªå€¼`true`å’Œ`false`ã€‚ç”¨æ³•å’ŒJavaä¸€æ ·ã€‚\n\n## Stringç±»å‹\nå’ŒJavaä¸€æ ·ï¼Œkotlinä¸­çš„å­—ç¬¦ä¸²ä¹Ÿæ˜¯`String`ã€‚ä½†æ˜¯kotlinä¸­`String`æ˜¯ä¸å¯å˜çš„ã€‚æ‰€ä»¥kotlinä¸­`String`å¿…é¡»æ˜¯`val`ç±»å‹ã€‚åŒæ—¶ï¼Œ`String`æ˜¯`final`ä¸å¯ç»§æ‰¿çš„ã€‚\n\n## Arrayç±»å‹\nkotlinä¸­æ•°ç»„å¿…é¡»ä½¿ç”¨`Array`è¡¨ç¤ºã€‚\nåŸºæœ¬å†™æ³•\n> val array: Array<ç±»å‹> = arrayOf(..)\n\nä¾‹å¦‚\n```kotlin\n/**æ•´å‹Intçš„æ•°ç»„*/\nval arrayOfInt: IntArray = intArrayOf(1,3,5,7,9)\n/**å­—ç¬¦Charç±»å‹çš„æ•°ç»„*/\nval arrayOfChar: CharArray = charArrayOf('H','e','l','l','o','W','o','r','l','d')\n/**å­—ç¬¦ä¸²Stringæ•°ç»„*/\nval arrayOfString: Array<String> = arrayOf(\"Hello\",\"World\")\n\nfun main(args: Array<String>) {\n    //æŸ¥çœ‹æœ‰å¤šå°‘ä¸ªå…ƒç´ \n    println(arrayOfInt.size)\n    //éå†æ•°ç»„\n    for (char in arrayOfChar){\n        println(char)\n    }\n\n    //æ ¹æ®æ‰€å¼•è·å–æ•°æ®,æ•°ç»„æ˜¯ä»0å¼€å§‹çš„ï¼Œç°åœ¨è·å–ç¬¬äºŒä¸ªä¸œäº¬å¤§å­¦\n    println(arrayOfUniversity[1])\n    //é‡æ–°ç»™æ•°ç»„èµ‹å€¼ï¼Œæ—©ç¨»ç”°å¤§å­¦\n    arrayOfUniversity[1] = University(\"æ—©ç¨»ç”°å¤§å­¦\")\n    println(arrayOfUniversity[1])\n\n    //å°†charè¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²,é»˜è®¤æ˜¯è‡ªåŠ¨ç”±é€—å·\",\"åˆ†å‰²çš„ï¼Œè¾“å‡ºH, e, l, l, o, W, o, r, l, d\n    println(arrayOfChar.joinToString())\n    //å¦‚æœæƒ³è¦è¿æˆHelloWorld\n    println(arrayOfChar.joinToString (\"\"))\n\n    //æ•°ç»„çš„åˆ‡ç‰‡,è¾“å‡º3ï¼Œ5,ç»“å°¾éœ€è¦arrayOfInt-1ï¼Œä¸ç„¶ä¼šæŠ¥ç´¢å¼•è¶Šç•Œå¼‚å¸¸\n    println(arrayOfInt.slice(1..2))\n\n    println(arrayOfInt.size)\n}\n```","tags":["Kotlin","è¯­è¨€åŸºç¡€"],"categories":["Kotlin"]},{"title":"Kotlin Ankoå…¥é—¨","url":"/posts/62bb1dd7.html","content":"# Kotlin Ankoå…¥é—¨\n\n# ç®€ä»‹\nAnkoçš„å®˜ç½‘å°±æ˜¯ä»–çš„GitHubåœ°å€\n> https://github.com/Kotlin/anko\n\nå®˜æ–¹å¯¹Ankoçš„è§£é‡Šæ˜¯\n> Ankoæ˜¯ä¸€ä¸ª [Kotlin](https://www.kotlinlang.org/) åº“ï¼Œå®ƒä½¿Androidåº”ç”¨ç¨‹åºå¼€å‘æ›´å¿«æ›´å®¹æ˜“ã€‚å®ƒä½¿æ‚¨çš„ä»£ç æ¸…æ™°æ˜“è¯»ï¼Œè®©æ‚¨å¿˜è®°Android SDK for Javaçš„ç²—ç³™è¾¹ç¼˜ã€‚\n\n<!-- More -->\nä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿ\næ¯”æ–¹è¯´å¦‚æœä½ å†™Androidï¼Œä½ åœ¨xmlä¸­å®šä¹‰äº†ä¸€ä¸ª`Button`ï¼Œä»–çš„IDæ˜¯`button_login`ã€‚\nå¦‚æœæ˜¯Javaï¼š\n```java\nsetContentView(R.layout.activity_words_detail);\nButton button = findViewById(R.Id.button_login);\n```\nè€Œå¦‚æœä½ ä½¿ç”¨kotlinçš„è¯ï¼Œä½ å¯ä»¥å°±æŒ‰å¦‚ä¸‹ä»£ç å†™\n```kotlin\nimport kotlinx.android.synthetic.main.activity_kotlin_main.*\n...\nbutton_login.setText(\"Kotlin Android Extensions æˆ‘ä¸å¤ªå–œæ¬¢\");\n```\nè¿™æ ·ç¡®å®æ¯”Javaæ–¹ä¾¿å¤šäº†ï¼Œä¸éœ€è¦å¯¹æ¯ä¸€ä¸ªç»„ä»¶éƒ½å®šä¹‰å†findViewByIdï¼Œå¯ä»¥å°±ç›´æ¥è¾“å…¥ç»„ä»¶çš„idç„¶åå°±èƒ½ä½¿ç”¨äº†ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è§‰å¾—ä¸å¤Ÿå•Šï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½å°±ç›´æ¥åœ¨ä»£ç ä¸­å†™å…¥å„ä¸ªç»„ä»¶å‘¢ï¼Œäºæ˜¯ï¼ŒAnkoæ¥äº†ã€‚\n\n# å¯¼å…¥Anko\nAnkoç”±å‡ éƒ¨åˆ†ç»„æˆï¼š\n* *Anko Commons*ï¼šä¸€ä¸ªè½»é‡çº§çš„åº“ï¼ŒåŒ…å«ç”¨äºLayoutsï¼ŒIntentï¼ŒLogç­‰çš„å¸®åŠ©ç¨‹åº;\n* *Anko Layouts*ï¼šä¸€ç§å¿«é€Ÿä¸”ç±»å‹å®‰å…¨çš„æ–¹å¼æ¥ç¼–å†™åŠ¨æ€Androidå¸ƒå±€;\n* *Anko SQLite*ï¼šAndroid SQLiteçš„æŸ¥è¯¢DSLå’Œè§£æå™¨é›†åˆ;\n* *Anko Coroutines*ï¼šåŸºäº[kotlinx.coroutines](https://github.com/Kotlin/kotlinx.coroutines)åº“çš„å®ç”¨ç¨‹åºã€‚\n\nä½ å¯ä»¥åœ¨appçš„`build.gradle`ä¸­æ·»åŠ \n```java\ndependencies {\n     // Anko Layouts\n    implementation \"org.jetbrains.anko:anko-sdk25:$anko_version\" // sdk15, sdk19, sdk21, sdk23 are also available\n    implementation \"org.jetbrains.anko:anko-appcompat-v7:$anko_version\"\n\n    // Coroutine listeners for Anko Layouts\n    implementation \"org.jetbrains.anko:anko-sdk25-coroutines:$anko_version\"\n    implementation \"org.jetbrains.anko:anko-appcompat-v7-coroutines:$anko_version\"}\n```\nè¿™ä¸ªä¾èµ–å¯ä»¥ç›´æ¥å¯¼å…¥æ‰€æœ‰çš„å¯ç”¨ç‰¹æ€§ï¼ˆåŒ…æ‹¬Commons, Layouts, SQLite)ã€‚\n\n# ä½¿ç”¨Anko layout\n\n## åˆ›å»ºç®€å•å¸ƒå±€\nä½¿ç”¨Ankoåˆ›å»ºå¸ƒå±€å¾ˆç®€å•ï¼š\n\n```kotlin\nclass MainActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        verticalLayout {\n            padding = dip(30)\n            editText {\n                hint = \"Name\"\n                textSize = 24f\n            }\n            editText {\n                hint = \"Password\"\n                textSize = 24f\n            }\n            button(\"ç™»å½•\") {\n                textSize = 26f\n            }\n        }\n    }\n}\n```\n\nä½ åªéœ€è¦åœ¨Activityä¸­å†™å…¥DSLä»£ç å°±èƒ½ä½¿ç”¨å®ƒã€‚\n\n## AnkoComponent\nå°½ç®¡æˆ‘ä»¬ç°åœ¨å¯ä»¥ç›´æ¥åœ¨Activityä¸­å†™å…¥DSLä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è§‰å¾—æŠŠä»£ç å’Œå¸ƒå±€æ–‡ä»¶æ”¾åœ¨ä¸€èµ·ä¸å¤ªå¥½ï¼Œå¸Œæœ›æŠŠActivityå’ŒDSlä»£ç æ”¾åˆ°ä¸¤ä¸ªä¸åŒçš„ç±»é‡Œé¢ï¼Œæ‰€ä»¥AnkoComponentå°±å‡ºæ¥äº†ã€‚\nä»£ç å¦‚ä¸‹\n```kotlin\nclass MainActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        MainActivityUI().setContentView(this)\n    }\n}\n\nclass MainActivityUI : AnkoComponent<MainActivity> {\n    override fun createView(ui: AnkoContext<MainActivity>) = with(ui) {\n        verticalLayout {\n            padding = dip(30)\n            editText {\n                hint = \"Name\"\n                textSize = 24f\n            }\n            editText {\n                hint = \"Password\"\n                textSize = 24f\n            }\n            button(\"ç™»å½•\") {\n                textSize = 26f\n            }\n        }\n    }\n}\n```\n\n## Theme\nåœ¨Ankoå¦‚æœä½ æƒ³è®¾ç½®Themeéœ€è¦ä½¿ç”¨`themeable`\n```kotlin\nverticalLayout {\n    padding = dip(30)\n    themedButton(\"ç™»é™†\", theme = R.style.Base_TextAppearance_AppCompat_Button)\n}\n```\n\n## LayoutParams\nåœ¨Ankoä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨`LayoutParams`ã€‚\næ¯”æ–¹è¯´æˆ‘ç°åœ¨è¦æ˜¾ç¤ºä¸€ä¸ªbuttonï¼Œä¸‹é¢æ˜¾ç¤ºä¸€ä¸ªå›¾ç‰‡ã€‚\n\nå¦‚æœä½¿ç”¨XML:\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    xmlns:tools=\"http://schemas.android.com/tools\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:orientation=\"vertical\"\n    tools:context=\".MainActivity\">\n\n    <TextView\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:text=\"Hello World!\"\n        android:gravity=center\n        android:textSize=\"20sp\" />\n\n    <ImageView\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\"\n        android:background=\"@color/colorAccent\" />\n\n</LinearLayout>\n```\n\nä½†æ˜¯ä½¿ç”¨Anko:\n\n```kotlin\nverticalLayout {\n    textView (\"Hello World!\") {\n        textSize = sp(12).toFloat()\n    }.lparams(height = wrapContent, width = wrapContent) {\n        horizontalGravity = Gravity.CENTER_HORIZONTAL\n    }\n    imageView {\n        backgroundColor = Color.BLUE\n    }.lparams(height = matchParent, width = matchParent)\n}\n```\n\næ³¨æ„ï¼š\n* `horizontalMargin` åŒæ—¶è®¾ç½® left å’Œ right margins\n* `verticalMargin` åŒæ—¶è®¾ç½® top å’Œ bottom\n* `margin` åŒæ—¶è®¾ç½®4ä¸ªæ–¹å‘çš„ margins\n\n## Listeners\nåœ¨Ankoä¸­è®¾ç½®`Listeners`éå¸¸ç®€å•ï¼Œæˆ‘ä¸‹é¢ä»¥`Button`çš„`OnClick`ä¸¾ä¾‹ï¼š\n```kotlin\nbutton(\"ç™»å½•\") {\n    id = buttonLogin\n    textSize = 26f\n    onClick { toast(\"OnClickLoginButton\") }\n}\n```\n\n## ä½¿ç”¨FragmentåŠ è½½\nå…ˆåˆ›å»ºä¸€ä¸ª`Activity`ï¼ŒæŠŠ`Fragment`åŠ è¿›å»\n```kotlin\nclass AnkoFragmentActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        linearLayout {\n            id = R.id.fragment_id\n            supportFragmentManager.beginTransaction().replace(id, AnkoFragment.newInstance()).commit()\n        }\n    }\n}\n```\nç„¶ååœ¨`Fragment`çš„`onCreateView()`ä¸­åŠ å…¥DSLä»£ç ï¼Œç„¶åè¿”å›`View`å³å¯\n```kotlin\nclass AnkoFragment : Fragment() {\n    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {\n        // return inflater.inflate(R.layout.fragment_anko, container, false)\n        return UI {\n            verticalLayout {\n                editText()\n                button(\"OK\")\n            }\n        }.view\n    }\n    companion object {\n        fun newInstance(): AnkoFragment {\n            return AnkoFragment()\n        }\n    }\n}\n```\n\n## ä¸è¶³\nAnkoLayoutç¡®å®æŒºå¥½çš„ï¼Œå› ä¸ºä»–æŠŠUIä»£ç é›†æˆåˆ°äº†ä»£ç æ–‡ä»¶ä¸­ï¼Œä¸ç”¨å†åƒä»¥å‰ä¸€æ ·å†™ä¸€ä¸ªç‚¹å‡»äº‹ä»¶è¿˜å¾—å…ˆ`findViewBuId`ï¼Œç„¶åå†`setOnClickListeners`ã€‚ä»£ç èƒ½éå¸¸ç®€æ´ã€‚\n\nä½†æ˜¯AnkoLayoutè¿˜æ˜¯ä¸å¤Ÿå®Œç¾ï¼Œæ„Ÿè§‰å†™èµ·æ¥è¿˜æ˜¯æ²¡æœ‰XMLé‚£ä¸ªé¡ºæ‰‹ï¼ˆå¯èƒ½æ˜¯æˆ‘å†™æƒ¯äº†XMLï¼Œåˆšå¼€å§‹ç”¨Ankoè¿˜ä¸å¤Ÿç†Ÿç»ƒï¼‰ï¼Œè€Œä¸”Ankoè¿˜æœ‰å¾ˆå¤šæ§ä»¶éƒ½ä¸æ”¯æŒã€‚\næœ€é‡è¦çš„æ˜¯ï¼Œ**ä»–æ²¡æœ‰å®æ—¶é¢„è§ˆ**ï¼ï¼ï¼\n> Android Studioé‡Œé¢æœ‰ä¸€ä¸ªå«`Anko Support`çš„æ’ä»¶ï¼Œå¯ä»¥å®ç°ankoçš„é¢„è§ˆï¼Œä½†æ˜¯ä»–å¿…é¡»æ˜¯å…ˆå°†é¡¹ç›®æ„å»ºäº†å†é¢„è§ˆçš„ï¼Œä¸ç®—æ˜¯å®æ—¶é¢„è§ˆ","tags":["Android","Kotlin"],"categories":["Kotlin"]},{"title":"Androidç±»ä¹‹SharedPreferences","url":"/posts/8a47fe84.html","content":"# Androidç±»ä¹‹SharedPreferences\n# ç®€ä»‹\nSharedPreferencesæ˜¯ä¸€ä¸ªè½»é‡çš„å­˜å‚¨ç±»ï¼Œç”¨äºæŠŠä¸€äº›åªéœ€è¦å°‘é‡ç®€å•ç±»å‹æ•°æ®ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¾‹å¦‚æœç´¢å†å²ã€ç”¨æˆ·è®¾ç½®ç­‰ã€‚ ä»–åªé€‚åˆå¤„ç†ç®€å•çš„æ•°æ®ï¼Œå¤„ç†å¤ªè¿‡äºåºå¤§çš„æ•°æ®ä¼šå‡æ…¢ç¨‹åºè¿è¡Œã€‚\n\n<!-- More -->\n\n# ä½¿ç”¨æ­¥éª¤\n## 1. å­˜å‚¨æ•°æ®\n1. ä½¿ç”¨Activityç±»çš„getSharedPreferences()æ–¹æ³•è·å¾—SharedPreferenceså¯¹è±¡ï¼Œå…¶ä¸­å­˜å‚¨key-valueçš„æ–‡ä»¶åç”±getSharedPreferences()æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šã€‚\n2. ä½¿ç”¨SharedPreferencesæ¥å£çš„edit()è·å¾—SharedPreferences.Editorå¯¹è±¡ã€‚\n3. é€šè¿‡SharedPreferences.Editoræ¥å£çš„putXxx()æ–¹æ³•ä¿å­˜key-valueå¯¹ï¼Œå…¶ä¸­Xxxè¡¨ç¤ºä¸åŒçš„æ•°æ®ç±»å‹ã€‚ä¾‹å¦‚ï¼šå­—ç¬¦ä¸²ç±»å‹çš„valueéœ€è¦ç”¨putStringæ–¹æ³•ã€‚\n4. é€šè¿‡SharedPreferences.Editoræ¥å£çš„commit()æ–¹æ³•ä¿å­˜key-valueå¯¹ï¼Œcommitæ–¹æ³•ç›¸å½“äºæ•°æ®åº“äº‹åŠ¡ä¸­çš„æäº¤æ“ä½œã€‚\n\n```java\nSharedPreferences sharedPreferences = getSharedPreferences(\"test\", Context.MODE_PRIVATE);\nEditor editor = sharedPreferences.edit();//è·å–ç¼–è¾‘å™¨\neditor.putString(\"name\", \"å°æ˜\");\neditor.putInt(\"age\", 24);\neditor.commit();//æäº¤ä¿®æ”¹\n```\n\n## 2. è¯»å–æ•°æ®\n1. ä½¿ç”¨Activityç±»çš„getSharedPreferences()æ–¹æ³•è·å¾—SharedPreferenceså¯¹è±¡ã€‚\n2. é€šè¿‡SharedPreferenceså¯¹è±¡çš„getXxx()æ–¹æ³•å¾—åˆ°æ•°æ®ã€‚\n\n```java\nSharedPreferences sharedPreferences= getSharedPreferences(\"test\", Activity.MODE_PRIVATE);\n// ä½¿ç”¨getStringæ–¹æ³•è·å¾—valueï¼Œæ³¨æ„ç¬¬2ä¸ªå‚æ•°æ˜¯valueçš„é»˜è®¤å€¼   \nString name =sharedPreferences.getString(\"name\", \"\");\nint age =sharedPreferences.getInt(\"age\", 0);\n```\n`SharedPreferences`çš„å››ç§æ¨¡å¼\n\n```java\nContext.MODE_PRIVATEï¼šä¸ºé»˜è®¤æ“ä½œæ¨¡å¼,ä»£è¡¨è¯¥æ–‡ä»¶æ˜¯ç§æœ‰æ•°æ®,åªèƒ½è¢«åº”ç”¨æœ¬èº«è®¿é—®,åœ¨è¯¥æ¨¡å¼ä¸‹,å†™å…¥çš„å†…å®¹ä¼šè¦†ç›–åŸæ–‡ä»¶çš„å†…å®¹\nContext.MODE_APPENDï¼šæ¨¡å¼ä¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨,å­˜åœ¨å°±å¾€æ–‡ä»¶è¿½åŠ å†…å®¹,å¦åˆ™å°±åˆ›å»ºæ–°æ–‡ä»¶.\nContext.MODE_WORLD_READABLEï¼šè¡¨ç¤ºå½“å‰æ–‡ä»¶å¯ä»¥è¢«å…¶ä»–åº”ç”¨è¯»å–.\nContext.MODE_WORLD_WRITEABLEï¼šè¡¨ç¤ºå½“å‰æ–‡ä»¶å¯ä»¥è¢«å…¶ä»–åº”ç”¨å†™å…¥.\n```","tags":["Android","View"],"categories":["Android"]},{"title":"AndroidViewä¹‹PopupWindow","url":"/posts/1900f7eb.html","content":"# AndroidViewä¹‹PopupWindow\n\nå› ä¸ºé¡¹ç›®ä¸­æœ‰å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ä½¿ç”¨PopupWindowï¼Œæ‰€ä»¥ç‰¹åˆ«æŸ¥äº†ä¸€ä¸‹ï¼Œåšäº†ä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼Œè¿‡ä¸¤å¤©å°±åŠ åˆ°é¡¹ç›®ä¸­å»ã€‚\n\n<!-- More -->\n\n# PopupWindow\nPopupWindowï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªç”¨æ¥æ˜¾ç¤ºå¼¹çª—çš„ç»„ä»¶ã€‚\n\n# åˆ›å»ºæ­¥éª¤\n1. åˆ›å»ºPopupWindowå®ä¾‹\n2. è®¾ç½®ä¸€äº›åŸºæœ¬å‚æ•°\n3. æ˜¾ç¤ºPopupWindow\n# æ„é€ æ–¹æ³•\n\n```java\nPopupWindow window = new PopupWindow(View contentView, int width, int height, boolean focusable);\n```\n\nè¿™ä¸ªæ–¹æ³•æœ‰å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨äºPopupWindowä¸­çš„Viewï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯PopupWindowçš„å®½åº¦ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯PopupWindowçš„é«˜åº¦ï¼Œç¬¬å››ä¸ªå‚æ•°æŒ‡å®šPopupWindowèƒ½å¦è·å¾—ç„¦ç‚¹ã€‚\n\nç¤ºä¾‹ä»£ç \n\n```java\nView contentView = LayoutInflater.from(MainActivity.this).inflate(R.layout.popuplayout, null);\nPopupWindwo window = PopupWindow (contentView, ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, true);\n```\n\n# åŸºæœ¬æ–¹æ³•\n- window.setBackgroundDrawable(Drawable background); è®¾ç½®PopupWindowçš„èƒŒæ™¯\n- window.setOutsideTouchable(boolean touchable); è®¾ç½®PopupWindowæ˜¯å¦èƒ½å“åº”å¤–éƒ¨ç‚¹å‡»äº‹ä»¶\n- window.setTouchable(boolean touchable); è®¾ç½®PopupWindowæ˜¯å¦èƒ½å“åº”ç‚¹å‡»äº‹ä»¶\nåªæœ‰åŒæ—¶è®¾ç½®PopupWindowçš„èƒŒæ™¯å’Œå¯ä»¥å“åº”å¤–éƒ¨ç‚¹å‡»äº‹ä»¶ï¼Œå®ƒæ‰èƒ½â€œçœŸæ­£â€å“åº”å¤–éƒ¨ç‚¹å‡»äº‹ä»¶ã€‚\n\n# æ˜¾ç¤ºPopupWindow\n- window.showAtLocation(View parent, int gravity, int x, int y); ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯PopupWindowçš„çˆ¶Viewï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯PopupWindowç›¸å¯¹çˆ¶Viewçš„ä½ç½®ï¼Œç¬¬ä¸‰å’Œç¬¬å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯PopupWindowç›¸å¯¹çˆ¶Viewçš„xã€yåç§»\n- window.showAsDropDown(View anchor, int xoff, int yoff, int gravity); ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯PopupWindowçš„é”šç‚¹ï¼Œç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯PopupWindowç›¸å¯¹é”šç‚¹çš„xã€yåç§»\n\n# ä¸ºPopupWindowæ·»åŠ åŠ¨ç”»\n- è¿›å…¥æ—¶åŠ¨ç”»ï¼š(context_menu_enter.xml)\n\n```java\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<set xmlns:android=\"http://schemas.android.com/apk/res/android\">\n    <translate\n        android:duration=\"@android:integer/config_shortAnimTime\"\n        android:fromXDelta=\"0\"\n        android:fromYDelta=\"100%p\"\n        android:interpolator=\"@android:anim/accelerate_decelerate_interpolator\"\n        android:toXDelta=\"0\"\n        android:toYDelta=\"0\"/>\n \n</set>\n```\n- é€€å‡ºæ—¶åŠ¨ç”»ï¼š(context_menu_exit.xml)\n\n```java\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<set xmlns:android=\"http://schemas.android.com/apk/res/android\" >\n \n    <translate\n        android:duration=\"@android:integer/config_shortAnimTime\"\n        android:fromXDelta=\"0\"\n        android:fromYDelta=\"0\"\n        android:interpolator=\"@android:anim/accelerate_decelerate_interpolator\"\n        android:toXDelta=\"0\"\n        android:toYDelta=\"100%p\" />\n \n</set>\n```\n- ç”Ÿæˆstyle\n\n```\n<style name=\"contextMenuAnim\" parent=\"@android:style/Animation.Activity\">\n    <item name=\"android:windowEnterAnimation\">@anim/context_menu_enter</item>\n    <item name=\"android:windowExitAnimation\">@anim/context_menu_exit</item>\n</style>\n```","tags":["Android","View"],"categories":["Android"]}]
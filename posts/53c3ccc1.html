<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jetpack源码 之 Lifecycle | littlecorgiの小站</title><meta name="keywords" content="Android,Jetpack,Lifecycle"><meta name="author" content="littlecorgi"><meta name="copyright" content="littlecorgi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Lifecycle是Jetpack中最基础的一类库，他的主要作用就是帮我们实现自动的生命周期监听，那么她是怎么去实现的呢？就让我们一起来看看吧">
<meta property="og:type" content="article">
<meta property="og:title" content="Jetpack源码 之 Lifecycle">
<meta property="og:url" content="https://littlecorgi-twk.github.io/posts/53c3ccc1.html">
<meta property="og:site_name" content="littlecorgiの小站">
<meta property="og:description" content="Lifecycle是Jetpack中最基础的一类库，他的主要作用就是帮我们实现自动的生命周期监听，那么她是怎么去实现的呢？就让我们一起来看看吧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png">
<meta property="article:published_time" content="2020-08-14T08:49:20.000Z">
<meta property="article:modified_time" content="2020-08-14T08:49:20.000Z">
<meta property="article:author" content="littlecorgi">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Jetpack">
<meta property="article:tag" content="Lifecycle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png"><link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png"><link rel="canonical" href="https://littlecorgi-twk.github.io/posts/53c3ccc1"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="pPSnfGmgyTvh0rzyQ5F8JPhJMvyCk5tEfGC0pQgIdbQ"/><meta name="baidu-site-verification" content="nBauC5BcHu"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d96f5834c289ac641e8340af58c61f69";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-08-14 16:49:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="littlecorgiの小站" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/uploads/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标志</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 文档</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Koin"><i class="fa-fw /koin/"></i><span> 0</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">littlecorgiの小站</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标志</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 文档</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Koin"><i class="fa-fw /koin/"></i><span> 0</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Jetpack源码 之 Lifecycle</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-14T08:49:20.000Z" title="发表于 2020-08-14 16:49:20">2020-08-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-14T08:49:20.000Z" title="更新于 2020-08-14 16:49:20">2020-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Jetpack源码 之 Lifecycle"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><h2 id="0-1-用法"><a href="#0-1-用法" class="headerlink" title="0.1 用法"></a>0.1 用法</h2><p>Lifecycle可以说是Jetpack中最基础的一个库，他的主要作用就是帮我们实现的生命周期监听。</p>
<p>对于他的用法也很简单，由于我们的Activity(间接通过<code>ComponentActivity</code>实现)、Fragment(直接实现)都已经实现了<code>LifecycleOwner</code>接口，所以我们可以直接在他们中调用<code>getLifecycle()</code>获得到<code>Lifecycle</code>对象，然后调用他的<code>addObserver()</code>将我们自定义的<code>LifecycleObserver</code>传入进入即可。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 以Activity为例 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MainActivity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_lifecycle_test)</span><br><span class="line">        lifecycle.addObserver(LifecycleObserverTest)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LifecycleObserverTest</span></span><br><span class="line"><span class="keyword">object</span> LifecycleObserverTest : LifecycleObserver &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;LifecycleTest&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">prepare</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// todo 播放器准备工作</span></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;prepare: Create时播放器准备工作&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">release</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// todo 释放资源</span></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;release: Destroy时释放资源&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">play</span><span class="params">(context: <span class="type">Context</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// todo 开始播放</span></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;play&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这样当MainActivity执行<code>onCreate()</code>时会自动执行<code>prepare()</code>方法，执行<code>onDestroy()</code>时会自动执行<code>release()</code>方法，就不需要我们手动的去调用了。</p>
<p>但是这块需要注意的是，这些添加了生命周期的方法，一定不要传入任何参数，因为都已经是自动调用的了，也就我们手动干预不了，那么系统怎么知道你要传入的参数是谁呢。没有添加生命周期的方法不受影响。</p>
<p>另外一个注意的点是，我们调用<code>addObserver()</code>并不是一定得在<code>onCreate()</code>方法中调用，我们在任何地方任何生命周期时调用即可，比方说我们上面在<code>onCreate()</code>中调用了，这样打印出来的log就如下所示：<br><img src="https://cdn.littlecorgi.top/mweb/2020-08-14/Jetpack%E6%BA%90%E7%A0%81%20%E4%B9%8B%20Lifecycle-1-.png" alt="Jetpack源码 之 Lifecycle-1-"></p>
<p>但是如果我们把<code>addObserver()</code>放在<code>onResume()</code>中调用，结果就变成了这样：<br><img src="https://cdn.littlecorgi.top/mweb/2020-08-14/Jetpack%E6%BA%90%E7%A0%81%20%E4%B9%8B%20Lifecycle-2-.png" alt="Jetpack源码 之 Lifecycle-2-"><br>我们就会发现，原本应该在<code>onCreate()</code>时执行的方法却到了<code>onResume()</code>才执行。</p>
<p>所以这点我们一定要注意，我们调用<code>addObserver()</code>一定得在我们监听的生命周期里面或者之前。</p>
<h2 id="0-2-真-·-前言"><a href="#0-2-真-·-前言" class="headerlink" title="0.2 真 · 前言"></a>0.2 真 · 前言</h2><p>看完刚刚的用法，我们能得到的第一个要素就是Lifecycle一定是通过观察者模式实现的，这个从<code>addObserver()</code>就能看出来。</p>
<p>所以我们可以大胆猜想下Lifecycle的实现原理：<br>当调动<code>addObserver()</code>之后，Lifecycle就通过一种数据接口将这个LifecycleObserver的对象保存了起来，当Activity生命周期变化时，他就会遍历这个数据结构，然后调用每一个的对应的生命周期的回调代码。</p>
<p>对应的也就分为两部分：</p>
<ol>
<li>注册</li>
<li>分发</li>
<li>执行回调</li>
</ol>
<p>(PS:突然感觉好像EventBus😂)</p>
<p>接下来我们就可以开始看源码，来验证我们的猜想到底正不正确。</p>
<h1 id="1-注册"><a href="#1-注册" class="headerlink" title="1. 注册"></a>1. 注册</h1><p>注册肯定是从<code>getLifecycle().addObserver(LifecycleObserver observer)</code>开始嘛。</p>
<p>首先，<code>getLifecycle()</code>是谁的方法？</p>
<p>直接通过AndroidStudio的跳转功能就能看到，我们调用的<code>getLifecycle()</code>其实是ComponentActivity的一个方法，进一步跳转就能看到其实是LifecycleOwner这个接口的一个抽象方法。</p>
<p>所以也就是说，Activity继承自ComponentActivity，而ComponentActivity实现了LifecycleOwner接口，这个接口中只有一个方法，那就是<code>getLifecycle()</code>。(Fragment同理)</p>
<p>而这个方法返回的是Lifecycle，那么Lifecycle里面有些啥东西？</p>
<h2 id="1-1-Lifecycle抽象类"><a href="#1-1-Lifecycle抽象类" class="headerlink" title="1.1 Lifecycle抽象类"></a>1.1 Lifecycle抽象类</h2><p>进入Lifecycle的源码就能看到它是一个抽象类，代码也很少：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    AtomicReference&lt;Object&gt; mInternalScopeRef = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> State <span class="title">getCurrentState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        ON_CREATE,</span><br><span class="line">        ON_START,</span><br><span class="line">        ON_RESUME,</span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        ON_STOP,</span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        ON_ANY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        DESTROYED,</span><br><span class="line">        INITIALIZED,</span><br><span class="line">        CREATED,</span><br><span class="line">        STARTED,</span><br><span class="line">        RESUMED;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Lifecycle中有三个方法和两个枚举：</p>
<ul>
<li>三个方法<ul>
<li><code>addObserver()</code>：Adds a LifecycleObserver that will be notified when the LifecycleOwner changes.<br>（添加一个LifecycleObserver，这个LifecycleObserver在LifecycleOwner变化时能得到通知）</li>
<li><code>removeObserver()</code>：Removes the given observer from the observers list.<br>（从observers的集合中移除这个observer）</li>
<li><code>getCurrentState()</code>：Returns the current state of the Lifecycle.<br>（返回当前的生命周期状态(State)）</li>
</ul>
</li>
<li>两个枚举<ul>
<li><code>Event</code>：这个不用多说，对应着Activity、Fragment的基本生命周期</li>
<li><code>State</code>：这个是返回的当前Activity、Fragment的状态，具体转换看下图：</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.littlecorgi.top/mweb/2020-08-14/15973104823930.jpg" alt="关于这个图的来源可以看LifecycleRegistry.getStateAfter()源码"></p>
<p>从上可得知，Lifecycle这个抽象类主要的作用就是</p>
<ul>
<li>添加和移除Observer</li>
<li>获取当前LifecycleOwner的状态，并负责对应的状态和事件的转换</li>
</ul>
<p>那么我们回过头来，<code>getLifecycle()</code>要求返回一个Lifecycle对象，但是Lifecycle是一个抽象类，没办法直接构造对象，那么这个方法返回的是谁？<br>我们直接看ComponentActivity的<code>getLifecycle()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>而这个<code>mLifecycleRegistry</code>是LifecycleRegistry的对象，所以可以得知，Lifecycle其中一个(实际上是唯一)实现类是LifecycleRegistry。</p>
<h2 id="1-2-LifecycleRegistry"><a href="#1-2-LifecycleRegistry" class="headerlink" title="1.2 LifecycleRegistry"></a>1.2 LifecycleRegistry</h2><p>Lifecycle只有唯一一个实现类，那就是LifecycleRegistry。</p>
<p>刚刚说到，注册肯定是有一个Observer的集合，刚刚Lifecycle源码中的注释也说明了这一点，所以我们先从这个类的属性开始看起：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleRegistry</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FastSafeIterableMap&lt;LifecycleObserver, ObserverWithState&gt; mObserverMap =</span><br><span class="line">            <span class="keyword">new</span> FastSafeIterableMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> State mState;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;LifecycleOwner&gt; mLifecycleOwner;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mAddingObserverCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHandlingEvent = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>mObserverMap</code>：用于保存Observer的集合，是一个FastSafeIterableMap集合，而这个FastSafeIterableMap根据源码注释，是类似于LinkedHashMap的，并且它是线程不安全，允许使用迭代器时修改集合的。</li>
<li><code>mState</code>：当前的状态(State)。就是Lifecycle中的那个State枚举类。</li>
<li><code>mLifecycleOwner</code>：就是这个LifecycleRegistry的持有者，这块使用了弱引用，是为了避免对Fragment、Activity直接引用而造成内存泄漏。</li>
<li><code>mAddingObserverCounter</code>：正在添加到mObserverMap中的Observer的数量。</li>
<li><code>mHandlingEvent</code>：是否正在分发事件的标记。</li>
<li><code>mNewEventOccurred</code>：是否有新的事件发生的标记。</li>
</ul>
<p>接着就来分析addObserver方法：</p>
<h3 id="1-2-1-addObserver-NonNull-LifecycleObserver-observer"><a href="#1-2-1-addObserver-NonNull-LifecycleObserver-observer" class="headerlink" title="1.2.1 addObserver(@NonNull LifecycleObserver observer)"></a>1.2.1 addObserver(@NonNull LifecycleObserver observer)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">    <span class="comment">// 根据状态和observer构造出一个statefulObserver</span></span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">    <span class="comment">// 通过observer去mObserverMap查找，如果没有这个key或者值为null，就将value保存进去，如果有value，就取出来赋值给previous</span></span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line">    <span class="comment">// 如果previous不为null，就证明mObserverMap中已经保存了这个observer，就直接return</span></span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取到lifecycleOwner弱引用引用对象</span></span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="comment">// 为null，就证明这个Activity或者Fragment已经Destroy了</span></span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// it is null we should be destroyed. Fallback quickly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有observer正在被加入或者正在分发时间，这个标记就会为true</span></span><br><span class="line">    <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">    <span class="comment">// 计算出目前的State——targetState。</span></span><br><span class="line">    <span class="comment">// -&gt;&gt;&gt; 见1.2.2</span></span><br><span class="line">    State targetState = calculateTargetState(observer);</span><br><span class="line">    <span class="comment">// 代表有一个Observer正在被添加</span></span><br><span class="line">    mAddingObserverCounter++;</span><br><span class="line">    <span class="comment">// 如果当前这个Observer的状态低于targetState并且mObserverMap中还有这个Observer的话，就需要同步到targetState</span></span><br><span class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">        <span class="comment">// 同步时先push进去，临时保存下</span></span><br><span class="line">        pushParentState(statefulObserver.mState);</span><br><span class="line">        <span class="comment">// 分发事件</span></span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">        <span class="comment">// 分发完成再pop出来</span></span><br><span class="line">        popParentState();</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        <span class="comment">// 重新计算targetState</span></span><br><span class="line">        targetState = calculateTargetState(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不可重入，就执行sync方法</span></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        <span class="comment">// sync涉及到了事件分发，我们放到后面说</span></span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; 见 2.2.4</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这个方法主要执行了下面几件事</p>
<ol>
<li>先构造一个默认状态，要么是<code>DESTROYED</code>要么是<code>INITIALIZED</code></li>
<li>然后根据这个<code>observer</code>和这个状态构建出一个<code>statefulObserver</code></li>
<li>就去计算<code>targetState</code>，并对于这个<code>statefulObserver</code>，如果他的<code>state</code>小于<code>targetState</code>，就进行分发时间，并重新计算<code>targetState</code></li>
<li>如果是不可重入状态，则执行<code>sync()</code>方法</li>
</ol>
<h3 id="1-2-2-calculateTargetState-LifecycleObserver-observer"><a href="#1-2-2-calculateTargetState-LifecycleObserver-observer" class="headerlink" title="1.2.2 calculateTargetState(LifecycleObserver observer)"></a>1.2.2 calculateTargetState(LifecycleObserver observer)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> State <span class="title">calculateTargetState</span><span class="params">(LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取出当前observer的前一个Observer</span></span><br><span class="line">    Entry&lt;LifecycleObserver, ObserverWithState&gt; previous = mObserverMap.ceil(observer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到previous的State</span></span><br><span class="line">    State siblingState = previous != <span class="keyword">null</span> ? previous.getValue().mState : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 取出parentState最后一个元素的State</span></span><br><span class="line">    State parentState = !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - <span class="number">1</span>)</span><br><span class="line">            : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 取出这些中最小的State</span></span><br><span class="line">    <span class="keyword">return</span> min(min(mState, siblingState), parentState);</span><br><span class="line">&#125;                                                                                          </span><br></pre></td></tr></table></figure>
<p>所以这个方法的主要作用就是计算<code>targetState</code>，这个<code>targetState</code>一定小于等于当前<code>mState</code>。<br>也就是说，我们可以添加多个Observer，但是每次添加新的Observer的时候，初始状态都是<code>INITIALIZED</code>，这个时候就需要把它同步到当前的生命周期状态。</p>
<p>并且在更新状态的时候，每次更新之后都会调用这个方法再重新计算<code>targetState</code>。</p>
<p>上面就完成了事件的添加了，那我们现在再来看下它是怎么分发事件的。</p>
<h1 id="2-分发"><a href="#2-分发" class="headerlink" title="2. 分发"></a>2. 分发</h1><p>我们再次回到ComponentActivity，他在<code>onCreate()</code>方法中执行了一行代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    mSavedStateRegistryController.performRestore(savedInstanceState);</span><br><span class="line">    ReportFragment.injectIfNeededIn(<span class="keyword">this</span>); <span class="comment">// !!!</span></span><br><span class="line">    <span class="keyword">if</span> (mContentLayoutId != <span class="number">0</span>) &#123;</span><br><span class="line">        setContentView(mContentLayoutId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>那我们看一下这个ReportFragment到底是啥：</p>
<h2 id="2-1-ReportFragment"><a href="#2-1-ReportFragment" class="headerlink" title="2.1 ReportFragment"></a>2.1 ReportFragment</h2><h3 id="2-1-1-ReportFragment-injectIfNeededIn"><a href="#2-1-1-ReportFragment-injectIfNeededIn" class="headerlink" title="2.1.1 ReportFragment # injectIfNeededIn()"></a>2.1.1 ReportFragment # injectIfNeededIn()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ProcessLifecycleOwner should always correctly work and some activities may not extend</span></span><br><span class="line">    <span class="comment">// FragmentActivity from support lib, so we use framework fragments for activities</span></span><br><span class="line">    <span class="comment">// 获取到FragmentManager</span></span><br><span class="line">    android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">    <span class="comment">// 判断当前的FragmentManager里面有没有我们需要的Fragment，没有的话就添加进去</span></span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">        <span class="comment">// Hopefully, we are the first to make a transaction.</span></span><br><span class="line">        manager.executePendingTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这块是不是感觉很眼熟，Android中最常用的监听生命周期的方法就是往Activity中添加一个没有界面的Fragment，这块正是这个操作，所以我们具体看一下ReportFragment的实现。</p>
<h3 id="2-1-2-ReportFragment-生命周期监听"><a href="#2-1-2-ReportFragment-生命周期监听" class="headerlink" title="2.1.2 ReportFragment # 生命周期监听"></a>2.1.2 ReportFragment # 生命周期监听</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">    dispatchCreate(mProcessListener);</span><br><span class="line">    dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStart();</span><br><span class="line">    dispatchStart(mProcessListener);</span><br><span class="line">    dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    dispatchResume(mProcessListener);</span><br><span class="line">    dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStop();</span><br><span class="line">    dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    <span class="comment">// just want to be sure that we won&#x27;t leak reference to an activity</span></span><br><span class="line">    mProcessListener = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是ReportFragment中对生命周期监听的所有方法，我们可以看到这些方法都有两个共性：</p>
<ul>
<li>他们都调用了<code>dispatch()</code>方法去分发生命周期</li>
<li>他们都通知了<code>mProcessListener</code></li>
</ul>
<p>对于<code>mProcessListener</code>，这个是处理应用程序进程的生命周期的，这个我们先不去管它，我们需要重视的是这个<code>dispatch()</code>方法</p>
<h3 id="2-1-3-ReportFragment-dispatch"><a href="#2-1-3-ReportFragment-dispatch" class="headerlink" title="2.1.3 ReportFragment # dispatch()"></a>2.1.3 ReportFragment # dispatch()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    Activity activity = getActivity();</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">        <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们探究的是ComponentActivity，所以肯定是走的第8行的if，然后他就会通过<code>getLifecycle()</code>拿到<code>mLifecycleRegistry</code>，然后调用了他的<code>handleLifecycleEvent(event)</code></p>
<h2 id="2-2-LifecycleRegistry"><a href="#2-2-LifecycleRegistry" class="headerlink" title="2.2 LifecycleRegistry"></a>2.2 LifecycleRegistry</h2><h3 id="2-2-1-LifecycleRegistry-handleLifecycleEvent"><a href="#2-2-1-LifecycleRegistry-handleLifecycleEvent" class="headerlink" title="2.2.1 LifecycleRegistry # handleLifecycleEvent()"></a>2.2.1 LifecycleRegistry # handleLifecycleEvent()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    State next = getStateAfter(event);</span><br><span class="line">    moveToState(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他首先调用了<code>getSateAfter()</code>方法，获取到了当前<code>event</code>对应的State（这个对应关系见上面那个State和Event的对应关系图）。<br>然后调用<code>moveToSate()</code>去分发事件以及移动状态。</p>
<h3 id="2-2-2-LifecycleRegistry-getStateAfter"><a href="#2-2-2-LifecycleRegistry-getStateAfter" class="headerlink" title="2.2.2 LifecycleRegistry # getStateAfter()"></a>2.2.2 LifecycleRegistry # getStateAfter()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> State <span class="title">getStateAfter</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">        <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">        <span class="keyword">case</span> ON_STOP:</span><br><span class="line">            <span class="keyword">return</span> CREATED;</span><br><span class="line">        <span class="keyword">case</span> ON_START:</span><br><span class="line">        <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">            <span class="keyword">return</span> STARTED;</span><br><span class="line">        <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">            <span class="keyword">return</span> RESUMED;</span><br><span class="line">        <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">            <span class="keyword">return</span> DESTROYED;</span><br><span class="line">        <span class="keyword">case</span> ON_ANY:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected event value &quot;</span> + event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个也就是我们上面说的Event和State对照图的来源。</p>
<h3 id="2-2-3-LifecycleRegistry-moveToState"><a href="#2-2-3-LifecycleRegistry-moveToState" class="headerlink" title="2.2.3 LifecycleRegistry # moveToState()"></a>2.2.3 LifecycleRegistry # moveToState()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前状态已经是目标状态了，就不需要改变</span></span><br><span class="line">    <span class="keyword">if</span> (mState == next) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 改变当前状态</span></span><br><span class="line">    mState = next;</span><br><span class="line">    <span class="comment">// 如果正在分发状态，或者有Observer正在添加的话</span></span><br><span class="line">    <span class="keyword">if</span> (mHandlingEvent || mAddingObserverCounter != <span class="number">0</span>) &#123;</span><br><span class="line">        mNewEventOccurred = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// we will figure out what to do on upper level.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分发状态标志位设置为true</span></span><br><span class="line">    mHandlingEvent = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 调用sync方法进行事件分发</span></span><br><span class="line">    sync();</span><br><span class="line">    <span class="comment">// 分发状态标志位设置为false</span></span><br><span class="line">    mHandlingEvent = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法就是将<code>next</code>同步到<code>mState</code>，并进行对应的状态的分发。</p>
<h3 id="2-2-4-LifecycleRegistry-sync"><a href="#2-2-4-LifecycleRegistry-sync" class="headerlink" title="2.2.4 LifecycleRegistry # sync()"></a>2.2.4 LifecycleRegistry # sync()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取出当前的lifecycleOwner，按照我们上面的流程，此处取出的是ComponentActivity</span></span><br><span class="line">    <span class="comment">// (并不一定是这个Activity，只是因为我们是从ComponentActivity入手分析的，也有可能是Fragment)</span></span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="comment">// 如果Owner不存在了，就抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;LifecycleOwner of this LifecycleRegistry is already&quot;</span></span><br><span class="line">                + <span class="string">&quot;garbage collected. It is too late to change lifecycle state.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过isSynced去判断，</span></span><br><span class="line">    <span class="comment">// 这个方法主要是判断mObserverMap的队头和队尾元素的State是否相等，以及队尾元素的State是否等于mState</span></span><br><span class="line">    <span class="comment">// 如果均相等则返回true(不需要进行分发)，否则返回false</span></span><br><span class="line">    <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">        mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// no need to check eldest for nullability, because isSynced does it for us.</span></span><br><span class="line">        <span class="comment">// 如果 mState 小于 mObserverMap 中队头元素的状态值，调用 backwardPass()</span></span><br><span class="line">        <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            backwardPass(lifecycleOwner);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 取出队尾元素</span></span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</span><br><span class="line">        <span class="comment">// 如果mState的状态值大于newest的状态值，则调用forwardPass()</span></span><br><span class="line">        <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            forwardPass(lifecycleOwner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于这是<code>mState</code>已经更新，但是Observers的状态还没更新过，所以肯定是进入第23行的if，也就执行<code>forwardPass()</code>方法</p>
<h3 id="2-2-5-LifecycleRegistry-forwardPass"><a href="#2-2-5-LifecycleRegistry-forwardPass" class="headerlink" title="2.2.5 LifecycleRegistry # forwardPass()"></a>2.2.5 LifecycleRegistry # forwardPass()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过iteratorWithAdditions去安全的并在遍历时能遍历到所有新增的元素的遍历方式去遍历mObservers集合</span></span><br><span class="line">    Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</span><br><span class="line">            mObserverMap.iteratorWithAdditions();</span><br><span class="line">    <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</span><br><span class="line">        ObserverWithState observer = entry.getValue();</span><br><span class="line">        <span class="comment">// 向上传递事件，直到 observer 的状态值等于当前状态值</span></span><br><span class="line">        <span class="keyword">while</span> ((observer.mState.compareTo(mState) &lt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">            <span class="comment">// 和addObserver中一样的操作</span></span><br><span class="line">            <span class="comment">// 先临时保存</span></span><br><span class="line">            pushParentState(observer.mState);</span><br><span class="line">            <span class="comment">// 分发事件</span></span><br><span class="line">            observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));</span><br><span class="line">            <span class="comment">// 移除</span></span><br><span class="line">            popParentState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * upEvent()</span></span><br><span class="line"><span class="comment"> * state升级所需要经历的事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Event <span class="title">upEvent</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZED:</span><br><span class="line">        <span class="keyword">case</span> DESTROYED:</span><br><span class="line">            <span class="keyword">return</span> ON_CREATE;</span><br><span class="line">        <span class="keyword">case</span> CREATED:</span><br><span class="line">            <span class="keyword">return</span> ON_START;</span><br><span class="line">        <span class="keyword">case</span> STARTED:</span><br><span class="line">            <span class="keyword">return</span> ON_RESUME;</span><br><span class="line">        <span class="keyword">case</span> RESUMED:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected state value &quot;</span> + state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这块我们就差不多能理解他的一个流程了，假设我们上面的流程是从<code>ON_CREATE</code>到<code>ON_RESUME</code>，那么这个流程就是：</p>
<ol>
<li>ReportFragment通过监听生命周期变化，调用了<code>dispatch(Lifecycle.Event.ON_RESUME)</code>；</li>
<li>在<code>dispatch()</code>中则执行了LifecycleRegistry的<code>handleLifecycleEvent()</code>方法，参数是<code>ON_RESUME</code>；</li>
<li>通过<code>getStateAfter()</code>返回<code>RESUMED</code>，在调用<code>moveToState()</code>跳转到<code>RESUMED</code>；</li>
<li>这时将<code>mSate</code>更新为<code>RESUMED</code>，然后调用<code>sync()</code>方法</li>
<li>在<code>sync()</code>方法中，由于<code>mSate</code>是<code>RESUMED</code>状态，而<code>mObserverMap</code>中的状态都是<code>STARTED</code>，那么<code>mState</code>大于<code>mObserverMap</code>，就执行<code>forwardPass()</code>方法</li>
<li>最后就会调用<code>observer.dispatchEvent()</code>去分发事件</li>
</ol>
<h3 id="2-2-6-LifecycleRegistry-backwardPass"><a href="#2-2-6-LifecycleRegistry-backwardPass" class="headerlink" title="2.2.6 LifecycleRegistry # backwardPass()"></a>2.2.6 LifecycleRegistry # backwardPass()</h3><p>刚刚看完了上面的代码和流程，那么既然有<code>forwardPass()</code>，对应的<code>backwardPass()</code>有啥作用呢？</p>
<p>我们还是假设一下流程，我们刚刚说到了<code>ON_RESUME</code>，那么我们假设从<code>ON_RESUME</code>到<code>ON_PAUSE</code>，再来看一下刚刚的流程，和刚刚的流程一样的：</p>
<ol>
<li>ReportFragment通过监听生命周期变化，调用了<code>dispatch(Lifecycle.Event.ON_PAUSE)</code>；</li>
<li>在<code>dispatch()</code>中则执行了LifecycleRegistry的<code>handleLifecycleEvent()</code>方法，参数是<code>ON_PAUSE</code>；</li>
<li>通过<code>getStateAfter()</code>返回<code>STARTED</code>，在调用<code>moveToState()</code>跳转到<code>STARTED</code>；</li>
<li>这时将<code>mSate</code>更新为<code>STARTED</code>，然后调用<code>sync()</code>方法</li>
<li>在<code>sync()</code>方法中，由于<code>mSate</code>是<code>STARTED</code>状态，而<code>mObserverMap</code>中的状态都是<code>RESUMED</code>，那么<code>mState</code>小于<code>mObserverMap</code>，就执行<code>backwardPass()</code>方法</li>
<li>最后就会调用<code>observer.dispatchEvent()</code>去分发事件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 和 forwardPass() 差不多</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">    Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; descendingIterator =</span><br><span class="line">            mObserverMap.descendingIterator();</span><br><span class="line">    <span class="keyword">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next();</span><br><span class="line">        ObserverWithState observer = entry.getValue();</span><br><span class="line">        <span class="keyword">while</span> ((observer.mState.compareTo(mState) &gt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            Event event = downEvent(observer.mState);</span><br><span class="line">            pushParentState(getStateAfter(event));</span><br><span class="line">            observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">            popParentState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * downEvent()</span></span><br><span class="line"><span class="comment"> * state降级所需经历的事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Event <span class="title">downEvent</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZED:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">case</span> CREATED:</span><br><span class="line">            <span class="keyword">return</span> ON_DESTROY;</span><br><span class="line">        <span class="keyword">case</span> STARTED:</span><br><span class="line">            <span class="keyword">return</span> ON_STOP;</span><br><span class="line">        <span class="keyword">case</span> RESUMED:</span><br><span class="line">            <span class="keyword">return</span> ON_PAUSE;</span><br><span class="line">        <span class="keyword">case</span> DESTROYED:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected state value &quot;</span> + state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面就是事件分发的过程。</p>
<p>那么剩下最后一个问题，怎么执行回调方法？</p>
<h1 id="3-执行回调"><a href="#3-执行回调" class="headerlink" title="3. 执行回调"></a>3. 执行回调</h1><p>其实这块我们刚刚已经提到过了，那就是在<code>sync()</code>方法中会调用<code>forwardPass()</code>和<code>backwardPass()</code>方法，这两个方法中都会调用<code>observer.dispatchEvent(lifecycleOwner, event)</code>方法，所以我们就从这个入手。</p>
<p>首先我们回顾下，我们添加进去的<code>observer</code>到底是谁？<br>回到<code>addObserver()</code>方法，在这个方法内部的第二行和第三行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br></pre></td></tr></table></figure><br>可以看到我们取出来的<code>observer</code>其实就是这块的这个<code>statefulObserver</code>，他是调用了ObserverWithState的构造方法构造出来的，并且我们后面也是调用的他的<code>dispatchEvent()</code>方法，那我们就直接来看一下这个类：</p>
<h2 id="3-1-ObserverWithState"><a href="#3-1-ObserverWithState" class="headerlink" title="3.1 ObserverWithState"></a>3.1 ObserverWithState</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = getStateAfter(event);</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这个源码可以看到，它里面有两个参数，一个是<code>mSate</code>，这个就是这个Observer当前的状态，另一个就是<code>mLifecycleObserver</code>，这个也就是我们传入的Observer，但是他并不是直接拿着我们传入的<code>observer</code>使用，而是调用<code>Lifecycling.lifecycleEventObserver()</code>返回了一个值，那我们看一下这个方法到底是啥：</p>
<h3 id="3-1-1-Lifecycling"><a href="#3-1-1-Lifecycling" class="headerlink" title="3.1.1 Lifecycling"></a>3.1.1 Lifecycling</h3><h4 id="3-1-1-1-Lifecycling-lifecycleEventObserver"><a href="#3-1-1-1-Lifecycling-lifecycleEventObserver" class="headerlink" title="3.1.1.1 Lifecycling # lifecycleEventObserver()"></a>3.1.1.1 Lifecycling # lifecycleEventObserver()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> LifecycleEventObserver <span class="title">lifecycleEventObserver</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是不是这两种类型的对象</span></span><br><span class="line">    <span class="keyword">boolean</span> isLifecycleEventObserver = object <span class="keyword">instanceof</span> LifecycleEventObserver;</span><br><span class="line">    <span class="keyword">boolean</span> isFullLifecycleObserver = object <span class="keyword">instanceof</span> FullLifecycleObserver;</span><br><span class="line">    <span class="comment">// 判断是哪种，返回对应的</span></span><br><span class="line">    <span class="comment">// 但是我们是构造的LifecycleObserver的子类，所以不满足下面这三种if</span></span><br><span class="line">    <span class="keyword">if</span> (isLifecycleEventObserver &amp;&amp; isFullLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FullLifecycleObserverAdapter((FullLifecycleObserver) object,</span><br><span class="line">                (LifecycleEventObserver) object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isFullLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FullLifecycleObserverAdapter((FullLifecycleObserver) object, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isLifecycleEventObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> (LifecycleEventObserver) object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得到他的class对象</span></span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; klass = object.getClass();</span><br><span class="line">    <span class="comment">// -&gt;&gt;&gt; 备注1</span></span><br><span class="line">    <span class="comment">// 获取 type</span></span><br><span class="line">    <span class="comment">//   GENERATED_CALLBACK 表示注解生成的代码</span></span><br><span class="line">    <span class="comment">//   REFLECTIVE_CALLBACK 表示使用反射</span></span><br><span class="line">    <span class="keyword">int</span> type = getObserverConstructorType(klass);</span><br><span class="line">    <span class="keyword">if</span> (type == GENERATED_CALLBACK) &#123;</span><br><span class="line">        List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; constructors =</span><br><span class="line">                sClassToAdapters.get(klass);</span><br><span class="line">        <span class="keyword">if</span> (constructors.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            GeneratedAdapter generatedAdapter = createGeneratedAdapter(</span><br><span class="line">                    constructors.get(<span class="number">0</span>), object);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SingleGeneratedAdapterObserver(generatedAdapter);</span><br><span class="line">        &#125;</span><br><span class="line">        GeneratedAdapter[] adapters = <span class="keyword">new</span> GeneratedAdapter[constructors.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructors.size(); i++) &#123;</span><br><span class="line">            adapters[i] = createGeneratedAdapter(constructors.get(i), object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CompositeGeneratedAdaptersObserver(adapters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveGenericLifecycleObserver(object);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 备注1</span></span><br><span class="line"><span class="comment"> * 返回构造方法的类型</span></span><br><span class="line"><span class="comment"> *   先从缓存(sCallbackCache)中找，有则直接返回</span></span><br><span class="line"><span class="comment"> *   没有则调用resolveObserverCallbackType方法获取并将结果缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getObserverConstructorType</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断缓存里面有没有，如果有则直接返回</span></span><br><span class="line">    Integer callbackCache = sCallbackCache.get(klass);</span><br><span class="line">    <span class="keyword">if</span> (callbackCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> callbackCache;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// -&gt;&gt;&gt; 备注2</span></span><br><span class="line">    <span class="keyword">int</span> type = resolveObserverCallbackType(klass);</span><br><span class="line">    sCallbackCache.put(klass, type);</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 备注2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resolveObserverCallbackType</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// anonymous class bug:35073837</span></span><br><span class="line">    <span class="comment">// 获得包名，如果为null，则是匿名内部类</span></span><br><span class="line">    <span class="keyword">if</span> (klass.getCanonicalName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 对应返回，表示使用反射</span></span><br><span class="line">        <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寻找注解生成的 GeneratedAdapter 类</span></span><br><span class="line">    Constructor&lt;? extends GeneratedAdapter&gt; constructor = generatedConstructor(klass);</span><br><span class="line">    <span class="keyword">if</span> (constructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sClassToAdapters.put(klass, Collections</span><br><span class="line">                .&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt;singletonList(constructor));</span><br><span class="line">        <span class="keyword">return</span> GENERATED_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寻找被OnLifecycleEvent注解的方法</span></span><br><span class="line">    <span class="keyword">boolean</span> hasLifecycleMethods = ClassesInfoCache.sInstance.hasLifecycleMethods(klass);</span><br><span class="line">    <span class="keyword">if</span> (hasLifecycleMethods) &#123;</span><br><span class="line">        <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有找到注解生成的 GeneratedAdapter 类，也没有找到 OnLifecycleEvent 注解，</span></span><br><span class="line">    <span class="comment">// 则向上寻找父类</span></span><br><span class="line">    Class&lt;?&gt; superclass = klass.getSuperclass();</span><br><span class="line">    List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; adapterConstructors = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isLifecycleParent(superclass)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getObserverConstructorType(superclass) == REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">            <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        adapterConstructors = <span class="keyword">new</span> ArrayList&lt;&gt;(sClassToAdapters.get(superclass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寻找是否有接口实现</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intrface : klass.getInterfaces()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isLifecycleParent(intrface)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getObserverConstructorType(intrface) == REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">            <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (adapterConstructors == <span class="keyword">null</span>) &#123;</span><br><span class="line">            adapterConstructors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        adapterConstructors.addAll(sClassToAdapters.get(intrface));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (adapterConstructors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sClassToAdapters.put(klass, adapterConstructors);</span><br><span class="line">        <span class="keyword">return</span> GENERATED_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中我们需要注意的是<code>hasLifecycleMethods</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasLifecycleMethods</span><span class="params">(Class klass)</span> </span>&#123;</span><br><span class="line">    Boolean hasLifecycleMethods = mHasLifecycleMethods.get(klass);</span><br><span class="line">    <span class="keyword">if</span> (hasLifecycleMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> hasLifecycleMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method[] methods = getDeclaredMethods(klass);</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Optimization for reflection, we know that this method is called</span></span><br><span class="line">            <span class="comment">// when there is no generated adapter. But there are methods with @OnLifecycleEvent</span></span><br><span class="line">            <span class="comment">// so we know that will use ReflectiveGenericLifecycleObserver,</span></span><br><span class="line">            <span class="comment">// so we createInfo in advance.</span></span><br><span class="line">            <span class="comment">// CreateInfo always initialize mHasLifecycleMethods for a class, so we don&#x27;t do it</span></span><br><span class="line">            <span class="comment">// here.</span></span><br><span class="line">            createInfo(klass, methods);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mHasLifecycleMethods.put(klass, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这个代码就没啥好说的，单纯通过反射去找OnLifecycleEvent注解，所以综上所述，我们通过OnLifecycleEvent注解实现的Observer则返回的是<code>REFLECTIVE_CALLBACK</code>类型，对应的<code>lifecycleEventObserver()</code>方法返回的也是<code>new ReflectiveGenericLifecycleObserver(observer)</code>。</p>
<h3 id="3-1-2-ReflectiveGenericLifecycleObserver"><a href="#3-1-2-ReflectiveGenericLifecycleObserver" class="headerlink" title="3.1.2 ReflectiveGenericLifecycleObserver"></a>3.1.2 ReflectiveGenericLifecycleObserver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectiveGenericLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 我们传入的observer对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mWrapped;</span><br><span class="line">    <span class="comment">// 通过反射从这个observer对象中获取的信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CallbackInfo mInfo;</span><br><span class="line"></span><br><span class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;</span><br><span class="line">        mWrapped = wrapped;</span><br><span class="line">        <span class="comment">// 通过反射来获取信息，但是代码太长，也很简单，就不详细去说了</span></span><br><span class="line">        mInfo = ClassesInfoCache.sInstance.getInfo(mWrapped.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Event event)</span> </span>&#123;</span><br><span class="line">        mInfo.invokeCallbacks(source, event, mWrapped);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而我们之前的<code>observer.dispatchEvent()</code>方法中实际上调用的是<code>mLifecycleObserver.onStateChanged(owner, event)</code>，所以最后会交给ReflectiveGenericLifecycleObserver的<code>onStateChanged()</code>方法来执行，而这个方法中又调用了<code>mInfo.invokeCallbacks()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeCallbacks</span><span class="params">(LifecycleOwner source, Lifecycle.Event event, Object target)</span> </span>&#123;</span><br><span class="line">    invokeMethodsForEvent(mEventToHandlers.get(event), source, event, target);</span><br><span class="line">    invokeMethodsForEvent(mEventToHandlers.get(Lifecycle.Event.ON_ANY), source, event,</span><br><span class="line">            target);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeMethodsForEvent</span><span class="params">(List&lt;MethodReference&gt; handlers,</span></span></span><br><span class="line"><span class="function"><span class="params">        LifecycleOwner source, Lifecycle.Event event, Object mWrapped)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (handlers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = handlers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            handlers.get(i).invokeCallback(source, event, mWrapped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(LifecycleOwner source, Lifecycle.Event event, Object target)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//noinspection TryWithIdenticalCatches</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mCallType) &#123;</span><br><span class="line">            <span class="keyword">case</span> CALL_TYPE_NO_ARG:</span><br><span class="line">                mMethod.invoke(target);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CALL_TYPE_PROVIDER:</span><br><span class="line">                mMethod.invoke(target, source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CALL_TYPE_PROVIDER_WITH_EVENT:</span><br><span class="line">                mMethod.invoke(target, source, event);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to call observer method&quot;</span>, e.getCause());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这个代码就很简单了，就是利用反射去执行。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">littlecorgi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://littlecorgi-twk.github.io/posts/53c3ccc1.html">https://littlecorgi-twk.github.io/posts/53c3ccc1.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://littlecorgi-twk.github.io" target="_blank">littlecorgiの小站</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Jetpack/">Jetpack</a><a class="post-meta__tags" href="/tags/Lifecycle/">Lifecycle</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/28011e4e.html"><img class="prev-cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Jetpack源码 之 LiveData</div></div></a></div><div class="next-post pull-right"><a href="/posts/24e17cf4.html"><img class="next-cover" src="https://dignitas.digital/wp-content/uploads/2019/02/SharedAndroid2-e1550504097495.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android源码之SharedPreferences</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/b1488352.html" title="Jetpack入门 之 LiveData的map()和switchMap"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-08-14</div><div class="title">Jetpack入门 之 LiveData的map()和switchMap</div></div></a></div><div><a href="/posts/28011e4e.html" title="Jetpack源码 之 LiveData"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-08-22</div><div class="title">Jetpack源码 之 LiveData</div></div></a></div><div><a href="/posts/b309316d.html" title="Jetpack源码 之 ViewModel"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-09-10</div><div class="title">Jetpack源码 之 ViewModel</div></div></a></div><div><a href="/posts/1900f7eb.html" title="AndroidView之PopupWindow"><img class="cover" src="https://i.loli.net/2019/11/10/71wgohfPHqXRbG9.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-05-31</div><div class="title">AndroidView之PopupWindow</div></div></a></div><div><a href="/posts/63ab42b7.html" title="Android多线程1--Java中的阻塞队列"><img class="cover" src="https://i.loli.net/2019/11/10/71wgohfPHqXRbG9.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-06-16</div><div class="title">Android多线程1--Java中的阻塞队列</div></div></a></div><div><a href="/posts/b39fd0ab.html" title="Android多线程2--Java中的线程池"><img class="cover" src="https://i.loli.net/2019/11/10/71wgohfPHqXRbG9.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-06-16</div><div class="title">Android多线程2--Java中的线程池</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/uploads/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">littlecorgi</div><div class="author-info__description">兴趣使然的个人小站，不定时分享Android等技术博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/littlecorgi-twk" target="_blank" title=""><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:littlecorgi.twk@gmail.com" target="_blank" title=""><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">目前准备面试中，面试完了再更新博客。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-1-%E7%94%A8%E6%B3%95"><span class="toc-text">0.1 用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0-2-%E7%9C%9F-%C2%B7-%E5%89%8D%E8%A8%80"><span class="toc-text">0.2 真 · 前言</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%B3%A8%E5%86%8C"><span class="toc-text">1. 注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Lifecycle%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-text">1.1 Lifecycle抽象类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-LifecycleRegistry"><span class="toc-text">1.2 LifecycleRegistry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-addObserver-NonNull-LifecycleObserver-observer"><span class="toc-text">1.2.1 addObserver(@NonNull LifecycleObserver observer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-calculateTargetState-LifecycleObserver-observer"><span class="toc-text">1.2.2 calculateTargetState(LifecycleObserver observer)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%88%86%E5%8F%91"><span class="toc-text">2. 分发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ReportFragment"><span class="toc-text">2.1 ReportFragment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-ReportFragment-injectIfNeededIn"><span class="toc-text">2.1.1 ReportFragment # injectIfNeededIn()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-ReportFragment-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9B%91%E5%90%AC"><span class="toc-text">2.1.2 ReportFragment # 生命周期监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-ReportFragment-dispatch"><span class="toc-text">2.1.3 ReportFragment # dispatch()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-LifecycleRegistry"><span class="toc-text">2.2 LifecycleRegistry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-LifecycleRegistry-handleLifecycleEvent"><span class="toc-text">2.2.1 LifecycleRegistry # handleLifecycleEvent()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-LifecycleRegistry-getStateAfter"><span class="toc-text">2.2.2 LifecycleRegistry # getStateAfter()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-LifecycleRegistry-moveToState"><span class="toc-text">2.2.3 LifecycleRegistry # moveToState()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-LifecycleRegistry-sync"><span class="toc-text">2.2.4 LifecycleRegistry # sync()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-LifecycleRegistry-forwardPass"><span class="toc-text">2.2.5 LifecycleRegistry # forwardPass()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-LifecycleRegistry-backwardPass"><span class="toc-text">2.2.6 LifecycleRegistry # backwardPass()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8C%E5%9B%9E%E8%B0%83"><span class="toc-text">3. 执行回调</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ObserverWithState"><span class="toc-text">3.1 ObserverWithState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-Lifecycling"><span class="toc-text">3.1.1 Lifecycling</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-1-Lifecycling-lifecycleEventObserver"><span class="toc-text">3.1.1.1 Lifecycling # lifecycleEventObserver()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-ReflectiveGenericLifecycleObserver"><span class="toc-text">3.1.2 ReflectiveGenericLifecycleObserver</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/79199b37.html" title="深入理解JVM-Reference源码"><img src="https://raw.githubusercontent.com/zxh0/jvmgo-book/master/v1/gophers/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解JVM-Reference源码"/></a><div class="content"><a class="title" href="/posts/79199b37.html" title="深入理解JVM-Reference源码">深入理解JVM-Reference源码</a><time datetime="2021-03-21T14:15:24.000Z" title="更新于 2021-03-21 22:15:24">2021-03-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f5a785d7.html" title="Koin-12-Koin for Android"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-12-Koin for Android"/></a><div class="content"><a class="title" href="/posts/f5a785d7.html" title="Koin-12-Koin for Android">Koin-12-Koin for Android</a><time datetime="2020-10-07T13:25:34.000Z" title="更新于 2020-10-07 21:25:34">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ebed2a69.html" title="Koin-11-Koin for Java"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-11-Koin for Java"/></a><div class="content"><a class="title" href="/posts/ebed2a69.html" title="Koin-11-Koin for Java">Koin-11-Koin for Java</a><time datetime="2020-10-07T13:25:27.000Z" title="更新于 2020-10-07 21:25:27">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/63fa5724.html" title="Koin-10-Testing(测试)"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-10-Testing(测试)"/></a><div class="content"><a class="title" href="/posts/63fa5724.html" title="Koin-10-Testing(测试)">Koin-10-Testing(测试)</a><time datetime="2020-10-07T13:25:15.000Z" title="更新于 2020-10-07 21:25:15">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f85e8eae.html" title="Koin-9-Koin Components(组件)"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-9-Koin Components(组件)"/></a><div class="content"><a class="title" href="/posts/f85e8eae.html" title="Koin-9-Koin Components(组件)">Koin-9-Koin Components(组件)</a><time datetime="2020-10-07T13:25:00.000Z" title="更新于 2020-10-07 21:25:00">2020-10-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By littlecorgi</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://littlecorgi.top/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
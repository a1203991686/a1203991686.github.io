<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jetpack源码 之 LiveData | littlecorgiの小站</title><meta name="description" content="LiveData是Jetpack中一个响应式开发框架，官方文档对它的说明是一种可观察的数据存储器类，具有生命周期感知能力。有点类似于感知生命周期的RxJava。"><meta name="keywords" content="Android,Jetpack,MVVM,LiveData"><meta name="author" content="littlecorgi"><meta name="copyright" content="littlecorgi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png"><link rel="canonical" href="https://a1203991686.github.io/posts/28011e4e.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="pPSnfGmgyTvh0rzyQ5F8JPhJMvyCk5tEfGC0pQgIdbQ"/><meta name="baidu-site-verification" content="nBauC5BcHu"/><meta property="og:type" content="article"><meta property="og:title" content="Jetpack源码 之 LiveData"><meta property="og:url" content="https://a1203991686.github.io/posts/28011e4e.html"><meta property="og:site_name" content="littlecorgiの小站"><meta property="og:description" content="LiveData是Jetpack中一个响应式开发框架，官方文档对它的说明是一种可观察的数据存储器类，具有生命周期感知能力。有点类似于感知生命周期的RxJava。"><meta property="og:image" content="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png"><meta property="article:published_time" content="2020-08-22T08:24:50.000Z"><meta property="article:modified_time" content="2020-08-22T08:24:50.000Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d96f5834c289ac641e8340af58c61f69";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '天',
  date_suffix: {"one_hour":"刚刚","hours":"小时前","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-22 16:24:50'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = '1'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="littlecorgiの小站" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/uploads/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">52</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">42</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标志</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jetpack%E6%BA%90%E7%A0%81-%E4%B9%8B-LiveData"><span class="toc-text">Jetpack源码 之 LiveData</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-1-%E7%94%A8%E6%B3%95"><span class="toc-text">0.1 用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0-2-%E6%BA%90%E7%A0%81"><span class="toc-text">0.2 源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-MutableLiveData"><span class="toc-text">1. MutableLiveData</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-LiveData"><span class="toc-text">2. LiveData</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%9F%BA%E6%9C%AC%E5%B1%9E%E6%80%A7"><span class="toc-text">2.1 基本属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-LiveData-postValue"><span class="toc-text">2.3 LiveData # postValue()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-LiveData-observer"><span class="toc-text">2.4 LiveData # observer()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-LiveData-dispatchingValue"><span class="toc-text">2.5 LiveData # dispatchingValue()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-LiveData-considerNotify"><span class="toc-text">2.6 LiveData # considerNotify()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-LifecycleWrapper"><span class="toc-text">3. LifecycleWrapper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-LifecycleWrapper"><span class="toc-text">3.1 LifecycleWrapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-LifecycleBoundObserver"><span class="toc-text">3.2 LifecycleBoundObserver</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%80%BB%E7%BB%93"><span class="toc-text">4. 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%80%BB%E7%BB%93%E5%92%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">4.1 总结和流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E6%B7%BB%E5%8A%A0%E8%A7%82%E5%AF%9F%E8%80%85"><span class="toc-text">4.1.1 添加观察者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE"><span class="toc-text">4.1.2 设置数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">4.1.3 流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-LiveData%E7%9C%9F%E7%9A%84%E5%8F%AF%E4%BB%A5%E8%A2%AB%E7%94%A8%E4%BA%8E%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E5%90%97"><span class="toc-text">4.2 LiveData真的可以被用于事件分发吗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-postValue-%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1"><span class="toc-text">4.2.1 postValue 数据丢失</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-considerNotify-%E4%B8%8D%E5%9B%9E%E8%B0%83%E8%A7%82%E5%AF%9F%E8%80%85"><span class="toc-text">4.2.2 considerNotify 不回调观察者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-LiveData%E6%9C%AC%E6%9D%A5%E5%B0%B1%E4%B8%8D%E6%98%AF%E4%B8%BA%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%89%93%E9%80%A0%E7%9A%84"><span class="toc-text">4.2.3 LiveData本来就不是为事件分发打造的</span></a></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">littlecorgiの小站</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标志</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Jetpack源码 之 LiveData</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-22T08:24:50.000Z" title="发表于 2020-08-22 16:24:50">2020-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-22T08:24:50.000Z" title="更新于 2020-08-22 16:24:50">2020-08-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Jetpack源码-之-LiveData"><a href="#Jetpack源码-之-LiveData" class="headerlink" title="Jetpack源码 之 LiveData"></a>Jetpack源码 之 LiveData</h1><h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>LiveData是Jetpack中一个响应式开发框架，官方文档对它的说明是一种可观察的数据存储器类，具有生命周期感知能力。有点类似于感知生命周期的RxJava。</p>
<h2 id="0-1-用法"><a href="#0-1-用法" class="headerlink" title="0.1 用法"></a>0.1 用法</h2><p>通常LiveData都是结合着ViewModel使用的，一般都是在ViewModel中创建LiveData：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MvvmViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过MutableLiveData创建一个可读可写的LiveData</span></span><br><span class="line">    <span class="comment">// 设置为Private，避免外部对数据直接进行修改，并暴露对外接口，让外部通过接口来修改</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _count = MutableLiveData(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 暴露给外部一个只读的LiveData副本，让外部监听数据通过此LiveData监听</span></span><br><span class="line">    <span class="keyword">val</span> count: LiveData&lt;<span class="built_in">Int</span>&gt;</span><br><span class="line">        <span class="keyword">get</span>() = _count</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">increaseCount</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _count.value = _count.value?.plus(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clearCount</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _count.value = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0-2-源码"><a href="#0-2-源码" class="headerlink" title="0.2 源码"></a>0.2 源码</h2><p>LiveData源码其实挺简单的，但是在看他的源码之前得先了解Lifecycle的源码，因为LiveData其实是大量通过Lifecycle实现的。关于Lifecycle的源码我们之前看过了，所以此篇博客不会讨论Lifecycle的相关问题。</p>
<p>我们在阅读源码前，首先得清除我们需要从源码里面搞懂哪些问题：</p>
<ol>
<li>首先，我们在用法上有MutableLiveData和LiveData， 那么他们的区别是啥</li>
<li>官方给LiveData定义是一个可被观察的数据存储类，那么他的可被观察是怎么实现的</li>
<li>官方还说他是生命周期感知的，那么是怎么实现的</li>
</ol>
<p>带着这三个问题，我们来看源码：</p>
<h1 id="1-MutableLiveData"><a href="#1-MutableLiveData" class="headerlink" title="1. MutableLiveData"></a>1. MutableLiveData</h1><p>这个类是我们用来可读可写的LiveData，我们对值的修改都是通过这个类的，那我们来看下他的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MutableLiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    MutableLiveData() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.postValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>源码就这么点，全是调用父类的方法，而他的父类就是LiveData类。<br>那么既然这些方法都是调用的LiveData的，那么为什么我们不直接使用LiveData而要去使用MutableLiveData呢？</p>
<p>当你看到LiveData源码时就能知道，LiveData虽然有这些方法，但是他是一个抽象类，没办法直接构造对象，所以我们就需要通过MutableLiveData来操作。<br>同时，LiveData的<code>setValue()</code>和<code>postValue()</code>方法都是被protected修饰的，所以我们在外部并没有办法直接访问到，而MutableLiveData的这两个方法是public的，所以可以在外部直接调用。</p>
<h1 id="2-LiveData"><a href="#2-LiveData" class="headerlink" title="2. LiveData"></a>2. LiveData</h1><h2 id="2-1-基本属性"><a href="#2-1-基本属性" class="headerlink" title="2.1 基本属性"></a>2.1 基本属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 数据锁，通过Synchronized线程同步</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line">    <span class="keyword">final</span> Object mDataLock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="comment">// LiveData的初始化版本</span></span><br><span class="line">    <span class="comment">// 如果构造方法中没有给值，那么 mVersion 直接使用此值</span></span><br><span class="line">    <span class="comment">// 如果给值，那么 mVersion=START_VERSION+1</span></span><br><span class="line">    <span class="comment">// 见下面构造方法</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START_VERSION = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// mData的默认值</span></span><br><span class="line">    <span class="comment">// 如果构造方法传值，那么mData使用传入的值</span></span><br><span class="line">    <span class="comment">// 如果没有，则使用此值</span></span><br><span class="line">    <span class="comment">// 见下面构造方法</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object NOT_SET = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个SafeIterableMap，用来保存监听的对象，key是观察者对象，value是观察者和mActive、mVersion构成的一个对象</span></span><br><span class="line">    <span class="comment">// SafeIterableMap是一个可以安全递归的HashMap</span></span><br><span class="line">    <span class="keyword">private</span> SafeIterableMap&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt; mObservers =</span><br><span class="line">            <span class="keyword">new</span> SafeIterableMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 活跃的Obsever的数量</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line">    <span class="keyword">int</span> mActiveCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 当前LiveData的数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object mData;</span><br><span class="line">    <span class="comment">// 当setData被调用时，我们就设置挂起的数据，实际的数据交换发生在主线程上</span></span><br><span class="line">    <span class="comment">// 咋一看有点迷，看不懂这个注释的意思，但是当我们看完postValue方法后再来看这个就能理解了</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line">    <span class="keyword">volatile</span> Object mPendingData = NOT_SET;</span><br><span class="line">    <span class="comment">// LiveData版本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVersion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否正在分发数据的flag</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mDispatchingValue;</span><br><span class="line">    <span class="comment">// 是否分发无效的flag</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;FieldCanBeLocal&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mDispatchInvalidated;</span><br><span class="line">    <span class="comment">// 实现同步锁更新数据的线程，在postValue中被调用，会被发送到主线程中去执行</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable mPostValueRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Object newValue;</span><br><span class="line">            <span class="comment">// 将postValue发过来的数据进行修改</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">                newValue = mPendingData;</span><br><span class="line">                mPendingData = NOT_SET;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用setValue更新数据</span></span><br><span class="line">            setValue((T) newValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        mData = value;</span><br><span class="line">        mVersion = START_VERSION + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mData = NOT_SET;</span><br><span class="line">        mVersion = START_VERSION;</span><br><span class="line">    &#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">## 2.2 LiveData # setValue()</span><br><span class="line">```java</span><br><span class="line"><span class="comment">// 通过注解表明只能在主线程使用</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">    <span class="comment">// 版本增加</span></span><br><span class="line">    mVersion++;</span><br><span class="line">    <span class="comment">// 更新数据</span></span><br><span class="line">    mData = value;</span><br><span class="line">    <span class="comment">// 分发事件</span></span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码很简单，增加版本、更新数据、分发事件。<br>因为这个方法只能在主线程中被调用(@MainThread)，所以实现才这么简单，不需要考虑线程同步啥的。</p>
<h2 id="2-3-LiveData-postValue"><a href="#2-3-LiveData-postValue" class="headerlink" title="2.3 LiveData # postValue()"></a>2.3 LiveData # postValue()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> postTask;</span><br><span class="line">    <span class="comment">// 对数据更新加锁</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">        <span class="comment">// 如果没有设置过值，那么mPendingData == NOT_SET</span></span><br><span class="line">        <span class="comment">// 先将值保存到mPendingData，在通过下面的Runable来更新数据，将mPendingData的值更新到mValue</span></span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// postTask为false，就代表数据还没有更新到mValue中去，就不让更新数据</span></span><br><span class="line">    <span class="comment">// 因为postValue和mPostValueRunnable执行之间还有一定的时间间隔</span></span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过线程池将数据更新发送到主线程中去更新数据</span></span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>postValue会比setValue复杂一点，因为我们可以从最后一行看出，postValue是提供给我们在其它线程中调用的，然后调用之后他就会通过线程池传回主线程，再在主线程中更新数据并调用setValue。</p>
<p>那么为什么会需要mPendingData这个中间量呢?<br>原因也很简单，因为我们最终是要在主线程中调用setValue的，那么我们怎么把最新的值传递给setValue呢，况且这块还涉及到了线程切换，所以我们就必须通过一个中间变量来将这个数据从子线程传输到主线程了。并且由于为了避免多线程情况下对数据进行修改造成数据混乱，所以才对mPendingData加了锁，并且还在postValue处如果数据还没更新的话，后面来的数据都直接丢弃了。</p>
<h2 id="2-4-LiveData-observer"><a href="#2-4-LiveData-observer" class="headerlink" title="2.4 LiveData # observer()"></a>2.4 LiveData # observer()</h2><p>上面说到了设置数据，那么我们数据设置之后谁来相应呢？<br>我们在使用的时候都是通过observer方法来注册观察者的，那我们就看下这个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只许主线程中调用</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observe&quot;</span>);</span><br><span class="line">    <span class="comment">// Activity和Fragment都实现了Owner接口，所以这个Owner就相当于他们</span></span><br><span class="line">    <span class="comment">// 当他们的状态是DESTROYED时，代表刚创建或者要摧毁了，此时就不需要注册了</span></span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造一个LifecycleBundleOvserver</span></span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">    <span class="comment">// 存入mObservers这个map中去</span></span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="comment">// 如果已经存在了，并且他的owner并不是我们调用这个方法时传入的owner，就抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果已经存在，就没必要再添加了</span></span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过Lifecycle去监听和分发事件</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>observer方法的源码很简单。</p>
<p>先根据传入的owner和observer构造一个LifecycleBoundObserver，然后把他们存入到mObservers这个SafeIterableMap中去，然后在存的时候，如果原本就有值，并且这个的owner还不是我们这次传入的这个owner，就抛出异常，如果原本有值，那么就直接返回，也就不存了。然后最后还是调用Lifecycle的addObserver存入到Lifecycle中去。</p>
<h2 id="2-5-LiveData-dispatchingValue"><a href="#2-5-LiveData-dispatchingValue" class="headerlink" title="2.5 LiveData # dispatchingValue()"></a>2.5 LiveData # dispatchingValue()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否有事件正在被分发</span></span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        <span class="comment">// 分发无效</span></span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 由于当前需要分发事件，于是这个flag为true</span></span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 正在分发，所以此flag为false</span></span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 传入的不为null</span></span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过considerNotify去分发</span></span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 传入的为null，也就是setValue中的调用</span></span><br><span class="line">            <span class="comment">//遍历mObservers，并且还是能遍历被添加的数据</span></span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                <span class="comment">// 通过considerNotify去分发</span></span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="comment">// 分发无效就break</span></span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    <span class="comment">// 分发结束，设置为false</span></span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-LiveData-considerNotify"><a href="#2-6-LiveData-considerNotify" class="headerlink" title="2.6 LiveData # considerNotify()"></a>2.6 LiveData # considerNotify()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果不是active状态了，就不用分发了</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check latest state b4 dispatch. Maybe it changed state but we didn&#x27;t get the event yet.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// we still first check observer.active to keep it as the entrance for events. So even if</span></span><br><span class="line">    <span class="comment">// the observer moved to an active state, if we&#x27;ve not received that event, we better not</span></span><br><span class="line">    <span class="comment">// notify for a more predictable notification order.</span></span><br><span class="line">    <span class="comment">// 如果状态不是STARTED之后的话，那么就更新状态</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果Observer的Version高于当前Version，那么就没必要去分发</span></span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新Version</span></span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    <span class="comment">// 事件分发，调用我们实现的Observer的onChanged方法，也就是我们写的代码</span></span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-LifecycleWrapper"><a href="#3-LifecycleWrapper" class="headerlink" title="3. LifecycleWrapper"></a>3. LifecycleWrapper</h1><h2 id="3-1-LifecycleWrapper"><a href="#3-1-LifecycleWrapper" class="headerlink" title="3.1 LifecycleWrapper"></a>3.1 LifecycleWrapper</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Observer</span></span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; mObserver;</span><br><span class="line">    <span class="comment">// 当前Observer的状态</span></span><br><span class="line">    <span class="keyword">boolean</span> mActive;</span><br><span class="line">    <span class="comment">// Observer的最新的Version</span></span><br><span class="line">    <span class="keyword">int</span> mLastVersion = START_VERSION;</span><br><span class="line">    <span class="comment">// 构造方法</span></span><br><span class="line">    ObserverWrapper(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        mObserver = observer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAttachedTo</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">detachObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// immediately set active state, so we&#x27;d never dispatch anything to inactive</span></span><br><span class="line">        <span class="comment">// owner</span></span><br><span class="line">        <span class="comment">// 更新状态</span></span><br><span class="line">        mActive = newActive;</span><br><span class="line">        <span class="comment">// 如果mActivityCount==0那就意味着没有Observer</span></span><br><span class="line">        <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 更新mActiveCount</span></span><br><span class="line">        LiveData.<span class="keyword">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class="line">            <span class="comment">// 如果mActive=1，那么就onActive去更新</span></span><br><span class="line">            onActive();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123;</span><br><span class="line">            <span class="comment">// 如果当前mActiveCount刚刚为0，那么就onInactive</span></span><br><span class="line">            onInactive();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果mActive=true，那么就分发</span></span><br><span class="line">        <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">            dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-LifecycleBoundObserver"><a href="#3-2-LifecycleBoundObserver" class="headerlink" title="3.2 LifecycleBoundObserver"></a>3.2 LifecycleBoundObserver</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line"></span><br><span class="line">    LifecycleBoundObserver(<span class="meta">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断当前Lifecycle的状态是不是在STARTED之后</span></span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 监听Lifecycle的状态发生变化</span></span><br><span class="line">        <span class="comment">// 如果状态时DESTROYED，</span></span><br><span class="line">        <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">            <span class="comment">// 移除掉这个Observer</span></span><br><span class="line">            removeObserver(mObserver);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新Active</span></span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAttachedTo</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner == owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">detachObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mOwner.getLifecycle().removeObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h1><h2 id="4-1-总结和流程"><a href="#4-1-总结和流程" class="headerlink" title="4.1 总结和流程"></a>4.1 总结和流程</h2><p>LiveData主要由2个类构成：</p>
<ul>
<li><code>LiveData</code>：抽象类，实现类就是<code>MutableLiveData</code>，只不过<code>MutableLiveData</code>中的所有的方法都是直接调用了<code>LiveData</code>的方法，本质上和<code>LiveData</code>没啥区别。</li>
<li><code>LifecycleWrapper</code>：抽象类，主要用来对<code>Observer</code>和<code>Version</code>、<code>Active</code>进行管理，而我们使用的都是<code>LifecycleBoundObserver</code>，这个类继承自<code>LifecycleWrapper</code>，并实现了<code>LifecycleEventObserver</code>接口。</li>
</ul>
<p>并且底层还是通过Lifecycle去实现的，就是对Lifecycle进行了一下封装。</p>
<p>LiveData的操作主要分为两种：</p>
<ul>
<li>添加观察者：<code>observer()</code></li>
<li>设置数据：<ul>
<li><code>setValue()</code></li>
<li><code>postValue()</code></li>
</ul>
</li>
</ul>
<h3 id="4-1-1-添加观察者"><a href="#4-1-1-添加观察者" class="headerlink" title="4.1.1 添加观察者"></a>4.1.1 添加观察者</h3><ol>
<li>调用<code>observer()</code>方法，<ol>
<li>在这个方法中会先构造一个LifecycleBoundObserver的对象，这个对象保存了这个<code>mObserver</code>以及激活状态<code>mActive</code>；</li>
<li>接着把这个对象添加到通过<code>mObservers.putIfAbsent()</code>添加进去；</li>
<li>并调用<code>owner.getLifecycle().addObserver(wrapper)</code>添加到Lifecycle中进行监听。</li>
</ol>
</li>
<li>之后每当<code>owner</code>生命周期变化时，就会调用LifecycleBoundObserver的<code>onStateChanged()</code>方法<ol>
<li>如果当前<code>owner</code>的状态为<code>DESTROYED</code>的时候，就会将这个<code>observer</code>从<code>mObservers</code>中移除</li>
<li>如果不是，就调用<code>activeStateChanged()</code>去更新<code>mActive</code></li>
</ol>
</li>
</ol>
<h3 id="4-1-2-设置数据"><a href="#4-1-2-设置数据" class="headerlink" title="4.1.2 设置数据"></a>4.1.2 设置数据</h3><ol>
<li><code>postValue()</code>：这个方法主要是提供给我们在非主线程中去调用的<ol>
<li>这个方法中会先加锁，然后将数据保存到<code>mPendingData</code>中，并根据<code>mPendingData</code>的值判断上次post的值是否更新到<code>mData</code>中了：<ol>
<li>如果更新到了，则通过<code>ArchTaskExecutor</code>将<code>mPostValueRunnable</code>这个Runnable<code>post</code>到了主线程中执行<ol>
<li><code>mPostValueRunnable</code>中会将加锁，将<code>mPendingData</code>中的值更新到<code>newData</code>中，并将<code>mPendingData</code>值设置为<code>NOT_SET</code>，然后会调用<code>setValue(newData)</code></li>
</ol>
</li>
<li>如果没有更新，则会直接return退出这次<code>postValue()</code>，不更新数据，直接丢弃</li>
</ol>
</li>
</ol>
</li>
<li><code>setValue()</code>：这个方法只能在主线程中调用<ol>
<li>他就会直接调用<code>dispatchingValue(null)</code>进行分发</li>
<li>这个方法中如果传入的是<code>null</code>，就代表需要分发给所有的Observer，那么他会遍历<code>mObservers</code>，对每一个Observer调用<code>considerNotify(iterator.next().getValue());</code></li>
<li>在<code>considerNotify(observer)</code>中会先判断传入的这个Observer的<code>mActive</code>是否为<code>false</code>，如果是的话，就代表没有激活，也就是他的<code>owner</code>处于<code>STARTED</code>之后，就没有必要去更新View了；而如果不是就继续往下执行：<ol>
<li>先调用<code>shouldBeActive</code>判断<code>owner</code>是否处于<code>STARTED</code>之后，如果是就调用<code>activeStateChanged(false)</code>去更新<code>mActive</code>为false，并return，不分发事件</li>
<li>在判断<code>observer</code>的<code>mLastVersion</code>是否大于当前的<code>mVersion</code>，如果大于等于，则也没有必要继续分发</li>
<li>之后更新<code>observer</code>的<code>mLastVersion</code>为当前的<code>mVersion</code></li>
<li>调用<code>observer.mObserver.onChanged((T) mData);</code>去执行我们实现的Observer</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="4-1-3-流程图"><a href="#4-1-3-流程图" class="headerlink" title="4.1.3 流程图"></a>4.1.3 流程图</h3><p>对于流程我们可以用下图表示：<br><img src="http://cdn.littlecorgi.top/mweb/2020-08-22/Jetpack%E6%BA%90%E7%A0%81-%E4%B9%8B-LiveData-LiveData%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="Jetpack源码-之-LiveData-LiveData流程图"></p>
<h2 id="4-2-LiveData真的可以被用于事件分发吗"><a href="#4-2-LiveData真的可以被用于事件分发吗" class="headerlink" title="4.2 LiveData真的可以被用于事件分发吗"></a>4.2 LiveData真的可以被用于事件分发吗</h2><p>LiveData本质上是可观察的数据存储类，但是可观察这个特性不就可以被用来事件分发吗(EventBus)，而且还通过Lifecycle实现了生命周期感知，这些相对来说比EventBus更加简单。</p>
<p>但是LiveData真的有表面上看上去的这个简单吗？真的有这么好吗？</p>
<h3 id="4-2-1-postValue-数据丢失"><a href="#4-2-1-postValue-数据丢失" class="headerlink" title="4.2.1 postValue 数据丢失"></a>4.2.1 postValue 数据丢失</h3><p>在postValue方法中，如果mPendingData == NOT_SET的话，就会直接丢弃调这次的数据。也就是说，如果上次的事件还在分发，还没完成的话，那么这次的事件就会直接丢弃。</p>
<p>这样就导致了事件丢失。</p>
<h3 id="4-2-2-considerNotify-不回调观察者"><a href="#4-2-2-considerNotify-不回调观察者" class="headerlink" title="4.2.2 considerNotify 不回调观察者"></a>4.2.2 considerNotify 不回调观察者</h3><p>除了postValue存放事件这块有问题，considerNotify通知事件也有问题。</p>
<p>considerNotify这个方法第一行就是如果Observer处于非激活状态(mActive == false)，那么这个时候他就不会回调这个Observer去分发事件。</p>
<p>只有当Observer处于激活状态，他才会进行分发。</p>
<p>这样就造成了事件丢失，中间传输的数据都无法收到。</p>
<h3 id="4-2-3-LiveData本来就不是为事件分发打造的"><a href="#4-2-3-LiveData本来就不是为事件分发打造的" class="headerlink" title="4.2.3 LiveData本来就不是为事件分发打造的"></a>4.2.3 LiveData本来就不是为事件分发打造的</h3><p>在官方文档上第一句话就表明了，LiveData只是一个可观察的数据存储类，他的核心在于他能将最新的数据通知给观察者，也就是说，他本来就不会在意中间状态，它只要保证当View处于激活状态能得到最新的数据保证UI时正确的就行，如果还要去纠结中间状态的话，那么UI展示岂不会变得很奇怪；并且如果对于没有显示的View都要去通知这个View的话，这样不就会显得很多此一举。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">littlecorgi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://a1203991686.github.io/posts/28011e4e.html">https://a1203991686.github.io/posts/28011e4e.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://a1203991686.github.io" target="_blank">littlecorgiの小站</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Jetpack/">Jetpack</a><a class="post-meta__tags" href="/tags/MVVM/">MVVM</a><a class="post-meta__tags" href="/tags/LiveData/">LiveData</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/uploads/wechat.png" target="_blank"><img class="post-qr-code-img" src="/uploads/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/uploads/alipay.png" target="_blank"><img class="post-qr-code-img" src="/uploads/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/b309316d.html"><img class="prev-cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Jetpack源码 之 ViewModel</div></div></a></div><div class="next-post pull-right"><a href="/posts/53c3ccc1.html"><img class="next-cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jetpack源码 之 Lifecycle</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/b1488352.html" title="Jetpack入门 之 LiveData的map()和switchMap"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-08-14</div><div class="title">Jetpack入门 之 LiveData的map()和switchMap</div></div></a></div><div><a href="/posts/b309316d.html" title="Jetpack源码 之 ViewModel"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-09-10</div><div class="title">Jetpack源码 之 ViewModel</div></div></a></div><div><a href="/posts/53c3ccc1.html" title="Jetpack源码 之 Lifecycle"><img class="cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-08-14</div><div class="title">Jetpack源码 之 Lifecycle</div></div></a></div><div><a href="/posts/1900f7eb.html" title="AndroidView之PopupWindow"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-05-31</div><div class="title">AndroidView之PopupWindow</div></div></a></div><div><a href="/posts/63ab42b7.html" title="Android多线程1--Java中的阻塞队列"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-06-16</div><div class="title">Android多线程1--Java中的阻塞队列</div></div></a></div><div><a href="/posts/b39fd0ab.html" title="Android多线程2--Java中的线程池"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-06-16</div><div class="title">Android多线程2--Java中的线程池</div></div></a></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By littlecorgi</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://littlecorgi.top/">blog</a>!</div><div class="icp"><a target="_blank" rel="noopener" href="https://hb.beian.miit.gov.cn/state/outPortal/loginPortal.action"><img class="icp-icon" src="/img/icp.png"/><span>鄂ICP备19018829号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script></div></body></html>